<?php

namespace App\Http\Controllers;

use App\Jobs\BigDBMCreateListJob;
use App\Jobs\SendSpreadsheetJob;
use App\Mail\Gmail;
use App\Models\BigDBMLeads;
use App\Models\Company;
use App\Models\CompanySetting;
use App\Models\FailedRecord;
use App\Models\GlobalSettings;
use App\Models\IntegrationList;
use App\Models\IntegrationSettings;
use App\Models\LeadsListsQueue;
use App\Models\LeadspeekAudienceCampaign;
use App\Models\LeadspeekInvoice;
use App\Models\LeadspeekReport;
use App\Models\LeadspeekUser;
use App\Models\OptoutList;
use App\Models\Person;
use App\Models\PersonAddress;
use App\Models\PersonEmail;
use App\Models\PersonName;
use App\Models\PersonPhone;
use App\Models\PersonAdvance;
use App\Models\PersonAdvance2;
use App\Models\PersonAdvance3;
use App\Models\PersonB2B;
use App\Models\PixelLeadRecord;
use App\Models\ReportAnalytic;
use App\Models\State;
use App\Models\SuppressionList;
use App\Models\User;
use App\Models\TldDomain;
use App\Services\GoogleSheet;
use Carbon\Carbon;
use DateTime;
use Exception;
use Google_Client;
use Google_Service_Sheets;
use Google_Service_Sheets_Spreadsheet;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Mail;
use Stripe\Exception\ApiConnectionException;
use Stripe\Exception\ApiErrorException;
use Stripe\Exception\AuthenticationException;
use Stripe\Exception\OAuth\InvalidRequestException;
use Stripe\Exception\RateLimitException;
use Stripe\StripeClient;
use App\Models\ListAndTag;
use App\Models\MasterFeature;
use App\Models\ServicesAgreement;
use App\Models\Topup;
use App\Services\AESCipher;
use App\Models\TopupAgency;
use App\Services\OpenApi\OpenApiWebhookService;
use App\Services\SimpliFiService;
use Closure;
use ESolution\DBEncryption\Encrypter;
use Illuminate\Support\Facades\App;
use Illuminate\Support\Facades\Cache;
use App\Services\SendJimService;

class WebhookController extends Controller
{
    protected  $api_key;
    protected  $api_password;

    public function checkLimitLeadsBeforeInsertLeadspeekReport($cl = [])
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            /* VARIABLE */
            $clientPaymentTerm = $cl['paymentterm'];
            $clientLimitFreq = $cl['lp_limit_freq'];
            $leadspeek_api_id = $cl['leadspeek_api_id'];
            $_lp_user_id = $cl['id'];
            $_user_id = $cl['user_id'];
            $clientLimitLeads = $cl['lp_limit_leads'];
            /* VARIABLE */

            if($cl['leadspeek_type'] == 'local' && $clientPaymentTerm == 'Prepaid' && $cl['topupoptions'] == 'continual' && $clientLimitFreq == 'month')
            {
                $idTopups = Topup::select(['id'])
                                    ->where('leadspeek_api_id','=', $leadspeek_api_id)
                                    ->where('topup_status','<>','done')
                                    ->get();
    
                $TotalLimitLeads = Topup::where('leadspeek_api_id','=', $leadspeek_api_id)
                                        ->where('topup_status','<>','done')
                                        ->sum('total_leads');
    
                $remainingBalanceLeads = $TotalLimitLeads - DB::table('leadspeek_reports')
                                                                ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                                                ->whereIn('topup_id', $idTopups)
                                                                ->count();
    
                // info('', [
                //     'action' => 'check paused on run prepaid continual limit month in local',
                //     'idTopups' => $idTopups,
                //     'totalLeadsTopup' => Topup::where('leadspeek_api_id','=', $leadspeek_api_id)->where('topup_status','<>','done')->sum('total_leads'),
                //     'totalLeadsReport' => DB::table('leadspeek_reports')->where('leadspeek_api_id','=',$leadspeek_api_id)->whereIn('topup_id', $idTopups)->count(),
                //     'remainingBalanceLeads' => $remainingBalanceLeads
                // ]); 
    
                if($remainingBalanceLeads <= 0)
                {
                    return false;
                }

                return true;
            }
            else 
            {
                $countleads = LeadspeekReport::select(DB::raw("(COUNT(*)) as total"))
                                              ->where('active','=','T')
                                              ->where('lp_user_id','=',$_lp_user_id)
                                              ->where('user_id','=',$_user_id);
    
                if ($clientLimitFreq == 'day') 
                {
                    // Filter by today's date using direct datetime comparison
                    $countleads->where('clickdate', '>=', Carbon::today()->startOfDay())
                               ->where('clickdate', '<', Carbon::tomorrow()->startOfDay());
    
                } 
                else if ($clientLimitFreq == 'month') 
                {
                    // Get the first and last day of the current month
                    $freqStartDate = Carbon::now()->startOfMonth()->startOfDay();
                    $freqEndDate = Carbon::now()->endOfMonth()->endOfDay();
    
                    $countleads->whereBetween('clickdate', [$freqStartDate, $freqEndDate]);
    
                } 
                else if ($clientLimitFreq == 'max' && !empty($clientLimitStartDate)) 
                {
                    // Convert given start date to a datetime format
                    $clientLimitStartDate = Carbon::parse($clientLimitStartDate)->startOfDay();
    
                    $countleads->where('clickdate', '>=', $clientLimitStartDate);
                }
                
                $countleads = $countleads->first();
                $TotalLimitLeads = $countleads ? $countleads->total : 0;
                
                if ($TotalLimitLeads == $clientLimitLeads) 
                {   
                    return false;
                }
                
                return true;
            }
        }
        catch (\Throwable $e)
        {
            Log::error('public function checkLimitLeadsBeforeInsertLeadspeekReport error', [
                'message' => $e->getMessage()
            ]);
            return false;
        }
    }

    public function checkLimitLeadsAfterInsertLeadspeekReport($cl = [])
    {
        try
        {
            date_default_timezone_set('America/Chicago');
            
            /* VARIABLE */
            $clientPaymentTerm = $cl['paymentterm'];
            $clientLimitFreq = $cl['lp_limit_freq'];
            $leadspeek_api_id = $cl['leadspeek_api_id'];
            $_lp_user_id = $cl['id'];
            $_user_id = $cl['user_id'];
            $clientLimitLeads = $cl['lp_limit_leads'];
            $organizationid = $cl['leadspeek_organizationid'];
            $campaignsid = $cl['leadspeek_campaignsid'];

            $campaignName = '';
            if (isset($cl['campaign_name']) && trim($cl['campaign_name']) != '') 
            {
                $campaignName = ' - ' . str_replace($leadspeek_api_id,'',$cl['campaign_name']);
            }

            $company_name = str_replace($leadspeek_api_id,'',$cl['company_name']) . $campaignName;
            /* VARIABLE */

            if($cl['leadspeek_type'] == 'local' && $clientPaymentTerm == 'Prepaid' && $cl['topupoptions'] == 'continual' && $clientLimitFreq == 'month') 
            {
                $idTopups = Topup::select(['id'])
                                 ->where('leadspeek_api_id','=', $leadspeek_api_id)
                                 ->where('topup_status','<>','done')
                                 ->get();

                $TotalLimitLeads = Topup::where('leadspeek_api_id','=', $leadspeek_api_id)
                                        ->where('topup_status','<>','done')
                                        ->sum('total_leads');

                $remainingBalanceLeads = $TotalLimitLeads - DB::table('leadspeek_reports')
                                                              ->where('leadspeek_api_id','=', $leadspeek_api_id)
                                                              ->whereIn('topup_id', $idTopups)
                                                              ->count();

                // info('', [
                //     'action' => 'check paused on run prepaid continual limit month in local',
                //     'idTopups' => $idTopups,
                //     'totalLeadsTopup' => Topup::where('leadspeek_api_id','=', $leadspeek_api_id)->where('topup_status','<>','done')->sum('total_leads'),
                //     'totalLeadsReport' => DB::table('leadspeek_reports')->where('leadspeek_api_id','=',$leadspeek_api_id)->whereIn('topup_id', $idTopups)->count(),
                //     'remainingBalanceLeads' => $remainingBalanceLeads
                // ]);

                if($remainingBalanceLeads <= 0)
                {
                    $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                    $updateLeadspeekUser->active = 'F';
                    $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                    $updateLeadspeekUser->save();

                    /** SEND EMAIL NOTIFICATION */
                    $this->notificationStartStopLeads(array('serverlogs@sitesettingsapi.com'),'Paused',$company_name . ' #' . $leadspeek_api_id . ' (Webhook)',$clientLimitLeads,$clientLimitFreq,$TotalLimitLeads,$cl['clientowner'],true);
                    /** SEND EMAIL NOTIFICATION */
                }
            } 
            else 
            {
                $countleads = LeadspeekReport::select(DB::raw("(COUNT(*)) as total"))
                                             ->where('active','=','T')
                                             ->where('lp_user_id','=',$_lp_user_id)
                                             ->where('user_id','=',$_user_id);

                if ($clientLimitFreq == 'day') {
                    // Filter by today's date using direct datetime comparison
                    $countleads->where('clickdate', '>=', Carbon::today()->startOfDay())
                               ->where('clickdate', '<', Carbon::tomorrow()->startOfDay());
                } else if ($clientLimitFreq == 'month') {
                    $freqStartDate = Carbon::now()->startOfMonth()->startOfDay();
                    $freqEndDate = Carbon::now()->endOfMonth()->endOfDay();

                    $countleads->whereBetween('clickdate', [$freqStartDate, $freqEndDate]);
                } else if ($clientLimitFreq == 'max' && !empty($clientLimitStartDate)) {
                    // Convert given start date to a datetime format
                    $clientLimitStartDate = Carbon::parse($clientLimitStartDate)->startOfDay();
                    $countleads->where('clickdate', '>=', $clientLimitStartDate);
                }

                $countleads = $countleads->first();
                $TotalLimitLeads = $countleads ? $countleads->total : 0;

                /** IF TOTAL COUNT LEADS DAY / MONTH BIGGER and EQUAL FROM LIMIT LEADS */
                if ($TotalLimitLeads >= $clientLimitLeads) {
                    /** ACTIVATE CAMPAIGN SIMPLIFI */
                    if ($organizationid != '' && $campaignsid != '') {
                        $camp = $this->startPause_campaign($organizationid,$campaignsid,'pause');
                        if ($camp == true) {
                            $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                            $updateLeadspeekUser->active = 'F';
                            $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                            $updateLeadspeekUser->save();
                        } else {
                            /** SEND EMAIL TO ME */
                            $details = [
                                'errormsg'  => 'Simpli.Fi Error Leadspeek ID :' . $leadspeek_api_id. '<br/>',
                            ];

                            $from = [
                                'address' => 'noreply@sitesettingsapi.com',
                                'name' => 'support',
                                'replyto' => 'noreply@sitesettingsapi.com',
                            ];
                            $this->send_email(array('serverlogs@sitesettingsapi.com'),'Start Pause Campaign Failed (INTERNAL - Webhook-ProcessDataMatch-L825) #' .$leadspeek_api_id,$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                            /** SEND EMAIL TO ME */
                        }
                    } else if ($cl['leadspeek_type'] == "local") {
                        $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                        $updateLeadspeekUser->active = 'F';
                        $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                        $updateLeadspeekUser->save();
                    }
                    /** ACTIVATE CAMPAIGN SIMPLIFI */

                    /** SEND EMAIL NOTIFICATION */
                    $this->notificationStartStopLeads(array('serverlogs@sitesettingsapi.com'),'Paused',$company_name . ' #' . $leadspeek_api_id . ' (Webhook)',$clientLimitLeads,$clientLimitFreq,$TotalLimitLeads,$cl['clientowner'],true);
                    /** SEND EMAIL NOTIFICATION */
                }
                /** IF TOTAL COUNT LEADS DAY / MONTH BIGGER and EQUAL FROM LIMIT LEADS */
            }
        }
        catch (\Throwable $e)
        {
            Log::error('public function checkLimitLeadsAfterInsertLeadspeekReport error', [
                'message' => $e->getMessage()
            ]);
        }
    }

    public function processInsertLeadspeekReport($cl = [], $matches = [], $is_advance = "", $price_lead = 0, $platform_price_lead = 0, $rootFeeCost = 0,$is_local_custom = ['is_advance' => false,'is_b2b' => false,'advance' => [],'b2b' => [],])
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            /* VARIABLE */
            $leadcount = 0;
            $content = [];
            $_lp_user_id = $cl['id'];
            $_company_id = $cl['company_id'];
            $_user_id = $cl['user_id'];
            $clientOngoingLeads = $cl['ongoing_leads'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
            $leadspeek_api_id = $cl['leadspeek_api_id'];
            $leadspeek_type = $cl['leadspeek_type'];
            $clientPaymentTerm = $cl['paymentterm'];
            $clientTotalLeads = $cl['total_leads'];
            $campaign_advance_information = LeadspeekUser::select('advance_information')->where('leadspeek_api_id',$leadspeek_api_id)->first();
            /* VARIABLE */
            
            /* PROCESS INSERT LEADSPEEK REPORTS */

            /* EHANCE ADVANCE ROW VARIABLES */
            $categories = [
                        'identification' => [
                            'GenderAux', 'Generation', 'MaritalStatus',
                        ],
                        'contactInformation' => [
                            'Phone3', 'TaxBillInformation',
                        ],
                        'houseAndRealEstate' => [
                            'DwellingType', 'HomeOwner', 'HomeOwnerOrdinal', 'LengthOfResidence',
                            'HomePrice', 'HomeValue', 'MedianHomeValue', 'LivingSqft', 'YrBuiltOrig',
                            'YrBuiltRange', 'LotNumber', 'LegalDescription', 'LandSqft', 'GarageSqft',
                            'Subdivision', 'ZoningCode',
                        ],
                        'financialInformation' => [
                            'IncomeHousehold', 'IncomeMidptsHousehold', 'NetWorthHousehold',
                            'NetWorthMidptHousehold', 'DiscretionaryIncome', 'CreditMidpts', 'CreditRange',
                        ],
                        'householdInformation' => [
                            'NumAdultsHousehold', 'NumChildrenHousehold', 'NumPersonsHousehold',
                            'ChildAged03Household', 'ChildAged46Household', 'ChildAged79Household',
                            'ChildAged1012Household', 'ChildAged1318Household', 'ChildrenHousehold',
                        ],
                        'interestsAndAffinities' => [
                            'Cooking', 'Gardening', 'Music', 'Diy', 'Books', 'TravelVacation',
                            'HealthBeautyProducts', 'PetOwner', 'Photography', 'Fitness', 'Epicurean',
                        ],
                        'occupation' => [
                            'OccupationCategory', 'OccupationType', 'OccupationDetail',
                        ],
                        'marketingIndicators' => [
                            'MagazineSubscriber', 'CharityInterest', 'LikelyCharitableDonor',
                        ],
                        'locationAndCensusData' => [
                            'Cbsa', 'CensusBlock', 'CensusBlockGroup', 'CensusTract',
                        ],
                        'miscellaneous' => [
                            'Voter', 'Urbanicity',
                        ],
                    ]; 
            /* EHANCE ADVANCE ROW VARIABLES */ 

            foreach($matches as $row) 
            {
                $_Phone = $row->Phone;
                $_Phone2 = $row->Phone2;
                $_Address1 = $row->Address1;
                $_Address2 = $row->Address2;
                $_City = $row->City;
                $_State = $row->State;
                $_Zipcode = $row->Zipcode;
    
                if ($leadspeek_type === 'b2b') 
                {
                    $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                    $_Phone2 = '';
                }
    
                if ($phoneenabled == 'F') 
                {
                    $_Phone = '';
                    $_Phone2 = '';
                }
    
                if ($homeaddressenabled == 'F') 
                {
                    $_Address1 = '';
                    $_Address2 = '';
                    $_City = '';
                    $_State = '';
                    $_Zipcode = '';
                }
    
                if ($is_advance && $leadspeek_type == 'enhance') 
                {
                    $campaignInformations = DB::table('campaign_informations')
                                              ->select('id','type')
                                              ->where('status', 'active')
                                              ->where('campaign_type','enhance')
                                              ->orderBy('start_index', 'asc')
                                              ->get();
    
                    $advance_content = [];
    
                    $selected_category = explode(',',$campaign_advance_information->advance_information);
                    if (!empty($campaignInformations)) 
                    {
                        foreach ($campaignInformations as $info) 
                        {
                            $category = $info->type;
                            if (array_key_exists($category, $categories)) 
                            {
                                foreach ($categories[$category] as $column) 
                                {
                                    $value = isset($row->$column) && in_array($info->id,$selected_category) ? $row->$column : '';
                                    $advance_content[] = $value;
                                }
                            }
                        }
                    }
                }
    
                $settingJson = DB::table('global_settings')
                                 ->where('setting_name', 'spreadsheet_b2b_ordering')
                                 ->value('setting_value');
    
                $dtJson = json_decode($settingJson, true);
                $startDate_spreadsheet = isset($dtJson[0]['start-date']) ? Carbon::parse($dtJson[0]['start-date']) : null;
                $userCreatedAt = Carbon::parse($cl['created_at']);
    
                if ($leadspeek_type == 'b2b') 
                {
                    $advance_content_b2b = [];
                    if ($startDate_spreadsheet && $userCreatedAt->greaterThanOrEqualTo($startDate_spreadsheet)) 
                    {
                        if ($is_advance) 
                        {
                            $campaignInformations = DB::table('campaign_informations')
                                                      ->select('id','type','description','start_index','name')
                                                      ->where('status', 'active')
                                                      ->where('campaign_type','b2b')
                                                      ->orderBy('start_index', 'asc')
                                                      ->get();
    
                            $categories = [
                                'company_name' => ['CompanyName'],
                                // 'company_email' => ['Email'],
                                'company_phone' => ['Phone1Company'],
                                'company_website' => ['CompanyWebsite'],
                                'job_title' => ['JobTitle'],
                                'level' => ['Level'],
                                'job_function' => ['JobFunction'],
                                'linkedin' => ['LinkedIn'],
                                'num_employees' => ['NumEmployees'],
                                'sales_volume' => ['SalesVolume'],
                                'year_founded' => ['YearFounded'],
                                // 'last_seen_date' => ['LastSeenDate'],
                            ];
    
                            $selected_category = explode(',', $campaign_advance_information->advance_information);
                            if (!empty($campaignInformations)) 
                            {
                                foreach ($campaignInformations as $info) 
                                {
                                    $category = $info->type;
                                    if (array_key_exists($category, $categories)) 
                                    {
                                        foreach ($categories[$category] as $column) 
                                        {
                                            $value = isset($row->$column) && in_array($info->id,$selected_category) ? $this->formatTxt($row->$column, 'b2b', $category) : '';
                                            $advance_content_b2b[$info->start_index] = $value;
                                        }
                                    }
                                }
                            }
                        }
                    } 
                    else 
                    {
                        $b2b_content = [
                            (isset($row->EmployeeID) && !empty($row->EmployeeID)) ? $row->EmployeeID : '',
                            (isset($row->CompanyName) && !empty($row->CompanyName)) ? $row->CompanyName : '',
                            (isset($row->Phone1Company) && !empty($row->Phone1Company)) ? $row->Phone1Company : '',
                            (isset($row->CompanyWebsite) && !empty($row->CompanyWebsite)) ? $row->CompanyWebsite : '',
                            (isset($row->NumEmployees) && !empty($row->NumEmployees)) ? $row->NumEmployees : '',
                            (isset($row->SalesVolume) && !empty($row->SalesVolume)) ? $row->SalesVolume : '',
                            (isset($row->YearFounded) && !empty($row->YearFounded)) ? $row->YearFounded : '',
                            (isset($row->JobTitle) && !empty($row->JobTitle)) ? $row->JobTitle : '',
                            (isset($row->Level) && !empty($row->Level)) ? $row->Level : '',
                            (isset($row->JobFunction) && !empty($row->JobFunction)) ? $row->JobFunction : '',
                            (isset($row->HeadquartersBranch) && !empty($row->HeadquartersBranch)) ? $row->HeadquartersBranch : '',
                            (isset($row->NaicsCode) && !empty($row->NaicsCode)) ? $row->NaicsCode : '',
                            (isset($row->LastSeenDate) && !empty($row->LastSeenDate)) ? $row->LastSeenDate : '',
                            (isset($row->LinkedIn) && !empty($row->LinkedIn)) ? $row->LinkedIn : '',
                        ];
                    }
                    
                }
    
                $leadFrom = (isset($row->LeadFrom))?$row->LeadFrom:'';
                $row->Keyword = $this->replaceExclamationWithAsterisk($row->Keyword);

                $advance_content_local = [];
                $b2b_content_local = [];
                    // if ($is_local_custom['is_advance'] || $is_local_custom['is_b2b']) {
                    if ($is_local_custom['is_advance']) {
                         $campaignInformations = DB::table('campaign_informations')
                                                  ->select('id','type')
                                                  ->where('status', 'active')
                                                  ->whereIn('campaign_type',['local_adv'])
                                                  ->orderBy('start_index', 'asc')
                                                  ->get();
        
                        $selected_category = $is_local_custom['advance'];
                        if (!empty($campaignInformations)) 
                        {
                            foreach ($campaignInformations as $info) 
                            {
                                $category = $info->type;
                                if (array_key_exists($category, $categories)) 
                                {
                                    foreach ($categories[$category] as $column) 
                                    {
                                        $value = isset($row->$column) && in_array($info->id,$selected_category) ? $row->$column : '';

                                        $advance_content_local[] = $value;
                                    }
                                }
                            }
                        }
                        
                        // $campaignInformationsB2B = DB::table('campaign_informations')
                        //                             ->select('id','type','description','start_index','name')
                        //                             ->where('status', 'active')
                        //                             ->where('campaign_type','local_b2b')
                        //                             ->orderBy('start_index', 'asc')
                        //                             ->get();
        
                        // $categories = [
                        //         'company_name' => ['CompanyName'],
                        //         'company_email' => ['CompanyEmail'],
                        //         'company_phone' => ['Phone1Company'],
                        //         'company_website' => ['CompanyWebsite'],
                        //         'job_title' => ['JobTitle'],
                        //         'level' => ['Level'],
                        //         'job_function' => ['JobFunction'],
                        //         'linkedin' => ['LinkedIn'],
                        //         'num_employees' => ['NumEmployees'],
                        //         'sales_volume' => ['SalesVolume'],
                        //         'year_founded' => ['YearFounded'],
                        //         // 'last_seen_date' => ['LastSeenDate'],
                        // ];

                        // $selected_category = $is_local_custom['b2b'];

                        // if (!empty($campaignInformationsB2B)) 
                        // {
                        //     foreach ($campaignInformationsB2B as $info) 
                        //     {
                        //         $category = $info->type;
                        //         if (array_key_exists($category, $categories)) 
                        //         {

                        //             foreach ($categories[$category] as $column) 
                        //             {

                        //                 $value = isset($row->$column) && in_array($info->id,$selected_category) ? $this->formatTxt($row->$column, 'b2b', $category) : '';
                        //                 $b2b_content_local[$info->start_index] = $value;
                        //             }
                        //         }
                        //     }
                        // }
                    }

                // setup content
                if ($is_advance && $leadspeek_type == 'enhance') 
                {
                    $content[] = array_merge(array($row->ID,date('m/d/Y h:i:s A',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword), $advance_content);
                } 
                else if ($leadspeek_type == 'b2b') 
                {
                    if ($startDate_spreadsheet && $userCreatedAt->greaterThanOrEqualTo($startDate_spreadsheet)) 
                    {
                        // set default content dan index arraynya
                        $content_default_b2b = array(
                            0 => $row->ID,
                            2 => ucfirst(strtolower($row->FirstName)),
                            3 => ucfirst(strtolower($row->LastName)),
                            4 => $row->Email,
                            11 => date('m/d/Y h:i:s A',strtotime($row->ClickDate)),
                            12 => $_Phone,
                            13 => $_Address1,
                            14 => $_Address2,
                            15 => $_City,
                            16 => $_State,
                            17 => $_Zipcode,
                            18 => $row->Keyword
                        );
    
                        // get max index
                        $maxStartIndex = DB::table('campaign_informations')
                                        ->where('campaign_type', 'b2b')
                                        ->where('status','active')
                                        ->max('start_index');
    
                        // buat array dengan semua index kosong terlebih dahulu dari maxindex + 1
                        $finalContent = array_fill(0, $maxStartIndex + 1, "");
    
                        // Isi dengan nilai dari $content_default_b2b
                        foreach ($content_default_b2b as $key => $value) 
                        {
                            if ($key <= $maxStartIndex) 
                            {
                                $finalContent[$key] = $value;
                            }
                        }
    
                        // Isi dengan nilai dari $advance_content_b2b
                        foreach ($advance_content_b2b as $key => $value) 
                        {
                            if ($key <= $maxStartIndex) 
                            {
                                $finalContent[$key] = $value;
                            }
                        }
    
                        ksort($finalContent);
    
                        $content[] = $finalContent;
                    } 
                    else 
                    {
                        $content[] = array_merge(array($row->ID,date('m/d/Y h:i:s A',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword), $b2b_content);
                    }
                } 
                // else if ($is_local_custom['is_advance'] || $is_local_custom['is_b2b']) 
                // {
                else if ($is_local_custom['is_advance']) 
                {
                    $content[] = array($row->ID,date('m/d/Y h:i:s A',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword);
                    // if ($is_local_custom['is_advance'] || $is_local_custom['is_b2b']) {
                    if ($is_local_custom['is_advance']) {
                        $content[0] = array_merge($content[0], $advance_content_local);
                        // $content[0] = array_merge($content[0], $b2b_content_local);
                    }

                }
                else 
                {    
                    $content[] = array($row->ID,date('m/d/Y h:i:s A',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword);
                }
                // setup content
                
                // process insert leadspeek reports
                if ($clientPaymentTerm == 'Prepaid') 
                {
                    $progressTopup = Topup::where('leadspeek_api_id', $leadspeek_api_id)
                                            ->where('topup_status', 'progress')
                                            ->first();
                    $_topup_id = '0';
    
                    if ($progressTopup) 
                    {
                        $price_lead = (isset($progressTopup->cost_perlead)) ? $progressTopup->cost_perlead : $price_lead;
                        $platform_price_lead = (isset($progressTopup->platform_price)) ? $progressTopup->platform_price : $platform_price_lead;
                        $rootFeeCost = (isset($progressTopup->root_price)) ? $progressTopup->root_price : $rootFeeCost;
                        $_topup_id = (isset($progressTopup->id)) ? $progressTopup->id : '0';
    
                        // info([
                        //     'action' => 'prepaid, ambil di topup',
                        //     'price_lead' => $price_lead,
                        //     'platform_price_lead' => $platform_price_lead,
                        //     'rootFeeCost' => $rootFeeCost,
                        // ]);
                    }
    
                    Log::info("insertDB topupID : {$_topup_id} campaignID: #{$leadspeek_api_id} CustomParams: {$row->CustomParams}");
                    $newleads = $this->insertLeadspeekReport($_lp_user_id,$_company_id,$_user_id,$leadspeek_api_id,$row->ID,$row->Email,$row->Email2,$row->OriginalMD5,$row->IP,$row->Source,date('Y-m-d H:i:s', strtotime($row->OptInDate)),date('Y-m-d H:i:s', strtotime($row->ClickDate)),$row->Referer,$row->Phone,$row->Phone2,ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Address1,$row->Address2,$row->City,$row->State,$row->Zipcode,$leadFrom,'T',$price_lead,$platform_price_lead,$row->PersonID,$row->Keyword,$row->CustomParams,$row->Description,$rootFeeCost,$_topup_id);
                    $leadspeekReportID = isset($row->ID)?$row->ID:'';
                } 
                else 
                {
                    // info([
                    //     'action' => 'weekly atau monthly',
                    //     'price_lead' => $price_lead,
                    //     'platform_price_lead' => $platform_price_lead,
                    //     'rootFeeCost' => $rootFeeCost,
                    // ]);
    
                    Log::info("insertDB campaignID: #{$leadspeek_api_id} CustomParams: {$row->CustomParams}");
                    $newleads = $this->insertLeadspeekReport($_lp_user_id,$_company_id,$_user_id,$leadspeek_api_id,$row->ID,$row->Email,$row->Email2,$row->OriginalMD5,$row->IP,$row->Source,date('Y-m-d H:i:s', strtotime($row->OptInDate)),date('Y-m-d H:i:s', strtotime($row->ClickDate)),$row->Referer,$row->Phone,$row->Phone2,ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Address1,$row->Address2,$row->City,$row->State,$row->Zipcode,$leadFrom,'T',$price_lead,$platform_price_lead,$row->PersonID,$row->Keyword,$row->CustomParams,$row->Description,$rootFeeCost);
                    $leadspeekReportID = isset($row->ID)?$row->ID:'';
                }
                $leadcount++;
                // process insert leadspeek reports
    
                // report analytic serve and bigbdmremainingleads if leadspeek_type enhance or b2b
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeek_type,'serveclient');
                if ($leadspeek_type == 'enhance' || $leadspeek_type == 'b2b') 
                {
                    $bigbdmremainingleads = BigDBMLeads::where('leadspeek_api_id', $leadspeek_api_id)
                                                       ->whereDate('created_at', date('Y-m-d'))
                                                       ->count() - 1;
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeek_type,'bigbdmremainingleads',$bigbdmremainingleads);
                }
                // report analytic serve and bigbdmremainingleads if leadspeek_type enhance or b2b
            }
            /* PROCESS INSERT LEADSPEEK REPORTS */

            /* UPDATE LEADS DATA AND DATE  */
            $totalOngoing = $clientOngoingLeads + $leadcount;
            $lpupdate = LeadspeekUser::find($_lp_user_id);
            $_last_lead_check = now();
            $_last_lead_added = now();

            if ($_last_lead_check != '')
            {
                $lpupdate->last_lead_check = $_last_lead_check;
            }
            if ($_last_lead_added != '') 
            {
                $lpupdate->last_lead_added = $_last_lead_added;
            }
            if ($leadcount != 0) 
            {
                $lpupdate->total_leads = $clientTotalLeads + $leadcount;
                $lpupdate->ongoing_leads = $totalOngoing;
            }

            $lpupdate->save();
            /* UPDATE LEADS DATA AND DATE  */

            return [
                'content' => $content,
                'leadspeekReportID' => $leadspeekReportID
            ];
        }
        catch (\Throwable $e)
        {
            Log::error('public function processInsertLeadspeekReport error', [
                'message' => $e->getMessage()
            ]);
            return [];
        }
    }
    
    public function processSendSpreadsheetJob($cl = [], $content = [], $md5param = "")
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            /* VARIABLE */
            $clientSpreadSheetID = $cl['spreadsheet_id'];
            $leadspeek_api_id = $cl['leadspeek_api_id'];
            $leadspeek_type = $cl['leadspeek_type'];
            $custEmail = $cl['email'];
            $companyNameOri = $cl['company_name'];

            $campaignName = '';
            if (isset($cl['campaign_name']) && trim($cl['campaign_name']) != '') 
            {
                $campaignName = ' - ' . str_replace($leadspeek_api_id,'',$cl['campaign_name']);
            }

            $company_name = str_replace($leadspeek_api_id,'',$cl['company_name']) . $campaignName;
            /* VARIABLE */

            /* WRITE THE DATA TO GOOGLE SPREADSHEET */
            if (count($content) > 0 && trim($clientSpreadSheetID) != '')
            {
                SendSpreadsheetJob::dispatch(
                    $clientSpreadSheetID,
                    $cl['clientowner'],
                    $leadspeek_api_id,
                    $leadspeek_type,
                    $md5param,
                    $content,
                    $cl['name'],
                    $company_name,
                    $campaignName,
                    $custEmail,
                    $companyNameOri
                )->onQueue('serve_lead_third_party');
            }
            /* WRITE THE DATA TO GOOGLE SPREADSHEET */
        }
        catch (\Throwable $e)
        {
            Log::error('public function processInsertLeadspeekReport error', [
                'message' => $e->getMessage()
            ]);
        }
    }

    public function processAutoTopupPrepaid($cl = [], $ori_platform_price_lead = 0, $ori_rootFeeCost = 0)
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            /* VARIABLE */
            $leadspeek_api_id = $cl['leadspeek_api_id'];
            $clientLimitLeads = $cl['lp_limit_leads'];
            $clientLimitFreq = $cl['lp_limit_freq'];
            $clientCostPerLead = $cl['cost_perlead'];
            $clientPlatformfee = $cl['platformfee'];
            $_lp_user_id = $cl['id'];
            $organizationid = $cl['leadspeek_organizationid'];
            $campaignsid = $cl['leadspeek_campaignsid'];
            $_user_id = $cl['user_id'];
            $clientLimitStartDate = ($cl['lp_limit_startdate'] == null || $cl['lp_limit_startdate'] == '0000-00-00')?'':$cl['lp_limit_startdate'];
            $clientAdminNotify = explode(',',$cl['admin_notify_to']);

            $campaignName = '';
            if (isset($cl['campaign_name']) && trim($cl['campaign_name']) != '') 
            {
                $campaignName = ' - ' . str_replace($leadspeek_api_id,'',$cl['campaign_name']);
            }

            $company_name = str_replace($leadspeek_api_id,'',$cl['company_name']) . $campaignName;
            /* VARIABLE */

            // Step 1: update status to 'done' for topups with status 'progress' and remaining balance 0
            $progressTopups = Topup::where('leadspeek_api_id','=',$leadspeek_api_id)
                                   ->where('topup_status','=','progress')
                                   ->first();
    
            $remainingBalance = Topup::where('id','=',$progressTopups->id)
                                     ->sum('total_leads') - DB::table('leadspeek_reports')
                                     ->where('topup_id','=',$progressTopups->id)
                                     ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                     ->count();  
    
            // change status to done
            if ($remainingBalance == 0) {
                Log::info("Balance 0 update status done topupID :" . $progressTopups->id . " Remaining Balance :" . $remainingBalance);
                Topup::where('id','=',$progressTopups->id)
                     ->update([
                        'balance_leads' => $remainingBalance,
                        'topup_status' => 'done'
                     ]);
            }else{
                Topup::where('id','=',$progressTopups->id)
                     ->update(['balance_leads' => $remainingBalance]);
            }
    
            /**GET THE TOPUP WITH STATUS NOT DONE */
            $idTopups = Topup::select(['id'])
                             ->where('leadspeek_api_id','=',$progressTopups->leadspeek_api_id)
                             ->where('topup_status','<>','done')
                             ->get();
    
            /** AFTER GET THE TOPU ID, COUNT remaining balance leads, sum total_leads from Toup up table based on leadspeek_api_id, and the top up status not done - sum row from report table based on leadspeek_api_id and topup_id */
            $remainingBalanceLeads = Topup::where('leadspeek_api_id','=', $leadspeek_api_id)
                                          ->where('topup_status','<>','done')
                                          ->sum('total_leads') - DB::table('leadspeek_reports')
                                          ->where('leadspeek_api_id','=',$progressTopups->leadspeek_api_id)
                                          ->whereIn('topup_id', $idTopups)
                                          ->count();
    
            // process of sending emails to clients and agencies that in 2 days there will be an automatic top-up
            $doubleClientLimitLeads = 2 * $clientLimitLeads;
            $is_send_email_prepaid = !empty($cl['is_send_email_prepaid'])?$cl['is_send_email_prepaid']:'F';
            // info(['clientLimitLeads' => $clientLimitLeads,'remainingBalanceLeads' => $remainingBalanceLeads,'doubleClientLimitLeads' => $doubleClientLimitLeads,'check_1' => $doubleClientLimitLeads >= $remainingBalanceLeads,'check_2' => $clientLimitLeads < $remainingBalanceLeads,'is_send_email_prepaid' => $is_send_email_prepaid,'stopcontinual' => $cl['stopcontinual'],'topupoptions' => $cl['topupoptions'],]);
            if($doubleClientLimitLeads >= $remainingBalanceLeads && $clientLimitLeads < $remainingBalanceLeads && $is_send_email_prepaid == 'F' && $cl['stopcontinual'] == 'F' && $cl['topupoptions'] == 'continual' && $clientLimitFreq == 'day') 
            {
                LeadspeekUser::where('leadspeek_api_id',$leadspeek_api_id)->update(['is_send_email_prepaid' => 'T']);
                try
                {
                    Log::info("Successfully Send Notification Topup Days Limit, Campaign ID = {$leadspeek_api_id} | Leads Per Day = {$clientLimitLeads} | Remaining Balance Leads = {$remainingBalanceLeads}");
                    $this->notificationPrepaidTopupTwoDaysLimit(array($cl['email']),$cl['user_id'],$cl['clientowner'],$cl['company_root_id'],$leadspeek_api_id,$clientLimitLeads,$remainingBalanceLeads);
                }
                catch(\Exception $e) 
                {
                    Log::error("Errors Send Notification Topup Two Days Limit, Campaign ID = {$leadspeek_api_id} | Leads Per Day = {$clientLimitLeads} | Remaining Balance Leads = {$remainingBalanceLeads}");
                }
            }
            // process of sending emails to clients and agencies that in 2 days there will be an automatic top-up
    
            Log::info("remainingBalanceLeads : " . $remainingBalanceLeads . " clientLimitLeads : " . $clientLimitLeads);
    
            if ($remainingBalanceLeads < $clientLimitLeads && $cl['stopcontinual'] == 'F' && $cl['topupoptions'] == 'continual' && $clientLimitFreq == 'day') {
                $freqContinualTopup = (isset($cl['continual_buy_options']) && $cl['continual_buy_options'] == 'Weekly')?1:4;
    
                /** CREATE PAYMENT HERE */
                $_usrInfo = User::select('id','customer_payment_id','customer_card_id','email','company_parent','company_id','payment_status')
                                ->where('id','=',$progressTopups->user_id)
                                ->where('active','=','T')
                                ->first();

                $data['cost_perlead'] = $clientCostPerLead;
                $data['total_leads'] = ($clientLimitLeads * 7) * $freqContinualTopup;
                $data['platformfee'] = $clientPlatformfee;
                $data['platform_price'] = $ori_platform_price_lead;
                $data['root_price'] = $ori_rootFeeCost;
    
                $AgencyManualBill = "F";
                $getParentInfo = Company::select('manual_bill')->where('id','=',$cl['company_parent'])->first();
                if ($getParentInfo) {
                    $AgencyManualBill = $getParentInfo->manual_bill;
                }
    
                if ($AgencyManualBill == "T" || trim($_usrInfo->payment_status) == "") {
                    /** TOP UP ARRAY */
                    $paramTopup = [  
                        'user_id' => $progressTopups->user_id,
                        'lp_user_id' => $progressTopups->lp_user_id,
                        'company_id' => $progressTopups->company_id,
                        'leadspeek_api_id' => $progressTopups->leadspeek_api_id,
                        'leadspeek_type' => $progressTopups->leadspeek_type,
                        'topupoptions' => $cl['topupoptions'],
                        'advance_information' => '',
                        'campaign_information_type_local' => '',
                        'platformfee' => $clientPlatformfee,
                        'cost_perlead' => $clientCostPerLead,
                        'lp_limit_leads' => $clientLimitLeads,
                        'total_leads' => ($clientLimitLeads * 7) * $freqContinualTopup,
                        'balance_leads' => ($clientLimitLeads * 7) * $freqContinualTopup,
                        'platform_price' => $ori_platform_price_lead,
                        'root_price' => $ori_rootFeeCost,
                        'treshold' => $clientLimitLeads,
                        'payment_amount' => '0',
                        'active' => 'T',
                        'stop_continue' => 'F',
                        'last_cost_perlead' => '0',
                        'last_limit_leads_day' => '0',
                        'topup_status' => 'queue',
                    ];

                    if($cl['leadspeek_type'] == 'local') 
                    {
                        $paramTopup['advance_information'] = $cl['advance_information'];
                        $paramTopup['campaign_information_type_local'] = $cl['campaign_information_type_local'];
                    }
                    /** TOP UP ARRAY */
                    //$totalFirstCharge = ($data['cost_perlead'] * $data['total_leads']) + $data['platformfee'];
                    $totalFirstCharge = ($data['cost_perlead'] * $data['total_leads']);
                    $_platformFee = ($data['platform_price'] * $data['total_leads']);
                    $_rootPrice = ($data['root_price'] * $data['total_leads']);
    
                    // Log::info([
                    //     'action' => 'auto topup',
                    //     '_platformFee' => $_platformFee,
                    //     '_rootPrice' => $_rootPrice,
                    //     'data' => $data,
                    //     'paramTopup' => $paramTopup
                    // ]);
    
                    $this->chargeClient($_usrInfo->customer_payment_id,$_usrInfo->customer_card_id,$_usrInfo->email,$totalFirstCharge,$cl['platformfee'],$_platformFee,$cl,$data,$_rootPrice,true,$paramTopup);
                }   
                /** CREATE PAYMENT HERE */
    
                // if (trim($_usrInfo[0]['payment_status']) == "") {
                //     $param = [  
                //     'user_id' => $progressTopups->user_id,
                //     'lp_user_id' => $progressTopups->lp_user_id,
                //     'company_id' => $progressTopups->company_id,
                //     'leadspeek_api_id' => $progressTopups->leadspeek_api_id,
                //     'leadspeek_type' => $progressTopups->leadspeek_type,
                //     'topupoptions' => $cl['topupoptions'],
                //     'platformfee' => $clientPlatformfee,
                //     'cost_perlead' => $clientCostPerLead,
                //     'lp_limit_leads' => $clientLimitLeads,
                //     'total_leads' => ($clientLimitLeads * 7) * 4,
                //     'balance_leads' => ($clientLimitLeads * 7) * 4,
                //     'platform_price' => $progressTopups->platform_price,
                //     'root_price' => $progressTopup->root_price,
                //     'treshold' => $clientLimitLeads,
                //     'payment_amount' => '0',
                //     'active' => 'T',
                //     'stop_continue' => 'F',
                //     'last_cost_perlead' => '0',
                //     'last_limit_leads_day' => '0',
                //     'topup_status' => 'queue',
                //     ];    
    
                //     $create = Topup::create($param);
    
                //     Log::info("Buy Top Up ID: " . $create->id);
                // }else{
                //     Log::info("FAILED Buy Top Up Payment Status : " . $_usrInfo[0]['payment_status'] . " USER ID :" . $_usrInfo[0]['id'] . " Payment ID :" . $_usrInfo[0]['customer_payment_id']);
                // }
            }
    
            if ($cl['topupoptions'] == 'continual') {
                // $remainingBalanceLeads = Topup::where('leadspeek_api_id', $progressTopups->leadspeek_api_id)
                //                             ->sum('balance_leads');
                /**GET THE TOPUP WITH STATUS NOT DONE */
                $idTopups = Topup::select(['id'])
                                 ->where('leadspeek_api_id','=', $progressTopups->leadspeek_api_id)
                                 ->where('topup_status','<>','done')
                                 ->get();
    
                /** AFTER GET THE TOPU ID, COUNT remaining balance leads, sum total_leads from Toup up table based on leadspeek_api_id, and the top up status not done - sum row from report table based on leadspeek_api_id and topup_id */
                $remainingBalanceLeads = Topup::where('leadspeek_api_id','=', $progressTopups->leadspeek_api_id)
                                              ->where('topup_status','<>','done')
                                              ->sum('total_leads') - DB::table('leadspeek_reports')
                                              ->where('leadspeek_api_id','=',$progressTopups->leadspeek_api_id)
                                              ->whereIn('topup_id', $idTopups)
                                              ->count();
            }
    
            // Step 2: make sure there is  no topup with status 'progress' exists before updating next queued topup
            $hasProgressTopup = Topup::where('leadspeek_api_id','=',$leadspeek_api_id)
                                     ->where('topup_status', 'progress')
                                     ->exists();
    
            if (!$hasProgressTopup) {
                $nextQueuedTopup = Topup::where('leadspeek_api_id','=',$leadspeek_api_id)
                                        ->where('topup_status','=','queue')
                                        ->orderBy('created_at', 'asc')
                                        ->first();
    
                if ($nextQueuedTopup) {
                    Topup::where('id','=',$nextQueuedTopup->id)
                         ->update(['topup_status' => 'progress']);
                }
            }
    
            /** IF REMAINING BALANCE ZERO THEN STOP THE CAMPAIGN */
            if (($remainingBalanceLeads <= 0 && $clientLimitFreq == 'day') || ($remainingBalanceLeads <= 0 && $cl['stopcontinual'] == 'T' && $clientLimitFreq == 'month')) {
    
                /** STOP CONTINUAL TOPUP*/
                $this->stop_continual_topup($_lp_user_id);
                /** STOP CONTINUAL TOPUP*/
    
                /** ACTIVATE CAMPAIGN SIMPLIFI */
                if ($organizationid != '' && $campaignsid != '') {
                    $camp = $this->startPause_campaign($organizationid,$campaignsid,'stop');
                    if ($camp == true) {
                        /** PUT CLIENT TO ARCHIVE OR STOP */
                        $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                        $updateLeadspeekUser->active = 'F';
                        $updateLeadspeekUser->disabled = 'T';
                        $updateLeadspeekUser->active_user = 'F';
                        $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                        $updateLeadspeekUser->last_balance_leads = null; // reset last_balance_leads
                        $updateLeadspeekUser->save();
                        /** PUT CLIENT TO ARCHIVE OR STOP */
    
                        $updateUser = User::find($_user_id);
                        $updateUser->lp_enddate = null;
                        $updateUser->lp_limit_startdate = null;
                        $updateUser->save();
    
                        $clientStartBilling = date('Ymd',strtotime($clientLimitStartDate));
                        $nextBillingDate = date('Ymd');
    
                        /** CALCULATION TOTAL LEADS TOP UP AND REPORT TOP UP */
                        $_idTopups = Topup::select(['id'])
                                        ->where('leadspeek_api_id','=', $progressTopups->leadspeek_api_id)
                                        ->where('topup_status','=','done')
                                        ->get();
                        $_TotalLimitLeads = LeadspeekReport::where('leadspeek_api_id','=',$progressTopups->leadspeek_api_id)
                                                        ->whereIn('topup_id', $_idTopups)
                                                        ->count();
                        $_clientLimitLeads = Topup::where('leadspeek_api_id','=', $progressTopups->leadspeek_api_id)  
                                                ->sum('total_leads');     
    
                        /** CALCULATION TOTAL LEADS TOP UP AND REPORT TOP UP */
    
                        /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                        $this->notificationStartStopLeads($clientAdminNotify,'Stopped (Prepaid ' . date('m-d-Y',strtotime($clientLimitStartDate)) . ' - ' . date('m-d-Y') . ')',$company_name . ' #' . $leadspeek_api_id,$_clientLimitLeads,$clientLimitFreq,$_TotalLimitLeads,$cl['clientowner'],true);
                        /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                    }else{
                        /** SEND EMAIL TO ME */
                        $details = [
                            'errormsg'  => 'Simpli.Fi Error Leadspeek ID :' . $leadspeek_api_id. '<br/>',
                        ];
                        $from = [
                            'address' => 'noreply@sitesettingsapi.com',
                            'name' => 'support',
                            'replyto' => 'noreply@sitesettingsapi.com',
                        ];
                        $this->send_email(array('serverlogs@sitesettingsapi.com'),'Start Pause Campaign Failed (INTERNAL - Webhook-ProcessDataMatch-1430) #' .$_leadspeek_api_id,$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                        /** SEND EMAIL TO ME */
                    }
                } else if ($cl['leadspeek_type'] == "local" || $cl['leadspeek_type'] == "enhance" || $cl['leadspeek_type'] == "b2b") {
                    /** PUT CLIENT TO ARCHIVE OR STOP */
                    $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                    $updateLeadspeekUser->active = 'F';
                    $updateLeadspeekUser->disabled = 'T';
                    $updateLeadspeekUser->active_user = 'F';
                    $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                    $updateLeadspeekUser->last_balance_leads = null; // reset last_balance_leads
                    $updateLeadspeekUser->save();
                    /** PUT CLIENT TO ARCHIVE OR STOP */
    
                    $updateUser = User::find($_user_id);
                    $updateUser->lp_enddate = null;
                    $updateUser->lp_limit_startdate = null;
                    $updateUser->save();
    
                    $clientStartBilling = date('Ymd',strtotime($clientLimitStartDate));
                    $nextBillingDate = date('Ymd');
    
                    /** CALCULATION TOTAL LEADS TOP UP AND REPORT TOP UP */
                    $_idTopups = Topup::select(['id'])
                                      ->where('leadspeek_api_id','=', $progressTopups->leadspeek_api_id)
                                      ->where('topup_status','=','done')
                                      ->get();
                    $_TotalLimitLeads = LeadspeekReport::where('leadspeek_api_id','=',$progressTopups->leadspeek_api_id)
                                                       ->whereIn('topup_id', $_idTopups)
                                                       ->count();
                    $_clientLimitLeads = Topup::where('leadspeek_api_id','=', $progressTopups->leadspeek_api_id)  
                                              ->sum('total_leads');     
    
    
                    /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                    $this->notificationStartStopLeads($clientAdminNotify,'Stopped (Prepaid ' . date('m-d-Y',strtotime($clientLimitStartDate)) . ' - ' . date('m-d-Y') . ')',$company_name . ' #' . $leadspeek_api_id,$_clientLimitLeads,$clientLimitFreq,$_TotalLimitLeads,$cl['clientowner'],true);
                    /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                }
                /** ACTIVATE CAMPAIGN SIMPLIFI */
            }
            /** IF REMAINING BALANCE ZERO THEN STOP THE CAMPAIGN */
        }
        catch (\Throwable $e)
        {
            Log::error('public function processAutoTopupPrepaid error', [
                'message' => $e->getMessage()
            ]);
        }
    }

    public function check_campaign_result()
    {
        // $today = Carbon::parse('2024-11-01');
        $today = Carbon::now()->toDateString();
        $endDate = $today;
        $startDate = Carbon::parse($endDate)->subDays(7)->toDateString();

        $subQuery = LeadsListsQueue::select('leadspeek_api_id')
        ->where('leads_received', 0)
        ->whereDate('created_at', '>=' ,$startDate)
        ->whereDate('created_at', '<' ,$endDate)
        ->groupBy('leadspeek_api_id')
        ->havingRaw('COUNT(*) >= 7');
    
        $campaigns = LeadspeekUser::joinSub($subQuery, 'campaigns', function ($join) {
                $join->on('leadspeek_users.leadspeek_api_id', '=', 'campaigns.leadspeek_api_id');
            })
            ->join('users', 'leadspeek_users.user_id', '=', 'users.id')
            ->where('leadspeek_users.active', 'T')
            ->where('leadspeek_users.disabled', 'F')
            ->where('leadspeek_users.active_user', 'T')    
            ->where('leadspeek_users.leadspeek_type','enhance')    
            ->select('leadspeek_users.id','leadspeek_users.campaign_name','leadspeek_users.leadspeek_api_id','leadspeek_users.national_targeting','leadspeek_users.leadspeek_locator_state','leadspeek_users.leadspeek_locator_city','leadspeek_users.leadspeek_locator_zip','leadspeek_users.leadspeek_locator_keyword','leadspeek_users.active', 'leadspeek_users.disabled', 'leadspeek_users.active_user','users.name','leadspeek_users.company_id','leadspeek_users.weeks_without_leads')
            ->where(function ($query) use ($today) {
                $query->whereNull('leadspeek_users.last_email_sent_at')
                      ->orWhereDate('leadspeek_users.last_email_sent_at', '<', Carbon::parse($today)->subDays(7));
            })        
            ->get();

        if (!empty($campaigns)) {
            foreach ($campaigns as $campaign) {
            try {
                $campaign->last_email_sent_at = $today;
                $campaign->weeks_without_leads += 1;
                $campaign->save();

                if ($campaign->weeks_without_leads >= 4) {
                    LeadspeekUser::where('id', $campaign->id)->update([
                        'active' => 'F',
                        'disabled' => 'T',
                        'active_user' => 'T'
                    ]);//pause campaign

                }

                /** SEND THE EMAIL */
                $ownedcompanyid = "";
                $dayspast = "7";
                
                $ownedcompanyid = $campaign->company_id;
                
                switch ($campaign->weeks_without_leads) {
                    case 1:
                        $dayspast = "7";
                        break;
                    case 2:
                        $dayspast = "14";
                        break;
                    case 3:
                        $dayspast = "21";
                        break;
                    case 4:
                        $dayspast = "28";
                        break;
                }

                $subject = 'Your Campaign Needs Attention '. $campaign->name. ' #'.$campaign->leadspeek_api_id.': No Leads in the Past ' . $dayspast . ' Days';

                $details = [
                    'leadspeek_api_id' => $campaign->leadspeek_api_id,
                    'campaign_name' => $campaign->campaign_name,
                    'state' => $campaign->leadspeek_locator_state,
                    'city' => $campaign->leadspeek_locator_city,
                    'zip' => $campaign->leadspeek_locator_zip,
                    'keyword' => $campaign->leadspeek_locator_keyword,
                    'national_targeting' => $campaign->national_targeting,
                    'weeks_without_leads' => $campaign->weeks_without_leads,
                ];

                $defaultdomain = $this->getDefaultDomainEmail($ownedcompanyid);

                $from = [
                    'address' => 'noreply@' . $defaultdomain,
                    'name' => 'noreply@' . $defaultdomain,
                    'replyto' => 'noreply@' . $defaultdomain,
                ];        
                
                //notify agency admin
                $AdminDefaultSMTP = $this->get_default_admin($ownedcompanyid);

                if (count($AdminDefaultSMTP) > 0) {
                    foreach ($AdminDefaultSMTP as $admin) {
                        $first_name = explode(' ', trim($admin->name));
                        $details['name'] = $first_name[0];
                        $this->send_email(array($admin->email),$subject,$details,array(),'emails.bigdbmcheckcampaign',$from,$ownedcompanyid);
                    }
                }

                $this->send_email(array('serverlogs@sitesettingsapi.com'),$subject,$details,array(),'emails.bigdbmcheckcampaign',$from,'');

                if ($campaign->weeks_without_leads >= 4) {
                    $campaign->weeks_without_leads = 0;
                    $campaign->save();
                }

                /** SEND THE EMAIL */
            } catch (\Throwable $th) {
                Log::warning([
                    'result' => 'error bigdbm campaign check result of 7 days',
                    'message' => $th->getMessage(),
                    'leadspeek_api_id' => $campaign->leadspeek_api_id,
                ]);
            }
            }
        }else {
            return response()->json([
                'result' => 'success',
                'message' => 'campaign with 0 result in previous 7 days in a row not found'
            ]);
        }
        
        //return response()->json(['campaigns' => $campaigns]);
    }

    public function zapier() {
        // set dummy param 
        $company_id = 90;
        $leadspeek_api_id = '891680';
        $leadspeek_type = 'locator';
        // set dummy param 
        
        $chkZap = IntegrationSettings::select('api_key', 'enable_sendgrid')
            ->where('company_id', '=', $company_id)
            ->where('integration_slug', 'zapier')
            ->where('enable_sendgrid', 1)
            ->first();
    
        $campaign = LeadspeekUser::select('leadspeek_users.id', 'leadspeek_users.zap_tags', 'leadspeek_users.zap_is_active', 'leadspeek_users.zap_webhook', 'leadspeek_users.company_id')
            ->where('leadspeek_api_id', '=', $leadspeek_api_id)
            ->where('zap_is_active', 1)
            ->first();
        if ($chkZap) {
            if ($chkZap->api_key != '' && $chkZap->enable_sendgrid == 1) {
                $webhook = ($campaign && $campaign->zap_webhook != '') ? explode('|',$campaign->zap_webhook) : explode('|',$chkZap->api_key);
                $tags = ($campaign && !empty($campaign->zap_tags)) ? json_decode($campaign->zap_tags) : '';
                if ($campaign && $campaign->zap_is_active == 1) {
                    foreach ($webhook as $url) {
                        $send_to_zapier = $this->zap_sendrecord(
                            $url,
                            date('Y-m-d'),
                            ucfirst(strtolower('agies')),
                            ucfirst(strtolower('wahyudi')),
                            'agieswahyudi@gmail.com',
                            'agiesganteng2gmail.com',
                            '081398257238',
                            '021524352689',
                            'plara',
                            'plara2',
                            'sukabumi',
                            'jawa barat',
                            '43356',
                            'keyword',
                            $tags,
                            $leadspeek_api_id,
                            $leadspeek_type
                        );
                    }
                    return response()->json(['message' => 'lead sent successfully to zapier']);
                }
            }
        } else {
            return response()->json(['message' => 'this agency has no any integrations with zapier']);
        }
        return response()->json(['message' => 'done']);
    }
    
    public function gohighlevel() {
        $leadspeek_api_id = '813938';
        $campaigns = LeadspeekUser::select('leadspeek_users.id','leadspeek_users.ghl_tags','leadspeek_users.ghl_is_active','leadspeek_users.company_id','leadspeek_users.ghl_remove_tags','users.company_id as client_company_id')
                                ->join('users','users.id','=','leadspeek_users.user_id')
                                ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                ->get();
        $_ghl_api_key = "";
        $_enable_ghl = "";
        $_client_company_id = $campaigns[0]['client_company_id'];
        $chkGhl = IntegrationSettings::select('api_key','enable_sendgrid')
                                ->where('company_id','=',$_client_company_id)
                                ->where('integration_slug','=','gohighlevel')
                                ->get();
        if (count($chkGhl) > 0) {
            $_ghl_api_key = $chkGhl[0]['api_key'];
            $_enable_ghl = $chkGhl[0]['enable_sendgrid'];
        }

        if ($_ghl_api_key != "" && $_enable_ghl == "1" && $campaigns[0]['ghl_is_active'] == "1") {
            /** CREATE GHL CONTACT AND ATTACHED THE TAG IF EXIST */

            /** CHECK IF TAG EXIST ON GHL */
            $tags = [];
            $saveTags = [];
            $removeTags = [];

            $ghltags = json_decode($campaigns[0]['ghl_tags']);
            $ghltagsbuffer = $ghltags;            
            if (isset($ghltags) && count($ghltags) > 0) {
                // get all tags
                $resultGetTags = $this->ghl_getTags($_ghl_api_key);
                $getAllTags = [];
                if(isset($resultGetTags->tags) && count($resultGetTags->tags) > 0) {
                    $getAllTags = $resultGetTags->tags;
                }
                // info('', ['resultGetTags' => $resultGetTags]);
                // info('', ['getAllTags' => $getAllTags]);
                // info('', ['ghltags' => $ghltags]);
                // get all tags  

                foreach($ghltags as $index => $item) {
                    $partItem = explode('|',$item);

                    /* SYNC ID AND TAGS */
                    if(count($getAllTags) > 0 && isset($partItem[0]) && isset($partItem[1])) {
                        foreach($getAllTags as $item) {
                            if($item->name == $partItem[1] && $item->id != $partItem[0]) {
                                $partItem[0] = $item->id;
                                $ghltags[$index] = implode('|', $partItem);
                            }
                        }
                    }
                    /* SYNC ID AND TAGS */

                    /** CHECK IF TAG STILL EXIST ON GOHIGHLEVEL */
                    $chkTag = $this->ghl_getTag($partItem[0],$_ghl_api_key);
                    /** CHECK IF TAG STILL EXIST ON GOHIGHLEVEL */
                    if ($chkTag != '' && $chkTag != 'sys_removed') {
                        $tags[] = $partItem[1];
                        $saveTags[] = $partItem[0] . '|' . $partItem[1];
                    }else if ($chkTag == 'sys_removed') {
                        $removeTags[] = $partItem[1];
                    }
                }

                // jika ada tag name sebelumnya namun id nya berbeda, sinkron id nya
                $ghlTagsDiff = array_diff($ghltagsbuffer, $ghltags);
                $ghlTagsDiff = array_values($ghlTagsDiff);
                // info(['ghlTagsDiff' => $ghlTagsDiff]);
                // info(['ghltags' => $ghltags]);

                if(count($ghlTagsDiff) > 0) {
                    // info('update ghl_tags');
                    LeadspeekUser::where('leadspeek_api_id','=',$leadspeek_api_id)
                                 ->update([
                                    'ghl_tags' => $ghltags
                                 ]);
                }
                // jika ada tag name sebelumnya namun id nya berbeda, sinkron id nya
            }

            /** IF THERE ARE REMOVE TAG FROM SYSTEM THEN UPDATE/SYNC THE TAG ON THE CAMPAIGN */
            if (count($removeTags) > 0) {
                // $update = LeadspeekUser::where('id',$campaigns[0]['id'])
                //                         ->update(['ghl_tags' => json_encode($saveTags),'ghl_remove_tags' => $removeTags]);
            }
            /** IF THERE ARE REMOVE TAG FROM SYSTEM THEN UPDATE/SYNC THE TAG ON THE CAMPAIGN */

            /** CHECK IF TAG EXIST ON GHL */

            /** INSERT INTO GHL CONTACT */

            $this->ghl_createContact('58',$_ghl_api_key,'11111','2024-02-21','Ajoe','Doe','ajoedoe@gmail.com','ajoedoe2@gmail.com','111-111-1111','222-222-2222','Stree Address 1','Street Address 2','Dolorado','AL','2322','test key',$tags);
            /** INSERT INTO GHL CONTACT */

            /** CREATE GHL CONTACT AND ATTACHED THE TAG IF EXIST */
        }
    }

    /** RENDERING TO GET LEADS FROM WEBHOOK TOWER DATA */
    public function test_cache() {
        Cache::store('redis')->put('testcache','all cached', 30);
        echo Cache::store('redis')->get('testcache');
    }

    public function test_flush() 
    {
        // info('masuk flush');
        // return Cache::store('redis')->flush();
    }

    /**
     * Untuk Menghapus Key Redis
     */
    public function cacheForget(string $cacheKey)
    {
        return Cache::store('redis')->forget($cacheKey);
    }

    /**
     * Untuk Mengecek Apakah Key Ini Ada Atau Tidak Di Redis, Jika Ada True, Jika Tidak Ada False
     */
    public function cacheHasResult(string $cacheKey)
    {
        return Cache::store('redis')->has($cacheKey);
    }

    /**
     * Untuk Mengambil Value Dari Key Redis
     */
    public function cacheGetResult(string $cachekey)
    {
        return Cache::store('redis')->get($cachekey);
    }

    /**
     * Ji
     */
    public function cacheQueryResult(string $cacheKey, int $ttl, Closure $query)
    {
        return Cache::store('redis')->remember($cacheKey, $ttl, $query);
    }

    public function check_cache_query($type="",$data=array()) {
        if (trim($type) == "checkCampaignIsActive") {
            $campaign = true;

            $_campaignID = $data['leadspeek_api_id'];
            $cacheKey = "checkCampaignIsActive_{$_campaignID}";
            //Log::info("Cache Name: " . $cacheKey);

            try {
                $_cache = Cache::store('redis')->get($cacheKey);
                //echo "campaign val: " . $_cache . '<br>';
                
                if ($_cache !== null) {
                    if ($_cache == 'F') {
                        $campaign = false;
                    }else{
                        $campaign = true;
                    }
                }
                
                if ($campaign) {
                    $campaign = LeadspeekUser::where('leadspeek_api_id','=',$_campaignID)
                                    ->where('active','=','T')
                                    ->where('disabled','=','F')
                                    ->where('active_user','=','T')
                                    ->where('archived','=','F')
                                    ->exists();
                    //Log::info("Masuk 1");
                    if (!$campaign) {
                        //Log::info("Campaign Not Active");
                        Cache::store('redis')->put($cacheKey,'F', 30);
                    }
                    // else{
                    //     Log::info("Campaign Active");
                    // }
                }
                // else{
                //     Log::info("Campaign Cache");
                // }

                return $campaign;

            }catch (Exception $e) {
                Log::error("Cache retrieval (checkCampaignIsActive) failed or Redis unavailable: " . $e->getMessage());
                try {
                    //Log::info("Masuk 2");
                    $campaign = LeadspeekUser::where('leadspeek_api_id','=',$_campaignID)
                                    ->where('active','=','T')
                                    ->where('disabled','=','F')
                                    ->where('active_user','=','T')
                                    ->where('archived','=','F')
                                    ->exists();
                    return $campaign;
    
                } catch (Exception $dbException) {
                    //Log::info("Masuk 3");
                    // Log the database error
                    Log::error("Database Error: " . $dbException->getMessage());
                    return "";
                }
            }
            
        }
    }

    private function is_ssl_exists($url)
    {
        /*try {
            $orignal_parse = parse_url($url, PHP_URL_HOST);
            $get = stream_context_create(array("ssl" => array("verify_peer" => false,"verify_peer_name" => false,"capture_peer_cert" => TRUE)));
            $read = stream_socket_client("ssl://" . $orignal_parse . ":443", $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $get);
            $cert = stream_context_get_params($read);
            $certinfo = openssl_x509_parse($cert['options']['ssl']['peer_certificate']);

            if (isset($certinfo) && !empty($certinfo)) {
                if (
                    isset($certinfo['name']) && !empty($certinfo['name']) &&
                    isset($certinfo['issuer']) && !empty($certinfo['issuer'])
                ) {
                    return true;
                }
                return false;
            }
            return false;
        }catch (Exception $e) {
            return false;
        }*/
        
        $ch=curl_init(); 
        $timeout=5; 
        curl_setopt($ch, CURLOPT_URL, $url); 
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout); 
        $contents = curl_exec($ch); 
        // close handle to release resources 
        curl_close($ch);

        if ($contents != '') {
            return true;
        }else{
            return false;
        }
    }

    function getMainDomain($url) {
        $host = parse_url($url, PHP_URL_HOST) ?: $url; // Ambil hostname
        $host = str_replace("www.", "", $host); // Hapus "www."

        // Daftar TLD tingkat dua yang umum digunakan
        // $twoLevelTLDs = ['com','co','id','co.id', 'ac.id', 'sch.id', 'go.id', 'my.id', 'co.uk', 'gov.uk', 'org.uk', 'edu.au', 'gov.co','c.id'];

        // Regex untuk menangkap domain utama dengan mempertimbangkan TLD
        if (preg_match('/([a-z0-9-]+)\.([a-z0-9-]+\.[a-z]{2,63}|[a-z]{2,63})$/i', $host, $matches)) {
            $fullDomain = $matches[0]; // Ambil hasil regex
            $parts = explode('.', $fullDomain);
            $count = count($parts);

            // Jika domain memiliki lebih dari 2 bagian, cek apakah termasuk TLD tingkat dua
            if ($count > 2) {
                $lastTwo = implode('.', array_slice($parts, -2)); // Ambil 2 bagian terakhir (TLD tingkat dua)

                // Jika termasuk dalam daftar DB TLD tingkat dua, ambil 3 bagian terakhir
                $exist_tld = TldDomain::where('tld','=',$lastTwo)->first();
                if ($exist_tld) {
                    $res = implode('.', array_slice($parts, -3));
                } else {
                    $res = implode('.', array_slice($parts, -2)); // Jika bukan, ambil 2 bagian terakhir
                }
                
            } else {
                $res = $fullDomain; // Jika hanya 2 bagian, kembalikan langsung
            }
            
        }

        return $res; // Jika regex gagal, kembalikan hostname asli
    }
    
    public function renderingPixel(Request $request) {
        //$md5param = (isset($request->md5_email))?trim($request->md5_email):'';
        $label = (isset($request->label))?trim($request->label):'';
        $customParams = (isset($request->customParams) && is_string($request->customParams))?trim($request->customParams):'';
        $script = (isset($request->script))?trim($request->script):'';
        // info(__FUNCTION__, ['all_request' => $request->all()]);

        /* TESTING EMBEDED CODE */
        $check_test = explode('|', $label);
        $test = isset($check_test[1]) && str_contains($check_test[1], 'test=true');
        if ($test){
            try {
                $label = explode('|', $label);
                $leadspeek_api_id = !empty($label[0]) ? $label[0] : '' ;
                $campaign = LeadspeekUser::where('leadspeek_api_id',$leadspeek_api_id)->first();
                $campaign->embedded_fire_status = 'success';
                $campaign->save();
            } catch (\Throwable $th) {
                Log::info(['error_test_embededcode' => $th->getMessage()]);
            }
            return response()->json(array('result'=>'success','message'=>'Embeded Code is running perfectly!'));
            exit;die();
        }
        /* TESTING EMBEDED CODE */

        /* GET VISITOR ID CLIENT BROWSER */
        $getvariableVisitorClientBrowser = $this->getvariableVisitorClientBrowser($request);
        $dataPixelLeadRecord = isset($getvariableVisitorClientBrowser['dataPixelLeadRecord'])?$getvariableVisitorClientBrowser['dataPixelLeadRecord']:[];
        $pixelLeadRecordID = '';
        // info(__FUNCTION__, ['dataPixelLeadRecord' => $dataPixelLeadRecord]);
        /* GET VISITOR ID CLIENT BROWSER */

        /** NEW METHOD TO ANTICIPATE ID PUT IT ON URL AS WEB URL */
        $queryParameters = $request->query();
        // info('', ['queryParameters' => $queryParameters]);
        $labelValue = '';
        foreach ($queryParameters as $key => $value) {
            if (strpos($key, 'id') === 0) {
                $labelValue .= $value;
                unset($queryParameters[$key]);
            }
        }
        // info('', ['labelValue' => $labelValue,]);
        // if ($labelValue !== '') {
        //     $queryParameters['label'] = $queryParameters['label'] . "&id=" . $labelValue;
        // }
        // info('', ['queryParameters' => $queryParameters]);
        // // Construct the new URL with the modified query parameters
        // $fullURL = $request->fullUrlWithQuery($queryParameters); 
        // info('', ['fullURL' => $fullURL]);
        // $replaceURL = $request->url() . '?label='; 
        // info('', ['replaceURL' => $replaceURL,]);
        // // $fullURL = $request->fullUrl();
        // $label = urldecode(str_replace(array($replaceURL,"&script=true"),array("",""),$fullURL));
        // info('', ['label' => $label]);
        /** NEW METHOD TO ANTICIPATE ID PUT IT ON URL AS WEB URL */

        if ($label != "") {
            $data = explode("|",$label);
            $leadspeek_api_id = (isset($data[0]))?trim($data[0]):'';
            $keyword = (isset($data[1]))?trim($data[1]):'';

            // GET SIMPLIFI TAG
            $simplifi_tag_url = null;
            if ($leadspeek_api_id != "") {
                try {
                    $site_id_campaign = LeadspeekUser::select('id')->where('leadspeek_api_id', $leadspeek_api_id)
                                        ->where('leadspeek_type','local')
                                        ->where('archived','F')
                                        ->first();
                    if ($site_id_campaign) {
                        $audience_campaign = LeadspeekAudienceCampaign::select('leadspeek_audience_campaign.*', 'leadspeek_users.leadspeek_organizationid')
                            ->join('leadspeek_users', 'leadspeek_users.leadspeek_api_id', '=', 'leadspeek_audience_campaign.leadspeek_api_id')
                            ->where('leadspeek_audience_campaign.media_id', $site_id_campaign->id)
                            ->where('leadspeek_audience_campaign.audience_type', 'campaign')
                            ->where('leadspeek_users.active', 'T')
                            ->where('leadspeek_users.disabled', 'F')
                            ->where('leadspeek_users.active_user', 'T')
                            ->where('leadspeek_users.archived', 'F')
                            ->first();
                        if ($audience_campaign && !empty($audience_campaign->leadspeek_organizationid)) {
                            $simplifiService = App::make(SimpliFiService::class);
                            $tagResponse = $simplifiService->get_organization_tag((int) $audience_campaign->leadspeek_organizationid);
    
                            $tag_identifier = $tagResponse['organization_tags'][0]['tag_identifier'] ?? null;
                            if ($tag_identifier) {
                                $baseUrl = 'https://tag.simpli.fi/sifitag/';
                                $simplifi_tag_url = $baseUrl . $tag_identifier;
                            }
                        }
                    }
                } catch (\Throwable $th) {
                    Log::error('Failed to get Simpli.fi tag URL during pixel render', [
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'error' => $th->getMessage()
                    ]);
                    $simplifi_tag_url = null;
                }
            }
            // GET SIMPLIFI TAG                    

            /** BLOCK RENDERING IF TV as Keywored */
            if (trim(strtolower($keyword)) == "tv" || preg_match('/^[a-zA-Z]{2}$/', trim($keyword))) {
                return response()->json(array('result'=>'failed','msg'=>'bannedkeyword', 'tag_url' => $simplifi_tag_url));
                exit;die();
            }
            /** BLOCK RENDERING IF TV as Keywored */
            
            // Log::info(['url' => $keyword,'leadspeek_api_id' => $leadspeek_api_id]);

            //// untuk saat ini pengecekan ke field embedded_play = 1
            //// ketika play campaign (embeded_play = 1) cek metode url baru,
            //// ketika campaign yg sudah berjalan (embeded_play null) pakai metode lama 
            // $check_dt = LeadspeekUser::select('leadspeek_users.url_code', 'u1.email as email_client', 'u2.email as email_agency', 
            //                                     'u1.company_parent', 'u1.company_root_id', 'leadspeek_users.admin_notify_to')
            //                             ->join('users as u1', 'u1.id', '=', 'leadspeek_users.user_id')
            //                             ->join('companies as u2', 'u2.id', '=', 'u1.company_parent')
            //                             // whereEncrypted('url_code', $keyword)
            //                             ->where('leadspeek_users.leadspeek_api_id','=',$leadspeek_api_id)
            //                             ->where('leadspeek_users.embedded_play','=',1)
            //                             ->where('leadspeek_users.leadspeek_type','=','local')
            //                             ->first();

            $check_dt = LeadspeekUser::select('url_code')
                                        ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                        ->where('active','=','T')
                                        ->where('disabled','=','F')
                                        ->where('active_user','=','T')
                                        ->where('archived','=','F')
                                        ->where('embedded_play','=',1)
                                        ->where('leadspeek_type','=','local')
                                        ->first();

            $embedded_play_check = false;
            $url_check = false;

            if ($check_dt) {
                $embedded_play_check = true;

                $keywordCek = parse_url($keyword, PHP_URL_HOST);
                $keywordCek = preg_replace('/\s+|^www\./', '', $keywordCek);
                //// ga usah pakai cek main domain
                // $keywordCek = $this->getMainDomain($keyword);
                
                $urlCek = $check_dt->url_code;
                $urlCek = str_replace(" ", "", $urlCek);
                $urls = explode("|", $urlCek); 
                $urlcode_arr = array_map(function($url) {
                        if (!preg_match("~^https?://~", $url)) {
                            $url = "https://" . $url; 
                        }
                        $new_urlcek = parse_url($url, PHP_URL_HOST) ?: $url;
                        $new_urlcek = str_replace("www.", "", $new_urlcek);
                        return $new_urlcek;
                        //// ga usah pakai cek main domain
                        // return $this->getMainDomain($url);
                    }, $urls);

                if (in_array($keywordCek, $urlcode_arr)) {
                    $url_check = true;
                } else {
                    /////// sementara di return true dulu biar tetep jalan pakai yg lama, tapi ketika not match tetep di log
                    $url_check = true;
                    //// sementara kirim email di coment dulu
                    // //// cek exist error embeded code? (only one time send email)
                    // $check_fail = FailedRecord::select('id')
                    //                     ->where('leadspeek_api_id','=',$leadspeek_api_id)
                    //                     ->where('description','like','%URL does not match%')
                    //                     ->exists();
                    // //// ketika checkfail tidak ada, send email
                    // if(!$check_fail) {
                    //     //// send email disini
                    //     $title = 'Embedded Code URLs doesnot match For Campaign #'.$leadspeek_api_id;
                    //     $result = '"' . implode('" or "', $urlcode_arr) . '"';
                        
                    //     $content = 'Embedded Code for campaign #'.$leadspeek_api_id.' doesnot match with URLs where you place the code. Embedded code is called from '.$keywordCek.', should be from ' . $result . '.';
                    //     $details = [
                    //         'title' => $title,
                    //         'content'  => $content,
                    //     ];
                    //     $attachement = array();
                    //     $isQueue = true;
                    //     $adminEmail = array();
                    //     $clientAdminNotify = explode(',',trim($check_dt->admin_notify_to));
                    //     $tmp = User::select('email')->whereIn('id', $clientAdminNotify)->get();
                    //     foreach($tmp as $ad) {
                    //         array_push($adminEmail,trim($ad['email']));
                    //     }

                    //     // $agencyEmail = $check_dt->email_agency;
                    //     $defaultdomainRoot = $this->getDefaultDomainEmail($check_dt->company_root_id);
                    //     $fromRoot = [
                    //         'address' => 'noreply@' . $defaultdomainRoot,
                    //         'name' => 'Error Embed code',
                    //         'replyto' => 'support@' . $defaultdomainRoot,
                    //     ];
                    //     $companyParentRoot = $check_dt->company_root_id;
                    //     //// send email ke agency dari root
                    //     $this->send_email($adminEmail,$title,$details,$attachement,'emails.customemail',$fromRoot,$companyParentRoot,$isQueue);
                    // }

                    //// insert logs to failed_records
                    FailedRecord::create([
                    'email_encrypt' => ' ',
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'description' => "URL does not match|embedded code is called from ".$keywordCek.", should be from " . json_encode($urlcode_arr),
                    ]);

                    // return response()->json(array('result'=>'failed','msg'=>"URL doesn't match with campaign.."));
                }
            }  

            //if (($embedded_play_check == false) || ($embedded_play_check == true && $url_check == true)) {
            if (true) {
                //// MAIN CODE
                if ($leadspeek_api_id != "") {
                    //$campaign = LeadspeekUser::select('id')
                    // $campaign = LeadspeekUser::where('leadspeek_api_id','=',$leadspeek_api_id)
                    //             ->where('active','=','T')
                    //             ->where('disabled','=','F')
                    //             ->where('active_user','=','T')
                    //             //->get();
                    //             ->exists();

                    $data['leadspeek_api_id'] = $leadspeek_api_id;
                    $campaign = $this->check_cache_query("checkCampaignIsActive",$data);

                    //if (count($campaign) > 0) {
                    if ($campaign) 
                    {
                        /* VALIDATION LEADS ZERO, IN LOCAL, PREPAID, CONTINUAL, LIMIT MONTH */
                        $lead = LeadspeekUser::where('leadspeek_api_id', $leadspeek_api_id)
                                             ->where('active','T')
                                             ->where('disabled','F')
                                             ->where('active_user','T')
                                             ->where('archived','F')
                                             ->first();

                        $leadspeek_type = isset($lead->leadspeek_type)?$lead->leadspeek_type:'';
                        $paymentterm = isset($lead->paymentterm)?$lead->paymentterm:'';
                        $topupoptions = isset($lead->topupoptions)?$lead->topupoptions:'';
                        $lp_limit_freq = isset($lead->lp_limit_freq)?$lead->lp_limit_freq:'';
                        $stopcontinual = isset($lead->stopcontinual)?$lead->stopcontinual:'';

                        // info(['action' => 'VALIDATION LEADS ZERO, IN LOCAL, PREPAID, CONTINUAL, LIMIT MONTH','leadspeek_type' => $leadspeek_type,'paymentterm' => $paymentterm,'topupoptions' => $topupoptions,'lp_limit_freq' => $lp_limit_freq,'stopcontinual' => $stopcontinual,]);

                        if($lead) 
                        {
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeek_type,'renderingpixelfire');
                            $dataPixelLeadRecord['leadspeek_api_id'] = $leadspeek_api_id;
                            $dataPixelLeadRecord['campaign_status'] = 'running';
                            $pixelLeadRecordID = $this->UpsertPixelLeadRecord($dataPixelLeadRecord);
                        }

                        if($leadspeek_type == 'local' && $paymentterm == 'Prepaid' && $topupoptions == 'continual' && $stopcontinual == 'F' && $lp_limit_freq == 'month')
                        {
                            $idTopups = Topup::select(['id'])
                                             ->where('leadspeek_api_id','=', $leadspeek_api_id)
                                             ->where('topup_status','<>','done')
                                             ->get();

                            $remainingBalanceLeads = Topup::where('leadspeek_api_id','=', $leadspeek_api_id)
                                                          ->where('topup_status','<>','done')
                                                          ->sum('total_leads') - DB::table('leadspeek_reports')
                                                          ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                                          ->whereIn('topup_id', $idTopups)
                                                          ->count();

                            // info('', ['action' => 'check remainingbalance','idTopups' => $idTopups,'totalLeadsTopup' => Topup::where('leadspeek_api_id','=', $leadspeek_api_id)->where('topup_status','<>','done')->sum('total_leads'),'totalLeadsReport' => DB::table('leadspeek_reports')->where('leadspeek_api_id','=',$leadspeek_api_id)->whereIn('topup_id', $idTopups)->count(),'remainingBalanceLeads' => $remainingBalanceLeads,]);

                            if($remainingBalanceLeads <= 0)
                            {
                                // karena remaining leads 0 dan status nya running, maka berubah menjadi paused on run
                                $lead->active = 'F';
                                $lead->disabled = 'F';
                                $lead->active_user = 'T';
                                $lead->save();
                                // karena remaining leads 0 dan status nya running, maka berubah menjadi paused on run

                                // info("PREPAID CONTINUAL LIMIT MONTH IN WILL ALREADY FULL, REMAININGLEADS : {$remainingBalanceLeads}");
                                return response()->json(array('result'=>'failed','msg'=>'remaining balance zero', 'tag_url' => $simplifi_tag_url));
                                exit;die();
                            }
                        }
                        /* VALIDATION LEADS ZERO, IN LOCAL, PREPAID, CONTINUAL, LIMIT MONTH */

                        $webhookcode = 'abiant3a';
                        $_webhookcode = config('services.application.webhookcode');
                        if (isset($_webhookcode) && trim($_webhookcode) != '') {
                            $webhookcode = $_webhookcode;
                        }
                        
                        $labelAlocdnSubParts = array_filter([$leadspeek_api_id,$pixelLeadRecordID,$customParams]);
                        $labelAlocdnSubPartsString = implode('-', $labelAlocdnSubParts);

                        $labelAlocdnParts = array_filter([$labelAlocdnSubPartsString, $keyword]);
                        $labelAlocdnString = implode('|', $labelAlocdnParts); // hasil akhir "{leadspeek_api_id}-{pixelLeadRecordID}-{customParams}|{keyword}" atau "{leadspeek_api_id}-{pixelLeadRecordID}|{keyword}"
                        
                        $paramsArray = array_filter(['label' => $labelAlocdnString,'id' => $labelValue]);
                        $paramsString = http_build_query($paramsArray);
                        $apiURL = "https://p.alocdn.com/c/{$webhookcode}/a/xtarget/p.gif?{$paramsString}";
                        // info('', ['labelAlocdnParts' => $labelAlocdnParts,'apiURL' => $apiURL, 'apiURLDecoded' => urldecode($apiURL)]);
                        // $apiURL = 'https://p.alocdn.com/c/' . $webhookcode . '/a/xtarget/p.gif?label=' . $leadspeek_api_id . '|' . urlencode($keyword);
                        // info('', ['apiURL' => urldecode($apiURL)]);

                        if ($script == "true") {
                            return response()->json(array('result'=>'success','url'=>$apiURL, 'tag_url' => $simplifi_tag_url));
                            exit;die();
                        }else{
                            $getimg = @file_get_contents($apiURL);
                            if ($getimg !== false) {
                                return  Response($getimg,200)->header('Content-Type','image/gif');
                            }else{
                                //$error = error_get_last();
                                Log::info('Failed to get URL: ' . $apiURL . ' - Error: #' . $leadspeek_api_id);
                                return response()->json(array('result'=>'failed','msg'=>'failed to load URL ' . $apiURL , 'tag_url' => $simplifi_tag_url));
                            }
                        }

                        /** SEND EMAIL FOR NOTIFICATION HIT */
                        $details = [
                            'params' => '',
                            'paramsUrl'  => 'Label : ' . $label,
                        ];
                        $attachement = array();
                        $from = [
                            'address' => 'newleads@leadspeek.com',
                            'name' => 'webhook',
                            'replyto' => 'newleads@leadspeek.com',
                        ];
                        //$this->send_email(array('harrison.budiman@gmail.com'),'HIT FROM RENDERING PIXEL',$details,$attachement,'emails.webhookleadnotification',$from,'');
                        /** SEND EMAIL FOR NOTIFICATON HIT */
                    }
                    else
                    {
                        $campaign = LeadspeekUser::where('leadspeek_api_id',$leadspeek_api_id)->first();
                        if($campaign)
                        {
                            $leadspeek_type = isset($campaign->leadspeek_type)?$campaign->leadspeek_type:'';
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeek_type,'renderingpixelfire');

                            $active = $campaign->active ?? '';
                            $disabled = $campaign->disabled ?? '';
                            $active_user = $campaign->active_user ?? '';
                            $conditions = ['F-T-T' => 'paused', 'F-F-T' => 'paused_on_run', 'F-T-F' => 'stopped'];
                            $dataPixelLeadRecord['leadspeek_api_id'] = $leadspeek_api_id;
                            $dataPixelLeadRecord['campaign_status'] = $conditions["{$active}-{$disabled}-{$active_user}"] ?? 'stopped';
                            $pixelLeadRecordID = $this->UpsertPixelLeadRecord($dataPixelLeadRecord);
                        }
                        return response()->json(array('result'=>'failed','msg'=>'notActiveCampaign','tag_url' => $simplifi_tag_url));
                        exit;die();
                    }
                }
                //// MAIN CODE
            }
        }
    }
    /** RENDERING TO GET LEADS FROM WEBHOOK TOWER DATA */

    /** FOR GET LEADS WEBHOOK */
    public function getleadwebhook(Request $request) 
    {
        $startTime = microtime(true);
        set_time_limit(0);
        $atdataEqsValue = "";

        /** CHECK IF URL ENCRYPT THEN DECRYPT URL PIXEL FIRE */
        if (isset($_GET['eqs']) && $_GET['eqs'] != '') {
            Log::info("GET IN EQS");
            $key = "164fa2202b52e7f67dd53767ab02c321"; // 128-bit key
            //$key = "d6c60c8e688e0afa7f49416897aadc1f";
            //$atdataEqsValue = "AeZFhZnm_ytYdj06wE5ikO4vPv302-SG9Osx_itiNbxF4gIY3CHdBpvpxd6Jaxvx%20%207i8-_fTb5Ib06zH-K2I1vEXiAhjcId0Gm-nF3olrG_HuLz799NvkhvTrMf4rYjW8%20%20rJmJDtsRTiTCWYfZfF6SDcHuTfwpOhubzIEAFNIeJRoOtRe-zev31MASpLRr2A_g%20%20wGPEJDvSZnokppAKPaWe2w";
            //$atdataEqsValue = "a0dBOP_RYgAncnExb4V-Y6ptSbaSaOq0iDoEsZY6oqJJfJHpTLf_i59couFGlbk5%20%20vK3ZJuSvVV57-no5V5r1C0VMBI0ebVc5_IhJcN9n678";
            $atdataEqsValue = $_GET['eqs'];

            // Initialize the AES cipher service
            $aesCipher = new AESCipher($key);

            // Standardize the base64 string
            $b64CipherText = $aesCipher->standardizeBase64($atdataEqsValue);

            // Decrypt the message
            $clearText = $aesCipher->decrypt($b64CipherText);

            /** DECRYPT URL PIXEL FIRE */
            
            // Parse the query string into an associative array
            parse_str($clearText, $output);

            $_GET = [];
            // Merge the parsed array into $_GET
            $_GET = array_merge($_GET, $output);
            
            $request->merge($_GET);
        }
        /** CHECK IF URL ENCRYPT THEN DECRYPT URL PIXEL FIRE */

        $params = $_GET;
        $md5email = (isset($request->md5email))?$request->md5email:'';
        $md5param = (isset($request->md5_email))?$request->md5_email:'';
        $label = (isset($request->label))?$request->label:'';
        Log::info("Original Label : " . $label);
        Log::info("MD5_EMAIL : " . $md5param);
        Log::info("GET :");
        Log::info($params);
        Log::info("Request : ");
        Log::info($request);

        $replaceURL = $request->url() . '?label=';
        $fullURL = $request->fullUrl();

        $resultProcessData = [
            'leadspeekReportID' => '',
            'executionTimeList' => []
        ];
        $leadspeekReportID = "";
        $executionTimeListGetDataMatch = [];
        $executionTimeListProcessDataMatch = [];
        $executionTimeList = [];
        //$label = urldecode(str_replace(array($replaceURL,"&script=true","&md5_email=",$md5param),array("","","",""),$fullURL));

        /** CONVERT ANY LABEL FORMAT INTO LEGACY $data ARRAY FOR CAMPAIGN LOCAL */
        /*
            format = [
              0 => leadspeek_api_id,
              1 => keyword,
              2 => pixelLeadRecordID,
              3 => customParams (optional),
            ]
        */
        // info('label before', ['label' => $label]);
        $data = $this->buildLegacyLabelArray($label);
        // info('date after', ['data' => $data]);
        /** CONVERT ANY LABEL FORMAT INTO LEGACY $data ARRAY FOR CAMPAIGN LOCAL */

        /** PARSE LABEL FOR GET ID, KEYWORD,etc */
        /** LABEL PATTERN campaignID|keyword **/
        // $data = explode("|",$label);
        $leadspeek_api_id = (isset($data[0]))?trim($data[0]):'';
        $keyword = (isset($data[1]))?trim($data[1]):'';
        
        $param = [];
        foreach ($params as $key => $value) {
            if ($key != "label" && $key != "md5_email") {
                //$param = $param . '&'. $key . '=' . $value;
                $param[$key] = $value;
            }
        }
        $finalparam = "";
        if (count($param) > 0) {
            $finalparam = '&' . http_build_query($param);
        }
        $keyword = $keyword . $finalparam;
        $keyword = preg_replace("/[^a-zA-Z0-9\-._~:\/?#\[\]@!$&'()*+,;= ]/", "",$keyword);

        $pixelLeadRecordID = isset($data[2])?$data[2]:null; // ini hanya ada digunakan di campaign local saja
        $customParams = isset($data[3])?$data[3]:null; // ini hanya ada digunakan di campaign local saja
        /** LABEL PATTERN campaignID|keyword **/
        /** PARSE LABEL FOR GET ID, KEYWORD,etc */

        if ($leadspeek_api_id != "") {
            /** CHECK AGAIN IF THE LEADSPEEK API ID ACTIVE */
            $campaign = LeadspeekUser::select('leadspeek_users.id','leadspeek_users.require_email','leadspeek_users.leadspeek_type','leadspeek_users.location_target','leadspeek_users.leadspeek_locator_zip','leadspeek_users.leadspeek_locator_state','leadspeek_users.leadspeek_locator_state_exclude','leadspeek_users.leadspeek_locator_state_simplifi','leadspeek_users.leadspeek_locator_city','leadspeek_users.leadspeek_locator_city_simplifi','leadspeek_users.national_targeting','leadspeek_users.company_id','users.company_id as clientcompany_id','users.company_root_id as clientcompany_root_id','leadspeek_users.paymentterm','leadspeek_users.advance_information','leadspeek_users.lp_limit_freq','leadspeek_users.stopcontinual','leadspeek_users.topupoptions','leadspeek_users.applyreidentificationall','leadspeek_users.user_id')
                            ->join('users','leadspeek_users.user_id','=','users.id')
                            ->where('leadspeek_users.leadspeek_api_id','=',$leadspeek_api_id)
                            ->where('leadspeek_users.active','=','T')
                            ->where('leadspeek_users.disabled','=','F')
                            ->where('leadspeek_users.active_user','=','T')
                            ->first();
            /** CHECK AGAIN IF THE LEADSPEEK API ID ACTIVE */
            //if (count($campaign) > 0) {
            if ($campaign) {
                /* VALIDATION LEADS ZERO, IN LOCAL, PREPAID, CONTINUAL, LIMIT MONTH */
                $leadspeek_type = isset($campaign->leadspeek_type)?$campaign->leadspeek_type:'';
                $paymentterm = isset($campaign->paymentterm)?$campaign->paymentterm:'';
                $topupoptions = isset($campaign->topupoptions)?$campaign->topupoptions:'';
                $lp_limit_freq = isset($campaign->lp_limit_freq)?$campaign->lp_limit_freq:'';
                $stopcontinual = isset($campaign->stopcontinual)?$campaign->stopcontinual:'';
                
                // info([
                //     'action' => 'VALIDATION LEADS ZERO, IN LOCAL, PREPAID, CONTINUAL, LIMIT MONTH',
                //     'leadspeek_type' => $leadspeek_type,
                //     'paymentterm' => $paymentterm,
                //     'topupoptions' => $topupoptions,
                //     'lp_limit_freq' => $lp_limit_freq,
                //     'stopcontinual' => $stopcontinual,
                // ]);
                
                if($leadspeek_type == 'local' && $paymentterm == 'Prepaid' && $topupoptions == 'continual' && $stopcontinual == 'F' && $lp_limit_freq == 'month')
                {
                    $idTopups = Topup::select(['id'])
                                     ->where('leadspeek_api_id','=', $leadspeek_api_id)
                                     ->where('topup_status','<>','done')
                                     ->get();

                    $remainingBalanceLeads = Topup::where('leadspeek_api_id','=', $leadspeek_api_id)
                                                  ->where('topup_status','<>','done')
                                                  ->sum('total_leads') - DB::table('leadspeek_reports')
                                                  ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                                  ->whereIn('topup_id', $idTopups)
                                                  ->count();

                    // info('', [
                    //     'action' => 'check remainingbalance',
                    //     'idTopups' => $idTopups,
                    //     'totalLeadsTopup' => Topup::where('leadspeek_api_id','=', $leadspeek_api_id)->where('topup_status','<>','done')->sum('total_leads'),
                    //     'totalLeadsReport' => DB::table('leadspeek_reports')->where('leadspeek_api_id','=',$leadspeek_api_id)->whereIn('topup_id', $idTopups)->count(),
                    //     'remainingBalanceLeads' => $remainingBalanceLeads,
                    // ]);

                    if($remainingBalanceLeads <= 0)
                    {
                        // karena remaining leads 0 dan status nya running, maka berubah menjadi paused on run
                        $campaign->active = 'F';
                        $campaign->disabled = 'F';
                        $campaign->active_user = 'T';
                        $campaign->save();
                        // karena remaining leads 0 dan status nya running, maka berubah menjadi paused on run

                        // info("PREPAID CONTINUAL LIMIT MONTH IN WILL ALREADY FULL, REMAININGLEADS : {$remainingBalanceLeads}");
                        return;
                    }
                }
                /* VALIDATION LEADS ZERO, IN LOCAL, PREPAID, CONTINUAL, LIMIT MONTH */

                /* VARIABLES */
                $loctarget = $campaign->location_target;
                $leadspeektype = $campaign->leadspeek_type;
                $nationaltargeting = $campaign->national_targeting;
                $loczip = "";
                $locstate = "";
                $locstateexclude = "";
                $locstatesifi = "";
                $loccity = "";
                $loccitysifi = "";
                $compleadID = (isset($campaign->company_id) && trim($campaign->company_id) != "")?trim($campaign->company_id):"";
                $clientCompanyID = (isset($campaign->clientcompany_id) && trim($campaign->clientcompany_id) != "")?trim($campaign->clientcompany_id):"";
                $clientCompanyRootId = (isset($campaign->clientcompany_root_id) && trim($campaign->clientcompany_root_id) != "")?trim($campaign->clientcompany_root_id):"";

                if ($leadspeektype == "locator" || $leadspeektype == 'enhance' || $leadspeektype == 'b2b') {
                    $loctarget = "Lock";
                    $loczip = (isset($campaign->leadspeek_locator_zip) && trim($campaign->leadspeek_locator_zip) != "")?trim($campaign->leadspeek_locator_zip):"";
                    $locstate = (isset($campaign->leadspeek_locator_state) && trim($campaign->leadspeek_locator_state) != "")?trim($campaign->leadspeek_locator_state):"";
                    $locstatesifi = (isset($campaign->leadspeek_locator_state_simplifi) && trim($campaign->leadspeek_locator_state_simplifi) != "")?trim($campaign->leadspeek_locator_state_simplifi):"";
                    //$loccity =  (isset($campaign[0]['leadspeek_locator_city']) && trim($campaign[0]['leadspeek_locator_city']) != "")?trim($campaign[0]['leadspeek_locator_city']):"";
                    // $loccity = "";
                    if($leadspeektype == 'enhance' || $leadspeektype == 'b2b') {
                        $loccity =  (isset($campaign->leadspeek_locator_city) && trim($campaign->leadspeek_locator_city) != "")?trim($campaign->leadspeek_locator_city):"";
                    }
                    //$loccitysifi =  (isset($campaign[0]['leadspeek_locator_city_simplifi']) && trim($campaign[0]['leadspeek_locator_city_simplifi']) != "")?trim($campaign[0]['leadspeek_locator_city_simplifi']):"";
                    $loccitysifi = "";
                }else{
                    $loctarget = "Focus";
                    $locstate = (isset($campaign->leadspeek_locator_state) && trim($campaign->leadspeek_locator_state) != "")?trim($campaign->leadspeek_locator_state):"";
                    $locstateexclude = (isset($campaign->leadspeek_locator_state_exclude) && trim($campaign->leadspeek_locator_state_exclude) != "")?trim($campaign->leadspeek_locator_state_exclude):"";
                }
                /* VARIABLES */

                /* LOCK EMAIL PROCESS */
                $applyreidentificationall = (isset($campaign->applyreidentificationall) && $campaign->applyreidentificationall == 'T');
                $userId = (isset($campaign->user_id))?$campaign->user_id:"";
                $developemode = env('DEVELOPEMODE', false) ? 'sandbox' : 'production';
                $leadEmailLockKey = "{$developemode}:lock:lead_client:{$userId}:{$md5param}";
                if ($applyreidentificationall)
                {
                    while (!$this->acquireLock($leadEmailLockKey, 60))
                    {
                        Log::info("Lead Email Lock Campaign ID : #{$leadspeek_api_id}");
                        sleep(1); // Wait before trying again
                    }
                }
                /* LOCK EMAIL PROCESS */
                
                /* GET DATA */
                $resultGetData = $this->getDataMatch($md5param,$leadspeek_api_id,$data,$keyword,$loctarget,$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$leadspeektype,$compleadID,$clientCompanyID,$clientCompanyRootId);
                $dataMatch = isset($resultGetData['matches'])?$resultGetData['matches']:[];
                $executionTimeListGetDataMatch = isset($resultGetData['executionTimeList'])?$resultGetData['executionTimeList']:[];
                /* GET DATA */
                
                /* PROCESS DATA */
                if (is_array($dataMatch) || is_object($dataMatch)) {
                    if (count($dataMatch) > 0) {
                        Log::info("Start serve leads campaign ID #" . $leadspeek_api_id);
                        if (($campaign->require_email == 'T' && trim($dataMatch[0]['Email']) != '') || ($campaign->require_email == 'F')) {
                            if (count($dataMatch) > 0) {
                                // /** REPORT ANALYTIC */
                                //     $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'serveclient');
                                // /** REPORT ANALYTIC */
                                $filterEmail = true;
                                if(trim($dataMatch[0]['Email']) != '') {
                                    $filterEmail = $this->filterEmailInLeadspeekReport($leadspeek_api_id, $dataMatch[0]['Email'], $dataMatch[0]['PersonID'], $clientCompanyID, $leadspeektype, $md5param);
                                }

                                if($filterEmail) {
                                    $dataMatch[0]['CustomParams'] = ($leadspeektype == 'local') ? $customParams : "";
                                    $matches = json_decode(json_encode($dataMatch), false);
                                    $resultProcessData = $this->processDataMatch($leadspeek_api_id,$matches,$data,$campaign->paymentterm,$leadspeektype,$md5param);
                                }
                            }
                        }
                    }else{
                        Log::info("Not serve leads 1 campaign ID #" . $leadspeek_api_id);
                        /** REPORT ANALYTIC NOT SERVE AND BIGBDMREMAININGLEADS IF LEADSPEEK_TYPE ENHANCE */
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'notserve');
                            if($leadspeektype == 'enhance' || $leadspeektype == 'b2b') {
                                $bigbdmremainingleads = BigDBMLeads::where('leadspeek_api_id', $leadspeek_api_id)
                                                                   ->whereDate('created_at', date('Y-m-d'))
                                                                   ->count() - 1;
                                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmremainingleads',$bigbdmremainingleads);
                            }
                        /** REPORT ANALYTIC NOT SERVE AND BIGBDMREMAININGLEADS IF LEADSPEEK_TYPE ENHANCE */
                    }
                }else{
                    Log::info("Not serve leads 2 campaign ID #" . $leadspeek_api_id);
                   /** REPORT ANALYTIC NOT SERVE AND BIGBDMREMAININGLEADS IF LEADSPEEK_TYPE ENHANCE */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'notserve');
                        if($leadspeektype == 'enhance' || $leadspeektype == 'b2b') {
                            $bigbdmremainingleads = BigDBMLeads::where('leadspeek_api_id', $leadspeek_api_id)
                                                               ->whereDate('created_at', date('Y-m-d'))
                                                               ->count() - 1;
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmremainingleads',$bigbdmremainingleads);
                        }
                   /** REPORT ANALYTIC NOT SERVE AND BIGBDMREMAININGLEADS IF LEADSPEEK_TYPE ENHANCE */
                }
                /* PROCESS DATA */
                
                /* RELEASE LOCK EMAIL PROCESS */
                if ($applyreidentificationall)
                {
                    $this->releaseLock($leadEmailLockKey);
                }
                /* RELEASE LOCK EMAIL PROCESS */

                /** REPORT ANALYTIC */
                if($leadspeektype == 'local')
                {
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'pixelfire');    
                    // insert pixel lead record
                    // info('insert pixel lead record', ['pixelLeadRecordID' => $pixelLeadRecordID, 'label' => $label]);
                    $this->UpdateFeedbackPixelLeadRecord($pixelLeadRecordID, $leadspeek_api_id, $md5param, $label);
                }
                /** REPORT ANALYTIC */

                /** COUNT WEBHOOK BEEN FIRE FOR SPECIFIC LEADSPEEK ID */
                    $updatewebhook = LeadspeekUser::find($campaign->id);
                    $updatewebhook->webhookfire =  $updatewebhook->webhookfire + 1;
                    $updatewebhook->save();
                /** COUNT WEBHOOK BEEN FIRE FOR SPECIFIC LEADSPEEK ID */
            }
        }

        $details = [
            'params' => $keyword . '==>' . $leadspeek_api_id,
            'paramsUrl'  => json_encode($params) . '<br>Label : ' . $label . '<br>MD5 Email : ' . $md5param . '<br>Full URL : ' . $fullURL,
        ];
        $attachement = array();

        $from = [
            'address' => 'newleads@leadspeek.com',
            'name' => 'webhook',
            'replyto' => 'newleads@leadspeek.com',
        ];

        //$this->send_email(array('serverlogs@sitesettingsapi.com'),'SANBOX-GET WEBHOOK FROM TOWER DATA',$details,$attachement,'emails.webhookleadnotification',$from,'');

        /* SAVE TO EXECUTION TIME PROCESS TO LEADSPEEK_REPORT IF DATA MATCH */
        $leadspeekReportID = isset($resultProcessData['leadspeekReportID'])?$resultProcessData['leadspeekReportID']:"";
        $executionTimeListProcessDataMatch = isset($resultProcessData['executionTimeList'])?$resultProcessData['executionTimeList']:[];
        if(!empty($leadspeekReportID) && trim($leadspeekReportID) != '') {
            $executionTimeList = array_merge($executionTimeList, $executionTimeListGetDataMatch);
            $executionTimeList = array_merge($executionTimeList, $executionTimeListProcessDataMatch);

            $endTime = microtime(true);
            
            // convert epochtime to date format ('Y-m-d H:i:s')
            $startDate = Carbon::createFromTimestamp($startTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
            $endDate = Carbon::createFromTimestamp($endTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
            // convert epochtime to date format ('Y-m-d H:i:s') 
            
            $executionTime = $endTime - $startTime;
            $executionTime = number_format($executionTime,2,'.','');

            $executionTimeList['all_process'] = [
                'start_execution_time' => $startDate,
                'end_execution_time' => $endDate,
                'total_execution_time' => $executionTime
            ];

            LeadspeekReport::where('id', $leadspeekReportID)
                           ->update([
                            'start_execution_time' => $startDate,
                            'end_execution_time' => $endDate,
                            'total_execution_time' => $executionTime,
                            'list_execution_time' => json_encode($executionTimeList)
                           ]);
        }
        /* SAVE TO EXECUTION TIME PROCESS TO LEADSPEEK_REPORT IF DATA MATCH */
    }
    /** FOR GET LEADS WEBHOOK */

    private function notificationPrepaidTopupTwoDaysLimit($emailClient=[],$clientUserId="",$agencyCompanyId="",$rootCompanyId="",$leadspeekApiId="",$clientLimitLeads="",$remainingBalanceLeads="")
    {
        // info(['emailClient' => $emailClient,'clientUserId' => $clientUserId,'agencyCompanyId' => $agencyCompanyId,'rootCompanyId' => $rootCompanyId,'leadspeekApiId' => $leadspeekApiId]);

        /* SEND EMAIL TO CLIENT */
        $userlist = User::select('companies.company_name','companies.simplifi_organizationid','users.company_id','users.company_parent','users.name','users.email','users.phonenum','users.user_type','users.company_root_id')
                        ->join('companies','users.company_id','=','companies.id')
                        ->where('users.id','=',$clientUserId)
                        ->where('users.active','=','T')
                        ->get();
        // info('userlist', ['clientUserId' => $clientUserId,'userlist' => $userlist]);

        $emailType = 'em_prepaidtopuptwodaylimitclient';
        $customsetting = $this->getcompanysetting($agencyCompanyId,$emailType);
        if ($customsetting == '') 
        {
            $customsetting =  json_decode(json_encode($this->check_email_template($emailType,$agencyCompanyId)));
        }        
        // info('customsetting', ['customsetting' => $customsetting]);

        $finalcontent = nl2br($this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->content,'','','',$leadspeekApiId));
        // $searchArray = array('[leads-per-day]','[remaining-balance]');
        // $replaceArray = array($clientLimitLeads,$remainingBalanceLeads);
        // $finalcontent = str_replace($searchArray,$replaceArray,$finalcontent);

        $finalsubject = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->subject,'','','',$leadspeekApiId);
        $finalfrom = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->fromName,'','','',$leadspeekApiId);
        // info('', ['finalcontent' => $finalcontent, 'finalsubject' => $finalsubject, 'finalfrom' => $finalfrom]);

        $details = [
            'title' => ucwords($finalsubject),
            'content' => $finalcontent,
        ];
        $from = [
            'address' => (isset($customsetting->fromAddress) && $customsetting->fromAddress != '')?$customsetting->fromAddress:'noreply@sitesettingsapi.com',
            'name' => (isset($finalfrom) && $finalfrom != '')?$finalfrom:'Your Campaign Will Auto Topup In 2 Days',
            'replyto' => (isset($customsetting->fromReplyto) && $customsetting->fromReplyto != '')?$customsetting->fromReplyto:'support@sitesettingsapi.com',
        ];
        // Log::channel('custom')->info('', ['details' => $details, 'from' => $from]);
        
        // $emailClient = ['muhammadjidan703@gmail.com'];
        $this->send_email($emailClient,ucwords($finalsubject),$details,array(),'emails.customemail',$from,$userlist[0]['company_parent'],true);
        /* SEND EMAIL TO CLIENT */

        /* SEND EMAIL TO AGENCY */
        $emailType = 'em_prepaidtopuptwodaylimitagency';
        $customsetting =  json_decode(json_encode($this->check_email_template($emailType,$rootCompanyId)));
        // info('customsetting', ['customsetting' => $customsetting]);

        $finalcontent = nl2br($this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->content,'','','',$leadspeekApiId));
        // $searchArray = array('[leads-per-day]','[remaining-balance]');
        // $replaceArray = array($clientLimitLeads,$remainingBalanceLeads);
        // $finalcontent = str_replace($searchArray,$replaceArray,$finalcontent);
        // Log::channel('custom')->info('', ['finalcontent' => $finalcontent]);

        $finalsubject = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->subject,'','','',$leadspeekApiId);
        $finalfrom = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->fromName,'','','',$leadspeekApiId);
        // info('', ['finalcontent' => $finalcontent, 'finalsubject' => $finalsubject, 'finalfrom' => $finalfrom]);

        $details = [
            'title' => ucwords($finalsubject),
            'content' => $finalcontent,
        ];
        $from = [
            'address' => (isset($customsetting->fromAddress) && $customsetting->fromAddress != '')?$customsetting->fromAddress:'noreply@sitesettingsapi.com',
            'name' => (isset($finalfrom) && $finalfrom != '')?$finalfrom:'Your Campaign Will Auto Topup In 2 Days',
            'replyto' => (isset($customsetting->fromReplyto) && $customsetting->fromReplyto != '')?$customsetting->fromReplyto:'support@sitesettingsapi.com',
        ];
        // Log::channel('custom')->info('', ['details' => $details, 'from' => $from, 'rootCompanyId' => $rootCompanyId]);
        
        $userDownline = User::where('company_id', $agencyCompanyId)->where('user_type','userdownline')->first();
        $emailUserDownline = isset($userDownline->email)?$userDownline->email:'';
        $emailAgency = [$emailUserDownline];
        // $emailAgencyArray = ['fisikamodern00@gmail.com'];
        
        $this->send_email($emailAgency,ucwords($finalsubject),$details,array(),'emails.customemail',$from,$rootCompanyId,true);
        /* SEND EMAIL TO AGENCY */
    }

    private function notificationGohighlevelMissingTags($clientUserId = '', $leadspeekApiId = '', $tags = '')
    {
        if(empty($clientUserId) || empty($leadspeekApiId)) {
            return false;
        }

        $userlist = User::select('companies.company_name','companies.simplifi_organizationid','users.company_id','users.company_parent','users.name','users.email','users.phonenum','users.user_type','users.company_root_id')
                        ->join('companies','users.company_id','=','companies.id')
                        ->where('users.id','=',$clientUserId)
                        ->where('users.active','=','T')
                        ->get();

        // info('', ['userlist'=>$userlist]);
        if(empty($userlist)) {
            return false;
        }

        $rootCompanyId = $userlist[0]['company_root_id'];
        $agencyCompanyId = $userlist[0]['company_parent'];
        $emailClient = $userlist[0]['email'];
        $emailClientArray = [$emailClient];
        
        // /* SEND EMAIL TO CLIENT */
        // $emailType = 'em_gohighlevelmissingtagsclient';
        // $customsetting = $this->getcompanysetting($agencyCompanyId,$emailType);
        // if ($customsetting == '') 
        // {
        //     $customsetting =  json_decode(json_encode($this->check_email_template($emailType,$agencyCompanyId)));
        // }        
        // // Log::channel('custom')->info('customsetting_client', ['customsetting' => $customsetting, 'agencyCompanyId' => $agencyCompanyId]);

        // $finalcontent = nl2br($this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->content,'','','',$leadspeekApiId));
        // $searchArray = array('[integration-name]','[tags]');
        // $replaceArray = array('Lead Connector',$tags);
        // $finalcontent = str_replace($searchArray,$replaceArray,$finalcontent);

        // $finalsubject = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->subject,'','','',$leadspeekApiId);
        // $searchArray = array('[integration-name]');
        // $replaceArray = array('Lead Connector');
        // $finalsubject = str_replace($searchArray,$replaceArray,$finalsubject);

        // $finalfrom = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->fromName,'','','',$leadspeekApiId);
        // $searchArray = array('[integration-name]');
        // $replaceArray = array('Lead Connector');
        // $finalfrom = str_replace($searchArray,$replaceArray,$finalfrom);

        // // info('', ['finalcontent' => $finalcontent, 'finalsubject' => $finalsubject, 'finalfrom' => $finalfrom]);

        // $details = [
        //     'title' => ucwords($finalsubject),
        //     'content' => $finalcontent,
        // ];
        // $from = [
        //     'address' => (isset($customsetting->fromAddress) && $customsetting->fromAddress != '')?$customsetting->fromAddress:'noreply@sitesettingsapi.com',
        //     'name' => (isset($finalfrom) && $finalfrom != '')?$finalfrom:'Campaign Missing Tags',
        //     'replyto' => (isset($customsetting->fromReplyto) && $customsetting->fromReplyto != '')?$customsetting->fromReplyto:'support@sitesettingsapi.com',
        // ];
        // // info('', ['details' => $details, 'from' => $from]);
        
        // // $emailClientArray = ['muhammadjidan703@gmail.com'];
        // // info('', ['emailClientArray' => $emailClientArray, 'finalsubject' => ucwords($finalsubject), 'details' => $details, 'from' => $from, 'agencyCompanyId' => $userlist[0]['company_parent']]);
        // $this->send_email($emailClientArray,ucwords($finalsubject),$details,array(),'emails.customemail',$from,$userlist[0]['company_parent'],true);
        // /* SEND EMAIL TO CLIENT */

        /* SEND EMAIL TO AGENCY */
        $emailType = 'em_gohighlevelmissingtagsagency';
        $customsetting = $this->getcompanysetting($agencyCompanyId,$emailType);
        if ($customsetting == '') 
        {
            $customsetting =  json_decode(json_encode($this->check_email_template($emailType,$rootCompanyId)));
        }
        // Log::channel('custom')->info('customsetting_agency', ['customsetting' => $customsetting, 'rootCompanyId' => $rootCompanyId]);

        $finalcontent = nl2br($this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->content,'','','',$leadspeekApiId));
        $searchArray = array('[integration-name]','[tags]');
        $replaceArray = array('Lead Connector',$tags);
        $finalcontent = str_replace($searchArray,$replaceArray,$finalcontent);

        $finalsubject = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->subject,'','','',$leadspeekApiId);
        $searchArray = array('[integration-name]');
        $replaceArray = array('Lead Connector');
        $finalsubject = str_replace($searchArray,$replaceArray,$finalsubject);
        
        $finalfrom = $this->filterCustomEmail($userlist,$userlist[0]['company_parent'],$customsetting->fromName,'','','',$leadspeekApiId);
        $searchArray = array('[integration-name]');
        $replaceArray = array('Lead Connector');
        $finalfrom = str_replace($searchArray,$replaceArray,$finalfrom);
        
        // info('', ['finalcontent' => $finalcontent, 'finalsubject' => $finalsubject, 'finalfrom' => $finalfrom]);

        $details = [
            'title' => ucwords($finalsubject),
            'content' => $finalcontent,
        ];
        $from = [
            'address' => (isset($customsetting->fromAddress) && $customsetting->fromAddress != '')?$customsetting->fromAddress:'noreply@sitesettingsapi.com',
            'name' => (isset($finalfrom) && $finalfrom != '')?$finalfrom:'Campaign Missing Tags',
            'replyto' => (isset($customsetting->fromReplyto) && $customsetting->fromReplyto != '')?$customsetting->fromReplyto:'support@sitesettingsapi.com',
        ];
        // info('', ['details' => $details, 'from' => $from, 'rootCompanyId' => $rootCompanyId]);
        
        $userDownline = User::where('company_id', $agencyCompanyId)->where('user_type','userdownline')->first();
        $emailUserDownline = isset($userDownline->email)?$userDownline->email:'';
        $emailAgencyArray = [$emailUserDownline];
        // $emailAgencyArray = ['fisikamodern00@gmail.com'];
        
        // info('', ['emailAgencyArray' => $emailAgencyArray, 'finalsubject' => ucwords($finalsubject), 'details' => $details, 'from' => $from, 'rootCompanyId' => $rootCompanyId]);
        $this->send_email($emailAgencyArray,ucwords($finalsubject),$details,array(),'emails.customemail',$from,$rootCompanyId,true);
        /* SEND EMAIL TO AGENCY */
    }

    private function processDataMatch($leadspeek_api_id,$matches,$data,$paymentTerm = "",$leadspeek_type = "",$md5param = "") 
    {
        $executionTimeList = [];

        date_default_timezone_set('America/Chicago');

        $leadspeekReportID = "";

        /** LOCK PROCESS FOR PREPAID UNTIL DONE FIRST */
        if (trim($paymentTerm) != "" && trim($paymentTerm) == "Prepaid") 
        {
            Log::info("START PREPAID LOCK Campaign ID: #" . $leadspeek_api_id);
            while (!$this->acquireLock('initPrepaidStart' . $leadspeek_api_id)) 
            {
                Log::info("Initial Prepaid Processing. Waiting to acquire lock. Campaign ID : #" . $leadspeek_api_id);
                sleep(1); // Wait before trying again
            }
        }
        /** LOCK PROCESS FOR PREPAID UNTIL DONE FIRST */

        $clientList = LeadspeekUser::select('leadspeek_users.id','leadspeek_users.url_code','leadspeek_users.company_id as clientowner','leadspeek_users.report_type','leadspeek_users.report_sent_to','leadspeek_users.admin_notify_to','leadspeek_users.leadspeek_api_id','leadspeek_users.active','leadspeek_users.leadspeek_organizationid','leadspeek_users.leadspeek_campaignsid','leadspeek_users.gtminstalled'
        ,'leadspeek_users.leadspeek_locator_state','leadspeek_users.leadspeek_locator_require','leadspeek_users.leadspeek_locator_zip','leadspeek_users.leads_amount_notification','leadspeek_users.total_leads','leadspeek_users.ongoing_leads','leadspeek_users.last_lead_added','leadspeek_users.spreadsheet_id','leadspeek_users.filename','leadspeek_users.report_frequency_id','leadspeek_users.lp_max_lead_month','leadspeek_users.lp_min_cost_month','leadspeek_users.cost_perlead'
        ,'users.customer_payment_id','users.customer_card_id','users.email','users.company_parent','users.company_root_id','leadspeek_users.paymentterm','leadspeek_users.leadspeek_type','leadspeek_users.lp_enddate','leadspeek_users.platformfee','leadspeek_users.hide_phone','leadspeek_users.campaign_name','leadspeek_users.campaign_enddate','leadspeek_users.phoneenabled','leadspeek_users.homeaddressenabled'
        ,'leadspeek_users.lp_limit_leads','leadspeek_users.lp_limit_freq','leadspeek_users.lp_limit_startdate','leadspeek_users.report_frequency','leadspeek_users.report_frequency_unit','leadspeek_users.last_lead_check','leadspeek_users.start_billing_date','users.name','leadspeek_users.user_id','leadspeek_users.is_send_email_prepaid','companies.id as company_id','companies.company_name'
        ,'leadspeek_users.created_at','leadspeek_users.embedded_lastreminder','leadspeek_users.trysera','leadspeek_users.campaign_information_type_local','leadspeek_users.advance_information',
        'leadspeek_users.ghl_tags','leadspeek_users.ghl_is_active','leadspeek_users.ghl_remove_tags','leadspeek_users.ghl_status_keyword_to_tags','leadspeek_users.sendgrid_is_active as sendgrid_is_active', 'leadspeek_users.sendgrid_action as sendgrid_action','leadspeek_users.sendgrid_list as sendgrid_list','leadspeek_users.mbp_groups','leadspeek_users.mbp_is_active','leadspeek_users.mbp_states','leadspeek_users.mbp_options','leadspeek_users.mbp_zip','leadspeek_users.clickfunnels_is_active','leadspeek_users.clickfunnels_tags','leadspeek_users.topupoptions','leadspeek_users.leadsbuy','leadspeek_users.stopcontinual','leadspeek_users.continual_buy_options','leadspeek_users.sendjim_is_active as sendjim_is_active','leadspeek_users.sendjim_tags as sendjim_tags','leadspeek_users.sendjim_quicksend_templates as sendjim_quicksend_templates','leadspeek_users.sendjim_quicksend_is_active as sendjim_quicksend_is_active')
        ->selectRaw('TIMESTAMPDIFF(MINUTE,leadspeek_users.last_lead_check,NOW()) as minutesdiff')
        ->selectRaw('TIMESTAMPDIFF(HOUR,leadspeek_users.last_lead_check,NOW()) as hoursdiff')
                        ->join('users','leadspeek_users.user_id','=','users.id')
                        ->join('companies','users.company_id','=','companies.id')
                        //->leftjoin('companies_integration_settings','users.company_id','=','companies_integration_settings.company_id')
                        ->where('leadspeek_users.active','=','T')
                        ->where('leadspeek_users.active_user','=','T')
                        ->where('users.user_type','=','client')
                        ->where('users.active','=','T')
                        ->where('leadspeek_users.leadspeek_api_id','=',$leadspeek_api_id)
                        ->get();

        foreach($clientList as $cl) 
        {
            //$clientEmail = explode(PHP_EOL, $cl['report_sent_to']);
            $_clientEmail = str_replace(["\r\n", "\r"], "\n", trim($cl['report_sent_to']));
            $clientEmail = explode("\n", $_clientEmail);
            $clientAdminNotify = explode(',',$cl['admin_notify_to']);
            $clientReportType = $cl['report_type'];
            $clientSpreadSheetID = $cl['spreadsheet_id'];
            $clientFilename = $cl['filename'];
            $clientTotalLeads = $cl['total_leads'];
            $clientOngoingLeads = $cl['ongoing_leads'];
            $limitleadsnotif = $cl['leads_amount_notification'];
            $clientURLcode = trim($cl['url_code']);
            $gtminstalled = ($cl['gtminstalled'] == 'T')?true:false;

            $clientLimitLeads = $cl['lp_limit_leads'];
            $clientLimitFreq = $cl['lp_limit_freq'];
            $clientLimitStartDate = ($cl['lp_limit_startdate'] == null || $cl['lp_limit_startdate'] == '0000-00-00')?'':$cl['lp_limit_startdate'];

            $clientPaymentTerm = $cl['paymentterm'];
            $clientPlatformfee = $cl['platformfee'];
            $clientMaxperTerm = $cl['lp_max_lead_month'];
            //$clientLimitEndDate = ($cl['lp_enddate'] == null || $cl['lp_enddate'] == '0000-00-00 00:00:00')?'':$cl['lp_enddate'];
            $clientLimitEndDate = ($cl['campaign_enddate'] == null || $cl['campaign_enddate'] == '0000-00-00 00:00:00' || trim($cl['campaign_enddate']) == '')?'':$cl['campaign_enddate'];
            $clientCostPerLead = $cl['cost_perlead'];
            $clientMinCostMonth = $cl['lp_min_cost_month'];
            $custStripeID = $cl['customer_payment_id'];
            $custStripeCardID = $cl['customer_card_id'];
            $custEmail = $cl['email'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];

            $_lp_user_id = $cl['id'];
            $_company_id = $cl['company_id'];
            $_user_id = $cl['user_id'];
            $_leadspeek_api_id = $cl['leadspeek_api_id'];
            $campaignName = '';
            $campaignNameOri = '';
            $companyNameOri = $cl['company_name'];
            if (isset($cl['campaign_name']) && trim($cl['campaign_name']) != '') 
            {
                $campaignName = ' - ' . str_replace($_leadspeek_api_id,'',$cl['campaign_name']);
                $campaignNameOri = str_replace($_leadspeek_api_id,'',$cl['campaign_name']);
            }

            $company_name = str_replace($_leadspeek_api_id,'',$cl['company_name']) . $campaignName;

            $_last_lead_check = '';
            $_last_lead_added = '';

            $clientFilterState = explode(',',trim($cl['leadspeek_locator_state']));
            $clientFilterZipCode = explode(',',trim($cl['leadspeek_locator_zip']));
            $clientFilterRequire = explode(',',trim($cl['leadspeek_locator_require']));

            $req_fname = false;
            $req_lname = false;
            $req_mailingaddress = false;
            $req_phone = false;

            $companyRootID = (isset($cl['company_root_id']))?$cl['company_root_id']:'';
            $rootFeeCost = 0;
            $ori_rootFeeCost = 0;
            $platform_price_lead = 0;
            $ori_platform_price_lead = 0;

            /** GET PLATFORM MARGIN */
            $resultProcessGetPlatformMargin = $this->processGetPlatformMargin($cl);
            $platform_LeadspeekCostperlead = isset($resultProcessGetPlatformMargin['platform_LeadspeekCostperlead'])?$resultProcessGetPlatformMargin['platform_LeadspeekCostperlead']:0;
            $platform_LeadspeekMinCostMonth = isset($resultProcessGetPlatformMargin['platform_LeadspeekMinCostMonth'])?$resultProcessGetPlatformMargin['platform_LeadspeekMinCostMonth']:0;
            $platform_LeadspeekPlatformFee = isset($resultProcessGetPlatformMargin['platform_LeadspeekPlatformFee'])?$resultProcessGetPlatformMargin['platform_LeadspeekPlatformFee']:0;
            // info(['action' => 'processGetPlatformMargin','resultProcessGetPlatformMargin' => $resultProcessGetPlatformMargin,'clientCostPerLead' => $clientCostPerLead]);
            if(isset($resultProcessGetPlatformMargin['cost_perlead']) && $resultProcessGetPlatformMargin['cost_perlead'] != '' && $resultProcessGetPlatformMargin['cost_perlead'] != $clientCostPerLead) 
            {
                $cl['cost_perlead'] = $resultProcessGetPlatformMargin['cost_perlead'];
                $clientCostPerLead = $cl['cost_perlead'];
            }
            /** GET PLATFORM MARGIN */

            $organizationid = $cl['leadspeek_organizationid'];
            $campaignsid = $cl['leadspeek_campaignsid'];
            $price_lead = ($cl['cost_perlead'] != '')?$cl['cost_perlead']:0;
            $platform_price_lead = $platform_LeadspeekCostperlead;
            $ori_platform_price_lead = $platform_price_lead;
            $clientHidePhone = $cl['hide_phone'];
            // info([
            //     'price_lead' => $price_lead,
            //     'platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead,
            //     'platform_LeadspeekMinCostMonth' => $platform_LeadspeekMinCostMonth,
            //     'platform_LeadspeekPlatformFee' => $platform_LeadspeekPlatformFee,
            // ]);

            /** GET ROOT FEE PER LEADS FROM SUPER ROOT */
            $resultProcessGetRootFee = $this->processGetRootFee($cl);
            // info(['action' => 'processGetRootFee','resultProcessGetRootFee' => $resultProcessGetRootFee]);
            $rootFeeCost = isset($resultProcessGetRootFee['rootFeeCost']) ? $resultProcessGetRootFee['rootFeeCost'] : 0;
            $ori_rootFeeCost = $rootFeeCost;
            /** GET ROOT FEE PER LEADS FROM SUPER ROOT */

            $attachementlist = array();
            $attachementlink = array();
            $attachment = array();

            /** CHECK IF THERE END DATE ON WEEKLY OR MONTHLY PAYMENT TERM */
            if (($cl['leadspeek_type'] == "local" && $clientLimitEndDate == '') || $cl['leadspeek_type'] == "enhance" || $cl['leadspeek_type'] == "b2b") 
            {
                //$clientLimitEndDate = $cl['campaign_enddate'];
                $oneYearLater = date('Y-m-d', strtotime('+1 year', strtotime(date('Y-m-d'))));
                $clientLimitEndDate = ($cl['lp_enddate'] == null || $cl['lp_enddate'] == '0000-00-00 00:00:00' || $cl['lp_enddate'] == '' || $cl['leadspeek_type'] == "enhance" || $cl['leadspeek_type'] == "b2b")? $oneYearLater . ' 00:00:00':$cl['lp_enddate'];
            }

            if ($clientPaymentTerm != 'One Time' && $clientPaymentTerm != 'Prepaid' && $clientLimitEndDate != '') 
            {
                $EndDate = date('YmdHis',strtotime($clientLimitEndDate));
                if (date('YmdHis') > $EndDate) 
                {
                    /** ACTIVATE CAMPAIGN SIMPLIFI */
                    if ($organizationid != '' && $campaignsid != '') 
                    {
                        $camp = $this->startPause_campaign($organizationid,$campaignsid,'stop');
                        if ($camp == true) 
                        {
                            /** PUT CLIENT TO ARCHIVE OR STOP */
                            $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                            $updateLeadspeekUser->active = 'F';
                            $updateLeadspeekUser->disabled = 'T';
                            $updateLeadspeekUser->active_user = 'F';
                            $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                            $updateLeadspeekUser->save();
                            /** PUT CLIENT TO ARCHIVE OR STOP */

                            /** UPDATE USER END DATE */
                            $updateUser = User::find($_user_id);
                            $updateUser->lp_enddate = null;
                            $updateUser->lp_limit_startdate = null;
                            $updateUser->save();
                            /** UPDATE USER END DATE */

                            /** CHECK IF THE CONTRACTED ENDED IN THE MIDDLE OF WEEK */
                            $LastBillDate = date('YmdHis',strtotime($updateLeadspeekUser->start_billing_date));
                            $platformFee = 0;

                            $clientStartBilling = date('YmdHis',strtotime($updateLeadspeekUser->start_billing_date));
                            //$nextBillingDate = date('Ymd');
                            $nextBillingDate = date("YmdHis", strtotime("-1 days"));

                            /** CREATE INVOICE AND SENT IT */
                            $invoiceCreated = $this->createInvoice($_lp_user_id,$_company_id,$_user_id,$_leadspeek_api_id,$clientMaxperTerm,$clientCostPerLead,$platformFee,$clientPaymentTerm,$company_name,$clientEmail,$clientAdminNotify,$clientStartBilling,$nextBillingDate,$custStripeID,$custStripeCardID,$custEmail,$cl,$cl['clientowner']);
                            /** CREATE INVOICE AND SENT IT */

                            /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                            $TotalLimitLeads = '0';
                            $this->notificationStartStopLeads($clientAdminNotify,'Stopped (Campaign End on ' . date('m-d-Y',strtotime($clientLimitEndDate)) . ' - ' . date('m-d-Y') . ')',$company_name . ' #' . $_leadspeek_api_id,$clientLimitLeads,$clientLimitFreq,$TotalLimitLeads,$cl['clientowner'],true);
                            /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                            continue;
                        }
                        else
                        {
                            /** SEND EMAIL TO ME */
                            $details = [
                                'errormsg'  => 'Simpli.Fi Error Leadspeek ID :' . $_leadspeek_api_id. '<br/>',
                            ];
                            $from = [
                                'address' => 'noreply@sitesettingsapi.com',
                                'name' => 'support',
                                'replyto' => 'noreply@sitesettingsapi.com',
                            ];
                            $this->send_email(array('serverlogs@sitesettingsapi.com'),'Start Pause Campaign Failed (INTERNAL - Webhook-ProcessDataMatch - L512) #' .$_leadspeek_api_id,$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                            /** SEND EMAIL TO ME */
                            continue;
                        }
                    }
                    else if ($cl['leadspeek_type'] == "local") 
                    {
                        /** PUT CLIENT TO ARCHIVE OR STOP */
                        $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                        $updateLeadspeekUser->active = 'F';
                        $updateLeadspeekUser->disabled = 'T';
                        $updateLeadspeekUser->active_user = 'F';
                        $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                        $updateLeadspeekUser->save();
                        /** PUT CLIENT TO ARCHIVE OR STOP */

                        /** UPDATE USER END DATE */
                        $updateUser = User::find($_user_id);
                        $updateUser->lp_enddate = null;
                        $updateUser->lp_limit_startdate = null;
                        $updateUser->save();
                        /** UPDATE USER END DATE */

                        /** CHECK IF THE CONTRACTED ENDED IN THE MIDDLE OF WEEK */
                        $LastBillDate = date('YmdHis',strtotime($updateLeadspeekUser->start_billing_date));
                        $platformFee = 0;

                        $clientStartBilling = date('YmdHis',strtotime($updateLeadspeekUser->start_billing_date));
                        //$nextBillingDate = date('Ymd');
                        $nextBillingDate = date("YmdHis", strtotime("-1 days"));

                        /** CREATE INVOICE AND SENT IT */
                        $invoiceCreated = $this->createInvoice($_lp_user_id,$_company_id,$_user_id,$_leadspeek_api_id,$clientMaxperTerm,$clientCostPerLead,$platformFee,$clientPaymentTerm,$company_name,$clientEmail,$clientAdminNotify,$clientStartBilling,$nextBillingDate,$custStripeID,$custStripeCardID,$custEmail,$cl,$cl['clientowner']);
                        /** CREATE INVOICE AND SENT IT */

                        /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                        $TotalLimitLeads = '0';
                        $this->notificationStartStopLeads($clientAdminNotify,'Stopped (Campaign End on ' . date('m-d-Y',strtotime($clientLimitEndDate)) . ' - ' . date('m-d-Y') . ')',$company_name . ' #' . $_leadspeek_api_id,$clientLimitLeads,$clientLimitFreq,$TotalLimitLeads,$cl['clientowner'],true);
                        /** SEND EMAIL NOTIFICATION ONE TIME FINISHED*/
                        continue;
                    }
                    /** ACTIVATE CAMPAIGN SIMPLIFI */
                }
            } 
            else if ($clientPaymentTerm == 'Prepaid') 
            {
                /** CHECK IF LEADS EMPTY */
                $dataContinualProgressIsNotDoneExists = Topup::where('leadspeek_api_id', $_leadspeek_api_id)
                                                             ->whereIn('topup_status', ['progress', 'queue'])
                                                             ->exists();
                
                if(!$dataContinualProgressIsNotDoneExists) 
                {
                    /** PUT CLIENT TO ARCHIVE OR STOP */
                    $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                    $updateLeadspeekUser->active = 'F';
                    $updateLeadspeekUser->disabled = 'T';
                    $updateLeadspeekUser->active_user = 'F';
                    $updateLeadspeekUser->last_lead_pause = date('Y-m-d H:i:s');
                    $updateLeadspeekUser->save();
                    /** PUT CLIENT TO ARCHIVE OR STOP */

                    /** UPDATE USER END DATE */
                    $updateUser = User::find($_user_id);
                    $updateUser->lp_enddate = null;
                    $updateUser->lp_limit_startdate = null;
                    $updateUser->save();
                    /** UPDATE USER END DATE */

                    /** UPDATE STOP CONTINUAL */
                    $this->stop_continual_topup($_lp_user_id);
                    /** UPDATE STOP CONTINUAL */
                    
                    /** SEND EMAIL TO ME */
                    $details = [
                        'errormsg'  => 'PREPAID Stopped No TOP UP EXIST (L716) Leadspeek ID :' . $_leadspeek_api_id. '<br/>',
                    ];
                    $from = [
                        'address' => 'noreply@sitesettingsapi.com',
                        'name' => 'support',
                        'replyto' => 'noreply@sitesettingsapi.com',
                    ];
                    $this->send_email(array('serverlogs@sitesettingsapi.com'),'PREPAID STOPPED #' .$_leadspeek_api_id,$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                    /** SEND EMAIL TO ME */
                    continue;
                }
                /** CHECK IF LEADS EMPTY */
            }
            /** CHECK IF THERE END DATE ON WEEKLY OR MONTHLY PAYMENT TERM */

            $leadcount = 0;

            /** PROCESS MATCHED DATA */
            if (count($matches) > 0) 
            {
                /** CHECK IS ADVANCE */
                $is_advance = false;
                if ($leadspeek_type == 'enhance' || $leadspeek_type == 'b2b') 
                {
                    $campaign_advance_information = LeadspeekUser::select('advance_information')->where('leadspeek_api_id',$leadspeek_api_id)->first();
                    if (isset($campaign_advance_information->advance_information) && !empty($campaign_advance_information->advance_information) && trim($campaign_advance_information->advance_information) != '') 
                    {
                        $is_advance = true;
                    }
                }
                /** CHECK IS ADVANCE */

                /** CHECK IS LOCAL CUSTOM */
                $is_local_custom = [
                    'is_advance' => false,
                    'is_b2b' => false,
                    'advance' => [],
                    'b2b' => [],
                ];
                $campaign_information_type_local = 'basic';
                if ($leadspeek_type == 'local') {
                        $campaign = LeadspeekUser::select('paymentterm','advance_information','campaign_information_type_local')->where('leadspeek_api_id',$leadspeek_api_id)->first();

                        if (strtolower($campaign->paymentterm) == 'prepaid') {
                            $topup = Topup::select('advance_information','campaign_information_type_local')
                                    ->where('leadspeek_api_id',$leadspeek_api_id)
                                    ->where('leadspeek_type','local')
                                    ->where('topup_status', 'progress')
                                    ->orderBy('id','ASC')
                                    ->first();
                                    
                            $campaign_information_type_local = !empty($topup->campaign_information_type_local) ? explode(',',$topup->campaign_information_type_local) : [];
                            $advance_information = !empty($topup->advance_information) ? json_decode($topup->advance_information) : '';
    
                            // if ((in_array('advanced',$campaign_information_type_local) || in_array('b2b',$campaign_information_type_local))) {
                            if (in_array('advanced',$campaign_information_type_local)) {
                                $is_local_custom['is_advance'] = in_array('advanced',$campaign_information_type_local) ? true : false;
                                $is_local_custom['is_b2b'] = false;
                                $is_local_custom['advance'] = isset($advance_information->advance) ? $advance_information->advance : [];
                                $is_local_custom['b2b'] = [];
                            }

                        }else {
                            $campaign_information_type_local = !empty($campaign->campaign_information_type_local) ? explode(',',$campaign->campaign_information_type_local) : [];
                            $advance_information = !empty($campaign->advance_information) ? json_decode($campaign->advance_information) : '';
    
                            if (in_array('advanced',$campaign_information_type_local)) {
                                $is_local_custom['is_advance'] = in_array('advanced',$campaign_information_type_local) ? true : false;
                                $is_local_custom['is_b2b'] = false;
                                $is_local_custom['advance'] = isset($advance_information->advance) ? $advance_information->advance : [];
                                $is_local_custom['b2b'] = [];
                            }
                        }
                }
                
                /** CHECK IS LOCAL CUSTOM */

                /** PROCESSING BASED ON REPORT TYPE */
                if ($clientReportType == 'GoogleSheet')
                {
                    $content = array();

                    /** CHECK FOR LIMIT LEADS */
                    if ($clientLimitLeads > 0) 
                    {
                        // untuk mengatahui apakah limit lead days hari ini sudah terpenuhi atau belom, jika sudah tolak jangan lanjut kebawah
                        $resultCheckLimitLeadsBeforeInsertLeadspeekReport = $this->checkLimitLeadsBeforeInsertLeadspeekReport($cl);
                        // info(['action' => 'checkLimitLeadsBeforeInsertLeadspeekReport', 'resultCheckLimitLeadsBeforeInsertLeadspeekReport' => $resultCheckLimitLeadsBeforeInsertLeadspeekReport]);
                        if(!$resultCheckLimitLeadsBeforeInsertLeadspeekReport)
                        {
                            continue;
                        }
                    }
                    /** CHECK FOR LIMIT LEADS */

                    /* INSERT LEADSPEEK REPORT */
                    $resultProcessInsertLeadspeekReport = $this->processInsertLeadspeekReport($cl, $matches, $is_advance, $price_lead, $platform_price_lead, $rootFeeCost,$is_local_custom);
                    // info(['action' => 'processInsertLeadspeekReport','resultProcessInsertLeadspeekReport' => $resultProcessInsertLeadspeekReport]);
                    $content = isset($resultProcessInsertLeadspeekReport['content']) ? $resultProcessInsertLeadspeekReport['content'] : [];
                    $leadspeekReportID = isset($resultProcessInsertLeadspeekReport['leadspeekReportID']) ? $resultProcessInsertLeadspeekReport['leadspeekReportID'] : "";
                    /* INSERT LEADSPEEK REPORT */

                    /** CHECK FOR LIMIT LEADS */
                    if ($clientLimitLeads > 0)
                    {
                        // untuk mengatahui apakah limit lead days hari ini sudah terpenuhi atau belom, jika sudah ubah status campaign dari run to paused on run
                        $this->checkLimitLeadsAfterInsertLeadspeekReport($cl);
                    }
                    /** CHECK FOR LIMIT LEADS */

                    /** CHECK IF PREPAID */
                    // process auto topup prepaid
                    $lockKey = 'topup_process_lock' . $_leadspeek_api_id;
                    if ($clientPaymentTerm == 'Prepaid') 
                    {
                        while (!$this->acquireLock($lockKey)) 
                        {
                            Log::info("Another top-up process is running. Waiting to acquire lock.");
                            sleep(1); // Wait before trying again
                        }

                        $this->processAutoTopupPrepaid($cl, $ori_platform_price_lead, $ori_rootFeeCost);

                        $this->releaseLock($lockKey);
                    }
                    /** CHECK IF PREPAID */

                    /* INSERT SPREADSHEET */
                    $this->processSendSpreadsheetJob($cl, $content, $md5param);
                    /* INSERT SPREADSHEET */
                }
                /** PROCESSING BASED ON REPORT TYPE */

                /** INSERT SENDGRID */
                $resultProcessSendGrid = $this->processSendgrid($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName);
                // info(['action' => 'processSendgrid','resultProcessSendGrid' => $resultProcessSendGrid]);
                if(isset($resultProcessSendGrid['executionTimeList']) && is_array($resultProcessSendGrid['executionTimeList']) && count($resultProcessSendGrid['executionTimeList']) > 0) 
                {
                    $executionTimeList['sendgrid'] = $resultProcessSendGrid['executionTimeList'];
                }
                /** INSERT SENDGRID */

                /** INSERT GOHIGHLEVEL */
                $resultProcessGHL = $this->processGHL($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName,$is_local_custom);
                // info(['action' => 'processGHL','resultProcessGHL' => $resultProcessGHL]);
                if(isset($resultProcessGHL['executionTimeList']) && is_array($resultProcessGHL['executionTimeList']) && count($resultProcessGHL['executionTimeList']) > 0) 
                {
                    $executionTimeList['gohighlevel'] = $resultProcessGHL['executionTimeList'];
                }
                /** INSERT GOHIGHLEVEL */

                /* INSERT MAILBOXPOWER */
                $resultProcessMailBoxPower = $this->processMailBoxPower($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName);
                // info(['action' => 'processMailBoxPower','resultProcessMailBoxPower' => $resultProcessMailBoxPower]);
                if(isset($resultProcessMailBoxPower['executionTimeList']) && is_array($resultProcessMailBoxPower['executionTimeList']) && count($resultProcessMailBoxPower['executionTimeList']) > 0) 
                {
                    $executionTimeList['mailboxpower'] = $resultProcessMailBoxPower['executionTimeList'];
                }
                /* INSERT MAILBOXPOWER */

                /* INSERT CLICK FUNNELS */
                $resultProcessClickFunnels = $this->processClickFunnels($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName);
                // info(['action' => 'processClickFunnels','resultProcessClickFunnels' => $resultProcessClickFunnels]);
                if(isset($resultProcessClickFunnels['executionTimeList']) && is_array($resultProcessClickFunnels['executionTimeList']) && count($resultProcessClickFunnels['executionTimeList']) > 0) 
                {
                    $executionTimeList['clickfunnels'] = $resultProcessClickFunnels['executionTimeList'];
                }
                /* INSERT CLICK FUNNELS */

                /* INSERT KARTRA */
                $resultProcessKartra = $this->processKartra($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName);
                // info(['action' => 'processKartra','resultProcessKartra' => $resultProcessKartra]);
                if(isset($resultProcessKartra['executionTimeList']) && is_array($resultProcessKartra['executionTimeList']) && count($resultProcessKartra['executionTimeList']) > 0) 
                {
                    $executionTimeList['kartra'] = $resultProcessKartra['executionTimeList'];
                }
                /* INSERT KARTRA */

                /* INSERT ZAPIER */
                $resultProcessZapier = $this->processZapier($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName,$is_local_custom);
                // info(['action' => 'processZapier','resultProcessZapier' => $resultProcessZapier]);
                if(isset($resultProcessZapier['executionTimeList']) && is_array($resultProcessZapier['executionTimeList']) && count($resultProcessZapier['executionTimeList']) > 0) 
                {
                    $executionTimeList['zapier'] = $resultProcessZapier['executionTimeList'];
                }
                /* INSERT ZAPIER */

                /* INSERT AGENCYZOOM */
                $resultProcessAgencyZoom = $this->processAgencyZoom($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName);
                // info(['action' => 'processAgencyZoom','resultProcessAgencyZoom' => $resultProcessAgencyZoom]);
                if(isset($resultProcessAgencyZoom['executionTimeList']) && is_array($resultProcessAgencyZoom['executionTimeList']) && count($resultProcessAgencyZoom['executionTimeList']) > 0) 
                {
                    $executionTimeList['agencyzoom'] = $resultProcessAgencyZoom['executionTimeList'];
                }
                /* INSERT AGENCYZOOM */

				/* INSERT SENDJIM */
				$resultProcessSendJim = $this->processSendJim($leadspeek_api_id,$leadspeek_type,$md5param,$matches,$cl,$campaignName);
				if(isset($resultProcessSendJim['executionTimeList']) && is_array($resultProcessSendJim['executionTimeList']) && count($resultProcessSendJim['executionTimeList']) > 0) 
				{
					$executionTimeList['sendjim'] = $resultProcessSendJim['executionTimeList'];
				}
				/* INSERT SENDJIM */
            }
            /** PROCESS MATCHED DATA */
        }

        /** RELEASE LOCK PROCESS FOR PREPAID */
        if (trim($paymentTerm) != "" && trim($paymentTerm) == "Prepaid") 
        {
            Log::info("RELEASE PREPAID LOCK Campaign ID : #" . $leadspeek_api_id);
            $this->releaseLock('initPrepaidStart' . $leadspeek_api_id);
        }
        /** RELEASE LOCK PROCESS FOR PREPAID */

        return [
            'leadspeekReportID' => $leadspeekReportID,
            'executionTimeList' => $executionTimeList,
        ];
    }

    
    // Function to acquire lock
    private function acquireLock($lockKey, $ttl = 10) {
        // return Cache::add($lockKey, true, $ttl);
        //// ganti pakai redis
        return Cache::store('redis')->add($lockKey,true,$ttl);
    }

    // Function to release lock
    private function releaseLock($lockKey) {
        // Cache::forget($lockKey);
        //// ganti pakai redis
        Cache::store('redis')->forget($lockKey);
    }

    public function chargeClient($custStripeID,$custStripeCardID,$custEmail,$totalAmount,$oneTime,$platformFee,$usrInfo,$topup=[],$rootFee=0,$rootFeeTransfer=false,$paramTopup=[],$dataSimplifi=[]) 
    {
        // info('public function ' . __FUNCTION__, ['get_defined_vars' => get_defined_vars()]);
        date_default_timezone_set('America/Chicago');
        $simplifiService = App::make(SimpliFiService::class);
        $systemid = config('services.application.systemid');
        $_lp_user_id = $usrInfo['id'];
        $invoiceNum = date('Ymd') . '-' . $_lp_user_id;
        $AgencyManualBill = "F";
        $startBillingDate = (isset($usrInfo['start_billing_date']))?$usrInfo['start_billing_date']:'';
        
        /** GET COMPANY PARENT NAME / AGENCY */
        $getParentInfo = Company::select('company_name','manual_bill')->where('id','=',$usrInfo['company_parent'])->first();
        //if(count($getParentInfo) > 0) {
        if ($getParentInfo) 
        {
            $companyParentName = $getParentInfo->company_name;
            $AgencyManualBill = $getParentInfo->manual_bill;
        }
        /** GET COMPANY PARENT NAME / AGENCY */

        /** CHECK IF THIS COMPANY USERDOWNLINE OR CLIENT */
        $accConID = '';
        if ($usrInfo['company_parent'] != '') 
        {
            $accConID = $this->check_connected_account($usrInfo['company_parent'],$usrInfo['company_root_id']);
        }
        /** CHECK IF THIS COMPANY USERDOWNLINE OR CLIENT */

        /** CHECK IF USER DATA STILL ON PLATFORM */
        $validuser = true;
        $user[0]['customer_payment_id'] = (isset($usrInfo['customer_payment_id']))?$usrInfo['customer_payment_id']:'';
        $user[0]['company_id'] = (isset($usrInfo['company_id']))?$usrInfo['company_id']:'';
        $user[0]['id'] = (isset($usrInfo['user_id']))?$usrInfo['user_id']:'';
        $user[0]['company_root_id'] = (isset($usrInfo['company_root_id']))?$usrInfo['company_root_id']:'';

        $leadspeek_organizationid = (isset($usrInfo['leadspeek_organizationid']))?$usrInfo['leadspeek_organizationid']:'';
        $leadspeek_campaignsid = (isset($usrInfo['leadspeek_campaignsid']))?$usrInfo['leadspeek_campaignsid']:'';
        /** CHECK IF USER DATA STILL ON PLATFORM */

        /** CHECK IF AGENCY MANUAL BILL */
        if ($AgencyManualBill == "T") 
        {
            $validuser = true;
            $custStripeID = "agencyDirectPayment";
            $custStripeCardID = "agencyDirectPayment";
            /** GET STRIPE ACC AND CARD AGENCY */
            $custAgencyStripeID = "";
            $custAgencyStripeCardID = "";

            $chkAgency = User::select('id','customer_payment_id','customer_card_id','email')
                    ->where('company_id','=',$usrInfo['company_parent'])
                    ->where('company_parent','<>',$usrInfo['company_parent'])
                    ->where('user_type','=','userdownline')
                    ->where('isAdmin','=','T')
                    ->where('active','=','T')
                    ->first();
            //if(count($chkAgency) > 0) {
            if ($chkAgency) 
            {
                $custAgencyStripeID = $chkAgency->customer_payment_id;
                $custAgencyStripeCardID = $chkAgency->customer_card_id;
            }
            /** GET STRIPE ACC AND CARD AGENCY */
        } 
        else 
        {
            $chkStripeUser = $this->check_stripe_customer_platform_exist($user,$accConID);
            $chkResultUser = json_decode($chkStripeUser);
            if ($chkResultUser->result == 'success') 
            {
                $validuser = true;
                $custStripeID = $chkResultUser->custStripeID;
                $custStripeCardID = $chkResultUser->CardID;
            } 
            else 
            {
                $validuser = false;
            }
        }
        /** CHECK CUSTOMER CARD AND VALID USER */

        $topup_agencies_id = null;
        $leadspeek_invoices_id = null;  
        $paymentintentID = '';
        $chargeID = '';
        $platform_errorstripe = '';
        $errorstripe = '';
        $statusPayment = 'pending';
        $cardlast = '';
        $platform_paymentintentID = '';
        $sr_id = 0;
        $ae_id = 0;
        $ar_id = 0;
        $sr_fee = 0;
        $ae_fee = 0;
        $ar_fee = 0;
        $sr_transfer_id = '';
        $ae_transfer_id = '';
        $ar_transfer_id = '';
        $sales_fee = 0;
        $platformfee_charge = false;
        $_ongoingleads = "";        
        $profitAgency = 0;

        /** CHARGE WITH STRIPE */
        if(trim($custStripeID) != '' && trim($custStripeCardID) != '' && ($totalAmount > 0 || $totalAmount != '' || $usrInfo['paymentterm'] == 'One Time' || $usrInfo['paymentterm'] == 'Prepaid') && $validuser) 
        { 
            $totalAmount = number_format($totalAmount,2,'.','');

            /** GET STRIPE KEY */
            $stripeseckey = config('services.stripe.secret');
            $stripepublish = $this->getcompanysetting($usrInfo['company_root_id'],'rootstripe');
            if ($stripepublish != '') 
            {
                $stripeseckey = (isset($stripepublish->secretkey))?$stripepublish->secretkey:"";
            }
            /** GET STRIPE KEY */

            $stripe = new StripeClient([
                'api_key' => $stripeseckey,
                'stripe_version' => '2020-08-27'
            ]);

            /** GET PLATFORM MARGIN */
            $platformMargin = $this->getcompanysetting($usrInfo['company_parent'],'costagency');
            $platform_LeadspeekCostperlead = 0;
            $platform_LeadspeekMinCostMonth = 0;
            $platform_LeadspeekPlatformFee = 0;
            $platformfee_ori = 0;
            
            $paymentterm = trim($usrInfo['paymentterm']);
            $paymentterm = str_replace(' ','',$paymentterm);
            if ($usrInfo['leadspeek_type'] == "local") 
            {
                $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                $campaign_information_type_local = !empty($usrInfo['campaign_information_type_local']) ? explode(',', $usrInfo['campaign_information_type_local']) : [];
                // info('chargeClient local', ['campaign_information_type_local_leadspeek_users' => $usrInfo['campaign_information_type_local'], 'campaign_information_type_local'=>$campaign_information_type_local]);

                if(in_array('advanced', $campaign_information_type_local)) {
                    $platform_LeadspeekCostperlead = (isset($platformMargin->local->$paymentterm->LeadspeekCostperleadAdvanced))?($platformMargin->local->$paymentterm->LeadspeekCostperleadAdvanced):($rootcostagency->local->$paymentterm->LeadspeekCostperleadAdvanced);
                    // info('chargeClient advanced', ['platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead,'isset_LeadspeekCostperleadAdvanced' => (isset($platformMargin->local->$paymentterm->LeadspeekCostperleadAdvanced))]);
                } else {
                    $platform_LeadspeekCostperlead = (isset($platformMargin->local->$paymentterm->LeadspeekCostperlead))?$platformMargin->local->$paymentterm->LeadspeekCostperlead:0;
                    // info('chargeClient advanced', ['platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead,'isset_LeadspeekCostperlead' => (isset($platformMargin->local->$paymentterm->LeadspeekCostperlead))]);
                }

                $platform_LeadspeekMinCostMonth = (isset($platformMargin->local->$paymentterm->LeadspeekMinCostMonth))?$platformMargin->local->$paymentterm->LeadspeekMinCostMonth:0;
                $platform_LeadspeekPlatformFee = (isset($platformMargin->local->$paymentterm->LeadspeekPlatformFee))?$platformMargin->local->$paymentterm->LeadspeekPlatformFee:0;
            }
            else if ($usrInfo['leadspeek_type'] == "locator") 
            {
                $platform_LeadspeekCostperlead = (isset($platformMargin->locator->$paymentterm->LocatorCostperlead))?$platformMargin->locator->$paymentterm->LocatorCostperlead:0;
                $platform_LeadspeekMinCostMonth = (isset($platformMargin->locator->$paymentterm->LocatorMinCostMonth))?$platformMargin->locator->$paymentterm->LocatorMinCostMonth:0;
                $platform_LeadspeekPlatformFee = (isset($platformMargin->locator->$paymentterm->LocatorPlatformFee))?$platformMargin->locator->$paymentterm->LocatorPlatformFee:0;
            }
            else if ($usrInfo['leadspeek_type'] == "enhance") 
            {
                // $rootcostagency = []; 
                // if(!isset($platformMargin->enhance)) {
                //     $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                // }

                $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                $clientTypeLead = $this->getClientCapType($usrInfo['company_root_id']);
                $costagency = $this->getcompanysetting($usrInfo['company_parent'], 'costagency');

                if($clientTypeLead['type'] == 'clientcapleadpercentage') {
                    // $platform_LeadspeekCostperlead = ($usrInfo['cost_perlead'] * $clientTypeLead['value']) / 100;
                    $m_LeadspeekCostperlead = ($usrInfo['cost_perlead'] * $clientTypeLead['value']) / 100;
                    // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                    // $rootCostPerLeadMin = ($costagency->enhance->Prepaid->EnhanceCostperlead > $rootcostagency->enhance->Prepaid->EnhanceCostperlead) ? $costagency->enhance->Prepaid->EnhanceCostperlead : $rootcostagency->enhance->Prepaid->EnhanceCostperlead;
                    $rootCostPerLeadMin = $costagency->enhance->$paymentterm->EnhanceCostperlead;
                    $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);

                    // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                    if(($usrInfo['cost_perlead'] == 0) || ($usrInfo['cost_perlead'] <= $rootCostPerLeadMax && $usrInfo['cost_perlead'] >= $rootCostPerLeadMin)) {
                        $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                    }
                    // jika lebih dari $rootCostPerLeadMax, maka dinamis
                    else if($usrInfo['cost_perlead'] > $rootCostPerLeadMax) {
                        $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                    }
                    else {
                        $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                    }
                } else {
                    $platform_LeadspeekCostperlead = (isset($platformMargin->enhance->$paymentterm->EnhanceCostperlead))?$platformMargin->enhance->$paymentterm->EnhanceCostperlead:$rootcostagency->enhance->$paymentterm->EnhanceCostperlead;
                }

                $platform_LeadspeekMinCostMonth = (isset($platformMargin->enhance->$paymentterm->EnhanceMinCostMonth))?$platformMargin->enhance->$paymentterm->EnhanceMinCostMonth:$rootcostagency->enhance->$paymentterm->EnhanceMinCostMonth;
                $platform_LeadspeekPlatformFee = (isset($platformMargin->enhance->$paymentterm->EnhancePlatformFee))?$platformMargin->enhance->$paymentterm->EnhancePlatformFee:$rootcostagency->enhance->$paymentterm->EnhancePlatformFee;
            }
            else if ($usrInfo['leadspeek_type'] == "b2b") 
            {
                // $rootcostagency = []; 
                // if(!isset($platformMargin->b2b)) {
                //     $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                // }

                $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                $clientTypeLead = $this->getClientCapType($usrInfo['company_root_id']);
                $costagency = $this->getcompanysetting($usrInfo['company_parent'], 'costagency');

                if($clientTypeLead['type'] == 'clientcapleadpercentage') {
                    // $platform_LeadspeekCostperlead = ($usrInfo['cost_perlead'] * $clientTypeLead['value']) / 100;
                    $m_LeadspeekCostperlead = ($usrInfo['cost_perlead'] * $clientTypeLead['value']) / 100;
                    // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                    // $rootCostPerLeadMin = ($costagency->b2b->Prepaid->B2bCostperlead > $rootcostagency->b2b->Prepaid->B2bCostperlead) ? $costagency->b2b->Prepaid->B2bCostperlead : $rootcostagency->b2b->Prepaid->B2bCostperlead;
                    $rootCostPerLeadMin = (isset($costagency->b2b->$paymentterm->B2bCostperlead)) ? ($costagency->b2b->$paymentterm->B2bCostperlead) : ($rootcostagency->b2b->$paymentterm->B2bCostperlead);
                    $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);

                    // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                    if(($usrInfo['cost_perlead'] == 0) || ($usrInfo['cost_perlead'] <= $rootCostPerLeadMax && $usrInfo['cost_perlead'] >= $rootCostPerLeadMin)) {
                        $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                    }
                    // jika lebih dari $rootCostPerLeadMax, maka dinamis
                    else if($usrInfo['cost_perlead'] > $rootCostPerLeadMax) {
                        $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                    }
                    else {
                        $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                    }
                } else {
                    $platform_LeadspeekCostperlead = (isset($platformMargin->b2b->$paymentterm->B2bCostperlead))?$platformMargin->b2b->$paymentterm->B2bCostperlead:$rootcostagency->b2b->$paymentterm->B2bCostperlead;
                }

                $platform_LeadspeekMinCostMonth = (isset($platformMargin->b2b->$paymentterm->B2bMinCostMonth))?$platformMargin->b2b->$paymentterm->B2bMinCostMonth:$rootcostagency->b2b->$paymentterm->B2bMinCostMonth;
                $platform_LeadspeekPlatformFee = (isset($platformMargin->b2b->$paymentterm->B2bPlatformFee))?$platformMargin->b2b->$paymentterm->B2bPlatformFee:$rootcostagency->b2b->$paymentterm->B2bPlatformFee;
            }
            // info(['action' => 'chargeClient','platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead,'platform_LeadspeekMinCostMonth' => $platform_LeadspeekMinCostMonth,'platform_LeadspeekPlatformFee' => $platform_LeadspeekPlatformFee,]);
            /** GET PLATFORM MARGIN */

            /* CALCULATE PLATFORMFEE */
            if ($usrInfo['paymentterm'] == 'One Time') 
            {
                $costinclude = ($usrInfo['lp_max_lead_month'] * $platform_LeadspeekCostperlead);
                $platformfee = (($platform_LeadspeekPlatformFee + $platform_LeadspeekMinCostMonth) - $costinclude);
                if ($platformfee < 0) 
                {
                    $platformfee = $platformfee * -1;
                }
            }
            else if ($usrInfo['paymentterm'] == 'Prepaid') 
            {
                if ($usrInfo['leadspeek_type'] == 'simplifi') // untuk module simplif
                {
                    $profitAgency = ($usrInfo['monthly_budget'] * $usrInfo['agency_markup']) / 100; // hitung profit agency dulu
                    $platformfee = ($usrInfo['monthly_budget'] - $profitAgency); // hitung harga agency 
                    // info('masuk ke module simplifi', ['monthly_budget' => $usrInfo['monthly_budget'],'agency_markup' => $usrInfo['agency_markup'],'profitAgency' => $profitAgency,'platformfee' => $platformfee,]);
                }
                else 
                {
                    // $platformfee = $platformFee + $platform_LeadspeekPlatformFee; // tidak perlu ditambah platform_LeadspeekPlatformFee, karena ini terjadi ketika charge di awal saja
                    $platformfee = $platformFee;
                    $_ongoingleads = (isset($topup['total_leads']))?$topup['total_leads']:'';
                }
            }
            else
            {
                $platformfee = ($platform_LeadspeekPlatformFee + $platform_LeadspeekMinCostMonth);
            }
            $platformfee = number_format($platformfee,2,'.','');
            $platformfee_ori = $platformfee;
            /* CALCULATE PLATFORMFEE */

            /* UPDATE DESCRIPTION */
            $defaultInvoice = '#' . $invoiceNum . '-' . str_replace($usrInfo['leadspeek_api_id'],'',$usrInfo['company_name']) . ' #' . $usrInfo['leadspeek_api_id'];
            $defaultInvoice_ori = $defaultInvoice;
            if($usrInfo['leadspeek_type'] == 'enhance' || $usrInfo['leadspeek_type'] == 'b2b')
            {
                $rootAccConResult = $this->getcompanysetting($usrInfo['company_root_id'],'rootfee');
                $feepercentagedom = isset($rootAccConResult->feepercentagedom)?$rootAccConResult->feepercentagedom:"";   
                $feepercentagemob = isset($rootAccConResult->feepercentagemob)?$rootAccConResult->feepercentagemob:"";   
                // jika mobile, feepercentagedom milik mobile dan feepercentagemob milik dom 
                if($feepercentagedom != '' && $feepercentagemob != '')
                {
                    $feeMob = number_format((($platformfee * $feepercentagedom) / 100),2,'.','');
                    $feeDom = number_format((($platformfee * $feepercentagemob) / 100),2,'.','');
                    $remainingFeeEmm = number_format(($platformfee - $feeMob - $feeDom),2,'.','');
                    //$defaultInvoice .= ", From a net amount of \$$platformfee for root Emm, $feepercentagedom% (\$$feeMob) is allocated to Mobile and $feepercentagemob% ($feeDom) to Dominator, leaving a remaining balance of \$$remainingFeeEmm.";
                }
                // jika dominator, feepercentagedom milik dominator 
                else if($feepercentagedom != '')
                {
                    $feeDom = number_format((($platformfee * $feepercentagedom) / 100),2,'.','');
                    $remainingFeeEmm = number_format(($platformfee - $feeDom),2,'.','');
                    //$defaultInvoice .= ", From a net amount of \$$platformfee for root Emm, $feepercentagedom% (\$$feeDom) is allocated to Dominator, leaving a remaining balance of \$$remainingFeeEmm";
                }
            }
            /* UPDATE DESCRIPTION */

            /** CHECK IF TOTAL AMOUNT IS SMALLER THAN PLATFORM FEE */
            //if (($totalAmount < $platformfee) && $platformfee > 0) {
            // if ($platformfee >= 0.5) {
            //     $agencystripe = $this->check_agency_stripeinfo($usrInfo[0]->company_parent,$platformfee,$usrInfo[0]->leadspeek_api_id,'Agency ' . $defaultInvoice);
            //     $agencystriperesult = json_decode($agencystripe);
            //     $platformfee_charge = true;

            //     if ($agencystriperesult->result == 'success') {
            //         $platform_paymentintentID = $agencystriperesult->payment_intentID;
            //         $sr_id = $agencystriperesult->srID;
            //         $ae_id = $agencystriperesult->aeID;
            //         $sales_fee = $agencystriperesult->salesfee;
            //         $platformfee = 0;
            //         $platform_errorstripe = '';
            //     }else{
            //         $platform_paymentintentID = $agencystriperesult->payment_intentID;
            //         $platform_errorstripe .= $agencystriperesult->error;
            //     }
            // }
            /** CHECK IF TOTAL AMOUNT IS SMALLER THAN PLATFORM FEE */

            /* GET BALANCE TOPUP AGENCY */
            $balanceAmount = 0;
            $agencyAgreeDataWallet = 'F';
            if($usrInfo['company_root_id'] == $systemid)
            {
                // get agency
                $agency = User::where('company_id', $usrInfo['company_parent'])
                              ->where('user_type', 'userdownline')
                              ->first();
                $agencyID = $agency->id ?? null;
                // get agency

                // get service agreement data wallet
                $featureDataWalletId = MasterFeature::where('slug', 'data_wallet')
                                                    ->value('id');
                $serviceAgreement = ServicesAgreement::where('user_id','=',$agencyID)
                                                     ->where('feature_id','=',$featureDataWalletId)
                                                     ->first();
                $agencyAgreeDataWallet = (isset($serviceAgreement->status) && $serviceAgreement->status == 'T') ? $serviceAgreement->status : 'F';
                // info(['action' => 'get agreement', 'agencyID' => $agencyID, 'agencyAgreeDataWallet' => $agencyAgreeDataWallet]);
                // get service agreement data wallet

                // get balance
                $balanceAmount = TopupAgency::where('company_id','=',$usrInfo['company_parent'])
                                            ->where('topup_status','<>','done')
                                            ->whereNull('expired_at')
                                            ->sum('balance_amount');
                // get balance
            }
            // info(['action' => 'get balance amount in charge client', 'balanceAmount' => $balanceAmount, 'paymentterm' => $paymentterm, 'AgencyManualBill' => $AgencyManualBill]);
            /* GET BALANCE TOPUP AGENCY */
            
            /* WHEN SIMPLIFI is_agency_covers_cost  */
            $is_agency_covers_cost = ($usrInfo['leadspeek_type'] == 'simplifi' && $usrInfo['agency_covers_cost'] == 1) ? true : false;
            if ($is_agency_covers_cost) {
                $totalAmount = 0;
            }
            /* WHEN SIMPLIFI is_agency_covers_cost  */
                
            /** CREATE ONE TIME PAYMENT USING PAYMENT INTENT */
            if ($totalAmount < 0.5 || $totalAmount <= 0) 
            {
                $paymentintentID = '';
                $statusPayment = 'paid';
                $platformfee_charge = false;
            }
            else
            {
                // info(['AgencyManualBill' => $AgencyManualBill]);
                if ($AgencyManualBill == 'F') 
                { 
                    try 
                    {
                        $chargeAmount = $totalAmount * 100;
                        $timestampKey = Carbon::now()->format('YmdHi'); // formatnya {namafungsi}_{leadspeekapiid}_{waktusampaimenit}
                        $idempotencyKey = "chargeclient_{$usrInfo['leadspeek_api_id']}_{$timestampKey}";
                        $statusPayment = 'paid';
                        $errorstripe = '';
                        
                        // jika agency belum agree data wallet balance 0 atau bukan prepaid atau bukan dari root emm
                        if(
                            $agencyAgreeDataWallet != 'T' || // jika agency belum agree data wallet 
                            $balanceAmount == 0 || // balance data wallet agency 0
                            $paymentterm != 'Prepaid' || // type paymentterm campaign bukan prepaid
                            $usrInfo['leadspeek_type'] == 'simplifi' || // campaign type simplifii
                            $usrInfo['company_root_id'] != $systemid // bukan dari root emm
                        ) 
                        {
                            $dataPaymentIntent = [
                                'payment_method_types' => ['card'],
                                'customer' => trim($custStripeID),
                                'amount' => $chargeAmount,
                                'currency' => 'usd',
                                'receipt_email' => $custEmail,
                                'payment_method' => $custStripeCardID,
                                'confirm' => true,
                                'description' => $defaultInvoice,
                                'application_fee_amount' => ($platformfee * 100)
                            ];
                            $platformfee_charge = true;
                            // info(['action' => 'prosess charge client with application_fee_amount','dataPaymentIntent' => $dataPaymentIntent,'idempotencyKey' => $idempotencyKey,'stripe_account' => $accConID]);
                            $payment_intent =  $stripe->paymentIntents->create($dataPaymentIntent, ['stripe_account' => $accConID, 'idempotency_key' => $idempotencyKey]);
    
                            /* CHECK STATUS PAYMENT INTENTS */
                            $payment_intent_status = (isset($payment_intent->status))?$payment_intent->status:"";
                            if($payment_intent_status == 'requires_action') 
                            {
                                $statusPayment = 'failed';
                                $platformfee_charge = false;
                            }
                            /* CHECK STATUS PAYMENT INTENTS */
    
                            $paymentintentID = $payment_intent->id;
    
                            if($statusPayment == 'paid' && $platformfee_charge && $usrInfo['leadspeek_type'] != 'simplifi') 
                            {
                                /** TRANSFER SALES COMMISSION IF ANY */
                                $dataCustomCommissionSales = [
                                    'type' => 'topup',
                                    'platform_price_lead' => $topup['platform_price'],
                                    'total_lead_topup' => $topup['total_leads'],
                                ];
                                $_cleanProfit = "";
                                if($rootFee != "0" && $rootFee != "") 
                                {
                                    $_cleanProfit = $platformfee_ori - $rootFee;
                                }
                                $salesfee = $this->transfer_commission_sales($usrInfo['company_parent'],$platformfee,$usrInfo['leadspeek_api_id'],date('Y-m-d'),date('Y-m-d'),$stripeseckey,$_ongoingleads,$_cleanProfit,$dataCustomCommissionSales);
                                $salesfeeresult = json_decode($salesfee);
                                $platform_paymentintentID = $salesfeeresult->payment_intentID ?? '';
                                $sr_id = $salesfeeresult->srID ?? 0;
                                $ae_id = $salesfeeresult->aeID ?? 0;
                                $ar_id = $salesfeeresult->arID ?? 0;
                                $sr_fee = $salesfeeresult->srFee ?? 0;
                                $ae_fee = $salesfeeresult->aeFee ?? 0;
                                $ar_fee = $salesfeeresult->arFee ?? 0;
                                $sr_transfer_id = $salesfeeresult->srTransferID ?? '';
                                $ae_transfer_id = $salesfeeresult->aeTransferID ?? '';
                                $ar_transfer_id = $salesfeeresult->arTransferID ?? '';
                                $sales_fee = $salesfeeresult->salesfee ?? 0;
                                /** TRANSFER SALES COMMISSION IF ANY */
                            }
                        }
                    }
                    catch (RateLimitException $e) 
                    {
                        // info(__FUNCTION__, ['error1' => $e->getMessage()]);
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Too many requests made to the API too quickly
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } 
                    catch (InvalidRequestException $e) 
                    {
                        // info(__FUNCTION__, ['error2' => $e->getMessage()]);
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Invalid parameters were supplied to Stripe's API
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } 
                    catch (AuthenticationException $e) 
                    {
                        // info(__FUNCTION__, ['error3' => $e->getMessage()]);
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Authentication with Stripe's API failed
                        // (maybe you changed API keys recently)
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } 
                    catch (ApiConnectionException $e) 
                    {
                        // info(__FUNCTION__, ['error4' => $e->getMessage()]);
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Network communication with Stripe failed
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } 
                    catch (ApiErrorException $e) 
                    {
                        // info(__FUNCTION__, ['error5' => $e->getMessage()]);
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Display a very generic error to the user, and maybe send
                        // yourself an email
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } 
                    catch (Exception $e) 
                    {
                        // info(__FUNCTION__, ['error6' => $e->getMessage()]);
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Something else happened, completely unrelated to Stripe
                        $errorstripe = 'error not stripe things';
                    }
                }
                else
                {
                    $statusPayment = 'paid';
                    $platformfee_charge = false;
                    $errorstripe = "This direct Agency Bill Method";
                }
            }
            /** UPDATE USER CARD DIRECTLY IF PAYMENt FAILED */
            
            /* GET CARD INFO */
            $cardinfo = "";
            $cardlast = "";
            if ($AgencyManualBill == "T") 
            {
                $custStripeID = $custAgencyStripeID;
                $custStripeCardID = $custAgencyStripeCardID;
                $cardinfo = $stripe->customers->retrieveSource(trim($custStripeID),trim($custStripeCardID),[]);
                $cardlast = $cardinfo->last4;
            }
            else 
            {
                $cardinfo = $stripe->customers->retrieveSource(trim($custStripeID),trim($custStripeCardID),[],['stripe_account' => $accConID]);
                $cardlast = $cardinfo->last4;
            }
            /* GET CARD INFO */

            /** CHECK IF FAILED CHARGE CLIENT WE STILL CHARGE THE AGENCY */
            if (
                ($platformfee_charge == false && $platformfee >= 0.5 && $statusPayment == "paid" && $AgencyManualBill == 'T') || // jika manual bill
                ($totalAmount <= 0 && $platformfee_charge == false && $statusPayment == "paid" && $AgencyManualBill == 'F') || // jika tidak manual bill dan cost client = 0 dan cost agency > 0
                ($platformfee_charge == false && $platformfee > 0 && $statusPayment == "paid" && $balanceAmount > 0 && $agencyAgreeDataWallet == 'T' && $paymentterm == 'Prepaid' && $usrInfo['leadspeek_type'] != 'simplifi') // jika balance dari data wallet agency > 0 dan sudah agree data wallet dan paymentterm prepaid
            ) 
            {
                // info('masuk if check_agency_stripeinfo');
                $dataCustomCommissionSales = [];
                if(count($topup) > 0) // karena chargeClient disini bisa untuk prepaid atau weekly atau monthly, jadi pastikan hanya prepaid 
                { 
                    $dataCustomCommissionSales = [
                        'type' => 'topup',
                        'platform_price_lead' => $topup['platform_price'],
                        'total_lead_topup' => $topup['total_leads'],
                    ];
                }

                $_cleanProfit = "";
                if($rootFee != "0" && $rootFee != "") 
                {
                    $_cleanProfit = $platformfee_ori - $rootFee;
                }

                $dataChargeClient = [
                    'stripeseckey' => $stripeseckey,
                    'accConID' => $accConID,
                    'customer' => $custStripeID,
                    'amount' => $totalAmount,
                    'receipt_email' => $custEmail,
                    'payment_method' => $custStripeCardID,
                    'description' => $defaultInvoice,
                ];
                $agencystripe = $this->check_agency_stripeinfo($usrInfo['company_parent'],$platformfee,$usrInfo['leadspeek_api_id'],'Agency ' . $defaultInvoice,date('Y-m-d 00:00:00'),date('Y-m-d 23:59:59'),$_ongoingleads,$_cleanProfit,$dataCustomCommissionSales,$AgencyManualBill,$dataChargeClient);
                $agencystriperesult = json_decode($agencystripe);
                // info(__FUNCTION__, ['agencystriperesult' => $agencystriperesult]);

                if (($agencystriperesult->result ?? '') == 'success') 
                {
                    $platform_paymentintentID = $agencystriperesult->payment_intentID ?? '';
                    $sr_id = $agencystriperesult->srID ?? 0;
                    $ae_id = $agencystriperesult->aeID ?? 0;
                    $ar_id = $agencystriperesult->arID ?? 0;
                    $sr_fee = $agencystriperesult->srFee ?? 0;
                    $ae_fee = $agencystriperesult->aeFee ?? 0;
                    $ar_fee = $agencystriperesult->arFee ?? 0;
                    $sr_transfer_id = $agencystriperesult->srTransferID ?? '';
                    $ae_transfer_id = $agencystriperesult->aeTransferID ?? '';
                    $ar_transfer_id = $agencystriperesult->arTransferID ?? '';
                    $sales_fee = $agencystriperesult->salesfee ?? 0;
                    $topup_agencies_id = $agencystriperesult->topup_agencies_id ?? null;
                    $leadspeek_invoices_id = $agencystriperesult->leadspeek_invoices_id ?? null;
                    $platform_errorstripe = '';
                    $statusPayment = $agencystriperesult->statusPayment ?? '';
                    if(($agencystriperesult->statusPaymentClient ?? '') == 'failed') 
                    {
                        $statusPayment = $agencystriperesult->statusPaymentClient ?? '';
                        $errorstripe = $agencystriperesult->errorstripeClient ?? '';
                    }
                }
                else
                {
                    $platform_paymentintentID = $agencystriperesult->payment_intentID ?? '';
                    $platform_errorstripe .= $agencystriperesult->error ?? '';
                    $statusPayment = 'failed';
                }
            }
            /** CHECK IF FAILED CHARGE CLIENT WE STILL CHARGE THE AGENCY */

            /** UPDATE USER CLIENT CARD STATUS */
            $topup_campaigns_id = null;
            if ($statusPayment == 'failed') 
            {
                if ($AgencyManualBill == 'F' && !empty($errorstripe)) 
                {
                    $updateUser = User::find($usrInfo['user_id']);
                    $updateUser->payment_status = 'failed';
                    $updateUser->save();
                    
                    // Update failed_prepaid_campaignid if paymentterm is Prepaid
                    $this->recordPrepaidCampaignsStopContinualTopup($updateUser, $usrInfo['leadspeek_api_id'] ?? '', $usrInfo['paymentterm'] ?? '');
                }
            }
            else if (count($paramTopup) > 0) 
            {
                /** CREATE TOP UP */
                $create = Topup::create($paramTopup);
                $topup_campaigns_id = $create->id;
                Log::info("Buy Top Up ID: " . $create->id);
                /** CREATE TOP UP */
            }
            /** UPDATE USER CARD STATUS */

            $statusClientPayment = $statusPayment;
            $_company_id = $usrInfo['company_id'];
            $_user_id = $usrInfo['user_id'];
            $_leadspeek_api_id = $usrInfo['leadspeek_api_id'];
            $clientPaymentTerm = $usrInfo['paymentterm'];
            //$minCostLeads = $usrInfo[0]->lp_min_cost_month;
            $minCostLeads = number_format($platformFee,2,'.','');
            $total_leads =  '0';
            $cost_perlead = '0';
            $platform_cost_leads = '0';
            $root_total_amount = '0';
            // variable untuk simplifi
            $budget_plan_id = null;
            $budget_end_date = null;
            $frequency_capping_impressions = '0';
            $frequency_capping_hours = '0';
            $max_bid = '0';
            $monthly_budget = '0';
            $daily_budget = '0';
            $goal_type = null;
            $goal_value = '0';
            $agency_markup = '0';
            // variable untuk simplifi
            if ($usrInfo['paymentterm'] == 'Prepaid')
            {
                if ($usrInfo['leadspeek_type'] == 'simplifi')
                {
                    if ($statusPayment != 'failed')
                    {
                        // update campaign simplifi
                        $campaign_settings_update_campaign = $dataSimplifi['campaign_settings_update_campaign'] ?? [];
                        $response = $simplifiService->update_campaign($leadspeek_organizationid, $leadspeek_campaignsid, $campaign_settings_update_campaign);
                        // info('update_campaign', ['response' => $response]);
                        // update campaign simplifi

                        // add new budget
                        $campaign_settings_add_budget = $dataSimplifi['campaign_settings_add_budget'] ?? [];
                        $response = $simplifiService->add_budget_plans_to_campaign($leadspeek_campaignsid, $campaign_settings_add_budget);
                        // info('add_budget_plans_to_campaign', ['response' => $response]);
                        // add new budget
                            
                        // get lates budget
                        $budget_plan_id = isset($response['budget_plans'][0]['id']) ? $response['budget_plans'][0]['id'] : null;
                        $budget_end_date = isset($response['budget_plans'][0]['end_date']) ? $response['budget_plans'][0]['end_date'] : null;
                        // get lates budget

                        // get other variable simplifi
                        $frequency_capping_impressions = $usrInfo['frequency_capping_impressions'];
                        $frequency_capping_hours = $usrInfo['frequency_capping_hours'];
                        $max_bid = $usrInfo['max_bid'];
                        $monthly_budget = $usrInfo['monthly_budget'];
                        $daily_budget = $usrInfo['daily_budget'];
                        $goal_type = $usrInfo['goal_type'];
                        $goal_value = $usrInfo['goal_value'];
                        $agency_markup = $usrInfo['agency_markup'];
                        // get other variable simplifi

                        // update status campaign simplifi to active
                        try{
                            $response = $simplifiService->update_status_campaign($leadspeek_organizationid, $leadspeek_campaignsid, 'active');
                        }catch(\Exception $e){
                            Log::error("[ChargeClient] Error update_status_campaign simplifi: {$e->getMessage()}");
                        }
                        // update status campaign simplifi to active
                    }
                }
                else 
                {
                    $tmpMinCost = (isset($usrInfo['lp_min_cost_month']))?$usrInfo['lp_min_cost_month']:'0';
                    $minCostLeads = number_format($tmpMinCost,2,'.','');
                    $total_leads =  (isset($paramTopup['total_leads'])) ? ($paramTopup['total_leads']) : ((isset($usrInfo['leadsbuy'])) ? $usrInfo['leadsbuy'] : '0');
                    $cost_perlead = (isset($usrInfo['cost_perlead']))?$usrInfo['cost_perlead']:'0';
                    $platform_cost_leads = $platform_LeadspeekCostperlead;
                    $root_total_amount = (isset($usrInfo['root_price']))?$usrInfo['root_price']:'0';
                    $root_total_amount = $total_leads * $root_total_amount;
                }
            }
            // info(['budget_plan_id' => $budget_plan_id,'budget_end_date' => $budget_end_date,'frequency_capping_impressions' => $frequency_capping_impressions,'frequency_capping_hours' => $frequency_capping_hours,'max_bid' => $max_bid,'monthly_budget' => $monthly_budget,'daily_budget' => $daily_budget,'goal_type' => $goal_type,'goal_value' => $goal_value,'agency_markup' => $agency_markup,]);
            //$reportSentTo = explode(PHP_EOL, $usrInfo['report_sent_to']);
            $_reportSentTo = str_replace(["\r\n", "\r"], "\n", trim($usrInfo['report_sent_to']));
            $reportSentTo = explode("\n", $_reportSentTo);
            $todayDate = date('Y-m-d H:i:s');
            $clientMaxperTerm = $usrInfo['lp_max_lead_month'];
            $oneTime = number_format($oneTime,2,'.','');

            /** CHECK IF ROOT FEE TRANSFER ENABLED */
            if ($rootFeeTransfer && $statusPayment == 'paid') 
            {
                $this->root_fee_commission($usrInfo,$stripeseckey,$usrInfo['company_name'],$usrInfo['leadspeek_api_id'],$rootFee,$platformfee_ori);
            }
            /** CHECK IF ROOT FEE TRANSFER ENABLED */

            /* GET ID SALES AGENCY */
            if (trim($sr_id) == "") 
            {
                $sr_id = 0;
            }
            if (trim($ae_id) == "") 
            {
                $ae_id = 0;
            }
            if (trim($ar_id) == "") 
            {
                $ar_id = 0;
            }
            /* GET ID SALES AGENCY */

            /** CREATE INVOICE FOR THIS */
            $invoiceID = "";
            $lpupdate = LeadspeekUser::find($_lp_user_id);
            if($statusPayment != 'failed')
            {
                if(empty($leadspeek_invoices_id) || trim($leadspeek_invoices_id) == '')
                {
                    // info('buat invoice');
                    $invoiceCreated = LeadspeekInvoice::create([
                        'topup_agencies_id' => $topup_agencies_id,
                        'topup_campaigns_id' => $topup_campaigns_id,
                        'budget_plan_id' => $budget_plan_id,
                        'company_id' => $_company_id,
                        'user_id' => $_user_id,
                        'leadspeek_api_id' => $_leadspeek_api_id,
                        'invoice_number' => '',
                        'payment_term' => $clientPaymentTerm,
                        'onetimefee' => $oneTime,
                        'platform_onetimefee' => $platform_LeadspeekPlatformFee,
                        'min_leads' => $clientMaxperTerm,
                        'exceed_leads' => '0',
                        'total_leads' => $total_leads,
                        'min_cost' => $minCostLeads,
                        'platform_min_cost' => $platform_LeadspeekMinCostMonth,
                        'cost_leads' => $cost_perlead,
                        'platform_cost_leads' => $platform_cost_leads,
                        'frequency_capping_impressions' => $frequency_capping_impressions,
                        'frequency_capping_hours' => $frequency_capping_hours,
                        'max_bid' => $max_bid,
                        'monthly_budget' => $monthly_budget,
                        'daily_budget' => $daily_budget,
                        'goal_type' => $goal_type,
                        'goal_value' => $goal_value,
                        'agency_markup' => $agency_markup,
                        'total_amount' => $totalAmount,
                        'platform_total_amount' => $platformfee_ori,
                        'root_total_amount' => $root_total_amount,
                        'status' => $statusPayment,
                        'customer_payment_id' => $paymentintentID,
                        'platform_customer_payment_id' => $platform_paymentintentID,
                        'error_payment' => $errorstripe,
                        'platform_error_payment' => $platform_errorstripe,
                        'invoice_date' => date('Y-m-d'),
                        'invoice_start' => date('Y-m-d'),
                        'invoice_end' => date('Y-m-d'),
                        'sent_to' => json_encode($reportSentTo),
                        'sr_id' => $sr_id,
                        'sr_fee' => $sr_fee,
                        'sr_transfer_id' => $sr_transfer_id,
                        'ae_id' => $ae_id,
                        'ae_fee' => $ae_fee,
                        'ae_transfer_id' => $ae_transfer_id,
                        'ar_id' => $ar_id,
                        'ar_fee' => $ar_fee,
                        'ar_transfer_id' => $ar_transfer_id,
                        'active' => 'T',
                    ]);
                    $invoiceID = $invoiceCreated->id;
                }
                else
                {
                    // info('update invoice');
                    $invoiceID = $leadspeek_invoices_id;
                    $dataLeadspeekInvoiceUpdate = [
                        'topup_agencies_id' => $topup_agencies_id,
                        'topup_campaigns_id' => $topup_campaigns_id,
                        'budget_plan_id' => $budget_plan_id,
                        'company_id' => $_company_id,
                        'user_id' => $_user_id,
                        'invoice_number' => '',
                        'payment_term' => $clientPaymentTerm,
                        'onetimefee' => $oneTime,
                        'platform_onetimefee' => $platform_LeadspeekPlatformFee,
                        'min_leads' => $clientMaxperTerm,
                        'exceed_leads' => '0',
                        'total_leads' => $total_leads,
                        'min_cost' => $minCostLeads,
                        'platform_min_cost' => $platform_LeadspeekMinCostMonth,
                        'cost_leads' => $cost_perlead,
                        'platform_cost_leads' => $platform_cost_leads,
                        'frequency_capping_impressions' => $frequency_capping_impressions,
                        'frequency_capping_hours' => $frequency_capping_hours,
                        'max_bid' => $max_bid,
                        'monthly_budget' => $monthly_budget,
                        'daily_budget' => $daily_budget,
                        'goal_type' => $goal_type,
                        'goal_value' => $goal_value,
                        'agency_markup' => $agency_markup,
                        'total_amount' => $totalAmount,
                        'platform_total_amount' => $platformfee_ori,
                        'root_total_amount' => $root_total_amount,
                        'status' => $statusPayment,
                        // 'customer_payment_id' => $paymentintentID,
                        'platform_customer_payment_id' => $platform_paymentintentID,
                        'error_payment' => $errorstripe,
                        'platform_error_payment' => $platform_errorstripe,
                        'invoice_date' => date('Y-m-d'),
                        'invoice_start' => date('Y-m-d'),
                        'invoice_end' => date('Y-m-d'),
                        'sent_to' => json_encode($reportSentTo),
                        'sr_id' => $sr_id,
                        'sr_fee' => $sr_fee,
                        'sr_transfer_id' => $sr_transfer_id,
                        'ae_id' => $ae_id,
                        'ae_fee' => $ae_fee,
                        'ae_transfer_id' => $ae_transfer_id,
                        'ar_id' => $ar_id,
                        'ar_fee' => $ar_fee,
                        'ar_transfer_id' => $ar_transfer_id,
                        'active' => 'T',
                    ];
                    if(!empty($paymentintentID) && trim($paymentintentID) != ''){
                        $dataLeadspeekInvoiceUpdate['customer_payment_id'] = $paymentintentID;
                    }
                    LeadspeekInvoice::where('id','=',$invoiceID)->update($dataLeadspeekInvoiceUpdate);
                }
                $invoice = LeadspeekInvoice::find($invoiceID);
                if(!empty($invoice)) 
                {
                    $invoice->invoice_number = $invoiceNum . '-' . $invoiceID;
                    $invoice->save();
                }
                if ($lpupdate->leadspeek_type == 'simplifi')
                {
                    $lpupdate->lp_enddate = $budget_end_date;
                }
                if ($AgencyManualBill == 'F')
                {
                    // clear payment status client 
                    $updateUser = User::where('id', $usrInfo['user_id'])->first();
                    if($updateUser && empty($updateUser->failed_campaignid) && empty($updateUser->failed_total_amount))
                    {
                        $updateUser->payment_status = '';
                        $updateUser->save();
                        
                        // Reset stopcontinual from T to F for campaigns in failed_prepaid_campaignid
                        $this->resumePrepaidCampaignsStopContinualTopup($updateUser, $usrInfo['user_id'] ?? null, 'auto topup campaign');
                    }
                    // clear payment status client
                }
            }
            $lpupdate->ongoing_leads = 0;
            // $lpupdate->start_billing_date = $todayDate;
            $lpupdate->lifetime_cost = ($lpupdate->lifetime_cost + $totalAmount);
            $lpupdate->is_send_email_prepaid = 'F';
            $lpupdate->save();
            /** CREATE INVOICE FOR THIS */

            /** GET NAME CAMPAIGN AND COMPANY NAME */
            $campaignName = '';
            if (isset($usrInfo['campaign_name']) && trim($usrInfo['campaign_name']) != '') 
            {
                $campaignName = ' - ' . str_replace($_leadspeek_api_id,'',$usrInfo['campaign_name']);
            }
            $companyName = str_replace($_leadspeek_api_id,'',$usrInfo['company_name']) . $campaignName;
            /** GET NAME CAMPAIGN AND COMPANY NAME */

            /** FIND ADMIN EMAIL */
            $adminnotify = explode(',',$usrInfo['admin_notify_to']);
            $tmp = User::select('email')->whereIn('id', $adminnotify)->get();
            $adminEmail = array();
            foreach($tmp as $ad) 
            {
                array_push($adminEmail,$ad['email']);
            }
            //array_push($adminEmail,'serverlogs@sitesettingsapi.com');
            if ($statusPayment == 'paid') 
            {
                $statusPayment = "Customer's Credit Card Successfully Charged ";
            }
            else if ($statusPayment == 'failed') 
            {
                $statusPayment = "Customer's Credit Card Failed";
            }
            else
            {
                $statusPayment = "Customer's Credit Card Successfully Charged ";
            }
            if ($totalAmount == '0.00' || $totalAmount == '0') 
            {
                $statusPayment = "Customer's Credit Card Successfully Charged";
            }
            if ($platformfee_ori != '0.00' || $platformfee_ori != '0') 
            {
                if ($statusClientPayment == 'failed' && $clientPaymentTerm != 'Prepaid') 
                {
                    $statusPayment .= " and Agency's Card Charged For Overage";
                }
            }
            if ($AgencyManualBill == "T") 
            {
                $statusPayment = "You must directly bill your client the amount due.";
            }
            /** FIND ADMIN EMAIL */

            /** UPDATE CLIENT STRIPE PAYMENT DESCRIPTION */
            if ($paymentintentID != "") 
            {
                try 
                {
                    $updatePaymentClientDesc =  $stripe->paymentIntents->update(
                        $paymentintentID,
                        ['description' => $defaultInvoice_ori],
                        ['stripe_account' => $accConID]
                    );
                }
                catch (\Throwable $e) 
                {
                    Log::error("Error Update Client Stripe Payment Description In Function Charge Client Message = {$e->getMessage()}");
                }
            }
            /** UPDATE CLIENT STRIPE PAYMENT DESCRIPTION */

            /** SEND EMAIL */
            $AdminDefault = $this->get_default_admin($usrInfo['company_root_id']);
            $AdminDefaultEmail = (isset($AdminDefault[0]['email']))?$AdminDefault[0]['email']:'';
            $rootCompanyInfo = $this->getCompanyRootInfo($usrInfo['company_root_id']);
            $defaultdomain = $this->getDefaultDomainEmail($usrInfo['company_root_id']);

            $details = [
                'leadspeek_type' => $lpupdate->leadspeek_type,
                'max_bid' => $lpupdate->max_bid, 
                'monthly_budget' => $lpupdate->monthly_budget,
                'daily_budget' => $lpupdate->daily_budget,
                'goal_type' => $lpupdate->goal_type,
                'goal_value' => $lpupdate->goal_value,
                'agency_markup' => $lpupdate->agency_markup,
                'agency_profit' => $profitAgency,
                'paymentterm' => $clientPaymentTerm,
                'name'  => $companyName,
                'cardlast' => trim($cardlast),
                'leadspeekapiid' =>$_leadspeek_api_id,
                'invoiceNumber' => !empty($invoiceID) ? ("$invoiceNum-$invoiceID") : $invoiceNum,
                'invoiceStatus' => $statusPayment,
                'invoiceDate' => date('m-d-Y'),
                'onetimefee' => $oneTime,
                'cost_perlead' => (isset($topup['cost_perlead']))?$topup['cost_perlead']:'0',
                'total_leads' => (isset($topup['total_leads']))?$topup['total_leads']:'0',
                'platform_onetimefee' => $platform_LeadspeekPlatformFee,
                'platform_cost_perlead' => (isset($topup['platform_price']))?$topup['platform_price']:'0',
                'min_cost' => $minCostLeads,
                'platform_min_cost' => $platform_LeadspeekMinCostMonth,
                'min_leads'=> $clientMaxperTerm,
                'total_amount' => $totalAmount,  
                'platform_total_amount' => $platformfee_ori,
                'invoicetype' => 'agency',
                'agencyname' => $rootCompanyInfo['company_name'],
                'defaultadmin' => $AdminDefaultEmail,
            ];
            $attachement = array();
            $from = [
                'address' => 'noreply@' . $defaultdomain,
                'name' => 'Invoice',
                'replyto' => 'support@' . $defaultdomain,
            ];

            $subjectFailed = "";
            if ($statusClientPayment == 'failed') 
            {
                $subjectFailed = "Failed Payment - ";
            }

            $tmp = $this->send_email($adminEmail,$subjectFailed . 'Invoice for ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',$details,$attachement,'emails.tryseramatchlistcharge',$from,$usrInfo['company_parent'],true);
            $tmp = $this->send_email(array('serverlogs@sitesettingsapi.com'),$subjectFailed . 'Invoice for ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',$details,$attachement,'emails.tryseramatchlistcharge',$from,'',true);
            /** SEND EMAIL */

            /** CHECK IF FAILED PAYMENT THEN PAUSED THE CAMPAIGN AND SENT EMAIL*/
            if ($statusClientPayment == 'failed') 
            {
                $ClientCompanyIDFailed = "";
                $ListFailedCampaign = "";

                $leadsuser = LeadspeekUser::select('leadspeek_users.leadspeek_type','leadspeek_users.active','leadspeek_users.disabled','leadspeek_users.trysera','leadspeek_users.leadspeek_organizationid','leadspeek_users.leadspeek_campaignsid','leadspeek_users.lp_limit_freq','users.customer_payment_id','leadspeek_users.user_id','leadspeek_users.paymentterm','leadspeek_users.topupoptions','users.company_id')
                                          ->join('users','leadspeek_users.user_id','=','users.id')
                                          ->where('leadspeek_users.leadspeek_api_id','=',$_leadspeek_api_id)
                                          ->get();
                if (count($leadsuser) > 0)
                {
                    foreach($leadsuser as $lds)
                    {
                        $ClientCompanyIDFailed = $lds['company_id'];

                        if ($lds['active'] == "T" || ($lds['active'] == "F" && $lds['disabled'] == "F")) // jika kondisi running, paused on run, dan paused 
                        {
                            $tryseramethod = (isset($lds['trysera']) && $lds['trysera'] == "T")?true:false;
                            $http = new \GuzzleHttp\Client;
                            $appkey = config('services.trysera.api_id');
                            $organizationid = ($lds['leadspeek_organizationid'] != "")?$lds['leadspeek_organizationid']:"";
                            $campaignsid = ($lds['leadspeek_campaignsid'] != "")?$lds['leadspeek_campaignsid']:"";    
                            $userStripeID = $lds['customer_payment_id'];
                            
                            $updateLeadspeekUser = LeadspeekUser::find($_lp_user_id);
                            if($lds['paymentterm'] == 'Prepaid') 
                            {
                                if($lds['leadspeek_type'] == 'simplifi') // jika simplifi
                                {
                                    $updateLeadspeekUser->active = 'F';
                                    $updateLeadspeekUser->disabled = 'T';
                                    $updateLeadspeekUser->active_user = 'F';

                                    /** STOP CAMPAIGN SIMPLIFI */
                                    if ($organizationid != '' && $campaignsid != '')
                                    {
                                        $response = $simplifiService->update_status_campaign($organizationid, $campaignsid, 'stop');
                                        // info('update_status_campaign_stop', ['response' => $response]);
                                    }
                                    /** STOP CAMPAIGN SIMPLIFI */
                                }
                                else if($lds['topupoptions'] == 'continual') // jika bukan simplifi dan topupoptionsnya continual
                                {
                                    if($lds['lp_limit_freq'] == 'day') // jika freq day maka ubah stop continual menjadi T, agar menghabiskan sisanya
                                    {
                                        // info('prepaid day');
                                        $updateLeadspeekUser->stopcontinual = 'T';
                                    }
                                    else if($lds['lp_limit_freq'] == 'month') // jika freq month langsung di stop, karena saat auto topup balance nya pasti 0
                                    {
                                        // info('prepaid month');
                                        $updateLeadspeekUser->active = 'F';
                                        $updateLeadspeekUser->disabled = 'T';
                                        $updateLeadspeekUser->active_user = 'F';
                                    }
                                }
                            }
                            $updateLeadspeekUser->save();
                            $ListFailedCampaign = $ListFailedCampaign . $_leadspeek_api_id . '<br/>';
                        }
                    }

                    /** SEND EMAIL TELL THIS CAMPAIGN HAS BEEN PAUSED BECAUSE FAILED PAYMENT */
                    if($lpupdate->leadspeek_type != 'simplifi')
                    {
                        $from = [
                            'address' => 'noreply@' . $defaultdomain,
                            'name' => 'Billing Notifications',
                            'replyto' => 'support@' . $defaultdomain,
                        ]; 
    
                        $details = [
                            'title' => 'Top Up Prepaid Failed For Company Name: ' . $companyName . ' Campaign ID #' . $_leadspeek_api_id . '. The Campaign Is Still Running, But It Has Switched To Stop Continual Mode',
                            'content'  => 'Top Up Prepaid Failed For Company Name: ' . $companyName . ' Campaign ID #' . $_leadspeek_api_id . '. The Campaign Is Still Running, But It Has Switched To Stop Continual Mode'
                        ];
                        
                        $tmp = $this->send_email($adminEmail,'Top Up Prepaid failed for campaign ID #' . $_leadspeek_api_id,$details,array(),'emails.customemail',$from,$usrInfo['company_parent'],true);
                        $tmp = $this->send_email(array('serverlogs@sitesettingsapi.com'),'Top Up Prepaid failed for campaign ID #' . $_leadspeek_api_id,$details,array(),'emails.customemail',$from,'',true);
                    }
                    /** SEND EMAIL TELL THIS CAMPAIGN HAS BEEN PAUSED BECAUSE FAILED PAYMENT */
                }
            }
            /** CHECK IF FAILED PAYMENT THEN PAUSED THE CAMPAIGN AND SENT EMAIL*/

            /* FOR USER LOGS */
            $companyParent = (isset($usrInfo['company_parent']))?$usrInfo['company_parent']:'';
            $agencyID = User::where('company_id', $companyParent)->where('user_type', 'userdownline')->where('active', 'T')->value('id'); 
            
            $action = "Campaign auto topup";
            if($statusClientPayment == 'failed') 
            {
                $action .= " failed payment";
            }
        
            $clientID = (isset($usrInfo['user_id']))?$usrInfo['user_id']:null;
            $leadspeek_api_id = (isset($usrInfo['leadspeek_api_id']))?$usrInfo['leadspeek_api_id']:'';
            $leadspeek_type = (isset($usrInfo['leadspeek_type']))?$usrInfo['leadspeek_type']:'';
            $paymentterm = (isset($usrInfo['paymentterm']))?strtolower($usrInfo['paymentterm']):'';
            $topupoptions = (isset($usrInfo['topupoptions']))?strtolower($usrInfo['topupoptions']):'';
            $continual_buy_options = (isset($usrInfo['continual_buy_options']))?$usrInfo['continual_buy_options']:'';
            $stopcontinual = (isset($usrInfo['stopcontinual']))?$usrInfo['stopcontinual']:'';
            $setup_fee = (isset($usrInfo['platformfee']))?$usrInfo['platformfee']:'';
            $campaign_fee_month = (isset($usrInfo['lp_min_cost_month']))?$usrInfo['lp_min_cost_month']:'';
            $cost_perlead = (isset($usrInfo['cost_perlead']))?$usrInfo['cost_perlead']:'';
            $lp_limit_leads = (isset($usrInfo['lp_limit_leads']))?$usrInfo['lp_limit_leads']:'';
            $frequency_capping_impressions = (isset($usrInfo['frequency_capping_impressions']))?$usrInfo['frequency_capping_impressions']:'';
            $frequency_capping_hours = (isset($usrInfo['frequency_capping_hours']))?$usrInfo['frequency_capping_hours']:'';
            $max_bid = (isset($usrInfo['max_bid']))?$usrInfo['max_bid']:'';
            $monthly_budget = (isset($usrInfo['monthly_budget']))?$usrInfo['monthly_budget']:'';
            $daily_budget = (isset($usrInfo['daily_budget']))?$usrInfo['daily_budget']:'';
            $goal_type = (isset($usrInfo['goal_type']))?$usrInfo['goal_type']:'';
            $goal_value = (isset($usrInfo['goal_value']))?$usrInfo['goal_value']:'';
            $agency_markup = (isset($usrInfo['agency_markup']))?$usrInfo['agency_markup']:'';
            $client_cost = $totalAmount;
            $agency_cost = $platformfee;
            $campaign_information_type_local = (isset($usrInfo['campaign_information_type_local']))?$usrInfo['campaign_information_type_local']:'';
            $ipAddress = "";
            
            $descLists = [
                "campaign id: $leadspeek_api_id",
                "campaign type: $leadspeek_type",
            ];
            if($leadspeek_type == 'simplifi')
            {
                $descLists[] = "frequency capping impressions: $frequency_capping_impressions";
                $descLists[] = "frequency capping hours: $frequency_capping_hours";
                $descLists[] = "max bid: $$max_bid";
                $descLists[] = "monthly budget: $$monthly_budget";
                $descLists[] = "daily budget: $$daily_budget";
                $descLists[] = "goal type: $goal_type";

                $goal_value_format = null;
                if($goal_type == 'ctr')
                    $goal_value_format = "$goal_value%";
                else if(in_array($goal_type, ['cpc', 'cpa']))
                    $goal_value_format = "$$goal_value";
                
                $descLists[] = "goal value: $goal_value_format";
                $descLists[] = "agency markup: $agency_markup%";
            }
            else 
            {
                $descLists[] = "payment term: $paymentterm";   
                $descLists[] = "top up options: $topupoptions";   

                if($topupoptions == 'continual')
                {
                    $descLists[] = "continual buy options: $continual_buy_options";
                    $descLists[] = "continual topup is : " . (($stopcontinual === 'T') ? 'disabled' : 'enabled');
                }

                $descLists[] = "setup fee : $$setup_fee";
                $descLists[] = "campaign fee: $$campaign_fee_month";
                $descLists[] = "cost per contact: $$cost_perlead";
                $descLists[] = "contact per day: $lp_limit_leads";
                $descLists[] = "client cost: $$client_cost";
                $descLists[] = "agency cost: $$agency_cost";

                if($leadspeek_type == 'local') 
                {
                    $descLists[] = "campaign information type local : $campaign_information_type_local";
                }
                $descLists[] = "start billing date : $startBillingDate";
            }
            $desc = implode(" | ", $descLists);

            // info(['companyParent' => $companyParent,'agencyID' => $agencyID,'action' => $action,'clientID' => $clientID,'leadspeek_api_id' => $leadspeek_api_id,'leadspeek_type' => $leadspeek_type,'paymentterm' => $paymentterm,'topupoptions' => $topupoptions,'continual_buy_options' => $continual_buy_options,'stopcontinual' => $stopcontinual,'setup_fee' => $setup_fee,'campaign_fee_month' => $campaign_fee_month,'cost_perlead' => $cost_perlead,'lp_limit_leads' => $lp_limit_leads,'frequency_capping_impressions' => $frequency_capping_impressions,'frequency_capping_hours' => $frequency_capping_hours,'max_bid' => $max_bid,'monthly_budget' => $monthly_budget,'daily_budget' => $daily_budget,'goal_type' => $goal_type,'goal_value' => $goal_value,'agency_markup' => $agency_markup,'client_cost' => $client_cost,'agency_cost' => $agency_cost,'campaign_information_type_local' => $campaign_information_type_local,'desc' => $desc,'ipAddress' => $ipAddress,]);
            $this->logUserAction($agencyID,$action,$desc,$ipAddress,$clientID);
            /* FOR USER LOGS */

            /* WEBHOOK SEND PAYLOAD */
            // info(['leadspeek_type' => $leadspeek_type]);
            if(in_array($leadspeek_type, ['local','enhance','b2b']))
            {
                $webhookEvent = ($statusClientPayment == 'failed') ? 'invoice.payment_failed' : 'invoice.succeeded';
                $webhookSendPayload = [
                    'type' => $webhookEvent,
                    'created' => Carbon::now()->timestamp,
                    'data' => [
                        'campaign' => [
                            'id' => (int) $leadspeek_api_id,
                            'name' => $usrInfo['campaign_name'] ?? '',
                            'payment_term' => $paymentterm,
                        ],
                        'client' => [
                            'id' => (int) $clientID,
                            'name' => $usrInfo['name'] ?? '',
                            'email' => $usrInfo['email'] ?? '',
                        ],
                        'pricing' => [
                            'client' => [
                                'setup_fee' => (float) $oneTime,
                                'campaign_fee' => (float) $minCostLeads,
                                'cost_per_lead' => (float) $cost_perlead,
                                'total_leads' => (int) $total_leads,
                                'total_amount' => (float) $totalAmount,
                            ],
                            'agency' => [
                                'setup_fee' => (float) $platform_LeadspeekPlatformFee,
                                'campaign_fee' => (float) $platform_LeadspeekMinCostMonth,
                                'cost_per_lead' => (float) $platform_cost_leads,
                                'total_leads' => (int) $total_leads,
                                'total_amount' => (float) $platformfee_ori,
                            ]
                        ]
                    ],
                ];
                // info(['webhookSendPayload' => $webhookSendPayload]);
                $openApiWebhookService = App::make(OpenApiWebhookService::class);
                $openApiWebhookService->sendWebhookEndpoint($companyParent, $webhookEvent, $webhookSendPayload);
            }
            /* WEBHOOK SEND PAYLOAD */
        }
        /** CHARGE WITH STRIPE */
    }

    public function root_fee_commission($usrInfo,$stripeseckey,$companyName,$_leadspeek_api_id,$rootFee = 0,$platformfee_ori = 0) 
    {
        /** CHARGE ROOT FEE AGENCY */
        if($rootFee != "0" && $rootFee != "") 
        {
            /** GET ROOT CONNECTED ACCOUNT TO BE TRANSFER FOR CLEAN PROFIT AFTER CUT BY ROOT FEE COST */
            $stripe = new StripeClient([
                'api_key' => $stripeseckey,
                'stripe_version' => '2020-08-27'
            ]);

            $todayDate = date('Y-m-d H:i:s');
            $platformfeeEmm = $platformfee_ori;
            
            $cleanProfit = $platformfee_ori - $rootFee;
            $cleanProfit = number_format($cleanProfit,2,'.','');

            $rootAccConResult = $this->getcompanysetting($usrInfo['company_root_id'],'rootfee');
            $rootAccCon = "";
            $rootAccConMob = "";
            $rootCommissionSRAcc = "";
            $rootCommissionAEAcc = "";
            
            $rootCommissionFee = ($usrInfo['leadspeek_type'] == 'enhance' || $usrInfo['leadspeek_type'] == 'b2b')?($platformfee_ori * 0.05):($rootFee * 0.05);
            $rootCommissionFee = number_format($rootCommissionFee,2,'.','');
            $rootCommissionSRAccVal = $rootCommissionFee;
            $rootCommissionAEAccVal = $rootCommissionFee;
            /** GET ROOT CONNECTED ACCOUNT TO BE TRANSFER FOR CLEAN PROFIT AFTER CUT BY ROOT FEE COST */

            /** OVERRIDE PLATFORMFEE IF ENHANCE,B2B AND SALES SR AND SALES AE */
            // Log::info(['action' => 'start root_fee_commission','leadspeek_type' => $usrInfo['leadspeek_type'],'rootAccConResult' => $rootAccConResult,'isset($rootAccConResult->rootcomfee)' => isset($rootAccConResult->rootcomfee),'isset($rootAccConResult->rootcomfee1)' => isset($rootAccConResult->rootcomfee1),]);
            if ($rootAccConResult != '') 
            {
                $rootAccCon = (isset($rootAccConResult->rootfeeaccid))?$rootAccConResult->rootfeeaccid:"";
                $rootAccConMob = (isset($rootAccConResult->rootfeeaccidmob))?$rootAccConResult->rootfeeaccidmob:""; 
                $rootCommissionSRAcc = (isset($rootAccConResult->rootcomsr))?$rootAccConResult->rootcomsr:"";
                $rootCommissionAEAcc = (isset($rootAccConResult->rootcomae))?$rootAccConResult->rootcomae:"";
                
                if ($usrInfo['leadspeek_type'] == 'enhance' || $usrInfo['leadspeek_type'] == 'b2b') 
                {
                    if((isset($rootAccConResult->feepercentagemob) && $rootAccConResult->feepercentagemob != "") || (isset($rootAccConResult->feepercentagedom) && $rootAccConResult->feepercentagedom != "")) 
                    {
                        $feePercentageEmm = (isset($rootAccConResult->feepercentageemm))?$rootAccConResult->feepercentageemm:0;
                        $platformfeeEmm = ($platformfeeEmm * $feePercentageEmm) / 100;
                        $platformfeeEmm = number_format($platformfeeEmm,2,'.','');
                        // Log::info(['action' => "override platformfeeEmm when {$usrInfo['leadspeek_type']}",'feePercentageEmm' => "{$feePercentageEmm}%",'platformfeeEmm' => $platformfeeEmm,'platformfee_ori' => $platformfee_ori,]);
                    }
                    if (isset($rootAccConResult->rootcomfee) && $rootAccConResult->rootcomfee != "") 
                    {
                        $rootCommissionSRAcc = $rootAccConResult->rootcomfee;
                        $rootAccConResult->rootcomsrval = $rootAccConResult->rootcomfeeval;
                        // Log::info(['action' => "override rootCommissionSRAcc when {$usrInfo['leadspeek_type']}",'rootCommissionSRAcc' => $rootCommissionSRAcc,'rootAccConResult->rootcomsrval' => $rootAccConResult->rootcomsrval]);
                    }
                    if (isset($rootAccConResult->rootcomfee1) && $rootAccConResult->rootcomfee1 != "") 
                    {
                        $rootCommissionAEAcc = $rootAccConResult->rootcomfee1;
                        $rootAccConResult->rootcomaeval = $rootAccConResult->rootcomfeeval1;
                        // Log::info(['action' => "override rootCommissionAEAcc when {$usrInfo['leadspeek_type']}",'rootCommissionAEAcc' => $rootCommissionAEAcc,'rootAccConResult->rootcomaeval' => $rootAccConResult->rootcomaeval,]);
                    }
                }
                if (isset($rootAccConResult->rootcomsrval) && $rootAccConResult->rootcomsrval != "") 
                {
                    $_rootFee = ($usrInfo['leadspeek_type'] == 'enhance' || $usrInfo['leadspeek_type'] == 'b2b')?$platformfeeEmm:$rootFee;
                    $rootCommissionSRAccVal = ($_rootFee * (float) $rootAccConResult->rootcomsrval);
                    $rootCommissionSRAccVal = number_format($rootCommissionSRAccVal,2,'.','');
                    // Log::info(['action' => 'calculate rootCommissionSRAccVal','_rootFee' => $_rootFee,'platformfeeEmm' => $platformfeeEmm,'rootFee' => $rootFee,'$rootAccConResult->rootcomsrval' => $rootAccConResult->rootcomsrval,'rootCommissionSRAccVal' => $rootCommissionSRAccVal,]);
                }
                if (isset($rootAccConResult->rootcomaeval) && $rootAccConResult->rootcomaeval != "") 
                {
                    $_rootFee = ($usrInfo['leadspeek_type'] == 'enhance' || $usrInfo['leadspeek_type'] == 'b2b')?$platformfeeEmm:$rootFee;
                    $rootCommissionAEAccVal = ($_rootFee * (float) $rootAccConResult->rootcomaeval);
                    $rootCommissionAEAccVal = number_format($rootCommissionAEAccVal,2,'.','');
                    // Log::info(['action' => 'calculate rootCommissionAEAccVal','_rootFee' => $_rootFee,'platformfeeEmm' => $platformfeeEmm,'rootFee' => $rootFee,'$rootAccConResult->rootcomaeval' => $rootAccConResult->rootcomaeval,'rootCommissionAEAccVal' => $rootCommissionAEAccVal,]);
                }
            }
            /** OVERRIDE PLATFORMFEE IF ENHANCE,B2B AND SALES SR AND SALES AE */

            /** TRANSFER FOR ROOT COMMISSION */
            if ($rootAccCon != "") 
            {
                try 
                {
                    if($usrInfo['leadspeek_type'] == 'enhance' || $usrInfo['leadspeek_type'] == 'b2b') 
                    {
                        // if root mobile
                        if(isset($rootAccConResult->feepercentagemob) && $rootAccConResult->feepercentagemob != "") 
                        {
                            // calculation cleanProfit for mobile
                            $feePercentageMob = (isset($rootAccConResult->feepercentagemob))?$rootAccConResult->feepercentagemob:0;
                            $cleanProfitMob = ($platformfee_ori * $feePercentageMob) / 100;
                            $cleanProfitMob = number_format($cleanProfitMob,2,'.','');

                            if($cleanProfitMob >= 0.5)
                            {
                                // Log::info(['action' => "TRANSFER FOR ROOT MOBILE WHEN {$usrInfo['leadspeek_type']}",'rootAccConMob' => $rootAccConMob,'feePercentageMob' => "{$feePercentageMob}%",'cleanProfitMob' => $cleanProfitMob,]);
                                // send cleanProfit to mobile
                                $transferRootProfit = $stripe->transfers->create([
                                    'amount' => ($cleanProfitMob * 100),
                                    'currency' => 'usd',
                                    'destination' => $rootAccConMob,
                                    'description' => 'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',
                                ]);
                            }
                        }
                        if(isset($rootAccConResult->feepercentagedom) && $rootAccConResult->feepercentagedom != "") 
                        {
                            // calculation cleanProfit for dominator
                            $feePercentageDom = (isset($rootAccConResult->feepercentagedom))?$rootAccConResult->feepercentagedom:0;
                            $cleanProfitDom = ($platformfee_ori * $feePercentageDom) / 100;
                            $cleanProfitDom = number_format($cleanProfitDom,2,'.','');

                            if($cleanProfitDom >= 0.5)
                            {
                                // Log::info(['action' => "TRANSFER FOR ROOT DOMINATOR WHEN {$usrInfo['leadspeek_type']}",'rootAccCon' => $rootAccCon,'feePercentageDom' => "{$feePercentageDom}%",'cleanProfitDom' => $cleanProfitDom,]);
                                // send cleanProfit to dominator
                                $transferRootProfit = $stripe->transfers->create([
                                    'amount' => ($cleanProfitDom * 100),
                                    'currency' => 'usd',
                                    'destination' => $rootAccCon,
                                    'description' => 'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',
                                ]);
                            }
                        }
                    }
                    else if($cleanProfit >= 0.5)
                    {
                        // Log::info(['action' => "TRANSFER FOR ROOT " . (isset($rootAccConResult->feepercentagemob) && $rootAccConResult->feepercentagemob != "" ? "MOBILE" : "DOMINATOR") . " WHEN {$usrInfo['leadspeek_type']}",'amount' => ($cleanProfit * 100),'currency' => 'usd','destination' => $rootAccCon,'description' => 'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',]);
                        $transferRootProfit = $stripe->transfers->create([
                            'amount' => ($cleanProfit * 100),
                            'currency' => 'usd',
                            'destination' => $rootAccCon,
                            'description' => 'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',
                        ]);
                    }
                }
                catch (Exception $e) 
                {
                    $this->send_notif_stripeerror('Profit Root Transfer Error','Profit Root Transfer Error to ' . $rootAccCon ,$usrInfo['company_root_id'],true);
                }
            }
            /** TRANSFER FOR ROOT COMMISSION */

            /** TRANSFER FOR ROOT SALES Representative */
            if ($rootCommissionSRAcc != "" && $rootCommissionSRAccVal >= 0.5) 
            {
                try 
                {
                    // Log::info(['action' => 'TRANSFER FOR ROOT SALES Representative','amount' => ($rootCommissionSRAccVal * 100),'currency' => 'usd','destination' => $rootCommissionSRAcc,'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ' )',]);
                    $transferRootProfitSRAcc = $stripe->transfers->create([
                        'amount' => ($rootCommissionSRAccVal * 100),
                        'currency' => 'usd',
                        'destination' => $rootCommissionSRAcc,
                        'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',
                    ]);
                    //$this->send_email(array($sale['email']),$from,'Commission fee from ' . $sale['company_name'] . ' #' . $_leadspeek_api_id ,$details,$attachement,'emails.salesfee',$companyParentID);
                }
                catch (Exception $e) 
                {
                    $this->send_notif_stripeerror('Commission Root Transfer Error','Profit Root Transfer Error to ' . $rootCommissionSRAcc ,$usrInfo['company_root_id'],true);
                }
            }
            /** TRANSFER FOR ROOT SALES Representative */

            /** TRANSFER FOR ROOT Account Executive */
            if ($rootCommissionAEAcc != "" && $rootCommissionAEAccVal >= 0.5) 
            {
                try 
                {
                    // Log::info(['action' => 'TRANSFER FOR ROOT Account Executive','amount' => ($rootCommissionAEAccVal * 100),'currency' => 'usd','destination' => $rootCommissionAEAcc,'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',]);
                    $transferRootProfitAEAcc = $stripe->transfers->create([
                        'amount' => ($rootCommissionAEAccVal * 100),
                        'currency' => 'usd',
                        'destination' => $rootCommissionAEAcc,
                        'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',
                    ]);
                    //$this->send_email(array($sale['email']),$from,'Commission fee from ' . $sale['company_name'] . ' #' . $_leadspeek_api_id ,$details,$attachement,'emails.salesfee',$companyParentID);
                }
                catch (Exception $e) 
                {
                    $this->send_notif_stripeerror('Commission Root Transfer Error','Profit Root Transfer Error to ' . $rootCommissionAEAcc ,$usrInfo['company_root_id'],true);
                }
            }
            /** TRANSFER FOR ROOT Account Executive */
        }
        /** CHARGE ROOT FEE AGENCY */
    }
    
    private function insertLeadspeekReport($_lp_user_id,$_company_id,$_user_id,$_leadspeek_api_id,$id,$email,$email2,$originalmd5,$ip,$source,$optindate,$clickdate,$referer,$phone,$phone2,$firstname,$lastname,$address1,$address2,$city,$state,$zipcode,$lead_from,$active = 'T',$pricelead = '0',$platform_pricelead = '0',$personID = '',$keyword = '',$customParams = '', $description = '',$rootFeeCost = '0',$topup_id = '0') {
        /** INSERT INTO LEADSPEEK REPORT */
        $leadspeekReport = LeadspeekReport::create([
            'id' => $id,
            'person_id' => $personID,
            'lp_user_id' => $_lp_user_id,
            'company_id' => $_company_id,
            'user_id' => $_user_id,
            'leadspeek_api_id' => $_leadspeek_api_id,
            'email' => $email,
            'email2' => $email2,
            'email_mdfive' => md5($email),
            'email2_mdfive' => md5($email2),
            'original_md5' => $originalmd5,
            'ipaddress' => $ip,
            'source' => $source,
            'optindate' => $optindate,
            'clickdate' => $clickdate,
            'referer' => $referer,
            'phone' => $phone,
            'phone2' => $phone2,
            'firstname' => $firstname,
            'lastname' => $lastname,
            'address1' => $address1,
            'address2' => $address2,
            'city' => $city,
            'state' => $state,
            'zipcode' => $zipcode,
            'price_lead' => $pricelead,
            'platform_price_lead' => $platform_pricelead,
            'root_price_lead' => $rootFeeCost,
            'keyword' => $keyword,
            'custom_params' => $customParams,
            'description' => $description,
            'topup_id' => $topup_id,
            'active' => $active,
            'lead_from' => $lead_from
        ]);
        /** INSERT INTO LEADSPEEK REPORT */

        return $leadspeekReport;
    }

    private function createInvoice($_lp_user_id,$_company_id,$_user_id,$_leadspeek_api_id,$minLeads,$costLeads,$minCostLeads,$clientPaymentTerm,$companyName,$reportSentTo,$adminnotify,$startBillingDate,$endBillingDate,$custStripeID,$custStripeCardID,$custEmail,$usrInfo,$companyParent = '') {
        date_default_timezone_set('America/Chicago');
        $todayDate = date('Y-m-d H:i:s');
        $invoiceNum = date('Ymd') . '-' . $_lp_user_id;
        $exceedLeads = 0;
        $totalAmount = 0;
        $costPriceLeads = 0;
        $platform_costPriceLeads = 0;
        $root_costPriceLeads = 0;
        $rootFee = 0;
        $cleanProfit = 0;
        //$totalLeads = $minLeads + $exceedLeads;
        $rootAccCon = "";
        $ongoingLeads = 0;

        /** FIND IF THERE IS ANY EXCEED LEADS */
        $reportCat = LeadspeekReport::select(DB::raw("COUNT(*) as total"),DB::raw("SUM(price_lead) as costleadprice"),DB::raw("SUM(platform_price_lead) as platform_costleadprice"),DB::raw("SUM(root_price_lead) as root_costleadprice"))
                        ->where('lp_user_id','=',$_lp_user_id)
                        ->where('company_id','=',$_company_id)
                        ->where('user_id','=',$_user_id)
                        ->where('leadspeek_api_id','=',$_leadspeek_api_id)
                        ->where('active','=','T')
                        //->whereBetween(DB::raw('DATE_FORMAT(clickdate,"%Y-%m-%d")'),[$startBillingDate,$endBillingDate])
                        ->where(DB::raw('DATE_FORMAT(clickdate,"%Y%m%d%H%i%s")'),'>=',$startBillingDate)
                        ->where(DB::raw('DATE_FORMAT(clickdate,"%Y%m%d%H%i%s")'),'<=',$endBillingDate)
                        ->first();
        //if(count($reportCat) > 0) {
        if ($reportCat) {
            $ongoingLeads = $reportCat->total;
            $costPriceLeads = $reportCat->costleadprice;
            $platform_costPriceLeads = $reportCat->platform_costleadprice;
            $root_costPriceLeads = $reportCat->root_costleadprice;
        }

        /*if(($ongoingLeads > $minLeads) && $minLeads > 0) {
            $exceedLeads = $ongoingLeads - $minLeads;
        }*/
        /** FIND IF THERE IS ANY EXCEED LEADS */

        //$totalAmount = ($costLeads * $exceedLeads) + $minCostLeads;
        /** IF JUST WILL CHARGE PER LEAD */
        if ($clientPaymentTerm != 'One Time' && ($costLeads != '0' || trim($costLeads) != '')) {
            //$totalAmount =  ($costLeads * $ongoingLeads) + $minCostLeads;
            $totalAmount = $costPriceLeads + $minCostLeads;
        }else if($clientPaymentTerm == 'One Time') {
            $totalAmount = $minCostLeads;
        }
        /** IF JUST WILL CHARGE PER LEAD */

        /** CHARGE WITH STRIPE */
        $paymentintentID = '';
        $errorstripe = '';
        $platform_errorstripe = '';
        $statusPayment = 'pending';
        $cardlast = '';
        $platform_paymentintentID = '';
        $sr_id = 0;
        $ae_id = 0;
        $ar_id = 0;
        $sales_fee = 0;
        $platformfee_charge = false;

        $totalAmount = number_format($totalAmount,2,'.','');
        $minCostLeads = number_format($minCostLeads,2,'.','');
        if ($root_costPriceLeads != "0") {
            $rootFee = number_format($root_costPriceLeads,2,'.','');
        }
        $companyParentName = "";
        $AgencyManualBill = "F";

        /** GET COMPANY PARENT NAME / AGENCY */
        $getParentInfo = Company::select('company_name','manual_bill')->where('id','=',$usrInfo['company_parent'])->first();
        //if(count($getParentInfo) > 0) {
        if ($getParentInfo) {
            $companyParentName = $getParentInfo->company_name;
            $AgencyManualBill = $getParentInfo->manual_bill;
        }
        /** GET COMPANY PARENT NAME / AGENCY */

        /** CHECK IF THIS COMPANY USERDOWNLINE OR CLIENT */
            $accConID = '';
            if ($usrInfo['company_parent'] != '') {
                $accConID = $this->check_connected_account($usrInfo['company_parent'],$usrInfo['company_root_id']);
            }
        /** CHECK IF THIS COMPANY USERDOWNLINE OR CLIENT */

        /** CHECK IF USER DATA STILL ON PLATFORM */
            $validuser = true;
            $user[0]['customer_payment_id'] = (isset($usrInfo['customer_payment_id']))?$usrInfo['customer_payment_id']:'';
            $user[0]['company_id'] = (isset($usrInfo['company_id']))?$usrInfo['company_id']:'';
            $user[0]['id'] = (isset($usrInfo['user_id']))?$usrInfo['user_id']:'';
            $user[0]['company_root_id'] = (isset($usrInfo['company_root_id']))?$usrInfo['company_root_id']:'';

            $chkStripeUser = $this->check_stripe_customer_platform_exist($user,$accConID);
            $chkResultUser = json_decode($chkStripeUser);
            if ($chkResultUser->result == 'success') {
                $validuser = true;
                $custStripeID = $chkResultUser->custStripeID;
                $custStripeCardID = $chkResultUser->CardID;
            }else{
                $validuser = false;
            }
        /** CHECK IF USER DATA STILL ON PLATFORM */

        /** CHECK IF AGENCY MANUAL BILL */
        if ($AgencyManualBill == "T") {
            $validuser = true;
            $custStripeID = "agencyDirectPayment";
            $custStripeCardID = "agencyDirectPayment";
            /** GET STRIPE ACC AND CARD AGENCY */
            $custAgencyStripeID = "";
            $custAgencyStripeCardID = "";

            $chkAgency = User::select('id','customer_payment_id','customer_card_id','email')
                    ->where('company_id','=',$usrInfo['company_parent'])
                    ->where('company_parent','<>',$usrInfo['company_parent'])
                    ->where('user_type','=','userdownline')
                    ->where('isAdmin','=','T')
                    ->where('active','=','T')
                    ->first();
            //if(count($chkAgency) > 0) {
            if ($chkAgency) {
                $custAgencyStripeID = $chkAgency->customer_payment_id;
                $custAgencyStripeCardID = $chkAgency->customer_card_id;
            }
            /** GET STRIPE ACC AND CARD AGENCY */
        }
        /** CHECK IF AGENCY MANUAL BILL */

        $platform_LeadspeekCostperlead = 0;
        $platform_LeadspeekMinCostMonth = 0;
        $platform_LeadspeekPlatformFee = 0;
        $platformfee_ori = 0;
        $platformfee = 0;

        if(trim($custStripeID) != '' && trim($custStripeCardID) != '' && $validuser) {
            /** GET STRIPE KEY */
            $stripeseckey = config('services.stripe.secret');
            $stripepublish = $this->getcompanysetting($usrInfo['company_root_id'],'rootstripe');
            if ($stripepublish != '') {
                $stripeseckey = (isset($stripepublish->secretkey))?$stripepublish->secretkey:"";
            }
            /** GET STRIPE KEY */

            $stripe = new StripeClient([
                'api_key' => $stripeseckey,
                'stripe_version' => '2020-08-27'
            ]);

            /** GET PLATFORM MARGIN */
                $platformMargin = $this->getcompanysetting($usrInfo['company_parent'],'costagency');

                $paymentterm = trim($usrInfo['paymentterm']);
                $paymentterm = str_replace(' ','',$paymentterm);
                if ($platformMargin != '') {
                    if ($usrInfo['leadspeek_type'] == "local") {
                        $platform_LeadspeekCostperlead = (isset($platformMargin->local->$paymentterm->LeadspeekCostperlead))?$platformMargin->local->$paymentterm->LeadspeekCostperlead:0;
                        $platform_LeadspeekMinCostMonth = (isset($platformMargin->local->$paymentterm->LeadspeekMinCostMonth))?$platformMargin->local->$paymentterm->LeadspeekMinCostMonth:0;
                        $platform_LeadspeekPlatformFee = (isset($platformMargin->local->$paymentterm->LeadspeekPlatformFee))?$platformMargin->local->$paymentterm->LeadspeekPlatformFee:0;
                    }else if ($usrInfo['leadspeek_type'] == "locator") {
                        $platform_LeadspeekCostperlead = (isset($platformMargin->locator->$paymentterm->LocatorCostperlead))?$platformMargin->locator->$paymentterm->LocatorCostperlead:0;
                        $platform_LeadspeekMinCostMonth = (isset($platformMargin->locator->$paymentterm->LocatorMinCostMonth))?$platformMargin->locator->$paymentterm->LocatorMinCostMonth:0;
                        $platform_LeadspeekPlatformFee = (isset($platformMargin->locator->$paymentterm->LocatorPlatformFee))?$platformMargin->locator->$paymentterm->LocatorPlatformFee:0;
                    }else if ($usrInfo['leadspeek_type'] == "enhance") {
                        $rootcostagency = []; 
                        if(!isset($platformMargin->enhance)) {
                            $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                        }
    
                        $clientTypeLead = $this->getClientCapType($usrInfo['company_root_id']);
                        if($clientTypeLead['type'] == 'clientcapleadpercentage') {
                            $platform_LeadspeekCostperlead = ($usrInfo['cost_perlead'] * $clientTypeLead['value']) / 100;
                        } else {
                            $platform_LeadspeekCostperlead = (isset($platformMargin->enhance->$paymentterm->EnhanceCostperlead))?$platformMargin->enhance->$paymentterm->EnhanceCostperlead:$rootcostagency->enhance->$paymentterm->EnhanceCostperlead;
                        }
    
                        $platform_LeadspeekMinCostMonth = (isset($platformMargin->enhance->$paymentterm->EnhanceMinCostMonth))?$platformMargin->enhance->$paymentterm->EnhanceMinCostMonth:$rootcostagency->enhance->$paymentterm->EnhanceMinCostMonth;
                        $platform_LeadspeekPlatformFee = (isset($platformMargin->enhance->$paymentterm->EnhancePlatformFee))?$platformMargin->enhance->$paymentterm->EnhancePlatformFee:$rootcostagency->enhance->$paymentterm->EnhancePlatformFee;
                    }else if ($usrInfo['leadspeek_type'] == "enhance") {
                        $rootcostagency = []; 
                        if(!isset($platformMargin->enhance)) {
                            $rootcostagency = $this->getcompanysetting($usrInfo['company_root_id'],'rootcostagency');
                        }
    
                        $clientTypeLead = $this->getClientCapType($usrInfo['company_root_id']);
                        if($clientTypeLead['type'] == 'clientcapleadpercentage') {
                            $platform_LeadspeekCostperlead = ($usrInfo['cost_perlead'] * $clientTypeLead['value']) / 100;
                        } else {
                            $platform_LeadspeekCostperlead = (isset($platformMargin->enhance->$paymentterm->EnhanceCostperlead))?$platformMargin->enhance->$paymentterm->EnhanceCostperlead:$rootcostagency->enhance->$paymentterm->EnhanceCostperlead;
                        }
    
                        $platform_LeadspeekMinCostMonth = (isset($platformMargin->enhance->$paymentterm->EnhanceMinCostMonth))?$platformMargin->enhance->$paymentterm->EnhanceMinCostMonth:$rootcostagency->enhance->$paymentterm->EnhanceMinCostMonth;
                        $platform_LeadspeekPlatformFee = (isset($platformMargin->enhance->$paymentterm->EnhancePlatformFee))?$platformMargin->enhance->$paymentterm->EnhancePlatformFee:$rootcostagency->enhance->$paymentterm->EnhancePlatformFee;
                    }
                }
            /** GET PLATFORM MARGIN */

            if ($clientPaymentTerm != 'One Time' && ($costLeads != '0' || trim($costLeads) != '')) {
                //$platformfee =  ($platform_LeadspeekCostperlead * $ongoingLeads) + $platform_LeadspeekMinCostMonth;
                $platformfee =  $platform_costPriceLeads + $platform_LeadspeekMinCostMonth;
            }else if($clientPaymentTerm == 'One Time') {
                $platformfee = $platform_LeadspeekMinCostMonth;
            }

            $platformfee = number_format($platformfee,2,'.','');
            $platformfee_ori = $platformfee;

            $defaultInvoice = '#' . $invoiceNum . '-' . $companyName . ' #' . $_leadspeek_api_id;

            /** CHECK IF TOTAL AMOUNT IS SMALLER THAN PLATFORM FEE */
            //if (($totalAmount < $platformfee) && $platformfee > 0) {
            // if ($platformfee >= 0.5) {
            //     $agencystripe = $this->check_agency_stripeinfo($usrInfo['company_parent'],$platformfee,$_leadspeek_api_id,'Agency ' . $defaultInvoice);
            //     $agencystriperesult = json_decode($agencystripe);
            //     $platformfee_charge = true;

            //     if ($agencystriperesult->result == 'success') {
            //         $platform_paymentintentID = $agencystriperesult->payment_intentID;
            //         $sr_id = $agencystriperesult->srID;
            //         $ae_id = $agencystriperesult->aeID;
            //         $sales_fee = $agencystriperesult->salesfee;
            //         $platformfee = 0;
            //         $platform_errorstripe = '';
            //     }else{
            //         $platform_paymentintentID = $agencystriperesult->payment_intentID;
            //         $platform_errorstripe .= $agencystriperesult->error;
            //     }
            // }
            /** CHECK IF TOTAL AMOUNT IS SMALLER THAN PLATFORM FEE */

            /** CREATE ONE TIME PAYMENT USING PAYMENT INTENT */
            if ($totalAmount < 0.5 || $totalAmount <= 0) {
                $paymentintentID = '';
                $statusPayment = 'paid';
                $platformfee_charge = false;
            }else{
                if ($AgencyManualBill == 'F') {
                    try {
                        $chargeAmount = $totalAmount * 100;
                        $payment_intent =  $stripe->paymentIntents->create([
                            'payment_method_types' => ['card'],
                            'customer' => trim($custStripeID),
                            'amount' => $chargeAmount,
                            'currency' => 'usd',
                            'receipt_email' => $custEmail,
                            'payment_method' => $custStripeCardID,
                            'confirm' => true,
                            'application_fee_amount' => ($platformfee * 100),
                            'description' => $defaultInvoice,
                        ],['stripe_account' => $accConID]);

                        $paymentintentID = $payment_intent->id;
                        $statusPayment = 'paid';
                        $platformfee_charge = true;

                        /** TRANSFER SALES COMMISSION IF ANY */
                        $_cleanProfit = "";
                        if($rootFee != "0" && $rootFee != "") {
                            $_cleanProfit = $platformfee_ori - $rootFee;
                        }
                        $salesfee = $this->transfer_commission_sales($usrInfo['company_parent'],$platformfee,$_leadspeek_api_id,$startBillingDate,$endBillingDate,$stripeseckey,$ongoingLeads,$_cleanProfit);
                        $salesfeeresult = json_decode($salesfee);
                        $platform_paymentintentID = $salesfeeresult->payment_intentID;
                        $sr_id = $salesfeeresult->srID;
                        $ae_id = $salesfeeresult->aeID;
                        $ar_id = $salesfeeresult->arID;
                        $sales_fee = $salesfeeresult->salesfee;
                        /** TRANSFER SALES COMMISSION IF ANY */
                    }catch (RateLimitException $e) {
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Too many requests made to the API too quickly
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } catch (InvalidRequestException $e) {
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Invalid parameters were supplied to Stripe's API
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } catch (AuthenticationException $e) {
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Authentication with Stripe's API failed
                        // (maybe you changed API keys recently)
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } catch (ApiConnectionException $e) {
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Network communication with Stripe failed
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } catch (ApiErrorException $e) {
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Display a very generic error to the user, and maybe send
                        // yourself an email
                        $errorstripe = $e->getHttpStatus() . '|' . $e->getError()->type . '|' . $e->getError()->code . '|' . $e->getError()->param . '|' . $e->getError()->message;
                    } catch (Exception $e) {
                        $statusPayment = 'failed';
                        $platformfee_charge = false;
                        // Something else happened, completely unrelated to Stripe
                        $errorstripe = 'error not stripe things';
                    }
                }else{
                    $statusPayment = 'paid';
                    $platformfee_charge = false;
                    $errorstripe = "This direct Agency Bill Method";
                }
            }

            $cardinfo = "";
            $cardlast = "";

            if ($AgencyManualBill == "T") {
                $custStripeID = $custAgencyStripeID;
                $custStripeCardID = $custAgencyStripeCardID;

                $cardinfo = $stripe->customers->retrieveSource(trim($custStripeID),trim($custStripeCardID),[]);
                $cardlast = $cardinfo->last4;
            }else{
                $cardinfo = $stripe->customers->retrieveSource(trim($custStripeID),trim($custStripeCardID),[],['stripe_account' => $accConID]);
                $cardlast = $cardinfo->last4;
            }

            /** CHECK IF FAILED CHARGE CLIENT WE STILL CHARGE THE AGENCY */
            //if ($statusPayment == 'failed' && $platformfee_charge == false && $platformfee >= 0.5) {
            if ($platformfee_charge == false && $platformfee >= 0.5) {
                $_cleanProfit = "";
                if($rootFee != "0" && $rootFee != "") {
                    $_cleanProfit = $platformfee_ori - $rootFee;
                }
                $agencystripe = $this->check_agency_stripeinfo($usrInfo['company_parent'],$platformfee,$_leadspeek_api_id,'Agency ' . $defaultInvoice,$startBillingDate,$endBillingDate,$ongoingLeads,$_cleanProfit);
                $agencystriperesult = json_decode($agencystripe);

                if (isset($agencystriperesult->result) && $agencystriperesult->result == 'success') {
                    $platform_paymentintentID = $agencystriperesult->payment_intentID;
                    $sr_id = $agencystriperesult->srID;
                    $ae_id = $agencystriperesult->aeID;
                    $ar_id = $agencystriperesult->arID;
                    $sales_fee = $agencystriperesult->salesfee;
                    $platformfee = 0;
                    $platform_errorstripe = '';
                }else{
                    $platform_paymentintentID = $agencystriperesult->payment_intentID;
                    $platform_errorstripe .= $agencystriperesult->error;
                }
            }
            /** CHECK IF FAILED CHARGE CLIENT WE STILL CHARGE THE AGENCY */

            /** CHARGE ROOT FEE AGENCY */
            if($rootFee != "0" && $rootFee != "") {
                $rootCommissionFee = 0;
                $rootCommissionFee = ($rootFee * 0.05);
                $rootCommissionFee = number_format($rootCommissionFee,2,'.','');

                $cleanProfit = $platformfee_ori - $rootFee;
                //if ($cleanProfit > 0.5) {
                    /** GET ROOT CONNECTED ACCOUNT TO BE TRANSFER FOR CLEAN PROFIT AFTER CUT BY ROOT FEE COST */
                    $rootAccCon = "";
                    $rootCommissionSRAcc = "";
                    $rootCommissionAEAcc = "";
                    $rootCommissionSRAccVal = $rootCommissionFee;
                    $rootCommissionAEAccVal = $rootCommissionFee;

                    $rootAccConResult = $this->getcompanysetting($usrInfo['company_root_id'],'rootfee');
                    if ($rootAccConResult != '') {
                        $rootAccCon = (isset($rootAccConResult->rootfeeaccid))?$rootAccConResult->rootfeeaccid:"";
                        $rootCommissionSRAcc = (isset($rootAccConResult->rootcomsr))?$rootAccConResult->rootcomsr:"";
                        $rootCommissionAEAcc = (isset($rootAccConResult->rootcomae))?$rootAccConResult->rootcomae:"";
                        /** OVERRIDE IF EXIST ANOTHER VALUE NOT 5% from Root FEE */
                        if (isset($rootAccConResult->rootcomsrval) && $rootAccConResult->rootcomsrval != "") {
                            $rootCommissionSRAccVal = ($rootFee * (float) $rootAccConResult->rootcomsrval);
                            $rootCommissionSRAccVal = number_format($rootCommissionSRAccVal,2,'.','');
                        }
                        if (isset($rootAccConResult->rootcomaeval) && $rootAccConResult->rootcomaeval != "") {
                            $rootCommissionAEAccVal = ($rootFee * (float) $rootAccConResult->rootcomaeval);
                            $rootCommissionAEAccVal = number_format($rootCommissionAEAccVal,2,'.','');
                        }
                        /** OVERRIDE IF EXIST ANOTHER VALUE NOT 5% from Root FEE */
                    }
                    /** GET ROOT CONNECTED ACCOUNT TO BE TRANSFER FOR CLEAN PROFIT AFTER CUT BY ROOT FEE COST */
                    if ($rootAccCon != "" && $cleanProfit > 0.5) {

                        $cleanProfit = number_format($cleanProfit,2,'.','');

                        $stripe = new StripeClient([
                            'api_key' => $stripeseckey,
                            'stripe_version' => '2020-08-27'
                        ]);

                        try {
                            $transferRootProfit = $stripe->transfers->create([
                                'amount' => ($cleanProfit * 100),
                                'currency' => 'usd',
                                'destination' => $rootAccCon,
                                'description' => 'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',
                            ]);

                            // if (isset($transferSales->destination_payment)) {
                            //     $despay = $transferSales->destination_payment;

                            //     $transferSalesDesc =  $stripe->charges->update($despay,
                            //             [
                            //                 'description' => 'Profit Root App from Agency Invoice'
                            //             ],['stripe_account' => $rootAccCon]);
                            // }

                            //$this->send_email(array($sale['email']),$from,'Commission fee from ' . $sale['company_name'] . ' #' . $_leadspeek_api_id ,$details,$attachement,'emails.salesfee',$companyParentID);
                        }catch (Exception $e) {
                            $this->send_notif_stripeerror('Profit Root Transfer Error','Profit Root Transfer Error to ' . $rootAccCon ,$usrInfo['company_root_id'],true);
                        }

                    }

                    /** TRANSFER FOR ROOT SALES Representative */
                    if ($rootCommissionSRAcc != "" && $rootCommissionSRAcc > 0.5) {
                        $stripe = new StripeClient([
                            'api_key' => $stripeseckey,
                            'stripe_version' => '2020-08-27'
                        ]);

                        try {
                            $transferRootProfitSRAcc = $stripe->transfers->create([
                                'amount' => ($rootCommissionSRAccVal * 100),
                                'currency' => 'usd',
                                'destination' => $rootCommissionSRAcc,
                                'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ' Ended Campaign)',
                            ]);


                            //$this->send_email(array($sale['email']),$from,'Commission fee from ' . $sale['company_name'] . ' #' . $_leadspeek_api_id ,$details,$attachement,'emails.salesfee',$companyParentID);
                        }catch (Exception $e) {
                            $this->send_notif_stripeerror('Commission Root Transfer Error','Profit Root Transfer Error to ' . $rootCommissionSRAcc ,$usrInfo['company_root_id'],true);
                        }
                    }
                    /** TRANSFER FOR ROOT SALES Representative */

                    /** TRANSFER FOR ROOT Account Executive */
                    if ($rootCommissionAEAcc != "" && $rootCommissionAEAccVal > 0.5) {
                        $stripe = new StripeClient([
                            'api_key' => $stripeseckey,
                            'stripe_version' => '2020-08-27'
                        ]);

                        try {
                            $transferRootProfitAEAcc = $stripe->transfers->create([
                                'amount' => ($rootCommissionAEAccVal * 100),
                                'currency' => 'usd',
                                'destination' => $rootCommissionAEAcc,
                                'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ' Ended Campaign)',
                            ]);


                            //$this->send_email(array($sale['email']),$from,'Commission fee from ' . $sale['company_name'] . ' #' . $_leadspeek_api_id ,$details,$attachement,'emails.salesfee',$companyParentID);
                        }catch (Exception $e) {
                            $this->send_notif_stripeerror('Commission Root Transfer Error','Profit Root Transfer Error to ' . $rootCommissionAEAcc ,$usrInfo['company_root_id'],true);
                        }
                    }
                   /** TRANSFER FOR ROOT Account Executive */

                //}
            }
            /** CHARGE ROOT FEE AGENCY */

        }
        /** CHARGE WITH STRIPE */

        if (trim($sr_id) == "") {
            $sr_id = 0;
        }
        if (trim($ae_id) == "") {
            $ae_id = 0;
        }

        if (trim($ar_id) == "") {
            $ar_id = 0;
        }

        $statusClientPayment = $statusPayment;
        
        $invoiceCreated = LeadspeekInvoice::create([
            'company_id' => $_company_id,
            'user_id' => $_user_id,
            'leadspeek_api_id' => $_leadspeek_api_id,
            'invoice_number' => '',
            'payment_term' => $clientPaymentTerm,
            'onetimefee' => 0,
            'platform_onetimefee' => $platform_LeadspeekPlatformFee,
            'min_leads' => $minLeads,
            'exceed_leads' => $exceedLeads,
            'total_leads' => $ongoingLeads,
            'min_cost' => $minCostLeads,
            'platform_min_cost' => $platform_LeadspeekMinCostMonth,
            'cost_leads' => $costLeads,
            'platform_cost_leads' => $platform_LeadspeekCostperlead,
            'total_amount' => $totalAmount,
            'platform_total_amount' => $platformfee_ori,
            'root_total_amount' => $rootFee,
            'status' => $statusPayment,
            'customer_payment_id' => $paymentintentID,
            'customer_stripe_id' => $custStripeID,
            'customer_card_id' => $custStripeCardID,
            'platform_customer_payment_id' => $platform_paymentintentID,
            'error_payment' => $errorstripe,
            'platform_error_payment' => $platform_errorstripe,
            'invoice_date' => $todayDate,
            'invoice_start' => date('Y-m-d H:i:s',strtotime($startBillingDate)),
            'invoice_end' => date('Y-m-d H:i:s',strtotime($endBillingDate)),
            'sent_to' => json_encode($reportSentTo),
            'sr_id' => $sr_id,
            'sr_fee' => $sales_fee,
            'ae_id' => $ae_id,
            'ae_fee' => $sales_fee,
            'ar_id' => $ar_id,
            'ae_fee' => $sales_fee,
            'active' => 'T',
        ]);
        $invoiceID = $invoiceCreated->id;

        $invoice = LeadspeekInvoice::find($invoiceID);
        $invoice->invoice_number = $invoiceNum . '-' . $invoiceID;
        $invoice->save();

        $lpupdate = LeadspeekUser::find($_lp_user_id);
        $lpupdate->ongoing_leads = 0;
        //$lpupdate->start_billing_date = $todayDate;
        $lpupdate->start_billing_date = date('Y-m-d H:i:s',strtotime($endBillingDate));
        $lpupdate->lifetime_cost = ($lpupdate->lifetime_cost + $totalAmount);
        $lpupdate->save();

        /** FIND ADMIN EMAIL */
        $tmp = User::select('email')->whereIn('id', $adminnotify)->get();
        $adminEmail = array();
        foreach($tmp as $ad) {
            array_push($adminEmail,$ad['email']);
        }
        //array_push($adminEmail,'serverlogs@sitesettingsapi.com');
        /** FIND ADMIN EMAIL */

        if ($statusPayment == 'paid') {
            $statusPayment = "Customer's Credit Card Successfully Charged ";
        }else if ($statusPayment == 'failed') {
            $statusPayment = "Customer's Credit Card Failed";
        }else{
            $statusPayment = "Customer's Credit Card Successfully Charged ";
        }

        if ($totalAmount == '0.00' || $totalAmount == '0') {
            $statusPayment = "Customer's Credit Card Successfully Charged";
        }

        if ($platformfee_ori != '0.00' || $platformfee_ori != '0') {
            if ($statusClientPayment == 'failed') {
                $statusPayment .= " and Agency's Card Charged For Overage";
            }
        }

        if ($AgencyManualBill == "T") {
            $statusPayment = "You must directly bill your client the amount due.";
        }

        $platform_LeadspeekCostperlead = number_format($platform_LeadspeekCostperlead,2,'.','');

        $agencyNet = "";
        if ($totalAmount > $platformfee_ori) {
            $agencyNet = $totalAmount - $platformfee_ori;
            $agencyNet = number_format($agencyNet,2,'.','');
        }

        $AdminDefault = $this->get_default_admin($usrInfo['company_root_id']);
        $AdminDefaultEmail = (isset($AdminDefault[0]['email']))?$AdminDefault[0]['email']:'';
        $rootCompanyInfo = $this->getCompanyRootInfo($usrInfo['company_root_id']);
        $defaultdomain = $this->getDefaultDomainEmail($usrInfo['company_root_id']);

        $details = [
            'name'  => $companyName,
            'invoiceNumber' => $invoiceNum . '-' . $invoiceID,
            'min_leads' => $minLeads,
            'exceed_leads' => $exceedLeads,
            'total_leads' => $ongoingLeads,
            'min_cost' => $minCostLeads,
            'platform_min_cost' => $platform_LeadspeekMinCostMonth,
            'cost_leads' => $costLeads,
            'platform_cost_leads' => $platform_LeadspeekCostperlead,
            'total_amount' => $totalAmount,
            'platform_total_amount' => $platformfee_ori,
            'invoiceDate' => date('m-d-Y',strtotime($todayDate)),
            'startBillingDate' => date('m-d-Y H:i:s',strtotime($startBillingDate)),
            'endBillingDate' =>  date('m-d-Y H:i:s',strtotime($endBillingDate)),
            'invoiceStatus' => $statusPayment,
            'cardlast' => trim($cardlast),
            'leadspeekapiid' => $_leadspeek_api_id,
            'paymentterm' => $clientPaymentTerm,
            'invoicetype' => 'agency',
            'agencyname' => $rootCompanyInfo['company_name'],
            'defaultadmin' => $AdminDefaultEmail,
            'agencyNet' => $agencyNet,
            'rootFee' => $rootFee,
            'cleanProfit' => $cleanProfit,
        ];
        $attachement = array();

        $from = [
            'address' => 'noreply@' . $defaultdomain,
            'name' => 'Invoice',
            'replyto' => 'support@' . $defaultdomain,
        ];

        $subjectFailed = "";
        if ($statusClientPayment == 'failed') {
            $subjectFailed = "Failed Payment - ";
        }
        //if (($platformfee_ori != '0.00' || $platformfee_ori != '0') || ($totalAmount != '0.00' || $totalAmount != '0') ) {
            $this->send_email($adminEmail,$subjectFailed . 'Invoice for ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',$details,$attachement,'emails.tryseramatchlistinvoice',$from,$companyParent,true);
            $this->send_email(array('serverlogs@sitesettingsapi.com'),$subjectFailed . 'Invoice for ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',$details,$attachement,'emails.tryseramatchlistinvoice',$from,'',true);
        //}

        /** UPDATE DESC PROFIT ROOT */
        if (isset($transferRootProfit->destination_payment)) {
            $despay = $transferRootProfit->destination_payment;
            try {
                $transferSalesDesc =  $stripe->charges->update($despay,
                        [
                            'description' => 'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')'
                        ],['stripe_account' => $rootAccCon]);
            }catch (Exception $e) {
                Log::warning('ERROR : Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ') - ' . $despay);
            }
        }

        /** UPDATE DESC SA COMMISSION */
        if (isset($transferRootProfitSRAcc->destination_payment)) {
            $despay = $transferRootProfitSRAcc->destination_payment;
            try {
                $transferSalesDesc =  $stripe->charges->update($despay,
                        [
                            'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ' Ended Campaign)'
                        ],['stripe_account' => $rootCommissionSRAcc]);
            }catch (Exception $e) {
                Log::warning('Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ') - SA -' . $despay);
            }
        }

        /** UPDATE DESC AE COMMISSION */
        if (isset($transferRootProfitAEAcc->destination_payment)) {
            $despay = $transferRootProfitAEAcc->destination_payment;
            try {
                $transferSalesDesc =  $stripe->charges->update($despay,
                        [
                            'description' => 'Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ' Ended Campaign)'
                        ],['stripe_account' => $rootCommissionAEAcc]);
            }catch (Exception $e) {
                Log::warning('Commision Root app from  Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ') - AE -' . $despay);
            }
        }

        /** GET ROOT ADMIN */
        // if ($rootAccCon != "") {
        //     $rootAdmin = User::select('email')
        //                             ->where('company_id','=',$usrInfo['company_root_id'])
        //                             ->where('isAdmin','=','T')
        //                                 ->where(function ($query) {
        //                                     $query->where('user_type','=','userdownline')
        //                                     ->orWhere('user_type','=','user');
        //                                 })->get();
        //     /** GET ROOT ADMIN */
        //     foreach($rootAdmin as $radm) {
        //         $this->send_email(array($radm['email']),'Profit Root App from Invoice ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')' ,$details,$attachement,'emails.rootProfitTransfer',$from,$usrInfo[0]->company_parent);
        //     }
        // }
        /** UPDATE ROOT FEE PAYMENT */

        $agencyCompanyID = $usrInfo['company_parent'];

        if (trim($companyParent) != "") {
            $agencyCompanyID = trim($companyParent);
        }

        $AdminDefault = $this->get_default_admin($agencyCompanyID);
        $AdminDefaultEmail = (isset($AdminDefault[0]['email']))?$AdminDefault[0]['email']:'noreply@sitesettingsapi.com';

        $agencycompany = Company::select('company_name','domain','subdomain','status_domain')
                                        ->where('id','=',$agencyCompanyID)
                                        ->first();
        $agencyname = "";

        //if (count($agencycompany) > 0) {
        if ($agencycompany) {
            $agencyname = $agencycompany->company_name;
        }

        $details['invoicetype'] = 'client';
        $details['agencyname'] = $agencyname;
        $details['defaultadmin'] = $AdminDefaultEmail;
        $details['invoiceStatus'] = str_replace("and Agency's Card Charged For Overage","",$details['invoiceStatus']);

        $from = [
            'address' => $AdminDefaultEmail,
            'name' => 'Invoice',
            'replyto' => $AdminDefaultEmail,
        ];

        $this->send_email(array($custEmail),'Invoice for ' . $companyName . ' #' . $_leadspeek_api_id . ' (' . date('m-d-Y',strtotime($todayDate)) . ')',$details,$attachement,'emails.tryseramatchlistinvoice',$from,$companyParent,true);
        /** SENT FOR CLIENT INVOICE */

         /** UPDATE CLIENT STRIPE PAYMENT DESCRIPTION */
         if ($paymentintentID != "") {
            $updatePaymentClientDesc =  $stripe->paymentIntents->update($paymentintentID,
                [
                    'description' => '#' . $invoiceNum . '-' . $invoiceID . ' ' . $companyParentName . '-' . $companyName . ' #' . $_leadspeek_api_id,
                ],['stripe_account' => $accConID]);
            /** UPDATE CLIENT STRIPE PAYMENT DESCRIPTION */
        }
        if ($platform_paymentintentID != "") {
            /** UPDATE AGENCY STRIPE PAYMENT DESCRIPTION */
            $updatePaymentClientDesc =  $stripe->paymentIntents->update($platform_paymentintentID,
                [
                    'description' => 'Agency #' . $invoiceNum . '-' . $invoiceID . ' ' . $companyParentName . '-' . $companyName . ' #' . $_leadspeek_api_id,
                ]);
            /** UPDATE AGENCY STRIPE PAYMENT DESCRIPTION */
        }

        /** UPDATE DESCRIPTION OF PAYMENT ON STRIPE */

    }

    /** SIMPLI.FI API */
    public function getStatefromCity($loccitysifi,$_state) {
        $http = new \GuzzleHttp\Client;

        $appkey = "86bb19a0-43e6-0139-8548-06b4c2516bae";
        $usrkey = "63c52610-87cd-0139-b15f-06a60fe5fe77";

                try {
                    $apiURL = "https://app.simpli.fi/api/geo_targets/" . $loccitysifi;
                    $options = [
                        'headers' => [
                            'X-App-Key' => $appkey,
                            'X-User-Key' => $usrkey,
                            'Content-Type' => 'application/json',
                        ],
                    ];

                    $response = $http->get($apiURL,$options);
                    $cityresult =  json_decode($response->getBody());

                    $tmpStateID = "";
                    for($i=0;$i<count($cityresult->geo_targets);$i++) {
                        $tmpStateID = $cityresult->geo_targets[$i]->parent_id;
                    }

                    $apiURL = "https://app.simpli.fi/api/geo_targets/" . $tmpStateID;

                    $response = $http->get($apiURL,$options);
                    $stateresult =  json_decode($response->getBody());

                    for($i=0;$i<count($stateresult->geo_targets);$i++) {
                        $statelist = State::select('state','state_code','sifi_state_id')
                                    ->where('sifi_state_id','=',$stateresult->geo_targets[$i]->id)
                                    ->orderBy('state')
                                    ->first();
                        //if (count($statelist) > 0) {
                        if ($statelist) {
                            if (strtolower(trim($_state)) ==  strtolower(trim($statelist->state_code))) {
                                return true;
                            }else{
                                return false;
                            }
                        }else{
                            return false;
                        }
                    }

                }catch (\GuzzleHttp\Exception\BadResponseException $e) {
                    return false;
                }
    }

    public function startPause_campaign($_organizationID,$_campaignsID,$status='') {
        $http = new \GuzzleHttp\Client;

        $appkey = "86bb19a0-43e6-0139-8548-06b4c2516bae";
        $usrkey = "63c52610-87cd-0139-b15f-06a60fe5fe77";
        $organizationID = $_organizationID;
        $campaignsID = explode(PHP_EOL, $_campaignsID);

        $ProcessStatus = true;

        for($i=0;$i<count($campaignsID);$i++) {


            try {
                /** CHECK ACTIONS IF CAMPAIGN ALLOW TO RUN STATUS  */
                $apiURL = "https://app.simpli.fi/api/organizations/" . $organizationID . "/campaigns/" . $campaignsID[$i];
                $options = [
                    'headers' => [
                        'X-App-Key' => $appkey,
                        'X-User-Key' => $usrkey,
                        'Content-Type' => 'application/json',
                    ],
                ];

                $response = $http->get($apiURL,$options);
                $result =  json_decode($response->getBody());

                for($j=0;$j<count($result->campaigns[0]->actions);$j++) {
                    if ($status == 'activate') {
                        if(isset($result->campaigns[0]->actions[$j]->activate)) {
                            //echo "activate";
                            try {
                                /** ACTIVATE THE CAMPAIGN */
                                $ActionApiURL = "https://app.simpli.fi/api/organizations/" . $organizationID . "/campaigns/" . $campaignsID[$i] . "/activate";
                                $ActionResponse = $http->post($ActionApiURL,$options);
                                /** ACTIVATE THE CAMPAIGN */
                            }catch (\GuzzleHttp\Exception\BadResponseException $e) {
                                $details = [
                                    'errormsg'  => 'Error when trying to Activate Campaign Organization ID : ' . $organizationID . ' Campaign ID :' . $campaignsID[$i] . ' (' . $e->getCode() . ')',
                                ];

                                $from = [
                                    'address' => 'newleads@leadspeek.com',
                                    'name' => 'support',
                                    'replyto' => 'serverlogs@sitesettingsapi.com',
                                ];
                                $ProcessStatus = false;
                                $this->send_email(array('serverlogs@sitesettingsapi.com'),'Error Log for Activate Campaign ' . $e->getCode(),$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                            }
                        }
                    }else if ($status == 'pause') {
                        if(isset($result->campaigns[0]->actions[$j]->pause)) {
                            //echo "Pause";
                            try {
                                /** PAUSE THE CAMPAIGN */
                                $ActionApiURL = "https://app.simpli.fi/api/organizations/" . $organizationID . "/campaigns/" . $campaignsID[$i] . "/pause";
                                $ActionResponse = $http->post($ActionApiURL,$options);
                                /** PAUSE THE CAMPAIGN */
                            }catch (\GuzzleHttp\Exception\BadResponseException $e) {
                                $details = [
                                    'errormsg'  => 'Error when trying to Pause Campaign Organization ID : ' . $organizationID . ' Campaign ID :' . $campaignsID[$i] . ' (' . $e->getCode() . ')',
                                ];

                                $from = [
                                    'address' => 'newleads@leadspeek.com',
                                    'name' => 'support',
                                    'replyto' => 'serverlogs@sitesettingsapi.com',
                                ];
                                $ProcessStatus = false;
                                $this->send_email(array('serverlogs@sitesettingsapi.com'),'Error Log for Pause Campaign ' . $e->getCode(),$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                            }
                        }
                    }else if ($status == 'stop') {
                        if(isset($result->campaigns[0]->actions[$j]->end)) {
                            //echo "Pause";
                            try {
                                /** PAUSE THE CAMPAIGN */
                                $ActionApiURL = "https://app.simpli.fi/api/organizations/" . $organizationID . "/campaigns/" . $campaignsID[$i] . "/end";
                                $ActionResponse = $http->post($ActionApiURL,$options);
                                /** PAUSE THE CAMPAIGN */
                            }catch (\GuzzleHttp\Exception\BadResponseException $e) {
                                $details = [
                                    'errormsg'  => 'Error when trying to Pause Campaign Organization ID : ' . $organizationID . ' Campaign ID :' . $campaignsID[$i] . ' (' . $e->getCode() . ')',
                                ];
                                $from = [
                                    'address' => 'newleads@leadspeek.com',
                                    'name' => 'support',
                                    'replyto' => 'serverlogs@sitesettingsapi.com',
                                ];
                                $ProcessStatus = false;
                                $this->send_email(array('serverlogs@sitesettingsapi.com'),'Error Log for Pause Campaign ' . $e->getCode(),$details,array(),'emails.tryseramatcherrorlog',$from,'',true);
                            }
                        }
                    }
                    //echo $result->campaigns[0]->actions[$j]->activate[0];
                }

                //return response()->json(array("result"=>'success','message'=>'xx','param'=>$result));
                /** CHECK ACTIONS IF CAMPAIGN ALLOW TO RUN STATUS  */
            }catch (\GuzzleHttp\Exception\BadResponseException $e) {
                $ProcessStatus = false;

                $details = [
                    'errormsg'  => 'Error when trying to get campaign information Organization ID : ' . $organizationID . ' Campaign ID :' . $campaignsID[$i] . '(' . $e->getCode() . ')',
                ];
                $from = [
                    'address' => 'newleads@leadspeek.com',
                    'name' => 'support',
                    'replyto' => 'serverlogs@sitesettingsapi.com',
                ];

                $this->send_email(array('serverlogs@sitesettingsapi.com'),'Error Log for Start / Pause Get Campaign ' . $e->getCode(),$details,array(),'emails.tryseramatcherrorlog',$from,'',true);

                // if ($e->getCode() === 400) {
                //     return response()->json(array("result"=>'failed','message'=>'Invalid Request. Please enter a username or a password.'), $e->getCode());
                // } else if ($e->getCode() === 401) {
                //     return response()->json(array("result"=>'failed','message'=>'Your credentials are incorrect. Please try again'), $e->getCode());
                // }

                // return response()->json(array("result"=>'failed','message'=>'Something went wrong on the server.'), $e->getCode());
            }

        }

        return $ProcessStatus;

    }
    /** SIMPLI.FI API */

    private function notificationStartStopLeads($adminnotify,$status,$name,$leadslimit,$leadstype,$leadstotal,$companyID = '',$isQueue = false) {
        /** FIND ADMIN EMAIL */
        $tmp = User::select('email')->whereIn('id', $adminnotify)->get();
        $adminEmail = array();
        foreach($tmp as $ad) {
            array_push($adminEmail,$ad['email']);
        }
        //array_push($adminEmail,'serverlogs@sitesettingsapi.com');
        /** FIND ADMIN EMAIL */

        $AdminDefault = $this->get_default_admin($companyID);
        $AdminDefaultEmail = (isset($AdminDefault[0]['email']))?$AdminDefault[0]['email']:'noreply@sitesettingsapi.com';

        $details = [
            'status'  => $status,
            'name' => $name,
            'leadslimit' => $leadslimit,
            'leadstype' => $leadstype,
            'leadstotal' => $leadstotal,
        ];
        $attachement = array();

        $from = [
            'address' => $AdminDefaultEmail,
            'name' => 'campaign status',
            'replyto' => $AdminDefaultEmail,
        ];

        $this->send_email($adminEmail,'User Notification for ' . $name . ' (' . $status . ')',$details,$attachement,'emails.tryserastartstop',$from,$companyID,$isQueue);
        $this->send_email(array('serverlogs@sitesettingsapi.com'),'User Notification for ' . $name . ' (' . $status . ')',$details,$attachement,'emails.tryserastartstop',$from,'',$isQueue);
    }

    private function getDataMatch($md5param,$leadspeek_api_id,$data,$keyword = '',$loctarget = 'Focus',$loczip = "",$locstate = "",$locstateexclude = "",$locstatesifi = "",$loccity = "",$loccitysifi = "",$nationaltargeting = "F",$leadspeektype="local",$compleadID = "",$clientCompanyID = "",$clientCompanyRootId = "") {
        $executionTimeList = [];
        
        date_default_timezone_set('America/Chicago');

        // /* LOCK PROCESS GETDATAMATCH */
        // Log::info('START GETDATAMATCH PROCESS #' . $leadspeek_api_id);
        // $initLock = 'initGetDataMatch' . $leadspeek_api_id;
        // while(!$this->acquireLock($initLock)) {
        //     Log::info("Initial Get Data Match Processing. Waiting to acquire lock. CAMPAIGN ID #" . $leadspeek_api_id);
        //     sleep(1); // Wait before trying again
        // }
        // /* LOCK PROCESS GETDATAMATCH */

        try {
            $reidentification = "";
            $matches = array();
            $salt = substr(hash('sha256', env('APP_KEY')), 0, 16);
            $dataflow = "";

            /** RECORD ANY INCOMING MD5 PARAM THAT WE GET FROM TOWERDATA WEBHOOK FIRED */
            $fr = FailedRecord::create([
                'email_encrypt' => $md5param,
                'leadspeek_api_id' => $leadspeek_api_id,
                'description' => 'md5email fired|' . $keyword,
            ]);
            $failedRecordID = $fr->id;
            /** RECORD ANY INCOMING MD5 PARAM THAT WE GET FROM TOWERDATA WEBHOOK FIRED */

            /** FILTER IF THERE IS KEYWORD TV AND PUT IT ON OPTOUT LIST */
            $blockedkeyword = array("tv");
            $word = strtolower(trim($keyword));

            if (in_array($word,$blockedkeyword)) {
                $createoptout = OptoutList::create([
                    'email' => '',
                    'emailmd5' => $md5param,
                    'blockedcategory' => 'keyword',
                    'description' => 'blocked because keyword : ' . $word,
                ]);
            }
            /** FILTER IF THERE IS KEYWORD TV AND PUT IT ON OPTOUT LIST */

            /** FILTER IF SIMPLIFI GIVE NOT FIT KEYWORD */
            if ($word != "") {
                if (str_contains($word, '_audience')) {
                    $keyword = "";
                }
            }
            /** FILTER IF SIMPLIFI GIVE NOT FIT KEYWORD */

            /** CHECK AGAINST EMM OPT OUT LIST */
            $notAgainstOptout = true;

            Log::info("Start Check OptOut 1 CampaignID : #" . $leadspeek_api_id);

            //$optoutlist = OptoutList::select('emailmd5')
            // $optoutlist = OptoutList::where('emailmd5','=',$md5param)
            //                         ->where('company_root_id','=',$clientCompanyRootId)
            //                         //->get();
            //                         ->exists();
            $_cacheKey = "opt1_" . $md5param . '_' . $clientCompanyRootId;
            $optoutlist = $this->cacheGetResult($_cacheKey);
            if(is_null($optoutlist)) {
                $optoutlist = OptoutList::where('emailmd5','=',$md5param)
                                        ->where('company_root_id','=',$clientCompanyRootId)
                                        ->exists();
                if($optoutlist) {
                    $optoutlist = $this->cacheQueryResult($_cacheKey,86400,function () use ($optoutlist) {
                        return $optoutlist;
                    });
                } else {
                    if($this->cacheHasResult($_cacheKey)) {
                        $this->cacheForget($_cacheKey);
                    }
                }
            }

            //if (count($optoutlist) > 0) {
            if ($optoutlist) {
                $notAgainstOptout = false;
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    $frupdate = FailedRecord::find($failedRecordID);
                    $frupdate->description = $frupdate->description . '|AgainstEMMOptList';
                    $frupdate->save();
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK OptOut 1 CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                Log::info("Failed Serve Check OptOut 1 CampaignID : #" . $leadspeek_api_id);

                /* WRITE UPSER FAILED LEAD RECORD */
                $this->UpsertFailedLeadRecord([
                    'function' => 'getDataMatch',
                    'type' => 'blocked',
                    'blocked_type' => 'optoutlist',
                    'description' => 'blocked in table optoutlist',
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'email_encrypt' => $md5param,
                    'leadspeek_type' => $leadspeektype,
                ]);
                /* WRITE UPSER FAILED LEAD RECORD */
                
                return array();
                exit;die();
            }
            /** CHECK AGAINST EMM OPT OUT LIST */

            /** CHECK AGAINST CAMPAIGN OR ACCOUNT SUPPRESSION LIST */
            if ($notAgainstOptout) {
                $notOnSuppressionList = true;

                Log::info("Start Check SupressionList 1 CampaignID : #" . $leadspeek_api_id);

                $_cacheKey = 'suplist_' . $md5param . '_' . $compleadID . '_' . $clientCompanyID . '_' . $leadspeek_api_id; 
                $supressionListExists = $this->cacheGetResult($_cacheKey);
                if(is_null($supressionListExists)) {
                    $supressionListExists = SuppressionList::select('suppression_type') 
                                                        ->where(function ($query) use ($md5param, $compleadID) {
                                                            $query->where('emailmd5', $md5param)
                                                                  ->where('company_id', $compleadID)
                                                                  ->where('suppression_type', 'account');
                                                        })
                                                        ->orWhere(function ($query) use ($md5param, $clientCompanyID) {
                                                            $query->where('emailmd5', $md5param)
                                                                  ->where('company_id', $clientCompanyID)
                                                                  ->where('suppression_type', 'client');
                                                        })
                                                        ->orWhere(function ($query) use ($md5param, $compleadID) {
                                                            $query->where('emailmd5', $md5param)
                                                                  ->where('company_id', $compleadID)
                                                                  ->where('suppression_type', 'agency');
                                                        })
                                                        ->orWhere(function ($query) use ($md5param, $leadspeek_api_id) {
                                                            $query->where('emailmd5', $md5param)
                                                                  ->where('leadspeek_api_id', $leadspeek_api_id)
                                                                  ->where('suppression_type', 'campaign');
                                                        })
                                                        ->first();
                    if(!empty($supressionListExists)) {
                        $supressionListExists = $this->cacheQueryResult($_cacheKey,86400,function() use($supressionListExists) {
                            return $supressionListExists;
                        });
                    } else {
                        if($this->cacheHasResult($_cacheKey)) {
                            $this->cacheForget($_cacheKey);
                        }
                    }
                }

                if(!empty($supressionListExists)) {
                    $supressionType = isset($supressionListExists->suppression_type)?$supressionListExists->suppression_type:'';
                    $notOnSuppressionList = false;

                    /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    $frupdate = FailedRecord::find($failedRecordID);
                    $frupdate->description = $frupdate->description . '|AgainstSupressionList';
                    $frupdate->save();
                    /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                    // Log::info("RELEASE GETDATAMATCH LOCK SupressionList 1 CampaignID #" . $leadspeek_api_id);
                    // $this->releaseLock($initLock);
                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                    Log::info("Failed Serve SupressionList CampaignID : #" . $leadspeek_api_id);

                    /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'getDataMatch',
                        'type' => 'blocked',
                        'blocked_type' => 'supressionlist',
                        'description' => 'blocked in table supression_lists where supression_type ' . $supressionType,
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                    /* WRITE UPSER FAILED LEAD RECORD */

                    return array();
                    exit;die();
                }

                /** CHECK ACCOUNT / AGENCY LEVEL */
                //$suppressionlistAccount = SuppressionList::select('emailmd5')
                // $suppressionlistAccount = SuppressionList::where('emailmd5','=',$md5param)
                //                             ->where('company_id','=',$compleadID)
                //                             ->where('suppression_type','=','account')
                //                             //->get();
                //                             ->exists();

                // $_cacheKey = "suplist1_" . $md5param . '_' . $compleadID;
                // $suppressionlistAccount = $this->cacheGetResult($_cacheKey);
                // if(is_null($suppressionlistAccount)) {
                //     $suppressionlistAccount = SuppressionList::where('emailmd5','=',$md5param)
                //                                              ->where('company_id','=',$compleadID)
                //                                              ->where('suppression_type','=','account')
                //                                              ->exists();
                //     if($suppressionlistAccount) {
                //         $suppressionlistAccount = $this->cacheQueryResult($_cacheKey,86400,function () use ($suppressionlistAccount) {
                //             return $suppressionlistAccount;
                //         });
                //     } else {
                //         if($this->cacheHasResult($_cacheKey)) {
                //             $this->cacheForget($_cacheKey);
                //         }
                //     }
                // } 
                
                // //if (count($suppressionlistAccount) > 0) {
                // if ($suppressionlistAccount) {
                //     $notOnSuppressionList = false;
                //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                //         $frupdate = FailedRecord::find($failedRecordID);
                //         $frupdate->description = $frupdate->description . '|AgainstAccountOptList';
                //         $frupdate->save();
                //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                //     // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                //     // Log::info("RELEASE GETDATAMATCH LOCK SupressionList 1 CampaignID #" . $leadspeek_api_id);
                //     // $this->releaseLock($initLock);
                //     // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                //     Log::info("Failed Serve SupressionList 1 CampaignID : #" . $leadspeek_api_id);

                //     /* WRITE UPSER FAILED LEAD RECORD */
                //     $this->UpsertFailedLeadRecord([
                //         'function' => 'getDataMatch',
                //         'type' => 'blocked',
                //         'blocked_type' => 'supressionlist',
                //         'description' => 'blocked in table supression_lists where supression_type account',
                //         'leadspeek_api_id' => $leadspeek_api_id,
                //         'email_encrypt' => $md5param,
                //         'leadspeek_type' => $leadspeektype,
                //     ]);
                //     /* WRITE UPSER FAILED LEAD RECORD */

                //     return array();
                //     exit;die();
                // }

                /** CHECK CLIENT LEVEL */

                // Log::info("Start Check SupressionList 2 CampaignID : #" . $leadspeek_api_id);

                //$suppressionlistAccount = SuppressionList::select('emailmd5')
                // $suppressionlistAccount = SuppressionList::where('emailmd5','=',$md5param)
                //                             ->where('company_id','=',$clientCompanyID)
                //                             ->where('suppression_type','=','client')
                //                             //->get();
                //                             ->exists();
                
                // $_cacheKey = "suplist2_" . $md5param . '_' . $clientCompanyID; --
                // $suppressionlistClient = $this->cacheGetResult($_cacheKey);
                // if(is_null($suppressionlistClient)) {
                //     $suppressionlistClient = SuppressionList::where('emailmd5','=',$md5param)
                //                                             ->where('company_id','=',$clientCompanyID)
                //                                             ->where('suppression_type','=','client')
                //                                             ->exists();
                //     if($suppressionlistClient) {
                //         $suppressionlistAccount = $this->cacheQueryResult($_cacheKey,86400,function () use ($suppressionlistClient) {
                //             return $suppressionlistClient;
                //         });
                //     } else {
                //         if($this->cacheHasResult($_cacheKey)) {
                //             $this->cacheForget($_cacheKey);
                //         }
                //     }
                // }--
                //if (count($suppressionlistAccount) > 0) {
                // if ($suppressionlistClient) {--
                //     $notOnSuppressionList = false;
                //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                //         $frupdate = FailedRecord::find($failedRecordID);
                //         $frupdate->description = $frupdate->description . '|AgainstClientOptList';
                //         $frupdate->save();
                //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                //     // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                //     // Log::info("RELEASE GETDATAMATCH LOCK SupressionList 2 CampaignID #" . $leadspeek_api_id);
                //     // $this->releaseLock($initLock);
                //     // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                //     Log::info("Failed Serve SupressionList 2 CampaignID : #" . $leadspeek_api_id);

                //     /* WRITE UPSER FAILED LEAD RECORD */
                //     $this->UpsertFailedLeadRecord([
                //         'function' => 'getDataMatch',
                //         'type' => 'blocked',
                //         'blocked_type' => 'supressionlist',
                //         'description' => 'blocked in table supression_lists where supression_type client',
                //         'leadspeek_api_id' => $leadspeek_api_id,
                //         'email_encrypt' => $md5param,
                //         'leadspeek_type' => $leadspeektype,
                //     ]);
                //     /* WRITE UPSER FAILED LEAD RECORD */

                //     return array();
                //     exit;die();
                // }--

                // Log::info("Start Check SupressionList 3 CampaignID : #" . $leadspeek_api_id);--
                /** CHECK CAMPAIGN LEVEL */
                //$suppressionlistCampaign = SuppressionList::select('emailmd5')
                // $suppressionlistCampaign = SuppressionList::where('emailmd5','=',$md5param)
                //                             ->where('leadspeek_api_id','=',$leadspeek_api_id)
                //                             ->where('suppression_type','=','campaign')
                //                             //->get();
                //                             ->exists();

                // $_cacheKey = "suplist3_" . $md5param . '_' . $leadspeek_api_id;--
                // $suppressionlistCampaign = $this->cacheGetResult($_cacheKey);
                // if(is_null($suppressionlistCampaign)) {
                //     $suppressionlistCampaign = SuppressionList::where('emailmd5','=',$md5param)
                //                                               ->where('leadspeek_api_id','=',$leadspeek_api_id)
                //                                               ->where('suppression_type','=','campaign')
                //                                               ->exists();
                //     if($suppressionlistCampaign) {
                //         $suppressionlistCampaign = $this->cacheQueryResult($_cacheKey,86400,function () use ($suppressionlistCampaign) {
                //             return $suppressionlistCampaign;
                //         });
                //     } else {
                //         if($this->cacheHasResult($_cacheKey)) {
                //             $this->cacheForget($_cacheKey);
                //         }
                //     }
                // }--
                //if (count($suppressionlistCampaign) > 0) {
                // if ($suppressionlistCampaign) {--
                //     $notOnSuppressionList = false;
                //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                //         $frupdate = FailedRecord::find($failedRecordID);
                //         $frupdate->description = $frupdate->description . '|AgainstCampaignOptList';
                //         $frupdate->save();
                //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    
                //     // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                //     // Log::info("RELEASE GETDATAMATCH LOCK SupressionList 3 CampaignID #" . $leadspeek_api_id);
                //     // $this->releaseLock($initLock);
                //     // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                //     Log::info("Failed Serve SupressionList 3 CampaignID : #" . $leadspeek_api_id);
                    
                //     /* WRITE UPSER FAILED LEAD RECORD */
                //     $this->UpsertFailedLeadRecord([
                //         'function' => 'getDataMatch',
                //         'type' => 'blocked',
                //         'blocked_type' => 'supressionlist',
                //         'description' => 'blocked in table supression_lists where supression_type campaign',
                //         'leadspeek_api_id' => $leadspeek_api_id,
                //         'email_encrypt' => $md5param,
                //         'leadspeek_type' => $leadspeektype,
                //     ]);
                //     /* WRITE UPSER FAILED LEAD RECORD */

                //     return array();
                //     exit;die();
                // }--

            }
            /** CHECK AGAINST CAMPAIGN OR ACCOUNT SUPPRESSION LIST */

            /** CHECK REGARDING RE-IDENTIFICATION FOR LEADS */
            if ($notOnSuppressionList) {
                $reidentification = 'never';
                $notOnReidentification = true;
                $applyreidentificationall = false;

                // $chkreidentification = LeadspeekUser::select('reidentification_type','applyreidentificationall')
                //                             ->where('leadspeek_api_id','=',$leadspeek_api_id)
                //                             ->first();

                $_cacheKey = "reidentification_" . $leadspeek_api_id;
                $chkreidentification = $this->cacheQueryResult($_cacheKey,30,function () use ($leadspeek_api_id) {
                    return LeadspeekUser::select('reidentification_type','applyreidentificationall')
                                            ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                            ->first();
                });
                //if (count($chkreidentification) > 0) {
                if ($chkreidentification) {
                    $reidentification = $chkreidentification->reidentification_type;
                    $applyreidentificationall = ($chkreidentification->applyreidentificationall == 'T')?true:false;
                }

                /** CHECK IF DATA ALREADY IN THAT CAMPAIGN OR NOT */
                $chkExistOnCampaign = array();

                if ($applyreidentificationall) {
                    // $chkExistOnCampaign = LeadspeekReport::select('leadspeek_reports.id','leadspeek_reports.clickdate','leadspeek_reports.created_at')
                    //                         ->join('leadspeek_users','leadspeek_reports.lp_user_id','=','leadspeek_users.id')
                    //                         ->where('leadspeek_reports.company_id','=',$clientCompanyID)
                    //                         ->where('leadspeek_users.applyreidentificationall','=','T')
                    //                         ->where('leadspeek_users.archived','=','F')
                    //                         ->where(function($query) use ($salt,$md5param){
                    //                             // $query->where(DB::raw("MD5(CONVERT(AES_DECRYPT(FROM_bASE64(`leadspeek_reports`.`email`), '" . $salt . "') USING utf8mb4))"),'=',$md5param)
                    //                             //         ->orWhere(DB::raw("MD5(CONVERT(AES_DECRYPT(FROM_bASE64(`leadspeek_reports`.`email2`), '" . $salt . "') USING utf8mb4))"),'=',$md5param)
                    //                             //         ->orWhere('leadspeek_reports.original_md5','=',$md5param);
                    //                             $query->where('leadspeek_reports.email_mdfive','=',$md5param)
                    //                                      ->orWhere('leadspeek_reports.email2_mdfive','=',$md5param)
                    //                                      ->orWhere('leadspeek_reports.original_md5','=',$md5param);
                    //                         })
                    //                         // ->orderBy(DB::raw("DATE_FORMAT(leadspeek_reports.clickdate,'%Y%m%d')"),'DESC')
                    //                         ->orderBy('leadspeek_reports.clickdate','DESC')	
                    //                         // ->limit(1)
                    //                         // ->get();
                    //                         ->first();
                    
                    $_cacheKey = "chkExistOnCampaign1_" . $md5param . '_' . $clientCompanyID;
                    $chkExistOnCampaign = $this->cacheGetResult($_cacheKey);
                    if(is_null($chkExistOnCampaign)) {
                        $chkExistOnCampaign = LeadspeekReport::select('leadspeek_reports.id','leadspeek_reports.clickdate','leadspeek_reports.created_at')
                                                            ->join('leadspeek_users','leadspeek_reports.lp_user_id','=','leadspeek_users.id')
                                                            ->where('leadspeek_users.applyreidentificationall','=','T')
                                                            ->where('leadspeek_users.archived','=','F')
                                                            ->where('leadspeek_reports.company_id','=',$clientCompanyID)
                                                            ->where('leadspeek_reports.original_md5','=',$md5param)
                                                            // ->where(function($query) use ($md5param){
                                                            //     // $query->where('leadspeek_reports.email_mdfive','=',$md5param)
                                                            //     //         ->orWhere('leadspeek_reports.email2_mdfive','=',$md5param)
                                                            //     //         ->orWhere('leadspeek_reports.original_md5','=',$md5param);
                                                            //     $query->where('leadspeek_reports.original_md5','=',$md5param);
                                                            // })
                                                            ->orderBy('leadspeek_reports.clickdate','DESC')	
                                                            ->first();
                        if(!empty($chkExistOnCampaign)) {
                            $chkExistOnCampaign = $this->cacheQueryResult($_cacheKey,86400,function () use ($chkExistOnCampaign) {
                                return $chkExistOnCampaign;
                            });
                        } else {
                            if($this->cacheHasResult($_cacheKey)) {
                                $this->cacheForget($_cacheKey);
                            }
                        }
                    }
                }else{
                    // $chkExistOnCampaign = LeadspeekReport::select('id','clickdate','created_at')
                    //                         ->where('leadspeek_api_id','=',$leadspeek_api_id)
                    //                         ->where(function($query) use ($salt,$md5param){
                    //                             // $query->where(DB::raw("MD5(CONVERT(AES_DECRYPT(FROM_bASE64(`email`), '" . $salt . "') USING utf8mb4))"),'=',$md5param)
                    //                             //         ->orWhere(DB::raw("MD5(CONVERT(AES_DECRYPT(FROM_bASE64(`email2`), '" . $salt . "') USING utf8mb4))"),'=',$md5param)
                    //                             //         ->orWhere('original_md5','=',$md5param);
                    //                             $query->where('email_mdfive','=',$md5param)
                    //                                      ->orWhere('email2_mdfive','=',$md5param)
                    //                                      ->orWhere('original_md5','=',$md5param);
                    //                         })
                    //                         // ->orderBy(DB::raw("DATE_FORMAT(clickdate,'%Y%m%d')"),'DESC')
                    //                         ->orderBy('clickdate','DESC')	
                    //                         //->limit(1)
                    //                         //->get();
                    //                         ->first();

                    $_cacheKey = "chkExistOnCampaign2_" . $md5param . '_' . $leadspeek_api_id;
                    $chkExistOnCampaign = $this->cacheGetResult($_cacheKey);
                    if(is_null($chkExistOnCampaign)) {
                        $chkExistOnCampaign = LeadspeekReport::select('id','clickdate','created_at')
                                                            ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                                            ->where('original_md5','=',$md5param)
                                                            // ->where(function($query) use ($md5param){
                                                            //     // $query->where('email_mdfive','=',$md5param)
                                                            //     //     ->orWhere('email2_mdfive','=',$md5param)
                                                            //     //     ->orWhere('original_md5','=',$md5param);
                                                            //     $query->where('original_md5','=',$md5param);
                                                            // })
                                                            ->orderBy('clickdate','DESC')	
                                                            ->first();
                        if(!empty($chkExistOnCampaign)) {
                            $chkExistOnCampaign = $this->cacheQueryResult($_cacheKey,86400,function () use ($chkExistOnCampaign) {
                                return $chkExistOnCampaign;
                            });
                        } else {
                            if($this->cacheHasResult($_cacheKey)) {
                                $this->cacheForget($_cacheKey);
                            }
                        }
                    }
                }

                //if (count($chkExistOnCampaign) > 0 && $reidentification != 'never') {
                //if (count($chkExistOnCampaign) > 0) {
                if ($chkExistOnCampaign) {
                    //$clickDate = date('Ymd',strtotime($chkExistOnCampaign[0]['clickdate']));
                    $clickDate = date('Ymd',strtotime($chkExistOnCampaign->clickdate));
                    $date1=date_create(date('Ymd'));
                    $date2=date_create($clickDate);
                    $diff=date_diff($date1,$date2);

                    if ($reidentification == 'never') {
                        $notOnReidentification = false;
                    }else if ($diff->format("%a") <= 7 && $reidentification == '1 week') {
                        $notOnReidentification = false;
                    }else if ($diff->format("%a") <= 30 && $reidentification == '1 month') {
                        $notOnReidentification = false;
                    }else if ($diff->format("%a") <= 90 && $reidentification == '3 months') {
                        $notOnReidentification = false;
                    }else if ($diff->format("%a") <= 120 && $reidentification == '6 months') {
                        $notOnReidentification = false;
                    }else if ($diff->format("%a") <= 360 && $reidentification == '1 year') {
                        $notOnReidentification = false;
                    }
                }
                /** CHECK IF DATA ALREADY IN THAT CAMPAIGN OR NOT */

            }
            /** CHECK REGARDING RE-IDENTIFICATION FOR LEADS */

            /** CHECK ON DATABASE IF EXIST */
            if ($notOnReidentification) {
                Log::info("Start Process Check If Data Exist On Our Database");

                // $chkEmailExist = PersonEmail::select('person_emails.email','person_emails.id as emailID','person_emails.permission','p.lastEntry','p.uniqueID',DB::raw("CONVERT(AES_DECRYPT(FROM_bASE64(`firstName`), '" . $salt . "') USING utf8mb4) as firstName"),
                // DB::raw("CONVERT(AES_DECRYPT(FROM_bASE64(`lastName`), '" . $salt . "') USING utf8mb4) as lastName"),'p.id')
                // $chkEmailExist = PersonEmail::select('person_emails.email','person_emails.id as emailID','person_emails.permission','p.lastEntry','p.uniqueID','p.firstName','p.lastName','p.id')
                //                     ->join('persons as p','person_emails.person_id','=','p.id')
                //                     ->where('person_emails.email_encrypt','=',$md5param)
                //                     ->first();

                $_cacheKey = "chkEmailExistPersonEmail_" . $md5param;
                $chkEmailExist = $this->cacheGetResult($_cacheKey);
                if(is_null($chkEmailExist)) {
                    $chkEmailExist = PersonEmail::select('person_emails.email','person_emails.id as emailID','person_emails.permission','p.lastEntry','p.uniqueID','p.firstName','p.lastName','p.id')
                                            ->join('persons as p','person_emails.person_id','=','p.id')
                                            ->where('person_emails.email_encrypt','=',$md5param)
                                            ->first();

                    if(!empty($chkEmailExist)) {
                        $chkEmailExist = $this->cacheQueryResult($_cacheKey,86400,function () use ($chkEmailExist) {
                            return $chkEmailExist;
                        });
                    } else {
                        if($this->cacheHasResult($_cacheKey)) {
                            $this->cacheForget($_cacheKey);
                        }
                    }
                }

                $is_advance = false;
                if ($leadspeektype == 'enhance') {
                    $campaign = LeadspeekUser::select('advance_information')->where('leadspeek_api_id',$leadspeek_api_id)->first();
                    if (isset($campaign->advance_information) && !empty($campaign->advance_information) && trim($campaign->advance_information) != '') {
                        $is_advance = true;
                    }
                }

                $is_local_custom = [
                    'is_advance' => false,
                    'is_b2b' => false,
                    'advance' => [],
                    'b2b' => [],
                ];
                $campaign_information_type_local = 'basic';
                if ($leadspeektype == 'local') {
                        $campaign = LeadspeekUser::select('paymentterm','advance_information','campaign_information_type_local')->where('leadspeek_api_id',$leadspeek_api_id)->first();

                        if (strtolower($campaign->paymentterm) == 'prepaid') {
                            $topup = Topup::select('advance_information','campaign_information_type_local')
                                    ->where('leadspeek_api_id',$leadspeek_api_id)
                                    ->where('leadspeek_type','local')
                                    ->where('topup_status', 'progress')
                                    ->orderBy('id','ASC')
                                    ->first();
                                    
                            $campaign_information_type_local = !empty($topup->campaign_information_type_local) ? explode(',',$topup->campaign_information_type_local) : [];
                            $advance_information = !empty($topup->advance_information) ? json_decode($topup->advance_information) : '';
    
                            if (in_array('advanced',$campaign_information_type_local)) {
                                $is_local_custom['is_advance'] = in_array('advanced',$campaign_information_type_local) ? true : false;
                                $is_local_custom['is_b2b'] = false;
                                $is_local_custom['advance'] = isset($advance_information->advance) ? $advance_information->advance : [];
                                $is_local_custom['b2b'] = [];
                            }

                        }else {
                            $campaign_information_type_local = !empty($campaign->campaign_information_type_local) ? explode(',',$campaign->campaign_information_type_local) : [];
                            $advance_information = !empty($campaign->advance_information) ? json_decode($campaign->advance_information) : '';
    
                            if (in_array('advanced',$campaign_information_type_local)) {
                                $is_local_custom['is_advance'] = in_array('advanced',$campaign_information_type_local) ? true : false;
                                $is_local_custom['is_b2b'] = false;
                                $is_local_custom['advance'] = isset($advance_information->advance) ? $advance_information->advance : [];
                                $is_local_custom['b2b'] = [];
                            }
                        }
                }
                //if (count($chkEmailExist) > 0) {
                if ($chkEmailExist) {
                        Log::info("Start Process Data Exist on Our Database");

                        $lastEntry = date('Ymd',strtotime($chkEmailExist->lastEntry));
                        $date1=date_create(date('Ymd'));
                        $date2=date_create($lastEntry);
                        $diff=date_diff($date1,$date2);

                        $persondata['id'] = $chkEmailExist->id;
                        $persondata['emailID'] = $chkEmailExist->emailID;
                        $persondata['uniqueID'] = $chkEmailExist->uniqueID;
                        $persondata['firstName'] = Encrypter::decrypt($chkEmailExist->firstName);
                        $persondata['lastName'] = Encrypter::decrypt($chkEmailExist->lastName);

                        /** CHECK FOR LOCATION LOCK */
                        //$datalocation = PersonAddress::select('state','zip','city')->where('person_id','=',$persondata['id'])->first();
                        
                        $_cacheKey = "PersonLocDataLoc_" . $persondata['id'];
                        $datalocation = $this->cacheGetResult($_cacheKey);
                        if(is_null($datalocation)) {
                            $datalocation = PersonAddress::select('state','zip','city')->where('person_id','=',$persondata['id'])->first();

                            if(!empty($datalocation)) {
                                $datalocation = $this->cacheQueryResult($_cacheKey,86400,function () use ($datalocation) {
                                    return $datalocation;
                                });
                            } else {
                                if($this->cacheHasResult($_cacheKey)) {
                                    $this->cacheForget($_cacheKey);
                                }
                            }
                        }

                        //if (count($datalocation) > 0) {
                        if ($datalocation) {
                            $chkloc = $this->checklocationlock($loctarget,$datalocation->zip,$datalocation->state,$datalocation->city,$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$failedRecordID);
                            if ($chkloc) {
                                /** REPORT ANALYTIC */
                                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlockfailed');
                                /** REPORT ANALYTIC */

                                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA 1 CampaignID #" . $leadspeek_api_id);
                                // $this->releaseLock($initLock);
                                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

                                /* WRITE UPSER FAILED LEAD RECORD */
                                $this->UpsertFailedLeadRecord([
                                    'function' => 'getDataMatch',
                                    'type' => 'blocked',
                                    'blocked_type' => 'locationlock',
                                    'description' => "blocked in checklocationlock zip = $loczip, state = $locstate, stateexclude = $locstateexclude, city = $loccity function getDataMatch",
                                    'leadspeek_api_id' => $leadspeek_api_id,
                                    'email_encrypt' => $md5param,
                                    'leadspeek_type' => $leadspeektype,
                                ]);
                                /* WRITE UPSER FAILED LEAD RECORD */

                                return array();
                                exit;die();
                            }else{
                                /** REPORT ANALYTIC */
                                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlock');
                                /** REPORT ANALYTIC */
                            }
                        }
                        /** CHECK FOR LOCATION LOCK */

                        $dataresult = array();
                        $personEmail = $chkEmailExist->email;

                        $dataflow = $dataflow . 'EmailExistonDB|';

                    if ($diff->format("%a") <= 120 && $chkEmailExist->permission == "T") { /** customer exist, permission YES, last Entry < 6 Month **/
                        // DATA EXIST ON DB
                        $dataflow = $dataflow . 'LastEntryLessSixMonthPermissionYes|';
                        $resultDataExistOnDB = $this->dataExistOnDB($personEmail,$persondata,$data,$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,$is_advance,$is_local_custom);
                        $dataresult = isset($resultDataExistOnDB['data'])?$resultDataExistOnDB['data']:[];
                        $executionTimeList = isset($resultDataExistOnDB['executionTimeList'])?$resultDataExistOnDB['executionTimeList']:[]; 
                    }else if ($diff->format("%a") > 120 && $chkEmailExist->permission == "T") {  /** customer exist, permission YES, last Entry > 6 Month **/
                        // UPDATE OR QUERY TO ENDATO
                        $dataflow = $dataflow . 'LastEntryMoreSixMonthPermissionYes|';
                        $resultdataNotExistOnDBBIG = $this->dataNotExistOnDBBIG($persondata['firstName'],$persondata['lastName'],$personEmail,"","","","","",$persondata['id'],$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,$is_advance,$is_local_custom);
                        $dataresult = isset($resultdataNotExistOnDBBIG['data'])?$resultdataNotExistOnDBBIG['data']:[];
                        $executionTimeList = isset($resultdataNotExistOnDBBIG['executionTimeList'])?$resultdataNotExistOnDBBIG['executionTimeList']:[]; 
                        //$dataresult = $this->dataNotExistOnDB($persondata['firstName'],$persondata['lastName'],$personEmail,"","","","","",$persondata['id'],$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                    }else if ($diff->format("%a") > 120 && $chkEmailExist->permission == "F") {  /** customer exist, permission NOT, last Entry > 6 Month **/
                        // UPDATE OR QUERY TO ENDATO
                        $dataflow = $dataflow . 'LastEntryMoreSixMonthPermissionNo|';
                        $resultdataNotExistOnDBBIG = $this->dataNotExistOnDBBIG($persondata['firstName'],$persondata['lastName'],$personEmail,"","","","","",$persondata['id'],$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,$is_advance,$is_local_custom);
                        $dataresult = isset($resultdataNotExistOnDBBIG['data'])?$resultdataNotExistOnDBBIG['data']:[];
                        $executionTimeList = isset($resultdataNotExistOnDBBIG['executionTimeList'])?$resultdataNotExistOnDBBIG['executionTimeList']:[]; 
                        //$dataresult = $this->dataNotExistOnDB($persondata['firstName'],$persondata['lastName'],$personEmail,"","","","","",$persondata['id'],$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                    }

                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                    //     Log::info("RELEASE GETDATAMATCH LOCK Process DATA 2 CampaignID #" . $leadspeek_api_id);
                    //     $this->releaseLock($initLock);
                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

                    if (count($dataresult) > 0) {
                        array_push($matches,$dataresult);
                        
                        /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                        // Log::info("RELEASE GETDATAMATCH LOCK");
                        // $this->releaseLock($initLock);
                        /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

                        return [
                            'matches' => $matches,
                            'executionTimeList' => $executionTimeList,
                        ];
                    }else{
                        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                            $frupdate = FailedRecord::find($failedRecordID);
                            $frupdate->description = $frupdate->description . '|NotAll4RequiredDataReturned';
                            $frupdate->save();
                        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                        /** RECORD AS FAILURE */
                        /*$fr = FailedRecord::create([
                            'email_encrypt' => $md5param,
                            'leadspeek_api_id' => $leadspeek_api_id,
                            'description' => 'Not All 4 Required data returned',
                        ]);*/
                        
                        /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                        // Log::info("RELEASE GETDATAMATCH LOCK");
                        // $this->releaseLock($initLock);
                        /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                        
                        return array();
                        /** RECORD AS FAILURE */
                    }

                }else{ //IF NOT EXIST ON DB

                    Log::info("Start Process Data On BigDBM");

                    /** QUERY BIG BDM TO GET RESULT */
                        $dataresult = [];
                        if ($is_advance) {
                        $processBDM = $this->process_BDM_advance($loctarget,$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$leadspeektype,'',$is_advance);
                        }elseif($leadspeektype == 'b2b'){
                        $processBDM = $this->process_BDM_B2B($loctarget,$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$leadspeektype);
                        // }elseif($is_local_custom['is_advance'] || $is_local_custom['is_b2b']){
                        }elseif($is_local_custom['is_advance']){
                        $processBDM = $this->process_BDM_local_custom($loctarget,$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$leadspeektype,'',$is_local_custom);
                        }else {
                        $processBDM = $this->process_BDM_TowerDATA($loctarget,$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$leadspeektype);
                        }
                        $dataresult = isset($processBDM['data'])?$processBDM['data']:[];
                        $executionTimeList = isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[];

                        // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                        // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM HAVE RESULT CampaignID #" . $leadspeek_api_id);
                        // $this->releaseLock($initLock);
                        // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

                        if (count($dataresult) > 0) {
                            array_push($matches,$dataresult);
                            
                            /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                            // Log::info("RELEASE GETDATAMATCH LOCK");
                            // $this->releaseLock($initLock);
                            /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                            Log::info("Start Process Data On BigDBM - Matched");

                            return [
                                'matches' => $matches,
                                'executionTimeList' => $executionTimeList,
                            ];
                        }else{
                            /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                            // Log::info("RELEASE GETDATAMATCH LOCK");
                            // $this->releaseLock($initLock);
                            /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                            Log::info("Start Process Data On BigDBM - NOT Matched");

                            return array();
                            exit;die();
                        }
                    /** QUERY BIG BDM TO GET RESULT */

                    /** QUERYING TO TOWER DATA WITH DATA POSTAL TO GET SOME OTHER INFORMATION WITH MD5 EMAIL */
                        // $tower = $this->getTowerData("postal",$md5param);

                        // if (isset($tower->postal_address)) {
                        //     $_fname = $tower->postal_address->first_name;
                        //     $_lname = $tower->postal_address->last_name;
                        //     $_email = "";
                        //     $_phone = "";
                        //     $_address = $tower->postal_address->address;
                        //     $_city = $tower->postal_address->city;
                        //     $_state = $tower->postal_address->state;
                        //     $_zip = $tower->postal_address->zip;

                        //     /** REPORT ANALYTIC */
                        //         $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'towerpostal');
                        //     /** REPORT ANALYTIC */

                        //     $dataresult = $this->dataNotExistOnDB($_fname,$_lname,$_email,$_phone,$_address,$_city,$_state,$_zip,"",$keyword,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);

                        //     if (count($dataresult) > 0) {

                        //         /** REPORT ANALYTIC */
                        //             $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'endatoenrichment');
                        //         /** REPORT ANALYTIC */

                        //         /** CHECK FOR LOCATION LOCK */
                        //             $chkloc = $this->checklocationlock($loctarget,$dataresult['Zipcode'],$dataresult['State'],$dataresult['City'],$loczip,$locstate,$loccity,$nationaltargeting,$failedRecordID);
                        //             if ($chkloc) {
                        //                 /** REPORT ANALYTIC */
                        //                     $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlockfailed');
                        //                 /** REPORT ANALYTIC */
                        //                 return array();
                        //                 exit;die();
                        //             }else{
                        //                 /** REPORT ANALYTIC */
                        //                 $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlock');
                        //                 /** REPORT ANALYTIC */
                        //             }
                        //         /** CHECK FOR LOCATION LOCK */

                        //         if (trim($dataresult['Email']) != "") {
                        //             array_push($matches,$dataresult);
                        //             return $matches;
                        //         }else{
                        //             $tower = $this->getTowerData("md5",$md5param);
                        //             if (isset($tower->target_email)) {
                        //                 if ($tower->target_email != "") {
                        //                     $tmpEmail = strtolower(trim($tower->target_email));
                        //                     $tmpMd5 = md5($tmpEmail);
                        //                     $dataresult['Email'] = $tmpEmail;

                        //                     /** REPORT ANALYTIC */
                        //                         $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'toweremail');
                        //                     /** REPORT ANALYTIC */

                        //                     if(trim($tmpEmail) != "") {
                        //                         $zbcheck = $this->zb_validation($tmpEmail,"");
                        //                         if (isset($zbcheck->status)) {
                        //                             if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                        //                                 /** PUT IT ON OPTOUT LIST */
                        //                                 $createoptout = OptoutList::create([
                        //                                     'email' => $tmpEmail,
                        //                                     'emailmd5' => md5($tmpEmail),
                        //                                     'blockedcategory' => 'zbnotvalid',
                        //                                     'description' => 'Zero Bounce Status. : ' . $zbcheck->status . '|Email1fromTD',
                        //                                 ]);
                        //                                 /** PUT IT ON OPTOUT LIST */
                        //                                 $dataresult['Email'] = "";

                        //                                 /** REPORT ANALYTIC */
                        //                                 $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                        //                                 /** REPORT ANALYTIC */
                        //                             }else{
                        //                                 $newpersonemail = PersonEmail::create([
                        //                                     'person_id' => $dataresult['PersonID'],
                        //                                     'email' => $tmpEmail,
                        //                                     'email_encrypt' => $tmpMd5,
                        //                                     'permission' => 'T',
                        //                                     'zbvalidate' => date('Y-m-d H:i:s'),
                        //                                 ]);

                        //                                 /** REPORT ANALYTIC */
                        //                                     $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                        //                                 /** REPORT ANALYTIC */

                        //                             }

                        //                         }else{
                        //                             $newpersonemail = PersonEmail::create([
                        //                                 'person_id' => $dataresult['PersonID'],
                        //                                 'email' => $tmpEmail,
                        //                                 'email_encrypt' => $tmpMd5,
                        //                                 'permission' => 'T',
                        //                                 'zbvalidate' => null,
                        //                             ]);
                        //                         }
                        //                     }

                        //                 }
                        //             }

                        //             array_push($matches,$dataresult);
                        //             return $matches;
                        //         }
                        //     }else{
                        //         /** CHECK FOR LOCATION LOCK */
                        //         $chkloc = $this->checklocationlock($loctarget,$_zip,$_state,$_city,$loczip,$locstate,$loccity,$nationaltargeting,$failedRecordID);
                        //             if ($chkloc) {
                        //                 /** REPORT ANALYTIC */
                        //                 $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlockfailed');
                        //                 /** REPORT ANALYTIC */
                        //                 return array();
                        //                 exit;die();
                        //             }else{
                        //                 /** REPORT ANALYTIC */
                        //                 $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlock');
                        //                 /** REPORT ANALYTIC */
                        //             }
                        //         /** CHECK FOR LOCATION LOCK */

                        //         /** GET FROM MD5 TO QUERY AND GET WHATEVER WE CAN GET */
                        //         $tower = $this->getTowerData("md5",$md5param);
                        //         if (isset($tower->target_email)) {
                        //             if ($tower->target_email != "") {
                        //                 $tmpEmail = strtolower(trim($tower->target_email));
                        //                 $tmpMd5 = md5($tmpEmail);
                        //                 $_email = $tmpEmail;

                        //                 /** REPORT ANALYTIC */
                        //                     $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'toweremail');
                        //                 /** REPORT ANALYTIC */

                        //                 if(trim($tmpEmail) != "") {

                        //                     $uniqueID = uniqid();
                        //                     /** INSERT INTO DATABASE PERSON */
                        //                         $newPerson = Person::create([
                        //                             'uniqueID' => $uniqueID,
                        //                             'firstName' => $_fname,
                        //                             'middleName' => '',
                        //                             'lastName' => $_lname,
                        //                             'age' => '0',
                        //                             'identityScore' => '0',
                        //                             'lastEntry' => date('Y-m-d H:i:s'),
                        //                         ]);

                        //                         $newPersonID = $newPerson->id;
                        //                     /** INSERT INTO DATABASE PERSON */

                        //                     $zbcheck = $this->zb_validation($tmpEmail,"");
                        //                     if (isset($zbcheck->status)) {
                        //                         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                        //                             /** PUT IT ON OPTOUT LIST */
                        //                             $createoptout = OptoutList::create([
                        //                                 'email' => $tmpEmail,
                        //                                 'emailmd5' => md5($tmpEmail),
                        //                                 'blockedcategory' => 'zbnotvalid',
                        //                                 'description' => 'Zero Bounce Status. : ' . $zbcheck->status . '|Email1fromTD',
                        //                             ]);
                        //                             /** PUT IT ON OPTOUT LIST */
                        //                             $_email = "";

                        //                             /** REPORT ANALYTIC */
                        //                             $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                        //                             /** REPORT ANALYTIC */
                        //                         }else{

                        //                             $newpersonemail = PersonEmail::create([
                        //                                 'person_id' => $newPersonID,
                        //                                 'email' => $tmpEmail,
                        //                                 'email_encrypt' => $tmpMd5,
                        //                                 'permission' => 'T',
                        //                                 'zbvalidate' => date('Y-m-d H:i:s'),
                        //                             ]);

                        //                             $_email = $tmpEmail;

                        //                             /** REPORT ANALYTIC */
                        //                                 $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                        //                             /** REPORT ANALYTIC */

                        //                         }

                        //                     }else{
                        //                         $newpersonemail = PersonEmail::create([
                        //                             'person_id' => $newPersonID,
                        //                             'email' => $tmpEmail,
                        //                             'email_encrypt' => $tmpMd5,
                        //                             'permission' => 'T',
                        //                             'zbvalidate' => null,
                        //                         ]);

                        //                         $_email = $tmpEmail;

                        //                     }

                        //                     /** INSERT INTO PERSON_ADDRESSES */
                        //                     $newpersonaddress = PersonAddress::create([
                        //                         'person_id' => $newPersonID,
                        //                         'street' => $_address,
                        //                         'unit' => '',
                        //                         'city' => $_city,
                        //                         'state' => $_state,
                        //                         'zip' => $_zip,
                        //                         'fullAddress' => $_address . ' ' . $_city . ',' . $_state . ' ' . $_zip,
                        //                         'firstReportedDate' => date('Y-m-d'),
                        //                         'lastReportedDate' => date('Y-m-d'),
                        //                     ]);
                        //                     /** INSERT INTO PERSON_ADDRESSES */

                        //                 }

                        //             }
                        //         }

                        //         if (trim($_email) != "") {
                        //             $_ID = $this->generateReportUniqueNumber();

                        //             $new = array(
                        //                 "ID" => $_ID,
                        //                 "Email" => $_email,
                        //                 "Email2" => '',
                        //                 "OriginalMD5" => $md5param,
                        //                 "IP" => '',
                        //                 "Source" => "",
                        //                 "OptInDate" => date('Y-m-d H:i:s'),
                        //                 "ClickDate" => date('Y-m-d H:i:s'),
                        //                 "Referer" => "",
                        //                 "Phone" => $_phone,
                        //                 "Phone2" => '',
                        //                 "FirstName" => $_fname,
                        //                 "LastName" => $_lname,
                        //                 "Address1" => $_address,
                        //                 "Address2" => '',
                        //                 "City" => $_city,
                        //                 "State" => $_state,
                        //                 "Zipcode" => $_zip,
                        //                 "PersonID" => $newPersonID,
                        //                 "Keyword" => $keyword,
                        //                 "Description" => 'TowerDataPostal|NotGetDataEndato',
                        //             );

                        //             array_push($matches,$new);
                        //             return $matches;
                        //         }else{
                        //             return array();
                        //         }
                        //         /** GET FROM MD5 TO QUERY AND GET WHATEVER WE CAN GET */

                        //     }
                        // }else{
                        //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                        //         $frupdate = FailedRecord::find($failedRecordID);
                        //         $frupdate->description = $frupdate->description . '|NoDataReturnFromPostalTowerData';
                        //         $frupdate->save();
                        //     /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                        //     /** RECORD AS FAILURE */
                        //     /*$fr = FailedRecord::create([
                        //         'email_encrypt' => $md5param,
                        //         'leadspeek_api_id' => $leadspeek_api_id,
                        //         'description' => 'No Data Return from Postal Tower Data',
                        //     ]);*/
                        //     return array();
                        //     /** RECORD AS FAILURE */
                        // }
                    /** QUERYING TO TOWER DATA WITH DATA POSTAL TO GET SOME OTHER INFORMATION WITH MD5 EMAIL */
                }



            }else{
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    $frupdate = FailedRecord::find($failedRecordID);
                    $frupdate->description = $frupdate->description . '|MatchReidentification:' . $reidentification;
                    $frupdate->save();
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA RE-Identification Failed CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("Re-Indentification Failed");

                /* WRITE UPSER FAILED LEAD RECORD */
                $this->UpsertFailedLeadRecord([
                    'function' => 'getDataMatch',
                    'type' => 'blocked',
                    'blocked_type' => 'reidentification',
                    'description' => "blocked in reidentification type = $reidentification function getDataMatch",
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'email_encrypt' => $md5param,
                    'leadspeek_type' => $leadspeektype,
                    // 'lead_not_serve_type' => 'reidentification_failed' //prepare new schem
                ]);
                /* WRITE UPSER FAILED LEAD RECORD */

                return array();
            }
            /** CHECK ON DATABASE IF EXIST */
        } catch (\Exception $e) {
            Log::info([
                'error' => $e->getMessage(),
                'file' => $e->getFile(),
                'line' => $e->getLine(),
            ]);

            // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
            // Log::info("RELEASE GETDATAMATCH LOCK Process DATA Catch Failed CampaignID #" . $leadspeek_api_id);
            // $this->releaseLock($initLock);
            // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

            return array();
        }
    }

    private function checklocationlock($loctarget = "Focus",$_zip = "",$_state = "",$_city = "",$loczip = "",$locstate = "",$locstateexclude = "", $locstatesifi = "",$loccity = "",$loccitysifi = "",$nationaltargeting = "",$failedRecordID = "") {
        /** CHECK FOR LOCATION LOCK */
        if ($loctarget == "Lock") {
            $validlock = true;
            $validlockState = true;

            $zipdata = explode("-",$_zip);
            $zipdata = strtolower(trim($zipdata[0]));
            $statedata = strtolower(trim($_state));
            $citydata = strtolower(trim($_city));

            $_ziplog = $zipdata;
            $_statedata = $statedata;

            if (trim($zipdata) != "") {
                if ($zipdata && str_contains(strtolower(trim($loczip)), $zipdata)) {
                    $validlock = false;
                }
            }

            if (trim($statedata) != "") {
                if ($statedata && str_contains(strtolower(trim($locstate)), $statedata)) {
                    $validlock = false;
                    $validlockState = false;
                }
            }

            if (trim($citydata) != "" && trim($loccity) != "") {
                /* VALIDATION CITY FOR LOCATOR */
                // if ($citydata && str_contains(strtolower(trim($loccity)), $citydata)) {
                //     /** CHECK THE STATE IF MATCHED CITY */
                //     if ($validlockState) {
                //         $tmploccity = explode(",",strtolower(trim($loccity)));
                //         $sifiCityMatchedID = "";

                //         foreach($tmploccity as $index=>$lc) {
                //             if ($citydata == $lc) {
                //                 $sifiCityMatchedID = $loccitysifi[$index];
                //                 break;
                //             }
                //         }

                //         if ($this->getStatefromCity($sifiCityMatchedID,$statedata)) {
                //             $validlock = false;
                //         }

                //     }else{
                //     /** CHECK THE STATE IF MATCHED CITY */
                //         $validlock = false;
                //     }
                // }
                /* VALIDATION CITY FOR LOCATOR */

                /* VALIDATION CITY FOR ENHANCE */
                if (!$validlockState && $citydata && str_contains(strtolower(trim($loccity)), $citydata)) {
                    $validlock = false;
                } else {
                    $validlock = true;
                }
                /* VALIDATION CITY FOR ENHANCE */
            }


            if (trim($loccity) == "" && trim($locstate) == "" && trim($loczip) == "") {
                $validlock = false;
            }
            if ($nationaltargeting == "T") {
                $validlock = false;
            }

            if ($validlock) {
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    $frupdate = FailedRecord::find($failedRecordID);
                    $frupdate->description = $frupdate->description . '|Location Lock : No Match (zip:' . $_ziplog . ' state:' . $_statedata . ')';
                    $frupdate->save();
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
               return true;
            }else{
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    $frupdate = FailedRecord::find($failedRecordID);
                    $frupdate->description = $frupdate->description . '|Location Lock : Match (zip:' . $_ziplog . ' state:' . $_statedata . ')';
                    $frupdate->save();
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                return false;
            }
        }else{
            $validlock = true;

            $statedata = strtolower(trim($_state));
            
            if(!empty($locstateexclude) && trim($locstateexclude) != "") // validate state logic exclude
            {
                if(!str_contains(strtolower(trim($locstateexclude)), $statedata))
                {
                    $validlock = false;
                }
            }
            else if(!empty($locstate) && trim($locstate) != "") // validate state logic include 
            {
                if(str_contains(strtolower(trim($locstate)), $statedata))
                {
                    $validlock = false;
                }
            }
            else
            {
                $validlock = false;
            }

            if($validlock)
            {
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = "{$frupdate->description}|Location Lock : No Match (state: {$statedata})";
                $frupdate->save();
                return true;
            }
            else 
            {
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = "$frupdate->description|Location Lock : Match (state: $statedata)";
                $frupdate->save();
                return false;
            }
        }
        /** CHECK FOR LOCATION LOCK */
    }

    private function dataExistOnDB($personEmail,$persondata,$data,$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$leadspeektype = "", $is_advance = false, $is_local_custom = ['is_advance' => false,'is_b2b' => false,'advance' => [],'b2b' => [],]) {
        $executionTimeList = [];
        date_default_timezone_set('America/Chicago');

        $new = array();
        $personID = $persondata['id'];
        $_ID = $this->generateReportUniqueNumber();
        $_FirstName = $persondata['firstName'];
        $_LastName = $persondata['lastName'];
        $_Email = $personEmail;
        $_Email2 = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');
        $_Referer = "";
        $_Phone = "";
        $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        $_Description = $dataflow . "dataExistOnDB|" . $failedRecordID;

        $trackBigBDM = "DATAEXISTONDB";

        /** GET PHONE DATA */
            //$personPhone = PersonPhone::where('person_id','=',$personID)->where('permission','=','T')->limit(2)->get();
            $_cacheKey = "personPhone_" . $personID;
            $personPhone = $this->cacheGetResult($_cacheKey);
            if(is_null($personPhone)) {
                $personPhone = PersonPhone::where('person_id','=',$personID)->where('permission','=','T')->limit(2)->get();

                if(!empty($personPhone)) {
                    $personPhone = $this->cacheQueryResult($_cacheKey,86400,function () use ($personPhone) {
                        return $personPhone;
                    });
                } else {
                    if($this->cacheHasResult($_cacheKey)) {
                        $this->cacheForget($_cacheKey);
                    }
                }
            }
            if (count($personPhone) > 0) {
                $_Phone = $personPhone[0]['number'];
                $_Phone2 = (isset($personPhone[1]['number']) && $personPhone[1]['number'] != "")?$personPhone[1]['number']:"";
            }
        /** GET PHONE DATA */

        /** GET ADDRESS DATA */
            //$personAddress = PersonAddress::where('person_id','=',$personID)->first();
            $_cacheKey = "personAddress_" . $personID;
            $personAddress = $this->cacheGetResult($_cacheKey);
            if(is_null($personAddress)) {
                $personAddress = PersonAddress::where('person_id','=',$personID)->first();

                if(!empty($personAddress)) {
                    $personAddress = $this->cacheQueryResult($_cacheKey,86400,function () use ($personAddress) {
                        return $personAddress;
                    });
                } else {
                    if($this->cacheHasResult($_cacheKey)) {
                        $this->cacheForget($_cacheKey);
                    }
                }
            }
            //if (count($personAddress) > 0) {
            if ($personAddress) {
                $_Address1 = $personAddress->street;
                $_Address2 = $personAddress->unit;
                $_City = $personAddress->city;
                $_State = $personAddress->state;
                $_Zipcode = $personAddress->zip;
            }
        /** GET ADDRESS DATA */

        /** GET SECOND EMAIL DATA */
            //$personEmail = PersonEmail::select('id','email')->where('person_id','=',$personID)->whereEncrypted('email','<>',$personEmail)->first();
            $_cacheKey = "personEmail_" . $personID . '_' . $personEmail;
            $personEmail = $this->cacheGetResult($_cacheKey);
            if(is_null($personEmail)) {
                $personEmail = PersonEmail::select('id','email')->where('person_id','=',$personID)->whereEncrypted('email','<>',$personEmail)->first();

                if(!empty($personEmail)) {
                    $personEmail = $this->cacheQueryResult($_cacheKey,86400,function () use ($personEmail) {
                        return $personEmail;
                    });
                } else {
                    if($this->cacheHasResult($_cacheKey)) {
                        $this->cacheForget($_cacheKey);
                    }
                }
            }
            //if (count($personEmail) > 0) {
            if ($personEmail) {
                $_Email2 = $personEmail->email;
            }
        /** GET SECOND EMAIL DATA */

        /** CHECK ZERO BOUNCE FOR VALID EMAIL */
        // $invalidFirstEmail = false;
        // $invalidSecondEmail = false;

        // if (trim($_Email) != "") {
        //     $zbcheck = $this->zb_validation($_Email,"");
        //     if (isset($zbcheck->status)) {
        //         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
        //             /** PUT IT ON OPTOUT LIST */
        //             $createoptout = OptoutList::create([
        //                 'email' => $_Email,
        //                 'emailmd5' => md5($_Email),
        //                 'blockedcategory' => 'zbnotvalid',
        //                 'description' => 'Zero Bounce Status : ' . $zbcheck->status,
        //             ]);
        //             /** PUT IT ON OPTOUT LIST */
        //             $invalidFirstEmail = true;

        //             /** REMOVE THE EMAIL FROM DATABASE */
        //             $delEmail = PersonEmail::where('id','=',$persondata['emailID'])->delete();
        //             /** REMOVE THE EMAIL FROM DATABASE */
        //         }else{
        //             $updateEmailValidate = PersonEmail::find($persondata['emailID']);
        //             $updateEmailValidate->zbvalidate = date('Y-m-d H:i:s');
        //             $updateEmailValidate->save();
        //         }
        //     }else{
        //         $_Description = $_Description . "|ZB Error Email1 : " . $zbcheck->error;
        //     }
        // }

        // if (trim($_Email2) != "") {
        //     $zbcheck = $this->zb_validation($_Email2,"");
        //     if (isset($zbcheck->status)) {
        //         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
        //             /** PUT IT ON OPTOUT LIST */
        //             $createoptout = OptoutList::create([
        //                 'email' => $_Email2,
        //                 'emailmd5' => md5($_Email2),
        //                 'blockedcategory' => 'zbnotvalid',
        //                 'description' => 'Zero Bounce Status : ' . $zbcheck->status,
        //             ]);
        //             /** PUT IT ON OPTOUT LIST */
        //             $invalidSecondEmail = true;

        //             /** REMOVE THE EMAIL FROM DATABASE */
        //             $delEmail = PersonEmail::where('id','=',$personEmail[0]['id'])->delete();
        //             /** REMOVE THE EMAIL FROM DATABASE */
        //         }else{
        //             $updateEmailValidate = PersonEmail::find($personEmail[0]['id']);
        //             $updateEmailValidate->zbvalidate = date('Y-m-d H:i:s');
        //             $updateEmailValidate->save();
        //         }
        //     }else{
        //         $_Description = $_Description . "|ZB Email2 Error : " . $zbcheck->error;
        //     }
        // }

        // if ($invalidFirstEmail == true && $invalidSecondEmail == true) {
        //     $_Email = "";
        //     $_Email2 = "";
        // }else if ($invalidFirstEmail == true && $invalidSecondEmail == false) {
        //     $_Email = $_Email2;
        //     $_Email2 = "";
        // }else if ($invalidFirstEmail == false && $invalidSecondEmail == true) {
        //     $_Email2 = "";
        // }
        /** CHECK ZERO BOUNCE FOR VALID EMAIL */

        $new = array(
            "ID" => $_ID,
			"Email" => $_Email,
            "Email2" => $_Email2,
            "OriginalMD5" => $md5param,
			"IP" => $_IP,
			"Source" => $_Source,
			"OptInDate" => $_OptInDate,
			"ClickDate" => $_ClickDate,
			"Referer" => $_Referer,
			"Phone" => $_Phone,
            "Phone2" => $_Phone2,
			"FirstName" => $_FirstName,
			"LastName" => $_LastName,
			"Address1" => $_Address1,
			"Address2" => $_Address2,
			"City" => $_City,
			"State" => $_State,
			"Zipcode" => $_Zipcode,
            "PersonID" => $personID,
            "Keyword" => $keyword,
            "Description" => $_Description,
            "LeadFrom" => "person"
        );

        if ($is_advance) {
            $person_advance = PersonAdvance::where('person_id', $personID)->first();
            /** HR TEMPORARY NOT SAVE 27 Jan 2025 */
            // $person_advance = false;
            /** HR TEMPORARY NOT SAVE 27 Jan 2025 */
            $new_advance = [];
            if ($person_advance) {

                $taxBillInformation = array_filter([
                    $person_advance->tax_bill_mailing_address,
                    $person_advance->tax_bill_mailing_city,
                    !empty($person_advance->tax_bill_mailing_county) ? "{$person_advance->tax_bill_mailing_county} County" : null,
                    $person_advance->tax_bill_mailing_state,
                    trim($person_advance->tax_bill_mailing_zip . ($person_advance->tax_bill_mailing_zip && $person_advance->tax_bill_mailing_zip4 ? "-" : "") . $person_advance->tax_bill_mailing_zip4, "-")
                ]);            
                $taxBillInformationString = '';
                $taxBillInformationString = implode(", ", $taxBillInformation);
    
                $new_advance = [
                     // Person advance
                        //identification
                            "GenderAux" => isset($person_advance->gender_aux) && !empty($person_advance->gender_aux) ? $person_advance->gender_aux : '',
                            // "AgeAux" => isset($person_advance->age_aux) && !empty($person_advance->age_aux) ? $person_advance->age_aux : '',
                            // "BirthYearAux" => isset($person_advance->birth_year_aux) && !empty($person_advance->birth_year_aux) ? $person_advance->birth_year_aux : '',
                            "Generation" => isset($person_advance->generation) && !empty($person_advance->generation) ? $person_advance->generation : '',
                            'MaritalStatus' => isset($person_advance->marital_status) && !empty($person_advance->marital_status) ? $person_advance->marital_status : '',
                        //identification
    
                        //financial information
                            "IncomeHousehold" => isset($person_advance->income_household) && !empty($person_advance->income_household) ? $person_advance->income_household : '',
                            "IncomeMidptsHousehold" => isset($person_advance->income_midpts_household) && !empty($person_advance->income_midpts_household) ? $person_advance->income_midpts_household : '',
                            "NetWorthHousehold" => isset($person_advance->net_worth_household) && !empty($person_advance->net_worth_household) ? $person_advance->net_worth_household : '',
                            "NetWorthMidptHousehold" => isset($person_advance->net_worth_midpt_household) && !empty($person_advance->net_worth_midpt_household) ? $person_advance->net_worth_midpt_household : '',
                            "DiscretionaryIncome" => isset($person_advance->discretionary_income) && !empty($person_advance->discretionary_income) ? $person_advance->discretionary_income : '',
                            "CreditMidpts" => isset($person_advance->credit_midpts) && !empty($person_advance->credit_midpts) ? $person_advance->credit_midpts : '',
                            "CreditRange" => isset($person_advance->credit_range) && !empty($person_advance->credit_range) ? $person_advance->credit_range : '',
                        //financial information
    
                        //occupation
                            "OccupationCategory" => isset($person_advance->occupation_category) && !empty($person_advance->occupation_category) ? $person_advance->occupation_category : '',
                            "OccupationDetail" => isset($person_advance->occupation_detail) && !empty($person_advance->occupation_detail) ? $person_advance->occupation_detail : '',
                            "OccupationType" => isset($person_advance->occupation_type) && !empty($person_advance->occupation_type) ? $person_advance->occupation_type : '',
                        //occupation
    
                        //miscellaneous
                            "Voter" => isset($person_advance->voter) && !empty($person_advance->voter) ? $person_advance->voter : '',
                            "Urbanicity" => isset($person_advance->urbanicity) && !empty($person_advance->urbanicity) ? $person_advance->urbanicity : '',
                        //miscellaneous
    
                        //contact information                    
                            "Phone" => isset($person_advance->mobile_phone_1) && !empty($person_advance->mobile_phone_1) ? $person_advance->mobile_phone_1 : '',
                            "Phone2" => isset($person_advance->mobile_phone_2) && !empty($person_advance->mobile_phone_2) ? $person_advance->mobile_phone_2 : '',
                            "Phone3" => isset($person_advance->mobile_phone_3) && !empty($person_advance->mobile_phone_3) ? $person_advance->mobile_phone_3 : '',    
                            "TaxBillInformation" => $taxBillInformationString,
                        //contact information
    
                        //household information
                            "NumAdultsHousehold" => isset($person_advance->num_adults_household) && !empty($person_advance->num_adults_household) ? $person_advance->num_adults_household : '',
                            "NumChildrenHousehold" => isset($person_advance->num_children_household) && !empty($person_advance->num_children_household) ? $person_advance->num_children_household : '',
                            "NumPersonsHousehold" => isset($person_advance->num_persons_household) && !empty($person_advance->num_persons_household) ? $person_advance->num_persons_household : '',
                            "ChildAged03Household" => isset($person_advance->child_aged_0_3_household) && !empty($person_advance->child_aged_0_3_household) ? $person_advance->child_aged_0_3_household : '',
                            "ChildAged46Household" => isset($person_advance->child_aged_4_6_household) && !empty($person_advance->child_aged_4_6_household) ? $person_advance->child_aged_4_6_household : '',
                            "ChildAged79Household" => isset($person_advance->child_aged_7_9_household) && !empty($person_advance->child_aged_7_9_household) ? $person_advance->child_aged_7_9_household : '',
                            "ChildAged1012Household" => isset($person_advance->child_aged_10_12_household) && !empty($person_advance->child_aged_10_12_household) ? $person_advance->child_aged_10_12_household : '',
                            "ChildAged1318Household" => isset($person_advance->child_aged_13_18_household) && !empty($person_advance->child_aged_13_18_household) ? $person_advance->child_aged_13_18_household : '',
                            "ChildrenHousehold" => isset($person_advance->children_household) && !empty($person_advance->children_household) ? $person_advance->children_household : '',
                        //household information
    
                        //marketing indicators
                            // "HasEmail" => isset($person_advance->has_email) && !empty($person_advance->has_email) ? $person_advance->has_email : '',
                            // "HasPhone" => isset($person_advance->has_phone) && !empty($person_advance->has_phone) ? $person_advance->has_phone : '',
                            "MagazineSubscriber" => isset($person_advance->magazine_subscriber) && !empty($person_advance->magazine_subscriber) ? $person_advance->magazine_subscriber : '',
                            "CharityInterest" => isset($person_advance->charity_interest) && !empty($person_advance->charity_interest) ? $person_advance->charity_interest : '',
                            "LikelyCharitableDonor" => isset($person_advance->likely_charitable_donor) && !empty($person_advance->likely_charitable_donor) ? $person_advance->likely_charitable_donor : '',
                        //marketing indicators
    
                        //house and real estate
                            "DwellingType" => isset($person_advance->dwelling_type) && !empty($person_advance->dwelling_type) ? $person_advance->dwelling_type : '',
                            "HomeOwner" => isset($person_advance->home_owner) && !empty($person_advance->home_owner) ? $person_advance->home_owner : '',
                            "HomeOwnerOrdinal" => isset($person_advance->home_owner_ordinal) && !empty($person_advance->home_owner_ordinal) ? $person_advance->home_owner_ordinal : '',
                            "LengthOfResidence" => isset($person_advance->length_of_residence) && !empty($person_advance->length_of_residence) ? $person_advance->length_of_residence : '',
                            "HomePrice" => isset($person_advance->home_price) && !empty($person_advance->home_price) ? $person_advance->home_price : '',
                            "HomeValue" => isset($person_advance->home_value) && !empty($person_advance->home_value) ? $person_advance->home_value : '',
                            "MedianHomeValue" => isset($person_advance->median_home_value) && !empty($person_advance->median_home_value) ? $person_advance->median_home_value : '',
                            "LivingSqft" => isset($person_advance->living_sqft) && !empty($person_advance->living_sqft) ? $person_advance->living_sqft : '',
                            "YrBuiltOrig" => isset($person_advance->yr_built_orig) && !empty($person_advance->yr_built_orig) ? $person_advance->yr_built_orig : '',
                            "YrBuiltRange" => isset($person_advance->yr_built_range) && !empty($person_advance->yr_built_range) ? $person_advance->yr_built_range : '',
                            "LotNumber" => isset($person_advance->lot_number) && !empty($person_advance->lot_number) ? $person_advance->lot_number : '',
                            "LegalDescription" => isset($person_advance->legal_description) && !empty($person_advance->legal_description) ? $person_advance->legal_description : '',
                            "LandSqft" => isset($person_advance->land_sqft) && !empty($person_advance->land_sqft) ? $person_advance->land_sqft : '',
                            "GarageSqft" => isset($person_advance->garage_sqft) && !empty($person_advance->garage_sqft) ? $person_advance->garage_sqft : '',
                            "Subdivision" => isset($person_advance->subdivision) && !empty($person_advance->subdivision) ? $person_advance->subdivision : '',
                            "ZoningCode" => isset($person_advance->zoning_code) && !empty($person_advance->zoning_code) ? $person_advance->zoning_code : '',
                        //house and real estate
    
                        //interest and affinities
                            "Cooking" => isset($person_advance->cooking) && !empty($person_advance->cooking) ? $person_advance->cooking : '',
                            "Gardening" => isset($person_advance->gardening) && !empty($person_advance->gardening) ? $person_advance->gardening : '',
                            "Music" => isset($person_advance->music) && !empty($person_advance->music) ? $person_advance->music : '',
                            "Diy" => isset($person_advance->diy) && !empty($person_advance->diy) ? $person_advance->diy : '',
                            "Books" => isset($person_advance->books) && !empty($person_advance->books) ? $person_advance->books : '',
                            "TravelVacation" => isset($person_advance->travel_vacation) && !empty($person_advance->travel_vacation) ? $person_advance->travel_vacation : '',
                            "HealthBeautyProducts" => isset($person_advance->health_beauty_products) && !empty($person_advance->health_beauty_products) ? $person_advance->health_beauty_products : '',
                            "PetOwner" => isset($person_advance->pet_owner) && !empty($person_advance->pet_owner) ? $person_advance->pet_owner : '',
                            "Photography" => isset($person_advance->photography) && !empty($person_advance->photography) ? $person_advance->photography : '',
                            "Fitness" => isset($person_advance->fitness) && !empty($person_advance->fitness) ? $person_advance->fitness : '',
                            "Epicurean" => isset($person_advance->epicurean) && !empty($person_advance->epicurean) ? $person_advance->epicurean : '',
                        //interest and affinities
    
                        //location and census data
                            "Cbsa" => isset($person_advance->cbsa) && !empty($person_advance->cbsa) ? $person_advance->cbsa : '',
                            "CensusBlock" => isset($person_advance->census_block) && !empty($person_advance->census_block) ? $person_advance->census_block : '',
                            "CensusBlockGroup" => isset($person_advance->census_block_group) && !empty($person_advance->census_block_group) ? $person_advance->census_block_group : '',
                            "CensusTract" => isset($person_advance->census_tract) && !empty($person_advance->census_tract) ? $person_advance->census_tract : '',
                        //location and census data
                    // Person advance
                ];
    
                $new = array_merge($new,$new_advance);
            } else { 
                $processBDM = $this->process_BDM_advance_exist($personID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,$is_advance);
                $new_advance = isset($processBDM['data'])?$processBDM['data']:[];
                $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                $new = array_merge($new,$new_advance);

            }
        }

        if($leadspeektype == 'b2b') {
            $person_b2b = PersonB2B::where('person_id', $personID)->first();
            $new_b2b = [];
            if(!empty($person_b2b)){
                $new_b2b = [
                    'EmployeeID' => isset($person_b2b->employee_id) && !empty($person_b2b->employee_id) ? $person_b2b->employee_id : '',
                    'CompanyName' => isset($person_b2b->company_name) && !empty($person_b2b->company_name) ? $person_b2b->company_name : '',
                    'CompanyWebsite' => isset($person_b2b->company_website) && !empty($person_b2b->company_website) ? $person_b2b->company_website : '',
                    'NumEmployees' => isset($person_b2b->num_employees) && !empty($person_b2b->num_employees) ? $person_b2b->num_employees : '',
                    'SalesVolume' => isset($person_b2b->sales_volume) && !empty($person_b2b->sales_volume) ? $person_b2b->sales_volume : '',
                    'YearFounded' => isset($person_b2b->year_founded) && !empty($person_b2b->year_founded) ? $person_b2b->year_founded : '',
                    'JobTitle' => isset($person_b2b->job_title) && !empty($person_b2b->job_title) ? $person_b2b->job_title : '',
                    'Level' => isset($person_b2b->level) && !empty($person_b2b->level) ? $person_b2b->level : '',
                    'JobFunction' => isset($person_b2b->job_function) && !empty($person_b2b->job_function) ? $person_b2b->job_function : '',
                    'HeadquartersBranch' => isset($person_b2b->headquarters_branch) && !empty($person_b2b->headquarters_branch) ? $person_b2b->headquarters_branch : '',
                    'NaicsCode' => isset($person_b2b->naics_code) && !empty($person_b2b->naics_code) ? $person_b2b->naics_code : '',
                    'LastSeenDate' => isset($person_b2b->last_seen_date) && !empty($person_b2b->last_seen_date) ? $person_b2b->last_seen_date : '',
                    'LinkedIn' => isset($person_b2b->linked_in) && !empty($person_b2b->linked_in) ? $person_b2b->linked_in : '',
                ];

                $new = array_merge($new,$new_b2b);
            } else {

                $processBDM = $this->process_BDM_B2B_exist($personID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                $new_b2b = isset($processBDM['data'])?$processBDM['data']:[];
                $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                $new = array_merge($new,$new_b2b);
            }
        }

            if ($is_local_custom['is_advance']) {
                $person_advance = PersonAdvance::where('person_id', $personID)->first();
                $new_advance_custom = [];
                if ($person_advance) {

                    $taxBillInformation = array_filter([
                        $person_advance->tax_bill_mailing_address,
                        $person_advance->tax_bill_mailing_city,
                        !empty($person_advance->tax_bill_mailing_county) ? "{$person_advance->tax_bill_mailing_county} County" : null,
                        $person_advance->tax_bill_mailing_state,
                        trim($person_advance->tax_bill_mailing_zip . ($person_advance->tax_bill_mailing_zip && $person_advance->tax_bill_mailing_zip4 ? "-" : "") . $person_advance->tax_bill_mailing_zip4, "-")
                    ]);            
                    $taxBillInformationString = '';
                    $taxBillInformationString = implode(", ", $taxBillInformation);
        
                    $new_advance_custom = [
                        // Person advance
                            //identification
                                "GenderAux" => isset($person_advance->gender_aux) && !empty($person_advance->gender_aux) ? $person_advance->gender_aux : '',
                                // "AgeAux" => isset($person_advance->age_aux) && !empty($person_advance->age_aux) ? $person_advance->age_aux : '',
                                // "BirthYearAux" => isset($person_advance->birth_year_aux) && !empty($person_advance->birth_year_aux) ? $person_advance->birth_year_aux : '',
                                "Generation" => isset($person_advance->generation) && !empty($person_advance->generation) ? $person_advance->generation : '',
                                'MaritalStatus' => isset($person_advance->marital_status) && !empty($person_advance->marital_status) ? $person_advance->marital_status : '',
                            //identification
        
                            //financial information
                                "IncomeHousehold" => isset($person_advance->income_household) && !empty($person_advance->income_household) ? $person_advance->income_household : '',
                                "IncomeMidptsHousehold" => isset($person_advance->income_midpts_household) && !empty($person_advance->income_midpts_household) ? $person_advance->income_midpts_household : '',
                                "NetWorthHousehold" => isset($person_advance->net_worth_household) && !empty($person_advance->net_worth_household) ? $person_advance->net_worth_household : '',
                                "NetWorthMidptHousehold" => isset($person_advance->net_worth_midpt_household) && !empty($person_advance->net_worth_midpt_household) ? $person_advance->net_worth_midpt_household : '',
                                "DiscretionaryIncome" => isset($person_advance->discretionary_income) && !empty($person_advance->discretionary_income) ? $person_advance->discretionary_income : '',
                                "CreditMidpts" => isset($person_advance->credit_midpts) && !empty($person_advance->credit_midpts) ? $person_advance->credit_midpts : '',
                                "CreditRange" => isset($person_advance->credit_range) && !empty($person_advance->credit_range) ? $person_advance->credit_range : '',
                            //financial information
        
                            //occupation
                                "OccupationCategory" => isset($person_advance->occupation_category) && !empty($person_advance->occupation_category) ? $person_advance->occupation_category : '',
                                "OccupationDetail" => isset($person_advance->occupation_detail) && !empty($person_advance->occupation_detail) ? $person_advance->occupation_detail : '',
                                "OccupationType" => isset($person_advance->occupation_type) && !empty($person_advance->occupation_type) ? $person_advance->occupation_type : '',
                            //occupation
        
                            //miscellaneous
                                "Voter" => isset($person_advance->voter) && !empty($person_advance->voter) ? $person_advance->voter : '',
                                "Urbanicity" => isset($person_advance->urbanicity) && !empty($person_advance->urbanicity) ? $person_advance->urbanicity : '',
                            //miscellaneous
        
                            //contact information                    
                                "Phone" => isset($person_advance->mobile_phone_1) && !empty($person_advance->mobile_phone_1) ? $person_advance->mobile_phone_1 : '',
                                "Phone2" => isset($person_advance->mobile_phone_2) && !empty($person_advance->mobile_phone_2) ? $person_advance->mobile_phone_2 : '',
                                "Phone3" => isset($person_advance->mobile_phone_3) && !empty($person_advance->mobile_phone_3) ? $person_advance->mobile_phone_3 : '',    
                                "TaxBillInformation" => $taxBillInformationString,
                            //contact information
        
                            //household information
                                "NumAdultsHousehold" => isset($person_advance->num_adults_household) && !empty($person_advance->num_adults_household) ? $person_advance->num_adults_household : '',
                                "NumChildrenHousehold" => isset($person_advance->num_children_household) && !empty($person_advance->num_children_household) ? $person_advance->num_children_household : '',
                                "NumPersonsHousehold" => isset($person_advance->num_persons_household) && !empty($person_advance->num_persons_household) ? $person_advance->num_persons_household : '',
                                "ChildAged03Household" => isset($person_advance->child_aged_0_3_household) && !empty($person_advance->child_aged_0_3_household) ? $person_advance->child_aged_0_3_household : '',
                                "ChildAged46Household" => isset($person_advance->child_aged_4_6_household) && !empty($person_advance->child_aged_4_6_household) ? $person_advance->child_aged_4_6_household : '',
                                "ChildAged79Household" => isset($person_advance->child_aged_7_9_household) && !empty($person_advance->child_aged_7_9_household) ? $person_advance->child_aged_7_9_household : '',
                                "ChildAged1012Household" => isset($person_advance->child_aged_10_12_household) && !empty($person_advance->child_aged_10_12_household) ? $person_advance->child_aged_10_12_household : '',
                                "ChildAged1318Household" => isset($person_advance->child_aged_13_18_household) && !empty($person_advance->child_aged_13_18_household) ? $person_advance->child_aged_13_18_household : '',
                                "ChildrenHousehold" => isset($person_advance->children_household) && !empty($person_advance->children_household) ? $person_advance->children_household : '',
                            //household information
        
                            //marketing indicators
                                // "HasEmail" => isset($person_advance->has_email) && !empty($person_advance->has_email) ? $person_advance->has_email : '',
                                // "HasPhone" => isset($person_advance->has_phone) && !empty($person_advance->has_phone) ? $person_advance->has_phone : '',
                                "MagazineSubscriber" => isset($person_advance->magazine_subscriber) && !empty($person_advance->magazine_subscriber) ? $person_advance->magazine_subscriber : '',
                                "CharityInterest" => isset($person_advance->charity_interest) && !empty($person_advance->charity_interest) ? $person_advance->charity_interest : '',
                                "LikelyCharitableDonor" => isset($person_advance->likely_charitable_donor) && !empty($person_advance->likely_charitable_donor) ? $person_advance->likely_charitable_donor : '',
                            //marketing indicators
        
                            //house and real estate
                                "DwellingType" => isset($person_advance->dwelling_type) && !empty($person_advance->dwelling_type) ? $person_advance->dwelling_type : '',
                                "HomeOwner" => isset($person_advance->home_owner) && !empty($person_advance->home_owner) ? $person_advance->home_owner : '',
                                "HomeOwnerOrdinal" => isset($person_advance->home_owner_ordinal) && !empty($person_advance->home_owner_ordinal) ? $person_advance->home_owner_ordinal : '',
                                "LengthOfResidence" => isset($person_advance->length_of_residence) && !empty($person_advance->length_of_residence) ? $person_advance->length_of_residence : '',
                                "HomePrice" => isset($person_advance->home_price) && !empty($person_advance->home_price) ? $person_advance->home_price : '',
                                "HomeValue" => isset($person_advance->home_value) && !empty($person_advance->home_value) ? $person_advance->home_value : '',
                                "MedianHomeValue" => isset($person_advance->median_home_value) && !empty($person_advance->median_home_value) ? $person_advance->median_home_value : '',
                                "LivingSqft" => isset($person_advance->living_sqft) && !empty($person_advance->living_sqft) ? $person_advance->living_sqft : '',
                                "YrBuiltOrig" => isset($person_advance->yr_built_orig) && !empty($person_advance->yr_built_orig) ? $person_advance->yr_built_orig : '',
                                "YrBuiltRange" => isset($person_advance->yr_built_range) && !empty($person_advance->yr_built_range) ? $person_advance->yr_built_range : '',
                                "LotNumber" => isset($person_advance->lot_number) && !empty($person_advance->lot_number) ? $person_advance->lot_number : '',
                                "LegalDescription" => isset($person_advance->legal_description) && !empty($person_advance->legal_description) ? $person_advance->legal_description : '',
                                "LandSqft" => isset($person_advance->land_sqft) && !empty($person_advance->land_sqft) ? $person_advance->land_sqft : '',
                                "GarageSqft" => isset($person_advance->garage_sqft) && !empty($person_advance->garage_sqft) ? $person_advance->garage_sqft : '',
                                "Subdivision" => isset($person_advance->subdivision) && !empty($person_advance->subdivision) ? $person_advance->subdivision : '',
                                "ZoningCode" => isset($person_advance->zoning_code) && !empty($person_advance->zoning_code) ? $person_advance->zoning_code : '',
                            //house and real estate
        
                            //interest and affinities
                                "Cooking" => isset($person_advance->cooking) && !empty($person_advance->cooking) ? $person_advance->cooking : '',
                                "Gardening" => isset($person_advance->gardening) && !empty($person_advance->gardening) ? $person_advance->gardening : '',
                                "Music" => isset($person_advance->music) && !empty($person_advance->music) ? $person_advance->music : '',
                                "Diy" => isset($person_advance->diy) && !empty($person_advance->diy) ? $person_advance->diy : '',
                                "Books" => isset($person_advance->books) && !empty($person_advance->books) ? $person_advance->books : '',
                                "TravelVacation" => isset($person_advance->travel_vacation) && !empty($person_advance->travel_vacation) ? $person_advance->travel_vacation : '',
                                "HealthBeautyProducts" => isset($person_advance->health_beauty_products) && !empty($person_advance->health_beauty_products) ? $person_advance->health_beauty_products : '',
                                "PetOwner" => isset($person_advance->pet_owner) && !empty($person_advance->pet_owner) ? $person_advance->pet_owner : '',
                                "Photography" => isset($person_advance->photography) && !empty($person_advance->photography) ? $person_advance->photography : '',
                                "Fitness" => isset($person_advance->fitness) && !empty($person_advance->fitness) ? $person_advance->fitness : '',
                                "Epicurean" => isset($person_advance->epicurean) && !empty($person_advance->epicurean) ? $person_advance->epicurean : '',
                            //interest and affinities
        
                            //location and census data
                                "Cbsa" => isset($person_advance->cbsa) && !empty($person_advance->cbsa) ? $person_advance->cbsa : '',
                                "CensusBlock" => isset($person_advance->census_block) && !empty($person_advance->census_block) ? $person_advance->census_block : '',
                                "CensusBlockGroup" => isset($person_advance->census_block_group) && !empty($person_advance->census_block_group) ? $person_advance->census_block_group : '',
                                "CensusTract" => isset($person_advance->census_tract) && !empty($person_advance->census_tract) ? $person_advance->census_tract : '',
                            //location and census data
                        // Person advance
                    ];
        
                    $new = array_merge($new,$new_advance_custom);
                } else { 
                    if (!empty($is_local_custom['advance'])) {
                        $processBDM = $this->process_BDM_advance_exist($personID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,true);
                        $new_advance_custom = isset($processBDM['data'])?$processBDM['data']:[];
                        $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                    }
                    $new = array_merge($new,$new_advance_custom);
                }

                // $new = array_merge($new,["local_advance_exist" => true]); //set advance charge

            }

            // if ($is_local_custom['is_b2b']) {
            //     $person_b2b = PersonB2B::where('person_id', $personID)->first();
            //     $new_b2b_custom = [];
            //     if(!empty($person_b2b)){
            //         $new_b2b_custom = [
            //             'EmployeeID' => isset($person_b2b->employee_id) && !empty($person_b2b->employee_id) ? $person_b2b->employee_id : '',
            //             'CompanyName' => isset($person_b2b->company_name) && !empty($person_b2b->company_name) ? $person_b2b->company_name : '',
            //             'CompanyWebsite' => isset($person_b2b->company_website) && !empty($person_b2b->company_website) ? $person_b2b->company_website : '',
            //             'NumEmployees' => isset($person_b2b->num_employees) && !empty($person_b2b->num_employees) ? $person_b2b->num_employees : '',
            //             'SalesVolume' => isset($person_b2b->sales_volume) && !empty($person_b2b->sales_volume) ? $person_b2b->sales_volume : '',
            //             'YearFounded' => isset($person_b2b->year_founded) && !empty($person_b2b->year_founded) ? $person_b2b->year_founded : '',
            //             'JobTitle' => isset($person_b2b->job_title) && !empty($person_b2b->job_title) ? $person_b2b->job_title : '',
            //             'Level' => isset($person_b2b->level) && !empty($person_b2b->level) ? $person_b2b->level : '',
            //             'JobFunction' => isset($person_b2b->job_function) && !empty($person_b2b->job_function) ? $person_b2b->job_function : '',
            //             'HeadquartersBranch' => isset($person_b2b->headquarters_branch) && !empty($person_b2b->headquarters_branch) ? $person_b2b->headquarters_branch : '',
            //             'NaicsCode' => isset($person_b2b->naics_code) && !empty($person_b2b->naics_code) ? $person_b2b->naics_code : '',
            //             'LastSeenDate' => isset($person_b2b->last_seen_date) && !empty($person_b2b->last_seen_date) ? $person_b2b->last_seen_date : '',
            //             'LinkedIn' => isset($person_b2b->linked_in) && !empty($person_b2b->linked_in) ? $person_b2b->linked_in : '',
            //         ];

            //         $new = array_merge($new,$new_b2b_custom);
            //     } else {
            //         if (!empty($is_local_custom['b2b'])) {
                //         $processBDM = $this->process_BDM_B2B_exist($personID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                //         $new_b2b_custom = isset($processBDM['data'])?$processBDM['data']:[];
                //         $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                //         $new = array_merge($new,$new_b2b_custom);
            //         }
            //     }
            //     $new = array_merge($new,["local_b2b_exist" => true]); //set b2b charge
            // }

        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
            $frupdate = FailedRecord::find($failedRecordID);
            $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
            $frupdate->save();
        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    public function process_BDM_local_custom($loctarget = 'Focus',$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$loczip = "",$locstate = "",$locstateexclude = "",$locstatesifi = "",$loccity = "",$loccitysifi = "",$nationaltargeting = "F",$leadspeektype = "",$initLock="",$is_local_custom = ['is_advance' => false,'is_b2b' => false,'advance' => [],'b2b' => [],]) {
        $executionTimeList = [];

        date_default_timezone_set('America/Chicago');

        $new = array();

        //BASIC INFORMATION
            $_ID = "";
            $_FirstName = "";
            $_LastName = "";
            $_Email = "";
            $_Email2 = "";
            $_IP = "";
            $_Source = "";
            $_OptInDate = date('Y-m-d H:i:s');
            $_ClickDate = date('Y-m-d H:i:s');
            $_Referer = "";
            $_Phone = "";
            $_Phone2 = "";
            $_Address1 = "";
            $_Address2 = "";
            $_City = "";
            $_State = "";
            $_Zipcode = "";
            // $local_advance_exist = false;
            // $local_b2b_exist = false;
        //BASIC INFORMATION

        //ADVANCE INFORMATION

            //identification
                $_gender_aux = "";
                $_age_aux = "";
                $_birth_year_aux = "";
                $_generation = "";
                $_marital_status = "";
            //identification
            
            //financial information
                $_household_income = "";
                $_median_household_income = "";
                $_household_net_worth = "";
                $_median_household_net_worth = "";
                $_discretionary_income = "";
                $_credit_score_median = "";
                $_credit_score_range = "";
            //financial information

            //occupation
                $_occupation_category = "";
                $_occupation_type = "";
                $_occupation_detail = "";
            //occupation
            
            //miscellaneous
                $_voter = "";
                $_urbanicity = "";
            //miscellaneous

            //contact information
                $_mobile_phone = "";
                $_mobile_phone2 = "";
                $_mobile_phone3 = "";
                $_mobile_phone_dnc = "";
                $_mobile_phone_dnc2 = "";
                $_mobile_phone_dnc3 = "";
                $_tax_bill_mailing_address = "";
                $_tax_bill_mailing_city = "";
                $_tax_bill_mailing_county = "";
                $_tax_bill_mailing_fips = "";
                $_tax_bill_mailing_state = "";
                $_tax_bill_mailing_zip = "";
                $_tax_bill_mailing_zip4 = "";
            //contact information

            //household information
                $_num_adults_household= "";
                $_num_children_household = "";
                $_num_persons_household = "";
                $_child_aged_0_3_household = "";
                $_child_aged_4_6_household = "";
                $_child_aged_7_9_household = "";
                $_child_aged_10_12_household = "";
                $_child_aged_13_18_household = "";
                $_children_household = "";
            //household information

            //marketing indicators
                $_has_email = "";
                $_has_phone = "";
                $_magazine_subscriber = "";
                $_charity_interest = "";
                $_likely_charitable_donor = "";            
            //marketing indicators

            //house and real estate
                $_dwelling_type = "";
                $_home_owner = "";
                $_home_owner_ordinal = "";
                $_length_of_residence = "";
                $_home_price = "";
                $_home_value = "";
                $_median_home_value = "";
                $_living_sqft = "";
                $_year_built_original = "";
                $_year_built_range = "";
                $_lot_number = "";
                $_legal_description = "";
                $_land_sqft = "";
                $_garage_sqft = "";
                $_subdivision = "";
                $_zoning_code = "";
            //house and real estate

            //interest and affinities
                $_cooking = "";
                $_gardening = "";
                $_music = "";
                $_diy = "";
                $_books = "";
                $_travel_vacation = "";
                $_health_beauty_products = "";
                $_pet_owner = "";
                $_photography = "";
                $_fitness = "";
                $_epicurean = "";
            //interest and affinities

            //location and census data
                $_cbsa = "";
                $_census_block = "";
                $_census_block_group = "";
                $_census_tract = "";
            //location and census data

            //unregistered row
                $_aerobics = "";
                $_african_american_affinity = "";
                $_amex_card = "";
                $_antiques = "";
                $_apparel_accessory_affinity = "";
                $_apparel_affinity = "";
                $_arts_and_crafts = "";
                $_asian_affinity = "";
                $_auto_affinity = "";
                $_auto_racing_affinity = "";
                $_aviation_affinity = "";
                $_bank_card = "";
                $_bargain_hunter_affinity = "";
                $_baseball = "";
                $_baseball_affinity = "";
                $_basketball = "";
                $_basketball_affinity = "";
                $_beauty_affinity = "";
                $_bible_affinity = "";
                $_bird_watching = "";
                $_birds_affinity = "";
                $_blue_collar = "";
                $_boating_sailing = "";
                $_boating_sailing_affinity = "";
                $_business_affinity = "";
                $_camping_hiking = "";
                $_camping_hiking_climbing_affinity = "";
                $_cars_interest = "";
                $_cat_owner = "";
                $_catalog_affinity = "";
                $_cigars = "";
                $_classical_music = "";
                $_coins = "";
                $_collectibles_affinity = "";
                $_college_affinity = "";
                $_computers_affinity = "";
                $_continuity_program_affinity = "";
                $_cooking_affinity = "";
                $_cosmetics = "";
                $_country_music = "";
                $_crafts_affinity = "";
                $_credit_card = "";
                $_credit_repair_affinity = "";
                $_crochet_affinity = "";
                $_diet_affinity = "";
                $_dieting = "";
                $_do_it_yourself_affinity = "";
                $_dog_owner = "";
                $_doll_collector = "";
                $_donor_affinity = "";
                $_education = "";
                $_education_ordinal = "";
                $_education_seekers_affinity = "";
                $_ego_affinity = "";
                $_entertainment_interest = "";
                $_figurines_collector = "";
                $_fine_arts_collector = "";
                $_fishing = "";
                $_fishing_affinity = "";
                $_fitness_affinity = "";
                $_football = "";
                $_football_affinity = "";
                $_gambling = "";
                $_gambling_affinity = "";
                $_games_affinity = "";
                $_gardening_affinity = "";
                $_gender = "";
                $_generation_ordinal = "";
                $_golf = "";
                $_golf_affinity = "";
                $_gourmet_affinity = "";
                $_grandparents_affinity = "";
                $_health_affinity = "";
                $_healthy_living = "";
                $_healthy_living_interest = "";
                $_high_tech_affinity = "";
                $_hispanic_affinity = "";
                $_hockey = "";
                $_hockey_affinity = "";
                $_home_decor = "";
                $_home_improvement_interest = "";
                $_home_office_affinity = "";
                $_home_study = "";
                $_hunting = "";
                $_hunting_affinity = "";
                $_jazz = "";
                $_kids_apparel_affinity = "";
                $_knit_affinity = "";
                $_knitting_quilting_sewing = "";
                $_luxury_life = "";
                $_married = "";
                $_median_income = "";
                $_mens_apparel_affinity = "";
                $_mens_fashion_affinity = "";
                $_mortgage_age = "";
                $_mortgage_amount = "";
                $_mortgage_loan_type = "";
                $_mortgage_refi_age = "";
                $_mortgage_refi_amount = "";
                $_mortgage_refi_type = "";
                $_motor_racing = "";
                $_motorcycles = "";
                $_motorcycles_affinity = "";
                $_movies = "";
                $_nascar = "";
                $_needlepoint_affinity = "";
                $_new_credit_offered_household = "";
                $_num_credit_lines_household = "";
                $_num_generations_household = "";
                $_outdoors = "";
                $_outdoors_affinity = "";
                $_owns_investments = "";
                $_owns_mutual_funds = "";
                $_owns_stocks_and_bonds = "";
                $_owns_swimming_pool = "";
                $_personal_finance_affinity = "";
                $_personality = "";
                $_plates_collector = "";
                $_pop_density = "";
                $_premium_amex_card = "";
                $_premium_card = "";
                $_premium_income_household = "";
                $_premium_income_midpt_household = "";
                $_quilt_affinity = "";
                $_religious_music = "";
                $_rhythm_and_blues = "";
                $_rock_music = "";
                $_running = "";
                $_rv = "";
                $_scuba = "";
                $_self_improvement = "";
                $_sewing_affinity = "";
                $_single_family_dwelling = "";
                $_snow_skiing = "";
                $_snow_skiing_affinity = "";
                $_soccer = "";
                $_soccer_affinity = "";
                $_soft_rock = "";
                $_soho_business = "";
                $_sports_memoribilia_collector = "";
                $_stamps = "";
                $_sweepstakes_affinity = "";
                $_tennis = "";
                $_tennis_affinity = "";
                $_tobacco_affinity = "";
                $_travel_affinity = "";
                $_travel_cruise_affinity = "";
                $_travel_cruises = "";
                $_travel_personal = "";
                $_travel_rv_affinity = "";
                $_travel_us_affinity = "";
                $_truck_owner = "";
                $_trucks_affinity = "";
                $_tv_movies_affinity = "";
                $_veteran_household = "";
                $_walking = "";
                $_weight_lifting = "";
                $_wildlife_affinity = "";
                $_womens_apparel_affinity = "";
                $_womens_fashion_affinity = "";
                $_woodworking = "";
                $_male_aux = "";
                $_political_contributor_aux = "";
                $_political_party_aux = "";
                $_financial_power = "";
                $_mortgage_open_1st_intent = "";
                $_mortgage_open_2nd_intent = "";
                $_mortgage_new_intent = "";
                $_mortgage_refinance_intent = "";
                $_automotive_loan_intent = "";
                $_bank_card_intent = "";
                $_personal_loan_intent = "";
                $_retail_card_intent = "";
                $_student_loan_cons_intent = "";
                $_student_loan_intent = "";
                $_3qtr_baths = "";
                $_ac_type = "";
                $_acres = "";
                $_additions_square_feet = "";
                $_assess_val_impr = "";
                $_assess_val_lnd = "";
                $_assess_val_prop = "";
                $_bldg_style = "";
                $_bsmt_sqft = "";
                $_bsmt_type = "";
                $_build_sqft_assess = "";
                $_business = "";
                $_combined_statistical_area = "";
                $_metropolitan_division = "";
                $_middle = "";
                $_middle_2 = "";
                $_mkt_ip_perc = "";
                $_mobile_home = "";

                $_mrtg_due = "";
                $_mrtg_intrate = "";
                $_mrtg_refi = "";
                $_mrtg_term = "";
                $_mrtg_type = "";

                $_mrtg2_amt = "";
                $_mrtg2_date = "";
                $_mrtg2_deed_type = "";
                $_mrtg2_due = "";
                $_mrtg2_equity = "";
                $_mrtg2_intrate = "";
                $_mrtg2_inttype = "";
                $_mrtg2_refi = "";
                $_mrtg2_term = "";
                $_mrtg2_type = "";

                $_mrtg3_amt = "";
                $_mrtg3_date = "";
                $_mrtg3_deed_type = "";
                $_mrtg3_due = "";
                $_mrtg3_equity = "";
                $_mrtg3_inttype = "";
                $_mrtg3_refi = "";
                $_mrtg3_term = "";
                $_mrtg3_type = "";

                $_msa_code = "";
                $_number_bedrooms = "";
                $_number_bldgs = "";
                $_number_fireplace = "";
                $_number_park_spaces = "";
                $_number_rooms = "";
                $_own_biz = "";
                $_owner_occupied = "";
                $_ownership_relation = "";
                $_owner_type_description = "";
                $_estimated_value = "";
                $_ext_type = "";
                $_finish_square_feet2 = "";
                $_fireplace = "";
                $_first = "";
                $_first_2 = "";
                $_found_type = "";
                $_fr_feet = "";
                $_fuel_type = "";
                $_full_baths = "";
                $_half_baths = "";
                $_garage_type = "";
                $_grnd_sqft = "";
                $_heat_type = "";
                $_hmstd = "";
                $_impr_appr_val = "";
                $_imprval = "";
                $_imprval_type = "";
                $_land_appr_val = "";
                $_landval = "";
                $_landval_type = "";
                $_last = "";
                $_last_2 = "";
                $_lat = "";
                $_lender_name = "";
                $_lender2_name = "";
                $_lender3_name = "";
                $_loan_amt = "";
                $_loan_date = "";
                $_loan_to_val = "";
                $_lon = "";
                $_markval = "";
                $_markval_type = "";
                $_patio_porch = "";
                $_patio_square_feet = "";
                $_pool = "";
                $_porch_square_feet = "";
                $_previous_assessed_value = "";
                $_prop_type = "";
                $_rate_type = "";
                $_rec_date = "";
                $_roof_covtype = "";
                $_roof_shapetype = "";
                $_sale_amt = "";
                $_sale_amt_pr = "";
                $_sale_date = "";
                $_sale_type_pr = "";
                $_sales_type = "";
                $_sell_name = "";
                $_sewer_type = "";
                $_site_quality = "";
                $_std_address = "";
                $_std_city = "";
                $_std_state = "";
                $_std_zip = "";
                $_std_zip4 = "";
                $_stories_number = "";
                $_suffix = "";
                $_suffix_2 = "";
                $_tax_yr = "";
                $_tax_improvement_percent = "";
                $_title_co = "";
                $_tot_baths_est = "";
                $_ttl_appr_val = "";
                $_ttl_bld_sqft = "";
                $_ttl_tax = "";
                $_unit_number = "";
                $_vet_exempt = "";
                $_water_type = "";

            //unregistered row

        //ADVANCE INFORMATION


        $_Description = $dataflow . "dataNotExistOnDBBDMTD|" . $failedRecordID;

        $trackBigBDM = "BDMLOCALCUSTOM";

        $is_advance = false;
        if ($is_local_custom['is_advance'] && !empty($is_local_custom['advance'])) {//this condition only for decide which BIGDBM API to hit. basic or advance 
            $is_advance = true;// if selected fields for advance empty, just hit the basic API
        }

        // if ($is_local_custom['is_advance']) {
        //     $local_advance_exist = true; // this variable to set the campaign will be charged or not
        // }
        
        // ADVANCE LEADS       
            $label_info = $is_advance ? 'Advance' : '';
            Log::info("Start Check BigBDM MD5 " . $label_info);      
            $startBigbdmMD5Time = microtime(true);

            $bigBDM_MD5_process = $this->bigBDM_MD5($md5param,$leadspeek_api_id,$leadspeektype,$is_advance);

            $endBigbdmMD5Time = microtime(true);

            // convert epochtime to date format ('Y-m-d H:i:s')
            $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
            $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
            // convert epochtime to date format ('Y-m-d H:i:s')

            $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
            $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

            $label_extime = $is_advance ? 'bigBDM_MD5_advance' : 'bigBDM_MD5';
            $executionTimeList[$label_extime] = [
                'start_execution_time' => $startBigbdmMD5Date,
                'end_execution_time' => $endBigbdmMD5Date,
                'total_execution_time' => $totalBigbdmMD5Time,
            ];


            /** IF BIG BDM MD5 HAVE RESULT */
            $new_advance = [];
            if (count((array)$bigBDM_MD5_process) > 0) {
                Log::info("BigBDMAdvance Have result");

                $label_track =  $is_advance ? "->MD5Advance" : "->MD5" ;
                $trackBigBDM = $trackBigBDM . $label_track;
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
                /** REPORT ANALYTIC */

                foreach ($bigBDM_MD5_process as $rd => $a) {

                //BASIC INFORMATION
                    $_FirstName = (isset($a[0]->First_Name))?$a[0]->First_Name:'';
                    $_LastName = (isset($a[0]->Last_Name))?$a[0]->Last_Name:'';

                    // $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                    if(isset($a[0]->Addr_Primary)){
                        $_Address1 = (isset($a[0]->Addr_Primary))?$a[0]->Addr_Primary:'';
                    }else{
                        $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                    }
                    if(isset($a[0]->Addr_Secondary)){
                        $_Address2 = (isset($a[0]->Addr_Secondary))?$a[0]->Addr_Secondary:'';
                    }
                    $_City =  (isset($a[0]->City))?$a[0]->City:'';
                    $_State = (isset($a[0]->State))?$a[0]->State:'';
                    $_Zipcode = (isset($a[0]->Zip))?$a[0]->Zip:'';

                    //process email
                    if ($is_advance) {
                        $email1 = isset($a[0]->Email_1) ? $a[0]->Email_1 : '';
                        $email2 = isset($a[0]->Email_2) ? $a[0]->Email_2 : '';
                        $email3 = isset($a[0]->Email_3) ? $a[0]->Email_3 : '';
                        $email_array = array_filter([$email1, $email2, $email3]); 
                        $bigEmail = $email_array;
                    }else {
                        $bigEmail = (isset($a[0]->Email))?$a[0]->Email:'';
                        $bigEmail = explode(",",$bigEmail);
                    }
                    //process email  
                    
                    //process phone
                    if ($is_advance) {
                        $_mobile_phone = (isset($a[0]->Mobile_Phone_1))?$a[0]->Mobile_Phone_1:'';
                        $_mobile_phone2 = (isset($a[0]->Mobile_Phone_2))?$a[0]->Mobile_Phone_2:'';
                        $_mobile_phone3 = (isset($a[0]->Mobile_Phone_3))?$a[0]->Mobile_Phone_3:'';
                    }else {
                        $bigPhone = (isset($a[0]->Phone))?$a[0]->Phone:'';
                        $bigPhone = explode(",",$bigPhone);
                        $_mobile_phone = $bigPhone[0];
                        $_mobile_phone2 = (isset($bigPhone[1]))?$bigPhone[1]:'';
                    }
                    //process phone

                //BASIC INFORMATION

                if ($is_advance) 
                {
                //ADVANCE INFORMATION

                    //identification
                        $_gender_aux = (isset($a[0]->Gender_aux))?$a[0]->Gender_aux:'';
                        $_age_aux = (isset($a[0]->Age_aux)) ? $a[0]->Age_aux : '';
                        $_birth_year_aux = (isset($a[0]->Birth_Year_aux)) ? $a[0]->Birth_Year_aux : '';
                        $_generation = (isset($a[0]->Generation)) ? $a[0]->Generation : '';
                        $_marital_status = (isset($a[0]->Marital_Status))?$a[0]->Marital_Status:'';
                    //identification
                    
                    //financial information
                        $_household_income = (isset($a[0]->Income_HH))?$a[0]->Income_HH:'';
                        $_median_household_income = (isset($a[0]->Income_Midpts_HH))?$a[0]->Income_Midpts_HH:'';
                        $_household_net_worth = (isset($a[0]->Net_Worth_HH))?$a[0]->Net_Worth_HH:'';
                        $_median_household_net_worth = (isset($a[0]->Net_Worth_Midpt_HH))?$a[0]->Net_Worth_Midpt_HH:'';
                        $_discretionary_income = (isset($a[0]->Discretionary_Income)) ? $a[0]->Discretionary_Income : '';
                        $_credit_score_median = (isset($a[0]->Credit_Midpts)) ? $a[0]->Credit_Midpts : '';
                        $_credit_score_range = (isset($a[0]->Credit_Range)) ? $a[0]->Credit_Range : '';
                    //financial information

                    //occupation
                        $_occupation_category = (isset($a[0]->Occupation_Category)) ? $a[0]->Occupation_Category : '';
                        $_occupation_type =(isset($a[0]->Occupation_Type)) ? $a[0]->Occupation_Type : '';
                        $_occupation_detail = (isset($a[0]->Occupation_Detail)) ? $a[0]->Occupation_Detail : '';
                    //occupation
                    
                    //miscellaneous
                        $_voter = (isset($a[0]->Voter)) ? $a[0]->Voter : '';
                        $_urbanicity = (isset($a[0]->Urbanicity)) ? $a[0]->Urbanicity : '';
                    //miscellaneous

                    //contact information
                        $_mobile_phone_dnc = (isset($a[0]->Mobile_Phone_1_DNC))?$a[0]->Mobile_Phone_1_DNC:'';
                        $_mobile_phone_dnc2 = (isset($a[0]->Mobile_Phone_2_DNC))?$a[0]->Mobile_Phone_2_DNC:'';
                        $_mobile_phone_dnc3 = (isset($a[0]->Mobile_Phone_3_DNC))?$a[0]->Mobile_Phone_3_DNC:'';

                        $_tax_bill_mailing_address = (isset($a[0]->TaxBillMailingAddress))?$a[0]->TaxBillMailingAddress:'';
                        $_tax_bill_mailing_city = (isset($a[0]->TaxBillMailingCity))?$a[0]->TaxBillMailingCity:'';
                        $_tax_bill_mailing_county = (isset($a[0]->TaxBillMailingCounty))?$a[0]->TaxBillMailingCounty:'';
                        $_tax_bill_mailing_fips = (isset($a[0]->TaxBillMailingFIPs))?$a[0]->TaxBillMailingFIPs:'';
                        $_tax_bill_mailing_state = (isset($a[0]->TaxBillMailingState))?$a[0]->TaxBillMailingState:'';
                        $_tax_bill_mailing_zip = (isset($a[0]->TaxBillMailingZip))?$a[0]->TaxBillMailingZip:'';
                        $_tax_bill_mailing_zip4 = (isset($a[0]->TaxBillMailingZip4))?$a[0]->TaxBillMailingZip4:'';
                    //contact information

                    //household information
                        $_num_adults_household= (isset($a[0]->Num_Adults_HH))?$a[0]->Num_Adults_HH:'';
                        $_num_children_household = (isset($a[0]->Num_Children_HH))?$a[0]->Num_Children_HH:'';
                        $_num_persons_household = (isset($a[0]->Num_Persons_HH))?$a[0]->Num_Persons_HH:'';
                        $_child_aged_0_3_household = (isset($a[0]->Child_Aged_0_3_HH))?$a[0]->Child_Aged_0_3_HH:'';
                        $_child_aged_4_6_household = (isset($a[0]->Child_Aged_4_6_HH))?$a[0]->Child_Aged_4_6_HH:'';
                        $_child_aged_7_9_household = (isset($a[0]->Child_Aged_7_9_HH))?$a[0]->Child_Aged_7_9_HH:'';
                        $_child_aged_10_12_household = (isset($a[0]->Child_Aged_10_12_HH))?$a[0]->Child_Aged_10_12_HH:'';
                        $_child_aged_13_18_household = (isset($a[0]->Child_Aged_13_18_HH))?$a[0]->Child_Aged_13_18_HH:'';
                        $_children_household = (isset($a[0]->Children_HH))?$a[0]->Children_HH:'';
                    //household information

                    //marketing indicators
                        $_has_email = (isset($a[0]->HasEmail))?$a[0]->HasEmail:'';
                        $_has_phone = (isset($a[0]->HasPhone))?$a[0]->HasPhone:'';
                        $_magazine_subscriber = (isset($a[0]->Magazine_Subscriber))?$a[0]->Magazine_Subscriber:'';
                        $_charity_interest = (isset($a[0]->Charity_Interest))?$a[0]->Charity_Interest:'';
                        $_likely_charitable_donor = (isset($a[0]->Likely_Charitable_Donor))?$a[0]->Likely_Charitable_Donor:'';     
                    //marketing indicators

                    //house and real estate
                        $_dwelling_type = (isset($a[0]->Dwelling_Type))?$a[0]->Dwelling_Type:'';     
                        $_home_owner = (isset($a[0]->Home_Owner))?$a[0]->Home_Owner:'';     
                        $_home_owner_ordinal = (isset($a[0]->Home_Owner_Ordinal))?$a[0]->Home_Owner_Ordinal:'';     
                        $_length_of_residence = (isset($a[0]->Length_of_Residence))?$a[0]->Length_of_Residence:'';     
                        $_home_price = (isset($a[0]->Home_Price))?$a[0]->Home_Price:'';     
                        $_home_value = (isset($a[0]->Home_Value))?$a[0]->Home_Value:'';     
                        $_median_home_value = (isset($a[0]->Median_Home_Value))?$a[0]->Median_Home_Value:'';  
                        $_living_sqft = (isset($a[0]->LIVING_SQFT))?$a[0]->LIVING_SQFT:'';  
                        $_year_built_original = (isset($a[0]->YR_BUILT_ORIG))?$a[0]->YR_BUILT_ORIG:'';  
                        $_year_built_range = (isset($a[0]->YR_BUILT_RANGE))?$a[0]->YR_BUILT_RANGE:'';  
                        $_lot_number = (isset($a[0]->LotNumber))?$a[0]->LotNumber:'';  
                        $_legal_description = (isset($a[0]->LegalDescription))?$a[0]->LegalDescription:'';  
                        $_land_sqft = (isset($a[0]->LAND_SQFT))?$a[0]->LAND_SQFT:'';  
                        $_garage_sqft = (isset($a[0]->GAR_SQFT))?$a[0]->GAR_SQFT:'';  
                        $_subdivision = (isset($a[0]->SUBDIVISION))?$a[0]->SUBDIVISION:'';  
                        $_zoning_code = (isset($a[0]->ZONING_CODE))?$a[0]->ZONING_CODE:'';  
                    //house and real estate

                    //interest and affinities
                        $_cooking = (isset($a[0]->Cooking))?$a[0]->Cooking:'';  
                        $_gardening = (isset($a[0]->Gardening))?$a[0]->Gardening:''; 
                        $_music = (isset($a[0]->Music))?$a[0]->Music:''; 
                        $_diy =  (isset($a[0]->DIY))?$a[0]->DIY:''; 
                        $_books = (isset($a[0]->Books))?$a[0]->Books:''; 
                        $_travel_vacation = (isset($a[0]->Travel_Vacation))?$a[0]->Travel_Vacation:''; 
                        $_health_beauty_products = (isset($a[0]->Health_Beauty_Products))?$a[0]->Health_Beauty_Products:''; 
                        $_pet_owner = (isset($a[0]->Pet_Owner))?$a[0]->Pet_Owner:''; 
                        $_photography = (isset($a[0]->Photography))?$a[0]->Photography:''; 
                        $_fitness = (isset($a[0]->Fitness))?$a[0]->Fitness:''; 
                        $_epicurean = (isset($a[0]->Epicurean))?$a[0]->Epicurean:''; 
                    //interest and affinities

                    //location and census data
                        $_cbsa = (isset($a[0]->Cbsa))?$a[0]->Cbsa:''; 
                        $_census_block = (isset($a[0]->Census_Block))?$a[0]->Census_Block:''; 
                        $_census_block_group = (isset($a[0]->Census_Block_Group))?$a[0]->Census_Block_Group:''; 
                        $_census_tract = (isset($a[0]->Census_Tract))?$a[0]->Census_Tract:''; 
                    //location and census data

                //ADVANCE INFORMATION

                //unregistered row
                    $_aerobics = (isset($a[0]->Aerobics)) ? $a[0]->Aerobics : '';
                    $_african_american_affinity = (isset($a[0]->African_American_Affinity)) ? $a[0]->African_American_Affinity : '';
                    $_amex_card = (isset($a[0]->AMEX_Card)) ? $a[0]->AMEX_Card : '';
                    $_antiques = (isset($a[0]->Antiques)) ? $a[0]->Antiques : '';
                    $_apparel_accessory_affinity = (isset($a[0]->Apparel_Accessory_Affinity)) ? $a[0]->Apparel_Accessory_Affinity : '';
                    $_apparel_affinity = (isset($a[0]->Apparel_Affinity)) ? $a[0]->Apparel_Affinity : '';
                    $_arts_and_crafts = (isset($a[0]->Arts_and_Crafts)) ? $a[0]->Arts_and_Crafts : '';
                    $_asian_affinity = (isset($a[0]->Asian_Affinity)) ? $a[0]->Asian_Affinity : '';
                    $_auto_affinity = (isset($a[0]->Auto_Affinity)) ? $a[0]->Auto_Affinity : '';
                    $_auto_racing_affinity = (isset($a[0]->Auto_Racing_Affinity)) ? $a[0]->Auto_Racing_Affinity : '';
                    $_aviation_affinity = (isset($a[0]->Aviation_Affinity)) ? $a[0]->Aviation_Affinity : '';
                    $_bank_card = (isset($a[0]->Bank_Card)) ? $a[0]->Bank_Card : '';
                    $_bargain_hunter_affinity = (isset($a[0]->Bargain_Hunter_Affinity)) ? $a[0]->Bargain_Hunter_Affinity : '';
                    $_baseball = (isset($a[0]->Baseball)) ? $a[0]->Baseball : '';
                    $_baseball_affinity = (isset($a[0]->Baseball_Affinity)) ? $a[0]->Baseball_Affinity : '';
                    $_basketball = (isset($a[0]->Basketball)) ? $a[0]->Basketball : '';
                    $_basketball_affinity = (isset($a[0]->Basketball_Affinity)) ? $a[0]->Basketball_Affinity : '';
                    $_beauty_affinity = (isset($a[0]->Beauty_Affinity)) ? $a[0]->Beauty_Affinity : '';
                    $_bible_affinity = (isset($a[0]->Bible_Affinity)) ? $a[0]->Bible_Affinity : '';
                    $_bird_watching = (isset($a[0]->Bird_watching)) ? $a[0]->Bird_watching : '';
                    $_birds_affinity = (isset($a[0]->Birds_Affinity)) ? $a[0]->Birds_Affinity : '';
                    $_blue_collar = (isset($a[0]->Blue_Collar)) ? $a[0]->Blue_Collar : '';
                    $_boating_sailing = (isset($a[0]->Boating_Sailing)) ? $a[0]->Boating_Sailing : '';
                    $_boating_sailing_affinity = (isset($a[0]->Boating_Sailing_Affinity)) ? $a[0]->Boating_Sailing_Affinity : '';
                    $_business_affinity = (isset($a[0]->Business_Affinity)) ? $a[0]->Business_Affinity : '';
                    $_camping_hiking = (isset($a[0]->Camping_Hiking)) ? $a[0]->Camping_Hiking : '';
                    $_camping_hiking_climbing_affinity = (isset($a[0]->Camping_Hiking_Climbing_Affinity)) ? $a[0]->Camping_Hiking_Climbing_Affinity : '';
                    $_cars_interest = (isset($a[0]->Cars_Interest)) ? $a[0]->Cars_Interest : '';
                    $_cat_owner = (isset($a[0]->Cat_Owner)) ? $a[0]->Cat_Owner : '';
                    $_catalog_affinity = (isset($a[0]->Catalog_Affinity)) ? $a[0]->Catalog_Affinity : '';
                    $_cigars = (isset($a[0]->Cigars)) ? $a[0]->Cigars : '';
                    $_classical_music = (isset($a[0]->Classical_Music)) ? $a[0]->Classical_Music : '';
                    $_coins = (isset($a[0]->Coins)) ? $a[0]->Coins : '';
                    $_collectibles_affinity = (isset($a[0]->Collectibles_Affinity)) ? $a[0]->Collectibles_Affinity : '';
                    $_college_affinity = (isset($a[0]->College_Affinity)) ? $a[0]->College_Affinity : '';
                    $_computers_affinity = (isset($a[0]->Computers_Affinity)) ? $a[0]->Computers_Affinity : '';
                    $_continuity_program_affinity = (isset($a[0]->Continuity_Program_Affinity)) ? $a[0]->Continuity_Program_Affinity : '';
                    $_cooking_affinity = (isset($a[0]->Cooking_Affinity)) ? $a[0]->Cooking_Affinity : '';
                    $_cosmetics = (isset($a[0]->Cosmetics)) ? $a[0]->Cosmetics : '';
                    $_country_music = (isset($a[0]->Country_Music)) ? $a[0]->Country_Music : '';
                    $_crafts_affinity = (isset($a[0]->Crafts_Affinity)) ? $a[0]->Crafts_Affinity : '';
                    $_credit_card = (isset($a[0]->Credit_Card)) ? $a[0]->Credit_Card : '';
                    $_credit_repair_affinity = (isset($a[0]->Credit_Repair_Affinity)) ? $a[0]->Credit_Repair_Affinity : '';
                    $_crochet_affinity = (isset($a[0]->Crochet_Affinity)) ? $a[0]->Crochet_Affinity : '';
                    $_diet_affinity = (isset($a[0]->Diet_Affinity)) ? $a[0]->Diet_Affinity : '';
                    $_dieting = (isset($a[0]->Dieting)) ? $a[0]->Dieting : '';
                    $_do_it_yourself_affinity = (isset($a[0]->Do_it_Yourself_Affinity)) ? $a[0]->Do_it_Yourself_Affinity : '';
                    $_dog_owner = (isset($a[0]->Dog_Owner)) ? $a[0]->Dog_Owner : '';
                    $_doll_collector = (isset($a[0]->Doll_Collector)) ? $a[0]->Doll_Collector : '';
                    $_donor_affinity = (isset($a[0]->Donor_Affinity)) ? $a[0]->Donor_Affinity : '';
                    $_education = (isset($a[0]->Education)) ? $a[0]->Education : '';
                    $_education_ordinal = (isset($a[0]->Education_Ordinal)) ? $a[0]->Education_Ordinal : '';
                    $_education_seekers_affinity = (isset($a[0]->Education_Seekers_Affinity)) ? $a[0]->Education_Seekers_Affinity : '';
                    $_ego_affinity = (isset($a[0]->EGO_Affinity)) ? $a[0]->EGO_Affinity : '';
                    $_entertainment_interest = (isset($a[0]->Entertainment_Interest)) ? $a[0]->Entertainment_Interest : '';
                    $_figurines_collector = (isset($a[0]->Figurines_Collector)) ? $a[0]->Figurines_Collector : '';
                    $_fine_arts_collector = (isset($a[0]->Fine_Arts_Collector)) ? $a[0]->Fine_Arts_Collector : '';
                    $_fishing = (isset($a[0]->Fishing)) ? $a[0]->Fishing : '';
                    $_fishing_affinity = (isset($a[0]->Fishing_Affinity)) ? $a[0]->Fishing_Affinity : '';
                    $_football = (isset($a[0]->Football)) ? $a[0]->Football : '';
                    $_football_affinity = (isset($a[0]->Football_Affinity)) ? $a[0]->Football_Affinity : '';
                    $_gambling = (isset($a[0]->Gambling)) ? $a[0]->Gambling : '';
                    $_gambling_affinity = (isset($a[0]->Gambling_Affinity)) ? $a[0]->Gambling_Affinity : '';
                    $_games_affinity = (isset($a[0]->Games_Affinity)) ? $a[0]->Games_Affinity : '';
                    $_gardening_affinity = (isset($a[0]->Gardening_Affinity)) ? $a[0]->Gardening_Affinity : '';
                    $_generation_ordinal = (isset($a[0]->Generation_Ordinal)) ? $a[0]->Generation_Ordinal : '';
                    $_golf = (isset($a[0]->Golf)) ? $a[0]->Golf : '';
                    $_golf_affinity = (isset($a[0]->Golf_Affinity)) ? $a[0]->Golf_Affinity : '';
                    $_gourmet_affinity = (isset($a[0]->Gourmet_Affinity)) ? $a[0]->Gourmet_Affinity : '';
                    $_grandparents_affinity = (isset($a[0]->Grandparents_Affinity)) ? $a[0]->Grandparents_Affinity : '';
                    $_health_affinity = (isset($a[0]->Health_Affinity)) ? $a[0]->Health_Affinity : '';
                    $_healthy_living = (isset($a[0]->Healthy_Living)) ? $a[0]->Healthy_Living : '';
                    $_healthy_living_interest = (isset($a[0]->Healthy_Living_Interest)) ? $a[0]->Healthy_Living_Interest : '';
                    $_high_tech_affinity = (isset($a[0]->High_Tech_Affinity)) ? $a[0]->High_Tech_Affinity : '';
                    $_hispanic_affinity = (isset($a[0]->Hispanic_Affinity)) ? $a[0]->Hispanic_Affinity : '';
                    $_hockey = (isset($a[0]->Hockey)) ? $a[0]->Hockey : '';
                    $_hockey_affinity = (isset($a[0]->Hockey_Affinity)) ? $a[0]->Hockey_Affinity : '';
                    $_home_decor = (isset($a[0]->Home_Decor)) ? $a[0]->Home_Decor : '';
                    $_home_improvement_interest = (isset($a[0]->Home_Improvement_Interest)) ? $a[0]->Home_Improvement_Interest : '';
                    $_home_office_affinity = (isset($a[0]->Home_Office_Affinity)) ? $a[0]->Home_Office_Affinity : '';
                    $_home_study = (isset($a[0]->Home_Study)) ? $a[0]->Home_Study : '';
                    $_hunting = (isset($a[0]->Hunting)) ? $a[0]->Hunting : '';
                    $_hunting_affinity = (isset($a[0]->Hunting_Affinity)) ? $a[0]->Hunting_Affinity : '';
                    $_jazz = (isset($a[0]->Jazz)) ? $a[0]->Jazz : '';
                    $_kids_apparel_affinity = (isset($a[0]->Kids_Apparel_Affinity)) ? $a[0]->Kids_Apparel_Affinity : '';
                    $_knit_affinity = (isset($a[0]->Knit_Affinity)) ? $a[0]->Knit_Affinity : '';
                    $_knitting_quilting_sewing = (isset($a[0]->Knitting_Quilting_Sewing)) ? $a[0]->Knitting_Quilting_Sewing : '';
                    $_luxury_life = (isset($a[0]->Luxury_Life)) ? $a[0]->Luxury_Life : '';
                    $_married = (isset($a[0]->Married)) ? $a[0]->Married : '';
                    $_median_income = (isset($a[0]->Median_Income)) ? $a[0]->Median_Income : '';
                    $_mens_apparel_affinity = (isset($a[0]->Mens_Apparel_Affinity)) ? $a[0]->Mens_Apparel_Affinity : '';
                    $_mens_fashion_affinity = (isset($a[0]->Mens_Fashion_Affinity)) ? $a[0]->Mens_Fashion_Affinity : '';
                    $_mortgage_age = (isset($a[0]->Mortgage_Age)) ? $a[0]->Mortgage_Age : '';
                    $_mortgage_amount = (isset($a[0]->Mortgage_Amount)) ? $a[0]->Mortgage_Amount : '';
                    $_mortgage_loan_type = (isset($a[0]->Mortgage_Loan_Type)) ? $a[0]->Mortgage_Loan_Type : '';
                    $_mortgage_refi_age = (isset($a[0]->Mortgage_Refi_Age)) ? $a[0]->Mortgage_Refi_Age : '';
                    $_mortgage_refi_amount = (isset($a[0]->Mortgage_Refi_Amount)) ? $a[0]->Mortgage_Refi_Amount : '';
                    $_mortgage_refi_type = (isset($a[0]->Mortgage_Refi_Type)) ? $a[0]->Mortgage_Refi_Type : '';
                    $_motor_racing = (isset($a[0]->Motor_Racing)) ? $a[0]->Motor_Racing : '';
                    $_motorcycles = (isset($a[0]->Motorcycles)) ? $a[0]->Motorcycles : '';
                    $_motorcycles_affinity = (isset($a[0]->Motorcycles_Affinity)) ? $a[0]->Motorcycles_Affinity : '';
                    $_movies = (isset($a[0]->Movies)) ? $a[0]->Movies : '';
                    $_nascar = (isset($a[0]->NASCAR)) ? $a[0]->NASCAR : '';
                    $_needlepoint_affinity = (isset($a[0]->Needlepoint_Affinity)) ? $a[0]->Needlepoint_Affinity : '';
                    $_new_credit_offered_household = (isset($a[0]->New_Credit_Offered_HH)) ? $a[0]->New_Credit_Offered_HH : '';
                    $_num_credit_lines_household = (isset($a[0]->Num_Credit_Lines_HH)) ? $a[0]->Num_Credit_Lines_HH : '';
                    $_num_generations_household = (isset($a[0]->Num_Generations_HH)) ? $a[0]->Num_Generations_HH : '';
                    $_outdoors = (isset($a[0]->Outdoors)) ? $a[0]->Outdoors : '';
                    $_outdoors_affinity = (isset($a[0]->Outdoors_Affinity)) ? $a[0]->Outdoors_Affinity : '';
                    $_owns_investments = (isset($a[0]->Owns_Investments)) ? $a[0]->Owns_Investments : '';
                    $_owns_mutual_funds = (isset($a[0]->Owns_Mutual_Funds)) ? $a[0]->Owns_Mutual_Funds : '';
                    $_owns_stocks_and_bonds = (isset($a[0]->Owns_Stocks_And_Bonds)) ? $a[0]->Owns_Stocks_And_Bonds : '';
                    $_owns_swimming_pool = (isset($a[0]->Owns_Swimming_Pool)) ? $a[0]->Owns_Swimming_Pool : '';
                    $_personal_finance_affinity = (isset($a[0]->Personal_Finance_Affinity)) ? $a[0]->Personal_Finance_Affinity : '';
                    $_personality = (isset($a[0]->Personality)) ? $a[0]->Personality : '';
                    $_plates_collector = (isset($a[0]->Plates_Collector)) ? $a[0]->Plates_Collector : '';
                    $_pop_density = (isset($a[0]->Pop_Density)) ? $a[0]->Pop_Density : '';
                    $_premium_amex_card = (isset($a[0]->Premium_AMEX_Card)) ? $a[0]->Premium_AMEX_Card : '';
                    $_premium_card = (isset($a[0]->Premium_Card)) ? $a[0]->Premium_Card : '';
                    $_premium_income_household = (isset($a[0]->Premium_Income_HH)) ? $a[0]->Premium_Income_HH : '';
                    $_premium_income_midpt_household = (isset($a[0]->Premium_Income_Midpt_HH)) ? $a[0]->Premium_Income_Midpt_HH : '';
                    $_quilt_affinity = (isset($a[0]->Quilt_Affinity)) ? $a[0]->Quilt_Affinity : '';
                    $_religious_music = (isset($a[0]->Religious_Music)) ? $a[0]->Religious_Music : '';
                    $_rhythm_and_blues = (isset($a[0]->Rhythm_and_Blues)) ? $a[0]->Rhythm_and_Blues : '';
                    $_rock_music = (isset($a[0]->Rock_Music)) ? $a[0]->Rock_Music : '';
                    $_running = (isset($a[0]->Running)) ? $a[0]->Running : '';
                    $_rv = (isset($a[0]->RV)) ? $a[0]->RV : '';
                    $_scuba = (isset($a[0]->Scuba)) ? $a[0]->Scuba : '';
                    $_self_improvement = (isset($a[0]->Self_Improvement)) ? $a[0]->Self_Improvement : '';
                    $_sewing_affinity = (isset($a[0]->Sewing_Affinity)) ? $a[0]->Sewing_Affinity : '';
                    $_single_family_dwelling = (isset($a[0]->Single_Family_Dwelling)) ? $a[0]->Single_Family_Dwelling : '';
                    $_snow_skiing = (isset($a[0]->Snow_Skiing)) ? $a[0]->Snow_Skiing : '';
                    $_snow_skiing_affinity = (isset($a[0]->Snow_Skiing_Affinity)) ? $a[0]->Snow_Skiing_Affinity : '';
                    $_soccer = (isset($a[0]->Soccer)) ? $a[0]->Soccer : '';
                    $_soccer_affinity = (isset($a[0]->Soccer_Affinity)) ? $a[0]->Soccer_Affinity : '';
                    $_soft_rock = (isset($a[0]->Soft_Rock)) ? $a[0]->Soft_Rock : '';
                    $_soho_business = (isset($a[0]->SOHO_Business)) ? $a[0]->SOHO_Business : '';
                    $_sports_memoribilia_collector = (isset($a[0]->Sports_Memoribilia_Collector)) ? $a[0]->Sports_Memoribilia_Collector : '';
                    $_stamps = (isset($a[0]->Stamps)) ? $a[0]->Stamps : '';
                    $_sweepstakes_affinity = (isset($a[0]->Sweepstakes_Affinity)) ? $a[0]->Sweepstakes_Affinity : '';
                    $_tennis = (isset($a[0]->Tennis)) ? $a[0]->Tennis : '';
                    $_tennis_affinity = (isset($a[0]->Tennis_Affinity)) ? $a[0]->Tennis_Affinity : '';
                    $_tobacco_affinity = (isset($a[0]->Tobacco_Affinity)) ? $a[0]->Tobacco_Affinity : '';
                    $_travel_affinity = (isset($a[0]->Travel_Affinity)) ? $a[0]->Travel_Affinity : '';
                    $_travel_cruise_affinity = (isset($a[0]->Travel_Cruise_Affinity)) ? $a[0]->Travel_Cruise_Affinity : '';
                    $_travel_cruises = (isset($a[0]->Travel_Cruises)) ? $a[0]->Travel_Cruises : '';
                    $_travel_personal = (isset($a[0]->Travel_Personal)) ? $a[0]->Travel_Personal : '';
                    $_travel_rv_affinity = (isset($a[0]->Travel_RV_Affinity)) ? $a[0]->Travel_RV_Affinity : '';
                    $_travel_us_affinity = (isset($a[0]->Travel_US_Affinity)) ? $a[0]->Travel_US_Affinity : '';
                    $_truck_owner = (isset($a[0]->Truck_Owner)) ? $a[0]->Truck_Owner : '';
                    $_trucks_affinity = (isset($a[0]->Trucks_Affinity)) ? $a[0]->Trucks_Affinity : '';
                    $_tv_movies_affinity = (isset($a[0]->TV_Movies_Affinity)) ? $a[0]->TV_Movies_Affinity : '';
                    $_veteran_household = (isset($a[0]->Veteran_HH)) ? $a[0]->Veteran_HH : '';
                    $_walking = (isset($a[0]->Walking)) ? $a[0]->Walking : '';
                    $_weight_lifting = (isset($a[0]->Weight_Lifting)) ? $a[0]->Weight_Lifting : '';
                    $_wildlife_affinity = (isset($a[0]->Wildlife_Affinity)) ? $a[0]->Wildlife_Affinity : '';
                    $_womens_apparel_affinity = (isset($a[0]->Womens_Apparel_Affinity)) ? $a[0]->Womens_Apparel_Affinity : '';
                    $_womens_fashion_affinity = (isset($a[0]->Womens_Fashion_Affinity)) ? $a[0]->Womens_Fashion_Affinity : '';
                    $_woodworking = (isset($a[0]->Woodworking)) ? $a[0]->Woodworking : '';
                    $_gender = (isset($a[0]->Gender)) ? $a[0]->Gender : '';
                    $_male_aux = (isset($a[0]->Male_aux)) ? $a[0]->Male_aux : '';
                    $_political_contributor_aux = (isset($a[0]->Political_Contributor_aux)) ? $a[0]->Political_Contributor_aux : '';
                    $_political_party_aux = (isset($a[0]->Political_Party_aux)) ? $a[0]->Political_Party_aux : '';
                    $_financial_power = (isset($a[0]->Financial_Power)) ? $a[0]->Financial_Power : '';
                    $_mortgage_open_1st_intent = (isset($a[0]->Mortgage_Open1st_Intent)) ? $a[0]->Mortgage_Open1st_Intent : '';
                    $_mortgage_open_2nd_intent = (isset($a[0]->Mortgage_Open2nd_Intent)) ? $a[0]->Mortgage_Open2nd_Intent : '';
                    $_mortgage_new_intent = (isset($a[0]->Mortgage_New_Intent)) ? $a[0]->Mortgage_New_Intent : '';
                    $_mortgage_refinance_intent = (isset($a[0]->Mortgage_Refinance_Intent)) ? $a[0]->Mortgage_Refinance_Intent : '';
                    $_automotive_loan_intent = (isset($a[0]->Automotive_Loan_Intent)) ? $a[0]->Automotive_Loan_Intent : '';
                    $_bank_card_intent = (isset($a[0]->Bank_Card_Intent)) ? $a[0]->Bank_Card_Intent : '';
                    $_personal_loan_intent = (isset($a[0]->Personal_Loan_Intent)) ? $a[0]->Personal_Loan_Intent : '';
                    $_retail_card_intent = (isset($a[0]->Retail_Card_Intent)) ? $a[0]->Retail_Card_Intent : '';
                    $_student_loan_cons_intent = (isset($a[0]->Student_Loan_Cons_Intent)) ? $a[0]->Student_Loan_Cons_Intent : '';
                    $_student_loan_intent = (isset($a[0]->Student_Loan_Intent)) ? $a[0]->Student_Loan_Intent : '';
                    $_3qtr_baths = (isset($a[0]) && property_exists($a[0], '3QTR_BATHS')) ? $a[0]->{'3QTR_BATHS'} : '';
                    $_ac_type = (isset($a[0]->AC_TYPE)) ? $a[0]->AC_TYPE : '';
                    $_acres = (isset($a[0]->ACRES)) ? $a[0]->ACRES : '';
                    $_additions_square_feet = (isset($a[0]->AdditionsSquareFeet)) ? $a[0]->AdditionsSquareFeet : '';
                    $_assess_val_impr = (isset($a[0]->ASSESS_VAL_IMPR)) ? $a[0]->ASSESS_VAL_IMPR : '';
                    $_assess_val_lnd = (isset($a[0]->ASSESS_VAL_LND)) ? $a[0]->ASSESS_VAL_LND : '';
                    $_assess_val_prop = (isset($a[0]->ASSESS_VAL_PROP)) ? $a[0]->ASSESS_VAL_PROP : '';
                    $_bldg_style = (isset($a[0]->BLDG_STYLE)) ? $a[0]->BLDG_STYLE : '';
                    $_bsmt_sqft = (isset($a[0]->BSMT_SQFT)) ? $a[0]->BSMT_SQFT : '';
                    $_bsmt_type = (isset($a[0]->BSMT_TYPE)) ? $a[0]->BSMT_TYPE : '';
                    $_build_sqft_assess = (isset($a[0]->BUILD_SQFT_ASSESS)) ? $a[0]->BUILD_SQFT_ASSESS : '';
                    $_business = (isset($a[0]->BUSINESS)) ? $a[0]->BUSINESS : '';
                    $_combined_statistical_area = (isset($a[0]->CombinedStatisticalArea)) ? $a[0]->CombinedStatisticalArea : '';
                    $_metropolitan_division = (isset($a[0]->MetropolitanDivision)) ? $a[0]->MetropolitanDivision : '';
                    $_middle = (isset($a[0]->MIDDLE)) ? $a[0]->MIDDLE : '';
                    $_middle_2 = (isset($a[0]->MIDDLE2)) ? $a[0]->MIDDLE2 : '';
                    $_mkt_ip_perc = (isset($a[0]->Mkt_Ip_Perc)) ? $a[0]->Mkt_Ip_Perc : '';
                    $_mobile_home = (isset($a[0]->MOBILE_HOME)) ? $a[0]->MOBILE_HOME : '';
                    $_mrtg_due = (isset($a[0]->MRTG_DUE)) ? $a[0]->MRTG_DUE : '';
                    $_mrtg_intrate = (isset($a[0]->MRTG_INTRATE)) ? $a[0]->MRTG_INTRATE : '';
                    $_mrtg_refi = (isset($a[0]->MRTG_REFI)) ? $a[0]->MRTG_REFI : '';
                    $_mrtg_term = (isset($a[0]->MRTG_TERM)) ? $a[0]->MRTG_TERM : '';
                    $_mrtg_type = (isset($a[0]->MRTG_TYPE)) ? $a[0]->MRTG_TYPE : '';
                    $_mrtg2_amt = (isset($a[0]->MRTG2_AMT)) ? $a[0]->MRTG2_AMT : '';
                    $_mrtg2_date = (isset($a[0]->MRTG2_DATE)) ? $a[0]->MRTG2_DATE : '';
                    $_mrtg2_deed_type = (isset($a[0]->MRTG2_DEED_TYPE)) ? $a[0]->MRTG2_DEED_TYPE : '';
                    $_mrtg2_due = (isset($a[0]->MRTG2_DUE)) ? $a[0]->MRTG2_DUE : '';
                    $_mrtg2_equity = (isset($a[0]->MRTG2_EQUITY)) ? $a[0]->MRTG2_EQUITY : '';
                    $_mrtg2_intrate = (isset($a[0]->MRTG2_INTRATE)) ? $a[0]->MRTG2_INTRATE : '';
                    $_mrtg2_inttype = (isset($a[0]->MRTG2_INTTYPE)) ? $a[0]->MRTG2_INTTYPE : '';
                    $_mrtg2_refi = (isset($a[0]->MRTG2_REFI)) ? $a[0]->MRTG2_REFI : '';
                    $_mrtg2_term = (isset($a[0]->MRTG2_TERM)) ? $a[0]->MRTG2_TERM : '';
                    $_mrtg2_type = (isset($a[0]->MRTG2_TYPE)) ? $a[0]->MRTG2_TYPE : '';
                    $_mrtg3_amt = (isset($a[0]->MRTG3_AMT)) ? $a[0]->MRTG3_AMT : '';
                    $_mrtg3_date = (isset($a[0]->MRTG3_DATE)) ? $a[0]->MRTG3_DATE : '';
                    $_mrtg3_deed_type = (isset($a[0]->MRTG3_DEED_TYPE)) ? $a[0]->MRTG3_DEED_TYPE : '';
                    $_mrtg3_due = (isset($a[0]->MRTG3_DUE)) ? $a[0]->MRTG3_DUE : '';
                    $_mrtg3_equity = (isset($a[0]->MRTG3_EQUITY)) ? $a[0]->MRTG3_EQUITY : '';
                    $_mrtg3_inttype = (isset($a[0]->MRTG3_INTTYPE)) ? $a[0]->MRTG3_INTTYPE : '';
                    $_mrtg3_refi = (isset($a[0]->MRTG3_REFI)) ? $a[0]->MRTG3_REFI : '';
                    $_mrtg3_term = (isset($a[0]->MRTG3_TERM)) ? $a[0]->MRTG3_TERM : '';
                    $_mrtg3_type = (isset($a[0]->MRTG3_TYPE)) ? $a[0]->MRTG3_TYPE : '';
                    $_msa_code = (isset($a[0]->MSACode)) ? $a[0]->MSACode : '';
                    $_number_bedrooms = (isset($a[0]->NMBR_BEDROOMS)) ? $a[0]->NMBR_BEDROOMS : '';
                    $_number_bldgs = (isset($a[0]->NMBR_BLDGS)) ? $a[0]->NMBR_BLDGS : '';
                    $_number_fireplace = (isset($a[0]->NMBR_FIREPLACE)) ? $a[0]->NMBR_FIREPLACE : '';
                    $_number_park_spaces = (isset($a[0]->NMBR_PARK_SPACES)) ? $a[0]->NMBR_PARK_SPACES : '';
                    $_number_rooms = (isset($a[0]->number_rooms)) ? $a[0]->number_rooms : '';
                    $_own_biz = (isset($a[0]->OWN_BIZ)) ? $a[0]->OWN_BIZ : '';
                    $_owner_occupied = (isset($a[0]->OWNER_OCCUPIED)) ? $a[0]->OWNER_OCCUPIED : '';
                    $_ownership_relation = (isset($a[0]->OwnershipRelation)) ? $a[0]->OwnershipRelation : '';
                    $_owner_type_description = (isset($a[0]->OwnerTypeDescription)) ? $a[0]->OwnerTypeDescription : '';
                    $_estimated_value = (isset($a[0]->EstimatedValue)) ? $a[0]->EstimatedValue : '';
                    $_ext_type = (isset($a[0]->EXT_TYPE)) ? $a[0]->EXT_TYPE : '';
                    $_finish_square_feet2 = (isset($a[0]->FinishSquareFeet2)) ? $a[0]->FinishSquareFeet2 : '';
                    $_fireplace = (isset($a[0]->fireplace)) ? $a[0]->fireplace : '';
                    $_first = (isset($a[0]->FIRST)) ? $a[0]->FIRST : '';
                    $_first_2 = (isset($a[0]->FIRST2)) ? $a[0]->FIRST2 : '';
                    $_found_type = (isset($a[0]->FOUND_TYPE)) ? $a[0]->FOUND_TYPE : '';
                    $_fr_feet = (isset($a[0]->FR_FEET)) ? $a[0]->FR_FEET : '';
                    $_fuel_type = (isset($a[0]->FUEL_TYPE)) ? $a[0]->FUEL_TYPE : '';
                    $_full_baths = (isset($a[0]->FULL_BATHS)) ? $a[0]->FULL_BATHS : '';
                    $_half_baths = (isset($a[0]->HALF_BATHS)) ? $a[0]->HALF_BATHS : '';
                    $_garage_type = (isset($a[0]->GAR_TYPE)) ? $a[0]->GAR_TYPE : '';
                    $_grnd_sqft = (isset($a[0]->GRND_SQFT)) ? $a[0]->GRND_SQFT : '';
                    $_heat_type = (isset($a[0]->HEAT_TYPE)) ? $a[0]->HEAT_TYPE : '';
                    $_hmstd = (isset($a[0]->HMSTD)) ? $a[0]->HMSTD : '';
                    $_impr_appr_val = (isset($a[0]->IMPR_APPR_VAL)) ? $a[0]->IMPR_APPR_VAL : '';
                    $_imprval = (isset($a[0]->IMPRVAL)) ? $a[0]->IMPRVAL : '';
                    $_imprval_type = (isset($a[0]->IMPRVAL_TYPE)) ? $a[0]->IMPRVAL_TYPE : '';
                    $_land_appr_val = (isset($a[0]->LAND_APPR_VAL)) ? $a[0]->LAND_APPR_VAL : '';
                    $_landval = (isset($a[0]->LANDVAL)) ? $a[0]->LANDVAL : '';
                    $_landval_type = (isset($a[0]->LANDVAL_TYPE)) ? $a[0]->LANDVAL_TYPE : '';
                    $_last = (isset($a[0]->LAST)) ? $a[0]->LAST : '';
                    $_last_2 = (isset($a[0]->LAST2)) ? $a[0]->LAST2 : '';
                    $_lat = (isset($a[0]->LAT)) ? $a[0]->LAT : '';
                    $_lender_name = (isset($a[0]->LENDER_NAME)) ? $a[0]->LENDER_NAME : '';
                    $_lender2_name = (isset($a[0]->LENDER2_NAME)) ? $a[0]->LENDER2_NAME : '';
                    $_lender3_name = (isset($a[0]->LENDER3_NAME)) ? $a[0]->LENDER3_NAME : '';
                    $_loan_amt = (isset($a[0]->LOAN_AMT)) ? $a[0]->LOAN_AMT : '';
                    $_loan_date = (isset($a[0]->LOAN_DATE)) ? $a[0]->LOAN_DATE : '';
                    $_loan_to_val = (isset($a[0]->LOAN_TO_VAL)) ? $a[0]->LOAN_TO_VAL : '';
                    $_lon = (isset($a[0]->LON)) ? $a[0]->LON : '';
                    $_markval = (isset($a[0]->MARKVAL)) ? $a[0]->MARKVAL : '';
                    $_markval_type = (isset($a[0]->MARKVAL_TYPE)) ? $a[0]->MARKVAL_TYPE : '';
                    $_patio_porch = (isset($a[0]->PatioPorch)) ? $a[0]->PatioPorch : '';
                    $_patio_square_feet = (isset($a[0]->PatioSquareFeet)) ? $a[0]->PatioSquareFeet : '';
                    $_pool = (isset($a[0]->POOL)) ? $a[0]->POOL : '';
                    $_porch_square_feet = (isset($a[0]->PorchSquareFeet)) ? $a[0]->PorchSquareFeet : '';
                    $_previous_assessed_value = (isset($a[0]->PreviousAssessedValue)) ? $a[0]->PreviousAssessedValue : '';
                    $_prop_type = (isset($a[0]->PROP_TYPE)) ? $a[0]->PROP_TYPE : '';
                    $_rate_type = (isset($a[0]->RATE_TYPE)) ? $a[0]->RATE_TYPE : '';
                    $_rec_date = (isset($a[0]->REC_DATE)) ? $a[0]->REC_DATE : '';
                    $_roof_covtype = (isset($a[0]->ROOF_COVTYPE)) ? $a[0]->ROOF_COVTYPE : '';
                    $_roof_shapetype = (isset($a[0]->ROOF_SHAPETYPE)) ? $a[0]->ROOF_SHAPETYPE : '';
                    $_sale_amt = (isset($a[0]->SALE_AMT)) ? $a[0]->SALE_AMT : '';
                    $_sale_amt_pr = (isset($a[0]->SALE_AMT_PR)) ? $a[0]->SALE_AMT_PR : '';
                    $_sale_date = (isset($a[0]->SALE_DATE)) ? $a[0]->SALE_DATE : '';
                    $_sale_type_pr = (isset($a[0]->SALE_TYPE_PR)) ? $a[0]->SALE_TYPE_PR : '';
                    $_sales_type = (isset($a[0]->SALES_TYPE)) ? $a[0]->SALES_TYPE : '';
                    $_sell_name = (isset($a[0]->SELL_NAME)) ? $a[0]->SELL_NAME : '';
                    $_sewer_type = (isset($a[0]->SEWER_TYPE)) ? $a[0]->SEWER_TYPE : '';
                    $_site_quality = (isset($a[0]->SITE_QUALITY)) ? $a[0]->SITE_QUALITY : '';
                    $_std_address = (isset($a[0]->STD_ADDRESS)) ? $a[0]->STD_ADDRESS : '';
                    $_std_city = (isset($a[0]->STD_CITY)) ? $a[0]->STD_CITY : '';
                    $_std_state = (isset($a[0]->STD_STATE)) ? $a[0]->STD_STATE : '';
                    $_std_zip = (isset($a[0]->STD_ZIP)) ? $a[0]->STD_ZIP : '';
                    $_std_zip4 = (isset($a[0]->STD_ZIP4)) ? $a[0]->STD_ZIP4 : '';
                    $_stories_number = (isset($a[0]->STORIES_NMBR)) ? $a[0]->STORIES_NMBR : '';
                    $_suffix = (isset($a[0]->SUFFIX)) ? $a[0]->SUFFIX : '';
                    $_suffix_2 = (isset($a[0]->SUFFIX2)) ? $a[0]->SUFFIX2 : '';
                    $_tax_yr = (isset($a[0]->TAX_YR)) ? $a[0]->TAX_YR : '';
                    $_tax_improvement_percent = (isset($a[0]->TaxImprovementPercent)) ? $a[0]->TaxImprovementPercent : '';
                    $_title_co = (isset($a[0]->TITLE_CO)) ? $a[0]->TITLE_CO : '';
                    $_tot_baths_est = (isset($a[0]->TOT_BATHS_EST)) ? $a[0]->TOT_BATHS_EST : '';
                    $_ttl_appr_val = (isset($a[0]->TTL_APPR_VAL)) ? $a[0]->TTL_APPR_VAL : '';
                    $_ttl_bld_sqft = (isset($a[0]->TTL_BLD_SQFT)) ? $a[0]->TTL_BLD_SQFT : '';
                    $_ttl_tax = (isset($a[0]->TTL_TAX)) ? $a[0]->TTL_TAX : '';
                    $_unit_number = (isset($a[0]->UNIT_NMBR)) ? $a[0]->UNIT_NMBR : '';
                    $_vet_exempt = (isset($a[0]->VET_EXEMPT)) ? $a[0]->VET_EXEMPT : '';
                    $_water_type = (isset($a[0]->WATER_TYPE)) ? $a[0]->WATER_TYPE : '';
        
                //unregistered row
                }
                }

                $uniqueID = uniqid();
                /** INSERT INTO DATABASE PERSON */
                    $newPerson = Person::create([
                        'uniqueID' => $uniqueID,
                        'firstName' => $_FirstName,
                        'middleName' => '',
                        'lastName' => $_LastName,
                        'age' => '0',
                        'identityScore' => '0',
                        'lastEntry' => date('Y-m-d H:i:s'),
                    ]);

                    $newPersonID = $newPerson->id;
                /** INSERT INTO DATABASE PERSON */

                /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */
                $filteredEmails = [];
                $otherEmails = [];
                foreach ($bigEmail as $index => $email) {
                    if (strpos($email, 'yahoo.com') !== false || strpos($email, 'aol.com') !== false) {
                        $filteredEmails[] = $email;
                    } else {
                        $otherEmails[] = $email;
                    }
                }
                /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */

                Log::info("BigBDM Have result - CHECK ZERO BOUNCE");
                /** NEW METHOD TO CHECK AND GET EMAIL */
                foreach($otherEmails as $index => $be) {
                    if (trim($be) != "") {
                        $tmpEmail = strtolower(trim($be));
                        $tmpMd5 = md5($tmpEmail);

                        $startZbValidationTime = microtime(true);
                        $param = [
                            'leadspeek_api_id' => $leadspeek_api_id,
                            'leadspeek_type' => $leadspeektype,
                            'md5param' => $tmpMd5,
                        ];
                        $zbcheck = $this->true_list_validation($tmpEmail,$param);

                        $endZbValidationTime = microtime(true);

                        // convert epochtime to date format ('Y-m-d H:i:s')
                        $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        // convert epochtime to date format ('Y-m-d H:i:s')

                        $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                        $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                        $executionTimeList['zb_validation'] = [
                            'start_execution_time' => $startZbValidationDate,
                            'end_execution_time' => $endZbValidationDate,
                            'total_execution_time' => $totalZbValidationTime
                        ];

                        // Handle both TrueList and ZeroBounce responses
                        $isValid = false;
                        $validationStatus = '';
                        $apiType = '';
                        
                        // Check TrueList response format
                        if (isset($zbcheck->emails[0]->email_state)) {
                            $validationStatus = $zbcheck->emails[0]->email_state;
                            $apiType = 'truelist';
                            $isValid = ($zbcheck->emails[0]->email_state == "ok");
                        }
                        // Check ZeroBounce response format
                        elseif (isset($zbcheck->status)) {
                            $validationStatus = $zbcheck->status;
                            $apiType = 'zerobounce';
                            $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                        }
                        
                        if ($validationStatus !== '') {
                            if (!$isValid) {
                                /** PUT IT ON OPTOUT LIST */
                                $createoptout = OptoutList::create([
                                    'email' => $tmpEmail,
                                    'emailmd5' => md5($tmpEmail),
                                    'blockedcategory' => 'zbnotvalid',
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                ]);
                                /** PUT IT ON OPTOUT LIST */

                                if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                    $this->UpsertFailedLeadRecord([
                                        'function' => __FUNCTION__,
                                        'type' => 'blocked',
                                        'blocked_type' => $apiType,
                                        'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                        'leadspeek_api_id' => $leadspeek_api_id,
                                        'email_encrypt' => $tmpMd5,
                                        'leadspeek_type' => $leadspeektype,
                                        'email' => $tmpEmail,
                                        'status' => $validationStatus,
                                    ]);
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                            }else{
                                $newpersonemail = PersonEmail::create([
                                    'person_id' => $newPersonID,
                                    'email' => $tmpEmail,
                                    'email_encrypt' => $tmpMd5,
                                    'permission' => 'T',
                                    'zbvalidate' => date('Y-m-d H:i:s'),
                                ]);

                                if ($_Email ==  "") {
                                    $_Email = $tmpEmail;
                                }else if ($_Email2 == "") {
                                    $_Email2 = $tmpEmail;
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                            }
                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                            /** REPORT ANALYTIC */
                        }else{
                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                        }

                    }
                }
                /** NEW METHOD TO CHECK AND GET EMAIL */

                /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */
                if (trim($_Email) == '') {
                    /** NEW METHOD TO CHECK AND GET EMAIL */
                    foreach($filteredEmails as $index => $be) {
                        if (trim($be) != "") {
                            $tmpEmail = strtolower(trim($be));
                            $tmpMd5 = md5($tmpEmail);

                            $startZbValidationTime = microtime(true);

                            $param = [
                                'leadspeek_api_id' => $leadspeek_api_id,
                                'leadspeek_type' => $leadspeektype,
                                'md5param' => $tmpMd5,
                            ];
                            $zbcheck = $this->true_list_validation($tmpEmail,$param);

                            $endZbValidationTime = microtime(true);

                            // convert epochtime to date format ('Y-m-d H:i:s')
                            $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                            $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                            // convert epochtime to date format ('Y-m-d H:i:s')

                            $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                            $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                            $executionTimeList['zb_validation'] = [
                                'start_execution_time' => $startZbValidationDate,
                                'end_execution_time' => $endZbValidationDate,
                                'total_execution_time' => $totalZbValidationTime
                            ];

                            // Handle both TrueList and ZeroBounce responses
                            $isValid = false;
                            $validationStatus = '';
                            $apiType = '';
                            
                            // Check TrueList response format
                            if (isset($zbcheck->emails[0]->email_state)) {
                                $validationStatus = $zbcheck->emails[0]->email_state;
                                $apiType = 'truelist';
                                $isValid = ($zbcheck->emails[0]->email_state == "ok");
                            }
                            // Check ZeroBounce response format
                            elseif (isset($zbcheck->status)) {
                                $validationStatus = $zbcheck->status;
                                $apiType = 'zerobounce';
                                $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                            }
                            
                            if ($validationStatus !== '') {
                                /** REPORT ANALYTIC */
                                $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                                /** REPORT ANALYTIC */
                                if (!$isValid) {
                                    /** PUT IT ON OPTOUT LIST */
                                    $createoptout = OptoutList::create([
                                        'email' => $tmpEmail,
                                        'emailmd5' => md5($tmpEmail),
                                        'blockedcategory' => 'zbnotvalid',
                                        'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                    ]);
                                    /** PUT IT ON OPTOUT LIST */

                                    if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                        $this->UpsertFailedLeadRecord([
                                            'function' => __FUNCTION__,
                                            'type' => 'blocked',
                                            'blocked_type' => $apiType,
                                            'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                            'leadspeek_api_id' => $leadspeek_api_id,
                                            'email_encrypt' => $tmpMd5,
                                            'leadspeek_type' => $leadspeektype,
                                            'email' => $tmpEmail,
                                            'status' => $validationStatus,
                                        ]);
                                    }    

                                    $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                                }else{
                                    $newpersonemail = PersonEmail::create([
                                        'person_id' => $newPersonID,
                                        'email' => $tmpEmail,
                                        'email_encrypt' => $tmpMd5,
                                        'permission' => 'T',
                                        'zbvalidate' => date('Y-m-d H:i:s'),
                                    ]);

                                    if ($_Email ==  "") {
                                        $_Email = $tmpEmail;
                                        break;
                                    }else if ($_Email2 == "") {
                                        $_Email2 = $tmpEmail;
                                    }

                                    $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                                }
                            }else{
                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                            }

                        }
                    }
                    /** NEW METHOD TO CHECK AND GET EMAIL */
                }
                /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */

                if (trim($_Email) == "" && trim($_Email2) == "") {
                    /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                        $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                    /** REPORT ANALYTIC */

                    Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 and Email 2 NOT VALID");
                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                    // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 NOT VALID CampaignID #" . $leadspeek_api_id);
                    // $this->releaseLock($initLock);
                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */


                    /* WRITE UPSER FAILED LEAD RECORD */
                        $this->UpsertFailedLeadRecord([
                            'function' => 'process_BDM_advance',
                            'type' => 'blocked',
                            'blocked_type' => 'truelist',
                            'description' => 'blocked in truelist fetch bigBDM_MD5 function process_BDM_local_custom',
                            'leadspeek_api_id' => $leadspeek_api_id,
                            'email_encrypt' => $md5param,
                            'leadspeek_type' => $leadspeektype,
                        ]);
                    /* WRITE UPSER FAILED LEAD RECORD */
                }else{
                    /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                        $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                    /** REPORT ANALYTIC */
                    Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 or Email 2 VALID");

                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                    // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 VALID CampaignID #" . $leadspeek_api_id);
                    // $this->releaseLock($initLock);
                    // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                }

                Log::info("BigBDM BDM_ADVANCE CHECK PHONE1");
                if (trim($_mobile_phone) != "") {
                    /** INSERT PERSON_PHONES */
                    $newpersonphone = PersonPhone::create([
                        'person_id' => $newPersonID,
                        'number' => $this->format_phone($_mobile_phone),
                        'type' => 'user',
                        'isConnected' => 'T',
                        'firstReportedDate' => date('Y-m-d'),
                        'lastReportedDate' => date('Y-m-d'),
                        'permission' => 'F',
                    ]);
                    /** INSERT PERSON_PHONES */
                }

                Log::info("BigBDM BDM_ADVANCE CHECK PHONE2");
                if (trim($_mobile_phone2) != "") {
                    /** INSERT PERSON_PHONES */
                    $newpersonphone = PersonPhone::create([
                        'person_id' => $newPersonID,
                        'number' => $this->format_phone($_mobile_phone2),
                        'type' => 'user',
                        'isConnected' => 'T',
                        'firstReportedDate' => date('Y-m-d'),
                        'lastReportedDate' => date('Y-m-d'),
                        'permission' => 'F',
                    ]);
                    /** INSERT PERSON_PHONES */
                }

                Log::info("BigBDM BDM_ADVANCE CHECK PHONE3");
                if (trim($_mobile_phone3) != "") {
                    /** INSERT PERSON_PHONES */
                    $newpersonphone = PersonPhone::create([
                        'person_id' => $newPersonID,
                        'number' => $this->format_phone($_mobile_phone3),
                        'type' => 'user',
                        'isConnected' => 'T',
                        'firstReportedDate' => date('Y-m-d'),
                        'lastReportedDate' => date('Y-m-d'),
                        'permission' => 'F',
                    ]);
                    /** INSERT PERSON_PHONES */
                }

                Log::info("BigBDM BDM_ADVANCE CHECK Address");
                /** INSERT INTO PERSON_ADDRESSES */
                $newpersonaddress = PersonAddress::create([
                    'person_id' => $newPersonID,
                    'street' => $_Address1,
                    'unit' => $_Address2,
                    'city' => $_City,
                    'state' => $_State,
                    'zip' => $_Zipcode,
                    'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                ]);

                if ($is_advance) {
                //INSERT PERSON ADVANCE 1 
                    $newpersonadvance1 = PersonAdvance::create([
                        'person_id' => $newPersonID,
                        'gender_aux' => $_gender_aux,
                        'gender' => $_gender,
                        'age_aux' => $_age_aux,
                        'birth_year_aux' => $_birth_year_aux,
                        'generation' => $_generation,
                        'marital_status' => $_marital_status,
                        'income_household' => $_household_income,
                        'income_midpts_household' => $_median_household_income,
                        'net_worth_household' => $_household_net_worth,
                        'net_worth_midpt_household' => $_median_household_net_worth,
                        'discretionary_income' => $_discretionary_income,
                        'credit_midpts' => $_credit_score_median,
                        'credit_range' => $_credit_score_range,
                        'occupation_category' => $_occupation_category,
                        'occupation_detail' => $_occupation_detail,
                        'occupation_type' => $_occupation_type,
                        'voter' => $_voter,
                        'urbanicity' => $_urbanicity,
                        'mobile_phone_1' => $_mobile_phone,
                        'mobile_phone_2' => $_mobile_phone2,
                        'mobile_phone_3' => $_mobile_phone3,
                        'mobile_phone_1_dnc' => $_mobile_phone_dnc,
                        'mobile_phone_2_dnc' => $_mobile_phone_dnc2,
                        'mobile_phone_3_dnc' => $_mobile_phone_dnc3,
                        'tax_bill_mailing_address' => $_tax_bill_mailing_address,
                        'tax_bill_mailing_city' => $_tax_bill_mailing_city,
                        'tax_bill_mailing_county' => $_tax_bill_mailing_county,
                        'tax_bill_mailing_fips' => $_tax_bill_mailing_fips,
                        'tax_bill_mailing_state' => $_tax_bill_mailing_state,
                        'tax_bill_mailing_zip' => $_tax_bill_mailing_zip,
                        'tax_bill_mailing_zip4' => $_tax_bill_mailing_zip4,
                        'num_adults_household' => $_num_adults_household,
                        'num_children_household' => $_num_children_household,
                        'num_persons_household' => $_num_persons_household,
                        'child_aged_0_3_household' => $_child_aged_0_3_household,
                        'child_aged_4_6_household' => $_child_aged_4_6_household,
                        'child_aged_7_9_household' => $_child_aged_7_9_household,
                        'child_aged_10_12_household' => $_child_aged_10_12_household,
                        'child_aged_13_18_household' => $_child_aged_13_18_household,
                        'children_household' => $_children_household,
                        'has_email' => $_has_email,
                        'has_phone' => $_has_phone,
                        'magazine_subscriber' => $_magazine_subscriber,
                        'charity_interest' => $_charity_interest,
                        'likely_charitable_donor' => $_likely_charitable_donor,
                        'donor_affinity' => $_donor_affinity,
                        'dwelling_type' => $_dwelling_type,
                        'home_owner' => $_home_owner,
                        'home_owner_ordinal' => $_home_owner_ordinal,
                        'length_of_residence' => $_length_of_residence,
                        'home_price' => $_home_price,
                        'home_value' => $_home_value,
                        'median_home_value' => $_median_home_value,
                        'living_sqft' => $_living_sqft,
                        'yr_built_orig' => $_year_built_original,
                        'yr_built_range' => $_year_built_range,
                        'lot_number' => $_lot_number,
                        'legal_description' => $_legal_description,
                        'land_sqft' => $_land_sqft,
                        'garage_sqft' => $_garage_sqft,
                        'subdivision' => $_subdivision,
                        'zoning_code' => $_zoning_code,
                        'cooking' => $_cooking,
                        'gardening' => $_gardening,
                        'music' => $_music,
                        'diy' => $_diy,
                        'books' => $_books,
                        'travel_vacation' => $_travel_vacation,
                        'health_beauty_products' => $_health_beauty_products,
                        'pet_owner' => $_pet_owner,
                        'photography' => $_photography,
                        'fitness' => $_fitness,
                        'epicurean' => $_epicurean,
                        'cbsa' => $_cbsa,
                        'census_block' => $_census_block,
                        'census_block_group' => $_census_block_group,
                        'census_tract' => $_census_tract,
                        
                        'aerobics' => $_aerobics,
                        'african_american_affinity' => $_african_american_affinity ,
                        'amex_card' => $_amex_card,
                        'antiques' => $_antiques,
                        'apparel_accessory_affinity' => $_apparel_accessory_affinity,
                        'apparel_affinity' => $_apparel_affinity,
                        'arts_and_crafts' => $_arts_and_crafts,
                        'asian_affinity' => $_asian_affinity,
                        'auto_affinity' => $_auto_affinity,
                        'auto_racing_affinity' => $_auto_racing_affinity,
                        'aviation_affinity' => $_aviation_affinity,
                        'bank_card' => $_bank_card,
                        'bargain_hunter_affinity' => $_bargain_hunter_affinity,
                        'baseball' => $_baseball,
                        'baseball_affinity' => $_baseball_affinity,
                        'basketball' => $_basketball,
                        'basketball_affinity' => $_basketball_affinity,
                        'beauty_affinity' => $_beauty_affinity,
                        'bible_affinity' => $_bible_affinity,
                        'bird_watching' => $_bird_watching,
                        'birds_affinity' => $_birds_affinity,
                        'blue_collar' => $_blue_collar,
                        'boating_sailing' => $_boating_sailing,
                        'boating_sailing_affinity' => $_boating_sailing_affinity,
                        'business_affinity' => $_business_affinity,
                        'camping_hiking' => $_camping_hiking,
                        'camping_hiking_climbing_affinity' => $_camping_hiking_climbing_affinity,
                        'cars_interest' => $_cars_interest,
                        'cat_owner' => $_cat_owner,
                        'catalog_affinity' => $_catalog_affinity,
                        'cigars' => $_cigars,
                        'classical_music' => $_classical_music,
                        'coins' => $_coins,
                        'collectibles_affinity' => $_collectibles_affinity,
                        'college_affinity' => $_college_affinity,
                        'computers_affinity' => $_computers_affinity,
                        'continuity_program_affinity' => $_continuity_program_affinity,
                        'cooking_affinity' => $_cooking_affinity,
                        'cosmetics' => $_cosmetics,
                        'country_music' => $_country_music,
                        'crafts_affinity' => $_crafts_affinity,
                        'credit_card' => $_credit_card,
                        'credit_repair_affinity' => $_credit_repair_affinity,
                        'crochet_affinity' => $_crochet_affinity,
                    ]);
                //INSERT PERSON ADVANCE 1

                //INSERT PERSON ADVANCE 2
                    $newpersonadvance2 = PersonAdvance2::create([
                        'person_id' => $newPersonID,
                        'diet_affinity' => $_diet_affinity,
                        'dieting' => $_dieting,
                        'do_it_yourself_affinity' => $_do_it_yourself_affinity,
                        'dog_owner' => $_dog_owner,
                        'doll_collector' => $_doll_collector,
                        'education' => $_education,
                        'education_ordinal' => $_education_ordinal,
                        'education_seekers_affinity' => $_education_seekers_affinity,
                        'ego_affinity' => $_ego_affinity,
                        'entertainment_interest' => $_entertainment_interest,
                        'figurines_collector' => $_figurines_collector,
                        'fine_arts_collector' => $_fine_arts_collector,
                        'fishing' => $_fishing,
                        'fishing_affinity' => $_fishing_affinity,
                        'fitness_affinity' => $_fitness_affinity,
                        'football' => $_football,
                        'football_affinity' => $_football_affinity,
                        'gambling' => $_gambling,
                        'gambling_affinity' => $_gambling_affinity,
                        'games_affinity' => $_games_affinity,
                        'gardening_affinity' => $_gardening_affinity,
                        'generation_ordinal' => $_generation_ordinal,
                        'golf' => $_golf,
                        'golf_affinity' => $_golf_affinity,
                        'gourmet_affinity' => $_gourmet_affinity,
                        'grandparents_affinity' => $_grandparents_affinity,
                        'health_affinity' => $_health_affinity,
                        'healthy_living' => $_healthy_living,
                        'healthy_living_interest' => $_healthy_living_interest,
                        'high_tech_affinity' => $_high_tech_affinity,
                        'hispanic_affinity' => $_hispanic_affinity,
                        'hockey' => $_hockey,
                        'hockey_affinity' => $_hockey_affinity,
                        'home_decor' => $_home_decor,
                        'home_improvement_interest' => $_home_improvement_interest,
                        'home_office_affinity' => $_home_office_affinity,
                        'home_study' => $_home_study,
                        'hunting' => $_hunting,
                        'hunting_affinity' => $_hunting_affinity,
                        'jazz' => $_jazz,
                        'kids_apparel_affinity' => $_kids_apparel_affinity,
                        'knit_affinity' => $_knit_affinity,
                        'knitting_quilting_sewing' => $_knitting_quilting_sewing,
                        'luxury_life' => $_luxury_life,
                        'married' => $_married,
                        'median_income' => $_median_income,
                        'mens_apparel_affinity' => $_mens_apparel_affinity,
                        'mens_fashion_affinity' => $_mens_fashion_affinity,
                        'mortgage_age' => $_mortgage_age,
                        'mortgage_amount' => $_mortgage_amount,
                        'mortgage_loan_type' => $_mortgage_loan_type,
                        'mortgage_refi_age' => $_mortgage_refi_age,
                        'mortgage_refi_amount' => $_mortgage_refi_amount,
                        'mortgage_refi_type' => $_mortgage_refi_type,
                        'motor_racing' => $_motor_racing,
                        'motorcycles' => $_motorcycles,
                        'motorcycles_affinity' => $_motorcycles_affinity,
                        'movies' => $_movies,
                        'nascar' => $_nascar,
                        'needlepoint_affinity' => $_needlepoint_affinity,
                        'new_credit_offered_household' => $_new_credit_offered_household,
                        'num_credit_lines_household' => $_num_credit_lines_household,
                        'num_generations_household' => $_num_generations_household,
                        'outdoors' => $_outdoors,
                        'outdoors_affinity' => $_outdoors_affinity,
                        'owns_investments' => $_owns_investments,
                        'owns_mutual_funds' => $_owns_mutual_funds,
                        'owns_stocks_and_bonds' => $_owns_stocks_and_bonds,
                        'owns_swimming_pool' => $_owns_swimming_pool,
                        'personal_finance_affinity' => $_personal_finance_affinity,
                        'personality' => $_personality,
                        'plates_collector' => $_plates_collector,
                        'pop_density' => $_pop_density,
                        'premium_amex_card' => $_premium_amex_card,
                        'premium_card' => $_premium_card,
                        'premium_income_household' => $_premium_income_household,
                        'premium_income_midpt_household' => $_premium_income_midpt_household,
                        'quilt_affinity' => $_quilt_affinity,
                        'religious_music' => $_religious_music,
                        'rhythm_and_blues' => $_rhythm_and_blues,
                        'rock_music' => $_rock_music,
                        'running' => $_running,
                        'rv' => $_rv,
                        'scuba' => $_scuba,
                        'self_improvement' => $_self_improvement,
                        'sewing_affinity' => $_sewing_affinity,
                        'single_family_dwelling' => $_single_family_dwelling,
                        'snow_skiing' => $_snow_skiing,
                        'snow_skiing_affinity' => $_snow_skiing_affinity,
                        'soccer' => $_soccer,
                        'soccer_affinity' => $_soccer_affinity,
                        'soft_rock' => $_soft_rock,
                        'soho_business' => $_soho_business,
                        'sports_memoribilia_collector' => $_sports_memoribilia_collector,
                        'stamps' => $_stamps,
                        'sweepstakes_affinity' => $_sweepstakes_affinity,
                        'tennis' => $_tennis,
                        'tennis_affinity' => $_tennis_affinity,
                        'tobacco_affinity' => $_tobacco_affinity,
                        'travel_affinity' => $_travel_affinity,
                        'travel_cruise_affinity' => $_travel_cruise_affinity,
                        'travel_cruises' => $_travel_cruises,
                        'travel_personal' => $_travel_personal,
                        'travel_rv_affinity' => $_travel_rv_affinity,
                        'travel_us_affinity' => $_travel_us_affinity,
                        'truck_owner' => $_truck_owner,
                        'trucks_affinity' => $_trucks_affinity,
                        'tv_movies_affinity' => $_tv_movies_affinity,
                        'veteran_household' => $_veteran_household,
                        'walking' => $_walking,
                        'weight_lifting' => $_weight_lifting,
                        'wildlife_affinity' => $_wildlife_affinity,
                        'womens_apparel_affinity' => $_womens_apparel_affinity,
                        'womens_fashion_affinity' => $_womens_fashion_affinity,
                        'woodworking' => $_woodworking,
                        'male_aux' => $_male_aux,
                        'political_contributor_aux' => $_political_contributor_aux,
                        'political_party_aux' => $_political_party_aux,
                        'financial_power' => $_financial_power,
                        'mortgage_open_1st_intent' => $_mortgage_open_1st_intent,
                        'mortgage_open_2nd_intent' => $_mortgage_open_2nd_intent,
                        'mortgage_new_intent' => $_mortgage_new_intent,
                        'mortgage_refinance_intent' => $_mortgage_refinance_intent,
                        'automotive_loan_intent' => $_automotive_loan_intent,
                        'bank_card_intent' => $_bank_card_intent,
                        'personal_loan_intent' => $_personal_loan_intent,
                        'retail_card_intent' => $_retail_card_intent,
                        'student_loan_cons_intent' => $_student_loan_cons_intent,
                        'student_loan_intent' => $_student_loan_intent,
                        'qtr3_baths' => $_3qtr_baths,
                        'ac_type' => $_ac_type,
                        'acres' => $_acres,
                    ]);
                //INSERT PERSON ADVANCE 2

                //INSERT PERSON ADVANCE 3
                    $newpersonadvance3 = PersonAdvance3::create([
                        'person_id' => $newPersonID,
                        'additions_square_feet' => $_additions_square_feet,
                        'assess_val_impr' => $_assess_val_impr,
                        'assess_val_lnd' => $_assess_val_lnd,
                        'assess_val_prop' => $_assess_val_prop,
                        'bldg_style' => $_bldg_style,
                        'bsmt_sqft' => $_bsmt_sqft,
                        'bsmt_type' => $_bsmt_type,
                        'build_sqft_assess' => $_build_sqft_assess,
                        'business' => $_business,
                        'combined_statistical_area' => $_combined_statistical_area,
                        'metropolitan_division' => $_metropolitan_division,
                        'middle' => $_middle,
                        'middle_2' => $_middle_2,
                        'mkt_ip_perc' => $_mkt_ip_perc,
                        'mobile_home' => $_mobile_home,

                        'mrtg_due' => $_mrtg_due,
                        'mrtg_intrate' => $_mrtg_intrate,
                        'mrtg_refi' => $_mrtg_refi,
                        'mrtg_term' => $_mrtg_term,
                        'mrtg_type' => $_mrtg_type,

                        'mrtg2_amt' => $_mrtg2_amt,
                        'mrtg2_date' => $_mrtg2_date,
                        'mrtg2_deed_type' => $_mrtg2_deed_type,
                        'mrtg2_due' => $_mrtg2_due,
                        'mrtg2_equity' => $_mrtg2_equity,
                        'mrtg2_intrate' => $_mrtg2_intrate,
                        'mrtg2_inttype' => $_mrtg2_inttype,
                        'mrtg2_refi' => $_mrtg2_refi,
                        'mrtg2_term' => $_mrtg2_term,
                        'mrtg2_type' => $_mrtg2_type,

                        'mrtg3_amt' => $_mrtg3_amt,
                        'mrtg3_date' => $_mrtg3_date,
                        'mrtg3_deed_type' => $_mrtg3_deed_type,
                        'mrtg3_due' => $_mrtg3_due,
                        'mrtg3_equity' => $_mrtg3_equity,
                        'mrtg3_inttype' => $_mrtg3_inttype,
                        'mrtg3_refi' => $_mrtg3_refi,
                        'mrtg3_term' => $_mrtg3_term,
                        'mrtg3_type' => $_mrtg3_type,

                        'msa_code' => $_msa_code,
                        'number_bedrooms' => $_number_bedrooms,
                        'number_bldgs' => $_number_bldgs,
                        'number_fireplace' => $_number_fireplace,
                        'number_park_spaces' => $_number_park_spaces,
                        'number_rooms' => $_number_rooms,
                        'own_biz' => $_own_biz,
                        'owner_occupied' => $_owner_occupied,
                        'ownership_relation' => $_ownership_relation,
                        'owner_type_description' => $_owner_type_description,
                        'estimated_value' => $_estimated_value,
                        'ext_type' => $_ext_type,
                        'finish_square_feet2' => $_finish_square_feet2,
                        'fireplace' => $_fireplace,
                        'first' => $_first,
                        'first_2' => $_first_2,
                        'found_type' => $_found_type,
                        'fr_feet' => $_fr_feet,
                        'fuel_type' => $_fuel_type,
                        'full_baths' => $_full_baths,
                        'half_baths' => $_half_baths,
                        'garage_type' => $_garage_type,
                        'grnd_sqft' => $_grnd_sqft,
                        'heat_type' => $_heat_type,
                        'hmstd' => $_hmstd,
                        'impr_appr_val' => $_impr_appr_val,
                        'imprval' => $_imprval,
                        'imprval_type' => $_imprval_type,
                        'land_appr_val' => $_land_appr_val,
                        'landval' => $_landval,
                        'landval_type' => $_landval_type,
                        'last' => $_last,
                        'last_2' => $_last_2,
                        'lat' => $_lat,
                        'lender_name' => $_lender_name,
                        'lender2_name' => $_lender2_name,
                        'lender3_name' => $_lender3_name,
                        'loan_amt' => $_loan_amt,
                        'loan_date' => $_loan_date,
                        'loan_to_val' => $_loan_to_val,
                        'lon' => $_lon,
                        'markval' => $_markval,
                        'markval_type' => $_markval_type,
                        'patio_porch' => $_patio_porch,
                        'patio_square_feet' => $_patio_square_feet,
                        'pool' => $_pool,
                        'porch_square_feet' => $_porch_square_feet,
                        'previous_assessed_value' => $_previous_assessed_value,
                        'prop_type' => $_prop_type,
                        'rate_type' => $_rate_type,
                        'rec_date' => $_rec_date,
                        'roof_covtype' => $_roof_covtype,
                        'roof_shapetype' => $_roof_shapetype,
                        'sale_amt' => $_sale_amt,
                        'sale_amt_pr' => $_sale_amt_pr,
                        'sale_date' => $_sale_date,
                        'sale_type_pr' => $_sale_type_pr,
                        'sales_type' => $_sales_type,
                        'sell_name' => $_sell_name,
                        'sewer_type' => $_sewer_type,
                        'site_quality' => $_site_quality,
                        'std_address' => $_std_address,
                        'std_city' => $_std_city,
                        'std_state' => $_std_state,
                        'std_zip' => $_std_zip,
                        'std_zip4' => $_std_zip4,
                        'stories_number' => $_stories_number,
                        'suffix' => $_suffix,
                        'suffix_2' => $_suffix_2,
                        'tax_yr' => $_tax_yr,
                        'tax_improvement_percent' => $_tax_improvement_percent,
                        'title_co' => $_title_co,
                        'tot_baths_est' => $_tot_baths_est,
                        'ttl_appr_val' => $_ttl_appr_val,
                        'ttl_bld_sqft' => $_ttl_bld_sqft,
                        'ttl_tax' => $_ttl_tax,
                        'unit_number' => $_unit_number,
                        'vet_exempt' => $_vet_exempt,
                        'water_type' => $_water_type,
                    ]);
                //INSERT PERSON ADVANCE 3

                }

                $_ID = $this->generateReportUniqueNumber();

                Log::info("BigBDM Have result - ReportID #" . $_ID);

                $new_advance = array(
                    "ID" => $_ID,
                    "PersonID" => $newPersonID,
                    "Email" => $_Email,
                    "Email2" => $_Email2,
                    "OriginalMD5" => $md5param,
                    "IP" => $_IP,
                    "Source" => $_Source,
                    "OptInDate" => $_OptInDate,
                    "ClickDate" => $_ClickDate,
                    "Referer" => $_Referer,
                    "Phone" => $_mobile_phone,
                    "Phone2" => $_mobile_phone2,
                    "Phone3" => $_mobile_phone3,
                    "FirstName" => $_FirstName,
                    "LastName" => $_LastName,
                    "Address1" => $_Address1,
                    "Address2" => $_Address2,
                    "City" => $_City,
                    "State" => $_State,
                    "Zipcode" => $_Zipcode,
                    "Keyword" => $keyword,
                    "Description" => $_Description,
                    "LeadFrom" => "bigbdmmd5",                    
                    // "local_advance_exist" => $local_advance_exist //set advance charge
                );

                if ($is_advance) {
                    $taxBillInformation = array_filter([
                        $_tax_bill_mailing_address,
                        $_tax_bill_mailing_city,
                        !empty($_tax_bill_mailing_county) ? "{$_tax_bill_mailing_county} County" : null,
                        $_tax_bill_mailing_state,
                        trim($_tax_bill_mailing_zip . ($_tax_bill_mailing_zip && $_tax_bill_mailing_zip4 ? "-" : "") . $_tax_bill_mailing_zip4, "-")
                    ]);            
                    $taxBillInformationString = '';
                    $taxBillInformationString = implode(", ", $taxBillInformation);

                    $person_advance = [
                    // Person advance
                        //identification
                            "GenderAux" => $_gender_aux,
                            // "AgeAux" => $_age_aux,
                            // "BirthYearAux" => $_birth_year_aux,
                            "Generation" => $_generation,
                            'MaritalStatus' => $_marital_status,
                        //identification

                        //financial information
                            "IncomeHousehold" => $_household_income,
                            "IncomeMidptsHousehold" => $_median_household_income,
                            "NetWorthHousehold" => $_household_net_worth,
                            "NetWorthMidptHousehold" => $_median_household_net_worth,
                            "DiscretionaryIncome" => $_discretionary_income,
                            "CreditMidpts" => $_credit_score_median,
                            "CreditRange" => $_credit_score_range,
                        //financial information

                        //occupation
                            "OccupationCategory" => $_occupation_category,
                            "OccupationDetail" => $_occupation_detail,
                            "OccupationType" => $_occupation_type,
                        //occupation

                        //miscellaneous
                            "Voter" => $_voter,
                            "Urbanicity" => $_urbanicity,
                        //miscellaneous

                        //contact information
                            "Phone" => $_mobile_phone,
                            "Phone2" => $_mobile_phone2,
                            "Phone3" => $_mobile_phone3,    
                            "TaxBillInformation" => $taxBillInformationString,
                        //contact information

                        //household information
                            "NumAdultsHousehold" => $_num_adults_household,
                            "NumChildrenHousehold" => $_num_children_household,
                            "NumPersonsHousehold" => $_num_persons_household,
                            "ChildAged03Household" => $_child_aged_0_3_household,
                            "ChildAged46Household" => $_child_aged_4_6_household,
                            "ChildAged79Household" => $_child_aged_7_9_household,
                            "ChildAged1012Household" => $_child_aged_10_12_household,
                            "ChildAged1318Household" => $_child_aged_13_18_household,
                            "ChildrenHousehold" => $_children_household,
                        //household information

                        //marketing indicators
                            // "HasEmail" => $_has_email,
                            // "HasPhone" => $_has_phone,
                            "MagazineSubscriber" => $_magazine_subscriber,
                            "CharityInterest" => $_charity_interest,
                            "LikelyCharitableDonor" => $_likely_charitable_donor,
                        //marketing indicators

                        //house and real estate
                            "DwellingType" => $_dwelling_type,
                            "HomeOwner" => $_home_owner,
                            "HomeOwnerOrdinal" => $_home_owner_ordinal,
                            "LengthOfResidence" => $_length_of_residence,
                            "HomePrice" => $_home_price,
                            "HomeValue" => $_home_value,
                            "MedianHomeValue" => $_median_home_value,
                            "LivingSqft" => $_living_sqft,
                            "YrBuiltOrig" => $_year_built_original,
                            "YrBuiltRange" => $_year_built_range,
                            "LotNumber" => $_lot_number,
                            "LegalDescription" => $_legal_description,
                            "LandSqft" => $_land_sqft,
                            "GarageSqft" => $_garage_sqft,
                            "Subdivision" => $_subdivision,
                            "ZoningCode" => $_zoning_code,
                        //house and real estate

                        //interest and affinities
                            "Cooking" => $_cooking,
                            "Gardening" => $_gardening,
                            "Music" => $_music,
                            "Diy" => $_diy,
                            "Books" => $_books,
                            "TravelVacation" => $_travel_vacation,
                            "HealthBeautyProducts" => $_health_beauty_products,
                            "PetOwner" => $_pet_owner,
                            "Photography" => $_photography,
                            "Fitness" => $_fitness,
                            "Epicurean" => $_epicurean,
                        //interest and affinities

                        //location and census data
                            "Cbsa" => $_cbsa,
                            "CensusBlock" => $_census_block,
                            "CensusBlockGroup" => $_census_block_group,
                            "CensusTract" => $_census_tract,
                        //location and census data

                    // Person advance
                    ];

                    $new_advance = array_merge($new_advance, $person_advance);
                }

                Log::info("BigBDM Result Ready to Serve");
                /** IF BIG BDM MD5 HAVE RESULT */
            }else{

                    
                $trackBigBDM = $trackBigBDM . $is_advance ? "->BDMAdvanceNoData" : "->BDMNoData" ;
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                    $frupdate = FailedRecord::find($failedRecordID);
                    $frupdate->description = $frupdate->description . '|NoDataReturnFromBigBDMAdvance';
                    $frupdate->save();
                /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                $new_advance = array();
                    /** BIG BDM NO RESULT CHECK TOWER DATA */
            }

            $new = array_merge($new, $new_advance);
        // ADVANCE LEADS 

        // // B2B LEADS 
        //     if (count($new) > 0 && $is_local_custom['is_b2b']) {//if campaign B2B Information Selected

        //     // b2b field 
        //         $_employee_id = '';
        //         $_company_email = '';
        //         $_company_name = '';
        //         $_company_website = '';
        //         $_phone_1_employee = '';
        //         $_phone_1_company = '';
        //         $_num_employees = '';
        //         $_sales_volume = '';
        //         $_year_founded = '';
        //         $_job_title = '';
        //         $_level = '';
        //         $_job_function = '';
        //         $_headquarters_branch = '';
        //         $_naics_code = '';
        //         $_last_seen_date = '';
        //         $_linked_in = '';
        //         $local_b2b_exist = true; //set charged
        //     // b2b field 

        //         $trackBigBDM = $trackBigBDM . "->BDMB2B";

        //         Log::info("Start Check BigBDM B2B");
        //         $startBigbdmMD5Time = microtime(true);


        //         $bigDBM_B2B = [];
        //         if (!empty($is_local_custom['b2b'])) {// if selected fields is empty, no need to hit BIGDBM but client still be charged
        //             $bigDBM_B2B = $this->bigDBM_B2B($md5param,$leadspeek_api_id,$leadspeektype);
        //         }

        //         $endBigbdmMD5Time = microtime(true);

        //         // convert epochtime to date format ('Y-m-d H:i:s')
        //         $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        //         $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        //         // convert epochtime to date format ('Y-m-d H:i:s')

        //         $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        //         $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        //         $executionTimeList['bigBDM_MD5_B2B'] = [
        //             'start_execution_time' => $startBigbdmMD5Date,
        //             'end_execution_time' => $endBigbdmMD5Date,
        //             'total_execution_time' => $totalBigbdmMD5Time,
        //         ];

        //         $new_b2b = [];
        //         if (count((array)$bigDBM_B2B) > 0) {
        //             Log::info("BigBDMB2B Have result");
                    
        //             $trackBigBDM = $trackBigBDM . "->MD5B2B";
        //             /** REPORT ANALYTIC */
        //                 $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
        //             /** REPORT ANALYTIC */

        //             foreach ($bigDBM_B2B as $rd => $a) {    
        //                 $_FirstName = (isset($a[0]['First_Name']))?$a[0]['First_Name']:'';
        //                 $_LastName = (isset($a[0]['Last_Name']))?$a[0]['Last_Name']:'';
        //                 $bigEmail = (isset($a[0]['B2B_Email']))?$a[0]['B2B_Email']:'';
        //                 $bigEmail = explode(",",$bigEmail);
        //                 $_Address1 = (isset($a[0]['Address']))?$a[0]['Address']:'';
        //                 $_City =  (isset($a[0]['City']))?$a[0]['City']:'';
        //                 $_State = (isset($a[0]['State']))?$a[0]['State']:'';
        //                 $_Zipcode = (isset($a[0]['Zip5']))?$a[0]['Zip5']:'';

        //                 $_employee_id = (isset($a[0]['EmployeeID']))?$a[0]['EmployeeID']:'';
        //                 $_company_name = (isset($a[0]['Company_Name']))?$a[0]['Company_Name']:'';
        //                 $_company_website = (isset($a[0]['Company_Website']))?$a[0]['Company_Website']:'';
        //                 $_phone_1_employee = (isset($a[0]['Phone1_Employee']))?$a[0]['Phone1_Employee']:'';
        //                 $_phone_1_company = (isset($a[0]['Phone1_Company']))?$a[0]['Phone1_Company']:'';
        //                 $_num_employees = (isset($a[0]['Num_Employees']))?$a[0]['Num_Employees']:'';
        //                 $_sales_volume = (isset($a[0]['Sales_Volume']))?$a[0]['Sales_Volume']:'';
        //                 $_year_founded = (isset($a[0]['Year_Founded']))?$a[0]['Year_Founded']:0;  
        //                 $_job_title = (isset($a[0]['Job_Title']))?$a[0]['Job_Title']:'';
        //                 $_level = (isset($a[0]['Level']))?$a[0]['Level']:'';
        //                 $_job_function = (isset($a[0]['Job_Function']))?$a[0]['Job_Function']:'';
        //                 $_headquarters_branch = (isset($a[0]['Headquarters_Branch']))?$a[0]['Headquarters_Branch']:0;
        //                 $_naics_code = (isset($a[0]['NAICS_CODE']))?$a[0]['NAICS_CODE']:'';
        //                 $_last_seen_date = (isset($a[0]['LastSeenDate']))?$a[0]['LastSeenDate']:'';
        //                 $_linked_in = (isset($a[0]['LinkedIn']))?$a[0]['LinkedIn']:'';

        //             }

        //             /** GET BUSINESS EMAIL*/
        //             if (count($bigEmail) > 0 && isset($bigEmail[0]) && isset($bigEmail[0]) != '') {
        //                 $_company_email =  $bigEmail[0];
        //                 $tmpEmail = strtolower(trim($_company_email));
        //                 $tmpMd5 = md5($tmpEmail);
        //                 $newpersonemail = PersonEmail::create([
        //                     'person_id' => $newPersonID,
        //                     'email' => $tmpEmail,
        //                     'email_encrypt' => $tmpMd5,
        //                     'permission' => 'T',
        //                     'zbvalidate' => date('Y-m-d H:i:s'),
        //                 ]);

        //             }
        //             /** GET BUSINESS EMAIL*/ 

        //             /** INSERT INTO PERSON_B2B */
        //             $personB2B = PersonB2B::create([
        //                 'person_id' => $newPersonID,
        //                 'employee_id' => $_employee_id,
        //                 'company_name' => $_company_name,
        //                 'company_website' => $_company_website,
        //                 'phone_1_employee' => $_phone_1_employee,
        //                 'phone_1_company' => $_phone_1_company,
        //                 'num_employees' => $_num_employees,
        //                 'sales_volume' => $_sales_volume,
        //                 'year_founded' => $_year_founded,
        //                 'job_title' => $_job_title,
        //                 'level' => $_level,
        //                 'job_function' => $_job_function,
        //                 'headquarters_branch' => $_headquarters_branch,
        //                 'naics_code' => $_naics_code,
        //                 'last_seen_date' => $_last_seen_date,
        //                 'linked_in' => $_linked_in,
        //             ]);

        //             if (trim($_phone_1_employee) != "") {
        //                 /** INSERT PERSON_PHONES */
        //                 $newpersonphone = PersonPhone::create([
        //                     'person_id' => $newPersonID,
        //                     'number' => $this->format_phone($_phone_1_employee),
        //                     'type' => 'user',
        //                     'isConnected' => 'T',
        //                     'firstReportedDate' => date('Y-m-d'),
        //                     'lastReportedDate' => date('Y-m-d'),
        //                     'permission' => 'F',
        //                 ]);
        //                 /** INSERT PERSON_PHONES */
        //             }


        //             $new_b2b = array(
        //                 "EmployeeID" => $_employee_id,
        //                 "CompanyName" => $_company_name,
        //                 "CompanyWebsite" => $_company_website,
        //                 "CompanyEmail" => $_company_email,
        //                 "Phone1Employee" => $_phone_1_employee,
        //                 "Phone1Company" => $_phone_1_company,
        //                 "NumEmployees" => $_num_employees,
        //                 "SalesVolume" => $_sales_volume,
        //                 "YearFounded" => $_year_founded,
        //                 "JobTitle" => $_job_title,
        //                 "Level" => $_level,
        //                 "JobFunction" => $_job_function,
        //                 "HeadquartersBranch" => $_headquarters_branch,
        //                 "NaicsCode" => $_naics_code,
        //                 "LastSeenDate" => $_last_seen_date,
        //                 "LinkedIn" => $_linked_in,
        //                 "local_b2b_exist" => $local_b2b_exist,
        //             );

        //             Log::info("BigBDM B2B Result Ready to Serve");
        //             /** IF BIG BDM MD5 HAVE RESULT */
        //         }else{

        //             $trackBigBDM = $trackBigBDM . "->B2BNoData";
        //             /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        //                 $frupdate = FailedRecord::find($failedRecordID);
        //                 $frupdate->description = $frupdate->description . '|NoDataReturnFromB2B';
        //                 $frupdate->save();
        //             /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

        //             $new_b2b = array(
        //                 "local_b2b_exist" => $local_b2b_exist,//even data is empty, campaign should be chared. because it's hit BIGDBM API already
        //             );
        //         }

        //         $new = array_merge($new, $new_b2b);
        //     }
        // // B2B LEADS 

        if (count($new) > 0) {

            /** CHECK FOR LOCATION LOCK */
                $chkloc = $this->checklocationlock($loctarget,$new['Zipcode'],$new['State'],$new['City'],$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$failedRecordID);
                if ($chkloc) {
                    $trackBigBDM = $trackBigBDM . "->LocationLockFailed";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlockfailed');
                    /** REPORT ANALYTIC */

                    /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_local_custom',
                        'type' => 'blocked',
                        'blocked_type' => 'locationlock',
                        'description' => "blocked in checklocationlock zip = $loczip, state = $locstate, stateexclude = $locstateexclude, city = $loccity function process_BDM_TowerDATA",
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                    /* WRITE UPSER FAILED LEAD RECORD */
                    
                    $new = array();
                }else{
                    $trackBigBDM = $trackBigBDM . "->LocationLockSuccess";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlock');
                    /** REPORT ANALYTIC */
                }
            /** CHECK FOR LOCATION LOCK */
        }

            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        Log::info("BigBDM DATA FINAL RETURN");

        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    public function process_BDM_TowerDATA($loctarget = 'Focus',$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$loczip = "",$locstate = "",$locstateexclude = "",$locstatesifi = "",$loccity = "",$loccitysifi = "",$nationaltargeting = "F",$leadspeektype = "",$initLock="") {
        $executionTimeList = [];

        date_default_timezone_set('America/Chicago');

        $new = array();

        $_ID = "";
        $_FirstName = "";
        $_LastName = "";
        $_Email = "";
        $_Email2 = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');
        $_Referer = "";
        $_Phone = "";
        $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        $_Description = $dataflow . "dataNotExistOnDBBDMTD|" . $failedRecordID;

        $trackBigBDM = "BDMTOWERDATA";

        Log::info("Start Check BigBDM MD5");
        $startBigbdmMD5Time = microtime(true);

        $is_advance = false;
        $bigBDM_MD5 = $this->bigBDM_MD5($md5param,$leadspeek_api_id,$leadspeektype,$is_advance);

        $endBigbdmMD5Time = microtime(true);

        // convert epochtime to date format ('Y-m-d H:i:s')
        $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        // convert epochtime to date format ('Y-m-d H:i:s')

        $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        $executionTimeList['bigBDM_MD5'] = [
            'start_execution_time' => $startBigbdmMD5Date,
            'end_execution_time' => $endBigbdmMD5Date,
            'total_execution_time' => $totalBigbdmMD5Time,
        ];

        /** IF BIG BDM MD5 HAVE RESULT */
        if (count((array)$bigBDM_MD5) > 0) {
            Log::info("BigBDM Have result");
            
            $trackBigBDM = $trackBigBDM . "->MD5";
            /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
            /** REPORT ANALYTIC */

            foreach ($bigBDM_MD5 as $rd => $a) {
                $bigEmail = (isset($a[0]->Email))?$a[0]->Email:'';
                $bigEmail = explode(",",$bigEmail);

                $bigPhone = (isset($a[0]->Phone))?$a[0]->Phone:'';
                $bigPhone = explode(",",$bigPhone);

                $_FirstName = (isset($a[0]->First_Name))?$a[0]->First_Name:'';
                $_LastName = (isset($a[0]->Last_Name))?$a[0]->Last_Name:'';
                //$_Email = $bigEmail[0];
                //$_Email2 = (isset($bigEmail[1]))?$bigEmail[1]:'';
                $_Phone = $bigPhone[0];
                $_Phone2 = (isset($bigPhone[1]))?$bigPhone[1]:'';
                // $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                if(isset($a[0]->Addr_Primary)){
                    $_Address1 = (isset($a[0]->Addr_Primary))?$a[0]->Addr_Primary:'';
                }else{
                    $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                }
                if(isset($a[0]->Addr_Secondary)){
                    $_Address2 = (isset($a[0]->Addr_Secondary))?$a[0]->Addr_Secondary:'';
                }
                $_City =  (isset($a[0]->City))?$a[0]->City:'';
                $_State = (isset($a[0]->State))?$a[0]->State:'';
                $_Zipcode = (isset($a[0]->Zip))?$a[0]->Zip:'';
            }

            $uniqueID = uniqid();
            /** INSERT INTO DATABASE PERSON */
                $newPerson = Person::create([
                    'uniqueID' => $uniqueID,
                    'firstName' => $_FirstName,
                    'middleName' => '',
                    'lastName' => $_LastName,
                    'age' => '0',
                    'identityScore' => '0',
                    'lastEntry' => date('Y-m-d H:i:s'),
                ]);

                $newPersonID = $newPerson->id;
            /** INSERT INTO DATABASE PERSON */

            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */
            $filteredEmails = [];
            $otherEmails = [];
            foreach ($bigEmail as $index => $email) {
                if (strpos($email, 'yahoo.com') !== false || strpos($email, 'aol.com') !== false) {
                    $filteredEmails[] = $email;
                } else {
                    $otherEmails[] = $email;
                }
            }
            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */

            Log::info("BigBDM Have result - CHECK ZERO BOUNCE");
            /** NEW METHOD TO CHECK AND GET EMAIL */
            foreach($otherEmails as $index => $be) {
                if (trim($be) != "") {
                    $tmpEmail = strtolower(trim($be));
                    $tmpMd5 = md5($tmpEmail);

                    $startZbValidationTime = microtime(true);
                    
                    $param = [
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'leadspeek_type' => $leadspeektype,
                        'md5param' => $tmpMd5,
                    ];
                    $zbcheck = $this->true_list_validation($tmpEmail,$param);

                    $endZbValidationTime = microtime(true);

                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')

                    $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                    $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                    $executionTimeList['zb_validation'] = [
                        'start_execution_time' => $startZbValidationDate,
                        'end_execution_time' => $endZbValidationDate,
                        'total_execution_time' => $totalZbValidationTime
                    ];

                    // Handle both TrueList and ZeroBounce responses
                    $isValid = false;
                    $validationStatus = '';
                    $apiType = '';
                    
                    // Check TrueList response format
                    if (isset($zbcheck->emails[0]->email_state)) {
                        $validationStatus = $zbcheck->emails[0]->email_state;
                        $apiType = 'truelist';
                        $isValid = ($zbcheck->emails[0]->email_state == "ok");
                    }
                    // Check ZeroBounce response format
                    elseif (isset($zbcheck->status)) {
                        $validationStatus = $zbcheck->status;
                        $apiType = 'zerobounce';
                        $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                    }
                    
                    if ($validationStatus !== '') {
                        if (!$isValid) {
                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $tmpEmail,
                                'emailmd5' => md5($tmpEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                            ]);
                            /** PUT IT ON OPTOUT LIST */

                            if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                $this->UpsertFailedLeadRecord([
                                    'function' => __FUNCTION__,
                                    'type' => 'blocked',
                                    'blocked_type' => $apiType,
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                    'leadspeek_api_id' => $leadspeek_api_id,
                                    'email_encrypt' => $tmpMd5,
                                    'leadspeek_type' => $leadspeektype,
                                    'email' => $tmpEmail,
                                    'status' => $validationStatus,
                                ]);
                            }

                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                        }else{
                            $newpersonemail = PersonEmail::create([
                                'person_id' => $newPersonID,
                                'email' => $tmpEmail,
                                'email_encrypt' => $tmpMd5,
                                'permission' => 'T',
                                'zbvalidate' => date('Y-m-d H:i:s'),
                            ]);

                            if ($_Email ==  "") {
                                $_Email = $tmpEmail;
                            }else if ($_Email2 == "") {
                                $_Email2 = $tmpEmail;
                            }

                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                        }

                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                        /** REPORT ANALYTIC */
                        
                    }else{
                        $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                    }

                }
            }
            /** NEW METHOD TO CHECK AND GET EMAIL */

            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */
            if (trim($_Email) == '') {
                /** NEW METHOD TO CHECK AND GET EMAIL */
                foreach($filteredEmails as $index => $be) {
                    if (trim($be) != "") {
                        $tmpEmail = strtolower(trim($be));
                        $tmpMd5 = md5($tmpEmail);

                        $startZbValidationTime = microtime(true);

                        $param = [
                            'leadspeek_api_id' => $leadspeek_api_id,
                            'leadspeek_type' => $leadspeektype,
                            'md5param' => $tmpMd5,
                        ];
                        $zbcheck = $this->true_list_validation($tmpEmail,$param);

                        $endZbValidationTime = microtime(true);

                        // convert epochtime to date format ('Y-m-d H:i:s')
                        $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        // convert epochtime to date format ('Y-m-d H:i:s')

                        $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                        $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                        $executionTimeList['zb_validation'] = [
                            'start_execution_time' => $startZbValidationDate,
                            'end_execution_time' => $endZbValidationDate,
                            'total_execution_time' => $totalZbValidationTime
                        ];

                        // Handle both TrueList and ZeroBounce responses
                        $isValid = false;
                        $validationStatus = '';
                        $apiType = '';
                        
                        // Check TrueList response format
                        if (isset($zbcheck->emails[0]->email_state)) {
                            $validationStatus = $zbcheck->emails[0]->email_state;
                            $apiType = 'truelist';
                            $isValid = ($zbcheck->emails[0]->email_state == "ok");
                        }
                        // Check ZeroBounce response format
                        elseif (isset($zbcheck->status)) {
                            $validationStatus = $zbcheck->status;
                            $apiType = 'zerobounce';
                            $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                        }
                        
                        if ($validationStatus !== '') {
                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                            /** REPORT ANALYTIC */
                            if (!$isValid) {
                                /** PUT IT ON OPTOUT LIST */
                                $createoptout = OptoutList::create([
                                    'email' => $tmpEmail,
                                    'emailmd5' => md5($tmpEmail),
                                    'blockedcategory' => 'zbnotvalid',
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                ]);
                                /** PUT IT ON OPTOUT LIST */

                                if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                    $this->UpsertFailedLeadRecord([
                                        'function' => __FUNCTION__,
                                        'type' => 'blocked',
                                        'blocked_type' => $apiType,
                                        'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                        'leadspeek_api_id' => $leadspeek_api_id,
                                        'email_encrypt' => $tmpMd5,
                                        'leadspeek_type' => $leadspeektype,
                                        'email' => $tmpEmail,
                                        'status' => $validationStatus,
                                    ]);
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                            }else{
                                $newpersonemail = PersonEmail::create([
                                    'person_id' => $newPersonID,
                                    'email' => $tmpEmail,
                                    'email_encrypt' => $tmpMd5,
                                    'permission' => 'T',
                                    'zbvalidate' => date('Y-m-d H:i:s'),
                                ]);

                                if ($_Email ==  "") {
                                    $_Email = $tmpEmail;
                                    break;
                                }else if ($_Email2 == "") {
                                    $_Email2 = $tmpEmail;
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                            }
                        }else{
                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                        }

                    }
                }
                /** NEW METHOD TO CHECK AND GET EMAIL */
            }
            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */

            // if (trim($_Email) != '') {
            //     $tmpEmail = strtolower(trim($_Email));
            //     $tmpMd5 = md5($tmpEmail);

            //     $zbcheck = $this->zb_validation($tmpEmail,"");
            //     if (isset($zbcheck->status)) {
            //         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
            //             /** PUT IT ON OPTOUT LIST */
            //             $createoptout = OptoutList::create([
            //                 'email' => $tmpEmail,
            //                 'emailmd5' => md5($tmpEmail),
            //                 'blockedcategory' => 'zbnotvalid',
            //                 'description' => 'Zero Bounce Status. : ' . $zbcheck->status . '|Email1fromBigMD5',
            //             ]);
            //             /** PUT IT ON OPTOUT LIST */
            //             $_Email = "";

            //             $trackBigBDM = $trackBigBDM . "->Email1ZBFailed";
            //             /** REPORT ANALYTIC */
            //             //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
            //             /** REPORT ANALYTIC */
            //         }else{

            //             $newpersonemail = PersonEmail::create([
            //                 'person_id' => $newPersonID,
            //                 'email' => $tmpEmail,
            //                 'email_encrypt' => $tmpMd5,
            //                 'permission' => 'T',
            //                 'zbvalidate' => date('Y-m-d H:i:s'),
            //             ]);

            //             $_Email = $tmpEmail;

            //             $trackBigBDM = $trackBigBDM . "->Email1ZBSuccess";
            //             /** REPORT ANALYTIC */
            //                 //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
            //             /** REPORT ANALYTIC */

            //         }

            //     }else{
            //         $newpersonemail = PersonEmail::create([
            //             'person_id' => $newPersonID,
            //             'email' => $tmpEmail,
            //             'email_encrypt' => $tmpMd5,
            //             'permission' => 'T',
            //             'zbvalidate' => null,
            //         ]);

            //         $_Email = $tmpEmail;

            //         $trackBigBDM = $trackBigBDM . "->Email1ZBNotValidate";

            //     }
            // }

            // if (trim($_Email2) != '') {
            //     $tmpEmail = strtolower(trim($_Email2));
            //     $tmpMd5 = md5($tmpEmail);

            //     $zbcheck = $this->zb_validation($tmpEmail,"");
            //     if (isset($zbcheck->status)) {
            //         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
            //             /** PUT IT ON OPTOUT LIST */
            //             $createoptout = OptoutList::create([
            //                 'email' => $tmpEmail,
            //                 'emailmd5' => md5($tmpEmail),
            //                 'blockedcategory' => 'zbnotvalid',
            //                 'description' => 'Zero Bounce Status. : ' . $zbcheck->status . '|Email2fromBigMD5',
            //             ]);
            //             /** PUT IT ON OPTOUT LIST */
            //             $_Email2 = "";

            //             $trackBigBDM = $trackBigBDM . "->Email2ZBFailed";
            //             /** REPORT ANALYTIC */
            //             //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
            //             /** REPORT ANALYTIC */
            //         }else{

            //             $newpersonemail = PersonEmail::create([
            //                 'person_id' => $newPersonID,
            //                 'email' => $tmpEmail,
            //                 'email_encrypt' => $tmpMd5,
            //                 'permission' => 'T',
            //                 'zbvalidate' => date('Y-m-d H:i:s'),
            //             ]);

            //             $_Email2 = $tmpEmail;

            //             $trackBigBDM = $trackBigBDM . "->Email2ZBSuccess";
            //             /** REPORT ANALYTIC */
            //                 //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
            //             /** REPORT ANALYTIC */

            //         }

            //     }else{
            //         $newpersonemail = PersonEmail::create([
            //             'person_id' => $newPersonID,
            //             'email' => $tmpEmail,
            //             'email_encrypt' => $tmpMd5,
            //             'permission' => 'T',
            //             'zbvalidate' => null,
            //         ]);

            //         $_Email2 = $tmpEmail;

            //         $trackBigBDM = $trackBigBDM . "->Email2ZBNotValidate";

            //     }
            // }

            // if (trim($_Email) == "" && trim($_Email2) != "") {
            //     $_Email = $_Email2;
            //     $_Email2 = "";
            // }
            if (trim($_Email) == "" && trim($_Email2) == "") {
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                    $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                /** REPORT ANALYTIC */

                Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 and Email 2 NOT VALID");

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 NOT VALID CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */


                /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_TowerData',
                        'type' => 'blocked',
                        'blocked_type' => 'truelist',
                        'description' => 'blocked in truelist fetch bigBDM_MD5 function process_BDM_TowerData',
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                /* WRITE UPSER FAILED LEAD RECORD */
            }else{
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                    $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                /** REPORT ANALYTIC */
                Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 and Email 2 VALID");

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 VALID CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
            }

            Log::info("BigBDM BDM_TOWERDATA CHECK PHONE1");

            if (trim($_Phone) != "") {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_Phone),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            Log::info("BigBDM BDM_TOWERDATA CHECK PHONE2");
            if (trim($_Phone2) != "") {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_Phone2),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            Log::info("BigBDM BDM_TOWERDATA CHECK Address");
            /** INSERT INTO PERSON_ADDRESSES */
            $newpersonaddress = PersonAddress::create([
                'person_id' => $newPersonID,
                'street' => $_Address1,
                'unit' => $_Address2,
                'city' => $_City,
                'state' => $_State,
                'zip' => $_Zipcode,
                'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                'firstReportedDate' => date('Y-m-d'),
                'lastReportedDate' => date('Y-m-d'),
            ]);

            /** INSERT INTO PERSON_ADDRESSES */

            $_ID = $this->generateReportUniqueNumber();

            Log::info("BigBDM Have result - ReportID #" . $_ID);

            $new = array(
                "ID" => $_ID,
                "Email" => $_Email,
                "Email2" => $_Email2,
                "OriginalMD5" => $md5param,
                "IP" => $_IP,
                "Source" => $_Source,
                "OptInDate" => $_OptInDate,
                "ClickDate" => $_ClickDate,
                "Referer" => $_Referer,
                "Phone" => $_Phone,
                "Phone2" => $_Phone2,
                "FirstName" => $_FirstName,
                "LastName" => $_LastName,
                "Address1" => $_Address1,
                "Address2" => $_Address2,
                "City" => $_City,
                "State" => $_State,
                "Zipcode" => $_Zipcode,
                "PersonID" => $newPersonID,
                "Keyword" => $keyword,
                "Description" => $_Description,
                "LeadFrom" => "bigbdmmd5"
            );

            Log::info("BigBDM Result Ready to Serve");
            /** IF BIG BDM MD5 HAVE RESULT */
        }else{
                Log::info("BigBDM Not Have Result");
                Log::info("Start Check Tower Data");
                /** BIG BDM NO RESULT CHECK TOWER DATA */
                if (isset($md5param) && trim($md5param) != "") {
                    $startGetTowerDataTime = microtime(true);

                    $tower = $this->getTowerData("postal",$md5param,$leadspeek_api_id,$leadspeektype);

                    $endGetTowerDataTime = microtime(true);

                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startGetTowerDataDate = Carbon::createFromTimestamp($startGetTowerDataTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endGetTowerDataDate = Carbon::createFromTimestamp($endGetTowerDataTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')

                    $totalGetTowerDataTime = $endGetTowerDataTime - $startGetTowerDataTime;
                    $totalGetTowerDataTime = number_format($totalGetTowerDataTime,2,'.','');

                    $executionTime['getTowerData'] = [
                        'start_execution_time' => $startGetTowerDataDate,
                        'end_execution_time' => $endGetTowerDataDate,
                        'total_execution_time' => $totalGetTowerDataTime,
                    ];

                    /* EMPTY TO FETCH DATA IN getTowerData FUNCTION */
                    if(count((array) $tower) == 0) {
                        $tower = "";
                    }
                    /* EMPTY TO FETCH DATA IN getTowerData FUNCTION */
                }

                if (isset($md5param) && trim($md5param) != "" && isset($tower->postal_address)) {
                    $_fname = $tower->postal_address->first_name;
                    $_lname = $tower->postal_address->last_name;
                    $_email = "";
                    $_phone = "";
                    $_address = $tower->postal_address->address;
                    $_city = $tower->postal_address->city;
                    $_state = $tower->postal_address->state;
                    $_zip = $tower->postal_address->zip;

                    $trackBigBDM = $trackBigBDM . "->TDPostal";
                    /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'towerpostal');
                    /** REPORT ANALYTIC */

                    /** CHECK WITH BIG BDM PII */
                        $startBigbdmPIITime = microtime(true);

                        $bigBDM_PII = $this->bigBDM_PII($_fname,$_lname,$_address,$_zip,$md5param,$leadspeek_api_id,$leadspeektype);

                        $endBigbdmPIITime = microtime(true);

                        // convert epochtime to date format ('Y-m-d H:i:s')
                        $startBigbdmPIIDate = Carbon::createFromTimestamp($startBigbdmPIITime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        $endBigbdmPIIDate = Carbon::createFromTimestamp($endBigbdmPIITime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        // convert epochtime to date format ('Y-m-d H:i:s')

                        $totalBigbdmPIITime = $endBigbdmPIITime - $startBigbdmPIITime;
                        $totalBigbdmPIITime = number_format($totalBigbdmPIITime,2,'.','');

                        $executionTime['bigBDM_PII'] = [
                            'start_execution_time' => $startBigbdmPIIDate,
                            'end_execution_time' => $endBigbdmPIIDate,
                            'total_execution_time' => $totalBigbdmPIITime,
                        ];

                        /** IF BIG BDM PII HAVE RESULT */
                        if (count((array)$bigBDM_PII) > 0) {

                            $trackBigBDM = $trackBigBDM . "->BIGPII";
                            /** REPORT ANALYTIC */
                                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmpii');
                            /** REPORT ANALYTIC */

                            foreach ($bigBDM_PII as $rd => $a) {
                                $bigEmail = (isset($a[0]->Email))?$a[0]->Email:'';
                                $bigEmail = explode(",",$bigEmail);

                                $bigPhone = (isset($a[0]->Phone))?$a[0]->Phone:'';
                                $bigPhone = explode(",",$bigPhone);

                                $_FirstName = (isset($a[0]->First_Name))?$a[0]->First_Name:'';
                                $_LastName = (isset($a[0]->Last_Name))?$a[0]->Last_Name:'';
                                //$_Email = $bigEmail[0];
                                //$_Email2 = (isset($bigEmail[1]))?$bigEmail[1]:'';
                                $_Phone = $bigPhone[0];
                                $_Phone2 = (isset($bigPhone[1]))?$bigPhone[1]:'';
                                // $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                                if(isset($a[0]->Addr_Primary)){
                                    $_Address1 = (isset($a[0]->Addr_Primary))?$a[0]->Addr_Primary:'';
                                }else{
                                    $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                                }
                                if(isset($a[0]->Addr_Secondary)){
                                    $_Address2 = (isset($a[0]->Addr_Secondary))?$a[0]->Addr_Secondary:'';
                                }
                
                                $_City =  (isset($a[0]->City))?$a[0]->City:'';
                                $_State = (isset($a[0]->State))?$a[0]->State:'';
                                $_Zipcode = (isset($a[0]->Zip))?$a[0]->Zip:'';
                            }

                            $uniqueID = uniqid();
                            /** INSERT INTO DATABASE PERSON */
                                $newPerson = Person::create([
                                    'uniqueID' => $uniqueID,
                                    'firstName' => $_FirstName,
                                    'middleName' => '',
                                    'lastName' => $_LastName,
                                    'age' => '0',
                                    'identityScore' => '0',
                                    'lastEntry' => date('Y-m-d H:i:s'),
                                ]);

                                $newPersonID = $newPerson->id;
                            /** INSERT INTO DATABASE PERSON */

                            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */
                            $filteredEmails = [];
                            $otherEmails = [];
                            foreach ($bigEmail as $index => $email) {
                                if (strpos($email, 'yahoo.com') !== false || strpos($email, 'aol.com') !== false) {
                                    $filteredEmails[] = $email;
                                } else {
                                    $otherEmails[] = $email;
                                }
                            }
                            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */

                            /** NEW METHOD TO CHECK AND GET EMAIL */
                            foreach($otherEmails as $index => $be) {
                                if (trim($be) != "") {
                                    $tmpEmail = strtolower(trim($be));
                                    $tmpMd5 = md5($tmpEmail);

                                    $startZbValidationTime = microtime(true);

                                    // $zbcheck = $this->zb_validation($tmpEmail,"");
                                    $param = [
                                        'leadspeek_api_id' => $leadspeek_api_id,
                                        'leadspeek_type' => $leadspeektype,
                                        'md5param' => $tmpMd5,
                                    ];
                                    $zbcheck = $this->true_list_validation($tmpEmail,$param);
                                    
                                    $endZbValidationTime = microtime(true);

                                    // convert epochtime to date format ('Y-m-d H:i:s')
                                    $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                                    $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                                    // convert epochtime to date format ('Y-m-d H:i:s')

                                    $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                                    $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                                    $executionTimeList['zb_validation'] = [
                                        'start_execution_time' => $startZbValidationDate,
                                        'end_execution_time' => $endZbValidationDate,
                                        'total_execution_time' => $totalZbValidationTime
                                    ];
                                    
                                    // Handle both TrueList and ZeroBounce responses
                                    $isValid = false;
                                    $validationStatus = '';
                                    $apiType = '';

                                    if (isset($zbcheck->emails[0]->email_state)) {
                                        $validationStatus = $zbcheck->emails[0]->email_state;
                                        $apiType = 'truelist';
                                        $isValid = ($zbcheck->emails[0]->email_state == "ok");
                                    } elseif (isset($zbcheck->status)) {
                                        $validationStatus = $zbcheck->status;
                                        $apiType = 'zerobounce';
                                        $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                                    }
                                    if ($validationStatus !== '') {
                                        if (!$isValid) {
                                            /** PUT IT ON OPTOUT LIST */
                                            $createoptout = OptoutList::create([
                                                'email' => $tmpEmail,
                                                'emailmd5' => md5($tmpEmail),
                                                'blockedcategory' => 'zbnotvalid',
                                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                            ]);
                                            /** PUT IT ON OPTOUT LIST */

                                            if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                                $this->UpsertFailedLeadRecord([
                                                    'function' => __FUNCTION__,
                                                    'type' => 'blocked',
                                                    'blocked_type' => $apiType,
                                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                                    'leadspeek_api_id' => $leadspeek_api_id,
                                                    'email_encrypt' => $tmpMd5,
                                                    'leadspeek_type' => $leadspeektype,
                                                    'email' => $tmpEmail,
                                                    'status' => $validationStatus,
                                                ]);
                                            }            

                                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                                        }else{
                                            $newpersonemail = PersonEmail::create([
                                                'person_id' => $newPersonID,
                                                'email' => $tmpEmail,
                                                'email_encrypt' => $tmpMd5,
                                                'permission' => 'T',
                                                'zbvalidate' => date('Y-m-d H:i:s'),
                                            ]);

                                            if ($_Email ==  "") {
                                                $_Email = $tmpEmail;
                                            }else if ($_Email2 == "") {
                                                $_Email2 = $tmpEmail;
                                            }

                                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                                        }
                                        /** REPORT ANALYTIC */
                                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,$apiType . '_details',$validationStatus);
                                        /** REPORT ANALYTIC */
                                    }else{
                                        $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                                    }

                                }
                            }
                            /** NEW METHOD TO CHECK AND GET EMAIL */

                            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */
                            if (trim($_Email) == '') {
                                /** NEW METHOD TO CHECK AND GET EMAIL */
                                foreach($filteredEmails as $index => $be) {
                                    if (trim($be) != "") {
                                        $tmpEmail = strtolower(trim($be));
                                        $tmpMd5 = md5($tmpEmail);

                                        $startZbValidationTime = microtime(true);
                                        $param = [
                                            'leadspeek_api_id' => $leadspeek_api_id,
                                            'leadspeek_type' => $leadspeektype,
                                            'md5param' => $tmpMd5,
                                        ];
                                        $zbcheck = $this->true_list_validation($tmpEmail,$param);

                                        $endZbValidationTime = microtime(true);

                                        // convert epochtime to date format ('Y-m-d H:i:s')
                                        $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                                        $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                                        // convert epochtime to date format ('Y-m-d H:i:s')

                                        $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                                        $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                                        $executionTimeList['zb_validation'] = [
                                            'start_execution_time' => $startZbValidationDate,
                                            'end_execution_time' => $endZbValidationDate,
                                            'total_execution_time' => $totalZbValidationTime
                                        ];

                                        // Handle both TrueList and ZeroBounce responses
                                        $isValid = false;
                                        $validationStatus = '';
                                        $apiType = '';

                                        if (isset($zbcheck->emails[0]->email_state)) {
                                            $validationStatus = $zbcheck->emails[0]->email_state;
                                            $apiType = 'truelist';
                                            $isValid = ($zbcheck->emails[0]->email_state == "ok");
                                        } elseif (isset($zbcheck->status)) {
                                            $validationStatus = $zbcheck->status;
                                            $apiType = 'zerobounce';
                                            $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                                        }
                                        if ($validationStatus !== '') {
                                            /** REPORT ANALYTIC */
                                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,$apiType . '_details',$validationStatus);
                                            /** REPORT ANALYTIC */
                                            if (!$isValid) {                    
                                                /** PUT IT ON OPTOUT LIST */
                                                $createoptout = OptoutList::create([
                                                    'email' => $tmpEmail,
                                                    'emailmd5' => md5($tmpEmail),
                                                    'blockedcategory' => 'zbnotvalid',
                                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                                ]);
                                                /** PUT IT ON OPTOUT LIST */
                                                
                                                if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                                    $this->UpsertFailedLeadRecord([
                                                        'function' => __FUNCTION__,
                                                        'type' => 'blocked',
                                                        'blocked_type' => $apiType,
                                                        'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                                        'leadspeek_api_id' => $leadspeek_api_id,
                                                        'email_encrypt' => $tmpMd5,
                                                        'leadspeek_type' => $leadspeektype,
                                                        'email' => $tmpEmail,
                                                        'status' => $validationStatus,
                                                    ]);
                                                }

                                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                                            }else{
                                                $newpersonemail = PersonEmail::create([
                                                    'person_id' => $newPersonID,
                                                    'email' => $tmpEmail,
                                                    'email_encrypt' => $tmpMd5,
                                                    'permission' => 'T',
                                                    'zbvalidate' => date('Y-m-d H:i:s'),
                                                ]);

                                                if ($_Email ==  "") {
                                                    $_Email = $tmpEmail;
                                                    break;
                                                }else if ($_Email2 == "") {
                                                    $_Email2 = $tmpEmail;
                                                }

                                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                                            }
                                        }else{
                                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                                        }

                                    }
                                }
                                /** NEW METHOD TO CHECK AND GET EMAIL */
                            }
                            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */

                            // if (trim($_Email) != '') {
                            //     $tmpEmail = strtolower(trim($_Email));
                            //     $tmpMd5 = md5($tmpEmail);

                            //     $zbcheck = $this->zb_validation($tmpEmail,"");
                            //     if (isset($zbcheck->status)) {
                            //         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                            //             /** PUT IT ON OPTOUT LIST */
                            //             $createoptout = OptoutList::create([
                            //                 'email' => $tmpEmail,
                            //                 'emailmd5' => md5($tmpEmail),
                            //                 'blockedcategory' => 'zbnotvalid',
                            //                 'description' => 'Zero Bounce Status. : ' . $zbcheck->status . '|Email1fromBigPII',
                            //             ]);
                            //             /** PUT IT ON OPTOUT LIST */
                            //             $_Email = "";

                            //             $trackBigBDM = $trackBigBDM . "->Email1ZBFailed";
                            //             /** REPORT ANALYTIC */
                            //             //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                            //             /** REPORT ANALYTIC */
                            //         }else{

                            //             $newpersonemail = PersonEmail::create([
                            //                 'person_id' => $newPersonID,
                            //                 'email' => $tmpEmail,
                            //                 'email_encrypt' => $tmpMd5,
                            //                 'permission' => 'T',
                            //                 'zbvalidate' => date('Y-m-d H:i:s'),
                            //             ]);

                            //             $_Email = $tmpEmail;

                            //             $trackBigBDM = $trackBigBDM . "->Email1ZBSuccess";
                            //             /** REPORT ANALYTIC */
                            //                 //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                            //             /** REPORT ANALYTIC */

                            //         }

                            //     }else{
                            //         $newpersonemail = PersonEmail::create([
                            //             'person_id' => $newPersonID,
                            //             'email' => $tmpEmail,
                            //             'email_encrypt' => $tmpMd5,
                            //             'permission' => 'T',
                            //             'zbvalidate' => null,
                            //         ]);

                            //         $_Email = $tmpEmail;
                            //         $trackBigBDM = $trackBigBDM . "->Email1ZBNotValidate";

                            //     }
                            // }

                            // if (trim($_Email2) != '') {
                            //     $tmpEmail = strtolower(trim($_Email2));
                            //     $tmpMd5 = md5($tmpEmail);

                            //     $zbcheck = $this->zb_validation($tmpEmail,"");
                            //     if (isset($zbcheck->status)) {
                            //         if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                            //             /** PUT IT ON OPTOUT LIST */
                            //             $createoptout = OptoutList::create([
                            //                 'email' => $tmpEmail,
                            //                 'emailmd5' => md5($tmpEmail),
                            //                 'blockedcategory' => 'zbnotvalid',
                            //                 'description' => 'Zero Bounce Status. : ' . $zbcheck->status . '|Email2fromBigPII',
                            //             ]);
                            //             /** PUT IT ON OPTOUT LIST */
                            //             $_Email2 = "";

                            //             $trackBigBDM = $trackBigBDM . "->Email2ZBFailed";
                            //             /** REPORT ANALYTIC */
                            //             //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                            //             /** REPORT ANALYTIC */
                            //         }else{

                            //             $newpersonemail = PersonEmail::create([
                            //                 'person_id' => $newPersonID,
                            //                 'email' => $tmpEmail,
                            //                 'email_encrypt' => $tmpMd5,
                            //                 'permission' => 'T',
                            //                 'zbvalidate' => date('Y-m-d H:i:s'),
                            //             ]);

                            //             $_Email2 = $tmpEmail;

                            //             $trackBigBDM = $trackBigBDM . "->Email2ZBSuccess";
                            //             /** REPORT ANALYTIC */
                            //                 //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                            //             /** REPORT ANALYTIC */

                            //         }

                            //     }else{
                            //         $newpersonemail = PersonEmail::create([
                            //             'person_id' => $newPersonID,
                            //             'email' => $tmpEmail,
                            //             'email_encrypt' => $tmpMd5,
                            //             'permission' => 'T',
                            //             'zbvalidate' => null,
                            //         ]);

                            //         $_Email2 = $tmpEmail;
                            //         $trackBigBDM = $trackBigBDM . "->Email2ZBNotValidate";

                            //     }
                            // }

                            // if (trim($_Email) == "" && trim($_Email2) != "") {
                            //     $_Email = $_Email2;
                            //     $_Email2 = "";
                            // }

                            if (trim($_Email) == "" && trim($_Email2) == "") {
                                /** REPORT ANALYTIC */
                                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                                    $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                                /** REPORT ANALYTIC */

                                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA TOWERDATA - Email 1 and Email 2 NOT VALID CampaignID #" . $leadspeek_api_id);
                                // $this->releaseLock($initLock);
                                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

                                /* WRITE UPSER FAILED LEAD RECORD */
                                    $this->UpsertFailedLeadRecord([
                                        'function' => 'process_BDM_TowerData',
                                        'type' => 'blocked',
                                        'blocked_type' => 'truelist',
                                        'description' => 'blocked in truelist fetch bigBDM_PII function process_BDM_TowerData',
                                        'leadspeek_api_id' => $leadspeek_api_id,
                                        'email_encrypt' => $md5param,
                                        'leadspeek_type' => $leadspeektype,
                                    ]);
                                /* WRITE UPSER FAILED LEAD RECORD */
                            }else{

                                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                                //     Log::info("RELEASE GETDATAMATCH LOCK Process DATA TOWERDATA - Email 1 and Email 2 VALID CampaignID #" . $leadspeek_api_id);
                                //     $this->releaseLock($initLock);
                                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */

                                /** REPORT ANALYTIC */
                                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                                    $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                                /** REPORT ANALYTIC */
                            }

                            Log::info("BigBDM TOWERDATA CHECK PHONE1");

                            if (trim($_Phone) != "") {
                                /** INSERT PERSON_PHONES */
                                $newpersonphone = PersonPhone::create([
                                    'person_id' => $newPersonID,
                                    'number' => $this->format_phone($_Phone),
                                    'type' => 'user',
                                    'isConnected' => 'T',
                                    'firstReportedDate' => date('Y-m-d'),
                                    'lastReportedDate' => date('Y-m-d'),
                                    'permission' => 'F',
                                ]);
                                /** INSERT PERSON_PHONES */
                            }

                            Log::info("BigBDM TOWERDATA CHECK PHONE2");

                            if (trim($_Phone2) != "") {
                                /** INSERT PERSON_PHONES */
                                $newpersonphone = PersonPhone::create([
                                    'person_id' => $newPersonID,
                                    'number' => $this->format_phone($_Phone2),
                                    'type' => 'user',
                                    'isConnected' => 'T',
                                    'firstReportedDate' => date('Y-m-d'),
                                    'lastReportedDate' => date('Y-m-d'),
                                    'permission' => 'F',
                                ]);
                                /** INSERT PERSON_PHONES */
                            }

                            Log::info("BigBDM BDM_TOWERDATA CHECK ADDRESS");

                            /** INSERT INTO PERSON_ADDRESSES */
                            $newpersonaddress = PersonAddress::create([
                                'person_id' => $newPersonID,
                                'street' => $_Address1,
                                'unit' => $_Address2,
                                'city' => $_City,
                                'state' => $_State,
                                'zip' => $_Zipcode,
                                'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                                'firstReportedDate' => date('Y-m-d'),
                                'lastReportedDate' => date('Y-m-d'),
                            ]);

                            /** INSERT INTO PERSON_ADDRESSES */

                            $_ID = $this->generateReportUniqueNumber();
                            
                            Log::info("BigBDM TOWERDATA Have result - ReportID #" . $_ID);

                            $new = array(
                                "ID" => $_ID,
                                "Email" => $_Email,
                                "Email2" => $_Email2,
                                "OriginalMD5" => $md5param,
                                "IP" => $_IP,
                                "Source" => $_Source,
                                "OptInDate" => $_OptInDate,
                                "ClickDate" => $_ClickDate,
                                "Referer" => $_Referer,
                                "Phone" => $_Phone,
                                "Phone2" => $_Phone2,
                                "FirstName" => $_FirstName,
                                "LastName" => $_LastName,
                                "Address1" => $_Address1,
                                "Address2" => $_Address2,
                                "City" => $_City,
                                "State" => $_State,
                                "Zipcode" => $_Zipcode,
                                "PersonID" => $newPersonID,
                                "Keyword" => $keyword,
                                "Description" => $_Description,
                                "LeadFrom" => "gettowerdata"
                            );

                            /** IF BIG BDM PII HAVE RESULT */
                            Log::info("BigBDM PII Result Ready to Serve");
                        }else{

                            $trackBigBDM = $trackBigBDM . "->BDMPIINoData";
                            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                                $frupdate = FailedRecord::find($failedRecordID);
                                $frupdate->description = $frupdate->description . '|NoDataReturnFromBigBDMPII';
                                $frupdate->save();
                            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                            $new = array();
                        }
                    /** CHECK WITH BIG BDM PII */

                }else{

                    $trackBigBDM = $trackBigBDM . "->TDPostalNoData";
                    /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                        $frupdate = FailedRecord::find($failedRecordID);
                        $frupdate->description = $frupdate->description . '|NoDataReturnFromPostalTowerData';
                        $frupdate->save();
                    /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

                    $new = array();
                    /** RECORD AS FAILURE */
                }
                /** BIG BDM NO RESULT CHECK TOWER DATA */
        }

        if (count($new) > 0) {
            /** CHECK FOR LOCATION LOCK */
                $chkloc = $this->checklocationlock($loctarget,$new['Zipcode'],$new['State'],$new['City'],$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$failedRecordID);
                if ($chkloc) {
                    $trackBigBDM = $trackBigBDM . "->LocationLockFailed";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlockfailed');
                    /** REPORT ANALYTIC */

                    /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_TowerDATA',
                        'type' => 'blocked',
                        'blocked_type' => 'locationlock',
                        'description' => "blocked in checklocationlock zip = $loczip, state = $locstate, stateexclude = $locstateexclude, city = $loccity function process_BDM_TowerDATA",
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                    /* WRITE UPSER FAILED LEAD RECORD */
                    
                    $new = array();
                }else{
                    $trackBigBDM = $trackBigBDM . "->LocationLockSuccess";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlock');
                    /** REPORT ANALYTIC */
                }
            /** CHECK FOR LOCATION LOCK */
        }

            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        Log::info("BigBDM DATA FINAL RETURN");

        // return $new;
        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    public function process_BDM_B2B_exist($person_id = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$leadspeektype = "") {
        $executionTimeList = [];

        date_default_timezone_set('America/Chicago');

        $new = array();

        $_ID = "";
        $_FirstName = "";
        $_LastName = "";
        $_Email = "";
        $_Email2 = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');
        $_Referer = "";
        // $_Phone = "";
        // $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        $_Description = $dataflow . "dataNotExistOnDBBDMB2B|" . $failedRecordID;

        // b2b field 
        $_employee_id = '';
        $_company_name = '';
        $_company_website = '';
        $_phone_1_employee = '';
        $_phone_1_company = '';
        $_num_employees = '';
        $_sales_volume = '';
        $_year_founded = '';
        $_job_title = '';
        $_level = '';
        $_job_function = '';
        $_headquarters_branch = '';
        $_naics_code = '';
        $_last_seen_date = '';
        $_linked_in = '';
        // b2b field 
        

        $trackBigBDM = "BDMB2B";

        Log::info("Start Check BigBDM B2B");
        $startBigbdmMD5Time = microtime(true);

        $bigDBM_B2B = $this->bigDBM_B2B($md5param,$leadspeek_api_id,$leadspeektype);

        $endBigbdmMD5Time = microtime(true);

        // convert epochtime to date format ('Y-m-d H:i:s')
        $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        // convert epochtime to date format ('Y-m-d H:i:s')

        $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        $executionTimeList['bigBDM_MD5_B2B'] = [
            'start_execution_time' => $startBigbdmMD5Date,
            'end_execution_time' => $endBigbdmMD5Date,
            'total_execution_time' => $totalBigbdmMD5Time,
        ];

        /** IF BIG BDM MD5 HAVE RESULT */
        if (count((array)$bigDBM_B2B) > 0) {
            Log::info("BigBDM Have result");
            
            $trackBigBDM = $trackBigBDM . "->B2B";
            /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
            /** REPORT ANALYTIC */

            foreach ($bigDBM_B2B as $rd => $a) {    
                $_FirstName = (isset($a[0]['First_Name']))?$a[0]['First_Name']:'';
                $_LastName = (isset($a[0]['Last_Name']))?$a[0]['Last_Name']:'';
                $bigEmail = (isset($a[0]['B2B_Email']))?$a[0]['B2B_Email']:'';
                $bigEmail = explode(",",$bigEmail);
                $_Address1 = (isset($a[0]['Address']))?$a[0]['Address']:'';
                $_City =  (isset($a[0]['City']))?$a[0]['City']:'';
                $_State = (isset($a[0]['State']))?$a[0]['State']:'';
                $_Zipcode = (isset($a[0]['Zip5']))?$a[0]['Zip5']:'';

                $_employee_id = (isset($a[0]['EmployeeID']))?$a[0]['EmployeeID']:'';
                $_company_name = (isset($a[0]['Company_Name']))?$a[0]['Company_Name']:'';
                $_company_website = (isset($a[0]['Company_Website']))?$a[0]['Company_Website']:'';
                $_phone_1_employee = (isset($a[0]['Phone1_Employee']))?$a[0]['Phone1_Employee']:'';
                $_phone_1_company = (isset($a[0]['Phone1_Company']))?$a[0]['Phone1_Company']:'';
                $_num_employees = (isset($a[0]['Num_Employees']))?$a[0]['Num_Employees']:'';
                $_sales_volume = (isset($a[0]['Sales_Volume']))?$a[0]['Sales_Volume']:'';
                $_year_founded = (isset($a[0]['Year_Founded']))?$a[0]['Year_Founded']:0;  
                $_job_title = (isset($a[0]['Job_Title']))?$a[0]['Job_Title']:'';
                $_level = (isset($a[0]['Level']))?$a[0]['Level']:'';
                $_job_function = (isset($a[0]['Job_Function']))?$a[0]['Job_Function']:'';
                $_headquarters_branch = (isset($a[0]['Headquarters_Branch']))?$a[0]['Headquarters_Branch']:0;
                $_naics_code = (isset($a[0]['NAICS_CODE']))?$a[0]['NAICS_CODE']:'';
                $_last_seen_date = (isset($a[0]['LastSeenDate']))?$a[0]['LastSeenDate']:'';
                $_linked_in = (isset($a[0]['LinkedIn']))?$a[0]['LinkedIn']:'';

            }

            /** INSERT INTO PERSON_B2B */
            $personB2B = PersonB2B::create([
                'person_id' => $person_id,
                'employee_id' => $_employee_id,
                'company_name' => $_company_name,
                'company_website' => $_company_website,
                'phone_1_employee' => $_phone_1_employee,
                'phone_1_company' => $_phone_1_company,
                'num_employees' => $_num_employees,
                'sales_volume' => $_sales_volume,
                'year_founded' => $_year_founded,
                'job_title' => $_job_title,
                'level' => $_level,
                'job_function' => $_job_function,
                'headquarters_branch' => $_headquarters_branch,
                'naics_code' => $_naics_code,
                'last_seen_date' => $_last_seen_date,
                'linked_in' => $_linked_in,
            ]);

            $_ID = $this->generateReportUniqueNumber();

            Log::info("BigBDM B2B Have result - ReportID #" . $_ID);

            $new = array(   
                "ID" => $_ID,
                // "Email" => $_Email,
                // "Email2" => $_Email2,
                "OriginalMD5" => $md5param,
                "IP" => $_IP,
                "Source" => $_Source,
                "OptInDate" => $_OptInDate,
                "ClickDate" => $_ClickDate,
                "Referer" => $_Referer,
                // "Phone" => $_Phone,
                // "Phone2" => $_Phone2,
                "FirstName" => $_FirstName,
                "LastName" => $_LastName,
                "Address1" => $_Address1,
                "Address2" => $_Address2,
                "City" => $_City,
                "State" => $_State,
                "Zipcode" => $_Zipcode,
                "EmployeeID" => $_employee_id,
                "CompanyName" => $_company_name,
                "CompanyWebsite" => $_company_website,
                "Phone1Employee" => $_phone_1_employee,
                "Phone1Company" => $_phone_1_company,
                "NumEmployees" => $_num_employees,
                "SalesVolume" => $_sales_volume,
                "YearFounded" => $_year_founded,
                "JobTitle" => $_job_title,
                "Level" => $_level,
                "JobFunction" => $_job_function,
                "HeadquartersBranch" => $_headquarters_branch,
                "NaicsCode" => $_naics_code,
                "LastSeenDate" => $_last_seen_date,
                "LinkedIn" => $_linked_in,
                "PersonID" => $person_id,
                "Description" => $_Description,
                "LeadFrom" => "bigbdmb2b"
            );

            Log::info("BigBDM B2B Result Ready to Serve");
            /** IF BIG BDM MD5 HAVE RESULT */
        }else{
            $trackBigBDM = $trackBigBDM . "->B2BNoData";
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|NoDataReturnFromB2B';
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

            $new = array();
        }

        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
            $frupdate = FailedRecord::find($failedRecordID);
            $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
            $frupdate->save();
        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        Log::info("BigBDM B2B DATA FINAL RETURN");

        // return $new;
        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    public function process_BDM_B2B($loctarget = 'Focus',$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$loczip = "",$locstate = "",$locstateexclude = "",$locstatesifi = "",$loccity = "",$loccitysifi = "",$nationaltargeting = "F",$leadspeektype = "",$initLock="") {
        $executionTimeList = [];

        date_default_timezone_set('America/Chicago');

        $new = array();

        $_ID = "";
        $_FirstName = "";
        $_LastName = "";
        $_Email = "";
        $_Email2 = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');
        $_Referer = "";
        $_Phone = "";
        $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        $_Description = $dataflow . "dataNotExistOnDBBDMB2B|" . $failedRecordID;

        // b2b field 
        $_employee_id = '';
        $_company_name = '';
        $_company_website = '';
        $_phone_1_employee = '';
        $_phone_1_company = '';
        $_num_employees = '';
        $_sales_volume = '';
        $_year_founded = '';
        $_job_title = '';
        $_level = '';
        $_job_function = '';
        $_headquarters_branch = '';
        $_naics_code = '';
        $_last_seen_date = '';
        $_linked_in = '';
        // b2b field 
        

        $trackBigBDM = "BDMB2B";

        Log::info("Start Check BigBDM B2B");
        $startBigbdmMD5Time = microtime(true);

        $bigDBM_B2B = $this->bigDBM_B2B($md5param,$leadspeek_api_id,$leadspeektype);

        $endBigbdmMD5Time = microtime(true);

        // convert epochtime to date format ('Y-m-d H:i:s')
        $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        // convert epochtime to date format ('Y-m-d H:i:s')

        $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        $executionTimeList['bigBDM_MD5_B2B'] = [
            'start_execution_time' => $startBigbdmMD5Date,
            'end_execution_time' => $endBigbdmMD5Date,
            'total_execution_time' => $totalBigbdmMD5Time,
        ];

        /** IF BIG BDM MD5 HAVE RESULT */
        if (count((array)$bigDBM_B2B) > 0) {
            Log::info("BigBDM Have result");
            
            $trackBigBDM = $trackBigBDM . "->B2B";
            /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
            /** REPORT ANALYTIC */

            foreach ($bigDBM_B2B as $rd => $a) {    
                $_FirstName = (isset($a[0]['First_Name']))?$a[0]['First_Name']:'';
                $_LastName = (isset($a[0]['Last_Name']))?$a[0]['Last_Name']:'';
                $bigEmail = (isset($a[0]['B2B_Email']))?$a[0]['B2B_Email']:'';
                $bigEmail = explode(",",$bigEmail);
                $_Address1 = (isset($a[0]['Address']))?$a[0]['Address']:'';
                $_City =  (isset($a[0]['City']))?$a[0]['City']:'';
                $_State = (isset($a[0]['State']))?$a[0]['State']:'';
                $_Zipcode = (isset($a[0]['Zip5']))?$a[0]['Zip5']:'';

                $_employee_id = (isset($a[0]['EmployeeID']))?$a[0]['EmployeeID']:'';
                $_company_name = (isset($a[0]['Company_Name']))?$a[0]['Company_Name']:'';
                $_company_website = (isset($a[0]['Company_Website']))?$a[0]['Company_Website']:'';
                $_phone_1_employee = (isset($a[0]['Phone1_Employee']))?$a[0]['Phone1_Employee']:'';
                $_phone_1_company = (isset($a[0]['Phone1_Company']))?$a[0]['Phone1_Company']:'';
                $_num_employees = (isset($a[0]['Num_Employees']))?$a[0]['Num_Employees']:'';
                $_sales_volume = (isset($a[0]['Sales_Volume']))?$a[0]['Sales_Volume']:'';
                $_year_founded = (isset($a[0]['Year_Founded']))?$a[0]['Year_Founded']:0;  
                $_job_title = (isset($a[0]['Job_Title']))?$a[0]['Job_Title']:'';
                $_level = (isset($a[0]['Level']))?$a[0]['Level']:'';
                $_job_function = (isset($a[0]['Job_Function']))?$a[0]['Job_Function']:'';
                $_headquarters_branch = (isset($a[0]['Headquarters_Branch']))?$a[0]['Headquarters_Branch']:0;
                $_naics_code = (isset($a[0]['NAICS_CODE']))?$a[0]['NAICS_CODE']:'';
                $_last_seen_date = (isset($a[0]['LastSeenDate']))?$a[0]['LastSeenDate']:'';
                $_linked_in = (isset($a[0]['LinkedIn']))?$a[0]['LinkedIn']:'';

            }
    
            $uniqueID = uniqid();
            /** INSERT INTO DATABASE PERSON */
                $newPerson = Person::create([
                    'uniqueID' => $uniqueID,
                    'firstName' => $_FirstName,
                    'middleName' => '',
                    'lastName' => $_LastName,
                    'age' => '0',
                    'identityScore' => '0',
                    'lastEntry' => date('Y-m-d H:i:s'),
                ]);

                $newPersonID = $newPerson->id;
            /** INSERT INTO DATABASE PERSON */

            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */    
            $filteredEmails = [];
            $otherEmails = [];

            foreach ($bigEmail as $index => $email) {
                if (strpos($email, 'yahoo.com') !== false || strpos($email, 'aol.com') !== false) {
                    $filteredEmails[] = $email;
                } else {
                    $otherEmails[] = $email;
                }
            }
            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */

            Log::info("BigBDM Have result - CHECK ZERO BOUNCE");

            /** NEW METHOD TO CHECK AND GET EMAIL */
            foreach($otherEmails as $index => $be) {
                if (trim($be) != "") {
                    $tmpEmail = strtolower(trim($be));
                    $tmpMd5 = md5($tmpEmail);

                    $startZbValidationTime = microtime(true);
                    $param = [
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'leadspeek_type' => $leadspeektype,
                        'md5param' => $tmpMd5,
                    ];
                    $zbcheck = $this->true_list_validation($tmpEmail,$param);
                    $endZbValidationTime = microtime(true);
                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')

                    $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                    $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                    $executionTimeList['zb_validation'] = [
                        'start_execution_time' => $startZbValidationDate,
                        'end_execution_time' => $endZbValidationDate,
                        'total_execution_time' => $totalZbValidationTime
                    ];                    

                    // Handle both TrueList and ZeroBounce responses
                    $isValid = false;
                    $validationStatus = '';
                    $apiType = '';

                    // TrueList response
                    if (isset($zbcheck->emails[0]->email_state)) {
                        $validationStatus = $zbcheck->emails[0]->email_state;
                        $apiType = 'truelist';
                        $isValid = ($zbcheck->emails[0]->email_state == "ok");
                    }
                    // ZeroBounce response
                    elseif (isset($zbcheck->status)) {
                        $validationStatus = $zbcheck->status;
                        $apiType = 'zerobounce';
                        $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                    }
                    if ($validationStatus !== '') {
                        if (!$isValid) {
                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $tmpEmail,
                                'emailmd5' => md5($tmpEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigB2B',
                            ]);
                            /** PUT IT ON OPTOUT LIST */

                            if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                $this->UpsertFailedLeadRecord([
                                    'function' => __FUNCTION__,
                                    'type' => 'blocked',
                                    'blocked_type' => $apiType,
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigB2B',
                                    'leadspeek_api_id' => $leadspeek_api_id,
                                    'email_encrypt' => $tmpMd5,
                                    'leadspeek_type' => $leadspeektype,
                                    'email' => $tmpEmail,
                                    'status' => $validationStatus,
                                ]);
                            }

                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                        }else{    
                            $newpersonemail = PersonEmail::create([
                                'person_id' => $newPersonID,
                                'email' => $tmpEmail,
                                'email_encrypt' => $tmpMd5,
                                'permission' => 'T',
                                'zbvalidate' => date('Y-m-d H:i:s'),
                            ]);

                            if ($_Email ==  "") {
                                $_Email = $tmpEmail;
                            }else if ($_Email2 == "") {
                                $_Email2 = $tmpEmail;
                            }

                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                        }
                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                        /** REPORT ANALYTIC */
                    }else{
                        $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                    }

                }
            }
            /** NEW METHOD TO CHECK AND GET EMAIL */

            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */
            if (trim($_Email) == '') {
                /** NEW METHOD TO CHECK AND GET EMAIL */
                foreach($filteredEmails as $index => $be) {
                    if (trim($be) != "") {
                        $tmpEmail = strtolower(trim($be));
                        $tmpMd5 = md5($tmpEmail);

                        $startZbValidationTime = microtime(true);

                        $param = [
                            'leadspeek_api_id' => $leadspeek_api_id,
                            'leadspeek_type' => $leadspeektype,
                            'md5param' => $tmpMd5,
                        ];
                        $zbcheck = $this->true_list_validation($tmpEmail,$param);

                        $endZbValidationTime = microtime(true);

                        // convert epochtime to date format ('Y-m-d H:i:s')
                        $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        // convert epochtime to date format ('Y-m-d H:i:s')

                        $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                        $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                        $executionTimeList['zb_validation'] = [
                            'start_execution_time' => $startZbValidationDate,
                            'end_execution_time' => $endZbValidationDate,
                            'total_execution_time' => $totalZbValidationTime
                        ];

                        // Handle both TrueList and ZeroBounce responses
                        $isValid = false;
                        $validationStatus = '';
                        $apiType = '';

                        // TrueList response
                        if (isset($zbcheck->emails[0]->email_state)) {
                            $validationStatus = $zbcheck->emails[0]->email_state;
                            $apiType = 'truelist';
                            $isValid = ($zbcheck->emails[0]->email_state == "ok");
                        }
                        // ZeroBounce response
                        elseif (isset($zbcheck->status)) {
                            $validationStatus = $zbcheck->status;
                            $apiType = 'zerobounce';
                            $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                        }

                        if ($validationStatus !== '') {
                                /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                                /** REPORT ANALYTIC */
                            if (!$isValid) {
                                /** PUT IT ON OPTOUT LIST */
                                $createoptout = OptoutList::create([
                                    'email' => $tmpEmail,
                                    'emailmd5' => md5($tmpEmail),
                                    'blockedcategory' => 'zbnotvalid',
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigB2B',
                                ]);
                                /** PUT IT ON OPTOUT LIST */

                                if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                    $this->UpsertFailedLeadRecord([
                                        'function' => __FUNCTION__,
                                        'type' => 'blocked',
                                        'blocked_type' => $apiType,
                                        'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigB2B',
                                        'leadspeek_api_id' => $leadspeek_api_id,
                                        'email_encrypt' => $tmpMd5,
                                        'leadspeek_type' => $leadspeektype,
                                        'email' => $tmpEmail,
                                        'status' => $validationStatus,
                                    ]);
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                            }else{
                                $newpersonemail = PersonEmail::create([
                                    'person_id' => $newPersonID,
                                    'email' => $tmpEmail,
                                    'email_encrypt' => $tmpMd5,
                                    'permission' => 'T',
                                    'zbvalidate' => date('Y-m-d H:i:s'),
                                ]);

                                if ($_Email ==  "") {
                                    $_Email = $tmpEmail;
                                    break;
                                }else if ($_Email2 == "") {
                                    $_Email2 = $tmpEmail;
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                            }
                        }else{
                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                        }

                    }
                }
                /** NEW METHOD TO CHECK AND GET EMAIL */
            }

            if (trim($_Email) == "" && trim($_Email2) == "") {
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                    $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                /** REPORT ANALYTIC */

                Log::info("BigBDM B2B Have result - CHECK ZERO BOUNCE - Email 1 and Email 2 NOT VALID");

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM B2B - Email 1 and Email 2 NOT VALID CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */


                /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_B2B',
                        'type' => 'blocked',
                        'blocked_type' => 'truelist',
                        'description' => 'blocked in truelist fetch bigBDM_B2B function process_BDM_B2B',
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                /* WRITE UPSER FAILED LEAD RECORD */
            }else{
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                    $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                /** REPORT ANALYTIC */
                Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 and Email 2 VALID");

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 VALID CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
            }

            /** INSERT INTO PERSON_B2B */
            $personB2B = PersonB2B::create([
                'person_id' => $newPersonID,
                'employee_id' => $_employee_id,
                'company_name' => $_company_name,
                'company_website' => $_company_website,
                'phone_1_employee' => $_phone_1_employee,
                'phone_1_company' => $_phone_1_company,
                'num_employees' => $_num_employees,
                'sales_volume' => $_sales_volume,
                'year_founded' => $_year_founded,
                'job_title' => $_job_title,
                'level' => $_level,
                'job_function' => $_job_function,
                'headquarters_branch' => $_headquarters_branch,
                'naics_code' => $_naics_code,
                'last_seen_date' => $_last_seen_date,
                'linked_in' => $_linked_in,
            ]);

            if (trim($_phone_1_employee) != "") {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_phone_1_employee),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            Log::info("BigBDM BDM_B2B CHECK Address");
            /** INSERT INTO PERSON_ADDRESSES */
            $newpersonaddress = PersonAddress::create([
                'person_id' => $newPersonID,
                'street' => $_Address1,
                'unit' => '',
                'city' => $_City,
                'state' => $_State,
                'zip' => $_Zipcode,
                'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                'firstReportedDate' => date('Y-m-d'),
                'lastReportedDate' => date('Y-m-d'),
            ]);
            /** INSERT INTO PERSON_ADDRESSES */

            $_ID = $this->generateReportUniqueNumber();

            Log::info("BigBDM B2B Have result - ReportID #" . $_ID);

            $new = array(   
                "ID" => $_ID,
                "Email" => $_Email,
                "Email2" => $_Email2,
                "OriginalMD5" => $md5param,
                "IP" => $_IP,
                "Source" => $_Source,
                "OptInDate" => $_OptInDate,
                "ClickDate" => $_ClickDate,
                "Referer" => $_Referer,
                "Phone" => $_Phone,
                "Phone2" => $_Phone2,
                "FirstName" => $_FirstName,
                "LastName" => $_LastName,
                "Address1" => $_Address1,
                "Address2" => $_Address2,
                "City" => $_City,
                "State" => $_State,
                "Zipcode" => $_Zipcode,
                "EmployeeID" => $_employee_id,
                "CompanyName" => $_company_name,
                "CompanyWebsite" => $_company_website,
                "Phone1Employee" => $_phone_1_employee,
                "Phone1Company" => $_phone_1_company,
                "NumEmployees" => $_num_employees,
                "SalesVolume" => $_sales_volume,
                "YearFounded" => $_year_founded,
                "JobTitle" => $_job_title,
                "Level" => $_level,
                "JobFunction" => $_job_function,
                "HeadquartersBranch" => $_headquarters_branch,
                "NaicsCode" => $_naics_code,
                "LastSeenDate" => $_last_seen_date,
                "LinkedIn" => $_linked_in,
                "PersonID" => $newPersonID,
                "Keyword" => $keyword,
                "Description" => $_Description,
                "LeadFrom" => "bigbdmb2b"
            );

            Log::info("BigBDM B2B Result Ready to Serve");
            /** IF BIG BDM MD5 HAVE RESULT */
        }else{
            $trackBigBDM = $trackBigBDM . "->B2BNoData";
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|NoDataReturnFromB2B';
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

            $new = array();
        }

        if (count($new) > 0) {
            /** CHECK FOR LOCATION LOCK */

                $chkloc = $this->checklocationlock($loctarget,$new['Zipcode'],$new['State'],$new['City'],$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$failedRecordID);

                if ($chkloc) {
                    $trackBigBDM = $trackBigBDM . "->LocationLockFailed";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlockfailed');
                    /** REPORT ANALYTIC */

                    /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_B2B',
                        'type' => 'blocked',
                        'blocked_type' => 'locationlock',
                        'description' => "blocked in checklocationlock zip = $loczip, state = $locstate, city = $loccity function process_BDM_B2B",
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                    /* WRITE UPSER FAILED LEAD RECORD */
                    
                    $new = array();
                }else{
                    $trackBigBDM = $trackBigBDM . "->LocationLockSuccess";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'locationlock');
                    /** REPORT ANALYTIC */
                }
            /** CHECK FOR LOCATION LOCK */
        }

            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        Log::info("BigBDM B2B DATA FINAL RETURN");

        // return $new;
        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    public function process_BDM_advance($loctarget = 'Focus',$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$loczip = "",$locstate = "",$locstateexclude = "",$locstatesifi = "",$loccity = "",$loccitysifi = "",$nationaltargeting = "F",$leadspeektype = "",$initLock="",$is_advance = false) {
        $executionTimeList = [];

        date_default_timezone_set('America/Chicago');

        $new = array();

        //BASIC INFORMATION
        $_ID = "";
        $_FirstName = "";
        $_LastName = "";
        $_Email = "";
        $_Email2 = "";
        $_Email3 = "";
        // $_Phone = "";
        // $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        //BASIC INFORMATION

        //ADVANCE INFORMATION

            //identification
                $_gender_aux = "";
                $_age_aux = "";
                $_birth_year_aux = "";
                $_generation = "";
                $_marital_status = "";
            //identification
            
            //financial information
                $_household_income = "";
                $_median_household_income = "";
                $_household_net_worth = "";
                $_median_household_net_worth = "";
                $_discretionary_income = "";
                $_credit_score_median = "";
                $_credit_score_range = "";
            //financial information

            //occupation
                $_occupation_category = "";
                $_occupation_type = "";
                $_occupation_detail = "";
            //occupation
            
            //miscellaneous
                $_voter = "";
                $_urbanicity = "";
            //miscellaneous

            //contact information
                $_mobile_phone = "";
                $_mobile_phone2 = "";
                $_mobile_phone3 = "";
                $_mobile_phone_dnc = "";
                $_mobile_phone_dnc2 = "";
                $_mobile_phone_dnc3 = "";
                $_tax_bill_mailing_address = "";
                $_tax_bill_mailing_city = "";
                $_tax_bill_mailing_county = "";
                $_tax_bill_mailing_fips = "";
                $_tax_bill_mailing_state = "";
                $_tax_bill_mailing_zip = "";
                $_tax_bill_mailing_zip4 = "";
            //contact information

            //household information
                $_num_adults_household= "";
                $_num_children_household = "";
                $_num_persons_household = "";
                $_child_aged_0_3_household = "";
                $_child_aged_4_6_household = "";
                $_child_aged_7_9_household = "";
                $_child_aged_10_12_household = "";
                $_child_aged_13_18_household = "";
                $_children_household = "";
            //household information

            //marketing indicators
                $_has_email = "";
                $_has_phone = "";
                $_magazine_subscriber = "";
                $_charity_interest = "";
                $_likely_charitable_donor = "";            
            //marketing indicators

            //house and real estate
                $_dwelling_type = "";
                $_home_owner = "";
                $_home_owner_ordinal = "";
                $_length_of_residence = "";
                $_home_price = "";
                $_home_value = "";
                $_median_home_value = "";
                $_living_sqft = "";
                $_year_built_original = "";
                $_year_built_range = "";
                $_lot_number = "";
                $_legal_description = "";
                $_land_sqft = "";
                $_garage_sqft = "";
                $_subdivision = "";
                $_zoning_code = "";
            //house and real estate

            //interest and affinities
                $_cooking = "";
                $_gardening = "";
                $_music = "";
                $_diy = "";
                $_books = "";
                $_travel_vacation = "";
                $_health_beauty_products = "";
                $_pet_owner = "";
                $_photography = "";
                $_fitness = "";
                $_epicurean = "";
            //interest and affinities

            //location and census data
                $_cbsa = "";
                $_census_block = "";
                $_census_block_group = "";
                $_census_tract = "";
            //location and census data

            //unregistered row
                $_aerobics = "";
                $_african_american_affinity = "";
                $_amex_card = "";
                $_antiques = "";
                $_apparel_accessory_affinity = "";
                $_apparel_affinity = "";
                $_arts_and_crafts = "";
                $_asian_affinity = "";
                $_auto_affinity = "";
                $_auto_racing_affinity = "";
                $_aviation_affinity = "";
                $_bank_card = "";
                $_bargain_hunter_affinity = "";
                $_baseball = "";
                $_baseball_affinity = "";
                $_basketball = "";
                $_basketball_affinity = "";
                $_beauty_affinity = "";
                $_bible_affinity = "";
                $_bird_watching = "";
                $_birds_affinity = "";
                $_blue_collar = "";
                $_boating_sailing = "";
                $_boating_sailing_affinity = "";
                $_business_affinity = "";
                $_camping_hiking = "";
                $_camping_hiking_climbing_affinity = "";
                $_cars_interest = "";
                $_cat_owner = "";
                $_catalog_affinity = "";
                $_cigars = "";
                $_classical_music = "";
                $_coins = "";
                $_collectibles_affinity = "";
                $_college_affinity = "";
                $_computers_affinity = "";
                $_continuity_program_affinity = "";
                $_cooking_affinity = "";
                $_cosmetics = "";
                $_country_music = "";
                $_crafts_affinity = "";
                $_credit_card = "";
                $_credit_repair_affinity = "";
                $_crochet_affinity = "";
                $_diet_affinity = "";
                $_dieting = "";
                $_do_it_yourself_affinity = "";
                $_dog_owner = "";
                $_doll_collector = "";
                $_donor_affinity = "";
                $_education = "";
                $_education_ordinal = "";
                $_education_seekers_affinity = "";
                $_ego_affinity = "";
                $_entertainment_interest = "";
                $_figurines_collector = "";
                $_fine_arts_collector = "";
                $_fishing = "";
                $_fishing_affinity = "";
                $_fitness_affinity = "";
                $_football = "";
                $_football_affinity = "";
                $_gambling = "";
                $_gambling_affinity = "";
                $_games_affinity = "";
                $_gardening_affinity = "";
                $_gender = "";
                $_generation_ordinal = "";
                $_golf = "";
                $_golf_affinity = "";
                $_gourmet_affinity = "";
                $_grandparents_affinity = "";
                $_health_affinity = "";
                $_healthy_living = "";
                $_healthy_living_interest = "";
                $_high_tech_affinity = "";
                $_hispanic_affinity = "";
                $_hockey = "";
                $_hockey_affinity = "";
                $_home_decor = "";
                $_home_improvement_interest = "";
                $_home_office_affinity = "";
                $_home_study = "";
                $_hunting = "";
                $_hunting_affinity = "";
                $_jazz = "";
                $_kids_apparel_affinity = "";
                $_knit_affinity = "";
                $_knitting_quilting_sewing = "";
                $_luxury_life = "";
                $_married = "";
                $_median_income = "";
                $_mens_apparel_affinity = "";
                $_mens_fashion_affinity = "";
                $_mortgage_age = "";
                $_mortgage_amount = "";
                $_mortgage_loan_type = "";
                $_mortgage_refi_age = "";
                $_mortgage_refi_amount = "";
                $_mortgage_refi_type = "";
                $_motor_racing = "";
                $_motorcycles = "";
                $_motorcycles_affinity = "";
                $_movies = "";
                $_nascar = "";
                $_needlepoint_affinity = "";
                $_new_credit_offered_household = "";
                $_num_credit_lines_household = "";
                $_num_generations_household = "";
                $_outdoors = "";
                $_outdoors_affinity = "";
                $_owns_investments = "";
                $_owns_mutual_funds = "";
                $_owns_stocks_and_bonds = "";
                $_owns_swimming_pool = "";
                $_personal_finance_affinity = "";
                $_personality = "";
                $_plates_collector = "";
                $_pop_density = "";
                $_premium_amex_card = "";
                $_premium_card = "";
                $_premium_income_household = "";
                $_premium_income_midpt_household = "";
                $_quilt_affinity = "";
                $_religious_music = "";
                $_rhythm_and_blues = "";
                $_rock_music = "";
                $_running = "";
                $_rv = "";
                $_scuba = "";
                $_self_improvement = "";
                $_sewing_affinity = "";
                $_single_family_dwelling = "";
                $_snow_skiing = "";
                $_snow_skiing_affinity = "";
                $_soccer = "";
                $_soccer_affinity = "";
                $_soft_rock = "";
                $_soho_business = "";
                $_sports_memoribilia_collector = "";
                $_stamps = "";
                $_sweepstakes_affinity = "";
                $_tennis = "";
                $_tennis_affinity = "";
                $_tobacco_affinity = "";
                $_travel_affinity = "";
                $_travel_cruise_affinity = "";
                $_travel_cruises = "";
                $_travel_personal = "";
                $_travel_rv_affinity = "";
                $_travel_us_affinity = "";
                $_truck_owner = "";
                $_trucks_affinity = "";
                $_tv_movies_affinity = "";
                $_veteran_household = "";
                $_walking = "";
                $_weight_lifting = "";
                $_wildlife_affinity = "";
                $_womens_apparel_affinity = "";
                $_womens_fashion_affinity = "";
                $_woodworking = "";
                $_male_aux = "";
                $_political_contributor_aux = "";
                $_political_party_aux = "";
                $_financial_power = "";
                $_mortgage_open_1st_intent = "";
                $_mortgage_open_2nd_intent = "";
                $_mortgage_new_intent = "";
                $_mortgage_refinance_intent = "";
                $_automotive_loan_intent = "";
                $_bank_card_intent = "";
                $_personal_loan_intent = "";
                $_retail_card_intent = "";
                $_student_loan_cons_intent = "";
                $_student_loan_intent = "";
                $_3qtr_baths = "";
                $_ac_type = "";
                $_acres = "";
                $_additions_square_feet = "";
                $_assess_val_impr = "";
                $_assess_val_lnd = "";
                $_assess_val_prop = "";
                $_bldg_style = "";
                $_bsmt_sqft = "";
                $_bsmt_type = "";
                $_build_sqft_assess = "";
                $_business = "";
                $_combined_statistical_area = "";
                $_metropolitan_division = "";
                $_middle = "";
                $_middle_2 = "";
                $_mkt_ip_perc = "";
                $_mobile_home = "";

                $_mrtg_due = "";
                $_mrtg_intrate = "";
                $_mrtg_refi = "";
                $_mrtg_term = "";
                $_mrtg_type = "";

                $_mrtg2_amt = "";
                $_mrtg2_date = "";
                $_mrtg2_deed_type = "";
                $_mrtg2_due = "";
                $_mrtg2_equity = "";
                $_mrtg2_intrate = "";
                $_mrtg2_inttype = "";
                $_mrtg2_refi = "";
                $_mrtg2_term = "";
                $_mrtg2_type = "";

                $_mrtg3_amt = "";
                $_mrtg3_date = "";
                $_mrtg3_deed_type = "";
                $_mrtg3_due = "";
                $_mrtg3_equity = "";
                $_mrtg3_inttype = "";
                $_mrtg3_refi = "";
                $_mrtg3_term = "";
                $_mrtg3_type = "";

                $_msa_code = "";
                $_number_bedrooms = "";
                $_number_bldgs = "";
                $_number_fireplace = "";
                $_number_park_spaces = "";
                $_number_rooms = "";
                $_own_biz = "";
                $_owner_occupied = "";
                $_ownership_relation = "";
                $_owner_type_description = "";
                $_estimated_value = "";
                $_ext_type = "";
                $_finish_square_feet2 = "";
                $_fireplace = "";
                $_first = "";
                $_first_2 = "";
                $_found_type = "";
                $_fr_feet = "";
                $_fuel_type = "";
                $_full_baths = "";
                $_half_baths = "";
                $_garage_type = "";
                $_grnd_sqft = "";
                $_heat_type = "";
                $_hmstd = "";
                $_impr_appr_val = "";
                $_imprval = "";
                $_imprval_type = "";
                $_land_appr_val = "";
                $_landval = "";
                $_landval_type = "";
                $_last = "";
                $_last_2 = "";
                $_lat = "";
                $_lender_name = "";
                $_lender2_name = "";
                $_lender3_name = "";
                $_loan_amt = "";
                $_loan_date = "";
                $_loan_to_val = "";
                $_lon = "";
                $_markval = "";
                $_markval_type = "";
                $_patio_porch = "";
                $_patio_square_feet = "";
                $_pool = "";
                $_porch_square_feet = "";
                $_previous_assessed_value = "";
                $_prop_type = "";
                $_rate_type = "";
                $_rec_date = "";
                $_roof_covtype = "";
                $_roof_shapetype = "";
                $_sale_amt = "";
                $_sale_amt_pr = "";
                $_sale_date = "";
                $_sale_type_pr = "";
                $_sales_type = "";
                $_sell_name = "";
                $_sewer_type = "";
                $_site_quality = "";
                $_std_address = "";
                $_std_city = "";
                $_std_state = "";
                $_std_zip = "";
                $_std_zip4 = "";
                $_stories_number = "";
                $_suffix = "";
                $_suffix_2 = "";
                $_tax_yr = "";
                $_tax_improvement_percent = "";
                $_title_co = "";
                $_tot_baths_est = "";
                $_ttl_appr_val = "";
                $_ttl_bld_sqft = "";
                $_ttl_tax = "";
                $_unit_number = "";
                $_vet_exempt = "";
                $_water_type = "";

            //unregistered row

        //ADVANCE INFORMATION

        $_Referer = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');

        $_Description = $dataflow . "dataNotExistOnDBBDMTD|" . $failedRecordID;

        $trackBigBDM = "BDMADVANCE";

        Log::info("Start Check BigBDM MD5 Advance");
        $startBigbdmMD5Time = microtime(true);

        $bigBDM_MD5_advance = $this->bigBDM_MD5($md5param,$leadspeek_api_id,$leadspeektype,$is_advance);

        $endBigbdmMD5Time = microtime(true);

        // convert epochtime to date format ('Y-m-d H:i:s')
        $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        // convert epochtime to date format ('Y-m-d H:i:s')

        $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        $executionTimeList['bigBDM_MD5_advance'] = [
            'start_execution_time' => $startBigbdmMD5Date,
            'end_execution_time' => $endBigbdmMD5Date,
            'total_execution_time' => $totalBigbdmMD5Time,
        ];

        /** IF BIG BDM MD5 HAVE RESULT */
        if (count((array)$bigBDM_MD5_advance) > 0) {
            Log::info("BigBDM Have result");
            
            $trackBigBDM = $trackBigBDM . "->MD5Advance";
            /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,'enhance','bigbdmemail');
            /** REPORT ANALYTIC */

            foreach ($bigBDM_MD5_advance as $rd => $a) {

            //BASIC INFORMATION
                $_FirstName = (isset($a[0]->First_Name))?$a[0]->First_Name:'';
                $_LastName = (isset($a[0]->Last_Name))?$a[0]->Last_Name:'';

                // $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                if(isset($a[0]->Addr_Primary)){
                    $_Address1 = (isset($a[0]->Addr_Primary))?$a[0]->Addr_Primary:'';
                }else{
                    $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                }
                if(isset($a[0]->Addr_Secondary)){
                    $_Address2 = (isset($a[0]->Addr_Secondary))?$a[0]->Addr_Secondary:'';
                }
                $_City =  (isset($a[0]->City))?$a[0]->City:'';
                $_State = (isset($a[0]->State))?$a[0]->State:'';
                $_Zipcode = (isset($a[0]->Zip))?$a[0]->Zip:'';

                //process email
                $email1 = isset($a[0]->Email_1) ? $a[0]->Email_1 : '';
                $email2 = isset($a[0]->Email_2) ? $a[0]->Email_2 : '';
                $email3 = isset($a[0]->Email_3) ? $a[0]->Email_3 : '';
                $email_array = array_filter([$email1, $email2, $email3]); 
                $bigEmail = $email_array;
                //process email                

            //BASIC INFORMATION

            //ADVANCE INFORMATION

                //identification
                    $_gender_aux = (isset($a[0]->Gender_aux))?$a[0]->Gender_aux:'';
                    $_age_aux = (isset($a[0]->Age_aux)) ? $a[0]->Age_aux : '';
                    $_birth_year_aux = (isset($a[0]->Birth_Year_aux)) ? $a[0]->Birth_Year_aux : '';
                    $_generation = (isset($a[0]->Generation)) ? $a[0]->Generation : '';
                    $_marital_status = (isset($a[0]->Marital_Status))?$a[0]->Marital_Status:'';
                //identification
                
                //financial information
                    $_household_income = (isset($a[0]->Income_HH))?$a[0]->Income_HH:'';
                    $_median_household_income = (isset($a[0]->Income_Midpts_HH))?$a[0]->Income_Midpts_HH:'';
                    $_household_net_worth = (isset($a[0]->Net_Worth_HH))?$a[0]->Net_Worth_HH:'';
                    $_median_household_net_worth = (isset($a[0]->Net_Worth_Midpt_HH))?$a[0]->Net_Worth_Midpt_HH:'';
                    $_discretionary_income = (isset($a[0]->Discretionary_Income)) ? $a[0]->Discretionary_Income : '';
                    $_credit_score_median = (isset($a[0]->Credit_Midpts)) ? $a[0]->Credit_Midpts : '';
                    $_credit_score_range = (isset($a[0]->Credit_Range)) ? $a[0]->Credit_Range : '';
                //financial information

                //occupation
                    $_occupation_category = (isset($a[0]->Occupation_Category)) ? $a[0]->Occupation_Category : '';
                    $_occupation_type =(isset($a[0]->Occupation_Type)) ? $a[0]->Occupation_Type : '';
                    $_occupation_detail = (isset($a[0]->Occupation_Detail)) ? $a[0]->Occupation_Detail : '';
                //occupation
                
                //miscellaneous
                    $_voter = (isset($a[0]->Voter)) ? $a[0]->Voter : '';
                    $_urbanicity = (isset($a[0]->Urbanicity)) ? $a[0]->Urbanicity : '';
                //miscellaneous

                //contact information

                    $_mobile_phone = (isset($a[0]->Mobile_Phone_1))?$a[0]->Mobile_Phone_1:'';
                    $_mobile_phone2 = (isset($a[0]->Mobile_Phone_2))?$a[0]->Mobile_Phone_2:'';
                    $_mobile_phone3 = (isset($a[0]->Mobile_Phone_3))?$a[0]->Mobile_Phone_3:'';
                    $_mobile_phone_dnc = (isset($a[0]->Mobile_Phone_1_DNC))?$a[0]->Mobile_Phone_1_DNC:'';
                    $_mobile_phone_dnc2 = (isset($a[0]->Mobile_Phone_2_DNC))?$a[0]->Mobile_Phone_2_DNC:'';
                    $_mobile_phone_dnc3 = (isset($a[0]->Mobile_Phone_3_DNC))?$a[0]->Mobile_Phone_3_DNC:'';

                    $_tax_bill_mailing_address = (isset($a[0]->TaxBillMailingAddress))?$a[0]->TaxBillMailingAddress:'';
                    $_tax_bill_mailing_city = (isset($a[0]->TaxBillMailingCity))?$a[0]->TaxBillMailingCity:'';
                    $_tax_bill_mailing_county = (isset($a[0]->TaxBillMailingCounty))?$a[0]->TaxBillMailingCounty:'';
                    $_tax_bill_mailing_fips = (isset($a[0]->TaxBillMailingFIPs))?$a[0]->TaxBillMailingFIPs:'';
                    $_tax_bill_mailing_state = (isset($a[0]->TaxBillMailingState))?$a[0]->TaxBillMailingState:'';
                    $_tax_bill_mailing_zip = (isset($a[0]->TaxBillMailingZip))?$a[0]->TaxBillMailingZip:'';
                    $_tax_bill_mailing_zip4 = (isset($a[0]->TaxBillMailingZip4))?$a[0]->TaxBillMailingZip4:'';
                //contact information

                //household information
                    $_num_adults_household= (isset($a[0]->Num_Adults_HH))?$a[0]->Num_Adults_HH:'';
                    $_num_children_household = (isset($a[0]->Num_Children_HH))?$a[0]->Num_Children_HH:'';
                    $_num_persons_household = (isset($a[0]->Num_Persons_HH))?$a[0]->Num_Persons_HH:'';
                    $_child_aged_0_3_household = (isset($a[0]->Child_Aged_0_3_HH))?$a[0]->Child_Aged_0_3_HH:'';
                    $_child_aged_4_6_household = (isset($a[0]->Child_Aged_4_6_HH))?$a[0]->Child_Aged_4_6_HH:'';
                    $_child_aged_7_9_household = (isset($a[0]->Child_Aged_7_9_HH))?$a[0]->Child_Aged_7_9_HH:'';
                    $_child_aged_10_12_household = (isset($a[0]->Child_Aged_10_12_HH))?$a[0]->Child_Aged_10_12_HH:'';
                    $_child_aged_13_18_household = (isset($a[0]->Child_Aged_13_18_HH))?$a[0]->Child_Aged_13_18_HH:'';
                    $_children_household = (isset($a[0]->Children_HH))?$a[0]->Children_HH:'';
                //household information

                //marketing indicators
                    $_has_email = (isset($a[0]->HasEmail))?$a[0]->HasEmail:'';
                    $_has_phone = (isset($a[0]->HasPhone))?$a[0]->HasPhone:'';
                    $_magazine_subscriber = (isset($a[0]->Magazine_Subscriber))?$a[0]->Magazine_Subscriber:'';
                    $_charity_interest = (isset($a[0]->Charity_Interest))?$a[0]->Charity_Interest:'';
                    $_likely_charitable_donor = (isset($a[0]->Likely_Charitable_Donor))?$a[0]->Likely_Charitable_Donor:'';     
                //marketing indicators

                //house and real estate
                    $_dwelling_type = (isset($a[0]->Dwelling_Type))?$a[0]->Dwelling_Type:'';     
                    $_home_owner = (isset($a[0]->Home_Owner))?$a[0]->Home_Owner:'';     
                    $_home_owner_ordinal = (isset($a[0]->Home_Owner_Ordinal))?$a[0]->Home_Owner_Ordinal:'';     
                    $_length_of_residence = (isset($a[0]->Length_of_Residence))?$a[0]->Length_of_Residence:'';     
                    $_home_price = (isset($a[0]->Home_Price))?$a[0]->Home_Price:'';     
                    $_home_value = (isset($a[0]->Home_Value))?$a[0]->Home_Value:'';     
                    $_median_home_value = (isset($a[0]->Median_Home_Value))?$a[0]->Median_Home_Value:'';  
                    $_living_sqft = (isset($a[0]->LIVING_SQFT))?$a[0]->LIVING_SQFT:'';  
                    $_year_built_original = (isset($a[0]->YR_BUILT_ORIG))?$a[0]->YR_BUILT_ORIG:'';  
                    $_year_built_range = (isset($a[0]->YR_BUILT_RANGE))?$a[0]->YR_BUILT_RANGE:'';  
                    $_lot_number = (isset($a[0]->LotNumber))?$a[0]->LotNumber:'';  
                    $_legal_description = (isset($a[0]->LegalDescription))?$a[0]->LegalDescription:'';  
                    $_land_sqft = (isset($a[0]->LAND_SQFT))?$a[0]->LAND_SQFT:'';  
                    $_garage_sqft = (isset($a[0]->GAR_SQFT))?$a[0]->GAR_SQFT:'';  
                    $_subdivision = (isset($a[0]->SUBDIVISION))?$a[0]->SUBDIVISION:'';  
                    $_zoning_code = (isset($a[0]->ZONING_CODE))?$a[0]->ZONING_CODE:'';  
                //house and real estate

                //interest and affinities
                    $_cooking = (isset($a[0]->Cooking))?$a[0]->Cooking:'';  
                    $_gardening = (isset($a[0]->Gardening))?$a[0]->Gardening:''; 
                    $_music = (isset($a[0]->Music))?$a[0]->Music:''; 
                    $_diy =  (isset($a[0]->DIY))?$a[0]->DIY:''; 
                    $_books = (isset($a[0]->Books))?$a[0]->Books:''; 
                    $_travel_vacation = (isset($a[0]->Travel_Vacation))?$a[0]->Travel_Vacation:''; 
                    $_health_beauty_products = (isset($a[0]->Health_Beauty_Products))?$a[0]->Health_Beauty_Products:''; 
                    $_pet_owner = (isset($a[0]->Pet_Owner))?$a[0]->Pet_Owner:''; 
                    $_photography = (isset($a[0]->Photography))?$a[0]->Photography:''; 
                    $_fitness = (isset($a[0]->Fitness))?$a[0]->Fitness:''; 
                    $_epicurean = (isset($a[0]->Epicurean))?$a[0]->Epicurean:''; 
                //interest and affinities

                //location and census data
                    $_cbsa = (isset($a[0]->Cbsa))?$a[0]->Cbsa:''; 
                    $_census_block = (isset($a[0]->Census_Block))?$a[0]->Census_Block:''; 
                    $_census_block_group = (isset($a[0]->Census_Block_Group))?$a[0]->Census_Block_Group:''; 
                    $_census_tract = (isset($a[0]->Census_Tract))?$a[0]->Census_Tract:''; 
                //location and census data

            //ADVANCE INFORMATION

            //unregistered row
                $_aerobics = (isset($a[0]->Aerobics)) ? $a[0]->Aerobics : '';
                $_african_american_affinity = (isset($a[0]->African_American_Affinity)) ? $a[0]->African_American_Affinity : '';
                $_amex_card = (isset($a[0]->AMEX_Card)) ? $a[0]->AMEX_Card : '';
                $_antiques = (isset($a[0]->Antiques)) ? $a[0]->Antiques : '';
                $_apparel_accessory_affinity = (isset($a[0]->Apparel_Accessory_Affinity)) ? $a[0]->Apparel_Accessory_Affinity : '';
                $_apparel_affinity = (isset($a[0]->Apparel_Affinity)) ? $a[0]->Apparel_Affinity : '';
                $_arts_and_crafts = (isset($a[0]->Arts_and_Crafts)) ? $a[0]->Arts_and_Crafts : '';
                $_asian_affinity = (isset($a[0]->Asian_Affinity)) ? $a[0]->Asian_Affinity : '';
                $_auto_affinity = (isset($a[0]->Auto_Affinity)) ? $a[0]->Auto_Affinity : '';
                $_auto_racing_affinity = (isset($a[0]->Auto_Racing_Affinity)) ? $a[0]->Auto_Racing_Affinity : '';
                $_aviation_affinity = (isset($a[0]->Aviation_Affinity)) ? $a[0]->Aviation_Affinity : '';
                $_bank_card = (isset($a[0]->Bank_Card)) ? $a[0]->Bank_Card : '';
                $_bargain_hunter_affinity = (isset($a[0]->Bargain_Hunter_Affinity)) ? $a[0]->Bargain_Hunter_Affinity : '';
                $_baseball = (isset($a[0]->Baseball)) ? $a[0]->Baseball : '';
                $_baseball_affinity = (isset($a[0]->Baseball_Affinity)) ? $a[0]->Baseball_Affinity : '';
                $_basketball = (isset($a[0]->Basketball)) ? $a[0]->Basketball : '';
                $_basketball_affinity = (isset($a[0]->Basketball_Affinity)) ? $a[0]->Basketball_Affinity : '';
                $_beauty_affinity = (isset($a[0]->Beauty_Affinity)) ? $a[0]->Beauty_Affinity : '';
                $_bible_affinity = (isset($a[0]->Bible_Affinity)) ? $a[0]->Bible_Affinity : '';
                $_bird_watching = (isset($a[0]->Bird_watching)) ? $a[0]->Bird_watching : '';
                $_birds_affinity = (isset($a[0]->Birds_Affinity)) ? $a[0]->Birds_Affinity : '';
                $_blue_collar = (isset($a[0]->Blue_Collar)) ? $a[0]->Blue_Collar : '';
                $_boating_sailing = (isset($a[0]->Boating_Sailing)) ? $a[0]->Boating_Sailing : '';
                $_boating_sailing_affinity = (isset($a[0]->Boating_Sailing_Affinity)) ? $a[0]->Boating_Sailing_Affinity : '';
                $_business_affinity = (isset($a[0]->Business_Affinity)) ? $a[0]->Business_Affinity : '';
                $_camping_hiking = (isset($a[0]->Camping_Hiking)) ? $a[0]->Camping_Hiking : '';
                $_camping_hiking_climbing_affinity = (isset($a[0]->Camping_Hiking_Climbing_Affinity)) ? $a[0]->Camping_Hiking_Climbing_Affinity : '';
                $_cars_interest = (isset($a[0]->Cars_Interest)) ? $a[0]->Cars_Interest : '';
                $_cat_owner = (isset($a[0]->Cat_Owner)) ? $a[0]->Cat_Owner : '';
                $_catalog_affinity = (isset($a[0]->Catalog_Affinity)) ? $a[0]->Catalog_Affinity : '';
                $_cigars = (isset($a[0]->Cigars)) ? $a[0]->Cigars : '';
                $_classical_music = (isset($a[0]->Classical_Music)) ? $a[0]->Classical_Music : '';
                $_coins = (isset($a[0]->Coins)) ? $a[0]->Coins : '';
                $_collectibles_affinity = (isset($a[0]->Collectibles_Affinity)) ? $a[0]->Collectibles_Affinity : '';
                $_college_affinity = (isset($a[0]->College_Affinity)) ? $a[0]->College_Affinity : '';
                $_computers_affinity = (isset($a[0]->Computers_Affinity)) ? $a[0]->Computers_Affinity : '';
                $_continuity_program_affinity = (isset($a[0]->Continuity_Program_Affinity)) ? $a[0]->Continuity_Program_Affinity : '';
                $_cooking_affinity = (isset($a[0]->Cooking_Affinity)) ? $a[0]->Cooking_Affinity : '';
                $_cosmetics = (isset($a[0]->Cosmetics)) ? $a[0]->Cosmetics : '';
                $_country_music = (isset($a[0]->Country_Music)) ? $a[0]->Country_Music : '';
                $_crafts_affinity = (isset($a[0]->Crafts_Affinity)) ? $a[0]->Crafts_Affinity : '';
                $_credit_card = (isset($a[0]->Credit_Card)) ? $a[0]->Credit_Card : '';
                $_credit_repair_affinity = (isset($a[0]->Credit_Repair_Affinity)) ? $a[0]->Credit_Repair_Affinity : '';
                $_crochet_affinity = (isset($a[0]->Crochet_Affinity)) ? $a[0]->Crochet_Affinity : '';
                $_diet_affinity = (isset($a[0]->Diet_Affinity)) ? $a[0]->Diet_Affinity : '';
                $_dieting = (isset($a[0]->Dieting)) ? $a[0]->Dieting : '';
                $_do_it_yourself_affinity = (isset($a[0]->Do_it_Yourself_Affinity)) ? $a[0]->Do_it_Yourself_Affinity : '';
                $_dog_owner = (isset($a[0]->Dog_Owner)) ? $a[0]->Dog_Owner : '';
                $_doll_collector = (isset($a[0]->Doll_Collector)) ? $a[0]->Doll_Collector : '';
                $_donor_affinity = (isset($a[0]->Donor_Affinity)) ? $a[0]->Donor_Affinity : '';
                $_education = (isset($a[0]->Education)) ? $a[0]->Education : '';
                $_education_ordinal = (isset($a[0]->Education_Ordinal)) ? $a[0]->Education_Ordinal : '';
                $_education_seekers_affinity = (isset($a[0]->Education_Seekers_Affinity)) ? $a[0]->Education_Seekers_Affinity : '';
                $_ego_affinity = (isset($a[0]->EGO_Affinity)) ? $a[0]->EGO_Affinity : '';
                $_entertainment_interest = (isset($a[0]->Entertainment_Interest)) ? $a[0]->Entertainment_Interest : '';
                $_figurines_collector = (isset($a[0]->Figurines_Collector)) ? $a[0]->Figurines_Collector : '';
                $_fine_arts_collector = (isset($a[0]->Fine_Arts_Collector)) ? $a[0]->Fine_Arts_Collector : '';
                $_fishing = (isset($a[0]->Fishing)) ? $a[0]->Fishing : '';
                $_fishing_affinity = (isset($a[0]->Fishing_Affinity)) ? $a[0]->Fishing_Affinity : '';
                $_football = (isset($a[0]->Football)) ? $a[0]->Football : '';
                $_football_affinity = (isset($a[0]->Football_Affinity)) ? $a[0]->Football_Affinity : '';
                $_gambling = (isset($a[0]->Gambling)) ? $a[0]->Gambling : '';
                $_gambling_affinity = (isset($a[0]->Gambling_Affinity)) ? $a[0]->Gambling_Affinity : '';
                $_games_affinity = (isset($a[0]->Games_Affinity)) ? $a[0]->Games_Affinity : '';
                $_gardening_affinity = (isset($a[0]->Gardening_Affinity)) ? $a[0]->Gardening_Affinity : '';
                $_generation_ordinal = (isset($a[0]->Generation_Ordinal)) ? $a[0]->Generation_Ordinal : '';
                $_golf = (isset($a[0]->Golf)) ? $a[0]->Golf : '';
                $_golf_affinity = (isset($a[0]->Golf_Affinity)) ? $a[0]->Golf_Affinity : '';
                $_gourmet_affinity = (isset($a[0]->Gourmet_Affinity)) ? $a[0]->Gourmet_Affinity : '';
                $_grandparents_affinity = (isset($a[0]->Grandparents_Affinity)) ? $a[0]->Grandparents_Affinity : '';
                $_health_affinity = (isset($a[0]->Health_Affinity)) ? $a[0]->Health_Affinity : '';
                $_healthy_living = (isset($a[0]->Healthy_Living)) ? $a[0]->Healthy_Living : '';
                $_healthy_living_interest = (isset($a[0]->Healthy_Living_Interest)) ? $a[0]->Healthy_Living_Interest : '';
                $_high_tech_affinity = (isset($a[0]->High_Tech_Affinity)) ? $a[0]->High_Tech_Affinity : '';
                $_hispanic_affinity = (isset($a[0]->Hispanic_Affinity)) ? $a[0]->Hispanic_Affinity : '';
                $_hockey = (isset($a[0]->Hockey)) ? $a[0]->Hockey : '';
                $_hockey_affinity = (isset($a[0]->Hockey_Affinity)) ? $a[0]->Hockey_Affinity : '';
                $_home_decor = (isset($a[0]->Home_Decor)) ? $a[0]->Home_Decor : '';
                $_home_improvement_interest = (isset($a[0]->Home_Improvement_Interest)) ? $a[0]->Home_Improvement_Interest : '';
                $_home_office_affinity = (isset($a[0]->Home_Office_Affinity)) ? $a[0]->Home_Office_Affinity : '';
                $_home_study = (isset($a[0]->Home_Study)) ? $a[0]->Home_Study : '';
                $_hunting = (isset($a[0]->Hunting)) ? $a[0]->Hunting : '';
                $_hunting_affinity = (isset($a[0]->Hunting_Affinity)) ? $a[0]->Hunting_Affinity : '';
                $_jazz = (isset($a[0]->Jazz)) ? $a[0]->Jazz : '';
                $_kids_apparel_affinity = (isset($a[0]->Kids_Apparel_Affinity)) ? $a[0]->Kids_Apparel_Affinity : '';
                $_knit_affinity = (isset($a[0]->Knit_Affinity)) ? $a[0]->Knit_Affinity : '';
                $_knitting_quilting_sewing = (isset($a[0]->Knitting_Quilting_Sewing)) ? $a[0]->Knitting_Quilting_Sewing : '';
                $_luxury_life = (isset($a[0]->Luxury_Life)) ? $a[0]->Luxury_Life : '';
                $_married = (isset($a[0]->Married)) ? $a[0]->Married : '';
                $_median_income = (isset($a[0]->Median_Income)) ? $a[0]->Median_Income : '';
                $_mens_apparel_affinity = (isset($a[0]->Mens_Apparel_Affinity)) ? $a[0]->Mens_Apparel_Affinity : '';
                $_mens_fashion_affinity = (isset($a[0]->Mens_Fashion_Affinity)) ? $a[0]->Mens_Fashion_Affinity : '';
                $_mortgage_age = (isset($a[0]->Mortgage_Age)) ? $a[0]->Mortgage_Age : '';
                $_mortgage_amount = (isset($a[0]->Mortgage_Amount)) ? $a[0]->Mortgage_Amount : '';
                $_mortgage_loan_type = (isset($a[0]->Mortgage_Loan_Type)) ? $a[0]->Mortgage_Loan_Type : '';
                $_mortgage_refi_age = (isset($a[0]->Mortgage_Refi_Age)) ? $a[0]->Mortgage_Refi_Age : '';
                $_mortgage_refi_amount = (isset($a[0]->Mortgage_Refi_Amount)) ? $a[0]->Mortgage_Refi_Amount : '';
                $_mortgage_refi_type = (isset($a[0]->Mortgage_Refi_Type)) ? $a[0]->Mortgage_Refi_Type : '';
                $_motor_racing = (isset($a[0]->Motor_Racing)) ? $a[0]->Motor_Racing : '';
                $_motorcycles = (isset($a[0]->Motorcycles)) ? $a[0]->Motorcycles : '';
                $_motorcycles_affinity = (isset($a[0]->Motorcycles_Affinity)) ? $a[0]->Motorcycles_Affinity : '';
                $_movies = (isset($a[0]->Movies)) ? $a[0]->Movies : '';
                $_nascar = (isset($a[0]->NASCAR)) ? $a[0]->NASCAR : '';
                $_needlepoint_affinity = (isset($a[0]->Needlepoint_Affinity)) ? $a[0]->Needlepoint_Affinity : '';
                $_new_credit_offered_household = (isset($a[0]->New_Credit_Offered_HH)) ? $a[0]->New_Credit_Offered_HH : '';
                $_num_credit_lines_household = (isset($a[0]->Num_Credit_Lines_HH)) ? $a[0]->Num_Credit_Lines_HH : '';
                $_num_generations_household = (isset($a[0]->Num_Generations_HH)) ? $a[0]->Num_Generations_HH : '';
                $_outdoors = (isset($a[0]->Outdoors)) ? $a[0]->Outdoors : '';
                $_outdoors_affinity = (isset($a[0]->Outdoors_Affinity)) ? $a[0]->Outdoors_Affinity : '';
                $_owns_investments = (isset($a[0]->Owns_Investments)) ? $a[0]->Owns_Investments : '';
                $_owns_mutual_funds = (isset($a[0]->Owns_Mutual_Funds)) ? $a[0]->Owns_Mutual_Funds : '';
                $_owns_stocks_and_bonds = (isset($a[0]->Owns_Stocks_And_Bonds)) ? $a[0]->Owns_Stocks_And_Bonds : '';
                $_owns_swimming_pool = (isset($a[0]->Owns_Swimming_Pool)) ? $a[0]->Owns_Swimming_Pool : '';
                $_personal_finance_affinity = (isset($a[0]->Personal_Finance_Affinity)) ? $a[0]->Personal_Finance_Affinity : '';
                $_personality = (isset($a[0]->Personality)) ? $a[0]->Personality : '';
                $_plates_collector = (isset($a[0]->Plates_Collector)) ? $a[0]->Plates_Collector : '';
                $_pop_density = (isset($a[0]->Pop_Density)) ? $a[0]->Pop_Density : '';
                $_premium_amex_card = (isset($a[0]->Premium_AMEX_Card)) ? $a[0]->Premium_AMEX_Card : '';
                $_premium_card = (isset($a[0]->Premium_Card)) ? $a[0]->Premium_Card : '';
                $_premium_income_household = (isset($a[0]->Premium_Income_HH)) ? $a[0]->Premium_Income_HH : '';
                $_premium_income_midpt_household = (isset($a[0]->Premium_Income_Midpt_HH)) ? $a[0]->Premium_Income_Midpt_HH : '';
                $_quilt_affinity = (isset($a[0]->Quilt_Affinity)) ? $a[0]->Quilt_Affinity : '';
                $_religious_music = (isset($a[0]->Religious_Music)) ? $a[0]->Religious_Music : '';
                $_rhythm_and_blues = (isset($a[0]->Rhythm_and_Blues)) ? $a[0]->Rhythm_and_Blues : '';
                $_rock_music = (isset($a[0]->Rock_Music)) ? $a[0]->Rock_Music : '';
                $_running = (isset($a[0]->Running)) ? $a[0]->Running : '';
                $_rv = (isset($a[0]->RV)) ? $a[0]->RV : '';
                $_scuba = (isset($a[0]->Scuba)) ? $a[0]->Scuba : '';
                $_self_improvement = (isset($a[0]->Self_Improvement)) ? $a[0]->Self_Improvement : '';
                $_sewing_affinity = (isset($a[0]->Sewing_Affinity)) ? $a[0]->Sewing_Affinity : '';
                $_single_family_dwelling = (isset($a[0]->Single_Family_Dwelling)) ? $a[0]->Single_Family_Dwelling : '';
                $_snow_skiing = (isset($a[0]->Snow_Skiing)) ? $a[0]->Snow_Skiing : '';
                $_snow_skiing_affinity = (isset($a[0]->Snow_Skiing_Affinity)) ? $a[0]->Snow_Skiing_Affinity : '';
                $_soccer = (isset($a[0]->Soccer)) ? $a[0]->Soccer : '';
                $_soccer_affinity = (isset($a[0]->Soccer_Affinity)) ? $a[0]->Soccer_Affinity : '';
                $_soft_rock = (isset($a[0]->Soft_Rock)) ? $a[0]->Soft_Rock : '';
                $_soho_business = (isset($a[0]->SOHO_Business)) ? $a[0]->SOHO_Business : '';
                $_sports_memoribilia_collector = (isset($a[0]->Sports_Memoribilia_Collector)) ? $a[0]->Sports_Memoribilia_Collector : '';
                $_stamps = (isset($a[0]->Stamps)) ? $a[0]->Stamps : '';
                $_sweepstakes_affinity = (isset($a[0]->Sweepstakes_Affinity)) ? $a[0]->Sweepstakes_Affinity : '';
                $_tennis = (isset($a[0]->Tennis)) ? $a[0]->Tennis : '';
                $_tennis_affinity = (isset($a[0]->Tennis_Affinity)) ? $a[0]->Tennis_Affinity : '';
                $_tobacco_affinity = (isset($a[0]->Tobacco_Affinity)) ? $a[0]->Tobacco_Affinity : '';
                $_travel_affinity = (isset($a[0]->Travel_Affinity)) ? $a[0]->Travel_Affinity : '';
                $_travel_cruise_affinity = (isset($a[0]->Travel_Cruise_Affinity)) ? $a[0]->Travel_Cruise_Affinity : '';
                $_travel_cruises = (isset($a[0]->Travel_Cruises)) ? $a[0]->Travel_Cruises : '';
                $_travel_personal = (isset($a[0]->Travel_Personal)) ? $a[0]->Travel_Personal : '';
                $_travel_rv_affinity = (isset($a[0]->Travel_RV_Affinity)) ? $a[0]->Travel_RV_Affinity : '';
                $_travel_us_affinity = (isset($a[0]->Travel_US_Affinity)) ? $a[0]->Travel_US_Affinity : '';
                $_truck_owner = (isset($a[0]->Truck_Owner)) ? $a[0]->Truck_Owner : '';
                $_trucks_affinity = (isset($a[0]->Trucks_Affinity)) ? $a[0]->Trucks_Affinity : '';
                $_tv_movies_affinity = (isset($a[0]->TV_Movies_Affinity)) ? $a[0]->TV_Movies_Affinity : '';
                $_veteran_household = (isset($a[0]->Veteran_HH)) ? $a[0]->Veteran_HH : '';
                $_walking = (isset($a[0]->Walking)) ? $a[0]->Walking : '';
                $_weight_lifting = (isset($a[0]->Weight_Lifting)) ? $a[0]->Weight_Lifting : '';
                $_wildlife_affinity = (isset($a[0]->Wildlife_Affinity)) ? $a[0]->Wildlife_Affinity : '';
                $_womens_apparel_affinity = (isset($a[0]->Womens_Apparel_Affinity)) ? $a[0]->Womens_Apparel_Affinity : '';
                $_womens_fashion_affinity = (isset($a[0]->Womens_Fashion_Affinity)) ? $a[0]->Womens_Fashion_Affinity : '';
                $_woodworking = (isset($a[0]->Woodworking)) ? $a[0]->Woodworking : '';
                $_gender = (isset($a[0]->Gender)) ? $a[0]->Gender : '';
                $_male_aux = (isset($a[0]->Male_aux)) ? $a[0]->Male_aux : '';
                $_political_contributor_aux = (isset($a[0]->Political_Contributor_aux)) ? $a[0]->Political_Contributor_aux : '';
                $_political_party_aux = (isset($a[0]->Political_Party_aux)) ? $a[0]->Political_Party_aux : '';
                $_financial_power = (isset($a[0]->Financial_Power)) ? $a[0]->Financial_Power : '';
                $_mortgage_open_1st_intent = (isset($a[0]->Mortgage_Open1st_Intent)) ? $a[0]->Mortgage_Open1st_Intent : '';
                $_mortgage_open_2nd_intent = (isset($a[0]->Mortgage_Open2nd_Intent)) ? $a[0]->Mortgage_Open2nd_Intent : '';
                $_mortgage_new_intent = (isset($a[0]->Mortgage_New_Intent)) ? $a[0]->Mortgage_New_Intent : '';
                $_mortgage_refinance_intent = (isset($a[0]->Mortgage_Refinance_Intent)) ? $a[0]->Mortgage_Refinance_Intent : '';
                $_automotive_loan_intent = (isset($a[0]->Automotive_Loan_Intent)) ? $a[0]->Automotive_Loan_Intent : '';
                $_bank_card_intent = (isset($a[0]->Bank_Card_Intent)) ? $a[0]->Bank_Card_Intent : '';
                $_personal_loan_intent = (isset($a[0]->Personal_Loan_Intent)) ? $a[0]->Personal_Loan_Intent : '';
                $_retail_card_intent = (isset($a[0]->Retail_Card_Intent)) ? $a[0]->Retail_Card_Intent : '';
                $_student_loan_cons_intent = (isset($a[0]->Student_Loan_Cons_Intent)) ? $a[0]->Student_Loan_Cons_Intent : '';
                $_student_loan_intent = (isset($a[0]->Student_Loan_Intent)) ? $a[0]->Student_Loan_Intent : '';
                $_3qtr_baths = (isset($a[0]) && property_exists($a[0], '3QTR_BATHS')) ? $a[0]->{'3QTR_BATHS'} : '';
                $_ac_type = (isset($a[0]->AC_TYPE)) ? $a[0]->AC_TYPE : '';
                $_acres = (isset($a[0]->ACRES)) ? $a[0]->ACRES : '';
                $_additions_square_feet = (isset($a[0]->AdditionsSquareFeet)) ? $a[0]->AdditionsSquareFeet : '';
                $_assess_val_impr = (isset($a[0]->ASSESS_VAL_IMPR)) ? $a[0]->ASSESS_VAL_IMPR : '';
                $_assess_val_lnd = (isset($a[0]->ASSESS_VAL_LND)) ? $a[0]->ASSESS_VAL_LND : '';
                $_assess_val_prop = (isset($a[0]->ASSESS_VAL_PROP)) ? $a[0]->ASSESS_VAL_PROP : '';
                $_bldg_style = (isset($a[0]->BLDG_STYLE)) ? $a[0]->BLDG_STYLE : '';
                $_bsmt_sqft = (isset($a[0]->BSMT_SQFT)) ? $a[0]->BSMT_SQFT : '';
                $_bsmt_type = (isset($a[0]->BSMT_TYPE)) ? $a[0]->BSMT_TYPE : '';
                $_build_sqft_assess = (isset($a[0]->BUILD_SQFT_ASSESS)) ? $a[0]->BUILD_SQFT_ASSESS : '';
                $_business = (isset($a[0]->BUSINESS)) ? $a[0]->BUSINESS : '';
                $_combined_statistical_area = (isset($a[0]->CombinedStatisticalArea)) ? $a[0]->CombinedStatisticalArea : '';
                $_metropolitan_division = (isset($a[0]->MetropolitanDivision)) ? $a[0]->MetropolitanDivision : '';
                $_middle = (isset($a[0]->MIDDLE)) ? $a[0]->MIDDLE : '';
                $_middle_2 = (isset($a[0]->MIDDLE2)) ? $a[0]->MIDDLE2 : '';
                $_mkt_ip_perc = (isset($a[0]->Mkt_Ip_Perc)) ? $a[0]->Mkt_Ip_Perc : '';
                $_mobile_home = (isset($a[0]->MOBILE_HOME)) ? $a[0]->MOBILE_HOME : '';
                $_mrtg_due = (isset($a[0]->MRTG_DUE)) ? $a[0]->MRTG_DUE : '';
                $_mrtg_intrate = (isset($a[0]->MRTG_INTRATE)) ? $a[0]->MRTG_INTRATE : '';
                $_mrtg_refi = (isset($a[0]->MRTG_REFI)) ? $a[0]->MRTG_REFI : '';
                $_mrtg_term = (isset($a[0]->MRTG_TERM)) ? $a[0]->MRTG_TERM : '';
                $_mrtg_type = (isset($a[0]->MRTG_TYPE)) ? $a[0]->MRTG_TYPE : '';
                $_mrtg2_amt = (isset($a[0]->MRTG2_AMT)) ? $a[0]->MRTG2_AMT : '';
                $_mrtg2_date = (isset($a[0]->MRTG2_DATE)) ? $a[0]->MRTG2_DATE : '';
                $_mrtg2_deed_type = (isset($a[0]->MRTG2_DEED_TYPE)) ? $a[0]->MRTG2_DEED_TYPE : '';
                $_mrtg2_due = (isset($a[0]->MRTG2_DUE)) ? $a[0]->MRTG2_DUE : '';
                $_mrtg2_equity = (isset($a[0]->MRTG2_EQUITY)) ? $a[0]->MRTG2_EQUITY : '';
                $_mrtg2_intrate = (isset($a[0]->MRTG2_INTRATE)) ? $a[0]->MRTG2_INTRATE : '';
                $_mrtg2_inttype = (isset($a[0]->MRTG2_INTTYPE)) ? $a[0]->MRTG2_INTTYPE : '';
                $_mrtg2_refi = (isset($a[0]->MRTG2_REFI)) ? $a[0]->MRTG2_REFI : '';
                $_mrtg2_term = (isset($a[0]->MRTG2_TERM)) ? $a[0]->MRTG2_TERM : '';
                $_mrtg2_type = (isset($a[0]->MRTG2_TYPE)) ? $a[0]->MRTG2_TYPE : '';
                $_mrtg3_amt = (isset($a[0]->MRTG3_AMT)) ? $a[0]->MRTG3_AMT : '';
                $_mrtg3_date = (isset($a[0]->MRTG3_DATE)) ? $a[0]->MRTG3_DATE : '';
                $_mrtg3_deed_type = (isset($a[0]->MRTG3_DEED_TYPE)) ? $a[0]->MRTG3_DEED_TYPE : '';
                $_mrtg3_due = (isset($a[0]->MRTG3_DUE)) ? $a[0]->MRTG3_DUE : '';
                $_mrtg3_equity = (isset($a[0]->MRTG3_EQUITY)) ? $a[0]->MRTG3_EQUITY : '';
                $_mrtg3_inttype = (isset($a[0]->MRTG3_INTTYPE)) ? $a[0]->MRTG3_INTTYPE : '';
                $_mrtg3_refi = (isset($a[0]->MRTG3_REFI)) ? $a[0]->MRTG3_REFI : '';
                $_mrtg3_term = (isset($a[0]->MRTG3_TERM)) ? $a[0]->MRTG3_TERM : '';
                $_mrtg3_type = (isset($a[0]->MRTG3_TYPE)) ? $a[0]->MRTG3_TYPE : '';
                $_msa_code = (isset($a[0]->MSACode)) ? $a[0]->MSACode : '';
                $_number_bedrooms = (isset($a[0]->NMBR_BEDROOMS)) ? $a[0]->NMBR_BEDROOMS : '';
                $_number_bldgs = (isset($a[0]->NMBR_BLDGS)) ? $a[0]->NMBR_BLDGS : '';
                $_number_fireplace = (isset($a[0]->NMBR_FIREPLACE)) ? $a[0]->NMBR_FIREPLACE : '';
                $_number_park_spaces = (isset($a[0]->NMBR_PARK_SPACES)) ? $a[0]->NMBR_PARK_SPACES : '';
                $_number_rooms = (isset($a[0]->number_rooms)) ? $a[0]->number_rooms : '';
                $_own_biz = (isset($a[0]->OWN_BIZ)) ? $a[0]->OWN_BIZ : '';
                $_owner_occupied = (isset($a[0]->OWNER_OCCUPIED)) ? $a[0]->OWNER_OCCUPIED : '';
                $_ownership_relation = (isset($a[0]->OwnershipRelation)) ? $a[0]->OwnershipRelation : '';
                $_owner_type_description = (isset($a[0]->OwnerTypeDescription)) ? $a[0]->OwnerTypeDescription : '';
                $_estimated_value = (isset($a[0]->EstimatedValue)) ? $a[0]->EstimatedValue : '';
                $_ext_type = (isset($a[0]->EXT_TYPE)) ? $a[0]->EXT_TYPE : '';
                $_finish_square_feet2 = (isset($a[0]->FinishSquareFeet2)) ? $a[0]->FinishSquareFeet2 : '';
                $_fireplace = (isset($a[0]->fireplace)) ? $a[0]->fireplace : '';
                $_first = (isset($a[0]->FIRST)) ? $a[0]->FIRST : '';
                $_first_2 = (isset($a[0]->FIRST2)) ? $a[0]->FIRST2 : '';
                $_found_type = (isset($a[0]->FOUND_TYPE)) ? $a[0]->FOUND_TYPE : '';
                $_fr_feet = (isset($a[0]->FR_FEET)) ? $a[0]->FR_FEET : '';
                $_fuel_type = (isset($a[0]->FUEL_TYPE)) ? $a[0]->FUEL_TYPE : '';
                $_full_baths = (isset($a[0]->FULL_BATHS)) ? $a[0]->FULL_BATHS : '';
                $_half_baths = (isset($a[0]->HALF_BATHS)) ? $a[0]->HALF_BATHS : '';
                $_garage_type = (isset($a[0]->GAR_TYPE)) ? $a[0]->GAR_TYPE : '';
                $_grnd_sqft = (isset($a[0]->GRND_SQFT)) ? $a[0]->GRND_SQFT : '';
                $_heat_type = (isset($a[0]->HEAT_TYPE)) ? $a[0]->HEAT_TYPE : '';
                $_hmstd = (isset($a[0]->HMSTD)) ? $a[0]->HMSTD : '';
                $_impr_appr_val = (isset($a[0]->IMPR_APPR_VAL)) ? $a[0]->IMPR_APPR_VAL : '';
                $_imprval = (isset($a[0]->IMPRVAL)) ? $a[0]->IMPRVAL : '';
                $_imprval_type = (isset($a[0]->IMPRVAL_TYPE)) ? $a[0]->IMPRVAL_TYPE : '';
                $_land_appr_val = (isset($a[0]->LAND_APPR_VAL)) ? $a[0]->LAND_APPR_VAL : '';
                $_landval = (isset($a[0]->LANDVAL)) ? $a[0]->LANDVAL : '';
                $_landval_type = (isset($a[0]->LANDVAL_TYPE)) ? $a[0]->LANDVAL_TYPE : '';
                $_last = (isset($a[0]->LAST)) ? $a[0]->LAST : '';
                $_last_2 = (isset($a[0]->LAST2)) ? $a[0]->LAST2 : '';
                $_lat = (isset($a[0]->LAT)) ? $a[0]->LAT : '';
                $_lender_name = (isset($a[0]->LENDER_NAME)) ? $a[0]->LENDER_NAME : '';
                $_lender2_name = (isset($a[0]->LENDER2_NAME)) ? $a[0]->LENDER2_NAME : '';
                $_lender3_name = (isset($a[0]->LENDER3_NAME)) ? $a[0]->LENDER3_NAME : '';
                $_loan_amt = (isset($a[0]->LOAN_AMT)) ? $a[0]->LOAN_AMT : '';
                $_loan_date = (isset($a[0]->LOAN_DATE)) ? $a[0]->LOAN_DATE : '';
                $_loan_to_val = (isset($a[0]->LOAN_TO_VAL)) ? $a[0]->LOAN_TO_VAL : '';
                $_lon = (isset($a[0]->LON)) ? $a[0]->LON : '';
                $_markval = (isset($a[0]->MARKVAL)) ? $a[0]->MARKVAL : '';
                $_markval_type = (isset($a[0]->MARKVAL_TYPE)) ? $a[0]->MARKVAL_TYPE : '';
                $_patio_porch = (isset($a[0]->PatioPorch)) ? $a[0]->PatioPorch : '';
                $_patio_square_feet = (isset($a[0]->PatioSquareFeet)) ? $a[0]->PatioSquareFeet : '';
                $_pool = (isset($a[0]->POOL)) ? $a[0]->POOL : '';
                $_porch_square_feet = (isset($a[0]->PorchSquareFeet)) ? $a[0]->PorchSquareFeet : '';
                $_previous_assessed_value = (isset($a[0]->PreviousAssessedValue)) ? $a[0]->PreviousAssessedValue : '';
                $_prop_type = (isset($a[0]->PROP_TYPE)) ? $a[0]->PROP_TYPE : '';
                $_rate_type = (isset($a[0]->RATE_TYPE)) ? $a[0]->RATE_TYPE : '';
                $_rec_date = (isset($a[0]->REC_DATE)) ? $a[0]->REC_DATE : '';
                $_roof_covtype = (isset($a[0]->ROOF_COVTYPE)) ? $a[0]->ROOF_COVTYPE : '';
                $_roof_shapetype = (isset($a[0]->ROOF_SHAPETYPE)) ? $a[0]->ROOF_SHAPETYPE : '';
                $_sale_amt = (isset($a[0]->SALE_AMT)) ? $a[0]->SALE_AMT : '';
                $_sale_amt_pr = (isset($a[0]->SALE_AMT_PR)) ? $a[0]->SALE_AMT_PR : '';
                $_sale_date = (isset($a[0]->SALE_DATE)) ? $a[0]->SALE_DATE : '';
                $_sale_type_pr = (isset($a[0]->SALE_TYPE_PR)) ? $a[0]->SALE_TYPE_PR : '';
                $_sales_type = (isset($a[0]->SALES_TYPE)) ? $a[0]->SALES_TYPE : '';
                $_sell_name = (isset($a[0]->SELL_NAME)) ? $a[0]->SELL_NAME : '';
                $_sewer_type = (isset($a[0]->SEWER_TYPE)) ? $a[0]->SEWER_TYPE : '';
                $_site_quality = (isset($a[0]->SITE_QUALITY)) ? $a[0]->SITE_QUALITY : '';
                $_std_address = (isset($a[0]->STD_ADDRESS)) ? $a[0]->STD_ADDRESS : '';
                $_std_city = (isset($a[0]->STD_CITY)) ? $a[0]->STD_CITY : '';
                $_std_state = (isset($a[0]->STD_STATE)) ? $a[0]->STD_STATE : '';
                $_std_zip = (isset($a[0]->STD_ZIP)) ? $a[0]->STD_ZIP : '';
                $_std_zip4 = (isset($a[0]->STD_ZIP4)) ? $a[0]->STD_ZIP4 : '';
                $_stories_number = (isset($a[0]->STORIES_NMBR)) ? $a[0]->STORIES_NMBR : '';
                $_suffix = (isset($a[0]->SUFFIX)) ? $a[0]->SUFFIX : '';
                $_suffix_2 = (isset($a[0]->SUFFIX2)) ? $a[0]->SUFFIX2 : '';
                $_tax_yr = (isset($a[0]->TAX_YR)) ? $a[0]->TAX_YR : '';
                $_tax_improvement_percent = (isset($a[0]->TaxImprovementPercent)) ? $a[0]->TaxImprovementPercent : '';
                $_title_co = (isset($a[0]->TITLE_CO)) ? $a[0]->TITLE_CO : '';
                $_tot_baths_est = (isset($a[0]->TOT_BATHS_EST)) ? $a[0]->TOT_BATHS_EST : '';
                $_ttl_appr_val = (isset($a[0]->TTL_APPR_VAL)) ? $a[0]->TTL_APPR_VAL : '';
                $_ttl_bld_sqft = (isset($a[0]->TTL_BLD_SQFT)) ? $a[0]->TTL_BLD_SQFT : '';
                $_ttl_tax = (isset($a[0]->TTL_TAX)) ? $a[0]->TTL_TAX : '';
                $_unit_number = (isset($a[0]->UNIT_NMBR)) ? $a[0]->UNIT_NMBR : '';
                $_vet_exempt = (isset($a[0]->VET_EXEMPT)) ? $a[0]->VET_EXEMPT : '';
                $_water_type = (isset($a[0]->WATER_TYPE)) ? $a[0]->WATER_TYPE : '';
    
            //unregistered row

            }

            $uniqueID = uniqid();
            /** INSERT INTO DATABASE PERSON */
                $newPerson = Person::create([
                    'uniqueID' => $uniqueID,
                    'firstName' => $_FirstName,
                    'middleName' => '',
                    'lastName' => $_LastName,
                    'age' => '0',
                    'identityScore' => '0',
                    'lastEntry' => date('Y-m-d H:i:s'),
                ]);

                $newPersonID = $newPerson->id;
            /** INSERT INTO DATABASE PERSON */

            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */
            $filteredEmails = [];
            $otherEmails = [];
            foreach ($bigEmail as $index => $email) {
                if (strpos($email, 'yahoo.com') !== false || strpos($email, 'aol.com') !== false) {
                    $filteredEmails[] = $email;
                } else {
                    $otherEmails[] = $email;
                }
            }
            /** SEPARATE BETWEEN YAHOO/AOL AND OTHER EMAIL */

            Log::info("BigBDM Have result - CHECK ZERO BOUNCE");
            /** NEW METHOD TO CHECK AND GET EMAIL */
            foreach($otherEmails as $index => $be) {
                if (trim($be) != "") {
                    $tmpEmail = strtolower(trim($be));
                    $tmpMd5 = md5($tmpEmail);

                    $startZbValidationTime = microtime(true);
                    
                    $param = [
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'leadspeek_type' => $leadspeektype,
                        'md5param' => $tmpMd5,
                    ];
                    $zbcheck = $this->true_list_validation($tmpEmail,$param);

                    $endZbValidationTime = microtime(true);

                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')

                    $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                    $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                    $executionTimeList['zb_validation'] = [
                        'start_execution_time' => $startZbValidationDate,
                        'end_execution_time' => $endZbValidationDate,
                        'total_execution_time' => $totalZbValidationTime
                    ];

                    // Handle both TrueList and ZeroBounce responses
                    $isValid = false;
                    $validationStatus = '';
                    $apiType = '';
                    
                    // Check TrueList response format
                    if (isset($zbcheck->emails[0]->email_state)) {
                        $validationStatus = $zbcheck->emails[0]->email_state;
                        $apiType = 'truelist';
                        $isValid = ($zbcheck->emails[0]->email_state == "ok");
                    }
                    // Check ZeroBounce response format
                    elseif (isset($zbcheck->status)) {
                        $validationStatus = $zbcheck->status;
                        $apiType = 'zerobounce';
                        $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                    }
                    if ($validationStatus !== '') {
                        if (!$isValid) {
                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $tmpEmail,
                                'emailmd5' => md5($tmpEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                            ]);
                            /** PUT IT ON OPTOUT LIST */

                            if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                $this->UpsertFailedLeadRecord([
                                    'function' => __FUNCTION__,
                                    'type' => 'blocked',
                                    'blocked_type' => $apiType,
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                    'leadspeek_api_id' => $leadspeek_api_id,
                                    'email_encrypt' => $tmpMd5,
                                    'leadspeek_type' => $leadspeektype,
                                    'email' => $tmpEmail,
                                    'status' => $validationStatus,
                                ]);
                            }

                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                        }else{
                            $newpersonemail = PersonEmail::create([
                                'person_id' => $newPersonID,
                                'email' => $tmpEmail,
                                'email_encrypt' => $tmpMd5,
                                'permission' => 'T',
                                'zbvalidate' => date('Y-m-d H:i:s'),
                            ]);

                            if ($_Email ==  "") {
                                $_Email = $tmpEmail;
                            }else if ($_Email2 == "") {
                                $_Email2 = $tmpEmail;
                            }

                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                        }
                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id, 'enhance', $apiType . '_details', $validationStatus);
                        /** REPORT ANALYTIC */
                    }else{
                        $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                    }

                }
            }
            /** NEW METHOD TO CHECK AND GET EMAIL */

            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */
            if (trim($_Email) == '') {
                /** NEW METHOD TO CHECK AND GET EMAIL */
                foreach($filteredEmails as $index => $be) {
                    if (trim($be) != "") {
                        $tmpEmail = strtolower(trim($be));
                        $tmpMd5 = md5($tmpEmail);

                        $startZbValidationTime = microtime(true);

                        $param = [
                            'leadspeek_api_id' => $leadspeek_api_id,
                            'leadspeek_type' => $leadspeektype,
                            'md5param' => $tmpMd5,
                        ];
                        $zbcheck = $this->true_list_validation($tmpEmail,$param);


                        $endZbValidationTime = microtime(true);

                        // convert epochtime to date format ('Y-m-d H:i:s')
                        $startZbValidationDate = Carbon::createFromTimestamp($startZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        $endZbValidationDate = Carbon::createFromTimestamp($endZbValidationTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                        // convert epochtime to date format ('Y-m-d H:i:s')

                        $totalZbValidationTime = $endZbValidationTime - $startZbValidationTime;
                        $totalZbValidationTime = number_format($totalZbValidationTime,2,'.','');

                        $executionTimeList['zb_validation'] = [
                            'start_execution_time' => $startZbValidationDate,
                            'end_execution_time' => $endZbValidationDate,
                            'total_execution_time' => $totalZbValidationTime
                        ];

                        // Handle both TrueList and ZeroBounce responses
                        $isValid = false;
                        $validationStatus = '';
                        $apiType = '';
                        
                        // Check TrueList response format
                        if (isset($zbcheck->emails[0]->email_state)) {
                            $validationStatus = $zbcheck->emails[0]->email_state;
                            $apiType = 'truelist';
                            $isValid = ($zbcheck->emails[0]->email_state == "ok");
                        }
                        // Check ZeroBounce response format
                        elseif (isset($zbcheck->status)) {
                            $validationStatus = $zbcheck->status;
                            $apiType = 'zerobounce';
                            $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                        }
                        if ($validationStatus !== '') {
                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id, 'enhance', $apiType . '_details', $validationStatus);
                            /** REPORT ANALYTIC */
                            if (!$isValid) {
                                /** PUT IT ON OPTOUT LIST */
                                $createoptout = OptoutList::create([
                                    'email' => $tmpEmail,
                                    'emailmd5' => md5($tmpEmail),
                                    'blockedcategory' => 'zbnotvalid',
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                ]);
                                /** PUT IT ON OPTOUT LIST */

                                if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                    $this->UpsertFailedLeadRecord([
                                        'function' => __FUNCTION__,
                                        'type' => 'blocked',
                                        'blocked_type' => $apiType,
                                        'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email' . $index . 'fromBigMD5',
                                        'leadspeek_api_id' => $leadspeek_api_id,
                                        'email_encrypt' => $tmpMd5,
                                        'leadspeek_type' => $leadspeektype,
                                        'email' => $tmpEmail,
                                        'status' => $validationStatus,
                                    ]);
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBFailed";
                            }else{
                                $newpersonemail = PersonEmail::create([
                                    'person_id' => $newPersonID,
                                    'email' => $tmpEmail,
                                    'email_encrypt' => $tmpMd5,
                                    'permission' => 'T',
                                    'zbvalidate' => date('Y-m-d H:i:s'),
                                ]);

                                if ($_Email ==  "") {
                                    $_Email = $tmpEmail;
                                    break;
                                }else if ($_Email2 == "") {
                                    $_Email2 = $tmpEmail;
                                }

                                $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBSuccess";
                            }
                        }else{
                            $trackBigBDM = $trackBigBDM . "->Email" . $index . "ZBNotValidate";
                        }

                    }
                }
                /** NEW METHOD TO CHECK AND GET EMAIL */
            }
            /** CHECK IF STANDARD EMAIL NOT GET ANY VALID EMAIL */

            if (trim($_Email) == "" && trim($_Email2) == "") {
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,'enhance','zerobouncefailed');
                    $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                /** REPORT ANALYTIC */

                Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 and Email 2 NOT VALID");
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 NOT VALID CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */


                /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_advance',
                        'type' => 'blocked',
                        'blocked_type' => 'truelist',
                        'description' => 'blocked in truelist fetch bigBDM_MD5 function process_BDM_advance',
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                /* WRITE UPSER FAILED LEAD RECORD */
            }else{
                /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,'enhance','zerobounce');
                    $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                /** REPORT ANALYTIC */
                Log::info("BigBDM Have result - CHECK ZERO BOUNCE - Email 1 or Email 2 VALID");

                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
                // Log::info("RELEASE GETDATAMATCH LOCK Process DATA BIG BDM - Email 1 and Email 2 VALID CampaignID #" . $leadspeek_api_id);
                // $this->releaseLock($initLock);
                // /* RELEASE LOCK PROCESS FOR GETDATAMATCH */
            }

            Log::info("BigBDM BDM_ADVANCE CHECK PHONE1");
            if (trim($_mobile_phone) != "") {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_mobile_phone),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            Log::info("BigBDM BDM_ADVANCE CHECK PHONE2");
            if (trim($_mobile_phone2) != "") {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_mobile_phone2),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            Log::info("BigBDM BDM_ADVANCE CHECK PHONE3");
            if (trim($_mobile_phone3) != "") {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_mobile_phone3),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            Log::info("BigBDM BDM_ADVANCE CHECK Address");
            /** INSERT INTO PERSON_ADDRESSES */
            $newpersonaddress = PersonAddress::create([
                'person_id' => $newPersonID,
                'street' => $_Address1,
                'unit' => $_Address2,
                'city' => $_City,
                'state' => $_State,
                'zip' => $_Zipcode,
                'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                'firstReportedDate' => date('Y-m-d'),
                'lastReportedDate' => date('Y-m-d'),
            ]);

            /** INSERT INTO PERSON_ADDRESSES */

            //INSERT PERSON ADVANCE 1 
            $newpersonadvance1 = PersonAdvance::create([
                'person_id' => $newPersonID,
                'gender_aux' => $_gender_aux,
                'gender' => $_gender,
                'age_aux' => $_age_aux,
                'birth_year_aux' => $_birth_year_aux,
                'generation' => $_generation,
                'marital_status' => $_marital_status,
                'income_household' => $_household_income,
                'income_midpts_household' => $_median_household_income,
                'net_worth_household' => $_household_net_worth,
                'net_worth_midpt_household' => $_median_household_net_worth,
                'discretionary_income' => $_discretionary_income,
                'credit_midpts' => $_credit_score_median,
                'credit_range' => $_credit_score_range,
                'occupation_category' => $_occupation_category,
                'occupation_detail' => $_occupation_detail,
                'occupation_type' => $_occupation_type,
                'voter' => $_voter,
                'urbanicity' => $_urbanicity,
                'mobile_phone_1' => $_mobile_phone,
                'mobile_phone_2' => $_mobile_phone2,
                'mobile_phone_3' => $_mobile_phone3,
                'mobile_phone_1_dnc' => $_mobile_phone_dnc,
                'mobile_phone_2_dnc' => $_mobile_phone_dnc2,
                'mobile_phone_3_dnc' => $_mobile_phone_dnc3,
                'tax_bill_mailing_address' => $_tax_bill_mailing_address,
                'tax_bill_mailing_city' => $_tax_bill_mailing_city,
                'tax_bill_mailing_county' => $_tax_bill_mailing_county,
                'tax_bill_mailing_fips' => $_tax_bill_mailing_fips,
                'tax_bill_mailing_state' => $_tax_bill_mailing_state,
                'tax_bill_mailing_zip' => $_tax_bill_mailing_zip,
                'tax_bill_mailing_zip4' => $_tax_bill_mailing_zip4,
                'num_adults_household' => $_num_adults_household,
                'num_children_household' => $_num_children_household,
                'num_persons_household' => $_num_persons_household,
                'child_aged_0_3_household' => $_child_aged_0_3_household,
                'child_aged_4_6_household' => $_child_aged_4_6_household,
                'child_aged_7_9_household' => $_child_aged_7_9_household,
                'child_aged_10_12_household' => $_child_aged_10_12_household,
                'child_aged_13_18_household' => $_child_aged_13_18_household,
                'children_household' => $_children_household,
                'has_email' => $_has_email,
                'has_phone' => $_has_phone,
                'magazine_subscriber' => $_magazine_subscriber,
                'charity_interest' => $_charity_interest,
                'likely_charitable_donor' => $_likely_charitable_donor,
                'donor_affinity' => $_donor_affinity,
                'dwelling_type' => $_dwelling_type,
                'home_owner' => $_home_owner,
                'home_owner_ordinal' => $_home_owner_ordinal,
                'length_of_residence' => $_length_of_residence,
                'home_price' => $_home_price,
                'home_value' => $_home_value,
                'median_home_value' => $_median_home_value,
                'living_sqft' => $_living_sqft,
                'yr_built_orig' => $_year_built_original,
                'yr_built_range' => $_year_built_range,
                'lot_number' => $_lot_number,
                'legal_description' => $_legal_description,
                'land_sqft' => $_land_sqft,
                'garage_sqft' => $_garage_sqft,
                'subdivision' => $_subdivision,
                'zoning_code' => $_zoning_code,
                'cooking' => $_cooking,
                'gardening' => $_gardening,
                'music' => $_music,
                'diy' => $_diy,
                'books' => $_books,
                'travel_vacation' => $_travel_vacation,
                'health_beauty_products' => $_health_beauty_products,
                'pet_owner' => $_pet_owner,
                'photography' => $_photography,
                'fitness' => $_fitness,
                'epicurean' => $_epicurean,
                'cbsa' => $_cbsa,
                'census_block' => $_census_block,
                'census_block_group' => $_census_block_group,
                'census_tract' => $_census_tract,
                
                'aerobics' => $_aerobics,
                'african_american_affinity' => $_african_american_affinity ,
                'amex_card' => $_amex_card,
                'antiques' => $_antiques,
                'apparel_accessory_affinity' => $_apparel_accessory_affinity,
                'apparel_affinity' => $_apparel_affinity,
                'arts_and_crafts' => $_arts_and_crafts,
                'asian_affinity' => $_asian_affinity,
                'auto_affinity' => $_auto_affinity,
                'auto_racing_affinity' => $_auto_racing_affinity,
                'aviation_affinity' => $_aviation_affinity,
                'bank_card' => $_bank_card,
                'bargain_hunter_affinity' => $_bargain_hunter_affinity,
                'baseball' => $_baseball,
                'baseball_affinity' => $_baseball_affinity,
                'basketball' => $_basketball,
                'basketball_affinity' => $_basketball_affinity,
                'beauty_affinity' => $_beauty_affinity,
                'bible_affinity' => $_bible_affinity,
                'bird_watching' => $_bird_watching,
                'birds_affinity' => $_birds_affinity,
                'blue_collar' => $_blue_collar,
                'boating_sailing' => $_boating_sailing,
                'boating_sailing_affinity' => $_boating_sailing_affinity,
                'business_affinity' => $_business_affinity,
                'camping_hiking' => $_camping_hiking,
                'camping_hiking_climbing_affinity' => $_camping_hiking_climbing_affinity,
                'cars_interest' => $_cars_interest,
                'cat_owner' => $_cat_owner,
                'catalog_affinity' => $_catalog_affinity,
                'cigars' => $_cigars,
                'classical_music' => $_classical_music,
                'coins' => $_coins,
                'collectibles_affinity' => $_collectibles_affinity,
                'college_affinity' => $_college_affinity,
                'computers_affinity' => $_computers_affinity,
                'continuity_program_affinity' => $_continuity_program_affinity,
                'cooking_affinity' => $_cooking_affinity,
                'cosmetics' => $_cosmetics,
                'country_music' => $_country_music,
                'crafts_affinity' => $_crafts_affinity,
                'credit_card' => $_credit_card,
                'credit_repair_affinity' => $_credit_repair_affinity,
                'crochet_affinity' => $_crochet_affinity,
            ]);
            //INSERT PERSON ADVANCE 1

            //INSERT PERSON ADVANCE 2
            $newpersonadvance2 = PersonAdvance2::create([
                'person_id' => $newPersonID,
                'diet_affinity' => $_diet_affinity,
                'dieting' => $_dieting,
                'do_it_yourself_affinity' => $_do_it_yourself_affinity,
                'dog_owner' => $_dog_owner,
                'doll_collector' => $_doll_collector,
                'education' => $_education,
                'education_ordinal' => $_education_ordinal,
                'education_seekers_affinity' => $_education_seekers_affinity,
                'ego_affinity' => $_ego_affinity,
                'entertainment_interest' => $_entertainment_interest,
                'figurines_collector' => $_figurines_collector,
                'fine_arts_collector' => $_fine_arts_collector,
                'fishing' => $_fishing,
                'fishing_affinity' => $_fishing_affinity,
                'fitness_affinity' => $_fitness_affinity,
                'football' => $_football,
                'football_affinity' => $_football_affinity,
                'gambling' => $_gambling,
                'gambling_affinity' => $_gambling_affinity,
                'games_affinity' => $_games_affinity,
                'gardening_affinity' => $_gardening_affinity,
                'generation_ordinal' => $_generation_ordinal,
                'golf' => $_golf,
                'golf_affinity' => $_golf_affinity,
                'gourmet_affinity' => $_gourmet_affinity,
                'grandparents_affinity' => $_grandparents_affinity,
                'health_affinity' => $_health_affinity,
                'healthy_living' => $_healthy_living,
                'healthy_living_interest' => $_healthy_living_interest,
                'high_tech_affinity' => $_high_tech_affinity,
                'hispanic_affinity' => $_hispanic_affinity,
                'hockey' => $_hockey,
                'hockey_affinity' => $_hockey_affinity,
                'home_decor' => $_home_decor,
                'home_improvement_interest' => $_home_improvement_interest,
                'home_office_affinity' => $_home_office_affinity,
                'home_study' => $_home_study,
                'hunting' => $_hunting,
                'hunting_affinity' => $_hunting_affinity,
                'jazz' => $_jazz,
                'kids_apparel_affinity' => $_kids_apparel_affinity,
                'knit_affinity' => $_knit_affinity,
                'knitting_quilting_sewing' => $_knitting_quilting_sewing,
                'luxury_life' => $_luxury_life,
                'married' => $_married,
                'median_income' => $_median_income,
                'mens_apparel_affinity' => $_mens_apparel_affinity,
                'mens_fashion_affinity' => $_mens_fashion_affinity,
                'mortgage_age' => $_mortgage_age,
                'mortgage_amount' => $_mortgage_amount,
                'mortgage_loan_type' => $_mortgage_loan_type,
                'mortgage_refi_age' => $_mortgage_refi_age,
                'mortgage_refi_amount' => $_mortgage_refi_amount,
                'mortgage_refi_type' => $_mortgage_refi_type,
                'motor_racing' => $_motor_racing,
                'motorcycles' => $_motorcycles,
                'motorcycles_affinity' => $_motorcycles_affinity,
                'movies' => $_movies,
                'nascar' => $_nascar,
                'needlepoint_affinity' => $_needlepoint_affinity,
                'new_credit_offered_household' => $_new_credit_offered_household,
                'num_credit_lines_household' => $_num_credit_lines_household,
                'num_generations_household' => $_num_generations_household,
                'outdoors' => $_outdoors,
                'outdoors_affinity' => $_outdoors_affinity,
                'owns_investments' => $_owns_investments,
                'owns_mutual_funds' => $_owns_mutual_funds,
                'owns_stocks_and_bonds' => $_owns_stocks_and_bonds,
                'owns_swimming_pool' => $_owns_swimming_pool,
                'personal_finance_affinity' => $_personal_finance_affinity,
                'personality' => $_personality,
                'plates_collector' => $_plates_collector,
                'pop_density' => $_pop_density,
                'premium_amex_card' => $_premium_amex_card,
                'premium_card' => $_premium_card,
                'premium_income_household' => $_premium_income_household,
                'premium_income_midpt_household' => $_premium_income_midpt_household,
                'quilt_affinity' => $_quilt_affinity,
                'religious_music' => $_religious_music,
                'rhythm_and_blues' => $_rhythm_and_blues,
                'rock_music' => $_rock_music,
                'running' => $_running,
                'rv' => $_rv,
                'scuba' => $_scuba,
                'self_improvement' => $_self_improvement,
                'sewing_affinity' => $_sewing_affinity,
                'single_family_dwelling' => $_single_family_dwelling,
                'snow_skiing' => $_snow_skiing,
                'snow_skiing_affinity' => $_snow_skiing_affinity,
                'soccer' => $_soccer,
                'soccer_affinity' => $_soccer_affinity,
                'soft_rock' => $_soft_rock,
                'soho_business' => $_soho_business,
                'sports_memoribilia_collector' => $_sports_memoribilia_collector,
                'stamps' => $_stamps,
                'sweepstakes_affinity' => $_sweepstakes_affinity,
                'tennis' => $_tennis,
                'tennis_affinity' => $_tennis_affinity,
                'tobacco_affinity' => $_tobacco_affinity,
                'travel_affinity' => $_travel_affinity,
                'travel_cruise_affinity' => $_travel_cruise_affinity,
                'travel_cruises' => $_travel_cruises,
                'travel_personal' => $_travel_personal,
                'travel_rv_affinity' => $_travel_rv_affinity,
                'travel_us_affinity' => $_travel_us_affinity,
                'truck_owner' => $_truck_owner,
                'trucks_affinity' => $_trucks_affinity,
                'tv_movies_affinity' => $_tv_movies_affinity,
                'veteran_household' => $_veteran_household,
                'walking' => $_walking,
                'weight_lifting' => $_weight_lifting,
                'wildlife_affinity' => $_wildlife_affinity,
                'womens_apparel_affinity' => $_womens_apparel_affinity,
                'womens_fashion_affinity' => $_womens_fashion_affinity,
                'woodworking' => $_woodworking,
                'male_aux' => $_male_aux,
                'political_contributor_aux' => $_political_contributor_aux,
                'political_party_aux' => $_political_party_aux,
                'financial_power' => $_financial_power,
                'mortgage_open_1st_intent' => $_mortgage_open_1st_intent,
                'mortgage_open_2nd_intent' => $_mortgage_open_2nd_intent,
                'mortgage_new_intent' => $_mortgage_new_intent,
                'mortgage_refinance_intent' => $_mortgage_refinance_intent,
                'automotive_loan_intent' => $_automotive_loan_intent,
                'bank_card_intent' => $_bank_card_intent,
                'personal_loan_intent' => $_personal_loan_intent,
                'retail_card_intent' => $_retail_card_intent,
                'student_loan_cons_intent' => $_student_loan_cons_intent,
                'student_loan_intent' => $_student_loan_intent,
                'qtr3_baths' => $_3qtr_baths,
                'ac_type' => $_ac_type,
                'acres' => $_acres,
            ]);
            //INSERT PERSON ADVANCE 2

            //INSERT PERSON ADVANCE 3
            $newpersonadvance3 = PersonAdvance3::create([
                'person_id' => $newPersonID,
                'additions_square_feet' => $_additions_square_feet,
                'assess_val_impr' => $_assess_val_impr,
                'assess_val_lnd' => $_assess_val_lnd,
                'assess_val_prop' => $_assess_val_prop,
                'bldg_style' => $_bldg_style,
                'bsmt_sqft' => $_bsmt_sqft,
                'bsmt_type' => $_bsmt_type,
                'build_sqft_assess' => $_build_sqft_assess,
                'business' => $_business,
                'combined_statistical_area' => $_combined_statistical_area,
                'metropolitan_division' => $_metropolitan_division,
                'middle' => $_middle,
                'middle_2' => $_middle_2,
                'mkt_ip_perc' => $_mkt_ip_perc,
                'mobile_home' => $_mobile_home,

                'mrtg_due' => $_mrtg_due,
                'mrtg_intrate' => $_mrtg_intrate,
                'mrtg_refi' => $_mrtg_refi,
                'mrtg_term' => $_mrtg_term,
                'mrtg_type' => $_mrtg_type,

                'mrtg2_amt' => $_mrtg2_amt,
                'mrtg2_date' => $_mrtg2_date,
                'mrtg2_deed_type' => $_mrtg2_deed_type,
                'mrtg2_due' => $_mrtg2_due,
                'mrtg2_equity' => $_mrtg2_equity,
                'mrtg2_intrate' => $_mrtg2_intrate,
                'mrtg2_inttype' => $_mrtg2_inttype,
                'mrtg2_refi' => $_mrtg2_refi,
                'mrtg2_term' => $_mrtg2_term,
                'mrtg2_type' => $_mrtg2_type,

                'mrtg3_amt' => $_mrtg3_amt,
                'mrtg3_date' => $_mrtg3_date,
                'mrtg3_deed_type' => $_mrtg3_deed_type,
                'mrtg3_due' => $_mrtg3_due,
                'mrtg3_equity' => $_mrtg3_equity,
                'mrtg3_inttype' => $_mrtg3_inttype,
                'mrtg3_refi' => $_mrtg3_refi,
                'mrtg3_term' => $_mrtg3_term,
                'mrtg3_type' => $_mrtg3_type,

                'msa_code' => $_msa_code,
                'number_bedrooms' => $_number_bedrooms,
                'number_bldgs' => $_number_bldgs,
                'number_fireplace' => $_number_fireplace,
                'number_park_spaces' => $_number_park_spaces,
                'number_rooms' => $_number_rooms,
                'own_biz' => $_own_biz,
                'owner_occupied' => $_owner_occupied,
                'ownership_relation' => $_ownership_relation,
                'owner_type_description' => $_owner_type_description,
                'estimated_value' => $_estimated_value,
                'ext_type' => $_ext_type,
                'finish_square_feet2' => $_finish_square_feet2,
                'fireplace' => $_fireplace,
                'first' => $_first,
                'first_2' => $_first_2,
                'found_type' => $_found_type,
                'fr_feet' => $_fr_feet,
                'fuel_type' => $_fuel_type,
                'full_baths' => $_full_baths,
                'half_baths' => $_half_baths,
                'garage_type' => $_garage_type,
                'grnd_sqft' => $_grnd_sqft,
                'heat_type' => $_heat_type,
                'hmstd' => $_hmstd,
                'impr_appr_val' => $_impr_appr_val,
                'imprval' => $_imprval,
                'imprval_type' => $_imprval_type,
                'land_appr_val' => $_land_appr_val,
                'landval' => $_landval,
                'landval_type' => $_landval_type,
                'last' => $_last,
                'last_2' => $_last_2,
                'lat' => $_lat,
                'lender_name' => $_lender_name,
                'lender2_name' => $_lender2_name,
                'lender3_name' => $_lender3_name,
                'loan_amt' => $_loan_amt,
                'loan_date' => $_loan_date,
                'loan_to_val' => $_loan_to_val,
                'lon' => $_lon,
                'markval' => $_markval,
                'markval_type' => $_markval_type,
                'patio_porch' => $_patio_porch,
                'patio_square_feet' => $_patio_square_feet,
                'pool' => $_pool,
                'porch_square_feet' => $_porch_square_feet,
                'previous_assessed_value' => $_previous_assessed_value,
                'prop_type' => $_prop_type,
                'rate_type' => $_rate_type,
                'rec_date' => $_rec_date,
                'roof_covtype' => $_roof_covtype,
                'roof_shapetype' => $_roof_shapetype,
                'sale_amt' => $_sale_amt,
                'sale_amt_pr' => $_sale_amt_pr,
                'sale_date' => $_sale_date,
                'sale_type_pr' => $_sale_type_pr,
                'sales_type' => $_sales_type,
                'sell_name' => $_sell_name,
                'sewer_type' => $_sewer_type,
                'site_quality' => $_site_quality,
                'std_address' => $_std_address,
                'std_city' => $_std_city,
                'std_state' => $_std_state,
                'std_zip' => $_std_zip,
                'std_zip4' => $_std_zip4,
                'stories_number' => $_stories_number,
                'suffix' => $_suffix,
                'suffix_2' => $_suffix_2,
                'tax_yr' => $_tax_yr,
                'tax_improvement_percent' => $_tax_improvement_percent,
                'title_co' => $_title_co,
                'tot_baths_est' => $_tot_baths_est,
                'ttl_appr_val' => $_ttl_appr_val,
                'ttl_bld_sqft' => $_ttl_bld_sqft,
                'ttl_tax' => $_ttl_tax,
                'unit_number' => $_unit_number,
                'vet_exempt' => $_vet_exempt,
                'water_type' => $_water_type,
            ]);
            //INSERT PERSON ADVANCE 3

            //INSERT PERSON ADVANCE 
            // /** HR TEMPORARY NOT SAVE 27 Jan 2025 */
            // $newpersonadvance = PersonAdvance::create([
            //     'person_id' => $newPersonID,
            //     'gender_aux' => $_gender_aux,
            //     'gender' => $_gender,
            //     'age_aux' => $_age_aux,
            //     'birth_year_aux' => $_birth_year_aux,
            //     'generation' => $_generation,
            //     'income_household' => $_household_income,
            //     'income_midpts_household' => $_median_household_income,
            //     'net_worth_household' => $_household_net_worth,
            //     'net_worth_midpt_household' => $_median_household_net_worth,
            //     'discretionary_income' => $_discretionary_income,
            //     'credit_midpts' => $_credit_score_median,
            //     'credit_range' => $_credit_score_range,
            //     'occupation_category' => $_occupation_category,
            //     'occupation_detail' => $_occupation_detail,
            //     'occupation_type' => $_occupation_type,
            //     'voter' => $_voter,
            //     'urbanicity' => $_urbanicity,
            //     'mobile_phone_1' => $_mobile_phone,
            //     'mobile_phone_2' => $_mobile_phone2,
            //     'mobile_phone_3' => $_mobile_phone3,
            //     'mobile_phone_1_dnc' => $_mobile_phone_dnc,
            //     'mobile_phone_2_dnc' => $_mobile_phone_dnc2,
            //     'mobile_phone_3_dnc' => $_mobile_phone_dnc3,
            //     'tax_bill_mailing_address' => $_tax_bill_mailing_address,
            //     'tax_bill_mailing_city' => $_tax_bill_mailing_city,
            //     'tax_bill_mailing_county' => $_tax_bill_mailing_county,
            //     'tax_bill_mailing_fips' => $_tax_bill_mailing_fips,
            //     'tax_bill_mailing_state' => $_tax_bill_mailing_state,
            //     'tax_bill_mailing_zip' => $_tax_bill_mailing_zip,
            //     'tax_bill_mailing_zip4' => $_tax_bill_mailing_zip4,
            //     'num_adults_household' => $_num_adults_household,
            //     'num_children_household' => $_num_children_household,
            //     'num_persons_household' => $_num_persons_household,
            //     'child_aged_0_3_household' => $_child_aged_0_3_household,
            //     'child_aged_4_6_household' => $_child_aged_4_6_household,
            //     'child_aged_7_9_household' => $_child_aged_7_9_household,
            //     'child_aged_10_12_household' => $_child_aged_10_12_household,
            //     'child_aged_13_18_household' => $_child_aged_13_18_household,
            //     'children_household' => $_children_household,
            //     'has_email' => $_has_email,
            //     'has_phone' => $_has_phone,
            //     'magazine_subscriber' => $_magazine_subscriber,
            //     'charity_interest' => $_charity_interest,
            //     'likely_charitable_donor' => $_likely_charitable_donor,
            //     'donor_affinity' => $_donor_affinity,
            //     'dwelling_type' => $_dwelling_type,
            //     'home_owner' => $_home_owner,
            //     'home_owner_ordinal' => $_home_owner_ordinal,
            //     'length_of_residence' => $_length_of_residence,
            //     'home_price' => $_home_price,
            //     'home_value' => $_home_value,
            //     'median_home_value' => $_median_home_value,
            //     'living_sqft' => $_living_sqft,
            //     'yr_built_orig' => $_year_built_original,
            //     'yr_built_range' => $_year_built_range,
            //     'lot_number' => $_lot_number,
            //     'legal_description' => $_legal_description,
            //     'land_sqft' => $_land_sqft,
            //     'garage_sqft' => $_garage_sqft,
            //     'subdivision' => $_subdivision,
            //     'zoning_code' => $_zoning_code,
            //     'cooking' => $_cooking,
            //     'gardening' => $_gardening,
            //     'music' => $_music,
            //     'diy' => $_diy,
            //     'books' => $_books,
            //     'travel_vacation' => $_travel_vacation,
            //     'health_beauty_products' => $_health_beauty_products,
            //     'pet_owner' => $_pet_owner,
            //     'photography' => $_photography,
            //     'fitness' => $_fitness,
            //     'epicurean' => $_epicurean,
            //     'cbsa' => $_cbsa,
            //     'census_block' => $_census_block,
            //     'census_block_group' => $_census_block_group,
            //     'census_tract' => $_census_tract,
                
            //     'aerobics' => $_aerobics,
            //     'african_american_affinity' => $_african_american_affinity ,
            //     'amex_card' => $_amex_card,
            //     'antiques' => $_antiques,
            //     'apparel_accessory_affinity' => $_apparel_accessory_affinity,
            //     'apparel_affinity' => $_apparel_affinity,
            //     'arts_and_crafts' => $_arts_and_crafts,
            //     'asian_affinity' => $_asian_affinity,
            //     'auto_affinity' => $_auto_affinity,
            //     'auto_racing_affinity' => $_auto_racing_affinity,
            //     'aviation_affinity' => $_aviation_affinity,
            //     'bank_card' => $_bank_card,
            //     'bargain_hunter_affinity' => $_bargain_hunter_affinity,
            //     'baseball' => $_baseball,
            //     'baseball_affinity' => $_baseball_affinity,
            //     'basketball' => $_basketball,
            //     'basketball_affinity' => $_basketball_affinity,
            //     'beauty_affinity' => $_beauty_affinity,
            //     'bible_affinity' => $_bible_affinity,
            //     'bird_watching' => $_bird_watching,
            //     'birds_affinity' => $_birds_affinity,
            //     'blue_collar' => $_blue_collar,
            //     'boating_sailing' => $_boating_sailing,
            //     'boating_sailing_affinity' => $_boating_sailing_affinity,
            //     'business_affinity' => $_business_affinity,
            //     'camping_hiking' => $_camping_hiking,
            //     'camping_hiking_climbing_affinity' => $_camping_hiking_climbing_affinity,
            //     'cars_interest' => $_cars_interest,
            //     'cat_owner' => $_cat_owner,
            //     'catalog_affinity' => $_catalog_affinity,
            //     'cigars' => $_cigars,
            //     'classical_music' => $_classical_music,
            //     'coins' => $_coins,
            //     'collectibles_affinity' => $_collectibles_affinity,
            //     'college_affinity' => $_college_affinity,
            //     'computers_affinity' => $_computers_affinity,
            //     'continuity_program_affinity' => $_continuity_program_affinity,
            //     'cooking_affinity' => $_cooking_affinity,
            //     'cosmetics' => $_cosmetics,
            //     'country_music' => $_country_music,
            //     'crafts_affinity' => $_crafts_affinity,
            //     'credit_card' => $_credit_card,
            //     'credit_repair_affinity' => $_credit_repair_affinity,
            //     'crochet_affinity' => $_crochet_affinity,
            //     'diet_affinity' => $_diet_affinity,
            //     'dieting' => $_dieting,
            //     'do_it_yourself_affinity' => $_do_it_yourself_affinity,
            //     'dog_owner' => $_dog_owner,
            //     'doll_collector' => $_doll_collector,
            //     'education' => $_education,
            //     'education_ordinal' => $_education_ordinal,
            //     'education_seekers_affinity' => $_education_seekers_affinity,
            //     'ego_affinity' => $_ego_affinity,
            //     'entertainment_interest' => $_entertainment_interest,
            //     'figurines_collector' => $_figurines_collector,
            //     'fine_arts_collector' => $_fine_arts_collector,
            //     'fishing' => $_fishing,
            //     'fishing_affinity' => $_fishing_affinity,
            //     'fitness_affinity' => $_fitness_affinity,
            //     'football' => $_football,
            //     'football_affinity' => $_football_affinity,
            //     'gambling' => $_gambling,
            //     'gambling_affinity' => $_gambling_affinity,
            //     'games_affinity' => $_games_affinity,
            //     'gardening_affinity' => $_gardening_affinity,
            //     'generation_ordinal' => $_generation_ordinal,
            //     'golf' => $_golf,
            //     'golf_affinity' => $_golf_affinity,
            //     'gourmet_affinity' => $_gourmet_affinity,
            //     'grandparents_affinity' => $_grandparents_affinity,
            //     'health_affinity' => $_health_affinity,
            //     'healthy_living' => $_healthy_living,
            //     'healthy_living_interest' => $_healthy_living_interest,
            //     'high_tech_affinity' => $_high_tech_affinity,
            //     'hispanic_affinity' => $_hispanic_affinity,
            //     'hockey' => $_hockey,
            //     'hockey_affinity' => $_hockey_affinity,
            //     'home_decor' => $_home_decor,
            //     'home_improvement_interest' => $_home_improvement_interest,
            //     'home_office_affinity' => $_home_office_affinity,
            //     'home_study' => $_home_study,
            //     'hunting' => $_hunting,
            //     'hunting_affinity' => $_hunting_affinity,
            //     'jazz' => $_jazz,
            //     'kids_apparel_affinity' => $_kids_apparel_affinity,
            //     'knit_affinity' => $_knit_affinity,
            //     'knitting_quilting_sewing' => $_knitting_quilting_sewing,
            //     'luxury_life' => $_luxury_life,
            //     'married' => $_married,
            //     'marital_status' => $_marital_status,
            //     'median_income' => $_median_income,
            //     'mens_apparel_affinity' => $_mens_apparel_affinity,
            //     'mens_fashion_affinity' => $_mens_fashion_affinity,
            //     'mortgage_age' => $_mortgage_age,
            //     'mortgage_amount' => $_mortgage_amount,
            //     'mortgage_loan_type' => $_mortgage_loan_type,
            //     'mortgage_refi_age' => $_mortgage_refi_age,
            //     'mortgage_refi_amount' => $_mortgage_refi_amount,
            //     'mortgage_refi_type' => $_mortgage_refi_type,
            //     'motor_racing' => $_motor_racing,
            //     'motorcycles' => $_motorcycles,
            //     'motorcycles_affinity' => $_motorcycles_affinity,
            //     'movies' => $_movies,
            //     'nascar' => $_nascar,
            //     'needlepoint_affinity' => $_needlepoint_affinity,
            //     'new_credit_offered_household' => $_new_credit_offered_household,
            //     'num_credit_lines_household' => $_num_credit_lines_household,
            //     'num_generations_household' => $_num_generations_household,
            //     'outdoors' => $_outdoors,
            //     'outdoors_affinity' => $_outdoors_affinity,
            //     'owns_investments' => $_owns_investments,
            //     'owns_mutual_funds' => $_owns_mutual_funds,
            //     'owns_stocks_and_bonds' => $_owns_stocks_and_bonds,
            //     'owns_swimming_pool' => $_owns_swimming_pool,
            //     'personal_finance_affinity' => $_personal_finance_affinity,
            //     'personality' => $_personality,
            //     'plates_collector' => $_plates_collector,
            //     'pop_density' => $_pop_density,
            //     'premium_amex_card' => $_premium_amex_card,
            //     'premium_card' => $_premium_card,
            //     'premium_income_household' => $_premium_income_household,
            //     'premium_income_midpt_household' => $_premium_income_midpt_household,
            //     'quilt_affinity' => $_quilt_affinity,
            //     'religious_music' => $_religious_music,
            //     'rhythm_and_blues' => $_rhythm_and_blues,
            //     'rock_music' => $_rock_music,
            //     'running' => $_running,
            //     'rv' => $_rv,
            //     'scuba' => $_scuba,
            //     'self_improvement' => $_self_improvement,
            //     'sewing_affinity' => $_sewing_affinity,
            //     'single_family_dwelling' => $_single_family_dwelling,
            //     'snow_skiing' => $_snow_skiing,
            //     'snow_skiing_affinity' => $_snow_skiing_affinity,
            //     'soccer' => $_soccer,
            //     'soccer_affinity' => $_soccer_affinity,
            //     'soft_rock' => $_soft_rock,
            //     'soho_business' => $_soho_business,
            //     'sports_memoribilia_collector' => $_sports_memoribilia_collector,
            //     'stamps' => $_stamps,
            //     'sweepstakes_affinity' => $_sweepstakes_affinity,
            //     'tennis' => $_tennis,
            //     'tennis_affinity' => $_tennis_affinity,
            //     'tobacco_affinity' => $_tobacco_affinity,
            //     'travel_affinity' => $_travel_affinity,
            //     'travel_cruise_affinity' => $_travel_cruise_affinity,
            //     'travel_cruises' => $_travel_cruises,
            //     'travel_personal' => $_travel_personal,
            //     'travel_rv_affinity' => $_travel_rv_affinity,
            //     'travel_us_affinity' => $_travel_us_affinity,
            //     'truck_owner' => $_truck_owner,
            //     'trucks_affinity' => $_trucks_affinity,
            //     'tv_movies_affinity' => $_tv_movies_affinity,
            //     'veteran_household' => $_veteran_household,
            //     'walking' => $_walking,
            //     'weight_lifting' => $_weight_lifting,
            //     'wildlife_affinity' => $_wildlife_affinity,
            //     'womens_apparel_affinity' => $_womens_apparel_affinity,
            //     'womens_fashion_affinity' => $_womens_fashion_affinity,
            //     'woodworking' => $_woodworking,
            //     'male_aux' => $_male_aux,
            //     'political_contributor_aux' => $_political_contributor_aux,
            //     'political_party_aux' => $_political_party_aux,
            //     'financial_power' => $_financial_power,
            //     'mortgage_open_1st_intent' => $_mortgage_open_1st_intent,
            //     'mortgage_open_2nd_intent' => $_mortgage_open_2nd_intent,
            //     'mortgage_new_intent' => $_mortgage_new_intent,
            //     'mortgage_refinance_intent' => $_mortgage_refinance_intent,
            //     'automotive_loan_intent' => $_automotive_loan_intent,
            //     'bank_card_intent' => $_bank_card_intent,
            //     'personal_loan_intent' => $_personal_loan_intent,
            //     'retail_card_intent' => $_retail_card_intent,
            //     'student_loan_cons_intent' => $_student_loan_cons_intent,
            //     'student_loan_intent' => $_student_loan_intent,
            //     'qtr3_baths' => $_3qtr_baths,
            //     'ac_type' => $_ac_type,
            //     'acres' => $_acres,
            //     'additions_square_feet' => $_additions_square_feet,
            //     'assess_val_impr' => $_assess_val_impr,
            //     'assess_val_lnd' => $_assess_val_lnd,
            //     'assess_val_prop' => $_assess_val_prop,
            //     'bldg_style' => $_bldg_style,
            //     'bsmt_sqft' => $_bsmt_sqft,
            //     'bsmt_type' => $_bsmt_type,
            //     'build_sqft_assess' => $_build_sqft_assess,
            //     'business' => $_business,
            //     'combined_statistical_area' => $_combined_statistical_area,
            //     'metropolitan_division' => $_metropolitan_division,
            //     'middle' => $_middle,
            //     'middle_2' => $_middle_2,
            //     'mkt_ip_perc' => $_mkt_ip_perc,
            //     'mobile_home' => $_mobile_home,

            //     'mrtg_due' => $_mrtg_due,
            //     'mrtg_intrate' => $_mrtg_intrate,
            //     'mrtg_refi' => $_mrtg_refi,
            //     'mrtg_term' => $_mrtg_term,
            //     'mrtg_type' => $_mrtg_type,

            //     'mrtg2_amt' => $_mrtg2_amt,
            //     'mrtg2_date' => $_mrtg2_date,
            //     'mrtg2_deed_type' => $_mrtg2_deed_type,
            //     'mrtg2_due' => $_mrtg2_due,
            //     'mrtg2_equity' => $_mrtg2_equity,
            //     'mrtg2_intrate' => $_mrtg2_intrate,
            //     'mrtg2_inttype' => $_mrtg2_inttype,
            //     'mrtg2_refi' => $_mrtg2_refi,
            //     'mrtg2_term' => $_mrtg2_term,
            //     'mrtg2_type' => $_mrtg2_type,

            //     'mrtg3_amt' => $_mrtg3_amt,
            //     'mrtg3_date' => $_mrtg3_date,
            //     'mrtg3_deed_type' => $_mrtg3_deed_type,
            //     'mrtg3_due' => $_mrtg3_due,
            //     'mrtg3_equity' => $_mrtg3_equity,
            //     'mrtg3_inttype' => $_mrtg3_inttype,
            //     'mrtg3_refi' => $_mrtg3_refi,
            //     'mrtg3_term' => $_mrtg3_term,
            //     'mrtg3_type' => $_mrtg3_type,

            //     'msa_code' => $_msa_code,
            //     'number_bedrooms' => $_number_bedrooms,
            //     'number_bldgs' => $_number_bldgs,
            //     'number_fireplace' => $_number_fireplace,
            //     'number_park_spaces' => $_number_park_spaces,
            //     'number_rooms' => $_number_rooms,
            //     'own_biz' => $_own_biz,
            //     'owner_occupied' => $_owner_occupied,
            //     'ownership_relation' => $_ownership_relation,
            //     'owner_type_description' => $_owner_type_description,
            //     'estimated_value' => $_estimated_value,
            //     'ext_type' => $_ext_type,
            //     'finish_square_feet2' => $_finish_square_feet2,
            //     'fireplace' => $_fireplace,
            //     'first' => $_first,
            //     'first_2' => $_first_2,
            //     'found_type' => $_found_type,
            //     'fr_feet' => $_fr_feet,
            //     'fuel_type' => $_fuel_type,
            //     'full_baths' => $_full_baths,
            //     'half_baths' => $_half_baths,
            //     'garage_type' => $_garage_type,
            //     'grnd_sqft' => $_grnd_sqft,
            //     'heat_type' => $_heat_type,
            //     'hmstd' => $_hmstd,
            //     'impr_appr_val' => $_impr_appr_val,
            //     'imprval' => $_imprval,
            //     'imprval_type' => $_imprval_type,
            //     'land_appr_val' => $_land_appr_val,
            //     'landval' => $_landval,
            //     'landval_type' => $_landval_type,
            //     'last' => $_last,
            //     'last_2' => $_last_2,
            //     'lat' => $_lat,
            //     'lender_name' => $_lender_name,
            //     'lender2_name' => $_lender2_name,
            //     'lender3_name' => $_lender3_name,
            //     'loan_amt' => $_loan_amt,
            //     'loan_date' => $_loan_date,
            //     'loan_to_val' => $_loan_to_val,
            //     'lon' => $_lon,
            //     'markval' => $_markval,
            //     'markval_type' => $_markval_type,
            //     'patio_porch' => $_patio_porch,
            //     'patio_square_feet' => $_patio_square_feet,
            //     'pool' => $_pool,
            //     'porch_square_feet' => $_porch_square_feet,
            //     'previous_assessed_value' => $_previous_assessed_value,
            //     'prop_type' => $_prop_type,
            //     'rate_type' => $_rate_type,
            //     'rec_date' => $_rec_date,
            //     'roof_covtype' => $_roof_covtype,
            //     'roof_shapetype' => $_roof_shapetype,
            //     'sale_amt' => $_sale_amt,
            //     'sale_amt_pr' => $_sale_amt_pr,
            //     'sale_date' => $_sale_date,
            //     'sale_type_pr' => $_sale_type_pr,
            //     'sales_type' => $_sales_type,
            //     'sell_name' => $_sell_name,
            //     'sewer_type' => $_sewer_type,
            //     'site_quality' => $_site_quality,
            //     'std_address' => $_std_address,
            //     'std_city' => $_std_city,
            //     'std_state' => $_std_state,
            //     'std_zip' => $_std_zip,
            //     'std_zip4' => $_std_zip4,
            //     'stories_number' => $_stories_number,
            //     'suffix' => $_suffix,
            //     'suffix_2' => $_suffix_2,
            //     'tax_yr' => $_tax_yr,
            //     'tax_improvement_percent' => $_tax_improvement_percent,
            //     'title_co' => $_title_co,
            //     'tot_baths_est' => $_tot_baths_est,
            //     'ttl_appr_val' => $_ttl_appr_val,
            //     'ttl_bld_sqft' => $_ttl_bld_sqft,
            //     'ttl_tax' => $_ttl_tax,
            //     'unit_number' => $_unit_number,
            //     'vet_exempt' => $_vet_exempt,
            //     'water_type' => $_water_type,
            // ]);
            /** HR TEMPORARY NOT SAVE 27 Jan 2025 */
            //INSERT PERSON ADVANCE

            $_ID = $this->generateReportUniqueNumber();

            Log::info("BigBDM Have result - ReportID #" . $_ID);

            $taxBillInformation = array_filter([
                $_tax_bill_mailing_address,
                $_tax_bill_mailing_city,
                !empty($_tax_bill_mailing_county) ? "{$_tax_bill_mailing_county} County" : null,
                $_tax_bill_mailing_state,
                trim($_tax_bill_mailing_zip . ($_tax_bill_mailing_zip && $_tax_bill_mailing_zip4 ? "-" : "") . $_tax_bill_mailing_zip4, "-")
            ]);            
            $taxBillInformationString = '';
            $taxBillInformationString = implode(", ", $taxBillInformation);

            $new = array(
                "ID" => $_ID,
                "PersonID" => $newPersonID,
                "Email" => $_Email,
                "Email2" => $_Email2,
                "OriginalMD5" => $md5param,
                "IP" => $_IP,
                "Source" => $_Source,
                "OptInDate" => $_OptInDate,
                "ClickDate" => $_ClickDate,
                "Referer" => $_Referer,
                "Phone" => $_mobile_phone,
                "Phone2" => $_mobile_phone2,
                "Phone3" => $_mobile_phone3,
                "FirstName" => $_FirstName,
                "LastName" => $_LastName,
                "Address1" => $_Address1,
                "Address2" => $_Address2,
                "City" => $_City,
                "State" => $_State,
                "Zipcode" => $_Zipcode,
                 // Person advance
                    //identification
                        "GenderAux" => $_gender_aux,
                        // "AgeAux" => $_age_aux,
                        // "BirthYearAux" => $_birth_year_aux,
                        "Generation" => $_generation,
                        'MaritalStatus' => $_marital_status,
                    //identification

                    //financial information
                        "IncomeHousehold" => $_household_income,
                        "IncomeMidptsHousehold" => $_median_household_income,
                        "NetWorthHousehold" => $_household_net_worth,
                        "NetWorthMidptHousehold" => $_median_household_net_worth,
                        "DiscretionaryIncome" => $_discretionary_income,
                        "CreditMidpts" => $_credit_score_median,
                        "CreditRange" => $_credit_score_range,
                    //financial information

                    //occupation
                        "OccupationCategory" => $_occupation_category,
                        "OccupationDetail" => $_occupation_detail,
                        "OccupationType" => $_occupation_type,
                    //occupation

                    //miscellaneous
                        "Voter" => $_voter,
                        "Urbanicity" => $_urbanicity,
                    //miscellaneous

                    //contact information
                        "Phone" => $_mobile_phone,
                        "Phone2" => $_mobile_phone2,
                        "Phone3" => $_mobile_phone3,    
                        "TaxBillInformation" => $taxBillInformationString,
                    //contact information

                    //household information
                        "NumAdultsHousehold" => $_num_adults_household,
                        "NumChildrenHousehold" => $_num_children_household,
                        "NumPersonsHousehold" => $_num_persons_household,
                        "ChildAged03Household" => $_child_aged_0_3_household,
                        "ChildAged46Household" => $_child_aged_4_6_household,
                        "ChildAged79Household" => $_child_aged_7_9_household,
                        "ChildAged1012Household" => $_child_aged_10_12_household,
                        "ChildAged1318Household" => $_child_aged_13_18_household,
                        "ChildrenHousehold" => $_children_household,
                    //household information

                    //marketing indicators
                        // "HasEmail" => $_has_email,
                        // "HasPhone" => $_has_phone,
                        "MagazineSubscriber" => $_magazine_subscriber,
                        "CharityInterest" => $_charity_interest,
                        "LikelyCharitableDonor" => $_likely_charitable_donor,
                    //marketing indicators

                    //house and real estate
                        "DwellingType" => $_dwelling_type,
                        "HomeOwner" => $_home_owner,
                        "HomeOwnerOrdinal" => $_home_owner_ordinal,
                        "LengthOfResidence" => $_length_of_residence,
                        "HomePrice" => $_home_price,
                        "HomeValue" => $_home_value,
                        "MedianHomeValue" => $_median_home_value,
                        "LivingSqft" => $_living_sqft,
                        "YrBuiltOrig" => $_year_built_original,
                        "YrBuiltRange" => $_year_built_range,
                        "LotNumber" => $_lot_number,
                        "LegalDescription" => $_legal_description,
                        "LandSqft" => $_land_sqft,
                        "GarageSqft" => $_garage_sqft,
                        "Subdivision" => $_subdivision,
                        "ZoningCode" => $_zoning_code,
                    //house and real estate

                    //interest and affinities
                        "Cooking" => $_cooking,
                        "Gardening" => $_gardening,
                        "Music" => $_music,
                        "Diy" => $_diy,
                        "Books" => $_books,
                        "TravelVacation" => $_travel_vacation,
                        "HealthBeautyProducts" => $_health_beauty_products,
                        "PetOwner" => $_pet_owner,
                        "Photography" => $_photography,
                        "Fitness" => $_fitness,
                        "Epicurean" => $_epicurean,
                    //interest and affinities

                    //location and census data
                        "Cbsa" => $_cbsa,
                        "CensusBlock" => $_census_block,
                        "CensusBlockGroup" => $_census_block_group,
                        "CensusTract" => $_census_tract,
                    //location and census data
                // Person advance
                "Keyword" => $keyword,
                "Description" => $_Description,
                "LeadFrom" => "bigbdmmd5"
            );

            Log::info("BigBDM Result Ready to Serve");
            /** IF BIG BDM MD5 HAVE RESULT */
        }else{
                
            $trackBigBDM = $trackBigBDM . "->BDMAdvanceNoData";
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|NoDataReturnFromBigBDMAdvance';
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

            $new = array();
                /** BIG BDM NO RESULT CHECK TOWER DATA */
        }

        if (count($new) > 0) {
            /** CHECK FOR LOCATION LOCK */
                $chkloc = $this->checklocationlock($loctarget,$new['Zipcode'],$new['State'],$new['City'],$loczip,$locstate,$locstateexclude,$locstatesifi,$loccity,$loccitysifi,$nationaltargeting,$failedRecordID);
                if ($chkloc) {
                    $trackBigBDM = $trackBigBDM . "->LocationLockFailed";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,'enhance','locationlockfailed');
                    /** REPORT ANALYTIC */

                    /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'process_BDM_advance',
                        'type' => 'blocked',
                        'blocked_type' => 'locationlock',
                        'description' => "blocked in checklocationlock zip = $loczip, state = $locstate, stateexclude = $locstateexclude, city = $loccity function process_BDM_TowerDATA",
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => 'enhance',
                    ]);
                    /* WRITE UPSER FAILED LEAD RECORD */
                    
                    $new = array();
                }else{
                    $trackBigBDM = $trackBigBDM . "->LocationLockSuccess";
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,'enhance','locationlock');
                    /** REPORT ANALYTIC */
                }
            /** CHECK FOR LOCATION LOCK */
        }

            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        Log::info("BigBDM DATA FINAL RETURN");

        // return $new;
        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    
    public function process_BDM_advance_exist($newPersonID = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$leadspeektype = "",$is_advance = false) {
        
        $executionTimeList = [];
        
        date_default_timezone_set('America/Chicago');

        $new = array();

        //BASIC INFORMATION
        $_ID = "";
        //BASIC INFORMATION

        //ADVANCE INFORMATION
            //identification
                $_gender_aux = "";
                $_age_aux = "";
                $_birth_year_aux = "";
                $_generation = "";
                $_marital_status = "";
            //identification
            //financial information
                $_household_income = "";
                $_median_household_income = "";
                $_household_net_worth = "";
                $_median_household_net_worth = "";
                $_discretionary_income = "";
                $_credit_score_median = "";
                $_credit_score_range = "";
            //financial information
            //occupation
                $_occupation_category = "";
                $_occupation_type = "";
                $_occupation_detail = "";
            //occupation
            //miscellaneous
                $_voter = "";
                $_urbanicity = "";
            //miscellaneous
            //contact information
                $_mobile_phone = "";
                $_mobile_phone2 = "";
                $_mobile_phone3 = "";
                $_mobile_phone_dnc = "";
                $_mobile_phone_dnc2 = "";
                $_mobile_phone_dnc3 = "";
                $_tax_bill_mailing_address = "";
                $_tax_bill_mailing_city = "";
                $_tax_bill_mailing_county = "";
                $_tax_bill_mailing_fips = "";
                $_tax_bill_mailing_state = "";
                $_tax_bill_mailing_zip = "";
                $_tax_bill_mailing_zip4 = "";
            //contact information
            //household information
                $_num_adults_household= "";
                $_num_children_household = "";
                $_num_persons_household = "";
                $_child_aged_0_3_household = "";
                $_child_aged_4_6_household = "";
                $_child_aged_7_9_household = "";
                $_child_aged_10_12_household = "";
                $_child_aged_13_18_household = "";
                $_children_household = "";
            //household information
            //marketing indicators
                $_has_email = "";
                $_has_phone = "";
                $_magazine_subscriber = "";
                $_charity_interest = "";
                $_likely_charitable_donor = "";            
            //marketing indicators
            //house and real estate
                $_dwelling_type = "";
                $_home_owner = "";
                $_home_owner_ordinal = "";
                $_length_of_residence = "";
                $_home_price = "";
                $_home_value = "";
                $_median_home_value = "";
                $_living_sqft = "";
                $_year_built_original = "";
                $_year_built_range = "";
                $_lot_number = "";
                $_legal_description = "";
                $_land_sqft = "";
                $_garage_sqft = "";
                $_subdivision = "";
                $_zoning_code = "";
            //house and real estate
            //interest and affinities
                $_cooking = "";
                $_gardening = "";
                $_music = "";
                $_diy = "";
                $_books = "";
                $_travel_vacation = "";
                $_health_beauty_products = "";
                $_pet_owner = "";
                $_photography = "";
                $_fitness = "";
                $_epicurean = "";
            //interest and affinities
            //location and census data
                $_cbsa = "";
                $_census_block = "";
                $_census_block_group = "";
                $_census_tract = "";
            //location and census data
            //unregistered row
                $_aerobics = "";
                $_african_american_affinity = "";
                $_amex_card = "";
                $_antiques = "";
                $_apparel_accessory_affinity = "";
                $_apparel_affinity = "";
                $_arts_and_crafts = "";
                $_asian_affinity = "";
                $_auto_affinity = "";
                $_auto_racing_affinity = "";
                $_aviation_affinity = "";
                $_bank_card = "";
                $_bargain_hunter_affinity = "";
                $_baseball = "";
                $_baseball_affinity = "";
                $_basketball = "";
                $_basketball_affinity = "";
                $_beauty_affinity = "";
                $_bible_affinity = "";
                $_bird_watching = "";
                $_birds_affinity = "";
                $_blue_collar = "";
                $_boating_sailing = "";
                $_boating_sailing_affinity = "";
                $_business_affinity = "";
                $_camping_hiking = "";
                $_camping_hiking_climbing_affinity = "";
                $_cars_interest = "";
                $_cat_owner = "";
                $_catalog_affinity = "";
                $_cigars = "";
                $_classical_music = "";
                $_coins = "";
                $_collectibles_affinity = "";
                $_college_affinity = "";
                $_computers_affinity = "";
                $_continuity_program_affinity = "";
                $_cooking_affinity = "";
                $_cosmetics = "";
                $_country_music = "";
                $_crafts_affinity = "";
                $_credit_card = "";
                $_credit_repair_affinity = "";
                $_crochet_affinity = "";
                $_diet_affinity = "";
                $_dieting = "";
                $_do_it_yourself_affinity = "";
                $_dog_owner = "";
                $_doll_collector = "";
                $_donor_affinity = "";
                $_education = "";
                $_education_ordinal = "";
                $_education_seekers_affinity = "";
                $_ego_affinity = "";
                $_entertainment_interest = "";
                $_figurines_collector = "";
                $_fine_arts_collector = "";
                $_fishing = "";
                $_fishing_affinity = "";
                $_fitness_affinity = "";
                $_football = "";
                $_football_affinity = "";
                $_gambling = "";
                $_gambling_affinity = "";
                $_games_affinity = "";
                $_gardening_affinity = "";
                $_gender = "";
                $_generation_ordinal = "";
                $_golf = "";
                $_golf_affinity = "";
                $_gourmet_affinity = "";
                $_grandparents_affinity = "";
                $_health_affinity = "";
                $_healthy_living = "";
                $_healthy_living_interest = "";
                $_high_tech_affinity = "";
                $_hispanic_affinity = "";
                $_hockey = "";
                $_hockey_affinity = "";
                $_home_decor = "";
                $_home_improvement_interest = "";
                $_home_office_affinity = "";
                $_home_study = "";
                $_hunting = "";
                $_hunting_affinity = "";
                $_jazz = "";
                $_kids_apparel_affinity = "";
                $_knit_affinity = "";
                $_knitting_quilting_sewing = "";
                $_luxury_life = "";
                $_married = "";
                $_median_income = "";
                $_mens_apparel_affinity = "";
                $_mens_fashion_affinity = "";
                $_mortgage_age = "";
                $_mortgage_amount = "";
                $_mortgage_loan_type = "";
                $_mortgage_refi_age = "";
                $_mortgage_refi_amount = "";
                $_mortgage_refi_type = "";
                $_motor_racing = "";
                $_motorcycles = "";
                $_motorcycles_affinity = "";
                $_movies = "";
                $_nascar = "";
                $_needlepoint_affinity = "";
                $_new_credit_offered_household = "";
                $_num_credit_lines_household = "";
                $_num_generations_household = "";
                $_outdoors = "";
                $_outdoors_affinity = "";
                $_owns_investments = "";
                $_owns_mutual_funds = "";
                $_owns_stocks_and_bonds = "";
                $_owns_swimming_pool = "";
                $_personal_finance_affinity = "";
                $_personality = "";
                $_plates_collector = "";
                $_pop_density = "";
                $_premium_amex_card = "";
                $_premium_card = "";
                $_premium_income_household = "";
                $_premium_income_midpt_household = "";
                $_quilt_affinity = "";
                $_religious_music = "";
                $_rhythm_and_blues = "";
                $_rock_music = "";
                $_running = "";
                $_rv = "";
                $_scuba = "";
                $_self_improvement = "";
                $_sewing_affinity = "";
                $_single_family_dwelling = "";
                $_snow_skiing = "";
                $_snow_skiing_affinity = "";
                $_soccer = "";
                $_soccer_affinity = "";
                $_soft_rock = "";
                $_soho_business = "";
                $_sports_memoribilia_collector = "";
                $_stamps = "";
                $_sweepstakes_affinity = "";
                $_tennis = "";
                $_tennis_affinity = "";
                $_tobacco_affinity = "";
                $_travel_affinity = "";
                $_travel_cruise_affinity = "";
                $_travel_cruises = "";
                $_travel_personal = "";
                $_travel_rv_affinity = "";
                $_travel_us_affinity = "";
                $_truck_owner = "";
                $_trucks_affinity = "";
                $_tv_movies_affinity = "";
                $_veteran_household = "";
                $_walking = "";
                $_weight_lifting = "";
                $_wildlife_affinity = "";
                $_womens_apparel_affinity = "";
                $_womens_fashion_affinity = "";
                $_woodworking = "";
                $_male_aux = "";
                $_political_contributor_aux = "";
                $_political_party_aux = "";
                $_financial_power = "";
                $_mortgage_open_1st_intent = "";
                $_mortgage_open_2nd_intent = "";
                $_mortgage_new_intent = "";
                $_mortgage_refinance_intent = "";
                $_automotive_loan_intent = "";
                $_bank_card_intent = "";
                $_personal_loan_intent = "";
                $_retail_card_intent = "";
                $_student_loan_cons_intent = "";
                $_student_loan_intent = "";
                $_3qtr_baths = "";
                $_ac_type = "";
                $_acres = "";
                $_additions_square_feet = "";
                $_assess_val_impr = "";
                $_assess_val_lnd = "";
                $_assess_val_prop = "";
                $_bldg_style = "";
                $_bsmt_sqft = "";
                $_bsmt_type = "";
                $_build_sqft_assess = "";
                $_business = "";
                $_combined_statistical_area = "";
                $_metropolitan_division = "";
                $_middle = "";
                $_middle_2 = "";
                $_mkt_ip_perc = "";
                $_mobile_home = "";

                $_mrtg_due = "";
                $_mrtg_intrate = "";
                $_mrtg_refi = "";
                $_mrtg_term = "";
                $_mrtg_type = "";

                $_mrtg2_amt = "";
                $_mrtg2_date = "";
                $_mrtg2_deed_type = "";
                $_mrtg2_due = "";
                $_mrtg2_equity = "";
                $_mrtg2_intrate = "";
                $_mrtg2_inttype = "";
                $_mrtg2_refi = "";
                $_mrtg2_term = "";
                $_mrtg2_type = "";

                $_mrtg3_amt = "";
                $_mrtg3_date = "";
                $_mrtg3_deed_type = "";
                $_mrtg3_due = "";
                $_mrtg3_equity = "";
                $_mrtg3_inttype = "";
                $_mrtg3_refi = "";
                $_mrtg3_term = "";
                $_mrtg3_type = "";

                $_msa_code = "";
                $_number_bedrooms = "";
                $_number_bldgs = "";
                $_number_fireplace = "";
                $_number_park_spaces = "";
                $_number_rooms = "";
                $_own_biz = "";
                $_owner_occupied = "";
                $_ownership_relation = "";
                $_owner_type_description = "";
                $_estimated_value = "";
                $_ext_type = "";
                $_finish_square_feet2 = "";
                $_fireplace = "";
                $_first = "";
                $_first_2 = "";
                $_found_type = "";
                $_fr_feet = "";
                $_fuel_type = "";
                $_full_baths = "";
                $_half_baths = "";
                $_garage_type = "";
                $_grnd_sqft = "";
                $_heat_type = "";
                $_hmstd = "";
                $_impr_appr_val = "";
                $_imprval = "";
                $_imprval_type = "";
                $_land_appr_val = "";
                $_landval = "";
                $_landval_type = "";
                $_last = "";
                $_last_2 = "";
                $_lat = "";
                $_lender_name = "";
                $_lender2_name = "";
                $_lender3_name = "";
                $_loan_amt = "";
                $_loan_date = "";
                $_loan_to_val = "";
                $_lon = "";
                $_markval = "";
                $_markval_type = "";
                $_patio_porch = "";
                $_patio_square_feet = "";
                $_pool = "";
                $_porch_square_feet = "";
                $_previous_assessed_value = "";
                $_prop_type = "";
                $_rate_type = "";
                $_rec_date = "";
                $_roof_covtype = "";
                $_roof_shapetype = "";
                $_sale_amt = "";
                $_sale_amt_pr = "";
                $_sale_date = "";
                $_sale_type_pr = "";
                $_sales_type = "";
                $_sell_name = "";
                $_sewer_type = "";
                $_site_quality = "";
                $_std_address = "";
                $_std_city = "";
                $_std_state = "";
                $_std_zip = "";
                $_std_zip4 = "";
                $_stories_number = "";
                $_suffix = "";
                $_suffix_2 = "";
                $_tax_yr = "";
                $_tax_improvement_percent = "";
                $_title_co = "";
                $_tot_baths_est = "";
                $_ttl_appr_val = "";
                $_ttl_bld_sqft = "";
                $_ttl_tax = "";
                $_unit_number = "";
                $_vet_exempt = "";
                $_water_type = "";

            //unregistered row

        //ADVANCE INFORMATION

        $_Description = $dataflow . "dataAdvanceNotExistOnDBBDM|" . $failedRecordID;

        $trackBigBDM = "BDMADVANCEEXIST";

        Log::info("Start Check BigBDM MD5 Advance exist");
        $startBigbdmMD5Time = microtime(true);

        $bigBDM_MD5_advance = $this->bigBDM_MD5($md5param,$leadspeek_api_id,$leadspeektype,$is_advance);

        $endBigbdmMD5Time = microtime(true);

        // convert epochtime to date format ('Y-m-d H:i:s')
        $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        // convert epochtime to date format ('Y-m-d H:i:s')

        $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        $executionTimeList['bigBDM_MD5_advance'] = [
            'start_execution_time' => $startBigbdmMD5Date,
            'end_execution_time' => $endBigbdmMD5Date,
            'total_execution_time' => $totalBigbdmMD5Time,
        ];

        /** IF BIG BDM MD5 HAVE RESULT */
        if (count((array)$bigBDM_MD5_advance) > 0) {
            Log::info("BigBDM Have result");
            
            $trackBigBDM = $trackBigBDM . "->MD5AdvanceExist";
            /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
            /** REPORT ANALYTIC */

            foreach ($bigBDM_MD5_advance as $rd => $a) {

            //ADVANCE INFORMATION

                //identification
                    $_gender_aux = (isset($a[0]->Gender_aux))?$a[0]->Gender_aux:'';
                    $_age_aux = (isset($a[0]->Age_aux)) ? $a[0]->Age_aux : '';
                    $_birth_year_aux = (isset($a[0]->Birth_Year_aux)) ? $a[0]->Birth_Year_aux : '';
                    $_generation = (isset($a[0]->Generation)) ? $a[0]->Generation : '';
                    $_marital_status = (isset($a[0]->Marital_Status))?$a[0]->Marital_Status:'';
                //identification
                
                //financial information
                    $_household_income = (isset($a[0]->Income_HH))?$a[0]->Income_HH:'';
                    $_median_household_income = (isset($a[0]->Income_Midpts_HH))?$a[0]->Income_Midpts_HH:'';
                    $_household_net_worth = (isset($a[0]->Net_Worth_HH))?$a[0]->Net_Worth_HH:'';
                    $_median_household_net_worth = (isset($a[0]->Net_Worth_Midpt_HH))?$a[0]->Net_Worth_Midpt_HH:'';
                    $_discretionary_income = (isset($a[0]->Discretionary_Income)) ? $a[0]->Discretionary_Income : '';
                    $_credit_score_median = (isset($a[0]->Credit_Midpts)) ? $a[0]->Credit_Midpts : '';
                    $_credit_score_range = (isset($a[0]->Credit_Range)) ? $a[0]->Credit_Range : '';
                //financial information

                //occupation
                    $_occupation_category = (isset($a[0]->Occupation_Category)) ? $a[0]->Occupation_Category : '';
                    $_occupation_type =(isset($a[0]->Occupation_Type)) ? $a[0]->Occupation_Type : '';
                    $_occupation_detail = (isset($a[0]->Occupation_Detail)) ? $a[0]->Occupation_Detail : '';
                //occupation
                
                //miscellaneous
                    $_voter = (isset($a[0]->Voter)) ? $a[0]->Voter : '';
                    $_urbanicity = (isset($a[0]->Urbanicity)) ? $a[0]->Urbanicity : '';
                //miscellaneous

                //contact information

                    $_mobile_phone = (isset($a[0]->Mobile_Phone_1))?$a[0]->Mobile_Phone_1:'';
                    $_mobile_phone2 = (isset($a[0]->Mobile_Phone_2))?$a[0]->Mobile_Phone_2:'';
                    $_mobile_phone3 = (isset($a[0]->Mobile_Phone_3))?$a[0]->Mobile_Phone_3:'';
                    $_mobile_phone_dnc = (isset($a[0]->Mobile_Phone_1_DNC))?$a[0]->Mobile_Phone_1_DNC:'';
                    $_mobile_phone_dnc2 = (isset($a[0]->Mobile_Phone_2_DNC))?$a[0]->Mobile_Phone_2_DNC:'';
                    $_mobile_phone_dnc3 = (isset($a[0]->Mobile_Phone_3_DNC))?$a[0]->Mobile_Phone_3_DNC:'';

                    $_tax_bill_mailing_address = (isset($a[0]->TaxBillMailingAddress))?$a[0]->TaxBillMailingAddress:'';
                    $_tax_bill_mailing_city = (isset($a[0]->TaxBillMailingCity))?$a[0]->TaxBillMailingCity:'';
                    $_tax_bill_mailing_county = (isset($a[0]->TaxBillMailingCounty))?$a[0]->TaxBillMailingCounty:'';
                    $_tax_bill_mailing_fips = (isset($a[0]->TaxBillMailingFIPs))?$a[0]->TaxBillMailingFIPs:'';
                    $_tax_bill_mailing_state = (isset($a[0]->TaxBillMailingState))?$a[0]->TaxBillMailingState:'';
                    $_tax_bill_mailing_zip = (isset($a[0]->TaxBillMailingZip))?$a[0]->TaxBillMailingZip:'';
                    $_tax_bill_mailing_zip4 = (isset($a[0]->TaxBillMailingZip4))?$a[0]->TaxBillMailingZip4:'';
                //contact information

                //household information
                    $_num_adults_household= (isset($a[0]->Num_Adults_HH))?$a[0]->Num_Adults_HH:'';
                    $_num_children_household = (isset($a[0]->Num_Children_HH))?$a[0]->Num_Children_HH:'';
                    $_num_persons_household = (isset($a[0]->Num_Persons_HH))?$a[0]->Num_Persons_HH:'';
                    $_child_aged_0_3_household = (isset($a[0]->Child_Aged_0_3_HH))?$a[0]->Child_Aged_0_3_HH:'';
                    $_child_aged_4_6_household = (isset($a[0]->Child_Aged_4_6_HH))?$a[0]->Child_Aged_4_6_HH:'';
                    $_child_aged_7_9_household = (isset($a[0]->Child_Aged_7_9_HH))?$a[0]->Child_Aged_7_9_HH:'';
                    $_child_aged_10_12_household = (isset($a[0]->Child_Aged_10_12_HH))?$a[0]->Child_Aged_10_12_HH:'';
                    $_child_aged_13_18_household = (isset($a[0]->Child_Aged_13_18_HH))?$a[0]->Child_Aged_13_18_HH:'';
                    $_children_household = (isset($a[0]->Children_HH))?$a[0]->Children_HH:'';
                //household information

                //marketing indicators
                    $_has_email = (isset($a[0]->HasEmail))?$a[0]->HasEmail:'';
                    $_has_phone = (isset($a[0]->HasPhone))?$a[0]->HasPhone:'';
                    $_magazine_subscriber = (isset($a[0]->Magazine_Subscriber))?$a[0]->Magazine_Subscriber:'';
                    $_charity_interest = (isset($a[0]->Charity_Interest))?$a[0]->Charity_Interest:'';
                    $_likely_charitable_donor = (isset($a[0]->Likely_Charitable_Donor))?$a[0]->Likely_Charitable_Donor:'';     
                //marketing indicators

                //house and real estate
                    $_dwelling_type = (isset($a[0]->Dwelling_Type))?$a[0]->Dwelling_Type:'';     
                    $_home_owner = (isset($a[0]->Home_Owner))?$a[0]->Home_Owner:'';     
                    $_home_owner_ordinal = (isset($a[0]->Home_Owner_Ordinal))?$a[0]->Home_Owner_Ordinal:'';     
                    $_length_of_residence = (isset($a[0]->Length_of_Residence))?$a[0]->Length_of_Residence:'';     
                    $_home_price = (isset($a[0]->Home_Price))?$a[0]->Home_Price:'';     
                    $_home_value = (isset($a[0]->Home_Value))?$a[0]->Home_Value:'';     
                    $_median_home_value = (isset($a[0]->Median_Home_Value))?$a[0]->Median_Home_Value:'';  
                    $_living_sqft = (isset($a[0]->LIVING_SQFT))?$a[0]->LIVING_SQFT:'';  
                    $_year_built_original = (isset($a[0]->YR_BUILT_ORIG))?$a[0]->YR_BUILT_ORIG:'';  
                    $_year_built_range = (isset($a[0]->YR_BUILT_RANGE))?$a[0]->YR_BUILT_RANGE:'';  
                    $_lot_number = (isset($a[0]->LotNumber))?$a[0]->LotNumber:'';  
                    $_legal_description = (isset($a[0]->LegalDescription))?$a[0]->LegalDescription:'';  
                    $_land_sqft = (isset($a[0]->LAND_SQFT))?$a[0]->LAND_SQFT:'';  
                    $_garage_sqft = (isset($a[0]->GAR_SQFT))?$a[0]->GAR_SQFT:'';  
                    $_subdivision = (isset($a[0]->SUBDIVISION))?$a[0]->SUBDIVISION:'';  
                    $_zoning_code = (isset($a[0]->ZONING_CODE))?$a[0]->ZONING_CODE:'';  
                //house and real estate

                //interest and affinities
                    $_cooking = (isset($a[0]->Cooking))?$a[0]->Cooking:'';  
                    $_gardening = (isset($a[0]->Gardening))?$a[0]->Gardening:''; 
                    $_music = (isset($a[0]->Music))?$a[0]->Music:''; 
                    $_diy =  (isset($a[0]->DIY))?$a[0]->DIY:''; 
                    $_books = (isset($a[0]->Books))?$a[0]->Books:''; 
                    $_travel_vacation = (isset($a[0]->Travel_Vacation))?$a[0]->Travel_Vacation:''; 
                    $_health_beauty_products = (isset($a[0]->Health_Beauty_Products))?$a[0]->Health_Beauty_Products:''; 
                    $_pet_owner = (isset($a[0]->Pet_Owner))?$a[0]->Pet_Owner:''; 
                    $_photography = (isset($a[0]->Photography))?$a[0]->Photography:''; 
                    $_fitness = (isset($a[0]->Fitness))?$a[0]->Fitness:''; 
                    $_epicurean = (isset($a[0]->Epicurean))?$a[0]->Epicurean:''; 
                //interest and affinities

                //location and census data
                    $_cbsa = (isset($a[0]->Cbsa))?$a[0]->Cbsa:''; 
                    $_census_block = (isset($a[0]->Census_Block))?$a[0]->Census_Block:''; 
                    $_census_block_group = (isset($a[0]->Census_Block_Group))?$a[0]->Census_Block_Group:''; 
                    $_census_tract = (isset($a[0]->Census_Tract))?$a[0]->Census_Tract:''; 
                //location and census data

            //ADVANCE INFORMATION

            //unregistered row
                $_aerobics = (isset($a[0]->Aerobics)) ? $a[0]->Aerobics : '';
                $_african_american_affinity = (isset($a[0]->African_American_Affinity)) ? $a[0]->African_American_Affinity : '';
                $_amex_card = (isset($a[0]->AMEX_Card)) ? $a[0]->AMEX_Card : '';
                $_antiques = (isset($a[0]->Antiques)) ? $a[0]->Antiques : '';
                $_apparel_accessory_affinity = (isset($a[0]->Apparel_Accessory_Affinity)) ? $a[0]->Apparel_Accessory_Affinity : '';
                $_apparel_affinity = (isset($a[0]->Apparel_Affinity)) ? $a[0]->Apparel_Affinity : '';
                $_arts_and_crafts = (isset($a[0]->Arts_and_Crafts)) ? $a[0]->Arts_and_Crafts : '';
                $_asian_affinity = (isset($a[0]->Asian_Affinity)) ? $a[0]->Asian_Affinity : '';
                $_auto_affinity = (isset($a[0]->Auto_Affinity)) ? $a[0]->Auto_Affinity : '';
                $_auto_racing_affinity = (isset($a[0]->Auto_Racing_Affinity)) ? $a[0]->Auto_Racing_Affinity : '';
                $_aviation_affinity = (isset($a[0]->Aviation_Affinity)) ? $a[0]->Aviation_Affinity : '';
                $_bank_card = (isset($a[0]->Bank_Card)) ? $a[0]->Bank_Card : '';
                $_bargain_hunter_affinity = (isset($a[0]->Bargain_Hunter_Affinity)) ? $a[0]->Bargain_Hunter_Affinity : '';
                $_baseball = (isset($a[0]->Baseball)) ? $a[0]->Baseball : '';
                $_baseball_affinity = (isset($a[0]->Baseball_Affinity)) ? $a[0]->Baseball_Affinity : '';
                $_basketball = (isset($a[0]->Basketball)) ? $a[0]->Basketball : '';
                $_basketball_affinity = (isset($a[0]->Basketball_Affinity)) ? $a[0]->Basketball_Affinity : '';
                $_beauty_affinity = (isset($a[0]->Beauty_Affinity)) ? $a[0]->Beauty_Affinity : '';
                $_bible_affinity = (isset($a[0]->Bible_Affinity)) ? $a[0]->Bible_Affinity : '';
                $_bird_watching = (isset($a[0]->Bird_watching)) ? $a[0]->Bird_watching : '';
                $_birds_affinity = (isset($a[0]->Birds_Affinity)) ? $a[0]->Birds_Affinity : '';
                $_blue_collar = (isset($a[0]->Blue_Collar)) ? $a[0]->Blue_Collar : '';
                $_boating_sailing = (isset($a[0]->Boating_Sailing)) ? $a[0]->Boating_Sailing : '';
                $_boating_sailing_affinity = (isset($a[0]->Boating_Sailing_Affinity)) ? $a[0]->Boating_Sailing_Affinity : '';
                $_business_affinity = (isset($a[0]->Business_Affinity)) ? $a[0]->Business_Affinity : '';
                $_camping_hiking = (isset($a[0]->Camping_Hiking)) ? $a[0]->Camping_Hiking : '';
                $_camping_hiking_climbing_affinity = (isset($a[0]->Camping_Hiking_Climbing_Affinity)) ? $a[0]->Camping_Hiking_Climbing_Affinity : '';
                $_cars_interest = (isset($a[0]->Cars_Interest)) ? $a[0]->Cars_Interest : '';
                $_cat_owner = (isset($a[0]->Cat_Owner)) ? $a[0]->Cat_Owner : '';
                $_catalog_affinity = (isset($a[0]->Catalog_Affinity)) ? $a[0]->Catalog_Affinity : '';
                $_cigars = (isset($a[0]->Cigars)) ? $a[0]->Cigars : '';
                $_classical_music = (isset($a[0]->Classical_Music)) ? $a[0]->Classical_Music : '';
                $_coins = (isset($a[0]->Coins)) ? $a[0]->Coins : '';
                $_collectibles_affinity = (isset($a[0]->Collectibles_Affinity)) ? $a[0]->Collectibles_Affinity : '';
                $_college_affinity = (isset($a[0]->College_Affinity)) ? $a[0]->College_Affinity : '';
                $_computers_affinity = (isset($a[0]->Computers_Affinity)) ? $a[0]->Computers_Affinity : '';
                $_continuity_program_affinity = (isset($a[0]->Continuity_Program_Affinity)) ? $a[0]->Continuity_Program_Affinity : '';
                $_cooking_affinity = (isset($a[0]->Cooking_Affinity)) ? $a[0]->Cooking_Affinity : '';
                $_cosmetics = (isset($a[0]->Cosmetics)) ? $a[0]->Cosmetics : '';
                $_country_music = (isset($a[0]->Country_Music)) ? $a[0]->Country_Music : '';
                $_crafts_affinity = (isset($a[0]->Crafts_Affinity)) ? $a[0]->Crafts_Affinity : '';
                $_credit_card = (isset($a[0]->Credit_Card)) ? $a[0]->Credit_Card : '';
                $_credit_repair_affinity = (isset($a[0]->Credit_Repair_Affinity)) ? $a[0]->Credit_Repair_Affinity : '';
                $_crochet_affinity = (isset($a[0]->Crochet_Affinity)) ? $a[0]->Crochet_Affinity : '';
                $_diet_affinity = (isset($a[0]->Diet_Affinity)) ? $a[0]->Diet_Affinity : '';
                $_dieting = (isset($a[0]->Dieting)) ? $a[0]->Dieting : '';
                $_do_it_yourself_affinity = (isset($a[0]->Do_it_Yourself_Affinity)) ? $a[0]->Do_it_Yourself_Affinity : '';
                $_dog_owner = (isset($a[0]->Dog_Owner)) ? $a[0]->Dog_Owner : '';
                $_doll_collector = (isset($a[0]->Doll_Collector)) ? $a[0]->Doll_Collector : '';
                $_donor_affinity = (isset($a[0]->Donor_Affinity)) ? $a[0]->Donor_Affinity : '';
                $_education = (isset($a[0]->Education)) ? $a[0]->Education : '';
                $_education_ordinal = (isset($a[0]->Education_Ordinal)) ? $a[0]->Education_Ordinal : '';
                $_education_seekers_affinity = (isset($a[0]->Education_Seekers_Affinity)) ? $a[0]->Education_Seekers_Affinity : '';
                $_ego_affinity = (isset($a[0]->EGO_Affinity)) ? $a[0]->EGO_Affinity : '';
                $_entertainment_interest = (isset($a[0]->Entertainment_Interest)) ? $a[0]->Entertainment_Interest : '';
                $_figurines_collector = (isset($a[0]->Figurines_Collector)) ? $a[0]->Figurines_Collector : '';
                $_fine_arts_collector = (isset($a[0]->Fine_Arts_Collector)) ? $a[0]->Fine_Arts_Collector : '';
                $_fishing = (isset($a[0]->Fishing)) ? $a[0]->Fishing : '';
                $_fishing_affinity = (isset($a[0]->Fishing_Affinity)) ? $a[0]->Fishing_Affinity : '';
                $_football = (isset($a[0]->Football)) ? $a[0]->Football : '';
                $_football_affinity = (isset($a[0]->Football_Affinity)) ? $a[0]->Football_Affinity : '';
                $_gambling = (isset($a[0]->Gambling)) ? $a[0]->Gambling : '';
                $_gambling_affinity = (isset($a[0]->Gambling_Affinity)) ? $a[0]->Gambling_Affinity : '';
                $_games_affinity = (isset($a[0]->Games_Affinity)) ? $a[0]->Games_Affinity : '';
                $_gardening_affinity = (isset($a[0]->Gardening_Affinity)) ? $a[0]->Gardening_Affinity : '';
                $_generation_ordinal = (isset($a[0]->Generation_Ordinal)) ? $a[0]->Generation_Ordinal : '';
                $_golf = (isset($a[0]->Golf)) ? $a[0]->Golf : '';
                $_golf_affinity = (isset($a[0]->Golf_Affinity)) ? $a[0]->Golf_Affinity : '';
                $_gourmet_affinity = (isset($a[0]->Gourmet_Affinity)) ? $a[0]->Gourmet_Affinity : '';
                $_grandparents_affinity = (isset($a[0]->Grandparents_Affinity)) ? $a[0]->Grandparents_Affinity : '';
                $_health_affinity = (isset($a[0]->Health_Affinity)) ? $a[0]->Health_Affinity : '';
                $_healthy_living = (isset($a[0]->Healthy_Living)) ? $a[0]->Healthy_Living : '';
                $_healthy_living_interest = (isset($a[0]->Healthy_Living_Interest)) ? $a[0]->Healthy_Living_Interest : '';
                $_high_tech_affinity = (isset($a[0]->High_Tech_Affinity)) ? $a[0]->High_Tech_Affinity : '';
                $_hispanic_affinity = (isset($a[0]->Hispanic_Affinity)) ? $a[0]->Hispanic_Affinity : '';
                $_hockey = (isset($a[0]->Hockey)) ? $a[0]->Hockey : '';
                $_hockey_affinity = (isset($a[0]->Hockey_Affinity)) ? $a[0]->Hockey_Affinity : '';
                $_home_decor = (isset($a[0]->Home_Decor)) ? $a[0]->Home_Decor : '';
                $_home_improvement_interest = (isset($a[0]->Home_Improvement_Interest)) ? $a[0]->Home_Improvement_Interest : '';
                $_home_office_affinity = (isset($a[0]->Home_Office_Affinity)) ? $a[0]->Home_Office_Affinity : '';
                $_home_study = (isset($a[0]->Home_Study)) ? $a[0]->Home_Study : '';
                $_hunting = (isset($a[0]->Hunting)) ? $a[0]->Hunting : '';
                $_hunting_affinity = (isset($a[0]->Hunting_Affinity)) ? $a[0]->Hunting_Affinity : '';
                $_jazz = (isset($a[0]->Jazz)) ? $a[0]->Jazz : '';
                $_kids_apparel_affinity = (isset($a[0]->Kids_Apparel_Affinity)) ? $a[0]->Kids_Apparel_Affinity : '';
                $_knit_affinity = (isset($a[0]->Knit_Affinity)) ? $a[0]->Knit_Affinity : '';
                $_knitting_quilting_sewing = (isset($a[0]->Knitting_Quilting_Sewing)) ? $a[0]->Knitting_Quilting_Sewing : '';
                $_luxury_life = (isset($a[0]->Luxury_Life)) ? $a[0]->Luxury_Life : '';
                $_married = (isset($a[0]->Married)) ? $a[0]->Married : '';
                $_median_income = (isset($a[0]->Median_Income)) ? $a[0]->Median_Income : '';
                $_mens_apparel_affinity = (isset($a[0]->Mens_Apparel_Affinity)) ? $a[0]->Mens_Apparel_Affinity : '';
                $_mens_fashion_affinity = (isset($a[0]->Mens_Fashion_Affinity)) ? $a[0]->Mens_Fashion_Affinity : '';
                $_mortgage_age = (isset($a[0]->Mortgage_Age)) ? $a[0]->Mortgage_Age : '';
                $_mortgage_amount = (isset($a[0]->Mortgage_Amount)) ? $a[0]->Mortgage_Amount : '';
                $_mortgage_loan_type = (isset($a[0]->Mortgage_Loan_Type)) ? $a[0]->Mortgage_Loan_Type : '';
                $_mortgage_refi_age = (isset($a[0]->Mortgage_Refi_Age)) ? $a[0]->Mortgage_Refi_Age : '';
                $_mortgage_refi_amount = (isset($a[0]->Mortgage_Refi_Amount)) ? $a[0]->Mortgage_Refi_Amount : '';
                $_mortgage_refi_type = (isset($a[0]->Mortgage_Refi_Type)) ? $a[0]->Mortgage_Refi_Type : '';
                $_motor_racing = (isset($a[0]->Motor_Racing)) ? $a[0]->Motor_Racing : '';
                $_motorcycles = (isset($a[0]->Motorcycles)) ? $a[0]->Motorcycles : '';
                $_motorcycles_affinity = (isset($a[0]->Motorcycles_Affinity)) ? $a[0]->Motorcycles_Affinity : '';
                $_movies = (isset($a[0]->Movies)) ? $a[0]->Movies : '';
                $_nascar = (isset($a[0]->NASCAR)) ? $a[0]->NASCAR : '';
                $_needlepoint_affinity = (isset($a[0]->Needlepoint_Affinity)) ? $a[0]->Needlepoint_Affinity : '';
                $_new_credit_offered_household = (isset($a[0]->New_Credit_Offered_HH)) ? $a[0]->New_Credit_Offered_HH : '';
                $_num_credit_lines_household = (isset($a[0]->Num_Credit_Lines_HH)) ? $a[0]->Num_Credit_Lines_HH : '';
                $_num_generations_household = (isset($a[0]->Num_Generations_HH)) ? $a[0]->Num_Generations_HH : '';
                $_outdoors = (isset($a[0]->Outdoors)) ? $a[0]->Outdoors : '';
                $_outdoors_affinity = (isset($a[0]->Outdoors_Affinity)) ? $a[0]->Outdoors_Affinity : '';
                $_owns_investments = (isset($a[0]->Owns_Investments)) ? $a[0]->Owns_Investments : '';
                $_owns_mutual_funds = (isset($a[0]->Owns_Mutual_Funds)) ? $a[0]->Owns_Mutual_Funds : '';
                $_owns_stocks_and_bonds = (isset($a[0]->Owns_Stocks_And_Bonds)) ? $a[0]->Owns_Stocks_And_Bonds : '';
                $_owns_swimming_pool = (isset($a[0]->Owns_Swimming_Pool)) ? $a[0]->Owns_Swimming_Pool : '';
                $_personal_finance_affinity = (isset($a[0]->Personal_Finance_Affinity)) ? $a[0]->Personal_Finance_Affinity : '';
                $_personality = (isset($a[0]->Personality)) ? $a[0]->Personality : '';
                $_plates_collector = (isset($a[0]->Plates_Collector)) ? $a[0]->Plates_Collector : '';
                $_pop_density = (isset($a[0]->Pop_Density)) ? $a[0]->Pop_Density : '';
                $_premium_amex_card = (isset($a[0]->Premium_AMEX_Card)) ? $a[0]->Premium_AMEX_Card : '';
                $_premium_card = (isset($a[0]->Premium_Card)) ? $a[0]->Premium_Card : '';
                $_premium_income_household = (isset($a[0]->Premium_Income_HH)) ? $a[0]->Premium_Income_HH : '';
                $_premium_income_midpt_household = (isset($a[0]->Premium_Income_Midpt_HH)) ? $a[0]->Premium_Income_Midpt_HH : '';
                $_quilt_affinity = (isset($a[0]->Quilt_Affinity)) ? $a[0]->Quilt_Affinity : '';
                $_religious_music = (isset($a[0]->Religious_Music)) ? $a[0]->Religious_Music : '';
                $_rhythm_and_blues = (isset($a[0]->Rhythm_and_Blues)) ? $a[0]->Rhythm_and_Blues : '';
                $_rock_music = (isset($a[0]->Rock_Music)) ? $a[0]->Rock_Music : '';
                $_running = (isset($a[0]->Running)) ? $a[0]->Running : '';
                $_rv = (isset($a[0]->RV)) ? $a[0]->RV : '';
                $_scuba = (isset($a[0]->Scuba)) ? $a[0]->Scuba : '';
                $_self_improvement = (isset($a[0]->Self_Improvement)) ? $a[0]->Self_Improvement : '';
                $_sewing_affinity = (isset($a[0]->Sewing_Affinity)) ? $a[0]->Sewing_Affinity : '';
                $_single_family_dwelling = (isset($a[0]->Single_Family_Dwelling)) ? $a[0]->Single_Family_Dwelling : '';
                $_snow_skiing = (isset($a[0]->Snow_Skiing)) ? $a[0]->Snow_Skiing : '';
                $_snow_skiing_affinity = (isset($a[0]->Snow_Skiing_Affinity)) ? $a[0]->Snow_Skiing_Affinity : '';
                $_soccer = (isset($a[0]->Soccer)) ? $a[0]->Soccer : '';
                $_soccer_affinity = (isset($a[0]->Soccer_Affinity)) ? $a[0]->Soccer_Affinity : '';
                $_soft_rock = (isset($a[0]->Soft_Rock)) ? $a[0]->Soft_Rock : '';
                $_soho_business = (isset($a[0]->SOHO_Business)) ? $a[0]->SOHO_Business : '';
                $_sports_memoribilia_collector = (isset($a[0]->Sports_Memoribilia_Collector)) ? $a[0]->Sports_Memoribilia_Collector : '';
                $_stamps = (isset($a[0]->Stamps)) ? $a[0]->Stamps : '';
                $_sweepstakes_affinity = (isset($a[0]->Sweepstakes_Affinity)) ? $a[0]->Sweepstakes_Affinity : '';
                $_tennis = (isset($a[0]->Tennis)) ? $a[0]->Tennis : '';
                $_tennis_affinity = (isset($a[0]->Tennis_Affinity)) ? $a[0]->Tennis_Affinity : '';
                $_tobacco_affinity = (isset($a[0]->Tobacco_Affinity)) ? $a[0]->Tobacco_Affinity : '';
                $_travel_affinity = (isset($a[0]->Travel_Affinity)) ? $a[0]->Travel_Affinity : '';
                $_travel_cruise_affinity = (isset($a[0]->Travel_Cruise_Affinity)) ? $a[0]->Travel_Cruise_Affinity : '';
                $_travel_cruises = (isset($a[0]->Travel_Cruises)) ? $a[0]->Travel_Cruises : '';
                $_travel_personal = (isset($a[0]->Travel_Personal)) ? $a[0]->Travel_Personal : '';
                $_travel_rv_affinity = (isset($a[0]->Travel_RV_Affinity)) ? $a[0]->Travel_RV_Affinity : '';
                $_travel_us_affinity = (isset($a[0]->Travel_US_Affinity)) ? $a[0]->Travel_US_Affinity : '';
                $_truck_owner = (isset($a[0]->Truck_Owner)) ? $a[0]->Truck_Owner : '';
                $_trucks_affinity = (isset($a[0]->Trucks_Affinity)) ? $a[0]->Trucks_Affinity : '';
                $_tv_movies_affinity = (isset($a[0]->TV_Movies_Affinity)) ? $a[0]->TV_Movies_Affinity : '';
                $_veteran_household = (isset($a[0]->Veteran_HH)) ? $a[0]->Veteran_HH : '';
                $_walking = (isset($a[0]->Walking)) ? $a[0]->Walking : '';
                $_weight_lifting = (isset($a[0]->Weight_Lifting)) ? $a[0]->Weight_Lifting : '';
                $_wildlife_affinity = (isset($a[0]->Wildlife_Affinity)) ? $a[0]->Wildlife_Affinity : '';
                $_womens_apparel_affinity = (isset($a[0]->Womens_Apparel_Affinity)) ? $a[0]->Womens_Apparel_Affinity : '';
                $_womens_fashion_affinity = (isset($a[0]->Womens_Fashion_Affinity)) ? $a[0]->Womens_Fashion_Affinity : '';
                $_woodworking = (isset($a[0]->Woodworking)) ? $a[0]->Woodworking : '';
                $_gender = (isset($a[0]->Gender)) ? $a[0]->Gender : '';
                $_male_aux = (isset($a[0]->Male_aux)) ? $a[0]->Male_aux : '';
                $_political_contributor_aux = (isset($a[0]->Political_Contributor_aux)) ? $a[0]->Political_Contributor_aux : '';
                $_political_party_aux = (isset($a[0]->Political_Party_aux)) ? $a[0]->Political_Party_aux : '';
                $_financial_power = (isset($a[0]->Financial_Power)) ? $a[0]->Financial_Power : '';
                $_mortgage_open_1st_intent = (isset($a[0]->Mortgage_Open1st_Intent)) ? $a[0]->Mortgage_Open1st_Intent : '';
                $_mortgage_open_2nd_intent = (isset($a[0]->Mortgage_Open2nd_Intent)) ? $a[0]->Mortgage_Open2nd_Intent : '';
                $_mortgage_new_intent = (isset($a[0]->Mortgage_New_Intent)) ? $a[0]->Mortgage_New_Intent : '';
                $_mortgage_refinance_intent = (isset($a[0]->Mortgage_Refinance_Intent)) ? $a[0]->Mortgage_Refinance_Intent : '';
                $_automotive_loan_intent = (isset($a[0]->Automotive_Loan_Intent)) ? $a[0]->Automotive_Loan_Intent : '';
                $_bank_card_intent = (isset($a[0]->Bank_Card_Intent)) ? $a[0]->Bank_Card_Intent : '';
                $_personal_loan_intent = (isset($a[0]->Personal_Loan_Intent)) ? $a[0]->Personal_Loan_Intent : '';
                $_retail_card_intent = (isset($a[0]->Retail_Card_Intent)) ? $a[0]->Retail_Card_Intent : '';
                $_student_loan_cons_intent = (isset($a[0]->Student_Loan_Cons_Intent)) ? $a[0]->Student_Loan_Cons_Intent : '';
                $_student_loan_intent = (isset($a[0]->Student_Loan_Intent)) ? $a[0]->Student_Loan_Intent : '';
                $_3qtr_baths = (isset($a[0]) && property_exists($a[0], '3QTR_BATHS')) ? $a[0]->{'3QTR_BATHS'} : '';
                $_ac_type = (isset($a[0]->AC_TYPE)) ? $a[0]->AC_TYPE : '';
                $_acres = (isset($a[0]->ACRES)) ? $a[0]->ACRES : '';
                $_additions_square_feet = (isset($a[0]->AdditionsSquareFeet)) ? $a[0]->AdditionsSquareFeet : '';
                $_assess_val_impr = (isset($a[0]->ASSESS_VAL_IMPR)) ? $a[0]->ASSESS_VAL_IMPR : '';
                $_assess_val_lnd = (isset($a[0]->ASSESS_VAL_LND)) ? $a[0]->ASSESS_VAL_LND : '';
                $_assess_val_prop = (isset($a[0]->ASSESS_VAL_PROP)) ? $a[0]->ASSESS_VAL_PROP : '';
                $_bldg_style = (isset($a[0]->BLDG_STYLE)) ? $a[0]->BLDG_STYLE : '';
                $_bsmt_sqft = (isset($a[0]->BSMT_SQFT)) ? $a[0]->BSMT_SQFT : '';
                $_bsmt_type = (isset($a[0]->BSMT_TYPE)) ? $a[0]->BSMT_TYPE : '';
                $_build_sqft_assess = (isset($a[0]->BUILD_SQFT_ASSESS)) ? $a[0]->BUILD_SQFT_ASSESS : '';
                $_business = (isset($a[0]->BUSINESS)) ? $a[0]->BUSINESS : '';
                $_combined_statistical_area = (isset($a[0]->CombinedStatisticalArea)) ? $a[0]->CombinedStatisticalArea : '';
                $_metropolitan_division = (isset($a[0]->MetropolitanDivision)) ? $a[0]->MetropolitanDivision : '';
                $_middle = (isset($a[0]->MIDDLE)) ? $a[0]->MIDDLE : '';
                $_middle_2 = (isset($a[0]->MIDDLE2)) ? $a[0]->MIDDLE2 : '';
                $_mkt_ip_perc = (isset($a[0]->Mkt_Ip_Perc)) ? $a[0]->Mkt_Ip_Perc : '';
                $_mobile_home = (isset($a[0]->MOBILE_HOME)) ? $a[0]->MOBILE_HOME : '';
                $_mrtg_due = (isset($a[0]->MRTG_DUE)) ? $a[0]->MRTG_DUE : '';
                $_mrtg_intrate = (isset($a[0]->MRTG_INTRATE)) ? $a[0]->MRTG_INTRATE : '';
                $_mrtg_refi = (isset($a[0]->MRTG_REFI)) ? $a[0]->MRTG_REFI : '';
                $_mrtg_term = (isset($a[0]->MRTG_TERM)) ? $a[0]->MRTG_TERM : '';
                $_mrtg_type = (isset($a[0]->MRTG_TYPE)) ? $a[0]->MRTG_TYPE : '';
                $_mrtg2_amt = (isset($a[0]->MRTG2_AMT)) ? $a[0]->MRTG2_AMT : '';
                $_mrtg2_date = (isset($a[0]->MRTG2_DATE)) ? $a[0]->MRTG2_DATE : '';
                $_mrtg2_deed_type = (isset($a[0]->MRTG2_DEED_TYPE)) ? $a[0]->MRTG2_DEED_TYPE : '';
                $_mrtg2_due = (isset($a[0]->MRTG2_DUE)) ? $a[0]->MRTG2_DUE : '';
                $_mrtg2_equity = (isset($a[0]->MRTG2_EQUITY)) ? $a[0]->MRTG2_EQUITY : '';
                $_mrtg2_intrate = (isset($a[0]->MRTG2_INTRATE)) ? $a[0]->MRTG2_INTRATE : '';
                $_mrtg2_inttype = (isset($a[0]->MRTG2_INTTYPE)) ? $a[0]->MRTG2_INTTYPE : '';
                $_mrtg2_refi = (isset($a[0]->MRTG2_REFI)) ? $a[0]->MRTG2_REFI : '';
                $_mrtg2_term = (isset($a[0]->MRTG2_TERM)) ? $a[0]->MRTG2_TERM : '';
                $_mrtg2_type = (isset($a[0]->MRTG2_TYPE)) ? $a[0]->MRTG2_TYPE : '';
                $_mrtg3_amt = (isset($a[0]->MRTG3_AMT)) ? $a[0]->MRTG3_AMT : '';
                $_mrtg3_date = (isset($a[0]->MRTG3_DATE)) ? $a[0]->MRTG3_DATE : '';
                $_mrtg3_deed_type = (isset($a[0]->MRTG3_DEED_TYPE)) ? $a[0]->MRTG3_DEED_TYPE : '';
                $_mrtg3_due = (isset($a[0]->MRTG3_DUE)) ? $a[0]->MRTG3_DUE : '';
                $_mrtg3_equity = (isset($a[0]->MRTG3_EQUITY)) ? $a[0]->MRTG3_EQUITY : '';
                $_mrtg3_inttype = (isset($a[0]->MRTG3_INTTYPE)) ? $a[0]->MRTG3_INTTYPE : '';
                $_mrtg3_refi = (isset($a[0]->MRTG3_REFI)) ? $a[0]->MRTG3_REFI : '';
                $_mrtg3_term = (isset($a[0]->MRTG3_TERM)) ? $a[0]->MRTG3_TERM : '';
                $_mrtg3_type = (isset($a[0]->MRTG3_TYPE)) ? $a[0]->MRTG3_TYPE : '';
                $_msa_code = (isset($a[0]->MSACode)) ? $a[0]->MSACode : '';
                $_number_bedrooms = (isset($a[0]->NMBR_BEDROOMS)) ? $a[0]->NMBR_BEDROOMS : '';
                $_number_bldgs = (isset($a[0]->NMBR_BLDGS)) ? $a[0]->NMBR_BLDGS : '';
                $_number_fireplace = (isset($a[0]->NMBR_FIREPLACE)) ? $a[0]->NMBR_FIREPLACE : '';
                $_number_park_spaces = (isset($a[0]->NMBR_PARK_SPACES)) ? $a[0]->NMBR_PARK_SPACES : '';
                $_number_rooms = (isset($a[0]->number_rooms)) ? $a[0]->number_rooms : '';
                $_own_biz = (isset($a[0]->OWN_BIZ)) ? $a[0]->OWN_BIZ : '';
                $_owner_occupied = (isset($a[0]->OWNER_OCCUPIED)) ? $a[0]->OWNER_OCCUPIED : '';
                $_ownership_relation = (isset($a[0]->OwnershipRelation)) ? $a[0]->OwnershipRelation : '';
                $_owner_type_description = (isset($a[0]->OwnerTypeDescription)) ? $a[0]->OwnerTypeDescription : '';
                $_estimated_value = (isset($a[0]->EstimatedValue)) ? $a[0]->EstimatedValue : '';
                $_ext_type = (isset($a[0]->EXT_TYPE)) ? $a[0]->EXT_TYPE : '';
                $_finish_square_feet2 = (isset($a[0]->FinishSquareFeet2)) ? $a[0]->FinishSquareFeet2 : '';
                $_fireplace = (isset($a[0]->fireplace)) ? $a[0]->fireplace : '';
                $_first = (isset($a[0]->FIRST)) ? $a[0]->FIRST : '';
                $_first_2 = (isset($a[0]->FIRST2)) ? $a[0]->FIRST2 : '';
                $_found_type = (isset($a[0]->FOUND_TYPE)) ? $a[0]->FOUND_TYPE : '';
                $_fr_feet = (isset($a[0]->FR_FEET)) ? $a[0]->FR_FEET : '';
                $_fuel_type = (isset($a[0]->FUEL_TYPE)) ? $a[0]->FUEL_TYPE : '';
                $_full_baths = (isset($a[0]->FULL_BATHS)) ? $a[0]->FULL_BATHS : '';
                $_half_baths = (isset($a[0]->HALF_BATHS)) ? $a[0]->HALF_BATHS : '';
                $_garage_type = (isset($a[0]->GAR_TYPE)) ? $a[0]->GAR_TYPE : '';
                $_grnd_sqft = (isset($a[0]->GRND_SQFT)) ? $a[0]->GRND_SQFT : '';
                $_heat_type = (isset($a[0]->HEAT_TYPE)) ? $a[0]->HEAT_TYPE : '';
                $_hmstd = (isset($a[0]->HMSTD)) ? $a[0]->HMSTD : '';
                $_impr_appr_val = (isset($a[0]->IMPR_APPR_VAL)) ? $a[0]->IMPR_APPR_VAL : '';
                $_imprval = (isset($a[0]->IMPRVAL)) ? $a[0]->IMPRVAL : '';
                $_imprval_type = (isset($a[0]->IMPRVAL_TYPE)) ? $a[0]->IMPRVAL_TYPE : '';
                $_land_appr_val = (isset($a[0]->LAND_APPR_VAL)) ? $a[0]->LAND_APPR_VAL : '';
                $_landval = (isset($a[0]->LANDVAL)) ? $a[0]->LANDVAL : '';
                $_landval_type = (isset($a[0]->LANDVAL_TYPE)) ? $a[0]->LANDVAL_TYPE : '';
                $_last = (isset($a[0]->LAST)) ? $a[0]->LAST : '';
                $_last_2 = (isset($a[0]->LAST2)) ? $a[0]->LAST2 : '';
                $_lat = (isset($a[0]->LAT)) ? $a[0]->LAT : '';
                $_lender_name = (isset($a[0]->LENDER_NAME)) ? $a[0]->LENDER_NAME : '';
                $_lender2_name = (isset($a[0]->LENDER2_NAME)) ? $a[0]->LENDER2_NAME : '';
                $_lender3_name = (isset($a[0]->LENDER3_NAME)) ? $a[0]->LENDER3_NAME : '';
                $_loan_amt = (isset($a[0]->LOAN_AMT)) ? $a[0]->LOAN_AMT : '';
                $_loan_date = (isset($a[0]->LOAN_DATE)) ? $a[0]->LOAN_DATE : '';
                $_loan_to_val = (isset($a[0]->LOAN_TO_VAL)) ? $a[0]->LOAN_TO_VAL : '';
                $_lon = (isset($a[0]->LON)) ? $a[0]->LON : '';
                $_markval = (isset($a[0]->MARKVAL)) ? $a[0]->MARKVAL : '';
                $_markval_type = (isset($a[0]->MARKVAL_TYPE)) ? $a[0]->MARKVAL_TYPE : '';
                $_patio_porch = (isset($a[0]->PatioPorch)) ? $a[0]->PatioPorch : '';
                $_patio_square_feet = (isset($a[0]->PatioSquareFeet)) ? $a[0]->PatioSquareFeet : '';
                $_pool = (isset($a[0]->POOL)) ? $a[0]->POOL : '';
                $_porch_square_feet = (isset($a[0]->PorchSquareFeet)) ? $a[0]->PorchSquareFeet : '';
                $_previous_assessed_value = (isset($a[0]->PreviousAssessedValue)) ? $a[0]->PreviousAssessedValue : '';
                $_prop_type = (isset($a[0]->PROP_TYPE)) ? $a[0]->PROP_TYPE : '';
                $_rate_type = (isset($a[0]->RATE_TYPE)) ? $a[0]->RATE_TYPE : '';
                $_rec_date = (isset($a[0]->REC_DATE)) ? $a[0]->REC_DATE : '';
                $_roof_covtype = (isset($a[0]->ROOF_COVTYPE)) ? $a[0]->ROOF_COVTYPE : '';
                $_roof_shapetype = (isset($a[0]->ROOF_SHAPETYPE)) ? $a[0]->ROOF_SHAPETYPE : '';
                $_sale_amt = (isset($a[0]->SALE_AMT)) ? $a[0]->SALE_AMT : '';
                $_sale_amt_pr = (isset($a[0]->SALE_AMT_PR)) ? $a[0]->SALE_AMT_PR : '';
                $_sale_date = (isset($a[0]->SALE_DATE)) ? $a[0]->SALE_DATE : '';
                $_sale_type_pr = (isset($a[0]->SALE_TYPE_PR)) ? $a[0]->SALE_TYPE_PR : '';
                $_sales_type = (isset($a[0]->SALES_TYPE)) ? $a[0]->SALES_TYPE : '';
                $_sell_name = (isset($a[0]->SELL_NAME)) ? $a[0]->SELL_NAME : '';
                $_sewer_type = (isset($a[0]->SEWER_TYPE)) ? $a[0]->SEWER_TYPE : '';
                $_site_quality = (isset($a[0]->SITE_QUALITY)) ? $a[0]->SITE_QUALITY : '';
                $_std_address = (isset($a[0]->STD_ADDRESS)) ? $a[0]->STD_ADDRESS : '';
                $_std_city = (isset($a[0]->STD_CITY)) ? $a[0]->STD_CITY : '';
                $_std_state = (isset($a[0]->STD_STATE)) ? $a[0]->STD_STATE : '';
                $_std_zip = (isset($a[0]->STD_ZIP)) ? $a[0]->STD_ZIP : '';
                $_std_zip4 = (isset($a[0]->STD_ZIP4)) ? $a[0]->STD_ZIP4 : '';
                $_stories_number = (isset($a[0]->STORIES_NMBR)) ? $a[0]->STORIES_NMBR : '';
                $_suffix = (isset($a[0]->SUFFIX)) ? $a[0]->SUFFIX : '';
                $_suffix_2 = (isset($a[0]->SUFFIX2)) ? $a[0]->SUFFIX2 : '';
                $_tax_yr = (isset($a[0]->TAX_YR)) ? $a[0]->TAX_YR : '';
                $_tax_improvement_percent = (isset($a[0]->TaxImprovementPercent)) ? $a[0]->TaxImprovementPercent : '';
                $_title_co = (isset($a[0]->TITLE_CO)) ? $a[0]->TITLE_CO : '';
                $_tot_baths_est = (isset($a[0]->TOT_BATHS_EST)) ? $a[0]->TOT_BATHS_EST : '';
                $_ttl_appr_val = (isset($a[0]->TTL_APPR_VAL)) ? $a[0]->TTL_APPR_VAL : '';
                $_ttl_bld_sqft = (isset($a[0]->TTL_BLD_SQFT)) ? $a[0]->TTL_BLD_SQFT : '';
                $_ttl_tax = (isset($a[0]->TTL_TAX)) ? $a[0]->TTL_TAX : '';
                $_unit_number = (isset($a[0]->UNIT_NMBR)) ? $a[0]->UNIT_NMBR : '';
                $_vet_exempt = (isset($a[0]->VET_EXEMPT)) ? $a[0]->VET_EXEMPT : '';
                $_water_type = (isset($a[0]->WATER_TYPE)) ? $a[0]->WATER_TYPE : '';
    
            //unregistered row
            }

            //INSERT PERSON ADVANCE 1 
            $newpersonadvance1 = PersonAdvance::create([
                'person_id' => $newPersonID,
                'gender_aux' => $_gender_aux,
                'gender' => $_gender,
                'age_aux' => $_age_aux,
                'birth_year_aux' => $_birth_year_aux,
                'generation' => $_generation,
                'marital_status' => $_marital_status,
                'income_household' => $_household_income,
                'income_midpts_household' => $_median_household_income,
                'net_worth_household' => $_household_net_worth,
                'net_worth_midpt_household' => $_median_household_net_worth,
                'discretionary_income' => $_discretionary_income,
                'credit_midpts' => $_credit_score_median,
                'credit_range' => $_credit_score_range,
                'occupation_category' => $_occupation_category,
                'occupation_detail' => $_occupation_detail,
                'occupation_type' => $_occupation_type,
                'voter' => $_voter,
                'urbanicity' => $_urbanicity,
                'mobile_phone_1' => $_mobile_phone,
                'mobile_phone_2' => $_mobile_phone2,
                'mobile_phone_3' => $_mobile_phone3,
                'mobile_phone_1_dnc' => $_mobile_phone_dnc,
                'mobile_phone_2_dnc' => $_mobile_phone_dnc2,
                'mobile_phone_3_dnc' => $_mobile_phone_dnc3,
                'tax_bill_mailing_address' => $_tax_bill_mailing_address,
                'tax_bill_mailing_city' => $_tax_bill_mailing_city,
                'tax_bill_mailing_county' => $_tax_bill_mailing_county,
                'tax_bill_mailing_fips' => $_tax_bill_mailing_fips,
                'tax_bill_mailing_state' => $_tax_bill_mailing_state,
                'tax_bill_mailing_zip' => $_tax_bill_mailing_zip,
                'tax_bill_mailing_zip4' => $_tax_bill_mailing_zip4,
                'num_adults_household' => $_num_adults_household,
                'num_children_household' => $_num_children_household,
                'num_persons_household' => $_num_persons_household,
                'child_aged_0_3_household' => $_child_aged_0_3_household,
                'child_aged_4_6_household' => $_child_aged_4_6_household,
                'child_aged_7_9_household' => $_child_aged_7_9_household,
                'child_aged_10_12_household' => $_child_aged_10_12_household,
                'child_aged_13_18_household' => $_child_aged_13_18_household,
                'children_household' => $_children_household,
                'has_email' => $_has_email,
                'has_phone' => $_has_phone,
                'magazine_subscriber' => $_magazine_subscriber,
                'charity_interest' => $_charity_interest,
                'likely_charitable_donor' => $_likely_charitable_donor,
                'donor_affinity' => $_donor_affinity,
                'dwelling_type' => $_dwelling_type,
                'home_owner' => $_home_owner,
                'home_owner_ordinal' => $_home_owner_ordinal,
                'length_of_residence' => $_length_of_residence,
                'home_price' => $_home_price,
                'home_value' => $_home_value,
                'median_home_value' => $_median_home_value,
                'living_sqft' => $_living_sqft,
                'yr_built_orig' => $_year_built_original,
                'yr_built_range' => $_year_built_range,
                'lot_number' => $_lot_number,
                'legal_description' => $_legal_description,
                'land_sqft' => $_land_sqft,
                'garage_sqft' => $_garage_sqft,
                'subdivision' => $_subdivision,
                'zoning_code' => $_zoning_code,
                'cooking' => $_cooking,
                'gardening' => $_gardening,
                'music' => $_music,
                'diy' => $_diy,
                'books' => $_books,
                'travel_vacation' => $_travel_vacation,
                'health_beauty_products' => $_health_beauty_products,
                'pet_owner' => $_pet_owner,
                'photography' => $_photography,
                'fitness' => $_fitness,
                'epicurean' => $_epicurean,
                'cbsa' => $_cbsa,
                'census_block' => $_census_block,
                'census_block_group' => $_census_block_group,
                'census_tract' => $_census_tract,
                
                'aerobics' => $_aerobics,
                'african_american_affinity' => $_african_american_affinity ,
                'amex_card' => $_amex_card,
                'antiques' => $_antiques,
                'apparel_accessory_affinity' => $_apparel_accessory_affinity,
                'apparel_affinity' => $_apparel_affinity,
                'arts_and_crafts' => $_arts_and_crafts,
                'asian_affinity' => $_asian_affinity,
                'auto_affinity' => $_auto_affinity,
                'auto_racing_affinity' => $_auto_racing_affinity,
                'aviation_affinity' => $_aviation_affinity,
                'bank_card' => $_bank_card,
                'bargain_hunter_affinity' => $_bargain_hunter_affinity,
                'baseball' => $_baseball,
                'baseball_affinity' => $_baseball_affinity,
                'basketball' => $_basketball,
                'basketball_affinity' => $_basketball_affinity,
                'beauty_affinity' => $_beauty_affinity,
                'bible_affinity' => $_bible_affinity,
                'bird_watching' => $_bird_watching,
                'birds_affinity' => $_birds_affinity,
                'blue_collar' => $_blue_collar,
                'boating_sailing' => $_boating_sailing,
                'boating_sailing_affinity' => $_boating_sailing_affinity,
                'business_affinity' => $_business_affinity,
                'camping_hiking' => $_camping_hiking,
                'camping_hiking_climbing_affinity' => $_camping_hiking_climbing_affinity,
                'cars_interest' => $_cars_interest,
                'cat_owner' => $_cat_owner,
                'catalog_affinity' => $_catalog_affinity,
                'cigars' => $_cigars,
                'classical_music' => $_classical_music,
                'coins' => $_coins,
                'collectibles_affinity' => $_collectibles_affinity,
                'college_affinity' => $_college_affinity,
                'computers_affinity' => $_computers_affinity,
                'continuity_program_affinity' => $_continuity_program_affinity,
                'cooking_affinity' => $_cooking_affinity,
                'cosmetics' => $_cosmetics,
                'country_music' => $_country_music,
                'crafts_affinity' => $_crafts_affinity,
                'credit_card' => $_credit_card,
                'credit_repair_affinity' => $_credit_repair_affinity,
                'crochet_affinity' => $_crochet_affinity,
            ]);
            //INSERT PERSON ADVANCE 1

            //INSERT PERSON ADVANCE 2
            $newpersonadvance2 = PersonAdvance2::create([
                'person_id' => $newPersonID,
                'diet_affinity' => $_diet_affinity,
                'dieting' => $_dieting,
                'do_it_yourself_affinity' => $_do_it_yourself_affinity,
                'dog_owner' => $_dog_owner,
                'doll_collector' => $_doll_collector,
                'education' => $_education,
                'education_ordinal' => $_education_ordinal,
                'education_seekers_affinity' => $_education_seekers_affinity,
                'ego_affinity' => $_ego_affinity,
                'entertainment_interest' => $_entertainment_interest,
                'figurines_collector' => $_figurines_collector,
                'fine_arts_collector' => $_fine_arts_collector,
                'fishing' => $_fishing,
                'fishing_affinity' => $_fishing_affinity,
                'fitness_affinity' => $_fitness_affinity,
                'football' => $_football,
                'football_affinity' => $_football_affinity,
                'gambling' => $_gambling,
                'gambling_affinity' => $_gambling_affinity,
                'games_affinity' => $_games_affinity,
                'gardening_affinity' => $_gardening_affinity,
                'generation_ordinal' => $_generation_ordinal,
                'golf' => $_golf,
                'golf_affinity' => $_golf_affinity,
                'gourmet_affinity' => $_gourmet_affinity,
                'grandparents_affinity' => $_grandparents_affinity,
                'health_affinity' => $_health_affinity,
                'healthy_living' => $_healthy_living,
                'healthy_living_interest' => $_healthy_living_interest,
                'high_tech_affinity' => $_high_tech_affinity,
                'hispanic_affinity' => $_hispanic_affinity,
                'hockey' => $_hockey,
                'hockey_affinity' => $_hockey_affinity,
                'home_decor' => $_home_decor,
                'home_improvement_interest' => $_home_improvement_interest,
                'home_office_affinity' => $_home_office_affinity,
                'home_study' => $_home_study,
                'hunting' => $_hunting,
                'hunting_affinity' => $_hunting_affinity,
                'jazz' => $_jazz,
                'kids_apparel_affinity' => $_kids_apparel_affinity,
                'knit_affinity' => $_knit_affinity,
                'knitting_quilting_sewing' => $_knitting_quilting_sewing,
                'luxury_life' => $_luxury_life,
                'married' => $_married,
                'median_income' => $_median_income,
                'mens_apparel_affinity' => $_mens_apparel_affinity,
                'mens_fashion_affinity' => $_mens_fashion_affinity,
                'mortgage_age' => $_mortgage_age,
                'mortgage_amount' => $_mortgage_amount,
                'mortgage_loan_type' => $_mortgage_loan_type,
                'mortgage_refi_age' => $_mortgage_refi_age,
                'mortgage_refi_amount' => $_mortgage_refi_amount,
                'mortgage_refi_type' => $_mortgage_refi_type,
                'motor_racing' => $_motor_racing,
                'motorcycles' => $_motorcycles,
                'motorcycles_affinity' => $_motorcycles_affinity,
                'movies' => $_movies,
                'nascar' => $_nascar,
                'needlepoint_affinity' => $_needlepoint_affinity,
                'new_credit_offered_household' => $_new_credit_offered_household,
                'num_credit_lines_household' => $_num_credit_lines_household,
                'num_generations_household' => $_num_generations_household,
                'outdoors' => $_outdoors,
                'outdoors_affinity' => $_outdoors_affinity,
                'owns_investments' => $_owns_investments,
                'owns_mutual_funds' => $_owns_mutual_funds,
                'owns_stocks_and_bonds' => $_owns_stocks_and_bonds,
                'owns_swimming_pool' => $_owns_swimming_pool,
                'personal_finance_affinity' => $_personal_finance_affinity,
                'personality' => $_personality,
                'plates_collector' => $_plates_collector,
                'pop_density' => $_pop_density,
                'premium_amex_card' => $_premium_amex_card,
                'premium_card' => $_premium_card,
                'premium_income_household' => $_premium_income_household,
                'premium_income_midpt_household' => $_premium_income_midpt_household,
                'quilt_affinity' => $_quilt_affinity,
                'religious_music' => $_religious_music,
                'rhythm_and_blues' => $_rhythm_and_blues,
                'rock_music' => $_rock_music,
                'running' => $_running,
                'rv' => $_rv,
                'scuba' => $_scuba,
                'self_improvement' => $_self_improvement,
                'sewing_affinity' => $_sewing_affinity,
                'single_family_dwelling' => $_single_family_dwelling,
                'snow_skiing' => $_snow_skiing,
                'snow_skiing_affinity' => $_snow_skiing_affinity,
                'soccer' => $_soccer,
                'soccer_affinity' => $_soccer_affinity,
                'soft_rock' => $_soft_rock,
                'soho_business' => $_soho_business,
                'sports_memoribilia_collector' => $_sports_memoribilia_collector,
                'stamps' => $_stamps,
                'sweepstakes_affinity' => $_sweepstakes_affinity,
                'tennis' => $_tennis,
                'tennis_affinity' => $_tennis_affinity,
                'tobacco_affinity' => $_tobacco_affinity,
                'travel_affinity' => $_travel_affinity,
                'travel_cruise_affinity' => $_travel_cruise_affinity,
                'travel_cruises' => $_travel_cruises,
                'travel_personal' => $_travel_personal,
                'travel_rv_affinity' => $_travel_rv_affinity,
                'travel_us_affinity' => $_travel_us_affinity,
                'truck_owner' => $_truck_owner,
                'trucks_affinity' => $_trucks_affinity,
                'tv_movies_affinity' => $_tv_movies_affinity,
                'veteran_household' => $_veteran_household,
                'walking' => $_walking,
                'weight_lifting' => $_weight_lifting,
                'wildlife_affinity' => $_wildlife_affinity,
                'womens_apparel_affinity' => $_womens_apparel_affinity,
                'womens_fashion_affinity' => $_womens_fashion_affinity,
                'woodworking' => $_woodworking,
                'male_aux' => $_male_aux,
                'political_contributor_aux' => $_political_contributor_aux,
                'political_party_aux' => $_political_party_aux,
                'financial_power' => $_financial_power,
                'mortgage_open_1st_intent' => $_mortgage_open_1st_intent,
                'mortgage_open_2nd_intent' => $_mortgage_open_2nd_intent,
                'mortgage_new_intent' => $_mortgage_new_intent,
                'mortgage_refinance_intent' => $_mortgage_refinance_intent,
                'automotive_loan_intent' => $_automotive_loan_intent,
                'bank_card_intent' => $_bank_card_intent,
                'personal_loan_intent' => $_personal_loan_intent,
                'retail_card_intent' => $_retail_card_intent,
                'student_loan_cons_intent' => $_student_loan_cons_intent,
                'student_loan_intent' => $_student_loan_intent,
                'qtr3_baths' => $_3qtr_baths,
                'ac_type' => $_ac_type,
                'acres' => $_acres,
            ]);
            //INSERT PERSON ADVANCE 2

            //INSERT PERSON ADVANCE 3
            $newpersonadvance3 = PersonAdvance3::create([
                'person_id' => $newPersonID,
                'additions_square_feet' => $_additions_square_feet,
                'assess_val_impr' => $_assess_val_impr,
                'assess_val_lnd' => $_assess_val_lnd,
                'assess_val_prop' => $_assess_val_prop,
                'bldg_style' => $_bldg_style,
                'bsmt_sqft' => $_bsmt_sqft,
                'bsmt_type' => $_bsmt_type,
                'build_sqft_assess' => $_build_sqft_assess,
                'business' => $_business,
                'combined_statistical_area' => $_combined_statistical_area,
                'metropolitan_division' => $_metropolitan_division,
                'middle' => $_middle,
                'middle_2' => $_middle_2,
                'mkt_ip_perc' => $_mkt_ip_perc,
                'mobile_home' => $_mobile_home,

                'mrtg_due' => $_mrtg_due,
                'mrtg_intrate' => $_mrtg_intrate,
                'mrtg_refi' => $_mrtg_refi,
                'mrtg_term' => $_mrtg_term,
                'mrtg_type' => $_mrtg_type,

                'mrtg2_amt' => $_mrtg2_amt,
                'mrtg2_date' => $_mrtg2_date,
                'mrtg2_deed_type' => $_mrtg2_deed_type,
                'mrtg2_due' => $_mrtg2_due,
                'mrtg2_equity' => $_mrtg2_equity,
                'mrtg2_intrate' => $_mrtg2_intrate,
                'mrtg2_inttype' => $_mrtg2_inttype,
                'mrtg2_refi' => $_mrtg2_refi,
                'mrtg2_term' => $_mrtg2_term,
                'mrtg2_type' => $_mrtg2_type,

                'mrtg3_amt' => $_mrtg3_amt,
                'mrtg3_date' => $_mrtg3_date,
                'mrtg3_deed_type' => $_mrtg3_deed_type,
                'mrtg3_due' => $_mrtg3_due,
                'mrtg3_equity' => $_mrtg3_equity,
                'mrtg3_inttype' => $_mrtg3_inttype,
                'mrtg3_refi' => $_mrtg3_refi,
                'mrtg3_term' => $_mrtg3_term,
                'mrtg3_type' => $_mrtg3_type,

                'msa_code' => $_msa_code,
                'number_bedrooms' => $_number_bedrooms,
                'number_bldgs' => $_number_bldgs,
                'number_fireplace' => $_number_fireplace,
                'number_park_spaces' => $_number_park_spaces,
                'number_rooms' => $_number_rooms,
                'own_biz' => $_own_biz,
                'owner_occupied' => $_owner_occupied,
                'ownership_relation' => $_ownership_relation,
                'owner_type_description' => $_owner_type_description,
                'estimated_value' => $_estimated_value,
                'ext_type' => $_ext_type,
                'finish_square_feet2' => $_finish_square_feet2,
                'fireplace' => $_fireplace,
                'first' => $_first,
                'first_2' => $_first_2,
                'found_type' => $_found_type,
                'fr_feet' => $_fr_feet,
                'fuel_type' => $_fuel_type,
                'full_baths' => $_full_baths,
                'half_baths' => $_half_baths,
                'garage_type' => $_garage_type,
                'grnd_sqft' => $_grnd_sqft,
                'heat_type' => $_heat_type,
                'hmstd' => $_hmstd,
                'impr_appr_val' => $_impr_appr_val,
                'imprval' => $_imprval,
                'imprval_type' => $_imprval_type,
                'land_appr_val' => $_land_appr_val,
                'landval' => $_landval,
                'landval_type' => $_landval_type,
                'last' => $_last,
                'last_2' => $_last_2,
                'lat' => $_lat,
                'lender_name' => $_lender_name,
                'lender2_name' => $_lender2_name,
                'lender3_name' => $_lender3_name,
                'loan_amt' => $_loan_amt,
                'loan_date' => $_loan_date,
                'loan_to_val' => $_loan_to_val,
                'lon' => $_lon,
                'markval' => $_markval,
                'markval_type' => $_markval_type,
                'patio_porch' => $_patio_porch,
                'patio_square_feet' => $_patio_square_feet,
                'pool' => $_pool,
                'porch_square_feet' => $_porch_square_feet,
                'previous_assessed_value' => $_previous_assessed_value,
                'prop_type' => $_prop_type,
                'rate_type' => $_rate_type,
                'rec_date' => $_rec_date,
                'roof_covtype' => $_roof_covtype,
                'roof_shapetype' => $_roof_shapetype,
                'sale_amt' => $_sale_amt,
                'sale_amt_pr' => $_sale_amt_pr,
                'sale_date' => $_sale_date,
                'sale_type_pr' => $_sale_type_pr,
                'sales_type' => $_sales_type,
                'sell_name' => $_sell_name,
                'sewer_type' => $_sewer_type,
                'site_quality' => $_site_quality,
                'std_address' => $_std_address,
                'std_city' => $_std_city,
                'std_state' => $_std_state,
                'std_zip' => $_std_zip,
                'std_zip4' => $_std_zip4,
                'stories_number' => $_stories_number,
                'suffix' => $_suffix,
                'suffix_2' => $_suffix_2,
                'tax_yr' => $_tax_yr,
                'tax_improvement_percent' => $_tax_improvement_percent,
                'title_co' => $_title_co,
                'tot_baths_est' => $_tot_baths_est,
                'ttl_appr_val' => $_ttl_appr_val,
                'ttl_bld_sqft' => $_ttl_bld_sqft,
                'ttl_tax' => $_ttl_tax,
                'unit_number' => $_unit_number,
                'vet_exempt' => $_vet_exempt,
                'water_type' => $_water_type,
            ]);
            //INSERT PERSON ADVANCE 3

            //INSERT PERSON ADVANCE 
            /** HR TEMPORARY NOT SAVE 27 Jan 2025 */
            // $newpersonadvance = PersonAdvance::create([
            //     'person_id' => $newPersonID,
            //     'gender_aux' => $_gender_aux,
            //     'gender' => $_gender,
            //     'age_aux' => $_age_aux,
            //     'birth_year_aux' => $_birth_year_aux,
            //     'generation' => $_generation,
            //     'income_household' => $_household_income,
            //     'income_midpts_household' => $_median_household_income,
            //     'net_worth_household' => $_household_net_worth,
            //     'net_worth_midpt_household' => $_median_household_net_worth,
            //     'discretionary_income' => $_discretionary_income,
            //     'credit_midpts' => $_credit_score_median,
            //     'credit_range' => $_credit_score_range,
            //     'occupation_category' => $_occupation_category,
            //     'occupation_detail' => $_occupation_detail,
            //     'occupation_type' => $_occupation_type,
            //     'voter' => $_voter,
            //     'urbanicity' => $_urbanicity,
            //     'mobile_phone_1' => $_mobile_phone,
            //     'mobile_phone_2' => $_mobile_phone2,
            //     'mobile_phone_3' => $_mobile_phone3,
            //     'mobile_phone_1_dnc' => $_mobile_phone_dnc,
            //     'mobile_phone_2_dnc' => $_mobile_phone_dnc2,
            //     'mobile_phone_3_dnc' => $_mobile_phone_dnc3,
            //     'tax_bill_mailing_address' => $_tax_bill_mailing_address,
            //     'tax_bill_mailing_city' => $_tax_bill_mailing_city,
            //     'tax_bill_mailing_county' => $_tax_bill_mailing_county,
            //     'tax_bill_mailing_fips' => $_tax_bill_mailing_fips,
            //     'tax_bill_mailing_state' => $_tax_bill_mailing_state,
            //     'tax_bill_mailing_zip' => $_tax_bill_mailing_zip,
            //     'tax_bill_mailing_zip4' => $_tax_bill_mailing_zip4,
            //     'num_adults_household' => $_num_adults_household,
            //     'num_children_household' => $_num_children_household,
            //     'num_persons_household' => $_num_persons_household,
            //     'child_aged_0_3_household' => $_child_aged_0_3_household,
            //     'child_aged_4_6_household' => $_child_aged_4_6_household,
            //     'child_aged_7_9_household' => $_child_aged_7_9_household,
            //     'child_aged_10_12_household' => $_child_aged_10_12_household,
            //     'child_aged_13_18_household' => $_child_aged_13_18_household,
            //     'children_household' => $_children_household,
            //     'has_email' => $_has_email,
            //     'has_phone' => $_has_phone,
            //     'magazine_subscriber' => $_magazine_subscriber,
            //     'charity_interest' => $_charity_interest,
            //     'likely_charitable_donor' => $_likely_charitable_donor,
            //     'donor_affinity' => $_donor_affinity,
            //     'dwelling_type' => $_dwelling_type,
            //     'home_owner' => $_home_owner,
            //     'home_owner_ordinal' => $_home_owner_ordinal,
            //     'length_of_residence' => $_length_of_residence,
            //     'home_price' => $_home_price,
            //     'home_value' => $_home_value,
            //     'median_home_value' => $_median_home_value,
            //     'living_sqft' => $_living_sqft,
            //     'yr_built_orig' => $_year_built_original,
            //     'yr_built_range' => $_year_built_range,
            //     'lot_number' => $_lot_number,
            //     'legal_description' => $_legal_description,
            //     'land_sqft' => $_land_sqft,
            //     'garage_sqft' => $_garage_sqft,
            //     'subdivision' => $_subdivision,
            //     'zoning_code' => $_zoning_code,
            //     'cooking' => $_cooking,
            //     'gardening' => $_gardening,
            //     'music' => $_music,
            //     'diy' => $_diy,
            //     'books' => $_books,
            //     'travel_vacation' => $_travel_vacation,
            //     'health_beauty_products' => $_health_beauty_products,
            //     'pet_owner' => $_pet_owner,
            //     'photography' => $_photography,
            //     'fitness' => $_fitness,
            //     'epicurean' => $_epicurean,
            //     'cbsa' => $_cbsa,
            //     'census_block' => $_census_block,
            //     'census_block_group' => $_census_block_group,
            //     'census_tract' => $_census_tract,
                
            //     'aerobics' => $_aerobics,
            //     'african_american_affinity' => $_african_american_affinity ,
            //     'amex_card' => $_amex_card,
            //     'antiques' => $_antiques,
            //     'apparel_accessory_affinity' => $_apparel_accessory_affinity,
            //     'apparel_affinity' => $_apparel_affinity,
            //     'arts_and_crafts' => $_arts_and_crafts,
            //     'asian_affinity' => $_asian_affinity,
            //     'auto_affinity' => $_auto_affinity,
            //     'auto_racing_affinity' => $_auto_racing_affinity,
            //     'aviation_affinity' => $_aviation_affinity,
            //     'bank_card' => $_bank_card,
            //     'bargain_hunter_affinity' => $_bargain_hunter_affinity,
            //     'baseball' => $_baseball,
            //     'baseball_affinity' => $_baseball_affinity,
            //     'basketball' => $_basketball,
            //     'basketball_affinity' => $_basketball_affinity,
            //     'beauty_affinity' => $_beauty_affinity,
            //     'bible_affinity' => $_bible_affinity,
            //     'bird_watching' => $_bird_watching,
            //     'birds_affinity' => $_birds_affinity,
            //     'blue_collar' => $_blue_collar,
            //     'boating_sailing' => $_boating_sailing,
            //     'boating_sailing_affinity' => $_boating_sailing_affinity,
            //     'business_affinity' => $_business_affinity,
            //     'camping_hiking' => $_camping_hiking,
            //     'camping_hiking_climbing_affinity' => $_camping_hiking_climbing_affinity,
            //     'cars_interest' => $_cars_interest,
            //     'cat_owner' => $_cat_owner,
            //     'catalog_affinity' => $_catalog_affinity,
            //     'cigars' => $_cigars,
            //     'classical_music' => $_classical_music,
            //     'coins' => $_coins,
            //     'collectibles_affinity' => $_collectibles_affinity,
            //     'college_affinity' => $_college_affinity,
            //     'computers_affinity' => $_computers_affinity,
            //     'continuity_program_affinity' => $_continuity_program_affinity,
            //     'cooking_affinity' => $_cooking_affinity,
            //     'cosmetics' => $_cosmetics,
            //     'country_music' => $_country_music,
            //     'crafts_affinity' => $_crafts_affinity,
            //     'credit_card' => $_credit_card,
            //     'credit_repair_affinity' => $_credit_repair_affinity,
            //     'crochet_affinity' => $_crochet_affinity,
            //     'diet_affinity' => $_diet_affinity,
            //     'dieting' => $_dieting,
            //     'do_it_yourself_affinity' => $_do_it_yourself_affinity,
            //     'dog_owner' => $_dog_owner,
            //     'doll_collector' => $_doll_collector,
            //     'education' => $_education,
            //     'education_ordinal' => $_education_ordinal,
            //     'education_seekers_affinity' => $_education_seekers_affinity,
            //     'ego_affinity' => $_ego_affinity,
            //     'entertainment_interest' => $_entertainment_interest,
            //     'figurines_collector' => $_figurines_collector,
            //     'fine_arts_collector' => $_fine_arts_collector,
            //     'fishing' => $_fishing,
            //     'fishing_affinity' => $_fishing_affinity,
            //     'fitness_affinity' => $_fitness_affinity,
            //     'football' => $_football,
            //     'football_affinity' => $_football_affinity,
            //     'gambling' => $_gambling,
            //     'gambling_affinity' => $_gambling_affinity,
            //     'games_affinity' => $_games_affinity,
            //     'gardening_affinity' => $_gardening_affinity,
            //     'generation_ordinal' => $_generation_ordinal,
            //     'golf' => $_golf,
            //     'golf_affinity' => $_golf_affinity,
            //     'gourmet_affinity' => $_gourmet_affinity,
            //     'grandparents_affinity' => $_grandparents_affinity,
            //     'health_affinity' => $_health_affinity,
            //     'healthy_living' => $_healthy_living,
            //     'healthy_living_interest' => $_healthy_living_interest,
            //     'high_tech_affinity' => $_high_tech_affinity,
            //     'hispanic_affinity' => $_hispanic_affinity,
            //     'hockey' => $_hockey,
            //     'hockey_affinity' => $_hockey_affinity,
            //     'home_decor' => $_home_decor,
            //     'home_improvement_interest' => $_home_improvement_interest,
            //     'home_office_affinity' => $_home_office_affinity,
            //     'home_study' => $_home_study,
            //     'hunting' => $_hunting,
            //     'hunting_affinity' => $_hunting_affinity,
            //     'jazz' => $_jazz,
            //     'kids_apparel_affinity' => $_kids_apparel_affinity,
            //     'knit_affinity' => $_knit_affinity,
            //     'knitting_quilting_sewing' => $_knitting_quilting_sewing,
            //     'luxury_life' => $_luxury_life,
            //     'married' => $_married,
            //     'marital_status' => $_marital_status,
            //     'median_income' => $_median_income,
            //     'mens_apparel_affinity' => $_mens_apparel_affinity,
            //     'mens_fashion_affinity' => $_mens_fashion_affinity,
            //     'mortgage_age' => $_mortgage_age,
            //     'mortgage_amount' => $_mortgage_amount,
            //     'mortgage_loan_type' => $_mortgage_loan_type,
            //     'mortgage_refi_age' => $_mortgage_refi_age,
            //     'mortgage_refi_amount' => $_mortgage_refi_amount,
            //     'mortgage_refi_type' => $_mortgage_refi_type,
            //     'motor_racing' => $_motor_racing,
            //     'motorcycles' => $_motorcycles,
            //     'motorcycles_affinity' => $_motorcycles_affinity,
            //     'movies' => $_movies,
            //     'nascar' => $_nascar,
            //     'needlepoint_affinity' => $_needlepoint_affinity,
            //     'new_credit_offered_household' => $_new_credit_offered_household,
            //     'num_credit_lines_household' => $_num_credit_lines_household,
            //     'num_generations_household' => $_num_generations_household,
            //     'outdoors' => $_outdoors,
            //     'outdoors_affinity' => $_outdoors_affinity,
            //     'owns_investments' => $_owns_investments,
            //     'owns_mutual_funds' => $_owns_mutual_funds,
            //     'owns_stocks_and_bonds' => $_owns_stocks_and_bonds,
            //     'owns_swimming_pool' => $_owns_swimming_pool,
            //     'personal_finance_affinity' => $_personal_finance_affinity,
            //     'personality' => $_personality,
            //     'plates_collector' => $_plates_collector,
            //     'pop_density' => $_pop_density,
            //     'premium_amex_card' => $_premium_amex_card,
            //     'premium_card' => $_premium_card,
            //     'premium_income_household' => $_premium_income_household,
            //     'premium_income_midpt_household' => $_premium_income_midpt_household,
            //     'quilt_affinity' => $_quilt_affinity,
            //     'religious_music' => $_religious_music,
            //     'rhythm_and_blues' => $_rhythm_and_blues,
            //     'rock_music' => $_rock_music,
            //     'running' => $_running,
            //     'rv' => $_rv,
            //     'scuba' => $_scuba,
            //     'self_improvement' => $_self_improvement,
            //     'sewing_affinity' => $_sewing_affinity,
            //     'single_family_dwelling' => $_single_family_dwelling,
            //     'snow_skiing' => $_snow_skiing,
            //     'snow_skiing_affinity' => $_snow_skiing_affinity,
            //     'soccer' => $_soccer,
            //     'soccer_affinity' => $_soccer_affinity,
            //     'soft_rock' => $_soft_rock,
            //     'soho_business' => $_soho_business,
            //     'sports_memoribilia_collector' => $_sports_memoribilia_collector,
            //     'stamps' => $_stamps,
            //     'sweepstakes_affinity' => $_sweepstakes_affinity,
            //     'tennis' => $_tennis,
            //     'tennis_affinity' => $_tennis_affinity,
            //     'tobacco_affinity' => $_tobacco_affinity,
            //     'travel_affinity' => $_travel_affinity,
            //     'travel_cruise_affinity' => $_travel_cruise_affinity,
            //     'travel_cruises' => $_travel_cruises,
            //     'travel_personal' => $_travel_personal,
            //     'travel_rv_affinity' => $_travel_rv_affinity,
            //     'travel_us_affinity' => $_travel_us_affinity,
            //     'truck_owner' => $_truck_owner,
            //     'trucks_affinity' => $_trucks_affinity,
            //     'tv_movies_affinity' => $_tv_movies_affinity,
            //     'veteran_household' => $_veteran_household,
            //     'walking' => $_walking,
            //     'weight_lifting' => $_weight_lifting,
            //     'wildlife_affinity' => $_wildlife_affinity,
            //     'womens_apparel_affinity' => $_womens_apparel_affinity,
            //     'womens_fashion_affinity' => $_womens_fashion_affinity,
            //     'woodworking' => $_woodworking,
            //     'male_aux' => $_male_aux,
            //     'political_contributor_aux' => $_political_contributor_aux,
            //     'political_party_aux' => $_political_party_aux,
            //     'financial_power' => $_financial_power,
            //     'mortgage_open_1st_intent' => $_mortgage_open_1st_intent,
            //     'mortgage_open_2nd_intent' => $_mortgage_open_2nd_intent,
            //     'mortgage_new_intent' => $_mortgage_new_intent,
            //     'mortgage_refinance_intent' => $_mortgage_refinance_intent,
            //     'automotive_loan_intent' => $_automotive_loan_intent,
            //     'bank_card_intent' => $_bank_card_intent,
            //     'personal_loan_intent' => $_personal_loan_intent,
            //     'retail_card_intent' => $_retail_card_intent,
            //     'student_loan_cons_intent' => $_student_loan_cons_intent,
            //     'student_loan_intent' => $_student_loan_intent,
            //     'qtr3_baths' => $_3qtr_baths,
            //     'ac_type' => $_ac_type,
            //     'acres' => $_acres,
            //     'additions_square_feet' => $_additions_square_feet,
            //     'assess_val_impr' => $_assess_val_impr,
            //     'assess_val_lnd' => $_assess_val_lnd,
            //     'assess_val_prop' => $_assess_val_prop,
            //     'bldg_style' => $_bldg_style,
            //     'bsmt_sqft' => $_bsmt_sqft,
            //     'bsmt_type' => $_bsmt_type,
            //     'build_sqft_assess' => $_build_sqft_assess,
            //     'business' => $_business,
            //     'combined_statistical_area' => $_combined_statistical_area,
            //     'metropolitan_division' => $_metropolitan_division,
            //     'middle' => $_middle,
            //     'middle_2' => $_middle_2,
            //     'mkt_ip_perc' => $_mkt_ip_perc,
            //     'mobile_home' => $_mobile_home,

            //     'mrtg_due' => $_mrtg_due,
            //     'mrtg_intrate' => $_mrtg_intrate,
            //     'mrtg_refi' => $_mrtg_refi,
            //     'mrtg_term' => $_mrtg_term,
            //     'mrtg_type' => $_mrtg_type,

            //     'mrtg2_amt' => $_mrtg2_amt,
            //     'mrtg2_date' => $_mrtg2_date,
            //     'mrtg2_deed_type' => $_mrtg2_deed_type,
            //     'mrtg2_due' => $_mrtg2_due,
            //     'mrtg2_equity' => $_mrtg2_equity,
            //     'mrtg2_intrate' => $_mrtg2_intrate,
            //     'mrtg2_inttype' => $_mrtg2_inttype,
            //     'mrtg2_refi' => $_mrtg2_refi,
            //     'mrtg2_term' => $_mrtg2_term,
            //     'mrtg2_type' => $_mrtg2_type,

            //     'mrtg3_amt' => $_mrtg3_amt,
            //     'mrtg3_date' => $_mrtg3_date,
            //     'mrtg3_deed_type' => $_mrtg3_deed_type,
            //     'mrtg3_due' => $_mrtg3_due,
            //     'mrtg3_equity' => $_mrtg3_equity,
            //     'mrtg3_inttype' => $_mrtg3_inttype,
            //     'mrtg3_refi' => $_mrtg3_refi,
            //     'mrtg3_term' => $_mrtg3_term,
            //     'mrtg3_type' => $_mrtg3_type,

            //     'msa_code' => $_msa_code,
            //     'number_bedrooms' => $_number_bedrooms,
            //     'number_bldgs' => $_number_bldgs,
            //     'number_fireplace' => $_number_fireplace,
            //     'number_park_spaces' => $_number_park_spaces,
            //     'number_rooms' => $_number_rooms,
            //     'own_biz' => $_own_biz,
            //     'owner_occupied' => $_owner_occupied,
            //     'ownership_relation' => $_ownership_relation,
            //     'owner_type_description' => $_owner_type_description,
            //     'estimated_value' => $_estimated_value,
            //     'ext_type' => $_ext_type,
            //     'finish_square_feet2' => $_finish_square_feet2,
            //     'fireplace' => $_fireplace,
            //     'first' => $_first,
            //     'first_2' => $_first_2,
            //     'found_type' => $_found_type,
            //     'fr_feet' => $_fr_feet,
            //     'fuel_type' => $_fuel_type,
            //     'full_baths' => $_full_baths,
            //     'half_baths' => $_half_baths,
            //     'garage_type' => $_garage_type,
            //     'grnd_sqft' => $_grnd_sqft,
            //     'heat_type' => $_heat_type,
            //     'hmstd' => $_hmstd,
            //     'impr_appr_val' => $_impr_appr_val,
            //     'imprval' => $_imprval,
            //     'imprval_type' => $_imprval_type,
            //     'land_appr_val' => $_land_appr_val,
            //     'landval' => $_landval,
            //     'landval_type' => $_landval_type,
            //     'last' => $_last,
            //     'last_2' => $_last_2,
            //     'lat' => $_lat,
            //     'lender_name' => $_lender_name,
            //     'lender2_name' => $_lender2_name,
            //     'lender3_name' => $_lender3_name,
            //     'loan_amt' => $_loan_amt,
            //     'loan_date' => $_loan_date,
            //     'loan_to_val' => $_loan_to_val,
            //     'lon' => $_lon,
            //     'markval' => $_markval,
            //     'markval_type' => $_markval_type,
            //     'patio_porch' => $_patio_porch,
            //     'patio_square_feet' => $_patio_square_feet,
            //     'pool' => $_pool,
            //     'porch_square_feet' => $_porch_square_feet,
            //     'previous_assessed_value' => $_previous_assessed_value,
            //     'prop_type' => $_prop_type,
            //     'rate_type' => $_rate_type,
            //     'rec_date' => $_rec_date,
            //     'roof_covtype' => $_roof_covtype,
            //     'roof_shapetype' => $_roof_shapetype,
            //     'sale_amt' => $_sale_amt,
            //     'sale_amt_pr' => $_sale_amt_pr,
            //     'sale_date' => $_sale_date,
            //     'sale_type_pr' => $_sale_type_pr,
            //     'sales_type' => $_sales_type,
            //     'sell_name' => $_sell_name,
            //     'sewer_type' => $_sewer_type,
            //     'site_quality' => $_site_quality,
            //     'std_address' => $_std_address,
            //     'std_city' => $_std_city,
            //     'std_state' => $_std_state,
            //     'std_zip' => $_std_zip,
            //     'std_zip4' => $_std_zip4,
            //     'stories_number' => $_stories_number,
            //     'suffix' => $_suffix,
            //     'suffix_2' => $_suffix_2,
            //     'tax_yr' => $_tax_yr,
            //     'tax_improvement_percent' => $_tax_improvement_percent,
            //     'title_co' => $_title_co,
            //     'tot_baths_est' => $_tot_baths_est,
            //     'ttl_appr_val' => $_ttl_appr_val,
            //     'ttl_bld_sqft' => $_ttl_bld_sqft,
            //     'ttl_tax' => $_ttl_tax,
            //     'unit_number' => $_unit_number,
            //     'vet_exempt' => $_vet_exempt,
            //     'water_type' => $_water_type,
            // ]);
            /** HR TEMPORARY NOT SAVE 27 Jan 2025 */
            //INSERT PERSON ADVANCE

            Log::info("BigBDM Have result - ReportID #" . $_ID);

            $taxBillInformation = array_filter([
                $_tax_bill_mailing_address,
                $_tax_bill_mailing_city,
                !empty($_tax_bill_mailing_county) ? "{$_tax_bill_mailing_county} County" : null,
                $_tax_bill_mailing_state,
                trim($_tax_bill_mailing_zip . ($_tax_bill_mailing_zip && $_tax_bill_mailing_zip4 ? "-" : "") . $_tax_bill_mailing_zip4, "-")
            ]);            
            $taxBillInformationString = '';
            $taxBillInformationString = implode(", ", $taxBillInformation);

            $new = array(
                 // Person advance
                    //identification
                        "GenderAux" => $_gender_aux,
                        // "AgeAux" => $_age_aux,
                        // "BirthYearAux" => $_birth_year_aux,
                        "Generation" => $_generation,
                        'MaritalStatus' => $_marital_status,
                    //identification

                    //financial information
                        "IncomeHousehold" => $_household_income,
                        "IncomeMidptsHousehold" => $_median_household_income,
                        "NetWorthHousehold" => $_household_net_worth,
                        "NetWorthMidptHousehold" => $_median_household_net_worth,
                        "DiscretionaryIncome" => $_discretionary_income,
                        "CreditMidpts" => $_credit_score_median,
                        "CreditRange" => $_credit_score_range,
                    //financial information

                    //occupation
                        "OccupationCategory" => $_occupation_category,
                        "OccupationDetail" => $_occupation_detail,
                        "OccupationType" => $_occupation_type,
                    //occupation

                    //miscellaneous
                        "Voter" => $_voter,
                        "Urbanicity" => $_urbanicity,
                    //miscellaneous

                    //contact information
                        "Phone" => $_mobile_phone,    
                        "Phone2" => $_mobile_phone2,
                        "Phone3" => $_mobile_phone3,    
                        "TaxBillInformation" => $taxBillInformationString,
                    //contact information

                    //household information
                        "NumAdultsHousehold" => $_num_adults_household,
                        "NumChildrenHousehold" => $_num_children_household,
                        "NumPersonsHousehold" => $_num_persons_household,
                        "ChildAged03Household" => $_child_aged_0_3_household,
                        "ChildAged46Household" => $_child_aged_4_6_household,
                        "ChildAged79Household" => $_child_aged_7_9_household,
                        "ChildAged1012Household" => $_child_aged_10_12_household,
                        "ChildAged1318Household" => $_child_aged_13_18_household,
                        "ChildrenHousehold" => $_children_household,
                    //household information

                    //marketing indicators
                        // "HasEmail" => $_has_email,
                        // "HasPhone" => $_has_phone,
                        "MagazineSubscriber" => $_magazine_subscriber,
                        "CharityInterest" => $_charity_interest,
                        "LikelyCharitableDonor" => $_likely_charitable_donor,
                    //marketing indicators

                    //house and real estate
                        "DwellingType" => $_dwelling_type,
                        "HomeOwner" => $_home_owner,
                        "HomeOwnerOrdinal" => $_home_owner_ordinal,
                        "LengthOfResidence" => $_length_of_residence,
                        "HomePrice" => $_home_price,
                        "HomeValue" => $_home_value,
                        "MedianHomeValue" => $_median_home_value,
                        "LivingSqft" => $_living_sqft,
                        "YrBuiltOrig" => $_year_built_original,
                        "YrBuiltRange" => $_year_built_range,
                        "LotNumber" => $_lot_number,
                        "LegalDescription" => $_legal_description,
                        "LandSqft" => $_land_sqft,
                        "GarageSqft" => $_garage_sqft,
                        "Subdivision" => $_subdivision,
                        "ZoningCode" => $_zoning_code,
                    //house and real estate

                    //interest and affinities
                        "Cooking" => $_cooking,
                        "Gardening" => $_gardening,
                        "Music" => $_music,
                        "Diy" => $_diy,
                        "Books" => $_books,
                        "TravelVacation" => $_travel_vacation,
                        "HealthBeautyProducts" => $_health_beauty_products,
                        "PetOwner" => $_pet_owner,
                        "Photography" => $_photography,
                        "Fitness" => $_fitness,
                        "Epicurean" => $_epicurean,
                    //interest and affinities

                    //location and census data
                        "Cbsa" => $_cbsa,
                        "CensusBlock" => $_census_block,
                        "CensusBlockGroup" => $_census_block_group,
                        "CensusTract" => $_census_tract,
                    //location and census data
                // Person advance
            );

            Log::info("BigBDM Result Ready to Serve");
            /** IF BIG BDM MD5 HAVE RESULT */
        }else{
                
            $trackBigBDM = $trackBigBDM . "->BDMAdvanceExistNoData";
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
                $frupdate = FailedRecord::find($failedRecordID);
                $frupdate->description = $frupdate->description . '|NoDataReturnFromBigBDMAdvanceExist';
                $frupdate->save();
            /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

            $new = array();
                /** BIG BDM NO RESULT CHECK TOWER DATA */
        }

        Log::info("BigBDM DATA FINAL RETURN");

        // return $new;
        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    public function filterEmailInLeadspeekReport($leadspeek_api_id = '', $email = '', $personID = '', $clientCompanyID = '', $leadspeektype = '', $md5Email = '') {
        /** CHECK REGARDING RE-IDENTIFICATION FOR LEADS */
        $salt = substr(hash('sha256', env('APP_KEY')), 0, 16);
        $reidentification = 'never';
        $notOnReidentification = true;
        $applyreidentificationall = false;

        // $chkreidentification = LeadspeekUser::select('reidentification_type','applyreidentificationall')
        //                             ->where('leadspeek_api_id','=',$leadspeek_api_id)
        //                             ->first();

        $_cacheKey = "reidentification_" . $leadspeek_api_id;
        $chkreidentification = $this->cacheQueryResult($_cacheKey,30,function () use ($leadspeek_api_id) {
            return LeadspeekUser::select('reidentification_type','applyreidentificationall')
                                    ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                    ->first();
        });

        //if (count($chkreidentification) > 0) {
        if ($chkreidentification) {
            $reidentification = $chkreidentification->reidentification_type;
            $applyreidentificationall = ($chkreidentification->applyreidentificationall == 'T')?true:false;
        }

        /** CHECK IF DATA ALREADY IN THAT CAMPAIGN OR NOT */
        $chkExistOnCampaign = null;
        $email = Encrypter::encrypt($email);

        if ($applyreidentificationall) {
            // $chkExistOnCampaign = LeadspeekReport::select('leadspeek_reports.id','leadspeek_reports.clickdate','leadspeek_reports.created_at')
            //                         ->join('leadspeek_users','leadspeek_reports.lp_user_id','=','leadspeek_users.id')
            //                         ->where('leadspeek_reports.company_id','=',$clientCompanyID)
            //                         ->where('leadspeek_users.applyreidentificationall','=','T')
            //                         ->where('leadspeek_users.archived','=','F')
            //                         //->where(DB::raw("CONVERT(AES_DECRYPT(FROM_bASE64(`leadspeek_reports`.`email`), '" . $salt . "') USING utf8mb4)"),'=',$email)
            //                         ->where('leadspeek_reports.email','=',$email)
            //                         // ->orderBy(DB::raw("DATE_FORMAT(leadspeek_reports.clickdate,'%Y%m%d')"),'DESC')
            //                         ->orderBy('leadspeek_reports.clickdate','DESC')	
            //                         //->limit(1)
            //                         //->get();
            //                         ->first();
            
            $_cacheKey = "chkExistOnCampaignFilterEmail1_" . $email . '_' . $clientCompanyID;
            $chkExistOnCampaign = $this->cacheGetResult($_cacheKey);
            if(is_null($chkExistOnCampaign)) {
                $chkExistOnCampaign = LeadspeekReport::select('leadspeek_reports.id','leadspeek_reports.clickdate','leadspeek_reports.created_at')
                                                    ->join('leadspeek_users','leadspeek_reports.lp_user_id','=','leadspeek_users.id')
                                                    ->where('leadspeek_users.applyreidentificationall','=','T')
                                                    ->where('leadspeek_users.archived','=','F')
                                                    ->where('leadspeek_reports.company_id','=',$clientCompanyID)
                                                    ->where('leadspeek_reports.email','=',$email)
                                                    ->orderBy('leadspeek_reports.clickdate','DESC')	
                                                    ->first();
                if(!empty($chkExistOnCampaign)) {
                    $chkExistOnCampaign = $this->cacheQueryResult($_cacheKey,100,function () use ($chkExistOnCampaign) {
                        return $chkExistOnCampaign; 
                    });
                } else {
                    if($this->cacheHasResult($_cacheKey)) {
                        $this->cacheForget($_cacheKey);
                    }
                }
            }
        }else{
            // $chkExistOnCampaign = LeadspeekReport::select('id','clickdate','created_at')
            //                         ->where('leadspeek_api_id','=',$leadspeek_api_id)
            //                         //->where(DB::raw("CONVERT(AES_DECRYPT(FROM_bASE64(`email`), '" . $salt . "') USING utf8mb4)"),'=',$email)
            //                         ->where('email','=',$email)
            //                         // ->orderBy(DB::raw("DATE_FORMAT(clickdate,'%Y%m%d')"),'DESC')
            //                         ->orderBy('clickdate','DESC')	
            //                         //->limit(1)
            //                         //->get();
            //                         ->first();

            $_cacheKey = "chkExistOnCampaignFilterEmail2_" . $email . '_' . $leadspeek_api_id;
            $chkExistOnCampaign = $this->cacheGetResult($_cacheKey);
            if(is_null($chkExistOnCampaign)) {
                $chkExistOnCampaign = LeadspeekReport::select('id','clickdate','created_at')
                                                    ->where('leadspeek_api_id','=',$leadspeek_api_id)
                                                    ->where('email','=',$email)
                                                    ->orderBy('clickdate','DESC')	
                                                    ->first();
                if(!empty($chkExistOnCampaign)) {
                    $chkExistOnCampaign = $this->cacheQueryResult($_cacheKey,100,function () use ($chkExistOnCampaign) {
                        return $chkExistOnCampaign;
                    });
                } else {
                    if($this->cacheHasResult($_cacheKey)) {
                        $this->cacheForget($_cacheKey);
                    }
                }
            }
        }

        //if (count($chkExistOnCampaign) > 0 && $reidentification != 'never') {
       //if (count($chkExistOnCampaign) > 0) {
       if ($chkExistOnCampaign) {
            //$clickDate = date('Ymd',strtotime($chkExistOnCampaign[0]['clickdate']));
            $clickDate = date('Ymd',strtotime($chkExistOnCampaign->clickdate));
            $date1=date_create(date('Ymd'));
            $date2=date_create($clickDate);
            $diff=date_diff($date1,$date2);

            if ($reidentification == 'never') {
                $notOnReidentification = false;
            }else if ($diff->format("%a") <= 7 && $reidentification == '1 week') {
                $notOnReidentification = false;
            }else if ($diff->format("%a") <= 30 && $reidentification == '1 month') {
                $notOnReidentification = false;
            }else if ($diff->format("%a") <= 90 && $reidentification == '3 months') {
                $notOnReidentification = false;
            }else if ($diff->format("%a") <= 120 && $reidentification == '6 months') {
                $notOnReidentification = false;
            }else if ($diff->format("%a") <= 360 && $reidentification == '1 year') {
                $notOnReidentification = false;
            }
        }

        if(!$notOnReidentification) {
            /* WRITE UPSER FAILED LEAD RECORD */
            $this->UpsertFailedLeadRecord([
                'function' => 'filterEmailInLeadspeekReport',
                'type' => 'blocked',
                'blocked_type' => 'reidentification',
                'description' => "blocked in reidentification type = $reidentification function filterEmailInLeadspeekReport",
                'leadspeek_api_id' => $leadspeek_api_id,
                'email_encrypt' => "$md5Email|$email",
                'leadspeek_type' => $leadspeektype,
            ]);
            /* WRITE UPSER FAILED LEAD RECORD */

            /* DELETE PERSON, PERSON EMAIL, PERSON PHONE, PERSON ADDRESS */
            // $person = Person::where('id',$personID)->delete();
            // $personEmail = PersonEmail::where('person_id',$personID)->delete();
            // $personPhone = PersonPhone::where('person_id',$personID)->delete();
            // $personAddress = PersonAddress::where('person_id',$personID)->delete();
            // /* DELETE PERSON, PERSON EMAIL, PERSON PHONE, PERSON ADDRESS */
        }

        return $notOnReidentification;
    }

    private function dataNotExistOnDBBIG($_fname,$_lname,$_email,$_phone,$_address,$_city,$_state,$_zip,$personID = "",$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$leadspeektype = "", $is_advance, $is_local_custom = ['is_advance' => false,'is_b2b' => false,'advance' => [],'b2b' => [],]) {
        date_default_timezone_set('America/Chicago');

        $new = array();
        $executionTimeList = [];

        $_ID = "";
        $_FirstName = "";
        $_LastName = "";
        $_Email = "";
        $_Email2 = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');
        $_Referer = "";
        $_Phone = "";
        $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        $_Description = $dataflow . "dataNotExistOnDBBIG|" . $failedRecordID;

        $trackBigBDM = "NOTEXISTONDBBIG";

        if ($personID != "") {
            /** GET PHONE DATA */
                // $personPhone = PersonPhone::where('person_id','=',$personID)->where('permission','T')->first();
                // //if (count($personPhone) > 0) {
                // if ($personPhone) {
                //     $_phone = $personPhone->number;
                // }
            /** GET PHONE DATA */

            /** GET ADDRESS DATA */
                //$personAddress = PersonAddress::where('person_id','=',$personID)->first();
                $_cacheKey = "personAddress_" . $personID;
                $personAddress = $this->cacheGetResult($_cacheKey);
                if(is_null($personAddress)) {
                    $personAddress = PersonAddress::where('person_id','=',$personID)->first();

                    if(!empty($personAddress)) {
                        $personAddress = $this->cacheQueryResult($_cacheKey,86400,function () use ($personAddress) {
                            return $personAddress;
                        });
                    } else {
                        if($this->cacheHasResult($_cacheKey)) {
                            $this->cacheForget($_cacheKey);
                        }
                    }
                }
                //if (count($personAddress) > 0) {
                if ($personAddress) {
                    $_address = $personAddress->street;
                    $_city = $personAddress->city;
                    $_state = $personAddress->state;
                    $_zip = $personAddress->zip;
                }
            /** GET ADDRESS DATA */
        }

        $startBigbdmMD5Time = microtime(true);

        /** CHECK WITH BIG BDM MD5 */
        $bigBDM_MD5 = $this->bigBDM_MD5($md5param,$leadspeek_api_id,$leadspeektype);
        /** CHECK WITH BIG BDM MD5 */

        $endBigbdmMD5Time = microtime(true);

        // convert epochtime to date format ('Y-m-d H:i:s')
        $startBigbdmMD5Date = Carbon::createFromTimestamp($startBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        $endBigbdmMD5Date = Carbon::createFromTimestamp($endBigbdmMD5Time)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
        // convert epochtime to date format ('Y-m-d H:i:s')

        $totalBigbdmMD5Time = $endBigbdmMD5Time - $startBigbdmMD5Time;
        $totalBigbdmMD5Time = number_format($totalBigbdmMD5Time,2,'.','');

        $executionTimeList['bigBDM_MD5'] = [
            'start_execution_time' => $startBigbdmMD5Date,
            'end_execution_time' => $endBigbdmMD5Date,
            'total_execution_time' => $totalBigbdmMD5Time,
        ];



        if(count((array)$bigBDM_MD5) > 0)
        {
            /** REPORT ANALYTIC */
            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmemail');
            /** REPORT ANALYTIC */
            $trackBigBDM = $trackBigBDM . "->MD5";

            foreach ($bigBDM_MD5 as $rd => $a) 
            {
                $bigEmail = (isset($a[0]->Email))?$a[0]->Email:'';
                $bigEmail = explode(",",$bigEmail);

                $bigPhone = (isset($a[0]->Phone))?$a[0]->Phone:'';
                $bigPhone = explode(",",$bigPhone);

                $_FirstName = (isset($a[0]->First_Name))?$a[0]->First_Name:'';
                $_LastName = (isset($a[0]->Last_Name))?$a[0]->Last_Name:'';
                $_Email = $bigEmail[0];
                $_Email2 = (isset($bigEmail[1]))?$bigEmail[1]:'';
                $_Phone = $bigPhone[0];
                $_Phone2 = (isset($bigPhone[1]))?$bigPhone[1]:'';
                // $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                if(isset($a[0]->Addr_Primary)){
                    $_Address1 = (isset($a[0]->Addr_Primary))?$a[0]->Addr_Primary:'';
                }else{
                    $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                }
                if(isset($a[0]->Addr_Secondary)){
                    $_Address2 = (isset($a[0]->Addr_Secondary))?$a[0]->Addr_Secondary:'';
                }
                $_City =  (isset($a[0]->City))?$a[0]->City:'';
                $_State = (isset($a[0]->State))?$a[0]->State:'';
                $_Zipcode = (isset($a[0]->Zip))?$a[0]->Zip:'';
            }

            if ($personID != "") 
            {
                /** CLEAN UP CURRENT DATABASE AND UPDATE NEW ONE */
                $pad = PersonAddress::where('person_id','=',$personID)->delete();
                $pname = PersonName::where('person_id','=',$personID)->delete();
                $pphone = PersonPhone::where('person_id','=',$personID)->delete();
                $pemail = PersonEmail::where('person_id','=',$personID)->delete();
                $p = Person::where('id','=',$personID)->delete();
                /** CLEAN UP CURRENT DATABASE AND UPDATE NEW ONE */
            }

            $uniqueID = uniqid();
            /** INSERT INTO DATABASE PERSON */
            $newPerson = Person::create([
                'uniqueID' => $uniqueID,
                'firstName' => $_FirstName,
                'middleName' => '',
                'lastName' => $_LastName,
                'age' => '0',
                'identityScore' => '0',
                'lastEntry' => date('Y-m-d H:i:s'),
            ]);
            $newPersonID = $newPerson->id;
            /** INSERT INTO DATABASE PERSON */

            if (trim($_Email) != '') 
            {
                $tmpEmail = strtolower(trim($_Email));
                $tmpMd5 = md5($tmpEmail);

                // $zbcheck = $this->zb_validation($tmpEmail,"");
                $param = [
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'leadspeek_type' => $leadspeektype,
                    'md5param' => $tmpMd5,
                ];
                $zbcheck = $this->true_list_validation($tmpEmail,$param);
                
                // Handle both TrueList and ZeroBounce responses
                $isValid = false;
                $validationStatus = '';
                $apiType = '';
                if (isset($zbcheck->emails[0]->email_state)) {
                    $validationStatus = $zbcheck->emails[0]->email_state;
                    $apiType = 'truelist';
                    $isValid = ($zbcheck->emails[0]->email_state == "ok");
                } elseif (isset($zbcheck->status)) {
                    $validationStatus = $zbcheck->status;
                    $apiType = 'zerobounce';
                    $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                }
                if ($validationStatus !== '') {
                    if (!$isValid) {
                        /** PUT IT ON OPTOUT LIST */
                        $createoptout = OptoutList::create([
                            'email' => $tmpEmail,
                            'emailmd5' => md5($tmpEmail),
                            'blockedcategory' => 'zbnotvalid',
                            'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email1fromBigPIIDataNotExist',
                        ]);
                        /** PUT IT ON OPTOUT LIST */
                        $_Email = "";

                        if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                            $this->UpsertFailedLeadRecord([
                                'function' => __FUNCTION__,
                                'type' => 'blocked',
                                'blocked_type' => $apiType,
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email1fromBigPIIDataNotExist',
                                'leadspeek_api_id' => $leadspeek_api_id,
                                'email_encrypt' => $tmpMd5,
                                'leadspeek_type' => $leadspeektype,
                                'email' => $tmpEmail,
                                'status' => $validationStatus,
                            ]);
                        }
                        /** REPORT ANALYTIC */
                        //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                        /** REPORT ANALYTIC */
                        $trackBigBDM = $trackBigBDM . "->Email1ZBFailed";
                    }
                    else
                    {
                        $newpersonemail = PersonEmail::create([
                            'person_id' => $newPersonID,
                            'email' => $tmpEmail,
                            'email_encrypt' => $tmpMd5,
                            'permission' => 'T',
                            'zbvalidate' => date('Y-m-d H:i:s'),
                        ]);
                        $_Email = $tmpEmail;

                        /** REPORT ANALYTIC */
                        //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                        /** REPORT ANALYTIC */
                        $trackBigBDM = $trackBigBDM . "->Email1ZBSuccess";
                    }
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                    /** REPORT ANALYTIC */
                }
                else
                {
                    $newpersonemail = PersonEmail::create([
                        'person_id' => $newPersonID,
                        'email' => $tmpEmail,
                        'email_encrypt' => $tmpMd5,
                        'permission' => 'T',
                        'zbvalidate' => null,
                    ]);
                    $_Email = $tmpEmail;
                    $trackBigBDM = $trackBigBDM . "->Email1ZBNotValidate";
                }
            }

            if (trim($_Email2) != '') 
            {
                $tmpEmail = strtolower(trim($_Email2));
                $tmpMd5 = md5($tmpEmail);

                // $zbcheck = $this->zb_validation($tmpEmail,"");
                $param = [
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'leadspeek_type' => $leadspeektype,
                    'md5param' => $tmpMd5,
                ];
                $zbcheck = $this->true_list_validation($tmpEmail,$param);
                
                // Handle both TrueList and ZeroBounce responses
                $isValid = false;
                $validationStatus = '';
                $apiType = '';
                if (isset($zbcheck->emails[0]->email_state)) {
                    $validationStatus = $zbcheck->emails[0]->email_state;
                    $apiType = 'truelist';
                    $isValid = ($zbcheck->emails[0]->email_state == "ok");
                } elseif (isset($zbcheck->status)) {
                    $validationStatus = $zbcheck->status;
                    $apiType = 'zerobounce';
                    $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                }
                if ($validationStatus !== '') {
                    if (!$isValid) {
                        /** PUT IT ON OPTOUT LIST */
                        $createoptout = OptoutList::create([
                            'email' => $tmpEmail,
                            'emailmd5' => md5($tmpEmail),
                            'blockedcategory' => 'zbnotvalid',
                            'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email2fromBigPIIDataNotExist',
                        ]);
                        /** PUT IT ON OPTOUT LIST */
                        $_Email2 = "";

                        if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                            $this->UpsertFailedLeadRecord([
                                'function' => __FUNCTION__,
                                'type' => 'blocked',
                                'blocked_type' => $apiType,
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email2fromBigPIIDataNotExist',
                                'leadspeek_api_id' => $leadspeek_api_id,
                                'email_encrypt' => $tmpMd5,
                                'leadspeek_type' => $leadspeektype,
                                'email' => $tmpEmail,
                                'status' => $validationStatus,
                            ]);                        
                        }

                        /** REPORT ANALYTIC */
                        //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                        /** REPORT ANALYTIC */
                        $trackBigBDM = $trackBigBDM . "->Email2ZBFailed";
                    }
                    else
                    {

                        $newpersonemail = PersonEmail::create([
                            'person_id' => $newPersonID,
                            'email' => $tmpEmail,
                            'email_encrypt' => $tmpMd5,
                            'permission' => 'T',
                            'zbvalidate' => date('Y-m-d H:i:s'),
                        ]);
                        $_Email2 = $tmpEmail;

                        /** REPORT ANALYTIC */
                        //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                        /** REPORT ANALYTIC */
                        $trackBigBDM = $trackBigBDM . "->Email2ZBSuccess";
                    }
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                    /** REPORT ANALYTIC */
                }
                else
                {
                    $newpersonemail = PersonEmail::create([
                        'person_id' => $newPersonID,
                        'email' => $tmpEmail,
                        'email_encrypt' => $tmpMd5,
                        'permission' => 'T',
                        'zbvalidate' => null,
                    ]);
                    $_Email2 = $tmpEmail;
                    $trackBigBDM = $trackBigBDM . "->Email2ZBNotValidate";
                }
            }

            if (trim($_Email) == "" && trim($_Email2) != "") 
            {
                $_Email = $_Email2;
                $_Email2 = "";
            }

            if (trim($_Email) == "" && trim($_Email2) == "") 
            {
                /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                /** REPORT ANALYTIC */

                /* WRITE UPSER FAILED LEAD RECORD */
                $this->UpsertFailedLeadRecord([
                    'function' => 'dataNotExistOnDBBIG',
                    'type' => 'blocked',
                    'blocked_type' => 'zerobounce',
                    'description' => 'blocked in zerobounce fetch bigBDM_MD5 function dataNotExistOnDBBIG',
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'email_encrypt' => $md5param,
                    'leadspeek_type' => $leadspeektype,
                ]);
                /* WRITE UPSER FAILED LEAD RECORD */
            }
            else
            {
                /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                /** REPORT ANALYTIC */
            }

            if (trim($_Phone) != "") 
            {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_Phone),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            if (trim($_Phone2) != "") 
            {
                /** INSERT PERSON_PHONES */
                $newpersonphone = PersonPhone::create([
                    'person_id' => $newPersonID,
                    'number' => $this->format_phone($_Phone2),
                    'type' => 'user',
                    'isConnected' => 'T',
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                    'permission' => 'F',
                ]);
                /** INSERT PERSON_PHONES */
            }

            /** INSERT INTO PERSON_ADDRESSES */
            $newpersonaddress = PersonAddress::create([
                'person_id' => $newPersonID,
                'street' => $_Address1,
                'unit' => $_Address2,
                'city' => $_City,
                'state' => $_State,
                'zip' => $_Zipcode,
                'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                'firstReportedDate' => date('Y-m-d'),
                'lastReportedDate' => date('Y-m-d'),
            ]);

            /** INSERT INTO PERSON_ADDRESSES */

            $_ID = $this->generateReportUniqueNumber();

            $new = array(
                "ID" => $_ID,
                "Email" => $_Email,
                "Email2" => $_Email2,
                "OriginalMD5" => $md5param,
                "IP" => $_IP,
                "Source" => $_Source,
                "OptInDate" => $_OptInDate,
                "ClickDate" => $_ClickDate,
                "Referer" => $_Referer,
                "Phone" => $_Phone,
                "Phone2" => $_Phone2,
                "FirstName" => $_FirstName,
                "LastName" => $_LastName,
                "Address1" => $_Address1,
                "Address2" => $_Address2,
                "City" => $_City,
                "State" => $_State,
                "Zipcode" => $_Zipcode,
                "PersonID" => $newPersonID,
                "Keyword" => $keyword,
                "Description" => $_Description,
                "LeadFrom" => 'bigbdmmd5',
            );

            if ($is_advance && isset($newPersonID))
            {
                //delete old and update new one
                if($personID != '')
                {
                    $padv = PersonAdvance::where('person_id','=',$personID)->delete();
                    $padv2 = PersonAdvance2::where('person_id','=',$personID)->delete();
                    $padv3 = PersonAdvance3::where('person_id','=',$personID)->delete();
                }

                $new_advance = [];

                $processBDM = $this->process_BDM_advance_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,$is_advance);
                $new_advance = isset($processBDM['data'])?$processBDM['data']:[];
                $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);

                $new = array_merge($new,$new_advance);

            }

            if($leadspeektype == 'b2b' && isset($newPersonID))
            {
                if($personID != '')
                {
                    $pb2b = PersonB2B::where('person_id','=',$personID)->delete();
                }
                $new_b2b = [];
                $processBDM = $this->process_BDM_B2B_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                $new_b2b = isset($processBDM['data'])?$processBDM['data']:[];
                $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                $new = array_merge($new,$new_b2b);
            }

                if ($is_local_custom['is_advance']) {
                    if($personID != '')
                    {
                        $padv = PersonAdvance::where('person_id','=',$personID)->delete();
                        $padv2 = PersonAdvance2::where('person_id','=',$personID)->delete();
                        $padv3 = PersonAdvance3::where('person_id','=',$personID)->delete();
                    }

                    $new_advance_custom = [];

                    if (!empty($is_local_custom['advance'])) {
                        $processBDM = $this->process_BDM_advance_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,true);
                        $new_advance_custom = isset($processBDM['data'])?$processBDM['data']:[];
                        $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                    }

                    $new = array_merge($new,$new_advance_custom);
                    // $new = array_merge($new,["local_advance_exist" => true]); //set advance charge

                }

                // if ($is_local_custom['is_b2b']) {
                //     if($personID != '')
                //     {
                //         $pb2b = PersonB2B::where('person_id','=',$personID)->delete();
                //     }
                //     $new_b2b_custom = [];
                //     if (!empty($is_local_custom['advance'])) {
                //     $processBDM = $this->process_BDM_B2B_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                //     $new_b2b_custom = isset($processBDM['data'])?$processBDM['data']:[];
                //     $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                //     }
                //     $new = array_merge($new,$new_b2b_custom);
                //     $new = array_merge($new,["local_b2b_exist" => true]); //set b2b charge

                // }

        } 
        else 
        {
            /** CHECK WITH BIG BDM PII */
            $bigBDM_PII = $this->bigBDM_PII($_fname,$_lname,$_address,$_zip,$md5param,$leadspeek_api_id,$leadspeektype);
            /** IF BIG BDM PII HAVE RESULT */

            if (count((array)$bigBDM_PII) > 0) 
            {
                /** REPORT ANALYTIC */
                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'bigbdmpii');
                /** REPORT ANALYTIC */
                $trackBigBDM = $trackBigBDM . "->BIGPII";
    
                foreach ($bigBDM_PII as $rd => $a) 
                {
                    $bigEmail = (isset($a[0]->Email))?$a[0]->Email:'';
                    $bigEmail = explode(",",$bigEmail);
    
                    $bigPhone = (isset($a[0]->Phone))?$a[0]->Phone:'';
                    $bigPhone = explode(",",$bigPhone);
    
                    $_FirstName = (isset($a[0]->First_Name))?$a[0]->First_Name:'';
                    $_LastName = (isset($a[0]->Last_Name))?$a[0]->Last_Name:'';
                    $_Email = $bigEmail[0];
                    $_Email2 = (isset($bigEmail[1]))?$bigEmail[1]:'';
                    $_Phone = $bigPhone[0];
                    $_Phone2 = (isset($bigPhone[1]))?$bigPhone[1]:'';
                    // $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                    if(isset($a[0]->Addr_Primary)){
                        $_Address1 = (isset($a[0]->Addr_Primary))?$a[0]->Addr_Primary:'';
                    }else{
                        $_Address1 = (isset($a[0]->Address))?$a[0]->Address:'';
                    }
                    if(isset($a[0]->Addr_Secondary)){
                        $_Address2 = (isset($a[0]->Addr_Secondary))?$a[0]->Addr_Secondary:'';
                    }
                    $_City =  (isset($a[0]->City))?$a[0]->City:'';
                    $_State = (isset($a[0]->State))?$a[0]->State:'';
                    $_Zipcode = (isset($a[0]->Zip))?$a[0]->Zip:'';
                }
    
                if ($personID != "") 
                {
                    /** CLEAN UP CURRENT DATABASE AND UPDATE NEW ONE */
                    $pad = PersonAddress::where('person_id','=',$personID)->delete();
                    $pname = PersonName::where('person_id','=',$personID)->delete();
                    $pphone = PersonPhone::where('person_id','=',$personID)->delete();
                    $pemail = PersonEmail::where('person_id','=',$personID)->delete();
                    $p = Person::where('id','=',$personID)->delete();
                    /** CLEAN UP CURRENT DATABASE AND UPDATE NEW ONE */
                }
    
                $uniqueID = uniqid();
                /** INSERT INTO DATABASE PERSON */
                $newPerson = Person::create([
                    'uniqueID' => $uniqueID,
                    'firstName' => $_FirstName,
                    'middleName' => '',
                    'lastName' => $_LastName,
                    'age' => '0',
                    'identityScore' => '0',
                    'lastEntry' => date('Y-m-d H:i:s'),
                ]);

                $newPersonID = $newPerson->id;
                /** INSERT INTO DATABASE PERSON */
    
                if (trim($_Email) != '') 
                {
                    $tmpEmail = strtolower(trim($_Email));
                    $tmpMd5 = md5($tmpEmail);

                    $param = [
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'leadspeek_type' => $leadspeektype,
                        'md5param' => $tmpMd5,
                    ];
                    $zbcheck = $this->true_list_validation($tmpEmail,$param);
                    // Handle both TrueList and ZeroBounce responses
                    $isValid = false;
                    $validationStatus = '';
                    $apiType = '';
                    if (isset($zbcheck->emails[0]->email_state)) {
                        $validationStatus = $zbcheck->emails[0]->email_state;
                        $apiType = 'truelist';
                        $isValid = ($zbcheck->emails[0]->email_state == "ok");
                    } elseif (isset($zbcheck->status)) {
                        $validationStatus = $zbcheck->status;
                        $apiType = 'zerobounce';
                        $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                    }
                    if ($validationStatus !== '') {
                        if (!$isValid) {                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $tmpEmail,
                                'emailmd5' => md5($tmpEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email1fromBigPIIDataNotExist',
                            ]);
                            /** PUT IT ON OPTOUT LIST */
                            $_Email = "";

                            if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                $this->UpsertFailedLeadRecord([
                                    'function' => __FUNCTION__,
                                    'type' => 'blocked',
                                    'blocked_type' => $apiType,
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email1fromBigPIIDataNotExist',
                                    'leadspeek_api_id' => $leadspeek_api_id,
                                    'email_encrypt' => $tmpMd5,
                                    'leadspeek_type' => $leadspeektype,
                                    'email' => $tmpEmail,
                                    'status' => $validationStatus,
                                ]);                        
                            }

                            /** REPORT ANALYTIC */
                            //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                            /** REPORT ANALYTIC */

                            $trackBigBDM = $trackBigBDM . "->Email1ZBFailed";
                        }
                        else
                        {

                            $newpersonemail = PersonEmail::create([
                                'person_id' => $newPersonID,
                                'email' => $tmpEmail,
                                'email_encrypt' => $tmpMd5,
                                'permission' => 'T',
                                'zbvalidate' => date('Y-m-d H:i:s'),
                            ]);

                            $_Email = $tmpEmail;

                            /** REPORT ANALYTIC */
                                //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                            /** REPORT ANALYTIC */
                            $trackBigBDM = $trackBigBDM . "->Email1ZBSuccess";
                        }
                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id, $leadspeektype, $apiType . '_details', $validationStatus);
                        /** REPORT ANALYTIC */
                    }
                    else
                    {
                        $newpersonemail = PersonEmail::create([
                            'person_id' => $newPersonID,
                            'email' => $tmpEmail,
                            'email_encrypt' => $tmpMd5,
                            'permission' => 'T',
                            'zbvalidate' => null,
                        ]);

                        $_Email = $tmpEmail;
                        $trackBigBDM = $trackBigBDM . "->Email1ZBNotValidate";
                    }
                }

                if (trim($_Email2) != '') 
                {
                    $tmpEmail = strtolower(trim($_Email2));
                    $tmpMd5 = md5($tmpEmail);

                    $param = [
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'leadspeek_type' => $leadspeektype,
                        'md5param' => $tmpMd5,
                    ];
                    $zbcheck = $this->true_list_validation($tmpEmail,$param);
                    // Handle both TrueList and ZeroBounce responses
                    $isValid = false;
                    $validationStatus = '';
                    $apiType = '';
                    if (isset($zbcheck->emails[0]->email_state)) {
                        $validationStatus = $zbcheck->emails[0]->email_state;
                        $apiType = 'truelist';
                        $isValid = ($zbcheck->emails[0]->email_state == "ok");
                    } elseif (isset($zbcheck->status)) {
                        $validationStatus = $zbcheck->status;
                        $apiType = 'zerobounce';
                        $isValid = !($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap");
                    }
                    if ($validationStatus !== '') {
                        if (!$isValid) {
                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $tmpEmail,
                                'emailmd5' => md5($tmpEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email2fromBigPIIDataNotExist',
                            ]);
                            /** PUT IT ON OPTOUT LIST */
                            $_Email2 = "";

                            if (isset($leadspeek_api_id) && isset($leadspeektype) && isset($tmpMd5)) {
                                $this->UpsertFailedLeadRecord([
                                    'function' => __FUNCTION__,
                                    'type' => 'blocked',
                                    'blocked_type' => $apiType,
                                    'description' => ucfirst($apiType) . ' Status: ' . $validationStatus . '|Email2fromBigPIIDataNotExist',
                                    'leadspeek_api_id' => $leadspeek_api_id,
                                    'email_encrypt' => $tmpMd5,
                                    'leadspeek_type' => $leadspeektype,
                                    'email' => $tmpEmail,
                                    'status' => $validationStatus,
                                ]);                        
                            }

                            /** REPORT ANALYTIC */
                            //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                            /** REPORT ANALYTIC */
                            $trackBigBDM = $trackBigBDM . "->Email2ZBFailed";
                        }
                        else
                        {

                            $newpersonemail = PersonEmail::create([
                                'person_id' => $newPersonID,
                                'email' => $tmpEmail,
                                'email_encrypt' => $tmpMd5,
                                'permission' => 'T',
                                'zbvalidate' => date('Y-m-d H:i:s'),
                            ]);

                            $_Email2 = $tmpEmail;

                            /** REPORT ANALYTIC */
                                //$this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                            /** REPORT ANALYTIC */
                            $trackBigBDM = $trackBigBDM . "->Email2ZBSuccess";
                        }
                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,$apiType . '_details',$validationStatus);
                        /** REPORT ANALYTIC */
                    }
                    else
                    {
                        $newpersonemail = PersonEmail::create([
                            'person_id' => $newPersonID,
                            'email' => $tmpEmail,
                            'email_encrypt' => $tmpMd5,
                            'permission' => 'T',
                            'zbvalidate' => null,
                        ]);

                        $_Email2 = $tmpEmail;
                        $trackBigBDM = $trackBigBDM . "->Email2ZBNotValidate";
                    }
                }

                if (trim($_Email) == "" && trim($_Email2) != "") 
                {
                    $_Email = $_Email2;
                    $_Email2 = "";
                }

                if (trim($_Email) == "" && trim($_Email2) == "") 
                {
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                    $trackBigBDM = $trackBigBDM . "->Email1andEmail2NotValid";
                    /** REPORT ANALYTIC */

                    /* WRITE UPSER FAILED LEAD RECORD */
                    $this->UpsertFailedLeadRecord([
                        'function' => 'dataNotExistOnDBBIG',
                        'type' => 'blocked',
                        'blocked_type' => 'zerobounce',
                        'description' => 'blocked in zerobounce fetch bigBDM_PII function dataNotExistOnDBBIG',
                        'leadspeek_api_id' => $leadspeek_api_id,
                        'email_encrypt' => $md5param,
                        'leadspeek_type' => $leadspeektype,
                    ]);
                    /* WRITE UPSER FAILED LEAD RECORD */
                }
                else
                {
                    /** REPORT ANALYTIC */
                    $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                    $trackBigBDM = $trackBigBDM . "->Email1orEmail2Valid";
                    /** REPORT ANALYTIC */
                }

                if (trim($_Phone) != "") 
                {
                    /** INSERT PERSON_PHONES */
                    $newpersonphone = PersonPhone::create([
                        'person_id' => $newPersonID,
                        'number' => $this->format_phone($_Phone),
                        'type' => 'user',
                        'isConnected' => 'T',
                        'firstReportedDate' => date('Y-m-d'),
                        'lastReportedDate' => date('Y-m-d'),
                        'permission' => 'F',
                    ]);
                    /** INSERT PERSON_PHONES */
                }

                if (trim($_Phone2) != "") 
                {
                    /** INSERT PERSON_PHONES */
                    $newpersonphone = PersonPhone::create([
                        'person_id' => $newPersonID,
                        'number' => $this->format_phone($_Phone2),
                        'type' => 'user',
                        'isConnected' => 'T',
                        'firstReportedDate' => date('Y-m-d'),
                        'lastReportedDate' => date('Y-m-d'),
                        'permission' => 'F',
                    ]);
                    /** INSERT PERSON_PHONES */
                }
    
                /** INSERT INTO PERSON_ADDRESSES */
                $newpersonaddress = PersonAddress::create([
                    'person_id' => $newPersonID,
                    'street' => $_Address1,
                    'unit' => $_Address2,
                    'city' => $_City,
                    'state' => $_State,
                    'zip' => $_Zipcode,
                    'fullAddress' => $_Address1 . ' ' . $_City . ',' . $_State . ' ' . $_Zipcode,
                    'firstReportedDate' => date('Y-m-d'),
                    'lastReportedDate' => date('Y-m-d'),
                ]);

                /** INSERT INTO PERSON_ADDRESSES */

                $_ID = $this->generateReportUniqueNumber();

                $new = array(
                    "ID" => $_ID,
                    "Email" => $_Email,
                    "Email2" => $_Email2,
                    "OriginalMD5" => $md5param,
                    "IP" => $_IP,
                    "Source" => $_Source,
                    "OptInDate" => $_OptInDate,
                    "ClickDate" => $_ClickDate,
                    "Referer" => $_Referer,
                    "Phone" => $_Phone,
                    "Phone2" => $_Phone2,
                    "FirstName" => $_FirstName,
                    "LastName" => $_LastName,
                    "Address1" => $_Address1,
                    "Address2" => $_Address2,
                    "City" => $_City,
                    "State" => $_State,
                    "Zipcode" => $_Zipcode,
                    "PersonID" => $newPersonID,
                    "Keyword" => $keyword,
                    "Description" => $_Description,
                    "LeadFrom" => 'bigbdmpii',
                );


                /** IF BIG BDM PII HAVE RESULT */
                if ($is_advance && isset($newPersonID)) 
                {
                    //delete old and update new one
                    if($personID != ''){
                        $padv = PersonAdvance::where('person_id','=',$personID)->delete();
                        $padv2 = PersonAdvance2::where('person_id','=',$personID)->delete();
                        $padv3 = PersonAdvance3::where('person_id','=',$personID)->delete();
                    }

                    $new_advance = [];

                    $processBDM = $this->process_BDM_advance_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,$is_advance);
                    $new_advance = isset($processBDM['data'])?$processBDM['data']:[];
                    $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);

                    $new = array_merge($new,$new_advance);

                }

                if($leadspeektype == 'b2b' && isset($newPersonID))
                {
                    if($personID != '')
                    {
                        $pb2b = PersonB2B::where('person_id','=',$personID)->delete();
                    }
                    $new_b2b = [];
                    $processBDM = $this->process_BDM_B2B_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                    $new_b2b = isset($processBDM['data'])?$processBDM['data']:[];
                    $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                    $new = array_merge($new,$new_b2b);
                }

                if ($is_local_custom['is_advance']) {
                    if($personID != '')
                    {
                        $padv = PersonAdvance::where('person_id','=',$personID)->delete();
                        $padv2 = PersonAdvance2::where('person_id','=',$personID)->delete();
                        $padv3 = PersonAdvance3::where('person_id','=',$personID)->delete();
                    }

                    $new_advance_custom = [];
                    if (!empty($is_local_custom['advance'])) {
                        $processBDM = $this->process_BDM_advance_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype,true);
                        $new_advance_custom = isset($processBDM['data'])?$processBDM['data']:[];
                        $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                    }
                    $new = array_merge($new,$new_advance_custom);
                    // $new = array_merge($new,["local_advance_exist" => true]); //set advance charge
                }

                // if ($is_local_custom['is_b2b']) {
                //     if($personID != '')
                //     {
                //         $pb2b = PersonB2B::where('person_id','=',$personID)->delete();
                //     }
                //     $new_b2b_custom = [];
                //     if (!empty($is_local_custom['advance'])) {
                //          $processBDM = $this->process_BDM_B2B_exist($newPersonID,$dataflow,$failedRecordID,$md5param,$leadspeek_api_id,$leadspeektype);
                //          $new_b2b_custom = isset($processBDM['data'])?$processBDM['data']:[];
                //          $executionTimeList = array_merge($executionTimeList, isset($processBDM['executionTimeList'])?$processBDM['executionTimeList']:[]);
                //     }
                //     $new = array_merge($new,$new_b2b_custom);
                //     $new = array_merge($new,["local_b2b_exist" => true]); //set b2b charge
                // }
            }
            else
            {
                $new = array();
                $trackBigBDM = $trackBigBDM . "->BIGBDMPIINOTFOUND";
            }
        }

        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */
        $frupdate = FailedRecord::find($failedRecordID);
        $frupdate->description = $frupdate->description . '|' . $trackBigBDM;
        $frupdate->save();
        /** UPDATE FOR DESCRIPTION ON FAILED RECORD */

        return [
            'data' => $new,
            'executionTimeList' => $executionTimeList,
        ];
    }

    private function dataNotExistOnDB($_fname,$_lname,$_email,$_phone,$_address,$_city,$_state,$_zip,$personID = "",$keyword = "",$dataflow = "",$failedRecordID = "",$md5param = "",$leadspeek_api_id = "",$leadspeektype = "") {
        date_default_timezone_set('America/Chicago');

        $new = array();

        $_ID = "";
        $_FirstName = $_fname;
        $_LastName = $_lname;
        $_Email = $_email;
        $_Email2 = "";
        $_IP = "";
        $_Source = "";
        $_OptInDate = date('Y-m-d H:i:s');
        $_ClickDate = date('Y-m-d H:i:s');
        $_Referer = "";
        $_Phone = "";
        $_Phone2 = "";
        $_Address1 = "";
        $_Address2 = "";
        $_City = "";
        $_State = "";
        $_Zipcode = "";
        $_Description = $dataflow . "dataNotExistOnDB|" . $failedRecordID;

        if ($personID != "") {
            /** GET PHONE DATA */
                $personPhone = PersonPhone::where('person_id','=',$personID)->where('permission','T')->first();
                //if (count($personPhone) > 0) {
                if ($personPhone) {
                    $_phone = $personPhone->number;
                }
            /** GET PHONE DATA */

            /** GET ADDRESS DATA */
                $personAddress = PersonAddress::where('person_id','=',$personID)->first();
                //if (count($personAddress) > 0) {
                if ($personAddress) {
                    $_address = $personAddress->street;
                    $_city = $personAddress->city;
                    $_state = $personAddress->state;
                    $_zip = $personAddress->zip;
                }
            /** GET ADDRESS DATA */
        }

        $de = $this->getDataEnrichment($_fname,$_lname,$_email,$_phone,$_address,$_city,$_state,$_zip);

        if (isset($de->message) && $de->message == "" && $de->isError == false) {

            if ($personID != "") {
                /** CLEAN UP CURRENT DATABASE AND UPDATE NEW ONE */
                $pad = PersonAddress::where('person_id','=',$personID)->delete();
                $pname = PersonName::where('person_id','=',$personID)->delete();
                $pphone = PersonPhone::where('person_id','=',$personID)->delete();
                $pemail = PersonEmail::where('person_id','=',$personID)->delete();
                $p = Person::where('id','=',$personID)->delete();
                /** CLEAN UP CURRENT DATABASE AND UPDATE NEW ONE */
            }

            /** GET PERSON DATA */
                $p_Age = $de->person->age;
                $p_firstName = $de->person->name->firstName;
                $p_middleName = $de->person->name->middleName;
                $p_lastName = $de->person->name->lastName;
                $p_identityScore = $de->identityScore;
            /** GET PERSON DATA */

            $uniqueID = uniqid();
            /** INSERT INTO DATABASE PERSON */
                $newPerson = Person::create([
                    'uniqueID' => $uniqueID,
                    'firstName' => $_fname,
                    'middleName' => '',
                    'lastName' => $_lname,
                    'age' => $p_Age,
                    'identityScore' => $p_identityScore,
                    'lastEntry' => date('Y-m-d H:i:s'),
                ]);

                $newPersonID = $newPerson->id;
            /** INSERT INTO DATABASE PERSON */

            $_ID = $this->generateReportUniqueNumber();
            $_FirstName = $_fname;
            $_LastName = $_lname;


            /** INSERT INTO PERSON NAMES */
                $newPersonName = PersonName::create([
                    'person_id' => $newPersonID,
                    'first_name' => $p_firstName,
                    'middle_name' => $p_middleName,
                    'last_name' => $p_lastName,
                    'endato_result' => 'T',
                ]);

                if (strtolower($_fname) != strtolower($p_firstName) || strtolower($_lname) != strtolower($p_lastName)) {
                    $newPersonName = PersonName::create([
                        'person_id' => $newPersonID,
                        'first_name' => $_fname,
                        'middle_name' => '',
                        'last_name' => $_lname,
                        'endato_result' => 'F',
                    ]);
                }
            /** INSERT INTO PERSON NAMES */

            /** GET EMAIL DATA*/
            $dataexist = false;
            $firstEmail = "";
            $secondEmail = "";
            $priorityEmail = "";
            $trackFirstEmail = "Email1fromED";

            $no = 0;
                foreach($de->person->emails as $em) {
                    $email = $em->email;
                    if ($no == 0) {
                        $firstEmail = $email;
                        $no++;
                    }else if ($no == 1) {
                        $secondEmail = $email;
                        $no++;
                    }
                    /** INSERT INTO PERSON_EMAILS */
                    /*$newpersonemail = PersonEmail::create([
                        'person_id' => $newPersonID,
                        'email' => $email,
                        'email_encrypt' => md5($email),
                        'permission' => 'T',
                    ]);*/
                    /** INSERT INTO PERSON_EMAILS */

                    /*if (trim($_email) == trim($email)) {
                        $dataexist = true;
                    }*/

                    if (trim($md5param) == trim(md5($email))) {
                        $priorityEmail = $email;
                    }
                }

                /** CHECK IF PRIORITY EMAIL STILL EMPTY THEN TRY TO GET FROM TOWER DATA */
                if ($priorityEmail == "" && isset($md5param) && trim($md5param) != "") {
                    $tower = $this->getTowerData("md5",$md5param);
                    if (isset($tower->target_email)) {
                        if ($tower->target_email != "") {
                            $tmpEmail = strtolower(trim($tower->target_email));
                            $tmpMd5 = md5($tmpEmail);

                            $secondEmail = $firstEmail;
                            $firstEmail = $tmpEmail;
                            $trackFirstEmail = "Email1fromTD";

                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'toweremail');
                            /** REPORT ANALYTIC */

                        }
                    }

                }else{
                    if (strtolower($priorityEmail) != strtolower($firstEmail)) {
                        $secondEmail = $firstEmail;
                        $firstEmail = $priorityEmail;
                    }
                    $trackFirstEmail = "Email1fromTD";
                }

                /** CHECK ZERO BOUNCE FOR VALID EMAIL */
                $invalidFirstEmail = false;
                $invalidSecondEmail = false;

                if(trim($firstEmail) != "") {
                    $zbcheck = $this->zb_validation($firstEmail,"");
                    if (isset($zbcheck->status)) {
                        // if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                        if($zbcheck->status != "valid") {
                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $firstEmail,
                                'emailmd5' => md5($firstEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => 'Zero Bounce Status : ' . $zbcheck->status . '|' . $trackFirstEmail,
                            ]);
                            /** PUT IT ON OPTOUT LIST */
                            $invalidFirstEmail = true;

                            /** REPORT ANALYTIC */
                                $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                            /** REPORT ANALYTIC */
                        }else{
                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                            /** REPORT ANALYTIC */
                        }
                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce_details',$zbcheck->status);
                        /** REPORT ANALYTIC */
                    }else{
                        $_Description = $_Description . "|ZB Error Email1 : " . $zbcheck->error;
                    }
                }

                if(trim($secondEmail) != "") {
                    $zbcheck = $this->zb_validation($secondEmail,"");
                    if (isset($zbcheck->status)) {
                        // if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                        if($zbcheck->status != "valid") {
                            /** PUT IT ON OPTOUT LIST */
                            $createoptout = OptoutList::create([
                                'email' => $secondEmail,
                                'emailmd5' => md5($secondEmail),
                                'blockedcategory' => 'zbnotvalid',
                                'description' => 'Zero Bounce Status : ' . $zbcheck->status . '|Email2fromED',
                            ]);
                            /** PUT IT ON OPTOUT LIST */
                            $invalidSecondEmail = true;

                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobouncefailed');
                            /** REPORT ANALYTIC */
                        }else{
                            /** REPORT ANALYTIC */
                            $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce');
                            /** REPORT ANALYTIC */
                        }
                        /** REPORT ANALYTIC */
                        $this->UpsertReportAnalytics($leadspeek_api_id,$leadspeektype,'zerobounce_details',$zbcheck->status);
                        /** REPORT ANALYTIC */
                    }else{
                        $_Description = $_Description . "|ZB Error Email2 : " . $zbcheck->error;
                    }
                }

                if ($invalidFirstEmail == true && $invalidSecondEmail == true) {
                    $firstEmail = "";
                    $secondEmail = "";
                }else if ($invalidFirstEmail == true && $invalidSecondEmail == false) {
                    $firstEmail = $secondEmail;
                    $secondEmail = "";
                }else if ($invalidFirstEmail == false && $invalidSecondEmail == true) {
                    $secondEmail = "";
                }
                /** CHECK ZERO BOUNCE FOR VALID EMAIL */

                $_Email = $firstEmail;
                $_Email2 = $secondEmail;

                if ($firstEmail != '') {
                    $newpersonemail = PersonEmail::create([
                        'person_id' => $newPersonID,
                        'email' => $firstEmail,
                        'email_encrypt' => md5($firstEmail),
                        'permission' => 'T',
                        'zbvalidate' => date('Y-m-d H:i:s'),
                    ]);
                }

                if ($secondEmail != '') {
                    $newpersonemail = PersonEmail::create([
                        'person_id' => $newPersonID,
                        'email' => $secondEmail,
                        'email_encrypt' => md5($secondEmail),
                        'permission' => 'T',
                        'zbvalidate' => date('Y-m-d H:i:s'),
                    ]);
                }

                /** CHECK IF PRIORITY EMAIL STILL EMPTY THEN TRY TO GET FROM TOWER DATA */

            /** GET EMAIL DATA */

            /** GET PHONE DATA*/
            $dataexist = false;
            $_phone = $this->format_phone($_phone);
            $firstPhone = "";
            $secondPhone = "";
            $no = 0;
                foreach($de->person->phones as $ph) {
                    $number = $ph->number;
                    $type = $ph->type;
                    $isConnected = ($ph->isConnected == true)?'T':'F';
                    $firstReportedDate = date('Y-m-d',strtotime($ph->firstReportedDate));
                    $lastReportedDate = date('Y-m-d',strtotime($ph->lastReportedDate));

                    if ($no == 0) {
                        $firstPhone = $number;
                        $no++;
                    }else if ($no == 1) {
                        $secondPhone = $number;
                        $no++;
                    }

                    /** INSERT INTO PERSON_PHONES */
                    $newpersonphone = PersonPhone::create([
                        'person_id' => $newPersonID,
                        'number' => $number,
                        'type' => $type,
                        'isConnected' => $isConnected,
                        'firstReportedDate' => $firstReportedDate,
                        'lastReportedDate' => $lastReportedDate,
                        'permission' => 'T',
                    ]);
                    /** INSERT INTO PERSON_PHONES */

                    if(trim($_phone) == trim($number)) {
                        $dataexist = true;
                    }
                }

                /** CHECK IF ORI PHONE EXIST */
                    if ($dataexist == false && trim($_phone) != "") {
                        $newpersonemail = PersonPhone::create([
                            'person_id' => $newPersonID,
                            'number' => $_phone,
                            'type' => 'user',
                            'isConnected' => 'T',
                            'firstReportedDate' => date('Y-m-d'),
                            'lastReportedDate' => date('Y-m-d'),
                            'permission' => 'F',
                        ]);

                        if ($firstPhone != "") {
                            $_Phone = $firstPhone;
                        }

                        if ($secondPhone != "") {
                            $_Phone2 = $secondPhone;
                        }
                    }
                /** CHECK IF ORI PHONE EXIST */

            /** GET PHONE DATA */

            $_Phone = (isset($de->person->phones[0]->number))?$de->person->phones[0]->number:'';
            $_Phone2 = (isset($de->person->phones[1]->number))?$de->person->phones[1]->number:'';

            /** GET ADDRESS DATA*/
            $dataexist = false;
                foreach($de->person->addresses as $ad) {
                    $street = $ad->street;
                    $unit = $ad->unit;
                    $city = $ad->city;
                    $state = $ad->state;
                    $zip = $ad->zip;
                    $firstReportedDate = date('Y-m-d',strtotime($ad->firstReportedDate));
                    $lastReportedDate = date('Y-m-d',strtotime($ad->lastReportedDate));

                    /** INSERT INTO PERSON_ADDRESSES */
                    $newpersonaddress = PersonAddress::create([
                        'person_id' => $newPersonID,
                        'street' => $street,
                        'unit' => $unit,
                        'city' => $city,
                        'state' => $state,
                        'zip' => $zip,
                        'fullAddress' => $street . ' ' . $city . ',' . $state . ' ' . $zip,
                        'firstReportedDate' => $firstReportedDate,
                        'lastReportedDate' => $lastReportedDate,
                    ]);
                    /** INSERT INTO PERSON_ADDRESSES */

                    if(trim($_address) == trim($street)) {
                        $dataexist = true;
                    }
                }

                /** CHECK IF ORI PHONE EXIST */
                    if ($dataexist == false && (trim($_address) != "" || trim($_city) != "" || trim($_state) != "" || trim($_zip) != "")) {
                        $newpersonaddress = PersonAddress::create([
                            'person_id' => $newPersonID,
                            'street' => $_address,
                            'unit' => 'user',
                            'city' => $_city,
                            'state' => $_state,
                            'zip' => $_zip,
                            'fullAddress' => $_address . ' ' . $_city . ',' . $_state . ' ' . $_zip,
                            'firstReportedDate' => date('Y-m-d'),
                            'lastReportedDate' => date('Y-m-d'),
                        ]);
                    }
                /** CHECK IF ORI PHONE EXIST */

            /** GET ADDRESS DATA*/

            $_Address1 = (isset($de->person->addresses[0]->street))?$de->person->addresses[0]->street:'';
            $_City = (isset($de->person->addresses[0]->city))?$de->person->addresses[0]->city:'';
            $_State = (isset($de->person->addresses[0]->state))?$de->person->addresses[0]->state:'';
            $_Zipcode = (isset($de->person->addresses[0]->zip))?$de->person->addresses[0]->zip:'';

            $new = array(
                "ID" => $_ID,
                "Email" => $_Email,
                "Email2" => $_Email2,
                "OriginalMD5" => $md5param,
                "IP" => $_IP,
                "Source" => $_Source,
                "OptInDate" => $_OptInDate,
                "ClickDate" => $_ClickDate,
                "Referer" => $_Referer,
                "Phone" => $_Phone,
                "Phone2" => $_Phone2,
                "FirstName" => $_FirstName,
                "LastName" => $_LastName,
                "Address1" => $_Address1,
                "Address2" => $_Address2,
                "City" => $_City,
                "State" => $_State,
                "Zipcode" => $_Zipcode,
                "PersonID" => $newPersonID,
                "Keyword" => $keyword,
                "Description" => $_Description,
            );

        }else{
            $new = array();
        }

        return $new;
    }

    private function format_phone(string $phone_no) {
        return preg_replace(
            "/.*(\d{3})[^\d]{0,7}(\d{3})[^\d]{0,7}(\d{4})/",
            '($1) $2-$3',
            $phone_no
        );
    }



    /** STRIPE WEBHOOK */
    public function stripe(Request $request) {
        $stripe = new StripeClient([
            'api_key' => config('services.stripe.secret'),
            'stripe_version' => '2020-08-27'
        ]);

        // retrieve the request's body and parse it as JSON
        $body = @file_get_contents('php://input');
        $event_json = json_decode($body);

        // for extra security, retrieve from the Stripe API
        $event_id = $event_json->id;

        $event = $stripe->events->retrieve($event_id,[]);

        /** payment_intent.succeeded */
        if($event->type == 'payment_intent.succeeded') {
            $this->payment_success($event->data->object);
        }
        /** payment_intent.succeeded */

        /** payment_intent.payment_failed */
        if($event->type == 'payment_intent.payment_failed') {
            $this->payment_failed($event->data->object);
        }
        /** payment_intent.payment_failed */

        /** payment_intent.requires_action */
        if($event->type == 'payment_intent.requires_action') {
            //$this->payment_requires_action($event->data->object);
        }
        /** payment_intent.requires_action */
    }

    private function payment_success($obj) {
        $paymentID = (isset($obj->id))?$obj->id:'';
        $customerID = (isset($obj->customer))?$obj->customer:'';
        $invoiceID = (isset($obj->invoice))?$obj->invoice:'';
        $chargeID = (isset($obj->charges->data[0]->id))?$obj->charges->data[0]->id:'';
        $reason = (isset($obj->charges->data[0]->outcome->reason))?$obj->charges->data[0]->outcome->reason:'';
        $msg = (isset($obj->charges->data[0]->outcome->seller_message))?$obj->charges->data[0]->outcome->seller_message:'';
        $last4digit = (isset($obj->charges->data[0]->payment_method_details->card->last4))?$obj->charges->data[0]->payment_method_details->card->last4:'';
        $cardtype = (isset($obj->charges->data[0]->payment_method_details->card->brand))?$obj->charges->data[0]->payment_method_details->card->brand:'';
        $transactionDate = (isset($obj->created))?$this->format_stripe_timestamp($obj->created):'';
        $receipt_email = (isset($obj->receipt_email))?$obj->receipt_email:'';
    }

    private function payment_failed($obj) {
        $paymentID = (isset($obj->id))?$obj->id:'';
        $customerID = (isset($obj->customer))?$obj->customer:'';
        $invoiceID = (isset($obj->invoice))?$obj->invoice:'';
        $chargeID = (isset($obj->charges->data[0]->id))?$obj->charges->data[0]->id:'';
        $reason = (isset($obj->charges->data[0]->outcome->reason))?$obj->charges->data[0]->outcome->reason:'';
        $msg = (isset($obj->charges->data[0]->outcome->seller_message))?$obj->charges->data[0]->outcome->seller_message:'';
        $last4digit = (isset($obj->charges->data[0]->payment_method_details->card->last4))?$obj->charges->data[0]->payment_method_details->card->last4:'';
        $cardtype = (isset($obj->charges->data[0]->payment_method_details->card->brand))?$obj->charges->data[0]->payment_method_details->card->brand:'';
        $transactionDate = (isset($obj->created))?$this->format_stripe_timestamp($obj->created):'';
        $receipt_email = (isset($obj->receipt_email))?$obj->receipt_email:'';
        $lperror_code = (isset($obj->last_payment_error->code))?$obj->last_payment_error->code:'';
        $lperror_msg = (isset($obj->last_payment_error->message))?$obj->last_payment_error->message:'';

        $details = [
            'errormsg'  => 'Stripe Payment Failed For Customer ID : ' . $customerID . ' Payment ID :' . $paymentID . ' (' . $reason . ')',
        ];

        $from = [
            'address' => 'newleads@leadspeek.com',
            'name' => 'stripe error',
            'replyto' => 'newleads@leadspeek.com',
        ];

        $this->send_email(array('serverlogs@sitesettingsapi.com'),'EMM-Stripe Payment Failed For Customer ID : ' . $customerID,$details,array(),'emails.tryseramatcherrorlog',$from,'');
        //$this->send_email('serverlogs@sitesettingsapi.com','Stripe Payment Failed For Customer ID : ' . $customerID,$details,array(),'emails.tryseramatcherrorlog');

    }

    public function cleanmasteremailzerobounce(Request $request) {
        date_default_timezone_set('America/Chicago');
        $chkdate = Carbon::now()->subDays(7)->toDateTimeString();

            $chkEmail = PersonEmail::select('id','email')
                                //->where('zbvalidate','=','')
                                ->whereNull('zbvalidate')
                                ->orWhere('zbvalidate','<=',$chkdate)
                                ->offset(0)
                                ->limit(100)
                                ->get();
        foreach($chkEmail as $chk) {
            $_Email = $chk['email'];

            $zbcheck = $this->true_list_validation($_Email);
            if (isset($zbcheck->emails[0]->email_state)) {
                // if($zbcheck->status == "invalid" || $zbcheck->status == "catch-all" || $zbcheck->status == "abuse" || $zbcheck->status == "do_not_mail" || $zbcheck->status == "spamtrap") {
                if($zbcheck->emails[0]->email_state != "ok") {
                    /** PUT IT ON OPTOUT LIST */
                    $createoptout = OptoutList::create([
                        'email' => $_Email,
                        'emailmd5' => md5($_Email),
                        'blockedcategory' => 'zbnotvalid',
                        'description' => 'True List Status : ' . $zbcheck->emails[0]->email_state,
                    ]);
                    /** PUT IT ON OPTOUT LIST */

                    /** REMOVE THE EMAIL FROM DATABASE */
                    $delEmail = PersonEmail::where('id','=',$chk['id'])->delete();
                    /** REMOVE THE EMAIL FROM DATABASE */
                }else{
                    $updateEmailValidate = PersonEmail::find($chk['id']);
                    $updateEmailValidate->zbvalidate = date('Y-m-d H:i:s');
                    $updateEmailValidate->save();
                }
            }
        }
    }

    /** TO SEND LEADS INTO SENDGRID ACCOUNT */

    public function sendContactToSendgrid($_sendgrid_api_key,$email,$firstname,$lastname,$address1,$address2,$city,$state,$zipcode,$phoneno,$email2,$keyword="",$url="",$leadspeek_api_id = "",$leadspeek_type = "",$md5param = ""){
        $http = new \GuzzleHttp\Client;
        $apiEndpoint = "https://api.sendgrid.com/v3/marketing/contacts";

        $_alternate_emails = array();
        if (trim($email2) != "") {
            $_alternate_emails[] = $email2;
        }else{
            $_alternate_emails = array();
        }


        $contactData = [
                'email' => $email,
                'alternate_emails' => $_alternate_emails,
                'first_name' => $firstname,
                'last_name' => $lastname,
                'address_line_1' => $address1,
                'address_line_2' => $address2,
                'city' => $city,
                'state_province_region' => $state,
                'postal_code' => $zipcode,
                'phone_number' => (string)$phoneno,
                'keyword' => $keyword,
                'url' => $url
        ];



        $dataOptions = [
            'headers' => [
                'Authorization' => 'Bearer ' . $_sendgrid_api_key,
                'Content-Type' => 'application/json'
            ],
            'json' => [
                'contacts' => [$contactData]
            ]
        ];

        try {
            $getcontact = $http->put($apiEndpoint,$dataOptions);
        }catch(Exception $e) {
            $message = $e->getMessage();
            Log::warning('sendContactToSendgrid (' . $email . ') error add msg :' . $message);

            /* WRITE UPSER FAILED LEAD RECORD */
            $this->UpsertFailedLeadRecord([
                'function' => 'sendContactToSendgrid',
                'type' => 'blocked',
                'blocked_type' => 'sendgrid',
                'description' => $message,
                'leadspeek_api_id' => $leadspeek_api_id,
                'leadspeek_type' => $leadspeek_type,
                'email_encrypt' => $md5param,
                'data_lead' => json_encode($contactData)
            ]);
            /* WRITE UPSER FAILED LEAD RECORD */
        }
    }

    public function sendContactToSendgridList($_sendgrid_api_key,$list,$email,$firstname,$lastname,$address1,$address2,$city,$state,$zipcode,$phoneno,$email2,$keyword="",$url="",$leadspeek_api_id = "",$leadspeek_type = "",$md5param = ""){
        $http = new \GuzzleHttp\Client;
        $apiEndpoint = "https://api.sendgrid.com/v3/marketing/contacts";

        $_alternate_emails = array();
        if (trim($email2) != "") {
            $_alternate_emails[] = $email2;
        }else{
            $_alternate_emails = array();
        }

        $contactData = [
            'email' => $email,
            'alternate_emails' => $_alternate_emails,
            'first_name' => $firstname,
            'last_name' => $lastname,
            'address_line_1' => $address1,
            'address_line_2' => $address2,
            'city' => $city,
            'state_province_region' => $state,
            'postal_code' => $zipcode,
            'phone_number' => (string)$phoneno,
            'keyword' => $keyword,
            'url' => $url
            ];

        $dataOptions = [
            'headers' => [
                'Authorization' => 'Bearer ' . $_sendgrid_api_key,
                'Content-Type' => 'application/json'
            ],
            'json' => [
                'list_ids' => [$list],
                'contacts' => [$contactData]
            ]
        ];

        try {
            $getcontact = $http->put($apiEndpoint,$dataOptions);
        }catch(Exception $e) {
            $message = $e->getMessage();
            Log::warning('sendContactToSendgridList (' . $email . ' | LIST : ' . $list . ') error add msg :' . $e);
        
            /* WRITE UPSER FAILED LEAD RECORD */
            $contactData['list_ids'] = $list;
            $this->UpsertFailedLeadRecord([
                'function' => 'sendContactToSendgridList',
                'type' => 'blocked',
                'blocked_type' => 'sendgrid',
                'description' => $message,
                'leadspeek_api_id' => $leadspeek_api_id,
                'leadspeek_type' => $leadspeek_type,
                'email_encrypt' => $md5param,
                'data_lead' => json_encode($contactData)
            ]);
            /* WRITE UPSER FAILED LEAD RECORD */
        }

    }

     /** TO SEND LEADS INTO SENDGRID ACCOUNT */

     protected function NewKartraLead($company_id,$campaign_id,$transaction_date,$first_name,$last_name,$email,$phone,$address,$city,$state,$zip,$website,$phone2,$email2,$address2,$keyword,$leadspeek_api_id = "",$leadspeek_type = "",$md5param = ""){

            $company_id = (isset($company_id))?$company_id:'';
            $listAndTag = ListAndTag::select('list','tag')
                                    //->where("company_id","=",$company_id)
                                    ->where("campaign_id","=",$campaign_id)
                                    ->where("kartra_is_active","=","1")
                                    ->first();

            if ($listAndTag) {

                $tags=[];  $tags = json_decode($listAndTag->tag );
                $taglist=[];  foreach ($tags as $key => $tag) {array_push($taglist, ['cmd' => 'assign_tag', 'tag_name' =>$tag]);}
                #
                $leadLists = json_decode($listAndTag->list );
                $leadList=[];  foreach ($leadLists as $key => $listname) {array_push($leadList, ['cmd' => 'subscribe_lead_to_list', 'list_name' =>$listname]);}
                array_push($taglist, $leadList[0]);
                #
                array_push($taglist,  ['cmd' => 'subscribe_lead_to_list', 'list_name' =>"mynewlist"]);
                array_push($taglist,  ['cmd' => 'create_lead']);

                $LeadData= [
                    'transaction_date' => $transaction_date,
                    'first_name' => $first_name,
                    'last_name' => $last_name,
                    'email' => $email,
                    'phone' => $phone,
                    'address' => $address,
                    'city' => $city,
                    'state' => $state,
                    'zip' => $zip,
                    'website'=>   $website,
                ];
                $custom_fields= [
                    ['field_identifier' => 'keyword','field_value' => $keyword ,],
                    ['field_identifier' => 'secondphone','field_value' => $phone2 ,],
                    ['field_identifier' => 'secondemail','field_value' => $email2 ,],
                    ['field_identifier' => 'secondaddress','field_value' => $address2 ,],
                ];

                $LeadData["custom_fields"]=$custom_fields;
                #
                   $actions=   $taglist;
                return $list = $this->kartrLeadCreater($actions,$LeadData,$leadspeek_api_id,$leadspeek_type,$md5param);
                #
            }
     }

    protected function kartrLeadCreater($actions,$lead,$leadspeek_api_id = "",$leadspeek_type = "",$md5param = ""){
            // Initialize cURL session
            $ch = curl_init();
            // Set the API endpoint
            $api_endpoint = "https://app.kartra.com/api";
            // Set the POST data with your API credentials and action
            $post_data =[
                            'app_id' =>  config('services.kartra.AppID'),
                            'api_key' => $this->api_key,
                            'api_password' => $this->api_password,
                            'lead' => $lead,
                            'actions' =>$actions
                    ];
            // Configure cURL options
            $curl_options = [
                CURLOPT_URL => $api_endpoint,
                CURLOPT_POST => true,
                CURLOPT_POSTFIELDS => http_build_query($post_data), // Convert the array to URL-encoded format
                CURLOPT_RETURNTRANSFER => true, // Return the response as a string
            ];
            // Apply cURL options
            curl_setopt_array($ch, $curl_options);
            // Execute the cURL request
            $server_output = curl_exec($ch);
            // Check for errors
            if (curl_errno($ch)) {
                Log::warning('cURL error: ' . curl_error($ch));

                /* WRITE UPSER FAILED LEAD RECORD */
                $this->UpsertFailedLeadRecord([
                    'function' => 'kartrLeadCreater',
                    'type' => 'blocked',
                    'blocked_type' => 'kartra',
                    'description' => curl_error($ch),
                    'leadspeek_api_id' => $leadspeek_api_id,
                    'leadspeek_type' => $leadspeek_type,
                    'email_encrypt' => $md5param,
                    'data_lead' => json_encode($lead)
                ]);
                /* WRITE UPSER FAILED LEAD RECORD */
            } else {
                // Process the server output as needed
                Log::warning('kartaleadcreate curl : ' . $server_output);
                return  json_decode($server_output, true); // 'true' for associative arrays
            }
            // Close the cURL session
            curl_close($ch);
    }

    /** FUNCTION THAT RELATED WITH TOPUP / PREPAID*/
    public function stop_continual_topup($_lp_user_id = "")
    {
        if ($_lp_user_id != "") {
            /* UPDATE STOPCONTINUE IN TOPUP TO F */
            $data = Topup::where('lp_user_id', $_lp_user_id)
                        ->where('topupoptions', 'continual')
                        ->where('topup_status', '<>', 'done')
                        ->get();

            foreach($data as $d) 
            {
                // ubah stop_continue menjadi 'T' 
                $d->stop_continue = 'F';
                $d->save();
            }
            /* UPDATE STOPCONTINUE IN TOPUP TO F */


            /* UPDATE STOPCONTINUE IN LEADSPEEK USER TO F */
            $leadspeekUser = LeadspeekUser::where('id', $_lp_user_id)->first();
            $leadspeekUser->stopcontinual = 'F';
            $leadspeekUser->save();
            /* UPDATE STOPCONTINUE IN LEADSPEEK USER TO F */
        }
    }
    /** FUNCTION THAT RELATED WITH TOPUP / PREPAID */

    /** FUNCTION Format Company Name */
    function formatTxt($name, $type, $label) {
        // info('fmt Txt : '.$label);
        if($type == 'b2b') {
            if($label == 'company_email' || $label == 'linkedin' || $label == 'company_website') {
                return strtolower($name);
            }

            $exceptions = ['INC', 'CORP', 'CO', 'LLC', 'LTD', 'LP', 'LLP', 'PLC', 'PC', 'PA', 'PLLC', 'S CORP', 'C CORP'];
            $words = explode(' ', strtolower($name));
            $formatted = [];
        
            foreach ($words as $word) {
                $upperWord = strtoupper($word);
                if (in_array($upperWord, $exceptions)) {
                    $formatted[] = $upperWord;
                } else {
                    $formatted[] = ucfirst($word);
                }
            }
        
            return implode(' ', $formatted);
        } else  {
            return $name;
        }
        
    }
    /** END FUNCTION Format Company Name */

    /** FUNCTION INSERT AGENCYZOOM */
    public function processAgencyZoom($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="")
    {
        // info(__FUNCTION__);
        try 
        {
            date_default_timezone_set('America/Chicago');

            // variable
            $_company_id = $cl['company_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
            $_leadspeek_api_id = $cl['leadspeek_api_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];

            $chkAgencyZoom = IntegrationSettings::select('api_key', 'enable_sendgrid')
                                                ->where('company_id', '=', $_company_id)
                                                ->where('integration_slug', 'agencyzoom')
                                                ->where('enable_sendgrid', 1)
                                                ->first();

            $campaign = LeadspeekUser::select('leadspeek_users.agencyzoom_is_active', 'leadspeek_users.agencyzoom_webhook')
                                     ->where('leadspeek_api_id', '=', $_leadspeek_api_id)
                                     ->where('agencyzoom_is_active', 1)
                                     ->first();
            // variable
        
            if ($chkAgencyZoom && !empty($chkAgencyZoom->api_key) && $chkAgencyZoom->enable_sendgrid == 1)
            {
                $webhook = (isset($campaign->agencyzoom_webhook) && !empty($campaign->agencyzoom_webhook)) ? 
                           (explode('|', $campaign->agencyzoom_webhook)) :
                           (explode('|', $chkAgencyZoom->api_key)) ;
                if ($campaign && $campaign->agencyzoom_is_active == 1) 
                {
                    $startAgencyZoomTime = microtime(true);

                    foreach ($matches as $row) 
                    {
                        $_Phone = $row->Phone;
                        $_Phone2 = $row->Phone2;
                        $_Address1 = $row->Address1;
                        $_Address2 = $row->Address2;
                        $_City = $row->City;
                        $_State = $row->State;
                        $_Zipcode = $row->Zipcode;
                        $_Email1 = $row->Email;
                        $_Email2 = $row->Email2;
                        $_keyword = $row->Keyword;
                        $_CompanyName = "";

                        if ($cl['leadspeek_type'] === 'b2b') 
                        {
                            $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                            $_Phone2 = '';
                            $_CompanyName = (isset($row->CompanyName) && !empty($row->CompanyName)) ? $row->CompanyName : '';
                        }
                        if ($phoneenabled == 'F')
                        {
                            $_Phone = '';
                            $_Phone2 = '';
                        }
                        if ($homeaddressenabled == 'F')
                        {
                            $_Address1 = '';
                            $_Address2 = '';
                            $_City = '';
                            $_State = '';
                            $_Zipcode = '';
                        }

                        try 
                        {
                            foreach ($webhook as $url) 
                            {
                                $this->agencyzoom_sendrecord(
                                    $url,
                                    ucfirst(strtolower($row->FirstName)),
                                    ucfirst(strtolower($row->LastName)),
                                    $_CompanyName,
                                    $_Email1,
                                    $_Email2,
                                    $_Phone,
                                    $_Phone2,
                                    $_Address1,
                                    $_Address2,
                                    $_City,
                                    $_State,
                                    $_Zipcode,
                                    $_keyword,
                                    $_leadspeek_api_id,
                                    $leadspeek_type,
                                    $md5param,
                                );
                            }
                        }
                        catch (\Throwable $e)
                        {
                            Log::error("Error creating new Agency Zoom lead for CampaignID {$_leadspeek_api_id}", [
                                'row' => $row,
                                'error' => $e->getMessage()
                            ]);
                        }
                    }

                    $endAgencyZoomTime = microtime(true);  

                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startAgencyZoomDate = Carbon::createFromTimestamp($startAgencyZoomTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endAgencyZoomDate = Carbon::createFromTimestamp($endAgencyZoomTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')

                    $totalAgencyZoomTime = $endAgencyZoomTime - $startAgencyZoomTime;
                    $totalAgencyZoomTime = number_format($totalAgencyZoomTime,2,'.','');

                    $executionTimeList = [
                        'start_execution_time' => $startAgencyZoomDate,
                        'end_execution_time' => $endAgencyZoomDate,
                        'total_execution_time' => $totalAgencyZoomTime,
                    ];

                    return [
                        'executionTimeList' => $executionTimeList
                    ]; 
                }
            }
        }
        catch (\Throwable $e)
        {
            Log::error("public function processAgencyZoom error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }
    }
    /** FUNCTION INSERT AGENCYZOOM */

    /** FUNCTION INSERT ZAPIER */
    public function processZapier($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="",$is_local_custom=[]) 
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            //// variable tampungan
            $_company_id = $cl['company_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
            $_leadspeek_api_id = $cl['leadspeek_api_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
    
            $is_advance = false;
            if ($leadspeek_type == 'enhance' || $leadspeek_type == 'b2b') {
                $campaign_advance_information = LeadspeekUser::select('advance_information')->where('leadspeek_api_id',$leadspeek_api_id)->first();
                if (isset($campaign_advance_information->advance_information) && !empty($campaign_advance_information->advance_information) && trim($campaign_advance_information->advance_information) != '') {
                    $is_advance = true;
                }
            }
    
            $chkZap = IntegrationSettings::select('api_key', 'enable_sendgrid')
                    ->where('company_id', '=', $_company_id)
                    ->where('integration_slug', 'zapier')
                    ->where('enable_sendgrid', 1)
                    ->first();
    
            $campaign = LeadspeekUser::select('leadspeek_users.zap_tags', 'leadspeek_users.zap_is_active', 'leadspeek_users.zap_webhook')
                    ->where('leadspeek_api_id', '=', $_leadspeek_api_id)
                    ->where('zap_is_active', 1)
                    ->first();
    
            if ($chkZap && $chkZap->api_key != '' && $chkZap->enable_sendgrid == 1) {
                $campaign_type = $cl['leadspeek_type'] == 'local' ? 'Site ID' : 'Search ID' ;
                $custom_side_menu = $this->getcompanysetting($cl['company_parent'], 'customsidebarleadmenu');
                if (!empty($custom_side_menu)) {
                    $campaign_type = ($cl['leadspeek_type'] == 'local') ? $custom_side_menu->local->name : $custom_side_menu->locator->name ;
                    if ($cl['leadspeek_type'] == 'enhance') {
                        $campaign_type = (isset($custom_side_menu->enhance->name))?$custom_side_menu->enhance->name:'Enhance ID';
                    }
                    if ($cl['leadspeek_type'] == 'b2b') {
                        $campaign_type = (isset($custom_side_menu->b2b->name))?$custom_side_menu->b2b->name:'B2B ID';
                    }
                }
                $webhook = ($campaign && $campaign->zap_webhook != '') ? explode('|',$campaign->zap_webhook) : explode('|',$chkZap->api_key);
                $tags = ($campaign && !empty($campaign->zap_tags)) ? json_decode($campaign->zap_tags) : '';
                if ($campaign && $campaign->zap_is_active == 1) {
                    $startZapierTime = microtime(true);
                    
                    foreach ($matches as $row) {
                        $_Phone = $row->Phone;
                        $_Phone2 = $row->Phone2;
                        $_Address1 = $row->Address1;
                        $_Address2 = $row->Address2;
                        $_City = $row->City;
                        $_State = $row->State;
                        $_Zipcode = $row->Zipcode;
                        $_Email1 = $row->Email;
                        $_Email2 = $row->Email2;

                        if ($cl['leadspeek_type'] === 'b2b') {
                            $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                            $_Phone2 = '';
                        }

                        if ($phoneenabled == 'F') {
                            $_Phone = '';
                            $_Phone2 = '';
                        }
                        if ($homeaddressenabled == 'F') {
                            $_Address1 = '';
                            $_Address2 = '';
                            $_City = '';
                            $_State = '';
                            $_Zipcode = '';
                        }

                        $keyword = '';
                        $url = '';
                        if ($cl['leadspeek_type'] === 'local') {
                            $url = $row->Keyword;
                        } elseif ($cl['leadspeek_type'] === 'locator') {
                            $keyword = $row->Keyword;
                        }else{
                            $keyword = $row->Keyword;
                        }

                        $additional_fields = [];
                        if($cl['leadspeek_type'] === 'b2b'){
                            $_Phone = '';
                            $_Phone2 = '';
                            $additional_fields = [
                                'EmployeeID' => (isset($row->EmployeeID) && !empty($row->EmployeeID)) ? $row->EmployeeID : '',
                                'CompanyName' => (isset($row->CompanyName) && !empty($row->CompanyName)) ? $row->CompanyName : '',
                                'CompanyPhone' => (isset($row->Phone1Company) && !empty($row->Phone1Company)) ? $row->Phone1Company : '',
                                'CompanyWebsite' => (isset($row->CompanyWebsite) && !empty($row->CompanyWebsite)) ? $row->CompanyWebsite : '',
                                'NumEmployees' => (isset($row->NumEmployees) && !empty($row->NumEmployees)) ? $row->NumEmployees : '',
                                'SalesVolume' => (isset($row->SalesVolume) && !empty($row->SalesVolume)) ? $row->SalesVolume : '',
                                'YearFounded' => (isset($row->YearFounded) && !empty($row->YearFounded)) ? $row->YearFounded : '',
                                'JobTitle' => (isset($row->JobTitle) && !empty($row->JobTitle)) ? $row->JobTitle : '',
                                'Level' => (isset($row->Level) && !empty($row->Level)) ? $row->Level : '',
                                'JobFunction' => (isset($row->JobFunction) && !empty($row->JobFunction)) ? $row->JobFunction : '',
                                'HeadquartersBranch' => (isset($row->HeadquartersBranch) && !empty($row->HeadquartersBranch)) ? $row->HeadquartersBranch : '',
                                'NaicsCode' => (isset($row->NaicsCode) && !empty($row->NaicsCode)) ? $row->NaicsCode : '',
                                'LastSeenDate' => (isset($row->LastSeenDate) && !empty($row->LastSeenDate)) ? $row->LastSeenDate : '',
                                'LinkedIn' => (isset($row->LinkedIn) && !empty($row->LinkedIn)) ? $row->LinkedIn : '',
                            ];
                        }

                        if ($is_local_custom['is_advance']) {
                            $campaignInformations = DB::table('campaign_informations')
                                                ->select('id','type')
                                                ->where('status', 'active')
                                                ->whereIn('campaign_type',['local_adv'])
                                                ->orderBy('start_index', 'asc')
                                                ->get();
            
                            $categories = [
                                'identification' => ['GenderAux', 'Generation', 'MaritalStatus'],
                                'contactInformation' => ['Phone3', 'TaxBillInformation'],
                                'houseAndRealEstate' => ['DwellingType', 'HomeOwner', 'HomeOwnerOrdinal', 'LengthOfResidence', 'HomePrice', 'HomeValue', 'MedianHomeValue', 'LivingSqft', 'YrBuiltOrig', 'YrBuiltRange', 'LotNumber', 'LegalDescription', 'LandSqft', 'GarageSqft', 'Subdivision', 'ZoningCode'],
                                'financialInformation' => ['IncomeHousehold', 'IncomeMidptsHousehold', 'NetWorthHousehold', 'NetWorthMidptHousehold', 'DiscretionaryIncome', 'CreditMidpts', 'CreditRange'],
                                'householdInformation' => ['NumAdultsHousehold', 'NumChildrenHousehold', 'NumPersonsHousehold', 'ChildAged03Household', 'ChildAged46Household', 'ChildAged79Household', 'ChildAged1012Household', 'ChildAged1318Household', 'ChildrenHousehold'],
                                'interestsAndAffinities' => ['Cooking', 'Gardening', 'Music', 'Diy', 'Books', 'TravelVacation', 'HealthBeautyProducts', 'PetOwner', 'Photography', 'Fitness', 'Epicurean'],
                                'occupation' => ['OccupationCategory', 'OccupationType', 'OccupationDetail'],
                                'marketingIndicators' => ['MagazineSubscriber', 'CharityInterest', 'LikelyCharitableDonor'],
                                'locationAndCensusData' => ['Cbsa', 'CensusBlock', 'CensusBlockGroup', 'CensusTract'],
                                'miscellaneous' => ['Voter', 'Urbanicity'],
                            ];

                            $selected_category = $is_local_custom['advance'];
                            if (!empty($campaignInformations)) {
                                foreach ($campaignInformations as $info) {
                                    $category = $info->type;
                                    if (array_key_exists($category, $categories)) {
                                        foreach ($categories[$category] as $column) {
                                            $value = isset($row->$column) && in_array($info->id,$selected_category) ? $row->$column : '';
                                            if (!empty($value)) {
                                                $camel = lcfirst(str_replace(' ', '', ucwords(str_replace(['-', '_'], ' ', strtolower($column)))));
                                                $additional_fields[$camel] = $value;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        if ($is_advance && $cl['leadspeek_type'] == 'enhance') {
                            $campaignInformations = DB::table('campaign_informations')
                                            ->select('id','type','description')
                                            ->where('status', 'active')
                                            ->where('campaign_type','enhance')
                                            ->orderBy('start_index', 'asc')
                                            ->get();

                            $advance_content = [];

                            $categories = [
                                'identification' => [
                                    'GenderAux', 'Generation', 'MaritalStatus',
                                ],
                                'contactInformation' => [
                                    'Phone3', 'TaxBillInformation',
                                ],
                                'houseAndRealEstate' => [
                                    'DwellingType', 'HomeOwner', 'HomeOwnerOrdinal', 'LengthOfResidence',
                                    'HomePrice', 'HomeValue', 'MedianHomeValue', 'LivingSqft', 'YrBuiltOrig',
                                    'YrBuiltRange', 'LotNumber', 'LegalDescription', 'LandSqft', 'GarageSqft',
                                    'Subdivision', 'ZoningCode',
                                ],
                                'financialInformation' => [
                                    'IncomeHousehold', 'IncomeMidptsHousehold', 'NetWorthHousehold',
                                    'NetWorthMidptHousehold', 'DiscretionaryIncome', 'CreditMidpts', 'CreditRange',
                                ],
                                'householdInformation' => [
                                    'NumAdultsHousehold', 'NumChildrenHousehold', 'NumPersonsHousehold',
                                    'ChildAged03Household', 'ChildAged46Household', 'ChildAged79Household',
                                    'ChildAged1012Household', 'ChildAged1318Household', 'ChildrenHousehold',
                                ],
                                'interestsAndAffinities' => [
                                    'Cooking', 'Gardening', 'Music', 'Diy', 'Books', 'TravelVacation',
                                    'HealthBeautyProducts', 'PetOwner', 'Photography', 'Fitness', 'Epicurean',
                                ],
                                'occupation' => [
                                    'OccupationCategory', 'OccupationType', 'OccupationDetail',
                                ],
                                'marketingIndicators' => [
                                    'MagazineSubscriber', 'CharityInterest', 'LikelyCharitableDonor',
                                ],
                                'locationAndCensusData' => [
                                    'Cbsa', 'CensusBlock', 'CensusBlockGroup', 'CensusTract',
                                ],
                                'miscellaneous' => [
                                    'Voter', 'Urbanicity',
                                ],
                            ];

                            $selected_category = explode(',',$campaign_advance_information->advance_information);
                            if (!empty($campaignInformations)) {
                                foreach ($campaignInformations as $info) {
                                    $category = $info->type;
                                    $description = json_decode($info->description, true);
                                    if (array_key_exists($category, $categories)) {
                                        foreach ($categories[$category] as $index => $column) {
                                            $value = isset($row->$column) && in_array($info->id,$selected_category) ? $row->$column : '';
                                            $camel = lcfirst(str_replace(' ', '', ucwords(str_replace(['-', '_'], ' ', strtolower($description[$index])))));
                                            $additional_fields[$camel] = $value;
                                        }
                                    }
                                }
                            }
                        }

                        try {
                            foreach ($webhook as $webhookurl) {
                                $send_to_zapier = $this->zap_sendrecord(
                                    $webhookurl,
                                    date('Y-m-d H:i:s', strtotime($row->ClickDate)),
                                    ucfirst(strtolower($row->FirstName)),
                                    ucfirst(strtolower($row->LastName)),
                                    $_Email1,
                                    $_Email2,
                                    $_Phone,
                                    $_Phone2,
                                    $_Address1,
                                    $_Address2,
                                    $_City,
                                    $_State,
                                    $_Zipcode,
                                    $keyword,
                                    $url,
                                    $tags,
                                    $_leadspeek_api_id,
                                    $campaign_type,
                                    $row->ID,
                                    $leadspeek_type,
                                    $md5param,
                                    $additional_fields
                                );
                            }
                        } catch (\Throwable $th) {
                            Log::error("Error creating new Zapier lead for match ID: " . $row->ID . " - " . $th->getMessage());
                        }
                    }
                    $endZapierTime = microtime(true);

                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startZapierDate = Carbon::createFromTimestamp($startZapierTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endZapierDate = Carbon::createFromTimestamp($endZapierTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')
                    
                    $totalZapierTime = $endZapierTime - $startZapierTime;
                    $totalZapierTime = number_format($totalZapierTime,2,'.','');

                    $executionTimeList = [
                        'start_execution_time' => $startZapierDate,
                        'end_execution_time' => $endZapierDate,
                        'total_execution_time' => $totalZapierTime,
                    ];

                    return [
                        'executionTimeList' => $executionTimeList
                    ]; 
                }
            }

            return [];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processZapier error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }
    }
    /** END FUNCTION INSERT ZAPIER */

    /** FUNCTION INSERT TO KARTRA */
    public function processKartra($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="") 
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            //// variable tampungan
            $_company_id = $cl['company_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
    
            $kartra = IntegrationSettings::select('api_key', 'enable_sendgrid', 'password')
                            ->where('company_id', '=', $_company_id)
                            ->where('integration_slug', '=', 'kartra')
                            ->where('enable_sendgrid', '=', '1')
                            ->first();
    
            if ($kartra) {
                $startKartraTime = microtime(true);
    
                //Log::info("Level[0] Kartra settings found, proceeding with API key and password assignment.");
                $this->api_key = $kartra->api_key;
                $this->api_password = $kartra->password;
    
                $KartraCreate = null;
            
                foreach ($matches as $row) {
                    $_Phone = $row->Phone;
                    $_Phone2 = $row->Phone2;
                    $_Address1 = $row->Address1;
                    $_Address2 = $row->Address2;
                    $_City = $row->City;
                    $_State = $row->State;
                    $_Zipcode = $row->Zipcode;
    
                    if ($phoneenabled == 'F') {
                        $_Phone = '';
                        $_Phone2 = '';
                    }
                    if ($homeaddressenabled == 'F') {
                        $_Address1 = '';
                        $_Address2 = '';
                        $_City = '';
                        $_State = '';
                        $_Zipcode = '';
                    }
                    
                    $_keyword = "";
                    $_url = "";
                    if ($cl['leadspeek_type'] == "local") {
                        $_url = $row->Keyword;
                    } else if ($cl['leadspeek_type'] == "locator") {
                        $_keyword = $row->Keyword;
                    }else {
                        $_keyword = $row->Keyword;
                    }
            
                    try {
                        //Log::info("Level [1] Creating new Kartra lead for match ID: " . $row->ID . " with parameters: company_id: $_company_id, cl_id: " . $cl['id'] . ", ClickDate: " . date('Y-m-d', strtotime($row->ClickDate)) . ", FirstName: " . ucfirst(strtolower($row->FirstName)) . ", LastName: " . ucfirst(strtolower($row->LastName)) . ", Email: " . $row->Email . ", Phone: $_Phone, Address1: $_Address1, City: $_City, State: $_State, Zipcode: $_Zipcode, URL: $_url, Phone2: $_Phone2, Email2: " . $row->Email2 . ", Address2: $_Address2, Keyword: $_keyword");
                        
                        $KartraCreate = $this->NewKartraLead(
                            $_company_id,
                            $cl['id'],
                            date('Y-m-d', strtotime($row->ClickDate)),
                            ucfirst(strtolower($row->FirstName)),
                            ucfirst(strtolower($row->LastName)),
                            $row->Email,
                            $_Phone,
                            $_Address1,
                            $_City,
                            $_State,
                            $_Zipcode,
                            $_url,
                            $_Phone2,
                            $row->Email2,
                            $_Address2,
                            $_keyword,
                            $leadspeek_api_id,
                            $leadspeek_type,
                            $md5param
                        );
            
                        //Log::info("Level [2] New Kartra lead created successfully for match ID: " . $row->ID);
                    } catch (Exception $e) {
                        Log::error("Error creating new Kartra lead for match ID: " . $row->ID . " - " . $e->getMessage());
                    }
                }
    
                if(!empty($KartraCreate)) {
                    $endKartraTime = microtime(true);
    
                    // convert epochtime to date format ('Y-m-d H:i:s')
                    $startKartraDate = Carbon::createFromTimestamp($startKartraTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    $endKartraDate = Carbon::createFromTimestamp($endKartraTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                    // convert epochtime to date format ('Y-m-d H:i:s')
    
                    $totalKartraTime = $endKartraTime - $startKartraTime;
                    $totalKartraTime = number_format($totalKartraTime,2,'.','');
    
                    $executionTimeList = [
                        'start_execution_time' => $startKartraDate,
                        'end_execution_time' => $endKartraDate,
                        'total_execution_time' => $totalKartraTime,
                    ];
    
                    return [
                        'executionTimeList' => $executionTimeList
                    ];
                }
            } 
    
            return [];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processKartra error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }
    }
    /** END FUNCTION INSERT TO KARTRA */

    /** FUNCTION INSERT TO SENDGRID ACCOUNT */
    public function processSendgrid($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="" ) 
    {
        try
        {
            date_default_timezone_set('America/Chicago');

            //// variable tampungan
            $_company_id = $cl['company_id'];
            $custEmail = $cl['email'];
            $companyNameOri = $cl['company_name'];
    
            $_leadspeek_api_id = $cl['leadspeek_api_id'];
            $_sendgrid_action=$cl['sendgrid_action'];
            $_sendgrid_list=$cl['sendgrid_list'];
            $_sendgrid_is_active=$cl['sendgrid_is_active'];
    
            /** GET THE API KEY INTEGRATION SETTING */
            $_sendgrid_api_key = "";
            $_enable_sendgrid = "";
            $chkSendGrid = IntegrationSettings::select('api_key','enable_sendgrid')
                                    ->where('company_id','=',$_company_id)
                                    ->where('integration_slug','=','sendgrid')
                                    ->first();
            //if (count($chkSendGrid) > 0) {
            if ($chkSendGrid) {
                $_sendgrid_api_key = $chkSendGrid->api_key;
                $_enable_sendgrid = $chkSendGrid->enable_sendgrid;
            }
            /** GET THE API KEY INTEGRATION SETTING */
    
            //Log::warning("sendgrid_api_key : " . $_sendgrid_api_key);
            if(!empty($_sendgrid_api_key) && $_enable_sendgrid == '1' && $_sendgrid_is_active == '1') {
                $startSendGridTime = microtime(true);
                $arraysendgrid = explode(',', $_sendgrid_action);
                foreach($arraysendgrid as $value) 
                {
                    if($value == 'add-to-contact')
                    {
                        foreach($matches as $row2) 
                        {
                            $_keyword = "";
                            $_url = "";

                            $row2->Keyword = $this->replaceExclamationWithAsterisk($row2->Keyword);

                            if ($cl['leadspeek_type'] == "local") {
                                $_url = $row2->Keyword;
                            }else if ($cl['leadspeek_type'] == "locator") {
                                $_keyword = $row2->Keyword;
                            }else{
                                $_keyword = $row2->Keyword;
                            }

                            try {
                                $this->sendContactToSendgrid($_sendgrid_api_key,$row2->Email, ucfirst(strtolower($row2->FirstName)),ucfirst(strtolower($row2->LastName)),$row2->Address1,$row2->Address2,$row2->City,$row2->State,$row2->Zipcode,$row2->Phone,$row2->Email2,$_keyword,$_url,$leadspeek_api_id,$leadspeek_type,$md5param);
                            }catch(Exception $e) {
                                Log::warning("Send Contact to SendGrid (L860) ErrMsg:" . $e->getMessage() . " CampaignID:" . $_leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri);
                            }
                        }
                    }
                    if($value == 'add-to-list')
                    {
                        $arraysendgridlist = explode(',', $_sendgrid_list);
                        foreach($arraysendgridlist as $list) 
                        {
                            if (!empty($list)) 
                            {
                                foreach($matches as $row2) 
                                {
                                    $_keyword = "";
                                    $_url = "";

                                    $row2->Keyword = $this->replaceExclamationWithAsterisk($row2->Keyword);
                                    if ($cl['leadspeek_type'] == "local") {
                                        $_url = $row2->Keyword;
                                    }else if ($cl['leadspeek_type'] == "locator") {
                                        $_keyword = $row2->Keyword;
                                    }else {
                                        $_keyword = $row2->Keyword;
                                    }

                                    try {
                                        $this->sendContactToSendgridList($_sendgrid_api_key,$list,$row2->Email,ucfirst(strtolower($row2->FirstName)),ucfirst(strtolower($row2->LastName)),$row2->Address1,$row2->Address2,$row2->City,$row2->State,$row2->Zipcode,$row2->Phone,$row2->Email2,$_keyword,$_url,$leadspeek_api_id,$leadspeek_type,$md5param);
                                    }catch(Exception $e) {
                                        Log::warning("Send Contact to SendGrid (L878) ErrMsg:" . $e->getMessage() . " CampaignID:" . $_leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri);
                                    }
                                }
                            }
                        }

                    }
                }
                    
                $endSendGridTime = microtime(true);
                
                // convert epochtime to date format ('Y-m-d H:i:s')
                $startSendGridDate = Carbon::createFromTimestamp($startSendGridTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                $endSendGridDate = Carbon::createFromTimestamp($endSendGridTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                // convert epochtime to date format ('Y-m-d H:i:s')

                $totalSendGridTime = $endSendGridTime - $startSendGridTime;
                $totalSendGridTime = number_format($totalSendGridTime,2,'.','');

                $executionTimeList = [
                    'start_execution_time' => $startSendGridDate,
                    'end_execution_time' => $endSendGridDate,
                    'total_execution_time' => $totalSendGridTime,
                ];

                return [
                    'executionTimeList' => $executionTimeList
                ];
            }
    
            return [];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processSendgrid error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }

    }
    /** END FUNCTION INSERT TO SENDGRID ACCOUNT */

    /** FUNCTION THIRDPARTY GHL */
    public function processGHL($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="",$is_local_custom=[]) 
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            //// variable tampungan
            $_company_id = $cl['company_id'];
            $custEmail = $cl['email'];
            $companyNameOri = $cl['company_name'];
            $_leadspeek_api_id = $cl['leadspeek_api_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
            $_user_id = $cl['user_id'];

            $is_advance = false;
            if ($leadspeek_type == 'enhance' || $leadspeek_type == 'b2b') {
                $campaign_advance_information = LeadspeekUser::select('advance_information')->where('leadspeek_api_id',$leadspeek_api_id)->first();
                if (isset($campaign_advance_information->advance_information) && !empty($campaign_advance_information->advance_information) && trim($campaign_advance_information->advance_information) != '') {
                    $is_advance = true;
                }
            }
    
            $_ghl_api_key = "";
            $_enable_ghl = "";
            $chkGhl = IntegrationSettings::select('api_key','enable_sendgrid','custom_fields')
                                    ->where('company_id','=',$_company_id)
                                    ->where('integration_slug','=','gohighlevel')
                                    ->first();
    
            $ghl_custom_fields = isset($chkGhl->custom_fields) ? $chkGhl->custom_fields : '';
            //if (count($chkGhl) > 0) {
            if ($chkGhl) {
                $_ghl_api_key = $chkGhl->api_key;
                $_enable_ghl = $chkGhl->enable_sendgrid;
            }
    
            /** CHECK CLIENT CONNECTED GHL VERSION 2 */
            $tokens = $this->gohighlevelv2GetTokensDB($_company_id);
            $access_token = isset($tokens['access_token']) ? $tokens['access_token'] : '';
            $refresh_token = isset($tokens['refresh_token']) ? $tokens['refresh_token'] : '';
            $location_id = isset($tokens['location_id']) ? $tokens['location_id'] : '';
            $ghlv2Connected = ($access_token != '' && $refresh_token != '' && $location_id != '');
            /** CHECK CLIENT CONNECTED GHL VERSION 2 */
    
            if (($_ghl_api_key != "" || $ghlv2Connected) && $_enable_ghl == "1" && $cl['ghl_is_active'] == "1") {
                $startGohighlevelTime = microtime(true);
    
                /** CREATE GHL CONTACT AND ATTACHED THE TAG IF EXIST */
    
                /** CHECK IF TAG EXIST ON GHL */
                $tags = [];
                $saveTags = [];
                $removeTags = [];
                $removeTagsAPI = json_decode($cl['ghl_remove_tags']);
    
                $ghltags = json_decode($cl['ghl_tags']);
                $ghltagsbuffer = $ghltags;
                if (isset($ghltags) && count($ghltags) > 0) {
                    // get all tags
                    $resultGetTags = [];
                    if($ghlv2Connected) { // version 2
                        // info('ghlv2 1');
                        $resultGetTags = $this->gohighlevelv2GetTags($_company_id, $access_token, $refresh_token, $location_id);
                    } else { // version 1
                        // info('ghlv1 1');
                        $resultGetTags = $this->ghl_getTags($_ghl_api_key);
                    }
    
                    $getAllTags = [];
                    if(isset($resultGetTags->tags) && count($resultGetTags->tags) > 0) {
                        $getAllTags = $resultGetTags->tags;
                    }
                    // info('', ['resultGetTags' => $resultGetTags]);
                    // info('', ['getAllTags' => $getAllTags]);
                    // info('', ['ghltags' => $ghltags]);
                    // info('', ['removeTagsAPI' => $removeTagsAPI]);
                    // get all tags  
    
                    foreach($ghltags as $index => $item) {
                        $partItem = explode('|',$item);
    
                        /* SYNC ID AND TAGS */
                        if(count($getAllTags) > 0 && isset($partItem[0]) && isset($partItem[1])) {
                            foreach($getAllTags as $item) {
                                if($item->name == $partItem[1] && $item->id != $partItem[0]) {
                                    $partItem[0] = $item->id;
                                    $ghltags[$index] = implode('|', $partItem);
                                }
                                if($item->id == $partItem[0] && $item->name != $partItem[1]) {
                                    $partItem[1] = $item->name;
                                    $ghltags[$index] = implode('|', $partItem);
                                }
                            }
                        }
                        /* SYNC ID AND TAGS */
    
                        /** CHECK IF TAG STILL EXIST ON GOHIGHLEVEL */
                        $chkTag = "";
                        if($ghlv2Connected) { // version 2
                            // info('ghlv2 2');
                            $chkTag = $this->gohighlevelv2GetTag($_company_id, $access_token, $refresh_token, $location_id, $partItem[0]);
                        } else { // version 1
                            // info('ghlv1 2');
                            $chkTag = $this->ghl_getTag($partItem[0],$_ghl_api_key);
                        }
    
                        /** CHECK IF TAG STILL EXIST ON GOHIGHLEVEL */
                        if ($chkTag != '' && $chkTag != 'sys_removed') {
                            $tags[] = isset($partItem[1]) ? strtolower($partItem[1]) : "";
                            $saveTags[] = (isset($partItem[0]) ? $partItem[0] : "") . '|' . (isset($partItem[1]) ? strtolower($partItem[1]) : "");
                        } elseif ($chkTag == 'sys_removed') {
                            $removeTags[] = isset($partItem[1]) ? strtolower($partItem[1]) : "";
                        }
                    }
    
                        // jika ada tag name sebelumnya namun id nya berbeda, sinkron id nya
                    $ghlTagsDiff = array_diff($ghltagsbuffer, $ghltags);
                    $ghlTagsDiff = array_values($ghlTagsDiff);
                    // info(['ghlTagsDiff' => $ghlTagsDiff]);
                    // info(['ghltags' => $ghltags]);
                    // info(['tags' => $tags]);
                    
                    if(count($ghlTagsDiff) > 0) {
                        // info('update ghl_tags');
                        LeadspeekUser::where('leadspeek_api_id','=',$leadspeek_api_id)
                                        ->update([
                                        'ghl_tags' => $ghltags
                                        ]);
                    }
                    // jika ada tag name sebelumnya namun id nya berbeda, sinkron id nya
                }
    
                /** IF THERE ARE REMOVE TAG FROM SYSTEM THEN UPDATE/SYNC THE TAG ON THE CAMPAIGN */
                if (count($removeTags) > 0) {
                    /** DISABLED BECAUSE SOMETIMES IT FAILED TO GET NOT BECAUSE IT REMOVED */
                    // $update = LeadspeekUser::where('id',$cl['id'])
                    //                         ->update(['ghl_tags' => json_encode($saveTags),'ghl_remove_tags' => $removeTags]);
                    /** DISABLED BECAUSE SOMETIMES IT FAILED TO GET NOT BECAUSE IT REMOVED */
    
                    // only update ghl_remove_tags, not update ghl_tags
                    $_ghl_remove_tags = [];
                    if(!empty($cl['ghl_remove_tags']) && trim($cl['ghl_remove_tags']) != '') {
                        $_ghl_remove_tags_decode = json_decode($cl['ghl_remove_tags'], true);
                        if(!empty($_ghl_remove_tags_decode) && is_array($_ghl_remove_tags_decode)) {
                            $_ghl_remove_tags = $_ghl_remove_tags_decode;
                        }
                    }
    
                    $removeTagsDiff = array_diff($removeTags, $_ghl_remove_tags);
                    $removeTagsDiff = array_values($removeTagsDiff);
    
                    $removeTagsDiff2 = array_diff($_ghl_remove_tags, $removeTags);
                    $removeTagsDiff2 = array_values($removeTagsDiff2);
    
                    // info([
                    //     'removeTags' => $removeTags,
                    //     'removeTagsDiff' => $removeTagsDiff,
                    //     'removeTagsDiff2' => $removeTagsDiff2,
                    //     'removeTags' => $removeTags,
                    //     '_ghl_remove_tags' => $_ghl_remove_tags,
                    // ]);
                    
                    if(!empty($removeTagsDiff) || !empty($removeTagsDiff2)) {
                        $update = LeadspeekUser::where('id', $cl['id'])
                                                ->update(['ghl_remove_tags' => $removeTags]);
    
                        /* USER LOG */
                        $userID = null;
                        $_ip_user = 'getleadwebhook';
                        $action = 'Gohighlevel Missing Tags';
                        $removeTagsFormat = implode(',', $removeTags);
                        $desc = "Tags : {$removeTagsFormat} | CampaignID : {$_leadspeek_api_id} | CampaignType : {$cl['leadspeek_type']}";
                        $this->logUserAction($userID, $action, $desc, $_ip_user);
                        /* USER LOG */
    
                        /* SEND EMAIL */
                        $clientUserId = $_user_id;
                        $removeTagsString = implode(', ', $removeTags);
                        $this->notificationGohighlevelMissingTags($clientUserId, $_leadspeek_api_id, $removeTagsString);
                        /* SEND EMAIL */
                    }
                    // only update ghl_remove_tags, not update ghl_tags
                } else if (is_array($removeTagsAPI) && count($removeTagsAPI) > 0){ 
                    // $removeTags = $removeTagsAPI;
                    $update = LeadspeekUser::where('id',$cl['id'])
                                            ->update(['ghl_remove_tags' => '']);
                }
                /** IF THERE ARE REMOVE TAG FROM SYSTEM THEN UPDATE/SYNC THE TAG ON THE CAMPAIGN */
    
                /** CHECK IF TAG EXIST ON GHL */
                
    
                /** CHECK GHL CUSTOM FIELDS*/
                if ($is_advance || $cl['leadspeek_type'] == 'b2b' || $is_local_custom['is_advance']) {
                    try {
                    $email2Id = "";
                    $phone2Id = "";
                    $address2Id = "";
                    $keywordId = "";
                    //$urlId = "";
                    $contactId = "";
                    $clickDateId = "";
    
    
                    $global_setting = GlobalSettings::where('setting_name','ghl_custom_fields_create')->first();
                    $ghl_custom_fields_create = [];
                    if (!empty($global_setting) && isset($global_setting->setting_value)) {
                        $ghl_custom_fields_create = json_decode($global_setting->setting_value);
                    }
    
                    $dynamicVariables = [];
                    if (!empty($ghl_custom_fields_create)) {
                        foreach ($ghl_custom_fields_create as $item) {
                            $dynamicVariables[$item->id] = '';
                        }
                        
                    }
                    
                    $comset_name = 'gohlcustomfields';
                    /** GET IF CUSTOM FIELD ALREADY EXIST */
                    $customfields = CompanySetting::where('company_id',$_company_id)->whereEncrypted('setting_name',$comset_name)->get();
                    if (count($customfields) > 0) {
                        $_customfields = json_decode($customfields[0]['setting_value']);
                        $email2Id = (isset($_customfields->email2Id))?$_customfields->email2Id:'';
                        $phone2Id = (isset($_customfields->phone2Id))?$_customfields->phone2Id:'';
                        $address2Id = (isset($_customfields->address2Id))?$_customfields->address2Id:'';
                        $keywordId = (isset($_customfields->keywordId))?$_customfields->keywordId:'';
                        //$urlId = (isset($_customfields->urlId))?$_customfields->urlId:'';
                        $contactId = (isset($_customfields->contactId))?$_customfields->contactId:'';
                        $clickDateId = (isset($_customfields->clickDateId))?$_customfields->clickDateId:'';
                        
                    if (!empty($ghl_custom_fields_create)) {
                        foreach ($ghl_custom_fields_create as $item) {
                            $dynamicVariables[$item->id] = (isset($_customfields->{$item->id})) ? $_customfields->{$item->id} : '';
                        }
                    }
        
                    }
                    /** GET IF CUSTOM FIELD ALREADY EXIST */
    
                    // GENERAL FIELDS 
                        /** CREATE CUSTOM FIELD Alternative Email */
                        if ($email2Id == '') {
                            $createField = "";
                            if($ghlv2Connected) { // version 2
                                // info('ghlv2 3');
                                $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, 'Alternative Email', 'Alternative Email', 'TEXT');
                            } else { // version 1
                                // info('ghlv1 3');
                                $createField = $this->ghl_CreateCustomField($_ghl_api_key,'','Alternative Email','Alternative Email','TEXT',true);
                            }
    
                            if (trim($createField) != '') {
                                $email2Id = trim($createField);
                            }
                        }
                        /** CREATE CUSTOM FIELD Alternative Email */
    
                        /** CREATE CUSTOM FIELD Alternative Phone */
                        if ($phone2Id == '') {
                            $createField = "";
                            if($ghlv2Connected) { // version 2
                                // info('ghlv2 4');
                                $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, 'Alternative Phone', 'Alternative Phone', 'TEXT');
                            } else { // version 1
                                // info('ghlv1 4');
                                $createField = $this->ghl_CreateCustomField($_ghl_api_key,'','Alternative Phone','Alternative Phone','TEXT',true);
                            }
    
                            if (trim($createField) != '') {
                                $phone2Id = trim($createField);
                            }
                        }
                        /** CREATE CUSTOM FIELD Alternative Phone */
    
                        /** CREATE CUSTOM FIELD Street Address 2 */
                        if ($address2Id == '') {
                            $createField = "";
                            if($ghlv2Connected) { // version 2
                                // info('ghlv2 5');
                                $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, 'Street Address 2', 'Street Address 2', 'TEXT');
                            } else { // version 1
                                // info('ghlv1 5');
                                $createField = $this->ghl_CreateCustomField($_ghl_api_key,'','Street Address 2','Street Address 2','TEXT',true);
                            }
    
                            if (trim($createField) != '') {
                                $address2Id = trim($createField);
                            }
                        }
                        /** CREATE CUSTOM FIELD Street Address 2 */
    
                        /** CREATE CUSTOM FIELD ID */
                        if ($contactId == '') {
                            $createField = "";
                            if($ghlv2Connected) { // version 2
                                // info('ghlv2 6');
                                $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, 'Contact ID', 'Contact ID', 'TEXT');
                            } else { // version 1
                                // info('ghlv1 6');
                                $createField = $this->ghl_CreateCustomField($_ghl_api_key,'','Contact ID','Contact ID','TEXT',true);
                            }
    
                            if (trim($createField) != '') {
                                $contactId = trim($createField);
                            }
                        }
                        /** CREATE CUSTOM FIELD ID */
    
                        /** CREATE CUSTOM FIELD CLICKDATE */
                        if ($clickDateId == '') {
                            $createField = "";
                            if($ghlv2Connected) { // version 2
                                // info('ghlv2 7');
                                $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, 'Click Date', 'Click Date', 'TEXT');
                            } else { // version 1
                                // info('ghlv1 7');
                                $createField = $this->ghl_CreateCustomField($_ghl_api_key,'','Click Date','Click Date','TEXT',true);
                            }
    
                            if (trim($createField) != '') {
                                $clickDateId = trim($createField);
                            }
                        }
                        /** CREATE CUSTOM FIELD CLICKDATE */
    
                        /** CREATE CUSTOM FIELD Keyword */
                        if ($keywordId == '') {
                            $createField = "";
                            if($ghlv2Connected) { // version 2
                                // info('ghlv2 8');
                                $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, 'Keywords', 'Keywords', 'TEXT');
                            } else { // version 1
                                // info('ghlv1 8');
                                $createField = $this->ghl_CreateCustomField($_ghl_api_key,'','Keywords','Keywords','TEXT',true);
                            }
    
                            if (trim($createField) != '') {
                                $keywordId = trim($createField);
                            }
                        }
                        /** CREATE CUSTOM FIELD Keyword */
    
                        /** CREATE CUSTOM FIELD URL */
                        // $createField = $this->ghl_CreateCustomField($_ghl_api_key,'jDrGGQMiOgQcv1S2qvjb','URL','URL','TEXT',true);
                        // if (trim($createField) != '') {
                        //     $urlId = trim($createField);
                        // }
                        /** CREATE CUSTOM FIELD URL */
                    // GENERAL FIELDS
    
                    // CUSTOM FIELDS (ADVANCE, ETC)
                        $comset_val_custom = [];
                        if (!empty($ghl_custom_fields_create)) {
                            foreach ($ghl_custom_fields_create as $item) {
                                if (isset($dynamicVariables[$item->id]) && $dynamicVariables[$item->id] == '' && isset($item->name) && isset($item->placeholder) && isset($item->dataType) && isset($item->showInForms)) { 
                                    $createField = "";
                                    if($ghlv2Connected) { // version 2
                                        // info('ghlv2 9', ['$item->name' => $item->name]);
                                        $createField = $this->gohighlevelv2CreateCustomField($_company_id, $access_token, $refresh_token, $location_id, $item->name, $item->placeholder, $item->dataType);
                                    } else { // version 1
                                        // info('ghlv1 9', ['$item->name' => $item->name]);
                                        $createField = $this->ghl_CreateCustomField($_ghl_api_key, '', $item->name, $item->placeholder, $item->dataType, $item->showInForms);
                                    }
                                    
                                    if (trim($createField) != '') {
                                        $dynamicVariables[$item->id] = trim($createField);
                                    }
                                }
                                $comset_val_custom[$item->id] = $dynamicVariables[$item->id];
                            }
                        }
                    // CUSTOM FIELDS (ADVANCE, ETC)
    
                    if ($_company_id != '') {
                        $comset_val = [
                            "contactId" => $contactId,
                            "clickDateId" => $clickDateId,
                            "email2Id" => $email2Id,
                            "phone2Id" => $phone2Id,
                            "address2Id" => $address2Id,
                            "keywordId" => $keywordId,
                            //"urlId" => $urlId
                        ];
    
                        if (!empty($comset_val_custom)) {
                            $comset_val = array_merge($comset_val, $comset_val_custom);
                        }
                        $companysetting = CompanySetting::where('company_id',$_company_id)->whereEncrypted('setting_name',$comset_name)->get();
    
                        if (count($companysetting) > 0) {
                            $updatesetting = CompanySetting::find($companysetting[0]['id']);
                            $updatesetting->setting_value = json_encode($comset_val);
                            $updatesetting->save();
                        }else{
                            $createsetting = CompanySetting::create([
                                'company_id' => $_company_id,
                                'setting_name' => $comset_name,
                                'setting_value' => json_encode($comset_val),
                            ]);
                        }
    
                    }
                    }catch(Exception $e) {
                        Log::warning("GHL Create Contact (L2757) ErrMsg:" . $e->getMessage() . " CampaignID:" . $_leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri);
                    }
                }
                /** CHECK GHL CUSTOM FIELDS*/
    
                /** INSERT INTO GHL CONTACT */
                foreach($matches as $row) {
                    $_ContactID = $row->ID;
                    $_ClickDate = date('Y-m-d',strtotime($row->ClickDate));
                    $_Email = $row->Email;
                    $_Email2 = $row->Email2;
                    $_Phone = $row->Phone;
                    $_Phone2 = $row->Phone2;
                    $_Address1 = $row->Address1;
                    $_Address2 = $row->Address2;
                    $_City = $row->City;
                    $_State = $row->State;
                    $_Zipcode = $row->Zipcode;
    
                    //general field setting
                    $custom_fields_db = [];
                    if($ghl_custom_fields){
                        $custom_fields_db = json_decode($ghl_custom_fields);
                    } else {
                        $integrationList = IntegrationList::select('custom_fields')
                                                    ->where('status', 1)
                                                    ->where('slug', 'gohighlevel')
                                                    ->first();
    
                        $decode_custom_fields = json_decode($integrationList->custom_fields, true);
                        $custom_fields_db = array_map(fn($field) => $field['name'], $decode_custom_fields);
                    }
    
    
                    $_ContactID = in_array('Contact Id', $custom_fields_db) ? $row->ID : '';
                    $_ClickDate = in_array('Click Date', $custom_fields_db) ? date('Y-m-d',strtotime($row->ClickDate)) : '';
                    $_Email2 = in_array('Email 2', $custom_fields_db) ? $row->Email2 : '';
                    $_Phone2 = in_array('Phone 2', $custom_fields_db) ? $row->Phone2 : '';
                    $_Address2 = in_array('Address 2', $custom_fields_db) ? $row->Address2 : '';        
                    //general field setting
                    
    
                    if ($cl['leadspeek_type'] === 'b2b') {
                        $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                        $_Phone2 = '';
                    }
                    
                    if ($phoneenabled == 'F') {
                        $_Phone = '';
                        $_Phone2 = '';
                    }
                    if ($homeaddressenabled == 'F') {
                        $_Address1 = '';
                        $_Address2 = '';
                        $_City = '';
                        $_State = '';
                        $_Zipcode = '';
                    }
    
                    //Advance and b2b field setting
                    $additional_fields = [];
    
                    if ($cl['leadspeek_type'] === 'b2b') {
                        $global_setting = GlobalSettings::where('company_id',$_company_id)->where('setting_name', 'custom_fields_b2b_gohighlevel')->first();
                
                        $global_setting_custom_fields = GlobalSettings::where('setting_name','ghl_custom_fields_create')->first();
    
                        $ghl_custom_fields_create = [];
                        if (!empty($global_setting_custom_fields) && isset($global_setting_custom_fields->setting_value)) {
                            $ghl_custom_fields_create = json_decode($global_setting_custom_fields->setting_value);
                        }
    
                        if (isset($global_setting->setting_value) && !empty($global_setting->setting_value)) {
                            $selected_fields = array_map('strtolower', (array) json_decode($global_setting->setting_value, true));
                            
                            foreach ($ghl_custom_fields_create as $field) {
                                $selected = strtolower((string) (isset($field->category) ? $field->category : $field->name));
                                $selected = $selected === 'headquarters branch' ? 'headquartes branch' : $selected;
                                if (isset($field->api_column) && in_array($selected, $selected_fields)) {
                                    $additional_fields[] = [
                                        'db_id' => $field->id,
                                        'value' => (isset($row->{$field->api_column}) && !empty($row->{$field->api_column})) ? $row->{$field->api_column} : '',
                                    ];
                                }
                            }
                        }else {
                            foreach ($ghl_custom_fields_create as $field) {
                                if (isset($field->api_column)) {
                                    $additional_fields[] = [
                                        'db_id' => $field->id,
                                        'value' => (isset($row->{$field->api_column}) && !empty($row->{$field->api_column})) ? $row->{$field->api_column} : '',
                                    ];    
                                }
                            }
                        }
                    }
    
    
                    if ($is_advance && $cl['leadspeek_type'] == 'enhance') {
                        $campaignInformations = DB::table('campaign_informations')
                                        ->select('id','name','type','description')
                                        ->where('status', 'active')
                                        ->where('campaign_type','enhance')
                                        ->orderBy('start_index', 'asc')
                                        ->get();
    
                        $advance_content = [];
    
                        $categories = [
                            'identification' => [
                                'GenderAux', 'Generation', 'MaritalStatus',
                            ],
                            'contactInformation' => [
                                'Phone3', 'TaxBillInformation',
                            ],
                            'houseAndRealEstate' => [
                                'DwellingType', 'HomeOwner', 'HomeOwnerOrdinal', 'LengthOfResidence',
                                'HomePrice', 'HomeValue', 'MedianHomeValue', 'LivingSqft', 'YrBuiltOrig',
                                'YrBuiltRange', 'LotNumber', 'LegalDescription', 'LandSqft', 'GarageSqft',
                                'Subdivision', 'ZoningCode',
                            ],
                            'financialInformation' => [
                                'IncomeHousehold', 'IncomeMidptsHousehold', 'NetWorthHousehold',
                                'NetWorthMidptHousehold', 'DiscretionaryIncome', 'CreditMidpts', 'CreditRange',
                            ],
                            'householdInformation' => [
                                'NumAdultsHousehold', 'NumChildrenHousehold', 'NumPersonsHousehold',
                                'ChildAged03Household', 'ChildAged46Household', 'ChildAged79Household',
                                'ChildAged1012Household', 'ChildAged1318Household', 'ChildrenHousehold',
                            ],
                            'interestsAndAffinities' => [
                                'Cooking', 'Gardening', 'Music', 'Diy', 'Books', 'TravelVacation',
                                'HealthBeautyProducts', 'PetOwner', 'Photography', 'Fitness', 'Epicurean',
                            ],
                            'occupation' => [
                                'OccupationCategory', 'OccupationType', 'OccupationDetail',
                            ],
                            'marketingIndicators' => [
                                'MagazineSubscriber', 'CharityInterest', 'LikelyCharitableDonor',
                            ],
                            'locationAndCensusData' => [
                                'Cbsa', 'CensusBlock', 'CensusBlockGroup', 'CensusTract',
                            ],
                            'miscellaneous' => [
                                'Voter', 'Urbanicity',
                            ],
                        ];
    
                        $selected_category = explode(',',$campaign_advance_information->advance_information);
                        if (!empty($campaignInformations)) {
                            foreach ($campaignInformations as $info) {
                                $category = $info->type;
                                $fields = json_decode($info->description);
                                if (array_key_exists($category, $categories)) {
                                    foreach ($categories[$category] as $key => $column) {
                                        $value = isset($row->$column) && in_array($info->id,$selected_category) ? $row->$column : '';
                                        $advance_content[] = [
                                            'category' => $info->name,
                                            'column' => $fields[$key],
                                            'value' => $value,
                                        ];
                                    }
                                }
                            }
                        }
    
                        $global_setting = GlobalSettings::where('company_id',$_company_id)->where('setting_name','custom_fields_advance_gohighlevel')->first();
                        
                        $global_setting_custom_fields = GlobalSettings::where('setting_name','ghl_custom_fields_create')->first();
    
                        $ghl_custom_fields_create = [];
                        if (!empty($global_setting_custom_fields) && isset($global_setting_custom_fields->setting_value)) {
                            $ghl_custom_fields_create = json_decode($global_setting_custom_fields->setting_value, );
                            $ghl_custom_fields_create = array_column($ghl_custom_fields_create, 'id', 'name');
                        }
    
                        if (isset($global_setting->setting_value) && !empty($global_setting->setting_value)) {
                            $selected_fields = json_decode($global_setting->setting_value);
                            $additional_fields = array_reduce($advance_content, function ($carry, $item) use ($selected_fields, $ghl_custom_fields_create) {
                                if (in_array($item['category'], $selected_fields) && isset($ghl_custom_fields_create[$item['column']])) {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => $item['value']
                                    ];
                                }else {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => ''
                                    ];
                                }
                                return $carry;
                            }, []);
                        }else {
                            $additional_fields = array_reduce($advance_content, function ($carry, $item) use ($ghl_custom_fields_create) {
                                if (isset($ghl_custom_fields_create[$item['column']])) {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => $item['value']
                                    ];
                                }else {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => ''
                                    ];
                                }
                                return $carry;
                            }, []);
                        }
                    }

                    if ($is_local_custom['is_advance']) {
                        $campaignInformations = DB::table('campaign_informations')
                                                ->select('id','name','type','description')
                                                ->where('status', 'active')
                                                ->whereIn('campaign_type',['local_adv'])
                                                ->orderBy('start_index', 'asc')
                                                ->get();

                        $advance_content_local = [];

                        $categories = [
                            'identification' => [
                                'GenderAux', 'Generation', 'MaritalStatus',
                            ],
                            'contactInformation' => [
                                'Phone3', 'TaxBillInformation',
                            ],
                            'houseAndRealEstate' => [
                                'DwellingType', 'HomeOwner', 'HomeOwnerOrdinal', 'LengthOfResidence',
                                'HomePrice', 'HomeValue', 'MedianHomeValue', 'LivingSqft', 'YrBuiltOrig',
                                'YrBuiltRange', 'LotNumber', 'LegalDescription', 'LandSqft', 'GarageSqft',
                                'Subdivision', 'ZoningCode',
                            ],
                            'financialInformation' => [
                                'IncomeHousehold', 'IncomeMidptsHousehold', 'NetWorthHousehold',
                                'NetWorthMidptHousehold', 'DiscretionaryIncome', 'CreditMidpts', 'CreditRange',
                            ],
                            'householdInformation' => [
                                'NumAdultsHousehold', 'NumChildrenHousehold', 'NumPersonsHousehold',
                                'ChildAged03Household', 'ChildAged46Household', 'ChildAged79Household',
                                'ChildAged1012Household', 'ChildAged1318Household', 'ChildrenHousehold',
                            ],
                            'interestsAndAffinities' => [
                                'Cooking', 'Gardening', 'Music', 'Diy', 'Books', 'TravelVacation',
                                'HealthBeautyProducts', 'PetOwner', 'Photography', 'Fitness', 'Epicurean',
                            ],
                            'occupation' => [
                                'OccupationCategory', 'OccupationType', 'OccupationDetail',
                            ],
                            'marketingIndicators' => [
                                'MagazineSubscriber', 'CharityInterest', 'LikelyCharitableDonor',
                            ],
                            'locationAndCensusData' => [
                                'Cbsa', 'CensusBlock', 'CensusBlockGroup', 'CensusTract',
                            ],
                            'miscellaneous' => [
                                'Voter', 'Urbanicity',
                            ],
                        ];

                        $selected_category = $is_local_custom['advance'];
                        if (!empty($campaignInformations)) {
                            foreach ($campaignInformations as $info) {
                                $category = $info->type;
                                $fields = isset($info->description) ? json_decode($info->description) : null;
                                if (array_key_exists($category, $categories)) {
                                    foreach ($categories[$category] as $key => $column) {
                                        $value = isset($row->$column) && in_array($info->id, $selected_category) ? $row->$column : '';
                                        $columnName = ($fields && isset($fields[$key])) ? $fields[$key] : $column;
                                        $advance_content_local[] = [
                                            'category' => $info->name ?? $category,
                                            'column'   => $columnName,
                                            'value'    => $value,
                                        ];
                                    }
                                }
                            }
                        }

                        $global_setting = GlobalSettings::where('company_id', $_company_id)->where('setting_name', 'custom_fields_advance_gohighlevel')->first();
                        $global_setting_custom_fields = GlobalSettings::where('setting_name', 'ghl_custom_fields_create')->first();

                        $ghl_custom_fields_create = [];
                        if (!empty($global_setting_custom_fields) && isset($global_setting_custom_fields->setting_value)) {
                            $ghl_custom_fields_create = json_decode($global_setting_custom_fields->setting_value);
                            $ghl_custom_fields_create = array_column($ghl_custom_fields_create, 'id', 'name');
                        }

                        if (isset($global_setting->setting_value) && !empty($global_setting->setting_value)) {
                            $selected_fields = json_decode($global_setting->setting_value);
                            $additional_fields = array_reduce($advance_content_local, function ($carry, $item) use ($selected_fields, $ghl_custom_fields_create) {
                                if (in_array($item['category'], $selected_fields) && isset($ghl_custom_fields_create[$item['column']])) {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => $item['value']
                                    ];
                                } else {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => ''
                                    ];
                                }
                                return $carry;
                            }, []);
                        } else {
                            $additional_fields = array_reduce($advance_content_local, function ($carry, $item) use ($ghl_custom_fields_create) {
                                if (isset($ghl_custom_fields_create[$item['column']])) {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => $item['value']
                                    ];
                                } else {
                                    $carry[] = [
                                        'db_id' => $ghl_custom_fields_create[$item['column']],
                                        'value' => ''
                                    ];
                                }
                                return $carry;
                            }, []);
                        }
                    }
                    //Advance and b2b field setting
    
                    // add existing tag when email has ben already
                    // $getContact = [];
                    // if($ghlv2Connected) { // version 2
                    //     // info('ghlv2 10');
                    //     $getContact = $this->gohighlevelv2GetContact($_company_id, $access_token, $refresh_token, $location_id, $_Email);
                    // } else { // version 1
                    //     // info('ghlv1 10');
                    //     $getContact = $this->ghl_GetContact($_ghl_api_key, $_Email);
                    // }
                    
                    // $getContactStatus = isset($getContact['status']) ? $getContact['status'] : '';
                    // $getContactTags = isset($getContact['data']['contacts'][0]['tags']) ? $getContact['data']['contacts'][0]['tags'] : [];
                    
                    // if($getContactStatus == 'success' && is_array($getContactTags) && count($getContactTags) > 0) {
                    //     $tags = array_merge($tags,$getContactTags);
                    //     $tags = array_unique($tags);
                    //     $tags = array_values($tags);
                    // }
                    // add existing tag when email has ben already
                    
                    try {
                        //log::warning('Campaign: #' . $_leadspeek_api_id . ' - GHL Create Contact (L903)');
                        $errMsg = " CampaignID:" . $_leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                        $row->Keyword = $this->replaceExclamationWithAsterisk($row->Keyword);
    
                        // for keyword to tags
                        $ghl_status_keyword_to_tags = $cl['ghl_status_keyword_to_tags'];
                        if($ghl_status_keyword_to_tags == 1){
                            array_push($tags, strtolower($row->Keyword));
                        }
                        // for keyword to tags
    
                        if($ghlv2Connected) { // version 2
                            // info('ghlv2 11');
                            $this->gohighlevelv2CreateContact($_company_id, $access_token, $refresh_token, $location_id, $_ContactID, $_ClickDate, ucfirst(strtolower($row->FirstName)), ucfirst(strtolower($row->LastName)), $_Email, $_Email2, $_Phone, $_Phone2, $_Address1, $_Address2, $_City, $_State, $_Zipcode, $row->Keyword, $tags, $_leadspeek_api_id, $errMsg, $leadspeek_type, $md5param, $additional_fields);
                        } else { // version 1
                            // info('ghlv1 11');
                            $this->ghl_createContact($_company_id,$_ghl_api_key,$_ContactID,$_ClickDate,ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$_Email,$_Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$tags, $_leadspeek_api_id,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                        }
                    }catch(Exception $e) {
                        Log::warning("GHL Create Contact (L941) ErrMsg:" . $e->getMessage() . " CampaignID:" . $_leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri);
                    }
                }
                /** INSERT INTO GHL CONTACT */
    
                $endGohighlevelTime = microtime(true);
    
                // convert epochtime to date format ('Y-m-d H:i:s')
                $startGohighlevelDate = Carbon::createFromTimestamp($startGohighlevelTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                $endGohighlevelDate = Carbon::createFromTimestamp($endGohighlevelTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                // convert epochtime to date format ('Y-m-d H:i:s')
    
                $totalGohighlevelTime = $endGohighlevelTime - $startGohighlevelTime;
                $totalGohighlevelTime = number_format($totalGohighlevelTime,2,'.','');
    
                $executionTimeList = [
                    'start_execution_time' => $startGohighlevelDate,
                    'end_execution_time' => $endGohighlevelDate,
                    'total_execution_time' => $totalGohighlevelTime,
                ];
    
                return [
                    'executionTimeList' => $executionTimeList
                ];
                /** CREATE GHL CONTACT AND ATTACHED THE TAG IF EXIST */
            }
    
            return [];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processGHL error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }
    }
    /** END FUNCTION THIRDPARTY GHL */

    /** FUNCTION THIRDPARTY MAILBOXPOWER */
    public function processMailBoxPower($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="")
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            //// variable tampungan
            $_company_id = $cl['company_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
            $custEmail = $cl['email'];
            $companyNameOri = $cl['company_name'];
            //// variable tampungan
    
            $mailboxpower = IntegrationSettings::select('api_key','enable_sendgrid')
                                               ->where('company_id','=',$_company_id)
                                               ->where('integration_slug','=','mailboxpower')
                                               ->first();
    
            $mbp_api_key = $mailboxpower->api_key ?? "";
            $mbp_enable = $mailboxpower->enable_sendgrid ?? 0;
    
            // Log::info('', ['leadspeek_api_id' => $cl['leadspeek_api_id'],'mailboxpower' => $mailboxpower,'mbp_api_key' => $mbp_api_key,'mbp_enable' => $mbp_enable,'mbp_is_active' => $cl['mbp_is_active'],'mbp_groups' => $cl['mbp_groups'],'mbp_states' => $cl['mbp_states'],]);
            /**
             * Validation
             * 1. jika mailboxpower api key tidak kosong
             * 2. jika mailboxpower di enabled di client level
             * 3. jika mailboxpower di enabled di campaign level
             */
            if(!empty($mbp_api_key) && $mbp_enable == "1" && $cl['mbp_is_active'] == "1")
            {
                $startMailboxpowerTime = microtime(true);
    
                /* GET MBP GROUPS */   
                $mbp_groups = "";
                if(!empty($cl['mbp_groups']) && trim($cl['mbp_groups']) != '') 
                {
                    $mbp_groups = json_decode($cl['mbp_groups'], true);
                }
                // Log::info(['mbp_groups' => $mbp_groups]);
                /* GET MBP GROUPS */  
                
                /* GET MBP OPTIONS */
                $mbp_options = "state";
                if(!empty($cl['mbp_options']) && trim($cl['mbp_options']) != '')
                {
                    $mbp_options = $cl['mbp_options'];
                }
                /* GET MBP OPTIONS */
    
                /* GET MBP ZIP */
                $mbp_zip = "";
                if(!empty($cl['mbp_zip']) && trim($cl['mbp_zip']) != '')
                {
                    $mbp_zip = explode(',', $cl['mbp_zip']);
                }
                /* GET MBP ZIP */
                
                /* GET MBP STATES */
                $mbp_states = "";
                if(!empty($cl['mbp_states']) && trim($cl['mbp_states']) != '')
                {
                    $mbp_states = explode(',', $cl['mbp_states']);
                }
                /* GET MBP STATES */
    
                foreach($matches as $row) 
                {
                    $_Phone = $row->Phone;
                    $_Phone2 = $row->Phone2;
                    $_Address1 = $row->Address1;
                    $_Address2 = $row->Address2;
                    $_City = $row->City;
                    $_State = $row->State;
                    $_Zipcode = $row->Zipcode;
    
                    if ($cl['leadspeek_type'] === 'b2b') 
                    {
                        $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                        $_Phone2 = '';
                    }
    
                    if ($phoneenabled == 'F') 
                    {
                        $_Phone = '';
                        $_Phone2 = '';
                    }
                    if ($homeaddressenabled == 'F') 
                    {
                        $_Address1 = '';
                        $_Address2 = '';
                        $_City = '';
                        $_State = '';
                        $_Zipcode = '';
                    }
    
                    $additional_fields = [];
                    if($cl['leadspeek_type'] === 'b2b')
                    {
                        $additional_fields = [
                            [
                                'text' => 'Employee ID',
                                'value' => (isset($row->EmployeeID) && !empty($row->EmployeeID)) ? $row->EmployeeID : '',
                            ],
                            [
                                'text' => 'Company Name',
                                'value' => (isset($row->CompanyName) && !empty($row->CompanyName)) ? $row->CompanyName : '',
                            ],
                            [
                                'text' => 'Company Website',
                                'value' => (isset($row->CompanyWebsite) && !empty($row->CompanyWebsite)) ? $row->CompanyWebsite : '',
                            ],
                            [
                                'text' => 'Company Phone',
                                'value' => (isset($row->Phone1Company) && !empty($row->Phone1Company)) ? $row->Phone1Company : '',
                            ],
                            [
                                'text' => 'Number of Employees',
                                'value' => (isset($row->NumEmployees) && !empty($row->NumEmployees)) ? $row->NumEmployees : '',
                            ],
                            [
                                'text' => 'Sales Volume',
                                'value' => (isset($row->SalesVolume) && !empty($row->SalesVolume)) ? $row->SalesVolume : '',
                            ],
                            [
                                'text' => 'Year Founded',
                                'value' => (isset($row->YearFounded) && !empty($row->YearFounded)) ? $row->YearFounded : '',
                            ],
                            [
                                'text' => 'Job Title',
                                'value' => (isset($row->JobTitle) && !empty($row->JobTitle)) ? $row->JobTitle : '',
                            ],
                            [
                                'text' => 'Level',
                                'value' => (isset($row->Level) && !empty($row->Level)) ? $row->Level : '',
                            ],
                            [
                                'text' => 'Job Function',
                                'value' => (isset($row->JobFunction) && !empty($row->JobFunction)) ? $row->JobFunction : '',
                            ],
                            [
                                'text' => 'Headquarters Branch',
                                'value' => (isset($row->HeadquartersBranch) && !empty($row->HeadquartersBranch)) ? $row->HeadquartersBranch : '',
                            ],
                            [
                                'text' => 'NAICS Code',
                                'value' => (isset($row->NaicsCode) && !empty($row->NaicsCode)) ? $row->NaicsCode : '',
                            ],
                            [
                                'text' => 'Last Seen Date',
                                'value' => (isset($row->LastSeenDate) && !empty($row->LastSeenDate)) ? $row->LastSeenDate : '',
                            ],
                            [
                                'text' => 'LinkedIn',
                                'value' => (isset($row->LinkedIn) && !empty($row->LinkedIn)) ? $row->LinkedIn : '',
                            ],
                        ];
                        
                    }
    
                    if($mbp_options == 'state')
                    {
                        // jika mailboxpower states nya ada maka validasi bedasarkan states nya tersebut
                        if(is_array($mbp_states))
                        {
                            // Log::info('send mailboxpower with validation states');
                            if(in_array($_State, $mbp_states))
                            {
                                // Log::info('send mailboxpower with validation states success');
                                // jika groups nya dipilih, maka create ke groups" tersebut
                                if(is_array($mbp_groups) && count($mbp_groups) > 0)
                                {
                                    // Log::info('jika groups nya dipilih, maka create ke groups" tersebut');
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                    foreach($mbp_groups as $group)
                                    {
                                        try 
                                        {
                                            $groupArray = explode('|', $group);
                                            $groupid = $groupArray[0] ?? "";
                                            $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                            $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                        }
                                        catch(Exception $e) 
                                        {
                                            Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                        }
                                    }
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                }
                                // jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong
                                else 
                                {
                                    // Log::info('jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong');
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                    try 
                                    {
                                        $groupid = "";
                                        $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                        $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                    }
                                    catch(Exception $e) 
                                    {
                                        Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                    }
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                }
    
                            }
                        }
                        // jika mailboxpower states nya kosong maka tidak ada validasi states
                        else 
                        {
                            // Log::info('send mailboxpower without validation states');
                            // jika groups nya dipilih, maka create ke groups" tersebut
                            if(is_array($mbp_groups) && count($mbp_groups) > 0)
                            {
                                // Log::info('jika groups nya dipilih, maka create ke groups" tersebut');
                                /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                foreach($mbp_groups as $group)
                                {
                                    try 
                                    {
                                        $groupArray = explode('|', $group);
                                        $groupid = $groupArray[0] ?? "";
                                        $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                        $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                    }
                                    catch(Exception $e) 
                                    {
                                        Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                    }
                                }
                                /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                            }
                            // jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong
                            else 
                            {
                                // Log::info('jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong');
                                try 
                                {
                                    $groupid = "";
                                    $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                    $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                }
                                catch(Exception $e) 
                                {
                                    Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                }
                            }
                        }
                    }
                    else if($mbp_options == 'zip')
                    {
                        // jika mailboxpower zip nya ada maka validasi bedasarkan zip nya tersebut
                        if(is_array($mbp_zip))
                        {
                            // Log::info('send mailboxpower with validation zip');
                            if(in_array($_Zipcode, $mbp_zip))
                            {
                                // Log::info('send mailboxpower with validation zip success');
                                // jika groups nya dipilih, maka create ke groups" tersebut
                                if(is_array($mbp_groups) && count($mbp_groups) > 0)
                                {
                                    // Log::info('jika groups nya dipilih, maka create ke groups" tersebut');
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                    foreach($mbp_groups as $group)
                                    {
                                        try 
                                        {
                                            $groupArray = explode('|', $group);
                                            $groupid = $groupArray[0] ?? "";
                                            $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                            $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                        }
                                        catch(Exception $e) 
                                        {
                                            Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                        }
                                    }
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                }
                                // jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong
                                else 
                                {
                                    // Log::info('jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong');
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                    try 
                                    {
                                        $groupid = "";
                                        $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                        $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                    }
                                    catch(Exception $e) 
                                    {
                                        Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                    }
                                    /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                }
    
                            }
                        }
                        // jika mailboxpower zip nya kosong maka tidak ada validasi zip
                        else 
                        {
                            // Log::info('send mailboxpower without validation zip');
                            // jika groups nya dipilih, maka create ke groups" tersebut
                            if(is_array($mbp_groups) && count($mbp_groups) > 0)
                            {
                                // Log::info('jika groups nya dipilih, maka create ke groups" tersebut');
                                /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                                foreach($mbp_groups as $group)
                                {
                                    try 
                                    {
                                        $groupArray = explode('|', $group);
                                        $groupid = $groupArray[0] ?? "";
                                        $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                        $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                    }
                                    catch(Exception $e) 
                                    {
                                        Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                    }
                                }
                                /* PROCESS SEND LEAD TO GROUPS MAILBOXPOWER */
                            }
                            // jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong
                            else 
                            {
                                // Log::info('jika groups nya tidak dipilih, maka create ke dengan groupid nya kosong');
                                try 
                                {
                                    $groupid = "";
                                    $errMsg = " CampaignID:" . $leadspeek_api_id . ' Campaign Name:' . $campaignName . ' Email:' . $custEmail . ' CompanyName:' .  $companyNameOri;
                                    $this->mbp_createContact($mbp_api_key,$groupid,$companyNameOri,$row->ID,$leadspeek_api_id,date('Y-m-d',strtotime($row->ClickDate)),ucfirst(strtolower($row->FirstName)),ucfirst(strtolower($row->LastName)),$row->Email,$row->Email2,$_Phone,$_Phone2,$_Address1,$_Address2,$_City,$_State,$_Zipcode,$row->Keyword,$errMsg,$leadspeek_type,$md5param,$additional_fields);
                                }
                                catch(Exception $e) 
                                {
                                    Log::warning("MBP Create Contact Errmsg : {$e->getMessage()} CampaignID:$leadspeek_api_id CampaignName:$campaignName Email:$custEmail CompanyName:$companyNameOri");
                                }
                            }
                        }
                    }
                }
    
                $endMailboxpowerTime = microtime(true);
    
                // convert epochtime to date format ('Y-m-d H:i:s')
                $startMailboxpowerDate = Carbon::createFromTimestamp($startMailboxpowerTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                $endMailboxpowerDate = Carbon::createFromTimestamp($endMailboxpowerTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                // convert epochtime to date format ('Y-m-d H:i:s')
    
                $totalMailboxpowerTime = $endMailboxpowerTime - $startMailboxpowerTime;
                $totalMailboxpowerTime = number_format($totalMailboxpowerTime,2,'.','');
    
                $executionTimeList = [
                    'start_execution_time' => $startMailboxpowerDate,
                    'end_execution_time' => $endMailboxpowerDate,
                    'total_execution_time' => $totalMailboxpowerTime,
                ];
    
                return [
                    'executionTimeList' => $executionTimeList
                ];
            }
    
            return [];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processMailBoxPower error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }

    }
    /** FUNCTION THIRDPARTY MAILBOXPOWER */

    /** FUNCTION THIRDPARTY CLICKFUNNELS */
    public function processClickFunnels($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="")
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            //// VARIABLE TAMPUNGAN
            $_company_id = $cl['company_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];
            $is_advance = false;
            if ($leadspeek_type == 'enhance' || $leadspeek_type == 'b2b') {
                $campaign_advance_information = LeadspeekUser::select('advance_information')->where('leadspeek_api_id',$leadspeek_api_id)->first();
                if (isset($campaign_advance_information->advance_information) && !empty($campaign_advance_information->advance_information) && trim($campaign_advance_information->advance_information) != '') {
                    $is_advance = true;
                }
            }
            //// VARIABLE TAMPUNGAN
    
            $clickfunnels = IntegrationSettings::select('api_key','enable_sendgrid','subdomain','workspace_id', 'custom_fields')
                                                       ->where('company_id','=',$_company_id)
                                                       ->where('integration_slug','=','clickfunnels')
                                                       ->first();
    
            $cf_api_key = $clickfunnels->api_key ?? "";
            $cf_subdomain = $clickfunnels->subdomain ?? "";
            $cf_workspace_id = $clickfunnels->workspace_id ?? "";
            $cf_enable = $clickfunnels->enable_sendgrid ?? 0;
            $cf_custom_fields = $clickfunnels->custom_fields ?? '';
    
            if(!empty($cf_api_key) && $cf_enable == "1" && $cl['clickfunnels_is_active'] == "1")
            {
                // info('start serve to clickfunnels');
                $startClickFunnelsTime = microtime(true);
    
                /* GET CF TAGS */
                $cf_tags = [];
                if(!empty($cl['clickfunnels_tags']) && trim($cl['clickfunnels_tags']) != '') 
                {
                    $cf_tags = json_decode($cl['clickfunnels_tags'], true);
                }
                // info(['cf_tags' => $cf_tags]);
                /* GET CF TAGS */
    
                foreach($matches as $row) 
                {
                    $_Phone = $row->Phone;
                    $_Phone2 = $row->Phone2;
                    $_Address1 = $row->Address1;
                    $_Address2 = $row->Address2;
                    $_City = $row->City;
                    $_State = $row->State;
                    $_Zipcode = $row->Zipcode;
    
                    if ($cl['leadspeek_type'] === 'b2b') {
                        $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                        $_Phone2 = '';
                    }
    
                    if ($phoneenabled == 'F') 
                    {
                        $_Phone = '';
                        $_Phone2 = '';
                    }
                    if ($homeaddressenabled == 'F') 
                    {
                        $_Address1 = '';
                        $_Address2 = '';
                        $_City = '';
                        $_State = '';
                        $_Zipcode = '';
                    }
                    
                    $custom_fields_db = [];
                    
                    $b2b_custom_fields = [];
                    if ($cl['leadspeek_type'] === 'b2b') {
                        $global_setting = GlobalSettings::where('company_id',$_company_id)->where('setting_name','custom_fields_b2b_clickfunnels')->first();
                        if (isset($global_setting->setting_value) && !empty($global_setting->setting_value)) {
                            $b2b_custom_fields = json_decode($global_setting->setting_value);
                        }else {
                            $b2b_custom_fields =  [
                                'Id Contact',
                                'Company Name',
                                'Company Website',
                                'Company Phone',
                                'Number of Employees',
                                'Sales Volume',
                                'Year Founded',
                                'Job Title',
                                'Level',
                                'Job function',
                                'Headquartes Branch',
                                'NAICS Code',
                                'Last Seen Date',
                                'Linked In'
                            ];
                        }
                    }
                    if($cf_custom_fields){
                        $custom_fields_db = json_decode($cf_custom_fields);
                        if (!empty($b2b_custom_fields)) {
                            $custom_fields_db = array_merge($custom_fields_db,$b2b_custom_fields);
                        }
                    } else {
                        $integrationList = IntegrationList::select('custom_fields')
                                                    ->where('status', 1)
                                                    ->where('slug', 'clickfunnels')
                                                    ->first();
    
                        $decode_custom_fields = json_decode($integrationList->custom_fields, true);
                        $custom_fields_db = array_map(fn($field) => $field['name'], $decode_custom_fields);
                    }
    
                    $custom_attributes = [
                        'id_campaign' => '',
                        'id_contact' => '',
                        'click_date' => '',
                        'email_2' => "",
                        'phone_2' => '',
                        'country' => '',
                        'state' => '',
                        'city' => '',
                        'postal_code' => '',
                        'address_1' => '',
                        'address_2' => '',
                        'keyword' => ''
                    ];
    
                    if(in_array('Id Contact', $custom_fields_db)){
                        $custom_attributes['id_contact'] = $row->ID;
                    }
                    if(in_array('Id Campaign', $custom_fields_db)){
                        $custom_attributes['id_campaign'] = $leadspeek_api_id;
                    }
                    if(in_array('Click Date', $custom_fields_db)){
                        $custom_attributes['click_date'] = date('Y-m-d',strtotime($row->ClickDate));
                    }
                    if(in_array('Email 2', $custom_fields_db)){
                        $custom_attributes['email_2'] = $row->Email2;
                    }
                    if(in_array('Phone 2', $custom_fields_db)){
                        $custom_attributes['phone_2'] = $_Phone2;
                    }
                    if(in_array('Country', $custom_fields_db)){
                        $custom_attributes['country'] = "US";
                    }
                    if(in_array('State', $custom_fields_db)){
                        $custom_attributes['state'] = $_State;
                    }
                    if(in_array('City', $custom_fields_db)){
                        $custom_attributes['city'] = $_City;
                    }
                    if(in_array('Postal Code', $custom_fields_db)){
                        $custom_attributes['postal_code'] = $_Zipcode;
                    }
                    if(in_array('Address 1', $custom_fields_db)){
                        $custom_attributes['address_1'] = $_Address1;
                    }
                    if(in_array('Address 2', $custom_fields_db)){
                        $custom_attributes['address_2'] = $_Address2;
                    }
                    if(in_array('Keyword', $custom_fields_db)){
                        $custom_attributes['keyword'] = $row->Keyword;
                    }
    
                    if($cl['leadspeek_type'] === 'b2b'){
                        if(in_array('Employee ID', $custom_fields_db)){
                            $custom_attributes['id_employee'] = (isset($row->EmployeeID) && !empty($row->EmployeeID)) ? $row->EmployeeID : '';
                        }
                        if(in_array('Company Name', $custom_fields_db)){
                            $custom_attributes['company_name'] = (isset($row->CompanyName) && !empty($row->CompanyName)) ? $row->CompanyName : '';
                        }
                        if(in_array('Company Website', $custom_fields_db)){
                            $custom_attributes['company_website'] = (isset($row->CompanyWebsite) && !empty($row->CompanyWebsite)) ? $row->CompanyWebsite : '';
                        }
                        if(in_array('Company Phone', $custom_fields_db)){
                            $custom_attributes['company_phone'] = (isset($row->Phone1Company) && !empty($row->Phone1Company)) ? $row->Phone1Company : '';
                        }
                        if(in_array('Number of Employees', $custom_fields_db)){
                            $custom_attributes['number_of_employees'] = (isset($row->NumEmployees) && !empty($row->NumEmployees)) ? $row->NumEmployees : '';
                        }
                        if(in_array('Sales Volume', $custom_fields_db)){
                            $custom_attributes['sales_volume'] = (isset($row->SalesVolume) && !empty($row->SalesVolume)) ? $row->SalesVolume : '';
                        }
                        if(in_array('Year Founded', $custom_fields_db)){
                            $custom_attributes['year_founded'] = (isset($row->YearFounded) && !empty($row->YearFounded)) ? $row->YearFounded : '';
                        }
                        if(in_array('Job Title', $custom_fields_db)){
                            $custom_attributes['job_title'] = (isset($row->JobTitle) && !empty($row->JobTitle)) ? $row->JobTitle : '';
                        }
                        if(in_array('Level', $custom_fields_db)){
                            $custom_attributes['level'] = (isset($row->Level) && !empty($row->Level)) ? $row->Level : '';
                        }
                        if(in_array('Job function', $custom_fields_db)){
                            $custom_attributes['job_function'] = (isset($row->JobFunction) && !empty($row->JobFunction)) ? $row->JobFunction : '';
                        }
                        if(in_array('Headquartes Branch', $custom_fields_db)){
                            $custom_attributes['headquartes_branch'] = (isset($row->HeadquartersBranch) && !empty($row->HeadquartersBranch)) ? $row->HeadquartersBranch : '';
                        }
                        if(in_array('NAICS Code', $custom_fields_db)){
                            $custom_attributes['naics_code'] = (isset($row->NaicsCode) && !empty($row->NaicsCode)) ? $row->NaicsCode : '';
                        }
                        if(in_array('Last Seen Date', $custom_fields_db)){
                            $custom_attributes['last_seen_date'] = (isset($row->LastSeenDate) && !empty($row->LastSeenDate)) ? $row->LastSeenDate : '';
                        }
                        if(in_array('Linked In', $custom_fields_db)){
                            $custom_attributes['linked_in'] = (isset($row->LinkedIn) && !empty($row->LinkedIn)) ? $row->LinkedIn : '';
                        }
                    }
                    
                    if ($is_advance && $cl['leadspeek_type'] == 'enhance') {
                        $campaignInformations = DB::table('campaign_informations')
                                        ->select('id','type','description')
                                        ->where('status', 'active')
                                        ->where('campaign_type','enhance')
                                        ->orderBy('start_index', 'asc')
                                        ->get();
    
                        $advance_content = [];
    
                        $categories = [
                            'identification' => [
                                'GenderAux', 'Generation', 'MaritalStatus',
                            ],
                            'contactInformation' => [
                                'Phone3', 'TaxBillInformation',
                            ],
                            'houseAndRealEstate' => [
                                'DwellingType', 'HomeOwner', 'HomeOwnerOrdinal', 'LengthOfResidence',
                                'HomePrice', 'HomeValue', 'MedianHomeValue', 'LivingSqft', 'YrBuiltOrig',
                                'YrBuiltRange', 'LotNumber', 'LegalDescription', 'LandSqft', 'GarageSqft',
                                'Subdivision', 'ZoningCode',
                            ],
                            'financialInformation' => [
                                'IncomeHousehold', 'IncomeMidptsHousehold', 'NetWorthHousehold',
                                'NetWorthMidptHousehold', 'DiscretionaryIncome', 'CreditMidpts', 'CreditRange',
                            ],
                            'householdInformation' => [
                                'NumAdultsHousehold', 'NumChildrenHousehold', 'NumPersonsHousehold',
                                'ChildAged03Household', 'ChildAged46Household', 'ChildAged79Household',
                                'ChildAged1012Household', 'ChildAged1318Household', 'ChildrenHousehold',
                            ],
                            'interestsAndAffinities' => [
                                'Cooking', 'Gardening', 'Music', 'Diy', 'Books', 'TravelVacation',
                                'HealthBeautyProducts', 'PetOwner', 'Photography', 'Fitness', 'Epicurean',
                            ],
                            'occupation' => [
                                'OccupationCategory', 'OccupationType', 'OccupationDetail',
                            ],
                            'marketingIndicators' => [
                                'MagazineSubscriber', 'CharityInterest', 'LikelyCharitableDonor',
                            ],
                            'locationAndCensusData' => [
                                'Cbsa', 'CensusBlock', 'CensusBlockGroup', 'CensusTract',
                            ],
                            'miscellaneous' => [
                                'Voter', 'Urbanicity',
                            ],
                        ];
    
                        $selected_category = explode(',',$campaign_advance_information->advance_information);
                        if (!empty($campaignInformations)) {
                            foreach ($campaignInformations as $info) {
                                $category = $info->type;
                                $description = json_decode($info->description, true);
                                if (array_key_exists($category, $categories)) {
                                    foreach ($categories[$category] as $index => $column) {
                                        $value = isset($row->$column) && in_array($info->id,$selected_category) ? $row->$column : '';
                                        $key = str_replace(['-', '_', ' '], '_', strtolower($description[$index])); 
                                        $custom_attributes[$key] = $value;
                                    }
                                }
                            }
                        }
                    }
    
                    // $custom_attributes = [
                    //     'id_contact' => $row->ID,
                    //     'id_campaign' => $_leadspeek_api_id,
                    //     'click_date' => date('Y-m-d',strtotime($row->ClickDate)),
                    //     'email_2' => $row->Email2,
                    //     'phone_2' => $_Phone2,
                    //     'country' => 'US',
                    //     'state' => $_State,
                    //     'city' => $_City,
                    //     'postal_code' => $_Zipcode,
                    //     'address_1' => $_Address1,
                    //     'address_2' => $_Address2,
                    //     'keyword' => $row->Keyword
                    // ];
    
                    $data = [
                        'email_address' => $row->Email,
                        'first_name' => ucfirst(strtolower($row->FirstName)),
                        'last_name' => ucfirst(strtolower($row->LastName)),
                        'phone_number' => $_Phone,
                        'custom_attributes' => $custom_attributes,
                    ];
    
                    /* GET WORKSPACE ID */
                    $workSpace = $this->clickfunnels_GetWorkSpaceId($cf_api_key,$cf_subdomain,$cf_workspace_id,$data,$leadspeek_type,$md5param);
                    $workspace_result = isset($workSpace['result']) ? $workSpace['result'] : '' ;
                    $workspace_id = isset($workSpace['id']) ? $workSpace['id'] : '' ;
                    /* GET WORKSPACE ID */
                    
                    /* SEND TO CLICKFUNNELS */
                    if($workspace_result == 'success' && $workspace_id != '')
                    {
                        /* FILTER LIST TAGS ID, REMOVE TAGS ID IF IN CLICKFUNNELS NOT EXISTS */
                        if(is_array($cf_tags) && count($cf_tags) > 0) 
                        {
                            $cf_tags_buffer = $cf_tags;
    
                            /* GET LIST TAGS */
                            $listTags = $this->clickfunnels_GetListTags($cf_api_key,$cf_subdomain,$workspace_id,$data,$leadspeek_type,$md5param);
                            $listTags_result = isset($listTags['result']) ? $listTags['result'] : '';
                            $listTags_data = isset($listTags['data']) ? $listTags['data'] : '';
                            /* GET LIST TAGS */
                            
                            if($listTags_result == 'success') 
                            { 
                                $listTags_Ids = array_column($listTags_data, 'id'); // untuk ambil id nya saja
                                
                                if(is_array($listTags_Ids) && count($listTags_Ids) > 0)
                                {
                                    $cf_tags_buffer = array_intersect($cf_tags, $listTags_Ids); // remove id tags yang ada di database, namun tidak ada di clickfunnels
                                    $cf_tags_buffer = array_values($cf_tags_buffer); // untuk mengurutkan index array
                                    // info(['action' => 'filter_tags_id','cf_tags' => $cf_tags,'listTags_Ids' => $listTags_Ids,'cf_tags_buffer' => $cf_tags_buffer]);
                                }
                            }   
                            if(is_array($cf_tags_buffer) && count($cf_tags_buffer) > 0)
                            {
                                $data['tag_ids'] = $cf_tags_buffer;
                            }
                            // info(['data' => $data]);
                        }
                        /* FILTER LIST TAGS ID, REMOVE TAGS ID IF IN CLICKFUNNELS NOT EXISTS */
                        
                        $this->clickfunnels_CreateContact($cf_api_key,$cf_subdomain,$workspace_id,$data,$leadspeek_type,$md5param);
                    }
                    /* SEND TO CLICKFUNNELS */
                }
    
                $endClickFunnelsTime = microtime(true);
    
                // convert epochtime to date format ('Y-m-d H:i:s')
                $startClickFunnelsDate = Carbon::createFromTimestamp($startClickFunnelsTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                $endClickFunnelsDate = Carbon::createFromTimestamp($endClickFunnelsTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                // convert epochtime to date format ('Y-m-d H:i:s')
    
                $totalClickFunnelsTime = $endClickFunnelsTime - $startClickFunnelsTime;
                $totalClickFunnelsTime = number_format($totalClickFunnelsTime,2,'.','');
    
                $executionTimeList = [
                    'start_execution_time' => $startClickFunnelsDate,
                    'end_execution_time' => $endClickFunnelsDate,
                    'total_execution_time' => $totalClickFunnelsTime,
                ];
    
                return [
                    'executionTimeList' => $executionTimeList
                ];
            }
    
            return [];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processClickFunnels error CampaignID {$leadspeek_api_id}", [
                'error' => $e->getMessage()
            ]);
            return [];
        }
    }
    /** FUNCTION THIRDPARTY CLICKFUNNELS */

    /** FUNCTION THIRDPARTY SENDJIM */
    public function processSendJim($leadspeek_api_id="",$leadspeek_type="",$md5param="",$matches=[],$cl=[],$campaignName="")
    {
        try {
            date_default_timezone_set('America/Chicago');

            $_company_id = $cl['company_id'];
            $phoneenabled = $cl['phoneenabled'];
            $homeaddressenabled = $cl['homeaddressenabled'];

            $sendJimSetting = IntegrationSettings::select('tokens','enable_sendgrid','custom_fields')
                                                ->where('company_id','=', $_company_id)
                                                ->where('integration_slug','=','sendjim')
                                                ->first();

            if(!$sendJimSetting) {
                return [];
            }

            $tokens_arr = [];
            if(!empty($sendJimSetting->tokens)) {
                $tokens_arr = json_decode($sendJimSetting->tokens, true) ?: [];
            }
            $sj_api_token = $tokens_arr['GrantToken'] ?? '';
            $sj_enabled = $sendJimSetting->enable_sendgrid ?? 0;
            $campaignSendjimActive = isset($cl['sendjim_is_active']) ? (string)$cl['sendjim_is_active'] : '0';
            $custom_fields = [];
            if (!empty($sendJimSetting) && !empty($sendJimSetting->custom_fields)) {
                $decoded = json_decode($sendJimSetting->custom_fields, true);
                $custom_fields = is_array($decoded) ? $decoded : [];
            }

            if(!empty($sj_api_token) && (string)$sj_enabled === '1' && $campaignSendjimActive === '1') {
                $startSjTime = microtime(true);
                $sendJimService = app(SendJimService::class);

                $contacts = [];
                $createdIds = [];
                foreach($matches as $row) {
                    $_Phone = $row->Phone;
                    $_Phone2 = $row->Phone2;
                    $_Address1 = $row->Address1;
                    $_Address2 = $row->Address2;
                    $_City = $row->City;
                    $_State = $row->State;
                    $_Zipcode = $row->Zipcode;

                    if ($leadspeek_type === 'b2b') {
                        $_Phone = isset($row->Phone1Employee) ? $row->Phone1Employee : '';
                        $_Phone2 = '';
                    }

                    if ($phoneenabled === 'F') {
                        $_Phone = '';
                        $_Phone2 = '';
                    }
                    if ($homeaddressenabled === 'F') {
                        $_Address1 = '';
                        $_Address2 = '';
                        $_City = '';
                        $_State = '';
                        $_Zipcode = '';
                    }

                    $streetAddress = trim(($_Address1 ?? '') . (($_Address2 ?? '') !== '' ? (' ' . $_Address2) : ''));
                    $tags = [];

                    if (!empty($cl['sendjim_tags'])) {
                        $dbTags = json_decode($cl['sendjim_tags'], true);
                        if (is_array($dbTags)) {
                            $tags = array_values(array_filter($dbTags, fn($t) => is_string($t) && trim($t) !== ''));
                        }
                    }

                    if (isset($row->Keyword) && $row->Keyword !== '') {
                        $tags[] = $row->Keyword;
                    }

                    $contact = [
                        'StreetAddress' => $streetAddress,
                        'City' => $_City ?? '',
                        'State' => $_State ?? '',
                        'PostalCode' => $_Zipcode ?? '',
                        'FirstName' => isset($row->FirstName) ? ucfirst(strtolower($row->FirstName)) : '',
                        'LastName' => isset($row->LastName) ? ucfirst(strtolower($row->LastName)) : '',
                        'Tags' => $tags,
                        'Email' => isset($row->Email) ? $row->Email : '',
                        'PhoneNumber' => $_Phone,
                    ];

                    $contacts[] = $contact;
                }

                if (count($contacts) > 0) {
                    try {
                        $response = $sendJimService->createContacts($contacts, $sj_api_token);
                        info([
                            'response' => $response,
                        ]);
                        if (is_array($response) && isset($response['ContactsSaved']) && is_array($response['ContactsSaved'])) {
                            foreach ($response['ContactsSaved'] as $item) {
                                if (is_array($item) && isset($item['ContactID'])) {
                                    $createdIds[] = (int)$item['ContactID'];
                                }
                            }
                        }
                    }
                    catch (\Throwable $e) {
                        Log::warning('SendJim createContacts failed', [
                            'campaign_id' => $leadspeek_api_id,
                            'error' => $e->getMessage(),
                        ]);
                    }

                    $qsEnabled = ((int)($cl['sendjim_quicksend_is_active'] ?? 0) === 1);
                    $qsTemplates = [];
                    if (!empty($cl['sendjim_quicksend_templates'])) {
                        $tpl = json_decode($cl['sendjim_quicksend_templates'], true);
                        if (is_array($tpl)) {
                            $qsTemplates = array_values(array_filter($tpl, fn($v) => is_numeric($v)));
                        }
                    }

                    if ($qsEnabled && count($qsTemplates) > 0 && count($createdIds) > 0) {
                        foreach ($qsTemplates as $qsId) {
                            try {
                                $sendJimService->quickSendByIds($qsId, $createdIds, $sj_api_token);
                            } catch (\Throwable $e) {
                                Log::warning('SendJim quickSend failed', [
                                    'campaign_id' => $leadspeek_api_id,
                                    'template_id' => $qsId,
                                    'error' => $e->getMessage(),
                                ]);
                            }
                        }
                    }
                }

                $endSjTime = microtime(true);
                $startSjDate = Carbon::createFromTimestamp($startSjTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                $endSjDate = Carbon::createFromTimestamp($endSjTime)->setTimezone('America/Chicago')->format('Y-m-d H:i:s');
                $totalSjTime = number_format($endSjTime - $startSjTime, 2, '.', '');

                $executionTimeList = [
                    'start_execution_time' => $startSjDate,
                    'end_execution_time' => $endSjDate,
                    'total_execution_time' => $totalSjTime,
                ];

                return [ 'executionTimeList' => $executionTimeList ];
            }

            return [];
        } catch (\Throwable $e) {
            Log::error('public function processSendJim error CampaignID ' . $leadspeek_api_id, [
                'error' => $e->getMessage()
            ]);
            return [];
        }
    }
    /** FUNCTION THIRDPARTY SENDJIM */
    
    /* FUNTION PROCESS GET ROOT FEE */
    public function processGetRootFee($cl = [])
    {
        try
        {
            date_default_timezone_set('America/Chicago');

            // VARIABLE TAMPUNGAN
            $companyRootID = (isset($cl['company_root_id']))?$cl['company_root_id']:'';
            $rootFeeCost = 0;
            // VARIABLE TAMPUNGAN
            
            $masterRootFee = $this->getcompanysetting($companyRootID,'rootfee');
            if ($masterRootFee != '') {
                if ($cl['leadspeek_type'] == "local") {
                    $rootFeeCost = (isset($masterRootFee->feesiteid))?$masterRootFee->feesiteid:0;
                }else if ($cl['leadspeek_type'] == "locator") {
                    $rootFeeCost = (isset($masterRootFee->feesearchid))?$masterRootFee->feesearchid:0;
                }else if ($cl['leadspeek_type'] == "enhance") {
                    $rootFeeCost = (isset($masterRootFee->feeenhance))?$masterRootFee->feeenhance:0;
                }else if($cl['leadspeek_type'] == "b2b") {
                    $rootFeeCost = (isset($masterRootFee->feeb2b))?$masterRootFee->feeb2b:0;
                }
            }
            
            return [
                'rootFeeCost' => $rootFeeCost,
            ];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processGetRootFee error", [
                'message' => $e->getMessage()
            ]);
            return [];
        }

    }
    /* FUNTION PROCESS GET ROOT FEE */

    /* FUNCTION PROCESS GET PLATFORM MARGIN */
    public function processGetPlatformMargin($cl = [])
    {
        try 
        {
            date_default_timezone_set('America/Chicago');

            $platform_LeadspeekCostperlead = 0;
            $platform_LeadspeekMinCostMonth = 0;
            $platform_LeadspeekPlatformFee = 0;

            $platformMargin = $this->getcompanysetting($cl['company_parent'],'costagency');
            $paymentterm = trim($cl['paymentterm']);
            $paymentterm = str_replace(' ','',$paymentterm);
            
            if ($platformMargin != '') {
                if ($cl['leadspeek_type'] == "local") {
                    $rootcostagency = $this->getcompanysetting($cl['company_root_id'],'rootcostagency');
                    $campaign_information_type_local = !empty($cl['campaign_information_type_local']) ? explode(',', $cl['campaign_information_type_local']) : [];
                    // info('processGetPlatformMargin local', ['campaign_information_type_local_leadspeek_users' => $cl['campaign_information_type_local'],'campaign_information_type_local' => $campaign_information_type_local]);
                    
                    if(in_array('advanced', $campaign_information_type_local)) {
                        $platform_LeadspeekCostperlead = (isset($platformMargin->local->$paymentterm->LeadspeekCostperleadAdvanced))?($platformMargin->local->$paymentterm->LeadspeekCostperleadAdvanced):($rootcostagency->local->$paymentterm->LeadspeekCostperleadAdvanced);
                        // info('processGetPlatformMargin advanced', ['platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead]);
                    } else {
                        $platform_LeadspeekCostperlead = (isset($platformMargin->local->$paymentterm->LeadspeekCostperlead))?$platformMargin->local->$paymentterm->LeadspeekCostperlead:0;
                        // info('processGetPlatformMargin basic', ['platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead]);
                    }

                    $platform_LeadspeekMinCostMonth = (isset($platformMargin->local->$paymentterm->LeadspeekMinCostMonth))?$platformMargin->local->$paymentterm->LeadspeekMinCostMonth:0;
                    $platform_LeadspeekPlatformFee = (isset($platformMargin->local->$paymentterm->LeadspeekPlatformFee))?$platformMargin->local->$paymentterm->LeadspeekPlatformFee:0;
                }else if ($cl['leadspeek_type'] == "locator") {
                    $platform_LeadspeekCostperlead = (isset($platformMargin->locator->$paymentterm->LocatorCostperlead))?$platformMargin->locator->$paymentterm->LocatorCostperlead:0;
                    $platform_LeadspeekMinCostMonth = (isset($platformMargin->locator->$paymentterm->LocatorMinCostMonth))?$platformMargin->locator->$paymentterm->LocatorMinCostMonth:0;
                    $platform_LeadspeekPlatformFee = (isset($platformMargin->locator->$paymentterm->LocatorPlatformFee))?$platformMargin->locator->$paymentterm->LocatorPlatformFee:0;
                }else if ($cl['leadspeek_type'] == "enhance") {
                    // $rootcostagency = []; 
                    // if(!isset($platformMargin->enhance)) {
                    //     $rootcostagency = $this->getcompanysetting($cl['company_root_id'],'rootcostagency');
                    // }
    
                    $clientTypeLead = $this->getClientCapType($cl['company_root_id']);
                    $rootcostagency = $this->getcompanysetting($cl['company_root_id'],'rootcostagency');
                    $costagency = $this->getcompanysetting($cl['company_parent'], 'costagency');
    
                    /* VALIDATION COST PER LEAD UNDER COSTAGENCY */
                    // info('', [
                    //     'action' => 'cl before',
                    //     'cl' => $cl,
                    //     'clientCostPerLead' => $clientCostPerLead
                    // ]);
                    if($cl['paymentterm'] == 'Weekly') {
                        if(isset($costagency->enhance->Weekly->EnhanceCostperlead) && ($costagency->enhance->Weekly->EnhanceCostperlead != '') && ($costagency->enhance->Weekly->EnhanceCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $costagency->enhance->Weekly->EnhanceCostperlead)) {
                            $cl['cost_perlead'] = (float) $costagency->enhance->Weekly->EnhanceCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    } else if($cl['paymentterm'] == 'Monthly') { 
                        if(isset($costagency->enhance->Monthly->EnhanceCostperlead) && ($costagency->enhance->Monthly->EnhanceCostperlead != '') && ($costagency->enhance->Monthly->EnhanceCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $costagency->enhance->Monthly->EnhanceCostperlead)) {
                            $cl['cost_perlead'] = (float) $costagency->enhance->Monthly->EnhanceCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    } else if($cl['paymentterm'] == 'One Time') {
                        if(isset($costagency->enhance->OneTime->EnhanceCostperlead) && ($costagency->enhance->OneTime->EnhanceCostperlead != '') && ($costagency->enhance->OneTime->EnhanceCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $costagency->enhance->OneTime->EnhanceCostperlead)) {
                            $cl['cost_perlead'] = (float) $costagency->enhance->OneTime->EnhanceCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    } else if($cl['paymentterm'] == 'Prepaid') {
                        if(isset($costagency->enhance->Prepaid->EnhanceCostperlead) && ($costagency->enhance->Prepaid->EnhanceCostperlead != '') && ($costagency->enhance->Prepaid->EnhanceCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $costagency->enhance->Prepaid->EnhanceCostperlead)) {
                            $cl['cost_perlead'] = (float) $costagency->enhance->Prepaid->EnhanceCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    }
                    // info('', [
                    //     'action' => 'cl after',
                    //     'cl' => $cl,
                    //     'clientCostPerLead' => $clientCostPerLead
                    // ]);
                    /* VALIDATION COST PER LEAD UNDER COSTAGENCY */
    
                    if($clientTypeLead['type'] == 'clientcapleadpercentage') {
                        if($cl['paymentterm'] == 'Weekly') {
                            // info('processdatamatch ke weekly');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->enhance->Weekly->EnhanceCostperlead > $rootcostagency->enhance->Weekly->EnhanceCostperlead) ? $costagency->enhance->Weekly->EnhanceCostperlead : $rootcostagency->enhance->Weekly->EnhanceCostperlead;
                            $rootCostPerLeadMin = $costagency->enhance->Weekly->EnhanceCostperlead;
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) { 
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        } else if($cl['paymentterm'] == 'Monthly') {
                            // info('processdatamatch ke monthly');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->enhance->Monthly->EnhanceCostperlead > $rootcostagency->enhance->Monthly->EnhanceCostperlead) ? $costagency->enhance->Monthly->EnhanceCostperlead : $rootcostagency->enhance->Monthly->EnhanceCostperlead;
                            $rootCostPerLeadMin = $costagency->enhance->Monthly->EnhanceCostperlead;
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) { 
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        } else if($cl['paymentterm'] == 'One Time') {
                            // info('processdatamatch ke onetime');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->enhance->OneTime->EnhanceCostperlead > $rootcostagency->enhance->OneTime->EnhanceCostperlead) ? $costagency->enhance->OneTime->EnhanceCostperlead : $rootcostagency->enhance->OneTime->EnhanceCostperlead;
                            $rootCostPerLeadMin = $costagency->enhance->OneTime->EnhanceCostperlead;
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) { 
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        } else if($cl['paymentterm'] == 'Prepaid') {
                            // info('processdatamatch ke prepaid');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->enhance->Prepaid->EnhanceCostperlead > $rootcostagency->enhance->Prepaid->EnhanceCostperlead) ? $costagency->enhance->Prepaid->EnhanceCostperlead : $rootcostagency->enhance->Prepaid->EnhanceCostperlead;
                            $rootCostPerLeadMin = $costagency->enhance->Prepaid->EnhanceCostperlead;
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        }
                    } else {
                        $platform_LeadspeekCostperlead = (isset($platformMargin->enhance->$paymentterm->EnhanceCostperlead))?$platformMargin->enhance->$paymentterm->EnhanceCostperlead:$rootcostagency->enhance->$paymentterm->EnhanceCostperlead;
                    }
    
                    $platform_LeadspeekMinCostMonth = (isset($platformMargin->enhance->$paymentterm->EnhanceMinCostMonth))?$platformMargin->enhance->$paymentterm->EnhanceMinCostMonth:$rootcostagency->enhance->$paymentterm->EnhanceMinCostMonth;
                    $platform_LeadspeekPlatformFee = (isset($platformMargin->enhance->$paymentterm->EnhancePlatformFee))?$platformMargin->enhance->$paymentterm->EnhancePlatformFee:$rootcostagency->enhance->$paymentterm->EnhancePlatformFee;
                }else if ($cl['leadspeek_type'] == "b2b") {
                    // $rootcostagency = []; 
                    // if(!isset($platformMargin->b2b)) {
                    //     $rootcostagency = $this->getcompanysetting($cl['company_root_id'],'rootcostagency');
                    // }
    
                    $clientTypeLead = $this->getClientCapType($cl['company_root_id']);
                    $rootcostagency = $this->getcompanysetting($cl['company_root_id'],'rootcostagency');
                    $costagency = $this->getcompanysetting($cl['company_parent'], 'costagency');
    
                    /* VALIDATION COST PER LEAD UNDER COSTAGENCY */
                    // info('', [
                    //     'action' => 'cl before',
                    //     'cl' => $cl,
                    //     'clientCostPerLead' => $clientCostPerLead
                    // ]);
                    if($cl['paymentterm'] == 'Weekly') {
                        $m_B2bCostperlead = (isset($costagency->b2b->Weekly->B2bCostperlead)) ? ($costagency->b2b->Weekly->B2bCostperlead) : ($rootcostagency->b2b->Weekly->B2bCostperlead);
                        if(($m_B2bCostperlead != '') && ($m_B2bCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $m_B2bCostperlead)) {
                            $cl['cost_perlead'] = (float) $m_B2bCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    } else if($cl['paymentterm'] == 'Monthly') { 
                        $m_B2bCostperlead = (isset($costagency->b2b->Monthly->B2bCostperlead)) ? ($costagency->b2b->Monthly->B2bCostperlead) : ($rootcostagency->b2b->Monthly->B2bCostperlead);
                        if(($m_B2bCostperlead != '') && ($m_B2bCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $m_B2bCostperlead)) {
                            $cl['cost_perlead'] = (float) $m_B2bCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    } else if($cl['paymentterm'] == 'One Time') {
                        $m_B2bCostperlead = (isset($costagency->b2b->OneTime->B2bCostperlead)) ? ($costagency->b2b->OneTime->B2bCostperlead) : ($rootcostagency->b2b->OneTime->B2bCostperlead);
                        if(($m_B2bCostperlead != '') && ($m_B2bCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $m_B2bCostperlead)) {
                            $cl['cost_perlead'] = (float) $m_B2bCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    } else if($cl['paymentterm'] == 'Prepaid') {
                        $m_B2bCostperlead = (isset($costagency->b2b->Prepaid->B2bCostperlead)) ? ($costagency->b2b->Prepaid->B2bCostperlead) : ($rootcostagency->b2b->Prepaid->B2bCostperlead);
                        if(($m_B2bCostperlead != '') && ($m_B2bCostperlead != 0) && ($cl['cost_perlead'] > 0) && ($cl['cost_perlead'] < $m_B2bCostperlead)) {
                            $cl['cost_perlead'] = (float) $m_B2bCostperlead;
                            $clientCostPerLead = $cl['cost_perlead'];
                        }
                    }
                    // info('', [
                    //     'action' => 'cl after',
                    //     'cl' => $cl,
                    //     'clientCostPerLead' => $clientCostPerLead
                    // ]);
                    /* VALIDATION COST PER LEAD UNDER COSTAGENCY */
    
                    if($clientTypeLead['type'] == 'clientcapleadpercentage') {
                        if($cl['paymentterm'] == 'Weekly') {
                            // info('processdatamatch ke weekly');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->b2b->Weekly->B2bCostperlead > $rootcostagency->b2b->Weekly->B2bCostperlead) ? $costagency->b2b->Weekly->B2bCostperlead : $rootcostagency->b2b->Weekly->B2bCostperlead;
                            $rootCostPerLeadMin = (isset($costagency->b2b->Weekly->B2bCostperlead)) ? ($costagency->b2b->Weekly->B2bCostperlead) : ($rootcostagency->b2b->Weekly->B2bCostperlead);
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) { 
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        } else if($cl['paymentterm'] == 'Monthly') {
                            // info('processdatamatch ke monthly');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->b2b->Monthly->B2bCostperlead > $rootcostagency->b2b->Monthly->B2bCostperlead) ? $costagency->b2b->Monthly->B2bCostperlead : $rootcostagency->b2b->Monthly->B2bCostperlead;
                            $rootCostPerLeadMin = (isset($costagency->b2b->Monthly->B2bCostperlead)) ? ($costagency->b2b->Monthly->B2bCostperlead) : ($rootcostagency->b2b->Monthly->B2bCostperlead);
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) { 
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        } else if($cl['paymentterm'] == 'One Time') {
                            // info('processdatamatch ke onetime');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->b2b->OneTime->B2bCostperlead > $rootcostagency->b2b->OneTime->B2bCostperlead) ? $costagency->b2b->OneTime->B2bCostperlead : $rootcostagency->b2b->OneTime->B2bCostperlead;
                            $rootCostPerLeadMin = (isset($costagency->b2b->OneTime->B2bCostperlead)) ? ($costagency->b2b->OneTime->B2bCostperlead) : ($rootcostagency->b2b->OneTime->B2bCostperlead);
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) { 
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        } else if($cl['paymentterm'] == 'Prepaid') {
                            // info('processdatamatch ke prepaid');
                            $m_LeadspeekCostperlead = ($cl['cost_perlead'] * $clientTypeLead['value']) / 100;
                            // $m_LeadspeekCostperlead = ($clientCostPerLead * $clientTypeLead['value']) / 100;
                            // $rootCostPerLeadMin = ($costagency->b2b->Prepaid->B2bCostperlead > $rootcostagency->b2b->Prepaid->B2bCostperlead) ? $costagency->b2b->Prepaid->B2bCostperlead : $rootcostagency->b2b->Prepaid->B2bCostperlead;
                            $rootCostPerLeadMin = (isset($costagency->b2b->Prepaid->B2bCostperlead)) ? ($costagency->b2b->Prepaid->B2bCostperlead) : ($rootcostagency->b2b->Prepaid->B2bCostperlead);
                            $rootCostPerLeadMax = ($rootCostPerLeadMin) / ($clientTypeLead['value'] / 100);
    
                            // jika cost_perlead 0 atau m_LeadspeekCostperlead berada di rentang $rootCostPerLeadMin ~ $rootCostPerLeadMax
                            if(($cl['cost_perlead'] == 0) || ($cl['cost_perlead'] <= $rootCostPerLeadMax && $cl['cost_perlead'] >= $rootCostPerLeadMin)) {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                            // jika lebih dari $rootCostPerLeadMax, maka dinamis
                            else if($cl['cost_perlead'] > $rootCostPerLeadMax) {
                                $platform_LeadspeekCostperlead = $m_LeadspeekCostperlead;
                            }
                            else {
                                $platform_LeadspeekCostperlead = $rootCostPerLeadMin;
                            }
                        }
                    } else {
                        $platform_LeadspeekCostperlead = (isset($platformMargin->b2b->$paymentterm->B2bCostperlead))?$platformMargin->b2b->$paymentterm->B2bCostperlead:$rootcostagency->b2b->$paymentterm->B2bCostperlead;
                    }
    
                    $platform_LeadspeekMinCostMonth = (isset($platformMargin->b2b->$paymentterm->B2bMinCostMonth))?$platformMargin->b2b->$paymentterm->B2bMinCostMonth:$rootcostagency->b2b->$paymentterm->B2bMinCostMonth;
                    $platform_LeadspeekPlatformFee = (isset($platformMargin->b2b->$paymentterm->B2bPlatformFee))?$platformMargin->b2b->$paymentterm->B2bPlatformFee:$rootcostagency->b2b->$paymentterm->B2bPlatformFee;
                }
            }

            return [
                'platform_LeadspeekCostperlead' => $platform_LeadspeekCostperlead,
                'platform_LeadspeekMinCostMonth' => $platform_LeadspeekMinCostMonth,
                'platform_LeadspeekPlatformFee' => $platform_LeadspeekPlatformFee,
                'cost_perlead' => $cl['cost_perlead']
            ];
        }
        catch (\Throwable $e)
        {
            Log::error("public function processGetPlatformMargin error", [
                'message' => $e->getMessage()
            ]);
            return [];
        }
    }
    /* FUNCTION PROCESS GET PLATFORM MARGIN */
}

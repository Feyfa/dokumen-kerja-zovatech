var PxGrabber = {
	options: {
		Label: "",
		CustomParams: "",
	},
	
	setOptions: function(options) {
		if(options.Label) {
			this.options.Label = options.Label;
		}
		if(options.CustomParams) {
			if (typeof options.CustomParams !== 'string') {
				this.options.CustomParams = '';
			} else {
				this.options.CustomParams = options.CustomParams.trim().substring(0, 100);
			}
		}
	},

	validate: function () {
		if(!this.options.Label) {
			console.log('N');
			return false;
		}
		return true;
	},

	render: function() {
		var self = this;
		console.log(this.options.Label);
		if(!this.validate()) {
			return;
		}

		// fetch data
		this.fetch(function(response) {
			if(response.tag_url) {
				try {
					var scriptTag = document.createElement('script');
					scriptTag.async = true;
					scriptTag.src = response.tag_url;

					// Event listener for successful script load and execution
					scriptTag.onload = function() {
						console.log('SUCCESS: Simpli.fi tag script loaded and executed successfully.');
					};
					
					// Event listener for script loading errors (e.g., 404, network issue)
					scriptTag.onerror = function() {
						console.log('ERROR: Failed to load the Simpli.fi tag script from URL: ' + response.tag_url);
					};

					document.body.appendChild(scriptTag);
					console.log('PxGrabber: Simpli.fi tag injected via URL.');
				} catch (e) {
					console.log('PxGrabber Error: Failed to execute Simpli.fi tag.', e);
				}
			}

			if(response.result == "success") {
				var img = document.createElement("img");
				img.src = response.url;
				img.style.display = "none";
				document.body.appendChild(img);
			}else{
                return false;
			}
		});
	},

	fetch: async function(callback) {
		// ambil cookies visitor id
		const visitorId = this.getOrCreateVisitorId();

		// ambil device info client
		const device = this.getDeviceInfo();

		// ambil waktu client
		const clientDate = this.getClientDate();
		
		// ambil client ip
		const clientIp = await this.fetchClientIp();

		// Siapkan parameter GET
		const paramsObject = {
			label: this.options.Label,
			customParams: this.options.CustomParams,
			script: 'true',
			url: window.location.href,
			ipClient: clientIp,
			visitorId: visitorId,
			date: clientDate,
			screenWidth: device.screenWidth,
			screenHeight: device.screenHeight,
			viewportWidth: device.viewportWidth,
			viewportHeight: device.viewportHeight,
			pixelRatio: device.pixelRatio,
			timeZone: device.timeZone,
			deviceType: device.deviceType,
		}; 
		const paramsString = new URLSearchParams(paramsObject).toString();
		// console.log({paramsObject, paramsString});

		// siapkan xhr request
		const xhr = new XMLHttpRequest();
		xhr.addEventListener("readystatechange", function () {
	  		if (this.readyState === 4 && this.status === 200) {
	    		callback(this.response);
	  		}
		});
		// xhr.open("GET", "https://px.0o0o.io/pixel?label=" + this.options.Label + "&script=true");
		xhr.open("GET", `https://px.0o0o.io/pixel?${paramsString}`); // production
		xhr.responseType = 'json';		
		xhr.send();
	},

	// untuk mendapatkan informasi device client
	getDeviceInfo: function() {
		let deviceType = 'desktop';
		if (/Mobile|Android|iPhone/i.test(navigator.userAgent)) {
			deviceType = 'mobile';
		} else if (/Tablet|iPad/i.test(navigator.userAgent)) {
			deviceType = 'tablet';
		}
		const data = {
			screenWidth: screen.width,
			screenHeight: screen.height,
			viewportWidth: window.innerWidth,
			viewportHeight: window.innerHeight,
			pixelRatio: window.devicePixelRatio,
			timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
			deviceType: deviceType
		}; // console.log(data);
		return data;
	},

	// untuk mendapatkan client ip
	fetchClientIp: async function () {
		try {
		  	const result = await fetch('https://api.ipify.org?format=json');
			if (!result.ok) return null; 
			const json = await result.json();
			return json.ip;
		} catch (error) {
			return null;
		}
	},

	// untuk mendapatkan atau membuat visitor id
	getOrCreateVisitorId: function() {
		/* CARA PAKAI LOCALSTORAGE */
		// nama key untuk localStorage
		const storageKey = "visitor_sitesettings_id";

		// cek apakah sudah ada di localStorage
		let visitorId = localStorage.getItem(storageKey);
		if (visitorId) {
			return visitorId; // sudah ada, langsung return
		}

		// kalau belum ada, buat ID baru
		visitorId = this.generateRandomId(24);

		// simpan ke localStorage (tanpa expired)
		localStorage.setItem(storageKey, visitorId);

		// return visitor id
		return visitorId;
		/* CARA PAKAI LOCALSTORAGE */

		/* CARA PAKAI COOKIE */
		// // nama cookie visitor id
		// const cookieName = "visitor_sitesettings_id";
	  
		// // Cek apakah cookie sudah ada
		// const cookies = document.cookie.split(';').map(c => c.trim());
		// for (let cookie of cookies) {
		// 	if (cookie.startsWith(cookieName + '=')) {
		// 		const value = cookie.split('=')[1];
		// 		return value; // sudah ada, langsung return
		// 	}
		// }
	  
		// // Kalau belum ada, buat ID baru
		// const visitorId = this.generateRandomId(24);
	  
		// // Durasi cookie dalam detik (2 tahun)
		// const maxAge = 60 * 60 * 24 * 365 * 2; // 2 tahun -> 63_072_000 detik
	  
		// // Buat cookie baru pakai max-age (tanpa Date)
		// document.cookie = `${cookieName}=${visitorId}; max-age=${maxAge}; path=/; SameSite=Lax`;
	  
		// // return visitor id
		// return visitorId;
		/* CARA PAKAI COOKIE */
	},
	  
	// Utility untuk bikin string acak (aman & unik)
	generateRandomId: function(length) {
		// geenrate random string pakai crypto
		const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		let randomString = '';
		const array = new Uint32Array(length);
		crypto.getRandomValues(array);
		for (let i = 0; i < length; i++) {
			randomString += chars[array[i] % chars.length];
		}
		
		// Tambahkan epoch time (ms)
		const timestamp = Date.now();
		
		// Gabungkan dan return
		return `${randomString}${timestamp}`;
	},

	// untuk mendapatkan waktu client
	getClientDate: function () {
		const now = new Date();
		const year = now.getFullYear();
		const month = String(now.getMonth() + 1).padStart(2, '0');
		const day = String(now.getDate()).padStart(2, '0');
		const hours = String(now.getHours()).padStart(2, '0');
		const minutes = String(now.getMinutes()).padStart(2, '0');
		const seconds = String(now.getSeconds()).padStart(2, '0');
		return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
	}
};
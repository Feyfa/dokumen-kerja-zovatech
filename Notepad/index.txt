-- ===============UJI COBA SANDBOX===============
-- leadspeek_api_id = 11655464
-- nama agency = muhammad jidan
select * from topup_agencies where company_id = 581 order by id desc;
select * from topup_agencies where company_id = 85 order by id desc;
-- ===============UJI COBA SANDBOX===============

-- ===============UPDATE STATUS CAMPAIGN===============
-- update leadspeek_users set active = 'T', disabled = 'F', active_user = 'T' where leadspeek_api_id = @leadspeek_api_id;
-- ===============UPDATE STATUS CAMPAIGN===============

-- ===============SELECT===============
SELECT start_billing_date,lp_invoice_date,active,disabled,active_user,leadspeek_users.* FROM leadspeek_users WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY);
SELECT * FROM topup_campaigns WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY) ORDER BY id ASC;
SELECT * FROM leadspeek_invoices WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY) ORDER BY id ASC;
SELECT * FROM leadspeek_reports WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY) ORDER BY id ASC;
SELECT * FROM topup_agencies WHERE CAST(company_id AS BINARY)=(SELECT CAST(company_id AS BINARY) FROM leadspeek_users WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY)) ORDER BY id ASC;
SELECT * FROM leadspeek_invoices WHERE CAST(company_id AS BINARY)=(SELECT CAST(company_id AS BINARY) FROM leadspeek_users WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY)) AND invoice_type='agency' ORDER BY id ASC;
-- ===============SELECT===============







-- ===============VARIABLE===============
SET @total_leads := 500;
SET @leadspeek_api_id := '87230242';

set @cost_per_contact := 0.1;
set @total_cost_agency := @cost_per_contact * @total_leads;

SET @last_id_topup_agencies := (
    SELECT id
    FROM topup_agencies
    WHERE company_id = (
        SELECT company_id
        FROM leadspeek_users
        WHERE CAST(leadspeek_api_id AS CHAR) = CAST(@leadspeek_api_id AS CHAR)
        LIMIT 1
    )
    ORDER BY id DESC
    LIMIT 1
);

select @total_leads, @leadspeek_api_id, @cost_per_contact, @total_cost_agency, @last_id_topup_agencies;
-- ===============VARIABLE===============


-- ===============TOPUP_CAMPAIGNS===============
INSERT INTO topup_campaigns
(
    user_id,
    lp_user_id,
    company_id,
    leadspeek_api_id,
    leadspeek_type,
    topupoptions,
    advance_information,
    campaign_information_type_local,
    platformfee,
    cost_perlead,
    lp_limit_leads,
    lp_min_cost_month,
    total_leads,
    balance_leads,
    platform_price,
    root_price,
    treshold,
    payment_amount,
    active,
    stop_continue,
    last_cost_perlead,
    last_limit_leads_day,
    topup_status,
    ip_user,
    timezone,
    updated_at,
    created_at
)
SELECT
    user_id,
    lp_user_id,
    company_id,
    leadspeek_api_id,
    leadspeek_type,
    topupoptions,
    advance_information,
    campaign_information_type_local,
    platformfee,
    cost_perlead,
    @total_leads as lp_limit_leads,
    lp_min_cost_month,
    @total_leads AS total_leads,
    @total_leads AS balance_leads,
    platform_price,
    root_price,
    @total_leads AS treshold,
    payment_amount,
    active,
    stop_continue,
    last_cost_perlead,
    last_limit_leads_day,
	CASE WHEN (SELECT COUNT(*) FROM topup_campaigns WHERE CAST(leadspeek_api_id AS BINARY)=CAST(@leadspeek_api_id AS BINARY) AND CAST(topup_status AS BINARY)=BINARY'done')=0 THEN 'queue' ELSE 'progress' END AS topup_status,
    ip_user,
    timezone,
    NOW(),
    NOW()
FROM topup_campaigns
WHERE CAST(leadspeek_api_id AS BINARY) = CAST(@leadspeek_api_id AS BINARY)
ORDER BY id DESC
LIMIT 1;
-- ===============TOPUP_CAMPAIGNS===============


-- ===============LEADSPEEK_INVOICES===============
INSERT INTO leadspeek_invoices (
    id,
    invoice_type,
    topup_agencies_id,
    budget_plan_id,
    payment_type,
    company_id,
    user_id,
    leadspeek_api_id,
    invoice_number,
    payment_term,
    onetimefee,
    platform_onetimefee,
    min_leads,
    exceed_leads,
    total_leads,
    min_cost,
    platform_min_cost,
    cost_leads,
    platform_cost_leads,
    frequency_capping_impressions,
    frequency_capping_hours,
    max_bid,
    monthly_budget,
    daily_budget,
    goal_type,
    goal_value,
    agency_markup,
    total_amount,
    platform_total_amount,
    root_total_amount,
    status,
    customer_payment_id,
    customer_stripe_id,
    customer_card_id,
    platform_customer_payment_id,
    error_payment,
    platform_error_payment,
    invoice_date,
    invoice_start,
    invoice_end,
    sent_to,
    sr_id,
    sr_fee,
    sr_transfer_id,
    ae_id,
    ae_fee,
    ae_transfer_id,
    ar_id,
    ar_fee,
    ar_transfer_id,
    campaigns_paused,
    active,
    updated_at,
    created_at
)
SELECT
    NULL,
    invoice_type,
    topup_agencies_id,
    budget_plan_id,
    payment_type,
    company_id,
    user_id,
    leadspeek_api_id,
    invoice_number, -- ganti yang ini
    payment_term,
    onetimefee,
    platform_onetimefee,
    min_leads,
    exceed_leads,
    @total_leads as total_leads, -- ganti total_leads
    min_cost,
    platform_min_cost,
    cost_leads,
    @cost_per_contact as platform_cost_leads,
    frequency_capping_impressions,
    frequency_capping_hours,
    max_bid,
    monthly_budget,
    daily_budget,
    goal_type,
    goal_value,
    agency_markup,
    total_amount,
    @total_cost_agency as platform_total_amount,
    root_total_amount,
    status,
    customer_payment_id,
    customer_stripe_id,
    customer_card_id,
    platform_customer_payment_id,
    error_payment,
    platform_error_payment,
    DATE(NOW()) as invoice_date,
    DATE(NOW()) as invoice_start,
    DATE(NOW()) as invoice_end,
    sent_to,
    sr_id,
    sr_fee,
    sr_transfer_id,
    ae_id,
    ae_fee,
    ae_transfer_id,
    ar_id,
    ar_fee,
    ar_transfer_id,
    campaigns_paused,
    active,
    NOW(),
    NOW()
FROM leadspeek_invoices
WHERE CAST(leadspeek_api_id AS BINARY) = CAST(@leadspeek_api_id AS BINARY)
ORDER BY id DESC
LIMIT 1;
-- ===============LEADSPEEK_INVOICES===============


-- ===============topup_agencies===============
UPDATE topup_agencies
SET balance_amount = balance_amount - @total_cost_agency
WHERE CAST(id AS BINARY) = CAST(@last_id_topup_agencies AS BINARY)
LIMIT 1;
-- ===============topup_agencies===============

{
    "status": "success",
    "message": "success get campaign",
    "status_code": 200,
    "data": {
        "campaign_id": "12345678",
        "campaign_type": "local",
        "status_campaign": "Stopped",
        "company_name": "Jhon Doe",
        "client_name": "Jhon Doe",
        "campaign_name": "Campaign Name",
        "email": "emmqatester@gmail.com",
        "phonenum": "(201) 222-2222",
        "phoneenabled": true,
        "homeaddressenabled": true,
        "require_email": true,
        "applyreidentificationall": false,
        "reidentification_type": "1 year",
        "gtminstalled": true,
        "urlcode_1": "https://jhondoe1.com",
        "urlcode_2": "https://jhondoe2.com",
        "contacts": {
            "total": 5,
            "yesterday": 2
        },
        "financials": {
            "payment_term": "prepaid",
            "prepaid_options": "continual",
            "stop_continual_topup": false,
            "continual_buy_options": "weekly",
            "limit_frequency": "day",
            "remaining_balance": 0,
            "lead_per_day": 3,
            "client": {
                "setup_fee": 0,
                "campaign_fee": 0,
                "cost_per_lead": 2.49
            },
            "agency": {
                "setup_fee": 0.1,
                "campaign_fee": 0.2,
                "cost_per_lead": 2
            }
        }
    }
}

EMM-SANDBOX-APP
JD-TASK-EMM-341 = "implement watt in clean id"
JD-TASK-EMM-341-DEV-SYNC

FILE
FRONT
* front\public\samplefile\cleanid-watt-sample.csv
* front\public\samplefile\cleanid-bigdbm-sample.csv
* front\src\pages\Modules\Auth\LeedspeekClean\index.vue
* front\src\store\store.js

DATA
* data\app\Exports\CleanIDResultExport.php
* data\app\Http\Controllers\OpenApiController.php
* data\app\Http\Controllers\LeadspeekController.php
* data\app\Models\FailedLeadRecord.php
* data\app\Models\CleanIDFile.php

px.min.js
DashboardLayout
global.js

EMM-SANDBOX-API
JD-TASK-EMM-341 = "implement watt in clean id"
JD-TASK-EMM-341-DEV-SYNC

FILE
* app\Http\Controllers\UploadController.php
* app\Jobs\CleanIDExportChunkJob.php
* app\Jobs\CleanIDExportInsertJob.php
* app\Jobs\CleanIDJob.php
* app\Jobs\CleanIDMd5StreamJob.php
* app\Jobs\RetryMD5CleanIDJob.php
* app\Services\CleanID.php
* app\Services\WattData.php
* app\Models\CleanIDFile.php
* app\Models\FailedLeadRecord.php
* app\Models\CleanIDResult.php
* app\Models\CleanIDMd5.php
* app\Models\Person.php
* app\Models\PersonAddress.php
* app\Models\PersonB2B.php
* app\Models\PersonEmail.php
* app\Models\PersonName.php
* app\Models\PersonPhone.php










































here i will prove that enable_on_campaign parameter works well
1. Create a client at the api level with the enable_on_campaign parameter set to true. ✅
2. Create a campaign B2B at API level ✅
3. Create a campaign B2B at UI level ✅




https://drive.google.com/file/d/1bCr1pBxvgMCOd7mwYeQM24p_dFPZJrGs/view?usp=sharing

https://trello.com/c/wFDXH64U#comment-69535aa3ce6c007c817d1a2a








enable_google_sheet_editor
enable_phone_number_on_campaign


        return collect($users)->map(function ($user) {
            $user->disable_client_add_campaign = $this->trueOrFalse($user->disable_client_add_campaign ?? '');
            $user->disabled_receive_email = $this->trueOrFalse($user->disabled_receive_email ?? '');
            $user->editor_spreadsheet = $this->trueOrFalse($user->editor_spreadsheet ?? '');
            $user->enabled_phone_number = $this->trueOrFalse($user->enabled_phone_number ?? '');
            $user->enable_google_sheet_editor = $this->trueOrFalse($user->editor_spreadsheet ?? '');
            $user->enable_phone_number_on_campaign = $this->trueOrFalse($user->enabled_phone_number ?? '');
            return $user;
        });

        DB::raw("users.editor_spreadsheet = 'T' AS enable_google_sheet_editor"),
        DB::raw("users.enabled_phone_number = 'T' AS enable_phone_number_on_campaign"),


RUN =>              active = T disabled = F active_user = T
PAUSED =>           active = F disabled = T active_user = T ✅
PAUSED on RUN =>    active = F disabled = F active_user = T
STOP                active = F disabled = T active_user = F ✅

(($request->status == 'F' && $request->activeuser == 'T') || ($request->status == 'F' && $request->activeuser == 'F'))

if ($usrInfo[0]->leadspeek_type != 'simplifi' && $platform_LeadspeekCostperlead == 0)
{
    LeadspeekUser::find($_lp_user_id)->update(['active' => 'F', 'disabled' => 'T', 'active_user' => 'F']);
    $msg = "Sorry, this campaign cannot be started because your agency cost per contact is set to $0. Please update the agency pricing and try again.";
    return response()->json(array('result'=>'failedPayment','msg'=>$msg));
}

if (($leads->leadspeek_type == 'enhance' || $leads->leadspeek_type == 'b2b') && (($request->status == 'F' && $request->activeuser == 'T') || ($request->status == 'F' && $request->activeuser == 'F'))) {

if(count($usrInfo) > 0 && (($usrInfo[0]['customer_payment_id'] != '' && $usrInfo[0]['customer_card_id'] != '') || $_AgencyManualBill === true) && ($updateclient[0]->platformfee > 0 || $updateclient[0]->lp_min_cost_month > 0 || $updateclient[0]->paymentterm == 'One Time' || $updateclient[0]->paymentterm == 'Prepaid' || $updateclient[0]->leadspeek_type == 'simplifi'))
if(count($usrInfo) > 0 && (($usrInfo[0]['customer_payment_id'] != '' && $usrInfo[0]['customer_card_id'] != '') || $_AgencyManualBill === true))

1767161680


validasi
1. weekly/monthly cost per contact agency diatas 0, namun lead per day boleh 0 ✅ 
2. weekly/monthly cost per contact agency tidak boleh 0. ✅
3. prepaid cost per contact agency ✅, lead per day , lead buy tidak boleh 0 
4. test apakah benar weekly/monthly, lead per day nya 0, itu unlimitid 
5. coba test" kaya biasa 


